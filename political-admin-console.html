<!DOCTYPE html>

<html lang="hi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- EventLens admin patched 2026-02-09 06:13:15 -->
<title>Political Admin Console Pro - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: { 
            brand: { 500: '#f97316', 600: '#ea580c' }, 
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } 
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.4s ease-out forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #020617;
      background-image: 
        radial-gradient(at 0% 0%, rgba(249, 115, 22, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(56, 189, 248, 0.10) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(249, 115, 22, 0.05) 0px, transparent 50%);
      background-attachment: fixed;
      color: #e2e8f0;
    }
    
    /* Glass Effect Enhanced */
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .glass-header {
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Inputs & UI Elements */
    .input-field {
      background: rgba(2, 6, 23, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      transition: all 0.2s;
    }
    .input-field:focus {
      outline: none;
      border-color: #f97316;
      background: rgba(2, 6, 23, 0.7);
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Phone Mockup */
    .phone-mockup {
      border: 12px solid #1e293b;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #000;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .phone-mockup::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 24px;
      background: #1e293b;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      z-index: 10;
    }

    /* Tab Animations */
    .nav-btn {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .nav-btn.active {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
      border-left-color: #f97316;
      color: #fff;
    }
    .nav-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(10px);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top: 3px solid #f97316;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
</head>

<body class="min-h-screen font-sans selection:bg-orange-500/30">

  <!-- Toast Container -->

  <div id="toastContainer" class="toast-container"></div>

  <!-- Top bar -->

  <nav class="sticky top-0 z-50 glass-header h-16">
    <div class="max-w-[1600px] mx-auto px-4 h-full">
      <div class="flex items-center justify-between h-full gap-4">

```
    <!-- Logo Area -->
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white shadow-lg shadow-orange-500/20 ring-1 ring-white/10">
        <i class="fa-solid fa-om"></i>
      </div>
      <div>
        <div class="text-white font-extrabold tracking-tight text-lg leading-none">EventLens <span class="text-orange-500">Pro</span></div>
        <div class="text-[10px] text-slate-400 font-semibold uppercase tracking-wider mt-1">Political Admin Console</div>
      </div>
    </div>

    <!-- Right Actions -->
    <div class="flex items-center gap-3">
      <!-- CID Display -->
      <div id="cidPill" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/60 border border-slate-800 text-xs font-mono text-slate-300">
        <i class="fa-solid fa-database text-emerald-500"></i>
        <span id="cidVal" class="font-bold text-white tracking-wide"></span>
      </div>

      <div class="h-6 w-px bg-slate-800 mx-1"></div>

      <!-- AUTH BUTTON -->
      <button id="btnAuth" class="group px-3 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 text-orange-400 hover:text-orange-300 transition-colors border border-transparent hover:border-orange-500/30" title="Update Token">
        <i class="fa-solid fa-key text-sm"></i>
      </button>

      <button id="btnReload" class="group px-3 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 text-slate-300 hover:text-white transition-colors border border-transparent hover:border-slate-700">
        <i class="fa-solid fa-rotate-right text-sm group-hover:rotate-180 transition-transform duration-500"></i>
      </button>

      <button id="btnSave" class="group relative px-5 py-2 rounded-lg bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white text-sm font-bold shadow-lg shadow-orange-600/20 transition-all hover:scale-105 active:scale-95 flex items-center gap-2 overflow-hidden">
        <span class="relative z-10 flex items-center gap-2">
          <i class="fa-solid fa-floppy-disk"></i> Save Changes
        </span>
        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
      </button>
    </div>
  </div>
</div>
```

  </nav>

  <!-- Main Layout -->

  <main class="max-w-[1600px] mx-auto px-4 py-6">
    <div class="grid lg:grid-cols-12 gap-6 items-start">

```
  <!-- Left Sidebar -->
  <aside class="lg:col-span-3 space-y-6 sticky top-24">
    
    <!-- Context Card -->
    <div class="glass-panel rounded-2xl p-5 relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
        <i class="fa-solid fa-chess-rook text-6xl text-orange-500"></i>
      </div>
      
      <div class="text-xs font-bold text-orange-400 uppercase tracking-widest mb-4">Current Context</div>
      
      <div class="space-y-4 relative z-10">
        <div>
          <label class="text-[11px] font-bold text-slate-400 uppercase">Collection ID</label>
          <div class="mt-1 flex gap-2">
            <input id="cidInput" class="input-field w-full rounded-lg px-3 py-2 text-xs font-mono" placeholder="Enter CID..." />
            <button id="btnApplyCid" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold text-white transition-colors">
              <i class="fa-solid fa-check"></i>
            </button>
          </div>
        </div>

        <div>
          <label class="text-[11px] font-bold text-slate-400 uppercase">Edit Target</label>
          <div class="relative mt-1">
            <select id="targetFormSel" class="input-field w-full rounded-lg px-3 py-2.5 text-sm appearance-none cursor-pointer">
              <option value="__defaults__">üì° Defaults (All Forms)</option>
              <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
              <option value="visitor_form">üìù Visitor Form</option>
              <option value="party_attendance">üö© Party Attendance</option>
              <option value="president_tour_form">üöô President Tour</option>
              <option value="mandal_reporting">üìä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó</option>
              <option value="coordinator_form">üëî Coordinator</option>
              <option value="program_info">‚ÑπÔ∏è Program Info</option>
            </select>
            <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs">
              <i class="fa-solid fa-chevron-down"></i>
            </div>
          </div>
          <div class="text-[10px] text-slate-500 mt-2 leading-relaxed">
            Changes apply to the selected form only unless "Defaults" is chosen.
          </div>
        </div>

        <div class="flex items-center justify-between gap-2 rounded-lg bg-slate-950/40 border border-slate-800 p-3">
          <div>
            <div class="text-xs font-bold text-white">Live Preview</div>
            <div class="text-[10px] text-slate-500">Real-time branding update</div>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input id="livePreviewToggle" type="checkbox" class="sr-only peer" checked>
            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
          </label>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-panel rounded-2xl p-2 space-y-1">
      <button class="nav-btn active w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="branding">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-palette text-orange-400"></i></span>
        Branding & Preview
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="programs">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-list-check text-blue-400"></i></span>
        Program Names
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="levels">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-lock text-rose-400"></i></span>
        Level Locks
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="attendance">
        <i class="fa-solid fa-calendar-check text-emerald-400"></i>
        <span>Attendance</span>
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="data">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-table text-emerald-400"></i></span>
        Data Records
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="gallery">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-images text-pink-400"></i></span>
        Photo Gallery
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="analytics">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-chart-pie text-purple-400"></i></span>
        Analytics
      </button>
      <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="backend">
        <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-plug text-yellow-400"></i></span>
        API Config
      </button>
    </nav>

    <div class="text-center">
      <p class="text-[10px] text-slate-600">v2.9.0 Pro ‚Ä¢ EventLens System</p>
    </div>
  </aside>

  <!-- Main Content Area -->
  <div class="lg:col-span-9 min-h-[80vh]">
    
    <!-- TAB: Branding -->
    <section id="tab-branding" class="tab-content animate-fade-in">
      <div class="grid lg:grid-cols-12 gap-6">
        
        <!-- Editor Column -->
        <div class="lg:col-span-7 space-y-6">
          <div class="glass-panel rounded-2xl p-6">
            <div class="flex items-center justify-between mb-6">
               <h2 class="text-xl font-bold text-white flex items-center gap-2">
                 <i class="fa-solid fa-pen-nib text-orange-500"></i> Appearance
               </h2>
               <div class="flex gap-2">
                  <button id="btnResetBrand" class="px-3 py-1.5 text-xs font-semibold text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-700 rounded-lg transition-colors">Reset</button>
                  <button id="btnCopyToDefaults" class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded-lg transition-colors">Copy to All</button>
               </div>
            </div>

            <!-- Text Inputs -->
            <div class="space-y-4">
              <div class="grid md:grid-cols-2 gap-4">
                <div class="group">
                  <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Title / Header</label>
                  <input id="b_title" class="input-field w-full rounded-xl px-4 py-3 text-sm font-bold" placeholder="e.g. ‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞" />
                </div>
                <div class="group">
                  <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Subtitle</label>
                  <input id="b_subtitle" class="input-field w-full rounded-xl px-4 py-3 text-sm" placeholder="e.g. ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§" />
                </div>
              </div>
              <div class="group">
                <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Tagline</label>
                <input id="b_tagline" class="input-field w-full rounded-xl px-4 py-3 text-sm" placeholder="e.g. ‡§∏‡•á‡§µ‡§æ ‚Ä¢ ‡§∏‡§Ç‡§ó‡§†‡§® ‚Ä¢ ‡§∏‡§Æ‡§∞‡•ç‡§™‡§£" />
              </div>
            </div>

            <!-- Colors -->
            <div class="mt-6 p-4 bg-slate-950/30 rounded-xl border border-slate-800/50">
              <label class="text-xs font-bold text-slate-400 block mb-3">Gradient Theme</label>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="flex items-center gap-3">
                    <input id="b_c1" type="color" class="w-10 h-10 rounded-lg bg-transparent cursor-pointer border-0 p-0" />
                    <div class="text-xs font-mono text-slate-400">Primary</div>
                  </div>
                </div>
                <div>
                  <div class="flex items-center gap-3">
                    <input id="b_c2" type="color" class="w-10 h-10 rounded-lg bg-transparent cursor-pointer border-0 p-0" />
                    <div class="text-xs font-mono text-slate-400">Secondary</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Assets Upload -->
          <div class="glass-panel rounded-2xl p-6">
            <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">Assets</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Logo Upload -->
              <div class="relative group">
                <input id="file_logo" type="file" accept="image/*" class="hidden" />
                <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_logo').click()">
                  <img id="prev_logo" class="absolute inset-0 w-full h-full object-contain p-2 hidden z-10" />
                  <i id="icon_logo" class="fa-solid fa-image text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform"></i>
                  <span class="text-[10px] font-bold text-slate-400 group-hover:text-white">Upload Logo</span>
                </div>
                <button class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="logo"><i class="fa-solid fa-xmark text-xs"></i></button>
                <div id="name_logo" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
              </div>

              <!-- Header Upload -->
              <div class="relative group">
                <input id="file_header" type="file" accept="image/*" class="hidden" />
                <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_header').click()">
                  <img id="prev_header" class="absolute inset-0 w-full h-full object-cover hidden z-10 opacity-60" />
                  <i id="icon_header" class="fa-solid fa-panorama text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform z-0"></i>
                  <span class="text-[10px] font-bold text-slate-400 group-hover:text-white z-20 relative">Upload Header</span>
                </div>
                <button class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="header"><i class="fa-solid fa-xmark text-xs"></i></button>
                <div id="name_header" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
              </div>

              <!-- BG Upload -->
              <div class="relative group">
                <input id="file_bg" type="file" accept="image/*" class="hidden" />
                <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_bg').click()">
                  <img id="prev_bg" class="absolute inset-0 w-full h-full object-cover hidden z-10 opacity-60" />
                  <i id="icon_bg" class="fa-solid fa-mountain-sun text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform z-0"></i>
                  <span class="text-[10px] font-bold text-slate-400 group-hover:text-white z-20 relative">Upload BG</span>
                </div>
                <button class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="bg"><i class="fa-solid fa-xmark text-xs"></i></button>
                <div id="name_bg" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Column -->
        <div class="lg:col-span-5">
          <div class="sticky top-28">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Mobile Preview</h3>
              <div class="flex gap-2">
                 <button id="btnLoadFormPreview" class="px-3 py-1 text-xs rounded-full bg-orange-600 hover:bg-orange-500 text-white font-bold transition-colors"><i class="fa-solid fa-rotate mr-1"></i> Refresh</button>
                 <button id="btnOpenFormPreview" class="px-3 py-1 text-xs rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold transition-colors"><i class="fa-solid fa-up-right-from-square"></i></button>
              </div>
            </div>


            <div id="previewTabs" class="mt-3 flex flex-wrap gap-2"></div>
            <!-- Phone Mockup Container -->
            <div class="flex justify-center">
              <div class="phone-mockup w-[320px] h-[640px] bg-white" style="position:relative">
                <iframe id="formPreviewIframe" class="w-full h-full bg-white border-0" style="position:relative;z-index:1"></iframe>
                
                <!-- Fallback/Overlay for branding preview (JS controlled opacity) -->
                <div id="customPreviewOverlay" class="absolute inset-0 bg-slate-900 pointer-events-none opacity-0 transition-opacity duration-300 z-20 flex flex-col" style="top:0;left:0;right:0;bottom:0;position:absolute">
                   <!-- This overlay is just for quick color feedback if iframe is slow -->
                   <div id="previewHeaderBar" class="h-1 w-full bg-orange-500"></div>
                   <div id="previewBg" class="flex-1 bg-cover bg-center relative">
                     <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                     <div class="relative p-6 flex flex-col items-center justify-center h-full text-center">
                        <div id="previewHeaderImgWrap" class="w-full h-32 rounded-lg overflow-hidden mb-4 hidden shadow-lg">
                           <img id="previewHeaderImg" class="w-full h-full object-cover">
                        </div>
                        <img id="previewLogo" class="w-20 h-20 rounded-full object-cover border-4 border-white/10 mb-4 hidden shadow-2xl">
                        <i id="previewLogoIcon" class="fa-solid fa-bolt text-4xl text-orange-500 mb-4"></i>
                        
                        <h2 id="previewTitle" class="text-2xl font-bold text-white mb-1">Title</h2>
                        <p id="previewSubtitle" class="text-sm text-slate-300">Subtitle</p>
                        <p id="previewTagline" class="text-xs text-slate-400 mt-1">Tagline</p>
                        <div class="mt-6 flex gap-2 justify-center">
                           <div id="sw1" class="w-4 h-4 rounded-full bg-orange-500"></div>
                           <div id="sw2" class="w-4 h-4 rounded-full bg-red-500"></div>
                        </div>
                     </div>
                   </div>
                </div>
              </div>
            </div>
            
            <div class="text-center mt-4">
               <div class="inline-block px-3 py-1 rounded-full bg-slate-900 border border-slate-800 text-[10px] text-slate-500 font-mono">
                 <span id="formPreviewUrlTxt" class="max-w-[200px] truncate block">...</span>
               </div>
            </div>
          </div>
        </div>
      </div>
    
      <div class="mt-6 p-4 rounded-2xl bg-white/5 border border-white/10">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-bold text-slate-300">All Forms Live Preview</div>
            <div class="text-xs text-slate-500 mt-1">‡§π‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ‡•§ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§â‡§∏ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç‡•§</div>
          </div>
          <button id="btnRefreshSignedUrls" class="px-3 py-2 text-xs rounded-lg bg-white/10 hover:bg-white/15">Refresh Preview</button>
        </div>
        <div id="allFormsGrid" style="display:none" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

    </section>

    <!-- TAB: Programs -->
    <section id="tab-programs" class="tab-content hidden animate-fade-in space-y-6">
      <div class="glass-panel rounded-2xl p-6">
         <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
               <h2 class="text-xl font-bold text-white">Program Management</h2>
               <p class="text-sm text-slate-400">Manage the list of programs available in dropdowns.</p>
            </div>
            <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-slate-800">
               <span class="text-xs font-bold text-slate-400 px-2">Mode:</span>
               <select id="progScopeSel" class="bg-transparent text-xs text-white font-bold py-1 pr-2 outline-none">
                  <option value="current">Current Form Only</option>
                  <option value="defaults">Defaults (Global)</option>
               </select>
            </div>
         </div>

         <div class="flex gap-2 mb-8">
            <input id="progInput" class="input-field flex-1 rounded-xl px-4 py-3 text-sm" placeholder="Type new program name (e.g. ‡§¨‡•Ç‡§• ‡§µ‡§ø‡§ú‡§Ø ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®)..." />
            <button id="btnAddProg" class="px-6 py-3 rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-bold shadow-lg shadow-orange-600/20 transition-all active:scale-95">
               <i class="fa-solid fa-plus"></i> Add
            </button>
         </div>

         <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="progList">
            <!-- Program items injected here -->
         </div>
      </div>
    </section>

    <!-- TAB: Levels -->
    <section id="tab-levels" class="tab-content hidden animate-fade-in space-y-6">
      <div class="glass-panel rounded-2xl p-6">
         <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">Hierarchical Locks</h2>
            <select id="levelScopeSel" class="input-field rounded-lg px-3 py-1.5 text-xs">
               <option value="current">Current Form</option>
               <option value="defaults">Defaults</option>
            </select>
         </div>
         
         <div class="grid md:grid-cols-3 gap-6">
            <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
               <div class="flex items-center gap-3 mb-4">
                  <div class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-sitemap"></i></div>
                  <div class="font-bold text-white text-sm">Reporting Level</div>
               </div>
               <select id="lvl_mandal_reporting" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                  <option value="">üîì Unlocked</option>
                  <option value="district">District Fixed</option>
                  <option value="vidhansabha">Vidhan Sabha Fixed</option>
                  <option value="mandal">Mandal Fixed</option>
               </select>
            </div>

            <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
               <div class="flex items-center gap-3 mb-4">
                  <div class="w-8 h-8 rounded-lg bg-purple-500/20 text-purple-400 flex items-center justify-center"><i class="fa-solid fa-user-tie"></i></div>
                  <div class="font-bold text-white text-sm">Coordinator</div>
               </div>
               <select id="lvl_coordinator" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                  <option value="">üîì Unlocked</option>
                  <option value="district">District Fixed</option>
                  <option value="vidhansabha">Vidhan Sabha Fixed</option>
                  <option value="mandal">Mandal Fixed</option>
               </select>
            </div>

            <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
               <div class="flex items-center gap-3 mb-4">
                  <div class="w-8 h-8 rounded-lg bg-emerald-500/20 text-emerald-400 flex items-center justify-center"><i class="fa-solid fa-info"></i></div>
                  <div class="font-bold text-white text-sm">Program Info</div>
               </div>
               <select id="lvl_program_info" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                  <option value="">üîì Unlocked</option>
                  <option value="district">District Fixed</option>
                  <option value="vidhansabha">Vidhan Sabha Fixed</option>
                  <option value="mandal">Mandal Fixed</option>
               </select>
            </div>
         </div>
      </div>
    </section>

    <!-- TAB: Attendance Dashboard -->
    <section id="tab-attendance" class="tab-content hidden animate-fade-in space-y-4">

      <!-- Event selector + controls -->
      <div class="glass-panel rounded-2xl p-4 space-y-3">
        <div class="flex flex-wrap gap-2 items-center">
          <div class="flex-1 min-w-[160px]">
            <label class="block text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç (Event)</label>
            <select id="att-event-sel" class="input-field w-full rounded-xl px-3 py-2 text-sm">
              <option value="">‚Äî ‡§∏‡§≠‡•Ä Events ‚Äî</option>
            </select>
          </div>
          <div class="flex-1 min-w-[130px]">
            <label class="block text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∏‡•á</label>
            <input id="att-date-from" type="date" class="input-field w-full rounded-xl px-3 py-2 text-sm"/>
          </div>
          <div class="flex-1 min-w-[130px]">
            <label class="block text-xs text-slate-400 font-bold mb-1 uppercase tracking-wider">‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§§‡§ï</label>
            <input id="att-date-to" type="date" class="input-field w-full rounded-xl px-3 py-2 text-sm"/>
          </div>
          <div class="flex gap-2 pt-4">
            <button id="btn-att-load" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm flex items-center gap-2 transition">
              <i class="fa-solid fa-rotate"></i> Load
            </button>
            <button id="btn-att-csv" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 hover:text-white text-sm flex items-center gap-1.5 transition">
              <i class="fa-solid fa-file-csv"></i> CSV
            </button>
            <button id="btn-att-excel" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 hover:text-white text-sm flex items-center gap-1.5 transition">
              <i class="fa-solid fa-file-excel"></i> Excel
            </button>
          </div>
        </div>
        <!-- Search -->
        <div class="relative">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
          <input id="att-search" class="input-field w-full rounded-xl pl-8 pr-3 py-2 text-sm" placeholder="‡§®‡§æ‡§Æ / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ / ‡§ú‡§ø‡§≤‡§æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..."/>
        </div>
      </div>

      <!-- KPI cards per event -->
      <div id="att-event-kpi" class="grid grid-cols-2 gap-3 md:grid-cols-4"></div>

      <!-- Event-wise summary cards -->
      <div id="att-event-summary" class="space-y-3"></div>

      <!-- Attendance list table -->
      <div class="glass-panel rounded-2xl overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
          <div class="font-bold text-sm text-white flex items-center gap-2">
            <i class="fa-solid fa-list text-emerald-400"></i>
            ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡•Ç‡§ö‡•Ä
          </div>
          <div class="text-xs text-slate-400"><span id="att-count">0</span> ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡•ç‡§§‡§æ</div>
        </div>

        <!-- Mobile cards -->
        <div id="att-mobile-cards" class="space-y-2 p-3 md:hidden"></div>

        <!-- Desktop table -->
        <div class="hidden md:block overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-slate-900/80 text-[11px] uppercase text-slate-400 font-bold">
              <tr>
                <th class="px-3 py-3 w-12">#</th>
                <th class="px-3 py-3">Photo</th>
                <th class="px-3 py-3">‡§®‡§æ‡§Æ</th>
                <th class="px-3 py-3">Mobile</th>
                <th class="px-3 py-3">‡§ú‡§ø‡§≤‡§æ / ‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ / ‡§Æ‡§Ç‡§°‡§≤</th>
                <th class="px-3 py-3">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th>
                <th class="px-3 py-3">‡§∏‡§Æ‡§Ø</th>
                <th class="px-3 py-3">Action</th>
              </tr>
            </thead>
            <tbody id="att-tbody" class="divide-y divide-slate-800/60 text-slate-300">
              <tr><td colspan="8" class="px-4 py-10 text-center text-slate-500 italic">Load ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: Data -->
    <section id="tab-data" class="tab-content hidden animate-fade-in space-y-4">
      <div class="glass-panel rounded-2xl p-4">

        <!-- ‚îÄ‚îÄ Top bar: search + filters ‚îÄ‚îÄ -->
        <div class="flex flex-wrap gap-2 mb-4">
          <!-- Search -->
          <div class="relative flex-1 min-w-[160px]">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
            <input id="dataSearch" class="input-field w-full rounded-xl pl-8 pr-3 py-2 text-sm" placeholder="‡§®‡§æ‡§Æ / mobile ‡§ñ‡•ã‡§ú‡•á‡§Ç..." />
          </div>
          <!-- Form type -->
          <select id="dataFormSel" class="input-field rounded-xl px-3 py-2 text-sm min-w-[120px]">
            <option value="__all__">‡§∏‡§≠‡•Ä Forms</option>
            <option value="visitor_form">Visitor</option>
            <option value="party_attendance">Attendance</option>
            <option value="president_tour_form">Tour</option>
            <option value="mandal_reporting">Mandal Report</option>
            <option value="coordinator_form">Coordinator</option>
            <option value="program_info">Program Info</option>
          </select>
          <!-- Date range -->
          <input id="dateFrom" type="date" class="input-field rounded-xl px-3 py-2 text-sm" title="From date" />
          <input id="dateTo" type="date" class="input-field rounded-xl px-3 py-2 text-sm" title="To date" />
          <!-- Sort -->
          <select id="dataSort" class="input-field rounded-xl px-3 py-2 text-sm">
            <option value="created_at_desc">‡§®‡§Ø‡§æ ‡§™‡§π‡§≤‡•á</option>
            <option value="created_at_asc">‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§™‡§π‡§≤‡•á</option>
            <option value="name_asc">‡§®‡§æ‡§Æ A-Z</option>
            <option value="mobile_asc">Mobile</option>
          </select>
          <button id="btnLoadData" class="px-4 py-2 rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-bold text-sm transition flex items-center gap-1.5">
            <i class="fa-solid fa-filter"></i> Load
          </button>
          <button id="btnExportCsv" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 hover:text-white text-sm transition flex items-center gap-1.5">
            <i class="fa-solid fa-download"></i> CSV
          </button>
        </div>

        <!-- ‚îÄ‚îÄ KPI Pills ‚îÄ‚îÄ -->
        <div class="flex flex-wrap gap-2 mb-4">
          <div class="flex-1 min-w-[100px] bg-slate-900/60 rounded-xl px-4 py-3 border border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase font-bold">Total</div>
            <div id="kpiTotal" class="text-2xl font-extrabold text-white">‚Äî</div>
          </div>
          <div class="flex-1 min-w-[100px] bg-slate-900/60 rounded-xl px-4 py-3 border border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase font-bold">‡§Ü‡§ú</div>
            <div id="kpiToday" class="text-2xl font-extrabold text-orange-400">‚Äî</div>
          </div>
          <div class="flex-1 min-w-[100px] bg-slate-900/60 rounded-xl px-4 py-3 border border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase font-bold">Unique Mobile</div>
            <div id="kpiUnique" class="text-2xl font-extrabold text-blue-400">‚Äî</div>
          </div>
          <div class="flex-1 min-w-[100px] bg-slate-900/60 rounded-xl px-4 py-3 border border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase font-bold">Photos</div>
            <div id="kpiPhotos" class="text-2xl font-extrabold text-pink-400">‚Äî</div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Cards (mobile) / Table (desktop) ‚îÄ‚îÄ -->

        <!-- Mobile: card view -->
        <div id="dataMobileCards" class="space-y-2 md:hidden"></div>

        <!-- Desktop: table view -->
        <div class="hidden md:block rounded-xl border border-slate-800 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-900/80 text-[11px] uppercase text-slate-400 font-bold">
                <tr>
                  <th class="px-3 py-3 cursor-pointer hover:text-white select-none" data-sort="created_at">
                    ‡§∏‡§Æ‡§Ø <i class="fa-solid fa-sort ml-1 text-slate-600"></i>
                  </th>
                  <th class="px-3 py-3">Form</th>
                  <th class="px-3 py-3">‡§®‡§æ‡§Æ</th>
                  <th class="px-3 py-3">Mobile</th>
                  <th class="px-3 py-3">‡§ú‡§ø‡§≤‡§æ / ‡§∏‡•ç‡§•‡§æ‡§®</th>
                  <th class="px-3 py-3">Photo</th>
                  <th class="px-3 py-3"></th>
                </tr>
              </thead>
              <tbody id="dataTbody" class="divide-y divide-slate-800/60 text-slate-300">
                <tr><td colspan="7" class="px-4 py-10 text-center text-slate-500 italic">Load ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-3 flex-wrap gap-2">
          <div class="text-xs text-slate-500">
            ‡§¶‡§ø‡§ñ ‡§∞‡§π‡•á: <span id="loadedCount" class="text-white font-bold">0</span> entries
          </div>
          <div class="flex gap-2">
            <button id="btnPrevPage" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-white border border-slate-700 disabled:opacity-40 transition">‚Üê Prev</button>
            <button id="btnNextPage" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-white border border-slate-700 disabled:opacity-40 transition">Next ‚Üí</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Analytics -->
    <!-- ‚îÄ‚îÄ Photo Gallery Tab ‚îÄ‚îÄ -->
    <section id="tab-gallery" class="tab-content hidden animate-fade-in space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <i class="fa-solid fa-images text-pink-400"></i> Photo Gallery
        </h2>
        <div class="flex items-center gap-2">
          <span id="photosTotal" class="text-xs text-slate-500"></span>
          <button id="galleryRefreshBtn" class="px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 text-slate-300 text-xs hover:text-white transition flex items-center gap-1.5">
            <i class="fa-solid fa-arrows-rotate"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Photos Grid -->
      <div class="glass-panel rounded-2xl p-4">
        <div id="galleryGrid" class="grid grid-cols-3 sm:grid-cols-5 lg:grid-cols-8 gap-1.5">
          <div class="col-span-full text-slate-500 text-sm text-center py-8">Gallery tab click ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ load ‡§π‡•ã‡§ó‡§æ...</div>
        </div>
        <div class="mt-4 flex justify-center">
          <button id="loadMorePhotosBtn" class="hidden px-5 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-300 text-xs hover:text-white transition flex items-center gap-1.5">
            <i class="fa-solid fa-chevron-down"></i> ‡§î‡§∞ Photos ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
          </button>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê PHOTO DETAIL SLIDESHOW ‚ïê‚ïê -->
    <div id="photoSlideOverlay" class="hidden fixed inset-0 z-[9999] bg-slate-950 flex flex-col">
      <!-- Top bar -->
      <div class="flex items-center justify-between px-4 py-2.5 bg-slate-900/95 border-b border-slate-800 shrink-0">
        <span id="photoSlideTitle" class="text-sm font-bold text-orange-400 truncate max-w-[40vw]"></span>
        <div class="flex items-center gap-3">
          <span id="photoSlideCounter" class="text-xs text-slate-400"></span>
          <button id="photoSlideClose" class="w-8 h-8 rounded-full bg-slate-800 text-slate-300 hover:text-white flex items-center justify-center">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>

      <!-- Main body: LEFT photo + RIGHT details -->
      <div class="flex-1 flex overflow-hidden min-h-0">

        <!-- LEFT: Photo + nav arrows -->
        <div class="flex-1 relative bg-black flex items-center justify-center min-w-0 overflow-hidden">
          <button id="photoSlidePrev" class="absolute left-3 z-10 w-10 h-10 rounded-full bg-slate-900/80 border border-slate-700 text-orange-400 flex items-center justify-center hover:bg-slate-800 transition">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <img id="photoSlideImg" src="" class="max-w-full max-h-full object-contain" style="max-height:calc(100vh - 120px)" />
          <button id="photoSlideNext" class="absolute right-3 z-10 w-10 h-10 rounded-full bg-slate-900/80 border border-slate-700 text-orange-400 flex items-center justify-center hover:bg-slate-800 transition">
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>

        <!-- RIGHT: Details panel (scrollable) -->
        <div class="w-72 lg:w-80 shrink-0 bg-slate-900 border-l border-slate-800 flex flex-col overflow-y-auto">

          <!-- ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä -->
          <div class="p-4 border-b border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase tracking-wider font-bold mb-3">
              <i class="fa-solid fa-calendar-days mr-1"></i> ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä
            </div>
            <div id="photoSlideEventInfo" class="space-y-2"></div>
          </div>

          <!-- ‡§á‡§∏ ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§î‡§∞ Photos -->
          <div class="p-4 border-b border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase tracking-wider font-bold mb-2">
              <i class="fa-solid fa-images mr-1"></i> ‡§á‡§∏ ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ï‡•Ä Photos
            </div>
            <div id="photoSlideEventPhotos" class="grid grid-cols-4 gap-1"></div>
          </div>

          <!-- ‡§á‡§∏ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡•Ä ‡§∏‡§≠‡•Ä Photos -->
          <div class="p-4">
            <div class="text-[10px] text-slate-500 uppercase tracking-wider font-bold mb-2">
              <i class="fa-solid fa-person mr-1"></i> ‡§á‡§∏ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡•Ä Photos
            </div>
            <div id="photoSlidePersonPhotos" class="grid grid-cols-4 gap-1"></div>
          </div>
        </div>
      </div>
    </div>

    <section id="tab-analytics" class="tab-content hidden animate-fade-in space-y-6">
      <div class="flex justify-end">
         <button id="btnRefreshCharts" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-xs font-bold text-white transition-colors border border-slate-700"><i class="fa-solid fa-rotate mr-2"></i>Refresh Charts</button>
      </div>
      <div class="grid md:grid-cols-2 gap-6">
         <div class="glass-panel p-5 rounded-2xl">
            <h4 class="text-sm font-bold text-slate-300 mb-4">Submission Trends (14 Days)</h4>
            <div class="h-[250px]"><canvas id="chartByDay"></canvas></div>
         </div>
         <div class="glass-panel p-5 rounded-2xl">
            <h4 class="text-sm font-bold text-slate-300 mb-4">By Form Type</h4>
            <div class="h-[250px]"><canvas id="chartByForm"></canvas></div>
         </div>
         <div class="glass-panel p-5 rounded-2xl md:col-span-2">
            <h4 class="text-sm font-bold text-slate-300 mb-4">Top Districts</h4>
            <div class="h-[200px]"><canvas id="chartDistrict"></canvas></div>
         </div>
      </div>
    </section>
    
    <!-- TAB: Backend Info -->
    <section id="tab-backend" class="tab-content hidden animate-fade-in">
       <div class="glass-panel rounded-2xl p-8 text-center">
          <div class="inline-flex w-16 h-16 rounded-full bg-slate-800 items-center justify-center mb-4">
             <i class="fa-solid fa-server text-2xl text-slate-400"></i>
          </div>
          <h2 class="text-xl font-bold text-white">Backend Configuration</h2>
          <p class="text-sm text-slate-400 mt-2 max-w-lg mx-auto">This console connects to the EventLens AWS Lambda infrastructure. Ensure your user account has `political_admin` claims.</p>
          
          <div class="mt-8 grid gap-4 max-w-2xl mx-auto text-left">
             <div class="bg-slate-950/50 rounded-lg p-4 border border-slate-800 font-mono text-xs text-slate-300">
                <span class="text-orange-500">POST</span> /prod/political/forms
             </div>
             <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900/30 p-3 rounded border border-slate-800">
                   <div class="text-[10px] text-slate-500 uppercase font-bold">Action</div>
                   <div class="text-sm text-white font-mono mt-1">admin_save_config</div>
                </div>
                <div class="bg-slate-900/30 p-3 rounded border border-slate-800">
                    <div class="text-[10px] text-slate-500 uppercase font-bold">Action</div>
                    <div class="text-sm text-white font-mono mt-1">admin_list_entries</div>
                 </div>
             </div>
          </div>
       </div>
    </section>

  </div>
</div>
```

  </main>

  <!-- Modal -->

  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-[60] backdrop-blur-sm">
    <div class="absolute inset-0 bg-black/80" id="modalBackdrop"></div>
    <div class="relative max-w-2xl w-[90%] rounded-2xl border border-slate-700 bg-slate-900 shadow-2xl overflow-hidden animate-slide-up">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 bg-slate-900/50">
        <div>
          <h3 class="text-lg font-bold text-white">Data Details</h3>
          <div id="modalMeta" class="text-xs text-slate-400 font-mono mt-1">ID: ...</div>
        </div>
        <button id="btnCloseModal" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors flex items-center justify-center">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-0 overflow-auto max-h-[70vh]">
        <pre id="modalJson" class="text-xs text-green-400 bg-[#0d1117] p-6 font-mono overflow-auto"></pre>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->

  <div id="authModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
      <h3 class="text-lg font-bold text-white mb-2">Update Access Token</h3>
      <p class="text-xs text-slate-400 mb-4">Your session has expired or the token is invalid. Please paste a new ID Token below.</p>
      <textarea id="authTokenInput" class="w-full h-24 bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs text-slate-300 font-mono mb-4 focus:border-orange-500 outline-none" placeholder="Paste id_token here..."></textarea>
      <div class="flex justify-end gap-3">
        <button id="btnCancelAuth" class="px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white hover:bg-slate-800">Cancel</button>
        <button id="btnSaveAuth" class="px-4 py-2 rounded-lg text-xs font-bold text-white bg-orange-600 hover:bg-orange-500">Save & Reload</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- Constants & Utils ---
  const API_ID = "vxid0yoovj"; // Replace if needed
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  const FORMS_URL = `${BASE_URL}/political/forms`;

  const FORM_META = {
    __defaults__: { file: "political_visitor_form.html" },
    visitor_form: { file: "political_visitor_form.html" },
    party_attendance: { file: "political_party_attendance_form.html" },
    president_tour_form: { file: "political_president_tour_form.html" },
    mandal_reporting: { file: "political_mandal_reporting_form.html" },
    coordinator_form: { file: "political_coordinator_entry_form.html" },
    program_info: { file: "political_program_info_form.html" },
  };

  const $ = (id) => document.getElementById(id);
  const qs = (n) => { try { return (new URL(window.location.href)).searchParams.get(n) || ""; } catch(e){ return ""; } };

  function getIdToken(){ return localStorage.getItem("id_token") || localStorage.getItem("idToken") || ""; }
  function extFromMime(m){ if(!m) return "jpg"; if(m.includes("png")) return "png"; if(m.includes("webp")) return "webp"; return "jpg"; }
  async function sha256Hex(file){
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result||""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // --- UI Helpers ---
  function showToast(msg, type = 'info') {
    const container = $('toastContainer');
    const el = document.createElement('div');
    
    let icon = 'fa-info-circle';
    let colors = 'bg-slate-800 border-slate-700 text-white';
    
    if(type === 'success') { icon = 'fa-circle-check'; colors = 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100'; }
    if(type === 'error') { icon = 'fa-circle-exclamation'; colors = 'bg-red-900/90 border-red-500/30 text-red-100'; }
    if(type === 'loading') { icon = 'fa-circle-notch fa-spin'; colors = 'bg-blue-900/90 border-blue-500/30 text-blue-100'; }

    el.className = `toast flex items-center gap-3 px-4 py-3 rounded-xl border shadow-xl min-w-[300px] ${colors}`;
    el.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-medium">${msg}</span>`;
    
    container.appendChild(el);

    if(type !== 'loading') {
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
        setTimeout(() => el.remove(), 300);
      }, 3000);
    }
    return el;
  }

  function openAuthModal() {
      const modal = $('authModal');
      if(modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          $('authTokenInput').focus();
      }
  }

  // --- State & Config ---
  const DEFAULT_CONFIG = {
    defaults: {
      branding: { title: "Political Forms", subtitle: "Visitor Entry System", tagline: "", color1: "#f97316", color2: "#ef4444", logo: { kind: "none" }, header: { kind: "none" }, background: { kind: "none" } },
      programs: ["‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡•ç‡§Æ‡•á‡§≤‡§®","‡§ú‡§®‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï","‡§¨‡•Ç‡§• ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó"],
      fixed_levels: {}
    },
    forms: { visitor_form: {}, party_attendance: {}, president_tour_form: {}, mandal_reporting: {}, coordinator_form: {}, program_info: {} }
  };

  let state = {
    cid: (qs("cid") || qs("collection_id") || "").trim(),
    target: "visitor_form",
    config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
    pendingAssets: {},
    cacheBust: Date.now(),
    lastPreviewDoc: "",
    allItems: [],
    viewItems: [],
    nextToken: null,
    prevStack: [],
    sort: { key: "created_at", dir: "desc" },
    charts: { byForm: null, byDay: null, byDistrict: null }
  };

  // --- Core Logic ---
  function ensureFormObj(ft){ if (!state.config.forms[ft]) state.config.forms[ft] = {}; }
  function deepMerge(base, override){
    if (!override || typeof override !== "object") return base;
    const out = Array.isArray(base) ? [...base] : { ...base };
    Object.keys(override).forEach(k=>{
      const bv = out[k], ov = override[k];
      if (Array.isArray(ov)) out[k] = ov;
      else if (ov && typeof ov === "object" && bv && typeof bv === "object" && !Array.isArray(bv)) out[k] = deepMerge(bv, ov);
      else out[k] = ov;
    });
    return out;
  }

  function getEffectiveBranding(ft) {
    const d = state.config.defaults.branding;
    const o = (ft !== "__defaults__") ? (state.config.forms[ft]?.branding || {}) : {};
    return { ...d, ...o };
  }

  
function srcdocSafeUrl(url) {
  if (!url) return "";
  if (String(url).startsWith("blob:")) return "";
  return url;
}

function withCacheBust(url) {
  if (!url) return "";
  const u = String(url);
  const lower = u.toLowerCase();
  // Don't alter blob/data URLs (breaks), and don't alter S3 pre-signed URLs (breaks signature).
  if (lower.startsWith("blob:") || lower.startsWith("data:")) return u;
  if (/X-Amz-(Signature|Credential|Algorithm)=/i.test(u)) return u;
  const sep = u.includes("?") ? "&" : "?";
  return u + sep + "cb=" + String(state.cacheBust || Date.now());
}

function escHtml(v) {
  const s = (v === null || v === undefined) ? "" : String(v);
  return s
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// Collect current branding fields from UI into state.config (defaults or specific form)
function collectBrandFromUI() {
  if (!state.config) return;
  const target = state.target || "__defaults__";

  const title = ($("b_title") && $("b_title").value !== undefined) ? $("b_title").value.trim() : "";
  const subtitle = ($("b_subtitle") && $("b_subtitle").value !== undefined) ? $("b_subtitle").value.trim() : "";
  const tagline = ($("b_tagline") && $("b_tagline").value !== undefined) ? $("b_tagline").value.trim() : "";
  const color1 = ($("b_c1") && $("b_c1").value) ? $("b_c1").value.trim() : "#f97316";
  const color2 = ($("b_c2") && $("b_c2").value) ? $("b_c2").value.trim() : "#ef4444";

  if (!state.config.defaults) state.config.defaults = {};
  if (!state.config.defaults.branding) state.config.defaults.branding = {};
  if (!state.config.forms) state.config.forms = {};
  if (!state.config.global) state.config.global = { tagline: "Powered by EventLens" };

  if (target === "__defaults__") {
    // Defaults live in defaults.branding (getEffectiveForm reads from branding.*)
    const b = state.config.defaults.branding;
    b.title = title;
    b.subtitle = subtitle;
    b.tagline = tagline;
    b.color1 = color1;
    b.color2 = color2;
  } else {
    // Per-form text is stored at the form root, but colors live in form.branding
    if (!state.config.forms[target]) state.config.forms[target] = {};
    const f = state.config.forms[target];
    f.title = title;
    f.subtitle = subtitle;
    f.tagline = tagline;
    if (!f.branding) f.branding = {};
    f.branding.color1 = color1;
    f.branding.color2 = color2;
  }

  return { color1, color2 };
}


function getEffectiveForm(ft) {
  const cfg = state.config || {};
  const forms = cfg.forms || {};
  const defaults = cfg.defaults || {};
  const global = cfg.global || {};
  const form = (ft && ft !== "__defaults__") ? (forms[ft] || {}) : {};
  const brandingDefaults = (defaults.branding || {});
  const brandingForm = (form.branding || {});
  const branding = deepMerge(brandingDefaults, brandingForm);

  const title = form.title || cfg.form?.title || branding.title || "Form";
  const subtitle = form.subtitle || cfg.form?.subtitle || branding.subtitle || "";
  const tagline = (form.tagline ?? cfg.form?.tagline ?? branding.tagline ?? global.tagline ?? "");

  const pend = (state.pendingAssets?.[ft] || {});
  const logoUrl = pend.logo?.previewUrl || form.logo_url || branding.logo?.url || (typeof branding.logo?.value === "string" && branding.logo.value.startsWith("http") ? branding.logo.value : "");
  const headerUrl = pend.header?.previewUrl || form.header_url || branding.header?.url || (typeof branding.header?.value === "string" && branding.header.value.startsWith("http") ? branding.header.value : "");
  const bgUrl = pend.background?.previewUrl || form.background_url || branding.background?.url || (typeof branding.background?.value === "string" && branding.background.value.startsWith("http") ? branding.background.value : "");

  const color1 = branding.color1 || "#f97316";
  const color2 = branding.color2 || "#ef4444";

  return { ft, form, branding, title, subtitle, tagline, logoUrl, headerUrl, bgUrl, color1, color2 };
}


function renderBrandInputsFromConfig() {
  if(!state.config) return;
  const ft = state.target || "visitor_form";
  const eff = getEffectiveForm(ft);

  // Title/Sub/Tagline inputs (users expect these to change form heading)
  if($("b_title")) $("b_title").value = eff.title || "";
  if($("b_subtitle")) $("b_subtitle").value = eff.subtitle || "";
  if($("b_tagline")) $("b_tagline").value = eff.tagline || "";

  // Colors
  if($("b_c1")) $("b_c1").value = eff.color1 || "#f97316";
  if($("b_c2")) $("b_c2").value = eff.color2 || "#ef4444";

  // Current images previews
  if($("prev_logo")) $("prev_logo").src = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";
  if($("prev_header")) $("prev_header").src = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
  if($("prev_bg")) $("prev_bg").src = eff.bgUrl ? withCacheBust(eff.bgUrl) : "";
}

function renderBrandPreview() {
  if(!state.config) return;

  const liveOn = $("livePreviewToggle") ? $("livePreviewToggle").checked : true;
  const overlay = $("customPreviewOverlay");
  if (overlay) overlay.style.opacity = liveOn ? "1" : "0";

  const eff = getEffectiveForm(state.target || "visitor_form");

  // Text
  const titleEl = $("previewTitle");
  const subtitleEl = $("previewSubtitle");
  const taglineEl = $("previewTagline");
  if(titleEl) titleEl.textContent = eff.title || "";
  if(subtitleEl) subtitleEl.textContent = eff.subtitle || "";
  if(taglineEl) taglineEl.textContent = eff.tagline || "";

  // Gradient + swatches
  const headerBar = $("previewHeaderBar");
  if(headerBar) headerBar.style.backgroundImage = `linear-gradient(90deg, ${eff.color1}, ${eff.color2})`;
  const sw1 = $("sw1"); const sw2 = $("sw2");
  if(sw1) sw1.style.backgroundColor = eff.color1;
  if(sw2) sw2.style.backgroundColor = eff.color2;

  // Background image (previewBg is a DIV, not an IMG)
  const bgEl = $("previewBg");
  const bg = eff.bgUrl ? withCacheBust(eff.bgUrl) : "";
  if(bgEl) bgEl.style.backgroundImage = bg ? `url("${bg}")` : "";

  // Header image
  const headerWrap = $("previewHeaderImgWrap");
  const headerImg = $("previewHeaderImg");
  const header = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
  if(headerWrap) headerWrap.classList.remove("hidden");
  if(headerImg) {
    if(header) headerImg.src = header;
    else {
      const c1 = (eff.color1 || "#0f172a").replace("#","%23");
      const c2 = (eff.color2 || "#111827").replace("#","%23");
      headerImg.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='240'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='${c1}'/%3E%3Cstop offset='1' stop-color='${c2}'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23g)'/%3E%3C/svg%3E`;
    }
  }

  // Logo
  const logoImg = $("previewLogo");
  const logoIcon = $("previewLogoIcon");
  const logo = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";
  if(logoImg) {
    if(logo) {
      logoImg.src = logo;
      logoImg.classList.remove("hidden");
      if(logoIcon) logoIcon.classList.add("hidden");
    } else {
      logoImg.classList.add("hidden");
      if(logoIcon) logoIcon.classList.remove("hidden");
    }
  }

  renderPreviewTabs();
}


function buildPreviewSrcDoc(ft) {
  const eff = getEffectiveForm(ft || "visitor_form");
  const c1 = eff.color1 || "#f97316";
  const c2 = eff.color2 || "#ef4444";
  const bg = eff.bgUrl ? withCacheBust(eff.bgUrl) : "";
  const header = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
  const logo = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";

  const rawPrograms =
    eff.form?.program_options ||
    eff.form?.programs ||
    state.config?.defaults?.programs ||
    [];

  const programs = Array.isArray(rawPrograms) ? rawPrograms : [];
  const optionsHtml = programs.slice(0, 40).map(p => `<option>${escHtml(p)}</option>`).join("");

  const headerBlock = header
    ? `<img class="header-img" src="${escHtml(header)}" alt="header" />`
    : `<div class="header-grad"></div>`;

  const logoBlock = logo
    ? `<img class="logo" src="${escHtml(logo)}" alt="logo" />`
    : `<div class="logo ph">LOGO</div>`;

  const bgStyle = bg ? `background-image:url('${escHtml(bg)}');` : "";

  return `<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preview</title>
  <style>
    :root{--c1:${c1};--c2:${c2};}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e5e7eb; background:#0b1220; ${bgStyle} background-size:cover; background-position:center;}
    .overlay{min-height:100vh; background:linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.88));}
    .wrap{max-width:420px;margin:0 auto; padding:14px;}
    .card{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); border-radius:18px; overflow:hidden; box-shadow:0 12px 30px rgba(0,0,0,.35);}
    .header{position:relative;height:150px; overflow:hidden;}
    .header-img{width:100%;height:100%;object-fit:cover;display:block;}
    .header-grad{width:100%;height:100%; background:linear-gradient(135deg,var(--c1),var(--c2));}
    .logo{position:absolute;left:14px;bottom:-26px;width:58px;height:58px;border-radius:16px;border:2px solid rgba(255,255,255,.35); background:rgba(2,6,23,.7); object-fit:cover; box-shadow:0 10px 18px rgba(0,0,0,.35);}
    .logo.ph{display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#94a3b8;}
    .content{padding:44px 14px 16px;}
    .title{font-size:18px;font-weight:800;line-height:1.2;margin:0;}
    .sub{margin:6px 0 0 0;font-size:12px;color:#cbd5e1;}
    .tag{margin:6px 0 0 0;font-size:11px;color:#94a3b8;}
    .field{margin-top:12px;}
    label{display:block;font-size:11px;color:#cbd5e1;margin-bottom:6px;}
    input,select{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.14); background:rgba(2,6,23,.55); color:#e5e7eb; padding:12px 12px; outline:none;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .btn{margin-top:14px;width:100%;border:none;border-radius:14px;padding:12px 14px;font-weight:800;color:white; cursor:pointer;background:linear-gradient(90deg,var(--c1),var(--c2));}
    .note{margin-top:10px;font-size:10px;color:#64748b;text-align:center;}
  </style>

</head>
<body>
  <div class="overlay">
    <div class="wrap">
      <div class="card">
        <div class="header">
          ${headerBlock}
          ${logoBlock}
        </div>
        <div class="content">
          <h1 class="title">${escHtml(eff.title || "")}</h1>
          ${eff.subtitle ? `<div class="sub">${escHtml(eff.subtitle)}</div>` : ``}
          ${eff.tagline ? `<div class="tag">${escHtml(eff.tagline)}</div>` : ``}

```
      <div class="field">
        <label>‡§®‡§æ‡§Æ / Name</label>
        <input placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç" />
      </div>

      <div class="row">
        <div class="field">
          <label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
          <input placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ" />
        </div>
        <div class="field">
          <label>‡§ú‡§ø‡§≤‡§æ</label>
          <input placeholder="‡§ú‡§ø‡§≤‡§æ" />
        </div>
      </div>

      ${optionsHtml ? `
      <div class="field">
        <label>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ / Program</label>
        <select>
          <option value="">Select</option>
          ${optionsHtml}
        </select>
      </div>` : ``}

      <div class="field">
        <label>‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä</label>
        <input placeholder="Optional" />
      </div>

      <button class="btn">Submit</button>
      <div class="note">Admin Preview ‚Ä¢ Live Branding</div>
    </div>
  </div>
</div>
```

  </div>
</body>
</html>`;
}

function renderFormPreviewIframe() {
const iframe = $(‚ÄúformPreviewIframe‚Äù);
if (!iframe) return;
const doc = buildPreviewSrcDoc(state.target || ‚Äúvisitor_form‚Äù);
state.lastPreviewDoc = doc;

// Use a Blob URL (same-origin) instead of srcdoc so blob: preview images also work reliably.
try{
if (state._previewBlobUrl) URL.revokeObjectURL(state._previewBlobUrl);
}catch(e){}
try{
const blob = new Blob([doc], { type: ‚Äútext/html‚Äù });
const url = URL.createObjectURL(blob);
state._previewBlobUrl = url;
iframe.removeAttribute(‚Äúsrcdoc‚Äù);
iframe.src = url;
}catch(e){
// Fallback
iframe.srcdoc = doc;
}
}

function openCurrentPreviewInNewTab() {
const doc = state.lastPreviewDoc || buildPreviewSrcDoc(state.target || ‚Äúvisitor_form‚Äù);
const blob = new Blob([doc], { type: ‚Äútext/html‚Äù });
const url = URL.createObjectURL(blob);
window.open(url, ‚Äú_blank‚Äù, ‚Äúnoopener‚Äù);
setTimeout(() => URL.revokeObjectURL(url), 60_000);
}

function renderPreviewTabs() {
const wrap = $(‚ÄúpreviewTabs‚Äù);
if(!wrap || !state.config) return;
const forms = state.config.forms || {};
const keys = Object.keys(forms);

wrap.innerHTML = ‚Äú‚Äù;
const makeBtn = (ft, label) => {
const b = document.createElement(‚Äúbutton‚Äù);
const active = (ft === state.target);
b.className = ‚Äúpx-3 py-2 text-xs rounded-lg border ‚Äú + (active
? ‚Äúbg-white/15 border-white/25 text-white‚Äù
: ‚Äúbg-white/5 border-white/10 text-slate-300 hover:bg-white/10‚Äù);
b.textContent = label;
b.addEventListener(‚Äúclick‚Äù, () => {
state.target = ft;
const sel = $(‚ÄútargetFormSel‚Äù);
if(sel) sel.value = ft;
renderAll();
renderFormPreviewIframe();
renderBrandPreview();
window.scrollTo({ top: 0, behavior: ‚Äúsmooth‚Äù });
});
return b;
};

wrap.appendChild(makeBtn(‚Äù**defaults**‚Äù, ‚ÄúDefaults‚Äù));

keys.forEach(ft => {
const label = (forms[ft]?.title || ft).toString().slice(0, 22);
wrap.appendChild(makeBtn(ft, label));
});
}

function renderAllFormsGrid() {
const grid = $(‚ÄúallFormsGrid‚Äù);
if(!grid || !state.config) return;

const forms = state.config.forms || {};
const keys = Object.keys(forms);

grid.innerHTML = ‚Äú‚Äù;

const addCard = (ft, eff) => {
const btn = document.createElement(‚Äúbutton‚Äù);
btn.type = ‚Äúbutton‚Äù;
btn.className = ‚Äútext-left rounded-2xl overflow-hidden border ‚Äú + (ft === state.target
? ‚Äúborder-white/25 bg-white/10‚Äù
: ‚Äúborder-white/10 bg-white/5 hover:bg-white/10‚Äù);

```
const header = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
const logo = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";

const headerEl = header
  ? `<img src="${escHtml(header)}" class="w-full h-24 object-cover" />`
  : `<div class="w-full h-24" style="background:linear-gradient(135deg,${escHtml(eff.color1)},${escHtml(eff.color2)})"></div>`;

const logoEl = logo
  ? `<img src="${escHtml(logo)}" class="w-10 h-10 rounded-xl object-cover border border-white/25 bg-slate-900" />`
  : `<div class="w-10 h-10 rounded-xl flex items-center justify-center text-[10px] font-extrabold border border-white/15 bg-slate-900 text-slate-400">LOGO</div>`;

btn.innerHTML = `
  ${headerEl}
  <div class="p-3">
    <div class="flex items-start gap-3">
      ${logoEl}
      <div class="min-w-0">
        <div class="font-bold text-slate-100 truncate">${escHtml(eff.title || ft)}</div>
        <div class="text-xs text-slate-400 truncate">${escHtml(eff.subtitle || ft)}</div>
      </div>
    </div>
    <div class="mt-3">
      <div class="h-2 rounded-full" style="background:linear-gradient(90deg,${escHtml(eff.color1)},${escHtml(eff.color2)})"></div>
    </div>
  </div>
`;

btn.addEventListener("click", () => {
  state.target = ft;
  const sel = $("targetFormSel");
  if(sel) sel.value = ft;
  renderAll();
  renderFormPreviewIframe();
  renderBrandPreview();
  window.scrollTo({ top: 0, behavior: "smooth" });
});

grid.appendChild(btn);
```

};

// Defaults card
addCard(‚Äù**defaults**‚Äù, getEffectiveForm(‚Äù**defaults**‚Äù));

keys.forEach(ft => addCard(ft, getEffectiveForm(ft)));
}

function setPending(kind, file, uiKey) {
uiKey = uiKey || kind;

```
// Ensure container exists
if (!state.pendingAssets) state.pendingAssets = {};
if (!state.pendingAssets[state.target]) state.pendingAssets[state.target] = {};

const nameEl = $(`name_${uiKey}`);
const prevImg = $(`prev_${uiKey}`);
const iconEl = $(`icon_${uiKey}`);

// Clear
if (!file) {
  try {
    if (state.pendingAssets[state.target]?.[kind]?.previewUrl) {
      URL.revokeObjectURL(state.pendingAssets[state.target][kind].previewUrl);
    }
  } catch(e){}
  if (state.pendingAssets[state.target]) delete state.pendingAssets[state.target][kind];

  if (nameEl) nameEl.textContent = "No file selected";
  if (prevImg) { prevImg.src = ""; prevImg.classList.add("hidden"); }
  if (iconEl) iconEl.classList.remove("hidden");

  renderBrandPreview();
  renderFormPreviewIframe();
  return;
}

// Set
const previewUrl = URL.createObjectURL(file);
state.pendingAssets[state.target][kind] = { file, previewUrl };

if (nameEl) nameEl.textContent = file.name;

// Immediate preview in thumbnail
if (prevImg) {
  prevImg.src = previewUrl;
  prevImg.classList.remove('hidden');
}
if (iconEl) iconEl.classList.add('hidden');

renderBrandPreview();
renderFormPreviewIframe();
```

}

// ‚Äî API Calls (Restored Robust Logic) (Restored Robust Logic) ‚Äî
async function apiCall(action, payload){
const token = (getIdToken() || ‚Äú‚Äù).trim();
const headers = { ‚ÄúContent-Type‚Äù: ‚Äúapplication/json‚Äù };
if (token) headers[‚ÄúAuthorization‚Äù] = `Bearer ${token}`;

```
let resp;
try{
  resp = await fetch(FORMS_URL, {
    method: "POST",
    cache: "no-store",
    headers,
    body: JSON.stringify({ action, payload })
  });
}catch(e){
  throw new Error("Network error calling API. Check internet / CORS.");
}

if (resp.status === 401) {
  openAuthModal();
  throw new Error("Unauthorized: Session Expired. Use the Key icon to update token.");
}

const txt = await resp.text();
let json = {};
try { json = JSON.parse(txt); } catch(e) { json = { message: txt || "Invalid JSON" }; }

if (!resp.ok) throw new Error(json.message || json.error || `HTTP ${resp.status}`);
return json;
```

}

// Gallery module ‡§ï‡•á ‡§≤‡§ø‡§è expose ‡§ï‡§∞‡•ã
window._adminApiCall = apiCall;
window._adminState = state;

async function apiCallCandidates(actions, payload){
let lastErr = null;
for (const a of actions){
try { return await apiCall(a, payload); } catch(e){ lastErr = e; }
}
throw lastErr || new Error(‚ÄúAPI call failed‚Äù);
}

function guessMimeFromName(name){
const n = (name || ‚Äú‚Äù).toLowerCase();
if (n.endsWith(‚Äù.png‚Äù)) return ‚Äúimage/png‚Äù;
if (n.endsWith(‚Äù.webp‚Äù)) return ‚Äúimage/webp‚Äù;
if (n.endsWith(‚Äù.jpg‚Äù) || n.endsWith(‚Äù.jpeg‚Äù)) return ‚Äúimage/jpeg‚Äù;
return ‚Äú‚Äù;
}

async function initAssetUpload(assetKind, ft, file){
const mime = (file && file.type) ? file.type : (guessMimeFromName(file?.name) || ‚Äúimage/jpeg‚Äù);
const fileName = `${crypto.randomUUID()}.${extFromMime(mime)}`;
const payload = {
collection_id: state.cid,
form_type: ft === ‚Äú**defaults**‚Äù ? ‚Äúvisitor_form‚Äù : ft,
asset_kind: assetKind,
file_name: fileName,
mime_type: mime
};

```
const res = await apiCallCandidates(["admin_init_asset_upload","admin_get_upload_url","admin_upload_init"], payload);
const uploadUrl = res.upload_url || res.url;
if (!uploadUrl) throw new Error("Upload URL missing from backend");

let putResp;
try{
  putResp = await fetch(uploadUrl, { method:"PUT", body: file, headers: { "Content-Type": mime } });
} catch(e){
  throw new Error("S3 upload blocked (CORS). S3 bucket CORS ‡§Æ‡•á‡§Ç PUT allow ‡§ï‡§∞‡•ã.");
}

if (!putResp.ok){
  let t = "";
  try{ t = await putResp.text(); }catch(e){}
  throw new Error(`S3 upload failed: HTTP ${putResp.status} ${t ? ("- " + t.slice(0,120)) : ""}`);
}

const previewUrl = res.preview_url || res.public_url || res.asset_url || res.url_public || "";
const key = res.s3_key || res.asset_key || res.key || "";
if (!key) throw new Error("S3 key missing from backend");
return { kind: "s3", key, previewUrl };
```

}

async function saveConfig() {
if(!state.cid) { showToast(‚ÄúCID missing‚Äù,‚Äúerror‚Äù); return; }
if(!state.config) { showToast(‚ÄúConfig not loaded‚Äù,‚Äúerror‚Äù); return; }

```
const btn = $("btnSave");
const toast = showToast("Saving...","info",0);
if(btn){ btn.disabled = true; btn.textContent = "Saving..."; }

try {
  const ft = state.target || "visitor_form";

  // Users expect Title/Sub/Tagline to change the actual form heading.
  const meta = {
    title: ($("b_title")?.value || "").trim(),
    subtitle: ($("b_subtitle")?.value || "").trim(),
    tagline: ($("b_tagline")?.value || "").trim(),
  };

  const brand = collectBrandFromUI();

  // Apply local changes into state.config
  state.config.defaults = state.config.defaults || {};
  state.config.defaults.branding = state.config.defaults.branding || {};
  state.config.forms = state.config.forms || {};

  if(ft === "__defaults__") {
    state.config.defaults.branding = deepMerge(state.config.defaults.branding, brand);
    if(meta.title) state.config.defaults.branding.title = meta.title;
    if(meta.subtitle) state.config.defaults.branding.subtitle = meta.subtitle;
    if(meta.tagline) state.config.defaults.branding.tagline = meta.tagline;

    state.config.global = state.config.global || {};
    if(meta.tagline) state.config.global.tagline = meta.tagline;
  } else {
    const f = state.config.forms[ft] || (state.config.forms[ft] = {});
    f.title = meta.title || f.title || "";
    f.subtitle = meta.subtitle || f.subtitle || "";
    f.tagline = meta.tagline || f.tagline || "";

    f.branding = deepMerge(f.branding || {}, brand);

    const pending = (state.pendingAssets?.[ft] || {});
    // Upload any pending asset files now (so backend gets NEW keys)
    for (const kind of ["logo","header","background"]) {
      if (pending[kind]?.file && !pending[kind]?.key) {
        const up = await initAssetUpload(kind, ft, pending[kind].file);
        if (up && up.key) {
          pending[kind].key = up.key;
          if (up.previewUrl) {
            pending[kind].previewUrl = up.previewUrl;
            // show immediately in admin preview
            if (kind === "logo") f.logo_url = up.previewUrl;
            if (kind === "header") f.header_url = up.previewUrl;
            if (kind === "background") f.background_url = up.previewUrl;
          }
        }
      }
    }

    if(pending.logo?.key) f.logo_key = pending.logo.key;
    if(pending.header?.key) f.header_key = pending.header.key;
    if(pending.background?.key) f.background_key = pending.background.key;
  }

  // Save to backend (political module)
  await apiCall("admin_save_config", {
      collection_id: state.cid,
      config_type: "political_forms",
      config: state.config
    });

  toast.remove?.();
  showToast("Saved","success");
  // Reload from backend to confirm persisted + refresh signed URLs
  await loadConfig({ allowFallback: false, silent: true });
  // Clear pending for this form (uploaded already)
  if(state.pendingAssets?.[ft]) delete state.pendingAssets[ft];

  // Update local cache + notify open form tabs to refresh branding
  try{ localStorage.setItem(`EL_CFG_${state.cid}`, JSON.stringify(state.config)); }catch(e){}
  try{ localStorage.setItem(`EL_BRAND_PING_${state.cid}`, String(Date.now())); }catch(e){}

  // Note: we do not auto-reload from backend here (prevents preview reverting to older cached config).
  // If you need fresh signed URLs later, use "Refresh Signed URLs".

} catch(e) {
  console.error("Save failed:", e);
  toast.remove?.();
  showToast("Save failed: " + (e?.message || e),"error");
} finally {
  if(btn){ btn.disabled = false; btn.textContent = "Save Config"; }
  state.cacheBust = Date.now();
  renderBrandInputsFromConfig();
  renderAll();
  renderFormPreviewIframe();
}
```

}

async function loadConfig(opts = {}) {
const allowFallback = (opts.allowFallback !== false);
const silent = !!opts.silent;

```
 if(!state.cid) { $('cidPill').classList.add('hidden'); return; }
 $('cidPill').classList.remove('hidden');
 $('cidVal').textContent = state.cid;

 const t = silent ? null : showToast("Loading configuration...", "loading");
 let cfg = null;

 try {
    // Ask backend for latest config; use current target as form_type so shortcut `form` matches.
    const res = await apiCallCandidates(["admin_get_config","admin_get_settings","get_admin_config"], { 
        collection_id: state.cid,
        form_type: (state.target && state.target !== "__defaults__") ? state.target : "visitor_form"
    });
    cfg = res.config || res.data || res.item || null;
 } catch(e) {
    console.error('admin_get_config failed', e);
 }

 // Fallback to local cache ONLY when allowed (otherwise keep current state.config to avoid reverting after save)
 if (!cfg && allowFallback){
    const local = localStorage.getItem(`EL_CFG_${state.cid}`);
    if(local) {
      try{ cfg = JSON.parse(local); } catch(e){}
    }
 }

 if (cfg){
    state.config = deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), cfg);
    try{ localStorage.setItem(`EL_CFG_${state.cid}`, JSON.stringify(cfg)); }catch(e){}
 }

 if(t) t.remove?.();
 renderAll();
 renderBrandInputsFromConfig();
 renderFormPreviewIframe();
```

}

// ‚Äî Rendering & Logic ‚Äî

function renderAll() {
renderBrandPreview();
renderPrograms();
renderLevels();
}

function renderPrograms() {
const ft = state.target === ‚Äú**defaults**‚Äù ? ‚Äú**defaults**‚Äù : state.target;
const scope = $(‚ÄòprogScopeSel‚Äô).value;
let list = [];

```
 if(scope === 'defaults') list = state.config.defaults.programs || [];
 else {
    // Per-form: prefer program_options if present, else programs, else fallback to defaults
    const node = state.config.forms[ft] || {};
    const specific =
      (Array.isArray(node.program_options) && node.program_options.length ? node.program_options :
       (Array.isArray(node.programs) && node.programs.length ? node.programs : null));
    list = specific || state.config.defaults.programs || [];
 }

 const container = $('progList');
 container.innerHTML = '';
 list.forEach((p, idx) => {
    const el = document.createElement('div');
    el.className = "flex items-center justify-between bg-slate-900/50 border border-slate-800 rounded-lg px-3 py-2";
    el.innerHTML = `<span class="text-sm font-medium text-slate-300 truncate">${p}</span> 
                    <button class="text-slate-500 hover:text-red-400 p-1" onclick="deleteProg(${idx})"><i class="fa-solid fa-trash"></i></button>`;
    container.appendChild(el);
 });
 
 window.deleteProg = (idx) => {
     const newList = [...list];
     newList.splice(idx, 1);
     if(scope === 'defaults') state.config.defaults.programs = newList;
     else {
         ensureFormObj(ft);
         state.config.forms[ft].programs = newList;
         state.config.forms[ft].program_options = newList;
     }
     renderPrograms();
 };
```

}

function renderLevels() {
const ft = state.target === ‚Äú**defaults**‚Äù ? ‚Äú**defaults**‚Äù : state.target;
const src = (ft === ‚Äú**defaults**‚Äù) ? state.config.defaults.fixed_levels : (state.config.forms[ft]?.fixed_levels || state.config.defaults.fixed_levels);

```
  $('lvl_mandal_reporting').value = src?.mandal_reporting || "";
  $('lvl_coordinator').value = src?.coordinator || "";
  $('lvl_program_info').value = src?.program_info || "";
```

}

// ‚Äî Data Loading (Restored Real Logic) ‚Äî
function normalizeItem(it){
const payload = it.payload || it.data || it.fields || {};
const createdAt = it.created_at || it.createdAt || it.ts || 0;
const ft = it.form_type || it.formType || payload.form_type || ‚Äú‚Äù;
return {
entry_id: it.entry_id || it.id || ‚Äú‚Äù,
created_at: createdAt,
form_type: ft,
payload,
mobile: payload.mobile || payload.phone || ‚Äú‚Äù,
name: payload.name || payload.full_name || ‚Äú‚Äù,
district: payload.district || ‚Äú‚Äù,
program_name: payload.program_name || payload.program || payload.karyakram || ‚Äú‚Äù
};
}
function dateKeyFromMs(ms){
if (!ms) return ‚Äú‚Äù;
const x = new Date(Number(ms));
return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;
}

async function loadData(direction=‚Äúfresh‚Äù) {
if(!state.cid) return showToast(‚ÄúCID Required‚Äù, ‚Äúerror‚Äù);
const t = showToast(‚ÄúFetching records‚Ä¶‚Äù, ‚Äúloading‚Äù);

```
 let next_token = null;
 if (direction === "next") next_token = state.nextToken || null;
 if (direction === "prev"){ const prev = state.prevStack.pop() || null; next_token = prev; }

 const payload = {
   collection_id: state.cid,
   form_type: $('dataFormSel').value,
   filters: { q: ($('dataSearch').value||"").trim(), date_from: $('dateFrom').value||"", date_to: $('dateTo').value||"" },
   limit: 200,
   next_token
 };

 let res = null;
 try{
   res = await apiCallCandidates(["admin_list_entries","admin_query_entries","list_entries_admin","admin_list_data"], payload);
   state.allItems = (res.items || res.data || res.rows || []).map(normalizeItem);
   state.nextToken = res.next_token || res.nextToken || null;
   try{ localStorage.setItem(`EL_POLITICAL_DATA_CACHE::${state.cid}`, JSON.stringify(state.allItems)); }catch(_){}
   t.remove(); showToast(`Loaded ${state.allItems.length} items`, "success");
 } catch(e){
    // Cache fallback
    try{
        const raw = localStorage.getItem(`EL_POLITICAL_DATA_CACHE::${state.cid}`);
        if(raw){ state.allItems = JSON.parse(raw).map(normalizeItem); t.remove(); showToast("Loaded from cache (Offline)", "info"); }
        else { t.remove(); showToast("Failed to load data", "error"); }
    }catch(_){ t.remove(); showToast("Failed to load data", "error"); }
 }
 
 state.viewItems = state.allItems;
 populateFilterOptions();
 applyClientFilters();
```

}

function getVal(obj, paths){
for(const p of paths){
const parts = p.split(‚Äô.‚Äô);
let cur = obj;
let ok = true;
for(const part of parts){
if(cur && Object.prototype.hasOwnProperty.call(cur, part)) cur = cur[part];
else { ok = false; break; }
}
if(ok && cur !== undefined && cur !== null && String(cur).trim() !== ‚Äú‚Äù) return cur;
}
return ‚Äú‚Äù;
}

function populateFilterOptions(){
const items = state.allItems || [];
const dSet = new Set(), aSet = new Set(), mSet = new Set(), pSet = new Set();
items.forEach(it=>{
const pl = it.payload || it;
const d = getVal(pl, [‚Äúdistrict‚Äù,‚Äújila‚Äù,‚Äú‡§ú‡§ø‡§≤‡§æ‚Äù]);
const a = getVal(pl, [‚Äúvidhansabha‚Äù,‚Äúassembly‚Äù,‚Äú‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ‚Äù]);
const m = getVal(pl, [‚Äúmandal‚Äù,‚Äú‡§Æ‡§Ç‡§°‡§≤‚Äù]);
const pr = getVal(pl, [‚Äúprogram_name‚Äù,‚Äúprogram‚Äù,‚Äú‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‚Äù,‚Äú‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§®‡§æ‡§Æ‚Äù]);
if(d) dSet.add(d);
if(a) aSet.add(a);
if(m) mSet.add(m);
if(pr) pSet.add(pr);
});

```
 function fill(selId, set){
    const sel = $(selId);
    if(!sel) return;
    const cur = sel.value;
    const first = sel.options[0]; // keep "All"
    sel.innerHTML = "";
    sel.appendChild(first);
    Array.from(set).sort((x,y)=>String(x).localeCompare(String(y), 'hi')).forEach(v=>{
       const opt = document.createElement('option');
       opt.value = v;
       opt.textContent = v;
       sel.appendChild(opt);
    });
    sel.value = cur || "";
 }
 fill("filterDistrict", dSet);
 fill("filterAssembly", aSet);
 fill("filterMandal", mSet);
 fill("filterProgram", pSet);
```

}

function applyClientFilters(){
const ftSel = $(‚ÄòfilterFormType‚Äô);
const d = ($(‚ÄòfilterDistrict‚Äô)?.value || ‚Äú‚Äù).trim();
const a = ($(‚ÄòfilterAssembly‚Äô)?.value || ‚Äú‚Äù).trim();
const m = ($(‚ÄòfilterMandal‚Äô)?.value || ‚Äú‚Äù).trim();
const pr = ($(‚ÄòfilterProgram‚Äô)?.value || ‚Äú‚Äù).trim();
const ft = ftSel ? ftSel.value : ‚Äú**all**‚Äù;

```
 const from = $('dateFrom')?.value ? new Date($('dateFrom').value + "T00:00:00") : null;
 const to = $('dateTo')?.value ? new Date($('dateTo').value + "T23:59:59") : null;

 const out = (state.allItems || []).filter(it=>{
    if(ft && ft !== "__all__" && it.form_type !== ft) return false;
    const pl = it.payload || it;
    const dd = getVal(pl, ["district","jila","‡§ú‡§ø‡§≤‡§æ"]);
    const aa = getVal(pl, ["vidhansabha","assembly","‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ"]);
    const mm = getVal(pl, ["mandal","‡§Æ‡§Ç‡§°‡§≤"]);
    const pp = getVal(pl, ["program_name","program","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§®‡§æ‡§Æ"]);

    if(d && dd !== d) return false;
    if(a && aa !== a) return false;
    if(m && mm !== m) return false;
    if(pr && pp !== pr) return false;

    if(from || to){
      const t = new Date(it.created_at);
      if(from && t < from) return false;
      if(to && t > to) return false;
    }
    return true;
 });

 state.viewItems = out;
 renderTable();
 updateStats();
```

}
function renderTable() {
// ‚îÄ‚îÄ Sort ‚îÄ‚îÄ
const sortVal = ($(‚ÄòdataSort‚Äô) || {}).value || ‚Äúcreated_at_desc‚Äù;
let items = [‚Ä¶state.viewItems];
if (sortVal === ‚Äúcreated_at_desc‚Äù) items.sort((a,b) => b.created_at - a.created_at);
else if (sortVal === ‚Äúcreated_at_asc‚Äù) items.sort((a,b) => a.created_at - b.created_at);
else if (sortVal === ‚Äúname_asc‚Äù) items.sort((a,b) => (a.payload.name||‚Äù‚Äù).localeCompare(b.payload.name||‚Äù‚Äù));
else if (sortVal === ‚Äúmobile_asc‚Äù) items.sort((a,b) => (a.payload.mobile||‚Äù‚Äù).localeCompare(b.payload.mobile||‚Äù‚Äù));

```
  $('loadedCount').textContent = items.length;

  // Form badge colors
  const formColors = {
    visitor_form: "bg-blue-900/50 text-blue-300 border-blue-800",
    party_attendance: "bg-green-900/50 text-green-300 border-green-800",
    president_tour_form: "bg-purple-900/50 text-purple-300 border-purple-800",
    mandal_reporting: "bg-amber-900/50 text-amber-300 border-amber-800",
    coordinator_form: "bg-pink-900/50 text-pink-300 border-pink-800",
    program_info: "bg-cyan-900/50 text-cyan-300 border-cyan-800",
  };
  const formShort = {
    visitor_form: "Visitor", party_attendance: "Attendance",
    president_tour_form: "Tour", mandal_reporting: "Report",
    coordinator_form: "Coord", program_info: "Program",
  };

  // ‚îÄ‚îÄ Desktop Table ‚îÄ‚îÄ
  const tbody = $('dataTbody');
  tbody.innerHTML = '';
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-10 text-center text-slate-500 italic">‡§ï‡•ã‡§à entries ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</td></tr>';
  }
  items.slice(0, 100).forEach(item => {
    const p = item.payload || {};
    const d = new Date(item.created_at);
    const dateStr = isNaN(d) ? "-" : d.toLocaleDateString("hi-IN", {day:"2-digit", month:"short", year:"2-digit"});
    const timeStr = isNaN(d) ? "" : d.toLocaleTimeString("en-IN", {hour:"2-digit", minute:"2-digit"});
    const fc = formColors[item.form_type] || "bg-slate-800 text-slate-300 border-slate-700";
    const fs = formShort[item.form_type] || (item.form_type||"").slice(0,8);
    const name = p.name || p["‡§®‡§æ‡§Æ"] || "-";
    const mobile = p.mobile || p["mobile"] || "-";
    const district = p.district || p["‡§ú‡§ø‡§≤‡§æ"] || p["district"] || "-";
    const program = p.program_name || p["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ"] || "";
    const assembly = p.assembly || p["‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ"] || "";
    const photoUrl = item.photo_url || "";

    const row = document.createElement('tr');
    row.className = "hover:bg-slate-800/40 transition-colors";
    row.innerHTML = `
      <td class="px-3 py-2.5">
        <div class="text-xs text-slate-300 font-medium">${dateStr}</div>
        <div class="text-[10px] text-slate-500">${timeStr}</div>
      </td>
      <td class="px-3 py-2.5">
        <span class="px-1.5 py-0.5 rounded text-[10px] border ${fc} font-medium whitespace-nowrap">${fs}</span>
      </td>
      <td class="px-3 py-2.5 max-w-[160px]">
        <div class="text-sm text-white font-medium truncate">${name}</div>
        ${program ? `<div class="text-[10px] text-slate-500 truncate">${program}</div>` : ''}
      </td>
      <td class="px-3 py-2.5">
        <span class="text-slate-300 font-mono text-xs whitespace-nowrap">${mobile}</span>
      </td>
      <td class="px-3 py-2.5 max-w-[120px]">
        <div class="text-slate-400 text-xs truncate">${district}</div>
        ${assembly ? `<div class="text-[10px] text-slate-600 truncate">${assembly}</div>` : ''}
      </td>
      <td class="px-2 py-2">
        ${photoUrl
          ? `<img src="${photoUrl}" class="w-9 h-9 rounded object-cover cursor-pointer hover:scale-110 transition ring-1 ring-slate-700" onclick='window.open("${photoUrl}","_blank")' />`
          : (item.s3_key ? '<i class="fa-solid fa-image text-slate-600 text-xs"></i>' : '')}
      </td>
      <td class="px-3 py-2.5">
        <button class="text-orange-400 hover:text-orange-300 text-xs font-bold px-2 py-1 rounded hover:bg-orange-500/10 transition whitespace-nowrap"
                onclick='openModal(${JSON.stringify(item).replace(/'/g, "&#39;")})'>View ‚Üí</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // ‚îÄ‚îÄ Mobile Cards (improved) ‚îÄ‚îÄ
  const mobileDiv = $('dataMobileCards');
  if (mobileDiv) {
    mobileDiv.innerHTML = '';
    if (!items.length) {
      mobileDiv.innerHTML = '<div class="text-slate-500 text-sm text-center py-8">‡§ï‡•ã‡§à entries ‡§®‡§π‡•Ä‡§Ç</div>';
    }
    items.slice(0, 100).forEach(item => {
      const p = item.payload || {};
      const d = new Date(item.created_at);
      const dateStr = isNaN(d) ? "-" : d.toLocaleDateString("hi-IN", {day:"2-digit", month:"short"});
      const timeStr = isNaN(d) ? "" : d.toLocaleTimeString("en-IN", {hour:"2-digit", minute:"2-digit"});
      const fc = formColors[item.form_type] || "bg-slate-800 text-slate-300 border-slate-700";
      const fs = formShort[item.form_type] || (item.form_type||"");
      const name = p.name || p["‡§®‡§æ‡§Æ"] || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§";
      const mobile = p.mobile || "-";
      const district = p.district || p["‡§ú‡§ø‡§≤‡§æ"] || "";
      const program = p.program_name || p["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ"] || "";
      const photoUrl = item.photo_url || "";

      const card = document.createElement('div');
      card.className = "bg-slate-900/60 rounded-xl border border-slate-800 p-3 flex gap-3 hover:border-slate-700 active:border-orange-500/50 transition cursor-pointer";
      card.innerHTML = `
        ${photoUrl
          ? `<img src="${photoUrl}" class="w-14 h-14 rounded-lg object-cover shrink-0 ring-1 ring-slate-700" />`
          : `<div class="w-14 h-14 rounded-lg bg-slate-800 border border-slate-700 shrink-0 flex items-center justify-center"><i class="fa-solid fa-user text-slate-600"></i></div>`}
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-1 mb-0.5">
            <span class="text-sm font-bold text-white truncate">${name}</span>
            <span class="px-1.5 py-0.5 rounded text-[9px] border ${fc} shrink-0">${fs}</span>
          </div>
          <div class="text-xs text-orange-300/80 font-mono">${mobile}</div>
          ${district ? `<div class="text-[10px] text-slate-500 truncate">${district}</div>` : ''}
          ${program ? `<div class="text-[10px] text-slate-500 truncate">${program}</div>` : ''}
          <div class="text-[10px] text-slate-600 mt-1">${dateStr} ${timeStr}</div>
        </div>
      `;
      card.addEventListener('click', () => openModal(item));
      mobileDiv.appendChild(card);
    });
  }
```

}

function updateStats() {
$(‚ÄòkpiTotal‚Äô).textContent = state.allItems.length;
$(‚ÄòkpiUnique‚Äô).textContent = new Set(state.allItems.map(i => i.payload.mobile).filter(Boolean)).size;
const photosCount = state.allItems.filter(i => i.s3_key).length;
if ($(‚ÄòkpiPhotos‚Äô)) $(‚ÄòkpiPhotos‚Äô).textContent = photosCount;
buildCharts();
}

window.openModal = (item) => {
$(‚Äòmodal‚Äô).classList.remove(‚Äòhidden‚Äô);
$(‚Äòmodal‚Äô).classList.add(‚Äòflex‚Äô);
$(‚ÄòmodalJson‚Äô).textContent = JSON.stringify(item, null, 2);
};
$(‚ÄòbtnCloseModal‚Äô).onclick = () => { $(‚Äòmodal‚Äô).classList.add(‚Äòhidden‚Äô); $(‚Äòmodal‚Äô).classList.remove(‚Äòflex‚Äô); };
$(‚ÄòmodalBackdrop‚Äô).onclick = $(‚ÄòbtnCloseModal‚Äô).onclick;

// Auth Button Handlers
$(‚ÄòbtnAuth‚Äô).onclick = openAuthModal;
$(‚ÄòbtnCancelAuth‚Äô).onclick = () => { $(‚ÄòauthModal‚Äô).classList.remove(‚Äòflex‚Äô); $(‚ÄòauthModal‚Äô).classList.add(‚Äòhidden‚Äô); };
$(‚ÄòbtnSaveAuth‚Äô).onclick = () => {
const t = $(‚ÄòauthTokenInput‚Äô).value.trim();
if(t) {
localStorage.setItem(‚Äúid_token‚Äù, t);
showToast(‚ÄúToken updated! Reloading‚Ä¶‚Äù, ‚Äúsuccess‚Äù);
setTimeout(() => location.reload(), 800);
}
};

// ‚Äî Charts ‚Äî
function buildCharts() {
const items = state.viewItems.length ? state.viewItems : state.allItems;

```
 const byForm = {}; items.forEach(x=>{ const k=x.form_type||"unknown"; byForm[k]=(byForm[k]||0)+1; });
 const formLabels = Object.keys(byForm); const formVals = formLabels.map(k=>byForm[k]);

 const dayMap = {}; items.forEach(x=>{ const k=dateKeyFromMs(x.created_at); if(!k) return; dayMap[k]=(dayMap[k]||0)+1; });
 const days = Object.keys(dayMap).sort(); const last14 = days.slice(-14); const dayVals = last14.map(k=>dayMap[k]);

 const dist = {}; items.forEach(x=>{ const k=(x.district||"").trim()||"Unknown"; dist[k]=(dist[k]||0)+1; });
 const distPairs = Object.entries(dist).sort((a,b)=>b[1]-a[1]).slice(0,10);
 const distLabels = distPairs.map(p=>p[0]); const distVals = distPairs.map(p=>p[1]);

 if(state.charts.byDay) state.charts.byDay.destroy();
 if(state.charts.byForm) state.charts.byForm.destroy();
 if(state.charts.district) state.charts.district.destroy();

 const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: { display: false }, y: { display: false } } };

 state.charts.byDay = new Chart($('chartByDay'), { type: 'line', data: { labels: last14, datasets: [{ data: dayVals, borderColor: '#f97316', tension: 0.4 }] }, options: common });
 state.charts.byForm = new Chart($('chartByForm'), { type: 'bar', data: { labels: formLabels, datasets: [{ data: formVals, backgroundColor: '#3b82f6' }] }, options: common });
 state.charts.district = new Chart($('chartDistrict'), { type: 'bar', data: { labels: distLabels, datasets: [{ data: distVals, backgroundColor: '#a855f7' }] }, options: common });
```

}

// ‚Äî Event Listeners ‚Äî
$(‚ÄòbtnSave‚Äô).onclick = saveConfig;

// Preview controls
if($(‚ÄòbtnLoadFormPreview‚Äô)) $(‚ÄòbtnLoadFormPreview‚Äô).onclick = () => { state.cacheBust = Date.now(); renderBrandPreview(); renderFormPreviewIframe(); };
if($(‚ÄòbtnOpenFormPreview‚Äô)) $(‚ÄòbtnOpenFormPreview‚Äô).onclick = () => { state.cacheBust = Date.now(); openCurrentPreviewInNewTab(); };
if($(‚ÄòbtnRefreshSignedUrls‚Äô)) $(‚ÄòbtnRefreshSignedUrls‚Äô).onclick = () => { state.cacheBust = Date.now(); loadConfig(); };
$(‚ÄòbtnReload‚Äô).onclick = loadConfig;
$(‚ÄòbtnApplyCid‚Äô).onclick = () => { state.cid = $(‚ÄòcidInput‚Äô).value; loadConfig(); };

// Tab Switching
document.querySelectorAll(‚Äô.nav-btn‚Äô).forEach(btn => {
btn.onclick = () => {
document.querySelectorAll(‚Äô.nav-btn‚Äô).forEach(b => b.classList.remove(‚Äòactive‚Äô));
btn.classList.add(‚Äòactive‚Äô);
document.querySelectorAll(‚Äô.tab-content‚Äô).forEach(t => t.classList.add(‚Äòhidden‚Äô));
$(`tab-${btn.dataset.tab}`).classList.remove(‚Äòhidden‚Äô);
};
});

// Target Change
$(‚ÄòtargetFormSel‚Äô).onchange = () => {
state.target = $(‚ÄòtargetFormSel‚Äô).value;
renderBrandInputsFromConfig();
renderAll();
renderFormPreviewIframe();
};
// Client-side filters (no backend change)
[‚ÄòfilterDistrict‚Äô,‚ÄòfilterAssembly‚Äô,‚ÄòfilterMandal‚Äô,‚ÄòfilterProgram‚Äô].forEach(id=>{
const el = $(id);
if(el) el.onchange = applyClientFilters;
});
{ const el = $(‚ÄòfilterFormType‚Äô); if(el) el.onchange = applyClientFilters; }

// Asset Inputs

// ‚Äî Image Fit / Crop (Client-side, does NOT change backend logic) ‚Äî
let __cropper = null;
let __cropCtx = null; // { kind, uiKey, fileName, mime }
function openCropperModal(kind, file, uiKey){
uiKey = uiKey || kind;
if(!file) return;
const modal = $(‚ÄòcropModal‚Äô);
const img = $(‚ÄòcropImage‚Äô);
const hint = $(‚ÄòcropHint‚Äô);

```
 // Decide preset
 const preset = {
   logo: { aspect: 1, outW: 512, outH: 512, mime: "image/png", quality: 0.92, hint: "Logo: square crop (drag + zoom)" },
   header: { aspect: 16/5, outW: 1600, outH: 500, mime: "image/jpeg", quality: 0.9, hint: "Header: wide crop (drag + zoom)" },
   background: { aspect: 16/9, outW: 1920, outH: 1080, mime: "image/jpeg", quality: 0.88, hint: "Background: 16:9 crop (drag + zoom)" },
 }[kind] || { aspect: NaN, outW: 1400, outH: 800, mime: "image/jpeg", quality: 0.9, hint: "Drag + zoom" };

 hint.textContent = preset.hint;

 // Build image URL
 const url = URL.createObjectURL(file);
 img.src = url;
 __cropCtx = { kind, uiKey, fileName: file.name || (kind + ".jpg"), preset };

 modal.classList.remove("hidden");

 // Initialize cropper after image load
 img.onload = () => {
    try{ if(__cropper){ __cropper.destroy(); __cropper = null; } }catch(_){}
    const aspectSel = $('cropAspect');
    aspectSel.value = "preset";
    __cropper = new Cropper(img, {
       viewMode: 1,
       dragMode: "move",
       autoCropArea: 1,
       movable: true,
       zoomable: true,
       scalable: false,
       rotatable: false,
       responsive: true,
       background: false,
       aspectRatio: preset.aspect,
       checkOrientation: true,
    });
 };

 // Close handlers
 $('btnCropClose').onclick = closeCropperModal;
 $('btnCropCancel').onclick = closeCropperModal;

 // Tools
 $('btnZoomIn').onclick = () => __cropper && __cropper.zoom(0.1);
 $('btnZoomOut').onclick = () => __cropper && __cropper.zoom(-0.1);
 $('btnMoveLeft').onclick = () => __cropper && __cropper.move(-10, 0);
 $('btnMoveRight').onclick = () => __cropper && __cropper.move(10, 0);
 $('btnMoveUp').onclick = () => __cropper && __cropper.move(0, -10);
 $('btnMoveDown').onclick = () => __cropper && __cropper.move(0, 10);

 // Aspect toggle
 $('cropAspect').onchange = (e) => {
    if(!__cropper) return;
    const v = e.target.value;
    if(v === "free") __cropper.setAspectRatio(NaN);
    else __cropper.setAspectRatio(preset.aspect);
 };

 $('btnCropApply').onclick = async () => {
    if(!__cropper || !__cropCtx) return;
    const { preset } = __cropCtx;
    const canvas = __cropper.getCroppedCanvas({ width: preset.outW, height: preset.outH, imageSmoothingEnabled: true, imageSmoothingQuality: "high" });
    if(!canvas){ showToast("Crop failed", "error"); return; }

    const blob = await new Promise(res => canvas.toBlob(res, preset.mime, preset.quality));
    if(!blob){ showToast("Crop failed", "error"); return; }

    // Create a new File so existing upload logic stays same
    const safeName = (__cropCtx.fileName || (kind + ".jpg")).replace(/\s+/g,'_');
    const newFile = new File([blob], safeName, { type: preset.mime });

    // push into pending assets (existing logic)
    setPending(kind, newFile, uiKey);

    closeCropperModal();
 };
```

}

function closeCropperModal(){
const modal = $(‚ÄòcropModal‚Äô);
const img = $(‚ÄòcropImage‚Äô);
try{ if(__cropper){ __cropper.destroy(); __cropper = null; } }catch(*){}
try{ if(img && img.src && img.src.startsWith(‚Äúblob:‚Äù)) URL.revokeObjectURL(img.src); }catch(*){}
if(modal) modal.classList.add(‚Äúhidden‚Äù);
__cropCtx = null;
}

// UI keys: logo, header, bg
// Backend keys: logo, header, background (IMPORTANT!)
[
{ ui: ‚Äúlogo‚Äù, kind: ‚Äúlogo‚Äù },
{ ui: ‚Äúheader‚Äù, kind: ‚Äúheader‚Äù },
{ ui: ‚Äúbg‚Äù, kind: ‚Äúbackground‚Äù },
].forEach(({ui, kind}) => {
const inp = $(`file_${ui}`);
if (inp){
inp.onchange = (e) => {
const f = e?.target?.files?.[0];
if (f) { openCropperModal(kind, f, ui); e.target.value=‚Äô‚Äô; }
};
}

const clearBtn = document.querySelector(`[data-clear="${ui}"]`);
if(clearBtn) clearBtn.onclick = (e) => {
e.stopPropagation();
if (inp) inp.value = ‚Äú‚Äù;
setPending(kind, null, ui);
};
});

// Input Live Sync
[‚Äòinput‚Äô,‚Äòchange‚Äô].forEach(ev => {
$(‚Äòb_title‚Äô).addEventListener(ev, renderBrandPreview);
$(‚Äòb_subtitle‚Äô).addEventListener(ev, renderBrandPreview);
$(‚Äòb_tagline‚Äô).addEventListener(ev, renderBrandPreview);
$(‚Äòb_c1‚Äô).addEventListener(ev, renderBrandPreview);
$(‚Äòb_c2‚Äô).addEventListener(ev, renderBrandPreview);
});

$(‚ÄòbtnAddProg‚Äô).onclick = () => {
const v = $(‚ÄòprogInput‚Äô).value.trim();
if(!v) return;
const ft = state.target === ‚Äú**defaults**‚Äù ? ‚Äú**defaults**‚Äù : state.target;
const scope = $(‚ÄòprogScopeSel‚Äô).value;
if(scope === ‚Äòdefaults‚Äô) {
state.config.defaults.programs = [v, ‚Ä¶(state.config.defaults.programs||[])];
} else {
ensureFormObj(ft);
const base = (state.config.forms[ft].program_options || state.config.forms[ft].programs || []);
const arr = [v, ‚Ä¶base];
state.config.forms[ft].program_options = arr;
state.config.forms[ft].programs = arr;
}
$(‚ÄòprogInput‚Äô).value = ‚Äú‚Äù;
renderPrograms();
showToast(‚ÄúProgram Added‚Äù, ‚Äúsuccess‚Äù);
};

$(‚ÄòbtnLoadData‚Äô).onclick = () => loadData(‚Äúfresh‚Äù);
if ($(‚ÄòbtnApplyFilter‚Äô)) $(‚ÄòbtnApplyFilter‚Äô).onclick = async () => { await loadData(‚Äúfresh‚Äù); populateFilterOptions(); applyClientFilters(); };
if ($(‚ÄòdataSort‚Äô)) $(‚ÄòdataSort‚Äô).onchange = () => { applyClientFilters(); };
$(‚ÄòbtnNextPage‚Äô).onclick = () => loadData(‚Äúnext‚Äù);
$(‚ÄòbtnPrevPage‚Äô).onclick = () => loadData(‚Äúprev‚Äù);
$(‚ÄòbtnExportCsv‚Äô).onclick = () => {
const rows = (state.viewItems || []).map(e => (e.payload || e));
if(!rows.length){ showToast(‚ÄúNo rows to export‚Äù, ‚Äúinfo‚Äù); return; }
const colsSet = new Set();
rows.forEach(r => Object.keys(r||{}).forEach(k=>colsSet.add(k)));
const cols = Array.from(colsSet);

```
 function esc(v){
   const x = (v===undefined||v===null) ? "" : String(v).replace(/\r?\n/g, " ");
   return '"' + x.replace(/"/g,'""') + '"';
 }

 const lines = [];
 lines.push(cols.map(esc).join(","));
 rows.forEach(r => {
    lines.push(cols.map(k => esc(r[k])).join(","));
 });

 const csvContent = "data:text/csv;charset=utf-8," + lines.join("\n");
 const encodedUri = encodeURI(csvContent);
 const link = document.createElement("a");
 link.setAttribute("href", encodedUri);
 link.setAttribute("download", `data_${state.cid || "export"}_${Date.now()}.csv`);
 document.body.appendChild(link);
 link.click();
 document.body.removeChild(link);
```

};

// Init
loadConfig();
renderFormPreviewIframe();

})();
</script>

<!-- Cropper Modal -->

<div id="cropModal" class="fixed inset-0 z-[9999] hidden">
  <div class="absolute inset-0 bg-black/70"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-4xl glass-panel rounded-2xl border border-slate-700 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-800 flex items-center justify-between">
        <div>
          <div class="text-sm font-extrabold text-white">Image Fit / Crop</div>
          <div id="cropHint" class="text-xs text-slate-400 mt-0.5">Drag to move ‚Ä¢ Scroll / pinch to zoom</div>
        </div>
        <button id="btnCropClose" class="w-9 h-9 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
          <div class="lg:col-span-4">
            <div class="rounded-xl overflow-hidden border border-slate-800 bg-slate-950/30">
              <img id="cropImage" class="max-h-[62vh] w-full object-contain" />
            </div>
          </div>
          <div class="lg:col-span-1 space-y-3">
            <div class="text-xs font-bold text-slate-300 uppercase tracking-wider">Tools</div>
            <div class="grid grid-cols-2 gap-2">
              <button id="btnZoomIn" class="py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold">Zoom +</button>
              <button id="btnZoomOut" class="py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold">Zoom ‚àí</button>
              <button id="btnMoveLeft" class="py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold"><i class="fa-solid fa-arrow-left"></i></button>
              <button id="btnMoveRight" class="py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold"><i class="fa-solid fa-arrow-right"></i></button>
              <button id="btnMoveUp" class="py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold"><i class="fa-solid fa-arrow-up"></i></button>
              <button id="btnMoveDown" class="py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold"><i class="fa-solid fa-arrow-down"></i></button>
            </div>

```
        <div class="mt-2">
          <div class="text-xs font-bold text-slate-300 uppercase tracking-wider mb-2">Aspect</div>
          <select id="cropAspect" class="input-field w-full rounded-xl px-3 py-2 text-sm">
            <option value="preset">Preset</option>
            <option value="free">Free</option>
          </select>
          <div class="text-[11px] text-slate-400 mt-1">Preset: Logo = Square ‚Ä¢ Header = Wide ‚Ä¢ BG = 16:9</div>
        </div>

        <div class="pt-2 border-t border-slate-800">
          <button id="btnCropApply" class="w-full py-2.5 rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-extrabold">Apply</button>
          <button id="btnCropCancel" class="w-full mt-2 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200 font-bold">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>
```

  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Gallery ‚Äî Admin Console Module (v2)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function() {
  let photosData = [];
  let photosLastKey = null;
  let slideIdx = 0;

  function esc(s) { return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

  async function adminApi(action, payload) {
    const cid = (window._adminState && window._adminState.cid)
      ? window._adminState.cid
      : (new URLSearchParams(window.location.search)).get("cid") || "";
    const fullPayload = { collection_id: cid, ...payload };
    if (window._adminApiCall) return window._adminApiCall(action, fullPayload);
    // fallback
    const API_ID = "vxid0yoovj", REGION = "ap-south-1";
    const url = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod/political/forms`;
    const headers = { "Content-Type": "application/json" };
    const tok = localStorage.getItem("id_token") || "";
    if (tok) headers["Authorization"] = `Bearer ${tok}`;
    const resp = await fetch(url, { method:"POST", headers, body: JSON.stringify({ action, payload: fullPayload }) });
    return resp.json();
  }

  // ‚îÄ‚îÄ Load Photos ‚îÄ‚îÄ
  async function loadPhotos(reset = true) {
    if (reset) { photosData = []; photosLastKey = null; }
    const grid = document.getElementById("galleryGrid");
    if (!grid) return;

    const cid = (window._adminState && window._adminState.cid) || (new URLSearchParams(window.location.search)).get("cid") || "";
    if (!cid) {
      grid.innerHTML = '<div class="col-span-full text-amber-400 text-sm text-center py-8">‚ö†Ô∏è CID missing</div>';
      return;
    }

    if (reset) grid.innerHTML = '<div class="col-span-full text-slate-500 text-sm text-center py-8"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Loading...</div>';

    try {
      const res = await adminApi("admin_list_photos", { limit: 100, last_key: photosLastKey || undefined });
      const newPhotos = (res.photos || []).filter(p => p.url);
      photosData = reset ? newPhotos : [...photosData, ...newPhotos];
      photosLastKey = res.last_key || null;

      renderPhotosGrid(reset);
      const tot = document.getElementById("photosTotal");
      if (tot) tot.textContent = `${photosData.length}${photosLastKey ? "+" : ""} photos`;
      const btn = document.getElementById("loadMorePhotosBtn");
      if (btn) btn.classList.toggle("hidden", !photosLastKey);
    } catch(e) {
      if (grid) grid.innerHTML = `<div class="col-span-full text-red-400 text-sm text-center py-8">Error: ${esc(e.message)}</div>`;
    }
  }

  function renderPhotosGrid(reset = true) {
    const grid = document.getElementById("galleryGrid");
    if (!grid) return;
    if (reset) grid.innerHTML = "";
    const startIdx = reset ? 0 : grid.children.length;

    photosData.slice(startIdx).forEach((photo, relIdx) => {
      const absIdx = startIdx + relIdx;
      const div = document.createElement("div");
      div.className = "relative aspect-square bg-slate-800 rounded overflow-hidden cursor-pointer group";

      const img = document.createElement("img");
      img.src = photo.url;
      img.loading = "lazy";
      img.className = "w-full h-full object-cover group-hover:scale-105 transition-transform duration-200";

      // Hover overlay with date
      const overlay = document.createElement("div");
      overlay.className = "absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all flex flex-col justify-end p-1 opacity-0 group-hover:opacity-100";
      const dateStr = photo.form_date || (photo.created_at_iso || "").slice(0,10) || "";
      overlay.innerHTML = `<span class="text-[9px] text-white/90 leading-tight truncate">${esc(photo.program_name || photo.form_type || "")}</span>
        <span class="text-[8px] text-white/60">${esc(dateStr)}</span>`;

      div.appendChild(img);
      div.appendChild(overlay);
      div.addEventListener("click", () => openSlide(absIdx));
      grid.appendChild(div);
    });

    if (!photosData.length && reset) {
      grid.innerHTML = '<div class="col-span-full text-slate-500 text-sm text-center py-8">‡§ï‡•ã‡§à photos ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á</div>';
    }
  }

  // ‚îÄ‚îÄ Photo Slideshow ‚îÄ‚îÄ
  function openSlide(idx) {
    slideIdx = idx;
    showSlide();
    document.getElementById("photoSlideOverlay").classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeSlide() {
    document.getElementById("photoSlideOverlay").classList.add("hidden");
    document.body.style.overflow = "";
  }

  function showSlide() {
    const photo = photosData[slideIdx];
    if (!photo) return;

    // Image
    document.getElementById("photoSlideImg").src = photo.url;
    document.getElementById("photoSlideCounter").textContent = `${slideIdx + 1} / ${photosData.length}`;
    document.getElementById("photoSlideTitle").textContent = photo.program_name || photo.form_type || "Photo";

    // Event Info (right panel)
    const info = document.getElementById("photoSlideEventInfo");
    const rows = [
      ["üìÖ ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï", photo.form_date || photo.created_at_iso?.slice(0,10)],
      ["üó∫Ô∏è ‡§ú‡§ø‡§≤‡§æ", photo.district],
      ["üìã Form", photo.form_type],
      ["üè∑Ô∏è Program", photo.program_name],
    ].filter(r => r[1]);

    info.innerHTML = rows.map(([k,v]) =>
      `<div class="flex gap-2"><span class="text-slate-500 text-xs shrink-0">${esc(k)}</span><span class="text-xs text-slate-200 break-words">${esc(v)}</span></div>`
    ).join("") || '<div class="text-slate-500 text-xs">‡§ï‡•ã‡§à details ‡§®‡§π‡•Ä‡§Ç</div>';

    // ‡§á‡§∏ event ‡§ï‡•Ä ‡§î‡§∞ photos (same entry_id ‡§Ø‡§æ same form_date+district)
    const eventPhotos = photosData.filter((p, i) => i !== slideIdx && (
      (photo.entry_id && p.entry_id === photo.entry_id) ||
      (photo.form_date && p.form_date === photo.form_date && p.district === photo.district && p.form_type === photo.form_type)
    )).slice(0, 12);

    const epGrid = document.getElementById("photoSlideEventPhotos");
    if (eventPhotos.length) {
      epGrid.innerHTML = eventPhotos.map((p, i) =>
        `<img src="${esc(p.url)}" class="aspect-square object-cover rounded cursor-pointer hover:opacity-80 w-full"
              onclick="window._galleryGoTo(${photosData.indexOf(p)})" />`
      ).join("");
    } else {
      epGrid.innerHTML = '<div class="col-span-4 text-slate-600 text-[10px] text-center py-2">‡§Ø‡§π‡•Ä ‡§è‡§ï photo ‡§π‡•à ‡§á‡§∏ event ‡§∏‡•á</div>';
    }
  }

  window._galleryGoTo = function(idx) { slideIdx = idx; showSlide(); };

  // Navigation
  document.getElementById("photoSlidePrev")?.addEventListener("click", () => {
    slideIdx = (slideIdx - 1 + photosData.length) % photosData.length;
    showSlide();
  });
  document.getElementById("photoSlideNext")?.addEventListener("click", () => {
    slideIdx = (slideIdx + 1) % photosData.length;
    showSlide();
  });
  document.getElementById("photoSlideClose")?.addEventListener("click", closeSlide);
  document.addEventListener("keydown", e => {
    if (document.getElementById("photoSlideOverlay")?.classList.contains("hidden")) return;
    if (e.key === "ArrowLeft") { slideIdx = (slideIdx - 1 + photosData.length) % photosData.length; showSlide(); }
    if (e.key === "ArrowRight") { slideIdx = (slideIdx + 1) % photosData.length; showSlide(); }
    if (e.key === "Escape") closeSlide();
  });

  // Refresh + Load more
  document.getElementById("galleryRefreshBtn")?.addEventListener("click", () => loadPhotos(true));
  document.getElementById("loadMorePhotosBtn")?.addEventListener("click", () => loadPhotos(false));

  // Gallery tab click ‡§™‡§∞ auto-load
  document.addEventListener("click", e => {
    const btn = e.target.closest("[data-tab]");
    if (btn && btn.dataset.tab === "gallery" && !photosData.length) {
      setTimeout(() => loadPhotos(true), 200);
    }
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ATTENDANCE DASHBOARD MODULE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  let attItems = [];
  let attFiltered = [];

  const $a = id => document.getElementById(id);

  // ‚îÄ‚îÄ Load attendance entries ‚îÄ‚îÄ
  async function loadAttendance(){
    const t = showToast("‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...", "info");
    try{
      const payload = {
        collection_id: state.cid,
        form_type: "party_attendance",
        filters: {
          q: ($a("att-search")?.value||"").trim(),
          date_from: $a("att-date-from")?.value||"",
          date_to: $a("att-date-to")?.value||""
        },
        limit: 500
      };
      const res = await apiCallCandidates(
        ["admin_list_entries","admin_query_entries","list_entries_admin","admin_list_data"],
        payload
      );
      attItems = (res.items || res.data || res.rows || []).map(normalizeAttItem);
      filterAndRender();
      populateEventSelector();
      showToast(`‚úÖ ${attItems.length} ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§≤‡•ã‡§°`, "success");
    }catch(e){
      showToast("‚ùå Load failed: "+e.message, "error");
    }
  }

  function normalizeAttItem(raw){
    const pl = raw.payload || raw.data || raw || {};
    return {
      entry_id: raw.entry_id || raw.id || "",
      name:     pl.name || pl.visitor_name || raw.name || "",
      mobile:   pl.mobile || pl.phone || raw.mobile || "",
      desig:    pl.designation || pl.‡§™‡§¶ || "",
      district: pl.district || pl.‡§ú‡§ø‡§≤‡§æ || "",
      vidhan:   pl.vidhansabha || pl.‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ || "",
      mandal:   pl.mandal || pl.‡§Æ‡§Ç‡§°‡§≤ || "",
      program:  pl.program_name || pl.program || pl.‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ || "",
      photo_url: raw.photo_url || raw.selfie_url || (raw.photo_urls&&raw.photo_urls[0]) || "",
      created_at: raw.created_at || raw.timestamp || raw.ts || "",
      raw
    };
  }

  function populateEventSelector(){
    const sel = $a("att-event-sel"); if(!sel) return;
    const programs = [...new Set(attItems.map(i=>i.program).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">‚Äî ‡§∏‡§≠‡•Ä Events ‚Äî</option>';
    programs.forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; sel.appendChild(o); });
    renderEventSummary(programs);
  }

  function renderEventSummary(programs){
    const container = $a("att-event-summary"); if(!container) return;
    container.innerHTML = "";
    programs.forEach(prog=>{
      const items = attItems.filter(i=>i.program===prog);
      const districts = [...new Set(items.map(i=>i.district).filter(Boolean))];
      const card = document.createElement("div");
      card.className = "glass-panel rounded-2xl p-4";
      card.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="font-bold text-white text-base">üìã ${prog}</div>
            <div class="text-xs text-slate-400 mt-0.5">${districts.slice(0,3).join(", ")}${districts.length>3?" +more":""}</div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-extrabold text-emerald-400">${items.length}</div>
            <div class="text-xs text-slate-500">‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§</div>
          </div>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button onclick="attFilterByEvent('${prog.replace(/'/g,"\\\'")}')" class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold transition">
            <i class="fa-solid fa-list mr-1"></i>‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç
          </button>
          <button onclick="attExportEvent('${prog.replace(/'/g,"\\\'")}')" class="px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-slate-300 text-xs font-bold transition">
            <i class="fa-solid fa-download mr-1"></i>CSV Export
          </button>
        </div>`;
      container.appendChild(card);
    });
  }

  function filterAndRender(){
    const q = ($a("att-search")?.value||"").toLowerCase();
    const prog = $a("att-event-sel")?.value||"";
    attFiltered = attItems.filter(i=>{
      if(prog && i.program!==prog) return false;
      if(q && !`${i.name} ${i.mobile} ${i.district} ${i.mandal}`.toLowerCase().includes(q)) return false;
      return true;
    });
    renderKPI();
    renderTable();
    renderMobileCards();
    if($a("att-count")) $a("att-count").textContent = attFiltered.length;
  }

  function renderKPI(){
    const container = $a("att-event-kpi"); if(!container) return;
    const today = new Date().toISOString().slice(0,10);
    const todayCount = attFiltered.filter(i=>(i.created_at||"").startsWith(today)).length;
    const districts = new Set(attFiltered.map(i=>i.district).filter(Boolean)).size;
    const withPhoto = attFiltered.filter(i=>i.photo_url).length;
    container.innerHTML = `
      <div class="glass-panel rounded-xl px-4 py-3 border border-slate-800">
        <div class="text-[10px] text-slate-500 uppercase font-bold">‡§ï‡•Å‡§≤ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§</div>
        <div class="text-2xl font-extrabold text-emerald-400">${attFiltered.length}</div>
      </div>
      <div class="glass-panel rounded-xl px-4 py-3 border border-slate-800">
        <div class="text-[10px] text-slate-500 uppercase font-bold">‡§Ü‡§ú</div>
        <div class="text-2xl font-extrabold text-orange-400">${todayCount}</div>
      </div>
      <div class="glass-panel rounded-xl px-4 py-3 border border-slate-800">
        <div class="text-[10px] text-slate-500 uppercase font-bold">‡§ú‡§ø‡§≤‡•á</div>
        <div class="text-2xl font-extrabold text-blue-400">${districts}</div>
      </div>
      <div class="glass-panel rounded-xl px-4 py-3 border border-slate-800">
        <div class="text-[10px] text-slate-500 uppercase font-bold">üì∏ Photos</div>
        <div class="text-2xl font-extrabold text-pink-400">${withPhoto}</div>
      </div>`;
  }

  function fmtTime(ts){
    if(!ts) return "‚Äî";
    try{ const d=new Date(ts); return d.toLocaleDateString("hi-IN")+"\n"+d.toLocaleTimeString("hi-IN",{hour:"2-digit",minute:"2-digit"}); }catch(e){ return ts.slice(0,16).replace("T"," "); }
  }

  function renderTable(){
    const tb = $a("att-tbody"); if(!tb) return;
    if(!attFiltered.length){ tb.innerHTML='<tr><td colspan="8" class="px-4 py-10 text-center text-slate-500 italic">‡§ï‡•ã‡§à ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç</td></tr>'; return; }
    tb.innerHTML = attFiltered.map((it,i)=>`
      <tr class="hover:bg-slate-800/40 transition">
        <td class="px-3 py-3 text-slate-500 text-xs">${i+1}</td>
        <td class="px-3 py-2">
          ${it.photo_url
            ? `<img src="${it.photo_url}" style="width:38px;height:38px;border-radius:10px;object-fit:cover;border:2px solid rgba(52,211,153,.3);cursor:pointer;" onclick="attViewPhoto('${it.photo_url}','${it.name}')" title="‡§´‡•ã‡§ü‡•ã ‡§¶‡•á‡§ñ‡•á‡§Ç"/>`
            : `<div style="width:38px;height:38px;border-radius:10px;background:#1e293b;display:flex;align-items:center;justify-content:center;color:#475569;font-size:16px;">üë§</div>`}
        </td>
        <td class="px-3 py-3">
          <div class="font-bold text-white text-sm">${it.name||"‚Äî"}</div>
          ${it.desig?`<div class="text-[11px] text-slate-500">${it.desig}</div>`:""}
        </td>
        <td class="px-3 py-3 text-slate-300 text-sm">${it.mobile||"‚Äî"}</td>
        <td class="px-3 py-3 text-xs text-slate-400 leading-5">${[it.district,it.vidhan,it.mandal].filter(Boolean).join(" ‚Ä∫ ")||"‚Äî"}</td>
        <td class="px-3 py-3 text-xs text-emerald-400 font-semibold">${it.program||"‚Äî"}</td>
        <td class="px-3 py-3 text-[11px] text-slate-500 whitespace-pre">${fmtTime(it.created_at)}</td>
        <td class="px-3 py-3">
          <button onclick="attEditEntry('${it.entry_id}')" class="px-2 py-1.5 rounded-lg bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 text-xs font-bold transition border border-amber-600/30">
            ‚úèÔ∏è Edit
          </button>
        </td>
      </tr>`).join("");
  }

  function renderMobileCards(){
    const container = $a("att-mobile-cards"); if(!container) return;
    if(!attFiltered.length){ container.innerHTML='<div class="text-center text-slate-500 py-8 italic">‡§ï‡•ã‡§à ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç</div>'; return; }
    container.innerHTML = attFiltered.map((it,i)=>`
      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3 flex gap-3">
        ${it.photo_url
          ? `<img src="${it.photo_url}" style="width:52px;height:52px;border-radius:12px;object-fit:cover;flex-shrink:0;border:2px solid rgba(52,211,153,.3);cursor:pointer;" onclick="attViewPhoto('${it.photo_url}','${it.name}')"/>`
          : `<div style="width:52px;height:52px;border-radius:12px;background:#1e293b;display:flex;align-items:center;justify-content:center;color:#475569;font-size:24px;flex-shrink:0;">üë§</div>`}
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-bold text-white text-sm">${it.name||"‚Äî"}</div>
              <div class="text-xs text-slate-400">${it.mobile||""} ${it.desig?`¬∑ ${it.desig}`:""}</div>
            </div>
            <button onclick="attEditEntry('${it.entry_id}')" class="px-2 py-1 rounded-lg bg-amber-600/20 text-amber-400 text-xs font-bold flex-shrink-0 border border-amber-600/30">‚úèÔ∏è</button>
          </div>
          <div class="text-[11px] text-slate-500 mt-1">${[it.district,it.vidhan,it.mandal].filter(Boolean).join(" ‚Ä∫ ")||""}</div>
          <div class="text-[11px] text-emerald-400 font-semibold mt-0.5">${it.program||""}</div>
          <div class="text-[10px] text-slate-600 mt-0.5">${fmtTime(it.created_at)}</div>
        </div>
      </div>`).join("");
  }

  // ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
  function exportCSV(items, filename){
    const cols=["#","‡§®‡§æ‡§Æ","Mobile","‡§™‡§¶","‡§ú‡§ø‡§≤‡§æ","‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ","‡§Æ‡§Ç‡§°‡§≤","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ","‡§∏‡§Æ‡§Ø","Photo URL"];
    const rows=[cols.join(",")];
    items.forEach((it,i)=>{
      rows.push([i+1,it.name,it.mobile,it.desig,it.district,it.vidhan,it.mandal,it.program,it.created_at,it.photo_url].map(v=>`"${(v||"").replace(/"/g,'""')}"`).join(","));
    });
    const blob=new Blob(["\uFEFF"+rows.join("\n")],{type:"text/csv;charset=utf-8;"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  }

  // ‚îÄ‚îÄ Export Excel (via SheetJS) ‚îÄ‚îÄ
  async function exportExcel(items, filename){
    try{
      // Load SheetJS if not loaded
      if(!window.XLSX){
        await new Promise((res,rej)=>{ const s=document.createElement("script"); s.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      }
      const ws_data=[["#","‡§®‡§æ‡§Æ","Mobile","‡§™‡§¶","‡§ú‡§ø‡§≤‡§æ","‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ","‡§Æ‡§Ç‡§°‡§≤","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ","‡§∏‡§Æ‡§Ø","Photo URL"]];
      items.forEach((it,i)=>ws_data.push([i+1,it.name,it.mobile,it.desig,it.district,it.vidhan,it.mandal,it.program,it.created_at,it.photo_url]));
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet(ws_data);
      ws["!cols"]=[{wch:4},{wch:20},{wch:14},{wch:16},{wch:16},{wch:18},{wch:16},{wch:24},{wch:20},{wch:50}];
      XLSX.utils.book_append_sheet(wb,ws,"Attendance");
      XLSX.writeFile(wb,filename);
    }catch(e){ showToast("Excel export failed: "+e.message,"error"); }
  }

  // ‚îÄ‚îÄ Edit entry modal ‚îÄ‚îÄ
  let _attEditId = null;
  let _attEditItem = null;

  window.attEditEntry = function(entryId){
    _attEditId = entryId;
    _attEditItem = attFiltered.find(i=>i.entry_id===entryId);
    if(!_attEditItem) return;
    showAttEditModal(_attEditItem);
  };

  function showAttEditModal(it){
    // Remove old modal if exists
    const old = document.getElementById("att-edit-modal"); if(old) old.remove();
    const modal = document.createElement("div");
    modal.id="att-edit-modal";
    modal.style.cssText="position:fixed;inset:0;z-index:9999;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);";
    modal.innerHTML=`
      <div style="width:100%;max-width:500px;background:#0f172a;border-radius:22px 22px 0 0;border:2px solid #334155;padding:20px 18px 36px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <div>
            <div style="font-size:16px;font-weight:900;color:#fff;">‚úèÔ∏è ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç</div>
            <div style="font-size:11px;color:#64748b;margin-top:2px;">Entry ID: ${it.entry_id.slice(0,16)}...</div>
          </div>
          <button onclick="document.getElementById('att-edit-modal').remove()" style="background:none;border:none;font-size:22px;color:#64748b;cursor:pointer;">‚úï</button>
        </div>
        ${it.photo_url ? `<div style="text-align:center;margin-bottom:14px;"><img src="${it.photo_url}" style="height:80px;border-radius:14px;object-fit:cover;border:2px solid #334155;"/></div>` : ""}
        <div style="display:flex;flex-direction:column;gap:11px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">üë§ ‡§®‡§æ‡§Æ *</label>
              <input id="ae-name" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.name||""}"/>
            </div>
            <div>
              <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">üì± Mobile *</label>
              <input id="ae-mobile" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.mobile||""}"/>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">‡§™‡§¶</label>
              <input id="ae-desig" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.desig||""}"/>
            </div>
            <div>
              <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</label>
              <input id="ae-program" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.program||""}"/>
            </div>
          </div>
          <div>
            <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">üèõÔ∏è ‡§ú‡§ø‡§≤‡§æ</label>
            <input id="ae-dist" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.district||""}"/>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ</label>
              <input id="ae-vidhan" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.vidhan||""}"/>
            </div>
            <div>
              <label style="display:block;font-size:11px;font-weight:800;color:#10b981;margin-bottom:4px;text-transform:uppercase;">‡§Æ‡§Ç‡§°‡§≤</label>
              <input id="ae-mandal" style="width:100%;padding:11px 12px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#fff;font-size:15px;outline:none;" value="${it.mandal||""}"/>
            </div>
          </div>
          <div id="ae-status" style="display:none;padding:10px;border-radius:10px;font-size:13px;font-weight:700;text-align:center;"></div>
          <button onclick="attSaveEdit()" style="width:100%;padding:15px;border-radius:13px;border:none;cursor:pointer;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-size:16px;font-weight:900;">
            <i class="fa-solid fa-floppy-disk" style="margin-right:8px;"></i>‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
          </button>
        </div>
      </div>`;
    document.body.appendChild(modal);
    modal.addEventListener("click", e=>{ if(e.target===modal) modal.remove(); });
  }

  window.attSaveEdit = async function(){
    const modal=document.getElementById("att-edit-modal");
    const name=document.getElementById("ae-name")?.value?.trim();
    const mobile=document.getElementById("ae-mobile")?.value?.trim();
    if(!name||!mobile){ showAeStatus("‚ùå ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à",true); return; }
    const payload={
      name, mobile,
      designation: document.getElementById("ae-desig")?.value?.trim()||"",
      program_name: document.getElementById("ae-program")?.value?.trim()||"",
      district: document.getElementById("ae-dist")?.value?.trim()||"",
      vidhansabha: document.getElementById("ae-vidhan")?.value?.trim()||"",
      mandal: document.getElementById("ae-mandal")?.value?.trim()||""
    };
    const saveBtn=modal?.querySelector("button:last-child");
    if(saveBtn){ saveBtn.disabled=true; saveBtn.innerHTML='<i class="fa-solid fa-spinner" style="animation:spin 1s linear infinite;"></i> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...'; }
    try{
      await apiCallCandidates(
        ["admin_update_entry","update_entry","admin_edit_entry","edit_entry"],
        {collection_id: state.cid, entry_id: _attEditId, form_type:"party_attendance", payload}
      );
      showAeStatus("‚úÖ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§ß‡§∞ ‡§ó‡§à!",false);
      // Update local data
      if(_attEditItem){ Object.assign(_attEditItem, {name,mobile,desig:payload.designation,district:payload.district,vidhan:payload.vidhansabha,mandal:payload.mandal,program:payload.program_name}); }
      filterAndRender();
      setTimeout(()=>{ modal?.remove(); },1500);
    }catch(e){
      showAeStatus("‚ùå "+e.message,true);
      if(saveBtn){ saveBtn.disabled=false; saveBtn.innerHTML='<i class="fa-solid fa-floppy-disk" style="margin-right:8px;"></i>‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç'; }
    }
  };

  function showAeStatus(msg,isErr){
    const el=document.getElementById("ae-status"); if(!el) return;
    el.style.display="block";
    el.style.background=isErr?"rgba(239,68,68,.15)":"rgba(34,197,94,.15)";
    el.style.color=isErr?"#f87171":"#4ade80";
    el.textContent=msg;
  }

  // ‚îÄ‚îÄ Photo viewer ‚îÄ‚îÄ
  window.attViewPhoto = function(url, name){
    const v=document.getElementById("att-photo-viewer");
    if(v){ v.remove(); }
    const el=document.createElement("div");
    el.id="att-photo-viewer";
    el.style.cssText="position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;";
    el.innerHTML=`
      <div style="color:#94a3b8;font-size:14px;font-weight:700;">${name||"Photo"}</div>
      <img src="${url}" style="max-width:90vw;max-height:75vh;border-radius:16px;object-fit:contain;border:2px solid #334155;"/>
      <button onclick="document.getElementById('att-photo-viewer').remove()" style="padding:10px 28px;border-radius:12px;background:#ef4444;border:none;color:#fff;font-size:14px;font-weight:700;cursor:pointer;">‚úï ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>`;
    el.addEventListener("click",e=>{ if(e.target===el) el.remove(); });
    document.body.appendChild(el);
  };

  // ‚îÄ‚îÄ Event filter ‚îÄ‚îÄ
  window.attFilterByEvent = function(prog){
    if($a("att-event-sel")) $a("att-event-sel").value=prog;
    filterAndRender();
    document.getElementById("tab-attendance")?.scrollIntoView({behavior:"smooth"});
  };

  window.attExportEvent = function(prog){
    const items = attItems.filter(i=>i.program===prog);
    exportCSV(items, `attendance_${prog.replace(/\s+/g,"_")}_${new Date().toISOString().slice(0,10)}.csv`);
  };

  // ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ
  document.addEventListener("DOMContentLoaded",()=>{
    $a("btn-att-load")?.addEventListener("click", loadAttendance);
    $a("att-search")?.addEventListener("input", filterAndRender);
    $a("att-event-sel")?.addEventListener("change", filterAndRender);
    $a("btn-att-csv")?.addEventListener("click",()=>{
      exportCSV(attFiltered, `attendance_${new Date().toISOString().slice(0,10)}.csv`);
    });
    $a("btn-att-excel")?.addEventListener("click",()=>{
      exportExcel(attFiltered, `attendance_${new Date().toISOString().slice(0,10)}.xlsx`);
    });
    // Auto-load when tab clicked
    document.addEventListener("click", e=>{
      const btn=e.target.closest("[data-tab]");
      if(btn && btn.dataset.tab==="attendance" && !attItems.length && state.cid){
        setTimeout(()=>loadAttendance(),200);
      }
    });
  });
})();

</script>

</body>
</html>