<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Political Admin Console - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: { brand: { 500: '#f97316', 600: '#ea580c' } }
        }
      }
    }
  </script>
  <style>
    body {
      background:
        radial-gradient(circle at top left, rgba(249, 115, 22, 0.14), transparent 50%),
        radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.10), transparent 50%),
        #020617;
      color: #e2e8f0;
    }
    .glass {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.65) 0%, rgba(15, 23, 42, 0.75) 100%);
      border: 1px solid rgba(255, 255, 255, 0.07);
    }
    .input {
      background: rgba(2, 6, 23, 0.55);
      border: 1px solid rgba(255,255,255,0.10);
      color: #fff;
    }
    .input:focus {
      outline: none;
      border-color: rgba(249,115,22,.8);
      box-shadow: 0 0 0 2px rgba(249,115,22,.18);
    }
    .pill { border: 1px solid rgba(255,255,255,0.10); }
    ::-webkit-scrollbar { width: 7px; }
    ::-webkit-scrollbar-track { background: #020617; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen font-sans">
  <div class="sticky top-0 z-40 border-b border-white/5 glass">
    <div class="max-w-7xl mx-auto px-4">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white shadow-lg shadow-orange-500/20">
            <i class="fa-solid fa-screwdriver-wrench"></i>
          </div>
          <div>
            <div class="text-white font-extrabold tracking-tight">EventLens <span class="text-orange-400">Political</span> Admin</div>
            <div class="text-[11px] text-slate-400 font-semibold uppercase tracking-wider">Branding • Programs • Level Locks • Preview</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div id="cidPill" class="hidden sm:flex items-center gap-2 px-3 py-1 rounded-full pill bg-slate-900/40 text-xs font-mono text-slate-300">
            <i class="fa-solid fa-layer-group text-orange-400"></i>
            <span id="cidVal"></span>
          </div>
          <button id="btnReload" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200 text-xs font-bold">
            <i class="fa-solid fa-rotate-right mr-1"></i> Reload
          </button>
          <button id="btnSave" class="px-4 py-2 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white text-xs font-extrabold shadow-lg shadow-orange-500/20">
            <i class="fa-solid fa-floppy-disk mr-1"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid lg:grid-cols-12 gap-6">

      <div class="lg:col-span-3 space-y-4">
        <div class="glass rounded-2xl p-4">
          <div class="text-xs text-slate-400 font-semibold mb-3 uppercase tracking-wider">Sections</div>
          <div class="space-y-2">
            <button class="navBtn w-full text-left px-3 py-2 rounded-xl bg-slate-900/50 hover:bg-slate-800 border border-slate-700 text-slate-200 text-sm font-bold" data-tab="branding">
              <i class="fa-solid fa-palette mr-2 text-orange-400"></i> Branding & Theme
            </button>
            <button class="navBtn w-full text-left px-3 py-2 rounded-xl bg-slate-900/20 hover:bg-slate-800 border border-slate-800 text-slate-200 text-sm font-bold" data-tab="programs">
              <i class="fa-solid fa-list-check mr-2 text-orange-400"></i> Program Names
            </button>
            <button class="navBtn w-full text-left px-3 py-2 rounded-xl bg-slate-900/20 hover:bg-slate-800 border border-slate-800 text-slate-200 text-sm font-bold" data-tab="levels">
              <i class="fa-solid fa-lock mr-2 text-orange-400"></i> Level Lock
            </button>
            <button class="navBtn w-full text-left px-3 py-2 rounded-xl bg-slate-900/20 hover:bg-slate-800 border border-slate-800 text-slate-200 text-sm font-bold" data-tab="preview">
              <i class="fa-solid fa-eye mr-2 text-orange-400"></i> Live Preview
            </button>
          </div>

          <div class="mt-4 pt-4 border-t border-white/5">
            <div id="status" class="hidden text-xs"></div>
            <div class="mt-3 text-[11px] text-slate-500 leading-relaxed">
              <div class="font-bold text-slate-300 mb-1"><i class="fa-solid fa-circle-info text-sky-400 mr-1"></i> Note</div>
              <div>यह console <b>CID based</b> config सेव करता है। अगर backend में admin APIs नहीं हैं तो यह localStorage में save करके चलेगा।</div>
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-9 space-y-6">

        <section id="tab-branding" class="tab card rounded-2xl p-5 lg:p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-extrabold text-white">Branding & Theme</div>
              <div class="text-xs text-slate-400 mt-1">Logo / Header Image / Background Image को <b>URL नहीं</b>, सीधे upload करके set करें।</div>
            </div>
            <div class="text-xs text-slate-400">Preview नीचे दिखेगा</div>
          </div>

          <div class="mt-6 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-bold text-slate-300">Title (Header)</label>
              <input id="b_title" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-1" placeholder="e.g. भाजपा कार्यालय मंदसौर" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-300">Subtitle</label>
              <input id="b_subtitle" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-1" placeholder="e.g. स्वागत" />
            </div>
            <div class="md:col-span-2">
              <label class="text-xs font-bold text-slate-300">Tagline</label>
              <input id="b_tagline" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-1" placeholder="e.g. सेवा • संगठन • समर्पण" />
            </div>

            <div>
              <label class="text-xs font-bold text-slate-300">Theme Color 1</label>
              <input id="b_c1" type="color" class="w-full mt-2 h-10 rounded-xl bg-slate-900/40 border border-slate-700" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-300">Theme Color 2</label>
              <input id="b_c2" type="color" class="w-full mt-2 h-10 rounded-xl bg-slate-900/40 border border-slate-700" />
            </div>
          </div>

          <div class="mt-6 grid lg:grid-cols-3 gap-4">
            <div class="bg-slate-950/30 rounded-2xl border border-slate-800 p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-extrabold text-white">Logo</div>
                <button class="text-xs px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700" data-clear="logo">
                  <i class="fa-solid fa-trash-can mr-1"></i> Remove
                </button>
              </div>
              <div class="mt-3 flex items-center gap-3">
                <div class="w-14 h-14 rounded-xl bg-slate-900/60 border border-slate-700 overflow-hidden flex items-center justify-center">
                  <img id="prev_logo" class="w-full h-full object-cover hidden" />
                  <i id="icon_logo" class="fa-solid fa-image text-slate-500"></i>
                </div>
                <div class="flex-1">
                  <input id="file_logo" type="file" accept="image/*" class="hidden" />
                  <button id="btn_logo" class="w-full px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold">
                    <i class="fa-solid fa-upload mr-1"></i> Upload Logo
                  </button>
                  <div id="name_logo" class="text-[11px] text-slate-500 mt-2 truncate">No file selected</div>
                </div>
              </div>
            </div>

            <div class="bg-slate-950/30 rounded-2xl border border-slate-800 p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-extrabold text-white">Header Image</div>
                <button class="text-xs px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700" data-clear="header">
                  <i class="fa-solid fa-trash-can mr-1"></i> Remove
                </button>
              </div>
              <div class="mt-3">
                <div class="w-full h-24 rounded-xl bg-slate-900/60 border border-slate-700 overflow-hidden flex items-center justify-center">
                  <img id="prev_header" class="w-full h-full object-cover hidden" />
                  <i id="icon_header" class="fa-solid fa-panorama text-slate-500"></i>
                </div>
                <div class="mt-3 flex items-center gap-2">
                  <input id="file_header" type="file" accept="image/*" class="hidden" />
                  <button id="btn_header" class="flex-1 px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold">
                    <i class="fa-solid fa-upload mr-1"></i> Upload Header
                  </button>
                </div>
                <div id="name_header" class="text-[11px] text-slate-500 mt-2 truncate">No file selected</div>
              </div>
            </div>

            <div class="bg-slate-950/30 rounded-2xl border border-slate-800 p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-extrabold text-white">Background Image</div>
                <button class="text-xs px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700" data-clear="bg">
                  <i class="fa-solid fa-trash-can mr-1"></i> Remove
                </button>
              </div>
              <div class="mt-3">
                <div class="w-full h-24 rounded-xl bg-slate-900/60 border border-slate-700 overflow-hidden flex items-center justify-center">
                  <img id="prev_bg" class="w-full h-full object-cover hidden" />
                  <i id="icon_bg" class="fa-solid fa-mountain-sun text-slate-500"></i>
                </div>
                <div class="mt-3 flex items-center gap-2">
                  <input id="file_bg" type="file" accept="image/*" class="hidden" />
                  <button id="btn_bg" class="flex-1 px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold">
                    <i class="fa-solid fa-upload mr-1"></i> Upload Background
                  </button>
                </div>
                <div id="name_bg" class="text-[11px] text-slate-500 mt-2 truncate">No file selected</div>
              </div>
            </div>
          </div>

          <div class="mt-6">
            <div class="text-sm font-extrabold text-white mb-3"><i class="fa-solid fa-eye mr-2 text-orange-400"></i> Live Branding Preview</div>

            <div id="previewCard" class="rounded-2xl overflow-hidden border border-slate-800 relative">
              <div id="previewBg" class="absolute inset-0 opacity-30 bg-cover bg-center"></div>
              <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-black/30 to-black/60"></div>

              <div id="previewHeaderBar" class="absolute top-0 left-0 w-full h-1"></div>

              <div class="relative p-6">
                <div id="previewHeaderImgWrap" class="hidden w-full h-28 rounded-2xl overflow-hidden border border-white/10 mb-5">
                  <img id="previewHeaderImg" class="w-full h-full object-cover" />
                </div>

                <div class="flex items-center gap-4">
                  <div class="w-16 h-16 rounded-2xl overflow-hidden border border-white/10 bg-white/5 flex items-center justify-center">
                    <img id="previewLogo" class="w-full h-full object-cover hidden" />
                    <i id="previewLogoIcon" class="fa-solid fa-bolt text-orange-400 text-2xl"></i>
                  </div>
                  <div class="min-w-0">
                    <div id="previewTitle" class="text-2xl font-extrabold text-white leading-tight"></div>
                    <div id="previewSubtitle" class="text-sm text-slate-300 mt-1"></div>
                    <div id="previewTagline" class="text-xs text-slate-400 mt-2"></div>
                  </div>
                </div>

                <div class="mt-6 grid grid-cols-2 gap-3">
                  <div class="rounded-xl bg-white/5 border border-white/10 p-3">
                    <div class="text-[10px] uppercase text-slate-400 font-bold">Theme Color 1</div>
                    <div class="mt-2 flex items-center gap-2">
                      <div id="sw1" class="w-6 h-6 rounded-lg border border-white/20"></div>
                      <div id="txt1" class="text-xs text-slate-300 font-mono"></div>
                    </div>
                  </div>
                  <div class="rounded-xl bg-white/5 border border-white/10 p-3">
                    <div class="text-[10px] uppercase text-slate-400 font-bold">Theme Color 2</div>
                    <div class="mt-2 flex items-center gap-2">
                      <div id="sw2" class="w-6 h-6 rounded-lg border border-white/20"></div>
                      <div id="txt2" class="text-xs text-slate-300 font-mono"></div>
                    </div>
                  </div>
                </div>

                <div class="mt-5 text-[11px] text-slate-400">
                  ⚡ यह preview <b>admin console में live</b> है। Save के बाद forms में वही branding apply होगी (यदि forms backend config पढ़ रहे हों)।
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-programs" class="tab hidden card rounded-2xl p-5 lg:p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-extrabold text-white">Program Names (Dropdown)</div>
              <div class="text-xs text-slate-400 mt-1">Party Attendance / Reporting / Coordinator / Program Info में “कार्यक्रम का नाम” dropdown इसी list से भरेंगे।</div>
            </div>
          </div>

          <div class="mt-5 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <input id="progInput" class="input w-full rounded-xl px-3 py-2.5 text-sm" placeholder="नया कार्यक्रम नाम लिखें (e.g. मंडल बैठक)" />
            </div>
            <button id="btnAddProg" class="px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-sm font-extrabold">
              <i class="fa-solid fa-plus mr-1"></i> Add
            </button>
          </div>

          <div class="mt-5">
            <div class="text-xs font-bold text-slate-300 mb-2">Current Programs</div>
            <div id="progList" class="space-y-2"></div>
            <div class="text-[11px] text-slate-500 mt-3">Tip: duplicates auto रोक दिए हैं।</div>
          </div>
        </section>

        <section id="tab-levels" class="tab hidden card rounded-2xl p-5 lg:p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-extrabold text-white">Level Lock</div>
              <div class="text-xs text-slate-400 mt-1">कुछ forms में Level fixed रखना है (Admin से या link के साथ)।</div>
            </div>
          </div>

          <div class="mt-6 grid md:grid-cols-2 gap-4">
            <div class="rounded-2xl border border-slate-800 bg-slate-950/20 p-4">
              <div class="text-sm font-extrabold text-white">Karyakram Reporting</div>
              <div class="text-[11px] text-slate-500 mt-1">Form: mandal_reporting</div>
              <select id="lvl_mandal_reporting" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-3">
                <option value="">(Not fixed)</option>
                <option value="district">District (जिला)</option>
                <option value="vidhansabha">Vidhan Sabha (विधानसभा)</option>
                <option value="mandal">Mandal (मंडल)</option>
              </select>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/20 p-4">
              <div class="text-sm font-extrabold text-white">Coordinator</div>
              <div class="text-[11px] text-slate-500 mt-1">Form: coordinator</div>
              <select id="lvl_coordinator" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-3">
                <option value="">(Not fixed)</option>
                <option value="district">District (जिला)</option>
                <option value="vidhansabha">Vidhan Sabha (विधानसभा)</option>
                <option value="mandal">Mandal (मंडल)</option>
              </select>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/20 p-4">
              <div class="text-sm font-extrabold text-white">Program Info</div>
              <div class="text-[11px] text-slate-500 mt-1">Form: program_info</div>
              <select id="lvl_program_info" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-3">
                <option value="">(Not fixed)</option>
                <option value="district">District (जिला)</option>
                <option value="vidhansabha">Vidhan Sabha (विधानसभा)</option>
                <option value="mandal">Mandal (मंडल)</option>
              </select>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/20 p-4">
              <div class="text-sm font-extrabold text-white">Link Lock (Optional)</div>
              <div class="text-xs text-slate-400 mt-2 leading-relaxed">
                अगर link में <span class="font-mono">level=mandal</span> दिया हो तो form उसी level पर lock हो सकता है (forms में code चाहिए)।
              </div>
              <div class="mt-3 text-[11px] text-slate-500">
                Example: <span class="font-mono">...?cid=XXX&level=mandal</span>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-preview" class="tab hidden card rounded-2xl p-5 lg:p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-extrabold text-white">Preview Form (How it will look)</div>
              <div class="text-xs text-slate-400 mt-1">Saved config के साथ forms preview करने के लिए नीचे select करके iframe में देखें।</div>
            </div>
          </div>

          <div class="mt-6 grid md:grid-cols-12 gap-3 items-end">
            <div class="md:col-span-5">
              <label class="text-xs font-bold text-slate-300">Select Form</label>
              <select id="previewFormSel" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-1">
                <option value="political_visitor_form.html">Visitor Form</option>
                <option value="political_party_attendance_form.html">Party Attendance</option>
                <option value="political_president_tour_form.html">President Tour</option>
                <option value="political_mandal_reporting_form.html">Karyakram Reporting</option>
                <option value="political_coordinator_form.html">Coordinator</option>
                <option value="political_program_info_form.html">Program Info</option>
              </select>
            </div>
            <div class="md:col-span-4">
              <label class="text-xs font-bold text-slate-300">Mode</label>
              <select id="previewModeSel" class="input w-full rounded-xl px-3 py-2.5 text-sm mt-1">
                <option value="cid">CID Mode (Dashboard)</option>
                <option value="token">Token Mode (Public) — if token exists</option>
              </select>
            </div>
            <div class="md:col-span-3 flex gap-2">
              <button id="btnOpenNew" class="flex-1 px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-sm font-extrabold">
                <i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> Open
              </button>
              <button id="btnLoadIframe" class="flex-1 px-4 py-2.5 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white text-sm font-extrabold">
                <i class="fa-solid fa-eye mr-1"></i> Load
              </button>
            </div>
          </div>

          <div class="mt-5 rounded-2xl overflow-hidden border border-slate-800 bg-slate-950/20">
            <div class="px-4 py-2.5 border-b border-slate-800 flex items-center justify-between">
              <div class="text-xs text-slate-400 font-bold"><i class="fa-solid fa-display mr-2 text-orange-400"></i> Embedded Preview</div>
              <div class="text-[11px] text-slate-500 truncate" id="iframeUrlTxt"></div>
            </div>
            <iframe id="previewIframe" class="w-full h-[740px] bg-white"></iframe>
          </div>

          <div class="mt-4 text-[11px] text-slate-500">
            अगर form preview में branding नहीं बदल रही, इसका मतलब form backend से config fetch नहीं कर रहा। (next step में forms में 10 लाइन का config loader जोड़ेंगे)
          </div>
        </section>

      </div>
    </div>
  </div>

<script>
(() => {
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  const FORMS_URL = `${BASE_URL}/political/forms`;

  const qs = (n) => { try { return (new URL(window.location.href)).searchParams.get(n) || ""; } catch(e){ return ""; } };
  const cid = (qs("cid") || qs("collection_id") || qs("id") || "").trim();
  const token = (qs("token") || "").trim();
  const $ = (id) => document.getElementById(id);

  const els = {
    status: $("status"),
    cidPill: $("cidPill"),
    cidVal: $("cidVal"),
    btnSave: $("btnSave"),
    btnReload: $("btnReload"),

    b_title: $("b_title"),
    b_subtitle: $("b_subtitle"),
    b_tagline: $("b_tagline"),
    b_c1: $("b_c1"),
    b_c2: $("b_c2"),

    file_logo: $("file_logo"),
    file_header: $("file_header"),
    file_bg: $("file_bg"),
    btn_logo: $("btn_logo"),
    btn_header: $("btn_header"),
    btn_bg: $("btn_bg"),
    name_logo: $("name_logo"),
    name_header: $("name_header"),
    name_bg: $("name_bg"),
    prev_logo: $("prev_logo"),
    prev_header: $("prev_header"),
    prev_bg: $("prev_bg"),
    icon_logo: $("icon_logo"),
    icon_header: $("icon_header"),
    icon_bg: $("icon_bg"),

    previewBg: $("previewBg"),
    previewHeaderBar: $("previewHeaderBar"),
    previewHeaderImgWrap: $("previewHeaderImgWrap"),
    previewHeaderImg: $("previewHeaderImg"),
    previewLogo: $("previewLogo"),
    previewLogoIcon: $("previewLogoIcon"),
    previewTitle: $("previewTitle"),
    previewSubtitle: $("previewSubtitle"),
    previewTagline: $("previewTagline"),
    sw1: $("sw1"),
    sw2: $("sw2"),
    txt1: $("txt1"),
    txt2: $("txt2"),

    progInput: $("progInput"),
    btnAddProg: $("btnAddProg"),
    progList: $("progList"),

    lvl_mandal_reporting: $("lvl_mandal_reporting"),
    lvl_coordinator: $("lvl_coordinator"),
    lvl_program_info: $("lvl_program_info"),

    previewFormSel: $("previewFormSel"),
    previewModeSel: $("previewModeSel"),
    btnOpenNew: $("btnOpenNew"),
    btnLoadIframe: $("btnLoadIframe"),
    previewIframe: $("previewIframe"),
    iframeUrlTxt: $("iframeUrlTxt"),
  };

  if (els.cidVal && cid) { els.cidPill.classList.remove("hidden"); els.cidVal.textContent = cid; }

  function setStatus(msg, type = "info") {
    if (!els.status) return;
    els.status.classList.remove("hidden");
    const cls = type === "error"
      ? "bg-red-500/10 border-red-500/20 text-red-300"
      : type === "success"
      ? "bg-emerald-500/10 border-emerald-500/20 text-emerald-300"
      : type === "loading"
      ? "bg-slate-900/60 border-slate-700 text-slate-200"
      : "bg-slate-900/60 border-slate-700 text-slate-200";
    els.status.innerHTML = `<div class="px-3 py-2 rounded-xl border ${cls}">
      ${type === "loading" ? '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>' : ""}
      ${msg}
    </div>`;
  }

  const DEFAULT_CONFIG = {
    branding: {
      title: "Political Forms",
      subtitle: "Admin Config",
      tagline: "",
      color1: "#f97316",
      color2: "#ef4444",
      logo: { kind: "none", value: "" },
      header: { kind: "none", value: "" },
      background: { kind: "none", value: "" },
    },
    programs: ["मंडल बैठक","कार्यकर्ता सम्मेलन","जनसंपर्क","बूथ मीटिंग"],
    fixed_levels: { mandal_reporting: "", coordinator: "", program_info: "" }
  };

  let state = { config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)), pending: { logo: null, header: null, background: null } };

  function getIdToken() { return localStorage.getItem("id_token") || localStorage.getItem("idToken") || ""; }

  async function apiCall(action, payload) {
    const idToken = getIdToken();
    if (!idToken) throw new Error("id_token missing in localStorage. Please login first.");
    const resp = await fetch(FORMS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${idToken}` },
      body: JSON.stringify({ action, payload })
    });
    const txt = await resp.text();
    let json = {};
    try { json = JSON.parse(txt); } catch(e) { json = { message: txt || "Invalid JSON" }; }
    if (!resp.ok) throw new Error(json.message || `HTTP ${resp.status}`);
    return json;
  }

  function extFromMime(m) { if (!m) return "jpg"; if (m.includes("png")) return "png"; if (m.includes("webp")) return "webp"; return "jpg"; }

  async function sha256Hex(file) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function tryUploadAsset(kind, file) {
    const sha = await sha256Hex(file);
    const fileName = `${crypto.randomUUID()}.${extFromMime(file.type)}`;
    const actionCandidates = ["admin_init_asset_upload", "init_asset_upload", "admin_init_upload_asset"];
    let initRes = null;
    for (const a of actionCandidates) {
      try {
        initRes = await apiCall(a, { collection_id: cid, asset_kind: kind, sha256: sha, file_name: fileName, mime_type: file.type });
        break;
      } catch (e) {}
    }
    if (!initRes || !(initRes.upload_url || initRes.url)) return null;
    const uploadUrl = initRes.upload_url || initRes.url;
    await fetch(uploadUrl, { method: "PUT", body: file, headers: { "Content-Type": file.type } });
    const assetUrl = initRes.public_url || initRes.asset_url || initRes.url_public || "";
    const assetKey = initRes.s3_key || initRes.asset_key || initRes.key || "";
    return { kind: "s3", value: assetUrl || assetKey || "" };
  }

  function escapeHtml(s) { return String(s || "").replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

  function renderPrograms() {
    const arr = Array.isArray(state.config.programs) ? state.config.programs : [];
    els.progList.innerHTML = "";
    if (arr.length === 0) { els.progList.innerHTML = `<div class="text-slate-500 text-sm">No programs yet.</div>`; return; }
    arr.forEach((name, idx) => {
      const row = document.createElement("div");
      row.className = "flex items-center gap-2 bg-slate-950/20 border border-slate-800 rounded-xl px-3 py-2";
      row.innerHTML = `
        <div class="flex-1 min-w-0"><div class="text-sm text-white font-bold truncate">${escapeHtml(name)}</div></div>
        <button class="px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold" data-prog-del="${idx}">
          <i class="fa-solid fa-trash-can"></i>
        </button>`;
      els.progList.appendChild(row);
    });
    els.progList.querySelectorAll("[data-prog-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = parseInt(btn.getAttribute("data-prog-del"), 10);
        const a = [...(state.config.programs || [])];
        a.splice(i, 1);
        state.config.programs = a;
        renderPrograms();
      });
    });
  }

  function getAssetUrl(assetObj) { return (assetObj && assetObj.value) ? assetObj.value : ""; }

  function setPreview(imgEl, iconEl, url) {
    if (url) { imgEl.src = url; imgEl.classList.remove("hidden"); iconEl.classList.add("hidden"); }
    else { imgEl.src = ""; imgEl.classList.add("hidden"); iconEl.classList.remove("hidden"); }
  }

  function renderAssetPreviews() {
    const b = state.config.branding;
    const logoVal = (state.pending.logo && state.pending.logo.previewUrl) || getAssetUrl(b.logo);
    setPreview(els.prev_logo, els.icon_logo, logoVal);
    const headerVal = (state.pending.header && state.pending.header.previewUrl) || getAssetUrl(b.header);
    setPreview(els.prev_header, els.icon_header, headerVal);
    const bgVal = (state.pending.background && state.pending.background.previewUrl) || getAssetUrl(b.background);
    setPreview(els.prev_bg, els.icon_bg, bgVal);
  }

  function renderBrandPreview() {
    const b = state.config.branding;
    const c1 = els.b_c1.value || "#f97316";
    const c2 = els.b_c2.value || "#ef4444";
    els.previewHeaderBar.style.backgroundImage = `linear-gradient(to right, ${c1}, ${c2})`;
    els.sw1.style.background = c1; els.sw2.style.background = c2;
    els.txt1.textContent = c1; els.txt2.textContent = c2;
    els.previewTitle.textContent = els.b_title.value || "—";
    els.previewSubtitle.textContent = els.b_subtitle.value || "";
    els.previewTagline.textContent = els.b_tagline.value || "";
    const bgUrl = (state.pending.background && state.pending.background.previewUrl) || getAssetUrl(b.background);
    els.previewBg.style.backgroundImage = bgUrl ? `url('${bgUrl}')` : "";
    const headerUrl = (state.pending.header && state.pending.header.previewUrl) || getAssetUrl(b.header);
    if (headerUrl) { els.previewHeaderImgWrap.classList.remove("hidden"); els.previewHeaderImg.src = headerUrl; }
    else { els.previewHeaderImgWrap.classList.add("hidden"); els.previewHeaderImg.src = ""; }
    const logoUrl = (state.pending.logo && state.pending.logo.previewUrl) || getAssetUrl(b.logo);
    if (logoUrl) { els.previewLogo.src = logoUrl; els.previewLogo.classList.remove("hidden"); els.previewLogoIcon.classList.add("hidden"); }
    else { els.previewLogo.src = ""; els.previewLogo.classList.add("hidden"); els.previewLogoIcon.classList.remove("hidden"); }
  }

  function applyFormValuesFromState() {
    const b = state.config.branding || DEFAULT_CONFIG.branding;
    els.b_title.value = b.title || "";
    els.b_subtitle.value = b.subtitle || "";
    els.b_tagline.value = b.tagline || "";
    els.b_c1.value = b.color1 || "#f97316";
    els.b_c2.value = b.color2 || "#ef4444";
    els.lvl_mandal_reporting.value = state.config.fixed_levels?.mandal_reporting || "";
    els.lvl_coordinator.value = state.config.fixed_levels?.coordinator || "";
    els.lvl_program_info.value = state.config.fixed_levels?.program_info || "";
    renderPrograms();
    renderAssetPreviews();
    renderBrandPreview();
  }

  function bindLiveBranding() {
    ["input","change"].forEach(ev => {
      els.b_title.addEventListener(ev, () => { state.config.branding.title = (els.b_title.value||"").trim(); renderBrandPreview(); });
      els.b_subtitle.addEventListener(ev, () => { state.config.branding.subtitle = (els.b_subtitle.value||"").trim(); renderBrandPreview(); });
      els.b_tagline.addEventListener(ev, () => { state.config.branding.tagline = (els.b_tagline.value||"").trim(); renderBrandPreview(); });
      els.b_c1.addEventListener(ev, () => { state.config.branding.color1 = els.b_c1.value; renderBrandPreview(); });
      els.b_c2.addEventListener(ev, () => { state.config.branding.color2 = els.b_c2.value; renderBrandPreview(); });
      els.lvl_mandal_reporting.addEventListener(ev, () => { state.config.fixed_levels.mandal_reporting = els.lvl_mandal_reporting.value; });
      els.lvl_coordinator.addEventListener(ev, () => { state.config.fixed_levels.coordinator = els.lvl_coordinator.value; });
      els.lvl_program_info.addEventListener(ev, () => { state.config.fixed_levels.program_info = els.lvl_program_info.value; });
    });
  }

  function showTab(name) {
    document.querySelectorAll(".tab").forEach(t => t.classList.add("hidden"));
    const target = document.getElementById("tab-" + name);
    if (target) target.classList.remove("hidden");
    document.querySelectorAll(".navBtn").forEach(b => {
      const isActive = (b.getAttribute("data-tab") === name);
      b.className = isActive
        ? "navBtn w-full text-left px-3 py-2 rounded-xl bg-slate-900/50 hover:bg-slate-800 border border-slate-700 text-slate-200 text-sm font-bold"
        : "navBtn w-full text-left px-3 py-2 rounded-xl bg-slate-900/20 hover:bg-slate-800 border border-slate-800 text-slate-200 text-sm font-bold";
    });
  }
  document.querySelectorAll(".navBtn").forEach(b => b.addEventListener("click", () => showTab(b.getAttribute("data-tab"))));

  function setPendingAsset(kind, file) {
    if (!file) return;
    const url = URL.createObjectURL(file);
    state.pending[kind] = { file, previewUrl: url };
    if (kind === "logo") els.name_logo.textContent = file.name;
    if (kind === "header") els.name_header.textContent = file.name;
    if (kind === "background") els.name_bg.textContent = file.name;
    renderAssetPreviews(); renderBrandPreview();
  }

  els.btn_logo.addEventListener("click", () => els.file_logo.click());
  els.btn_header.addEventListener("click", () => els.file_header.click());
  els.btn_bg.addEventListener("click", () => els.file_bg.click());
  els.file_logo.addEventListener("change", () => setPendingAsset("logo", els.file_logo.files[0]));
  els.file_header.addEventListener("change", () => setPendingAsset("header", els.file_header.files[0]));
  els.file_bg.addEventListener("change", () => setPendingAsset("background", els.file_bg.files[0]));

  document.querySelectorAll("[data-clear]").forEach(btn => {
    btn.addEventListener("click", () => {
      const k = btn.getAttribute("data-clear");
      if (k === "logo") { state.pending.logo=null; state.config.branding.logo={kind:"none",value:""}; els.name_logo.textContent="No file selected"; els.file_logo.value=""; }
      if (k === "header") { state.pending.header=null; state.config.branding.header={kind:"none",value:""}; els.name_header.textContent="No file selected"; els.file_header.value=""; }
      if (k === "bg") { state.pending.background=null; state.config.branding.background={kind:"none",value:""}; els.name_bg.textContent="No file selected"; els.file_bg.value=""; }
      renderAssetPreviews(); renderBrandPreview();
    });
  });

  els.btnAddProg.addEventListener("click", () => {
    const v = (els.progInput.value || "").trim();
    if (!v) return;
    const a = Array.isArray(state.config.programs) ? [...state.config.programs] : [];
    if (a.includes(v)) { els.progInput.value = ""; return; }
    a.unshift(v);
    state.config.programs = a.slice(0, 200);
    els.progInput.value = "";
    renderPrograms();
  });

  function lsKey() { return `EL_POLITICAL_ADMIN_CONFIG::${cid || "default"}`; }
  function deepMerge(base, override) {
    if (!override || typeof override !== "object") return base;
    const out = Array.isArray(base) ? [...base] : { ...base };
    Object.keys(override).forEach(k => {
      const bv = out[k];
      const ov = override[k];
      if (Array.isArray(ov)) out[k] = ov;
      else if (ov && typeof ov === "object" && bv && typeof bv === "object" && !Array.isArray(bv)) out[k] = deepMerge(bv, ov);
      else out[k] = ov;
    });
    return out;
  }

  async function loadConfig() {
    if (!cid) { setStatus("CID missing in URL. Still you can edit preview, but save needs CID.", "error"); state.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); applyFormValuesFromState(); return; }
    setStatus("Loading config...", "loading");
    let cfg = null;
    try { const res = await apiCall("admin_get_config", { collection_id: cid }); cfg = res.config || res.data || res.item || null; } catch (e) {}
    if (!cfg) { try { const raw = localStorage.getItem(lsKey()); if (raw) cfg = JSON.parse(raw); } catch (e) {} }
    if (!cfg) cfg = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
    state.config = deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), cfg);
    applyFormValuesFromState();
    setStatus("Config loaded", "success");
  }

  async function saveConfig() {
    if (!cid) { setStatus("CID missing: cannot save to backend.", "error"); return; }
    els.btnSave.disabled = true;
    const oldTxt = els.btnSave.innerHTML;
    els.btnSave.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Saving...';
    setStatus("Saving... (uploading assets if any)", "loading");
    try {
      state.config.branding.title = (els.b_title.value || "").trim();
      state.config.branding.subtitle = (els.b_subtitle.value || "").trim();
      state.config.branding.tagline = (els.b_tagline.value || "").trim();
      state.config.branding.color1 = els.b_c1.value || "#f97316";
      state.config.branding.color2 = els.b_c2.value || "#ef4444";
      state.config.fixed_levels.mandal_reporting = els.lvl_mandal_reporting.value || "";
      state.config.fixed_levels.coordinator = els.lvl_coordinator.value || "";
      state.config.fixed_levels.program_info = els.lvl_program_info.value || "";

      const assetMap = [["logo","logo"],["header","header"],["background","background"]];
      for (const [pendingKey, brandingKey] of assetMap) {
        const p = state.pending[pendingKey];
        if (!p || !p.file) continue;
        let uploaded = null;
        try { uploaded = await tryUploadAsset(brandingKey, p.file); } catch (e) { uploaded = null; }
        if (uploaded && uploaded.value) state.config.branding[brandingKey] = { kind: uploaded.kind, value: uploaded.value };
        else state.config.branding[brandingKey] = { kind: "data", value: await fileToDataUrl(p.file) };
        state.pending[pendingKey] = null;
      }

      let backendSaved = false;
      try { await apiCall("admin_save_config", { collection_id: cid, config: state.config }); backendSaved = true; } catch (e) { backendSaved = false; }
      localStorage.setItem(lsKey(), JSON.stringify(state.config));
      applyFormValuesFromState();
      setStatus(backendSaved ? "Saved to backend + local cache" : "Backend save failed. Saved to local cache only.", backendSaved ? "success" : "error");
    } catch (e) {
      console.error(e);
      setStatus(e.message || "Save failed", "error");
    } finally {
      els.btnSave.disabled = false;
      els.btnSave.innerHTML = oldTxt;
    }
  }

  els.btnSave.addEventListener("click", saveConfig);
  els.btnReload.addEventListener("click", loadConfig);

  function buildPreviewUrl() {
    const file = els.previewFormSel.value;
    const mode = els.previewModeSel.value;
    const params = new URLSearchParams();
    if (mode === "token") {
      if (!token) { alert("Token missing in admin console URL. Add ?token=XXXX to use token preview."); return ""; }
      params.set("token", token);
    } else {
      if (!cid) { alert("CID missing. Add ?cid=COLLECTION_ID to preview in CID mode."); return ""; }
      params.set("cid", cid);
    }
    params.set("preview", "1");
    return `${file}?${params.toString()}`;
  }

  els.btnOpenNew.addEventListener("click", () => { const u = buildPreviewUrl(); if (!u) return; window.open(u, "_blank"); });
  els.btnLoadIframe.addEventListener("click", () => { const u = buildPreviewUrl(); if (!u) return; els.previewIframe.src = u; els.iframeUrlTxt.textContent = u; });

  bindLiveBranding();
  showTab("branding");
  loadConfig();
})();
</script>
</body>
</html>
