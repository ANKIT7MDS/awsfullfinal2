<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EventLens ‚Ä¢ Political Admin Console</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó≥Ô∏è</text></svg>" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0b1220; color: #e5e7eb; }
    .glass { background: rgba(15, 23, 42, 0.65); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
    .sidebar-link { display:flex; align-items:center; gap:10px; padding: 12px 14px; border-radius: 12px; transition: all .2s; cursor:pointer; color:#94a3b8; }
    .sidebar-link:hover { background: rgba(255,255,255,0.06); color:#fff; }
    .sidebar-link.active { background: linear-gradient(135deg, #fb923c, #ea580c); color:white; box-shadow: 0 8px 24px rgba(249,115,22,0.25); }
    .pill { border:1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); border-radius:999px; padding: 6px 10px; }
    .btn { border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
    .btn:hover { background: rgba(255,255,255,0.09); }
    .btnPrimary { background: linear-gradient(135deg, #22c55e, #16a34a); border: 0; color:white; }
    .btnPrimary:hover { filter: brightness(1.05); }
    .btnDanger { background: linear-gradient(135deg, #ef4444, #b91c1c); border: 0; color:white; }
    .btnDanger:hover { filter: brightness(1.05); }
    .input { width:100%; border-radius: 12px; border:1px solid rgba(255,255,255,0.12); background: rgba(2,6,23,0.55); padding: 10px 12px; outline:none; }
    .input:focus { border-color: rgba(249,115,22,0.7); box-shadow: 0 0 0 4px rgba(249,115,22,0.15); }
    .table { width:100%; border-collapse: separate; border-spacing:0; }
    .th { text-align:left; font-weight:600; color:#cbd5e1; font-size: 12px; letter-spacing:.04em; text-transform: uppercase; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06); vertical-align: top; }
    .row:hover { background: rgba(255,255,255,0.03); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .modalBackdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50; }
    .modal { width: min(1000px, 96vw); max-height: 90vh; overflow: auto; border-radius: 16px; }
    .drawerBackdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; z-index: 45; }
    .drawer { position: fixed; top: 0; right: 0; height: 100vh; width: min(520px, 95vw); transform: translateX(100%); transition: transform .2s ease; z-index: 46; }
    .drawer.open { transform: translateX(0); }
    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); background: rgba(2,6,23,0.9); border:1px solid rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 999px; display:none; z-index: 60; }
    img.thumb { width: 44px; height: 44px; border-radius: 12px; object-fit: cover; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); }
    .kv { display:grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .kv:last-child { border-bottom: 0; }
  </style>
</head>
<body>
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-[290px] hidden lg:block p-4">
      <div class="glass rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl font-bold">Political Admin</div>
            <div class="text-sm text-slate-400">Forms ‚Ä¢ Timeline ‚Ä¢ Photos</div>
          </div>
          <div class="pill text-xs text-slate-200"><span id="pillMode">API</span></div>
        </div>

        <div class="mt-4 space-y-2" id="tabList"></div>

        <div class="mt-5 p-3 rounded-2xl border border-white/10 bg-white/5">
          <div class="text-xs text-slate-300">Collection ID</div>
          <div class="mt-2 flex gap-2">
            <input id="cidInput" class="input mono" placeholder="collection_id (cid)" />
            <button id="btnUseCid" class="btn">Use</button>
          </div>
          <div class="mt-2 text-xs text-slate-400">
            Tip: link me token/cid aata hai to auto-fill ho jayega.
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="btnRefresh" class="btn btnPrimary w-full">Refresh</button>
          <button id="btnClear" class="btn w-full">Clear</button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-4 lg:p-6">
      <div class="glass rounded-2xl p-4 lg:p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
          <div>
            <div class="text-2xl font-bold">Forms Data</div>
            <div class="text-sm text-slate-400" id="subtitle">Loading‚Ä¶</div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <div class="pill text-xs text-slate-200 flex gap-2">
              <span>Rows:</span><span id="countLabel" class="font-semibold">0</span>
            </div>
            <div class="pill text-xs text-slate-200 flex gap-2">
              <span>Duplicates:</span><span id="dupLabel" class="font-semibold">0</span>
            </div>
            <button id="btnExport" class="btn">Export CSV</button>
          </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-6 gap-3">
          <div class="lg:col-span-2">
            <div class="text-xs text-slate-300 mb-1">Search (name/mobile/district/anything)</div>
            <input id="qInput" class="input" placeholder="type to filter‚Ä¶" />
          </div>
          <div>
            <div class="text-xs text-slate-300 mb-1">From</div>
            <input id="fromInput" class="input" type="date" />
          </div>
          <div>
            <div class="text-xs text-slate-300 mb-1">To</div>
            <input id="toInput" class="input" type="date" />
          </div>
          <div>
            <div class="text-xs text-slate-300 mb-1">Only duplicates</div>
            <select id="dupOnly" class="input">
              <option value="">All</option>
              <option value="1">Duplicates only</option>
              <option value="0">Non-duplicates only</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnApply" class="btn btnPrimary w-full">Apply</button>
          </div>
        </div>

        <!-- Table -->
        <div class="mt-4 overflow-auto rounded-2xl border border-white/10">
          <table class="table">
            <thead>
              <tr class="bg-white/5">
                <th class="th">Photo</th>
                <th class="th">Type</th>
                <th class="th">When</th>
                <th class="th">Name / Mobile</th>
                <th class="th">District / Vidhansabha / Mandal</th>
                <th class="th">Program / Guests</th>
                <th class="th">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
          <div class="text-xs text-slate-400" id="pageInfo"></div>
          <div class="flex gap-2">
            <button id="btnLoadMore" class="btn" style="display:none;">Load more</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer: details -->
  <div id="drawerBackdrop" class="drawerBackdrop"></div>
  <div id="drawer" class="drawer glass p-4 lg:p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-lg font-bold" id="dTitle">Entry</div>
        <div class="text-xs text-slate-400 mono" id="dSub"></div>
      </div>
      <button id="btnCloseDrawer" class="btn">Close</button>
    </div>

    <div class="mt-4">
      <div class="flex items-center gap-3">
        <img id="dImg" class="thumb" alt="thumb"/>
        <div class="min-w-0">
          <div class="text-sm text-slate-200" id="dName"></div>
          <div class="text-xs text-slate-400" id="dMeta"></div>
        </div>
      </div>

      <div class="mt-3 flex gap-2">
        <button id="btnOpenPhoto" class="btn w-full">Open Photo</button>
        <button id="btnDownloadPhoto" class="btn w-full">Download</button>
      </div>

      <div class="mt-4 text-sm font-semibold text-slate-200">Details</div>
      <div class="mt-2" id="dDetails"></div>

      <div class="mt-4 text-sm font-semibold text-slate-200">Raw JSON</div>
      <pre id="dJson" class="mt-2 p-3 rounded-2xl border border-white/10 bg-black/30 text-xs overflow-auto"></pre>

      <div class="mt-3">
        <button id="btnCopyS3" class="btn w-full">Copy s3_key</button>
      </div>
    </div>
  </div>

  <!-- Modal: image preview -->
  <div id="imgModal" class="modalBackdrop">
    <div class="glass modal p-4">
      <div class="flex items-center justify-between gap-2">
        <div class="text-lg font-bold">Photo Preview</div>
        <button id="btnCloseImg" class="btn">Close</button>
      </div>
      <div class="mt-3">
        <img id="imgPreview" alt="preview" class="w-full rounded-2xl border border-white/10 bg-white/5" />
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnOpenImgNew" class="btn w-full">Open in new tab</button>
        <button id="btnDownloadImg" class="btn btnPrimary w-full">Download</button>
      </div>
      <div class="mt-2 text-xs text-slate-400 mono break-all" id="imgUrlLabel"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ======= Config (same API ID you used in other pages) =======
    const API_ID = "vxid0yoovj"; // keep same
    const REGION = "ap-south-1";
    const STAGE = "prod";
    const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/${STAGE}`;

    // ======= Tabs (match your DynamoDB form_type values) =======
    const TABS = [
      { key: "all", label: "All Forms", icon: "üìã" },
      { key: "visitor_form", label: "Visitor Form", icon: "üßæ" },
      { key: "party_attendance", label: "Party Attendance", icon: "üë§" },
      { key: "president_tour_form", label: "President Tour", icon: "üö©" },
      { key: "mandal_reporting", label: "Mandal Reporting", icon: "üìç" }
    ];

    // ======= State =======
    let currentTab = "all";
    let cid = "";
    let allItems = [];
    let filteredItems = [];
    let nextKeyByTab = {}; // tabKey -> next_key (if backend supports)
    let lastFetchAt = 0;

    // ======= Helpers =======
    function qs(name) {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    function safeJsonParse(str) {
      try { return JSON.parse(str); } catch { return null; }
    }

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.style.display = "none", 2200);
    }

    function humanType(ft) {
      const map = {
        visitor_form: "Visitor",
        party_attendance: "Attendance",
        president_tour_form: "President Tour",
        mandal_reporting: "Mandal Report"
      };
      return map[ft] || ft || "-";
    }

    function pick(obj, keys) {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return "";
    }

    function epochToIso(ms) {
      const n = Number(ms);
      if (!isFinite(n) || n <= 0) return "";
      try { return new Date(n).toISOString(); } catch { return ""; }
    }

    function parseIsoToDate(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      return isFinite(d.getTime()) ? d : null;
    }

    function matchesQuery(item, q) {
      if (!q) return true;
      const hay = JSON.stringify(item).toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function withinDateRange(item, fromStr, toStr) {
      if (!fromStr && !toStr) return true;
      const iso = item.created_at_iso || epochToIso(item.created_at) || "";
      const d = parseIsoToDate(iso);
      if (!d) return true;

      const from = fromStr ? new Date(fromStr + "T00:00:00") : null;
      const to = toStr ? new Date(toStr + "T23:59:59") : null;

      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function setImgSrcWithRetry(imgEl, url, opts = {}) {
      const max = opts.maxRetries ?? 2;
      const baseDelay = opts.baseDelay ?? 350;
      let attempt = 0;

      const load = () => {
        if (!url) {
          imgEl.removeAttribute("src");
          imgEl.style.visibility = "hidden";
          return;
        }
        imgEl.style.visibility = "visible";
        imgEl.src = url;
      };

      imgEl.onerror = () => {
        if (attempt >= max) return;
        attempt++;
        const delay = baseDelay * Math.pow(2, attempt);
        setTimeout(() => {
          // Retry without cache (best-effort)
          try {
            const u = new URL(url);
            u.searchParams.set("r", String(Date.now()));
            url = u.toString();
          } catch {}
          load();
        }, delay);
      };

      load();
    }

    function downloadUrl(url, filename = "photo.jpg") {
      if (!url) return;
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.target = "_blank";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function copyToClipboard(txt) {
      if (!txt) return;
      navigator.clipboard.writeText(txt).then(() => showToast("Copied")).catch(() => showToast("Copy failed"));
    }

    function normalizeItem(raw) {
      // Backend variations: item.payload OR item.data OR flattened
      const payload = raw.payload || raw.data || raw.form_data || raw || {};
      const created_at = raw.created_at || payload.created_at || "";
      const created_at_iso = raw.created_at_iso || payload.created_at_iso || epochToIso(created_at);
      const form_type = raw.form_type || payload.form_type || "";
      const duplicate = (raw.duplicate !== undefined) ? raw.duplicate : (payload.duplicate !== undefined ? payload.duplicate : false);
      const s3_key = raw.s3_key || payload.s3_key || "";
      const face_id = raw.face_id || payload.face_id || "";
      const face_ids = raw.face_ids || payload.face_ids || [];

      // Single photo or multiple photos
      const photo_url = pick(raw, ["photo_url", "photoUrl"]) || pick(payload, ["photo_url", "photoUrl"]) || (raw.photo_urls && raw.photo_urls[0]) || (payload.photo_urls && payload.photo_urls[0]) || "";
      const thumb_url = pick(raw, ["thumb_url", "thumbUrl"]) || pick(payload, ["thumb_url", "thumbUrl"]) || "";

      // Common identity fields
      const name = pick(payload, ["name", "full_name", "visitor_name", "karyakarta_name"]) || "";
      const mobile = pick(payload, ["mobile", "phone", "visitor_mobile", "karyakarta_mobile"]) || "";
      const district = pick(payload, ["district"]) || "";
      const vidhansabha = pick(payload, ["vidhansabha", "assembly", "vidhan_sabha"]) || "";
      const mandal = pick(payload, ["mandal"]) || "";

      // Event-ish fields
      const program_name = pick(payload, ["program_name", "program", "tour_program", "meeting_name"]) || "";
      const guests = pick(payload, ["guests", "guest", "atithi"]) || "";
      const venue = pick(payload, ["tour_venue", "venue", "place", "location"]) || "";
      const date = pick(payload, ["tour_date", "event_date", "date"]) || "";
      const time = pick(payload, ["tour_time", "event_time", "time"]) || "";
      const program_type = pick(payload, ["program_type", "type"]) || "";

      return {
        raw,
        payload,
        entry_id: raw.entry_id || payload.entry_id || "",
        form_type,
        created_at,
        created_at_iso,
        duplicate: !!duplicate,
        s3_key,
        face_id,
        face_ids,
        photo_url,
        thumb_url,
        name, mobile, district, vidhansabha, mandal,
        program_name, guests, venue, date, time, program_type
      };
    }

    function buildTabList() {
      const el = document.getElementById("tabList");
      el.innerHTML = "";
      TABS.forEach(t => {
        const div = document.createElement("div");
        div.className = "sidebar-link" + (t.key === currentTab ? " active" : "");
        div.innerHTML = `<div class="text-lg">${t.icon}</div><div class="flex-1"><div class="font-semibold">${t.label}</div><div class="text-xs text-slate-300/80 mono" id="cnt_${t.key}">0</div></div>`;
        div.onclick = () => {
          currentTab = t.key;
          buildTabList();
          applyFiltersAndRender(true);
        };
        el.appendChild(div);
      });
    }

    async function postJson(path, body) {
      const url = BASE_URL + path;
      const headers = { "Content-Type": "application/json" };

      // If token is present in URL, pass it as Bearer too (safe for your API gateway custom auth if any)
      const token = qs("token");
      if (token) headers["Authorization"] = "Bearer " + token;

      const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
      const txt = await res.text();
      let json = safeJsonParse(txt);
      if (!res.ok) {
        const msg = (json && (json.message || json.error)) ? (json.message || json.error) : txt;
        throw new Error(msg || ("HTTP " + res.status));
      }
      return json || {};
    }

    async function fetchOneTab(tabKey, opts = {}) {
      const limit = opts.limit ?? 200;
      const next_key = opts.next_key ?? null;

      const payload = {
        cid: cid,
        collection_id: cid,
        form_type: tabKey,
        limit,
        next_key
      };

      // Some backends want empty to mean "all"
      if (tabKey === "all") {
        payload.form_type = "";
      }

      payload.action = "admin_list";
      const data = await postJson("/political/forms", payload);

      // Backend variations: {items:[]}, {Items:[]}, {data:[]}
      const items = data.items || data.Items || data.data || [];
      const nk = data.next_key || data.nextKey || data.LastEvaluatedKey || null;

      return { items, next_key: nk, raw: data };
    }

    async function loadData({ reset = true } = {}) {
      if (!cid) {
        showToast("Collection ID missing");
        return;
      }
      const now = Date.now();
      if (!reset && now - lastFetchAt < 600) return; // tiny throttle
      lastFetchAt = now;

      document.getElementById("subtitle").textContent = `Loading ${currentTab}‚Ä¶`;
      document.getElementById("btnLoadMore").style.display = "none";

      try {
        let merged = [];

        if (currentTab === "all") {
          // To avoid backend dependency, call each type and merge
          const tabsToLoad = TABS.filter(t => t.key !== "all").map(t => t.key);
          const results = await Promise.all(tabsToLoad.map(k => fetchOneTab(k, { limit: 200 })));
          results.forEach((r, idx) => {
            const tkey = tabsToLoad[idx];
            nextKeyByTab[tkey] = r.next_key;
            merged = merged.concat(r.items || []);
          });
        } else {
          const nk = reset ? null : (nextKeyByTab[currentTab] || null);
          const r = await fetchOneTab(currentTab, { limit: 200, next_key: nk });
          nextKeyByTab[currentTab] = r.next_key;
          merged = r.items || [];
          if (!reset) {
            // append to existing list (same tab)
            const existingRaw = allItems.map(x => x.raw);
            merged = existingRaw.concat(merged);
          }
        }

        // normalize
        allItems = merged.map(normalizeItem).filter(x => x.entry_id || x.created_at || x.s3_key);
        // sort newest first
        allItems.sort((a,b) => (Number(b.created_at)||0) - (Number(a.created_at)||0));

        // counts per tab (from already loaded data only)
        const counts = {};
        const dups = {};
        allItems.forEach(x => {
          counts[x.form_type] = (counts[x.form_type] || 0) + 1;
          if (x.duplicate) dups[x.form_type] = (dups[x.form_type] || 0) + 1;
        });
        TABS.forEach(t => {
          const el = document.getElementById("cnt_" + t.key);
          if (!el) return;
          if (t.key === "all") {
            const total = allItems.length;
            const dupTotal = allItems.filter(x => x.duplicate).length;
            el.textContent = `${total} rows ‚Ä¢ ${dupTotal} dup`;
          } else {
            const c = counts[t.key] || 0;
            const d = dups[t.key] || 0;
            el.textContent = `${c} rows ‚Ä¢ ${d} dup`;
          }
        });

        // show load more if we have next key (only in specific tab)
        if (currentTab !== "all" && nextKeyByTab[currentTab]) {
          document.getElementById("btnLoadMore").style.display = "inline-flex";
        }

        applyFiltersAndRender(false);
        showToast("Loaded");
      } catch (e) {
        console.error(e);
        document.getElementById("subtitle").textContent = "Error: " + (e.message || e);
        showToast("Load failed");
      }
    }

    function applyFiltersAndRender(scrollTop = false) {
      const q = document.getElementById("qInput").value.trim();
      const fromStr = document.getElementById("fromInput").value;
      const toStr = document.getElementById("toInput").value;
      const dupOnly = document.getElementById("dupOnly").value;

      const tabFiltered = (currentTab === "all")
        ? allItems
        : allItems.filter(x => x.form_type === currentTab);

      filteredItems = tabFiltered.filter(item => {
        if (!matchesQuery(item, q)) return false;
        if (!withinDateRange(item, fromStr, toStr)) return false;
        if (dupOnly === "1" && !item.duplicate) return false;
        if (dupOnly === "0" && item.duplicate) return false;
        return true;
      });

      // UI stats
      document.getElementById("countLabel").textContent = String(filteredItems.length);
      document.getElementById("dupLabel").textContent = String(filteredItems.filter(x => x.duplicate).length);
      document.getElementById("subtitle").textContent = `CID: ${cid || "-"} ‚Ä¢ Tab: ${currentTab} ‚Ä¢ Updated: ${new Date().toLocaleString()}`;
      document.getElementById("pageInfo").textContent = `Showing ${filteredItems.length} rows`;

      renderTable(filteredItems);

      if (scrollTop) {
        try { document.querySelector("main").scrollTop = 0; } catch {}
      }
    }

    function renderTable(items) {
      const tb = document.getElementById("tbody");
      tb.innerHTML = "";

      if (!items.length) {
        tb.innerHTML = `<tr><td class="td text-slate-400" colspan="7">No rows</td></tr>`;
        return;
      }

      // Render
      items.forEach((it) => {
        const tr = document.createElement("tr");
        tr.className = "row";

        const when = it.created_at_iso ? new Date(it.created_at_iso).toLocaleString() : (it.created_at || "");
        const who = `${(it.name || "-")}\n${(it.mobile || "-")}`;
        const loc = `${it.district || "-"}\n${it.vidhansabha || "-"}\n${it.mandal || "-"}`;

        const prog = [
          it.program_type ? `Type: ${it.program_type}` : "",
          it.program_name ? `Program: ${it.program_name}` : "",
          it.venue ? `Venue: ${it.venue}` : "",
          it.date ? `Date: ${it.date}` : "",
          it.time ? `Time: ${it.time}` : "",
          it.guests ? `Guests: ${it.guests}` : ""
        ].filter(Boolean).slice(0, 3).join("\n") || "-";

        const thumb = it.thumb_url || it.photo_url;

        tr.innerHTML = `
          <td class="td">
            <div class="flex items-center gap-2">
              <img class="thumb" alt="photo"/>
              <div class="text-xs text-slate-400">${it.duplicate ? "dup" : ""}</div>
            </div>
          </td>
          <td class="td">
            <div class="font-semibold">${humanType(it.form_type)}</div>
            <div class="text-xs text-slate-400 mono break-all">${it.entry_id || ""}</div>
          </td>
          <td class="td text-sm text-slate-200">${when}</td>
          <td class="td text-sm whitespace-pre-line">${who}</td>
          <td class="td text-sm whitespace-pre-line">${loc}</td>
          <td class="td text-sm whitespace-pre-line">${prog}</td>
          <td class="td">
            <div class="flex flex-col gap-2">
              <button class="btn btnPrimary">Open</button>
              <button class="btn">Preview</button>
              <button class="btn">Copy Face ID</button>
            </div>
          </td>
        `;

        const img = tr.querySelector("img.thumb");
        setImgSrcWithRetry(img, thumb, { maxRetries: 2 });

        const btnOpen = tr.querySelectorAll("button")[0];
        const btnPrev = tr.querySelectorAll("button")[1];
        const btnFace = tr.querySelectorAll("button")[2];

        btnOpen.onclick = () => openDrawer(it);
        btnPrev.onclick = () => openImgModal(it.photo_url || it.thumb_url || "");
        btnFace.onclick = () => copyToClipboard(it.face_id || "");

        tb.appendChild(tr);
      });
    }

    function kvRow(k, v) {
      const safeV = (v === null || v === undefined || v === "") ? "-" : String(v);
      return `<div class="kv"><div class="text-xs text-slate-400">${k}</div><div class="text-sm text-slate-100 break-words">${escapeHtml(safeV)}</div></div>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll("\"","&quot;")
        .replaceAll("'","&#039;");
    }

    function openDrawer(it) {
      document.getElementById("drawerBackdrop").style.display = "block";
      const drawer = document.getElementById("drawer");
      drawer.classList.add("open");

      document.getElementById("dTitle").textContent = `${humanType(it.form_type)} ‚Ä¢ ${it.duplicate ? "DUP" : "NEW"}`;
      document.getElementById("dSub").textContent = it.entry_id || "";
      document.getElementById("dName").textContent = (it.name || "-") + (it.mobile ? ` ‚Ä¢ ${it.mobile}` : "");
      document.getElementById("dMeta").textContent = `${it.district || "-"} ‚Ä¢ ${it.vidhansabha || "-"} ‚Ä¢ ${it.mandal || "-"}`;

      const img = document.getElementById("dImg");
      setImgSrcWithRetry(img, it.thumb_url || it.photo_url, { maxRetries: 2 });

      // Details block
      const details = [];
      details.push(kvRow("created_at", it.created_at_iso || epochToIso(it.created_at) || it.created_at));
      details.push(kvRow("form_type", it.form_type));
      details.push(kvRow("face_id", it.face_id));
      details.push(kvRow("s3_key", it.s3_key));
      if (it.program_type) details.push(kvRow("program_type", it.program_type));
      if (it.program_name) details.push(kvRow("program_name", it.program_name));
      if (it.venue) details.push(kvRow("venue", it.venue));
      if (it.date) details.push(kvRow("date", it.date));
      if (it.time) details.push(kvRow("time", it.time));
      if (it.guests) details.push(kvRow("guests", it.guests));
      if (it.payload && it.payload.attendance) details.push(kvRow("attendance", it.payload.attendance));
      if (it.payload && it.payload.reason) details.push(kvRow("reason", it.payload.reason));
      if (it.payload && it.payload.designation) details.push(kvRow("designation", it.payload.designation));
      document.getElementById("dDetails").innerHTML = details.join("");

      // JSON
      document.getElementById("dJson").textContent = JSON.stringify(it.payload || it.raw || it, null, 2);

      // Photo buttons
      const photo = it.photo_url || it.thumb_url || "";
      document.getElementById("btnOpenPhoto").onclick = () => {
        if (!photo) return showToast("No photo url");
        openImgModal(photo);
      };
      document.getElementById("btnDownloadPhoto").onclick = () => {
        if (!photo) return showToast("No photo url");
        downloadUrl(photo, `${it.form_type || "photo"}_${it.entry_id || "entry"}.jpg`);
      };

      document.getElementById("btnCopyS3").onclick = () => copyToClipboard(it.s3_key || "");
    }

    function closeDrawer() {
      document.getElementById("drawerBackdrop").style.display = "none";
      document.getElementById("drawer").classList.remove("open");
    }

    function openImgModal(url) {
      if (!url) {
        showToast("No image URL");
        return;
      }
      document.getElementById("imgModal").style.display = "flex";
      const img = document.getElementById("imgPreview");
      document.getElementById("imgUrlLabel").textContent = url;
      setImgSrcWithRetry(img, url, { maxRetries: 2 });
      document.getElementById("btnOpenImgNew").onclick = () => window.open(url, "_blank");
      document.getElementById("btnDownloadImg").onclick = () => downloadUrl(url, "photo.jpg");
    }

    function closeImgModal() {
      document.getElementById("imgModal").style.display = "none";
      document.getElementById("imgPreview").removeAttribute("src");
    }

    function exportCSV() {
      const rows = filteredItems;
      if (!rows.length) return showToast("No rows");

      const cols = [
        "form_type","created_at_iso","entry_id","duplicate",
        "name","mobile","district","vidhansabha","mandal",
        "program_type","program_name","venue","date","time","guests",
        "face_id","s3_key","photo_url"
      ];
      const escape = (v) => {
        const s = (v === null || v === undefined) ? "" : String(v);
        const t = s.replaceAll('"','""');
        return `"${t}"`;
      };

      const lines = [];
      lines.push(cols.join(","));
      rows.forEach(r => {
        lines.push(cols.map(c => escape(r[c] || "")).join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `political_admin_${cid}_${currentTab}_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("CSV downloaded");
    }

    function init() {
      // Auto CID from token payload (if JWT-like) or from URL params
      const urlCid = qs("cid") || qs("collection_id") || qs("collectionId");
      const token = qs("token");

      if (urlCid) cid = urlCid;

      // Try decode token payload (your tokens are JWT-like: header.payload.signature)
      if (!cid && token && token.split(".").length >= 2) {
        try {
          const payloadB64 = token.split(".")[1];
          const payloadJson = JSON.parse(atob(payloadB64.replaceAll("-","+").replaceAll("_","/")));
          cid = payloadJson.collection_id || payloadJson.cid || payloadJson.collectionId || "";
        } catch {}
      }

      document.getElementById("cidInput").value = cid || "";
      document.getElementById("pillMode").textContent = "API: " + API_ID;

      buildTabList();

      // Events
      document.getElementById("btnUseCid").onclick = () => {
        cid = document.getElementById("cidInput").value.trim();
        if (!cid) return showToast("CID missing");
        nextKeyByTab = {};
        loadData({ reset: true });
      };

      document.getElementById("btnRefresh").onclick = () => loadData({ reset: true });
      document.getElementById("btnClear").onclick = () => {
        document.getElementById("qInput").value = "";
        document.getElementById("fromInput").value = "";
        document.getElementById("toInput").value = "";
        document.getElementById("dupOnly").value = "";
        applyFiltersAndRender(false);
      };
      document.getElementById("btnApply").onclick = () => applyFiltersAndRender(false);
      document.getElementById("btnExport").onclick = exportCSV;

      document.getElementById("qInput").addEventListener("input", () => applyFiltersAndRender(false));
      document.getElementById("btnLoadMore").onclick = () => loadData({ reset: false });

      document.getElementById("drawerBackdrop").onclick = closeDrawer;
      document.getElementById("btnCloseDrawer").onclick = closeDrawer;

      document.getElementById("btnCloseImg").onclick = closeImgModal;
      document.getElementById("imgModal").onclick = (e) => { if (e.target.id === "imgModal") closeImgModal(); };

      // First load if cid exists
      if (cid) {
        loadData({ reset: true });
      } else {
        document.getElementById("subtitle").textContent = "CID missing ‚Ä¢ left sidebar me collection_id set karo";
        showToast("Set Collection ID");
      }
    }

    init();
  </script>
</body>
</html>
