<!DOCTYPE html>
<html lang="hi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Political Admin Console Pro - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: { 
            brand: { 500: '#f97316', 600: '#ea580c' }, 
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } 
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.4s ease-out forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #020617;
      background-image: 
        radial-gradient(at 0% 0%, rgba(249, 115, 22, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(56, 189, 248, 0.10) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(249, 115, 22, 0.05) 0px, transparent 50%);
      background-attachment: fixed;
      color: #e2e8f0;
    }
    
    /* Glass Effect Enhanced */
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .glass-header {
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Inputs & UI Elements */
    .input-field {
      background: rgba(2, 6, 23, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      transition: all 0.2s;
    }
    .input-field:focus {
      outline: none;
      border-color: #f97316;
      background: rgba(2, 6, 23, 0.7);
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Phone Mockup */
    .phone-mockup {
      border: 12px solid #1e293b;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #000;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .phone-mockup::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 24px;
      background: #1e293b;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      z-index: 10;
    }

    /* Tab Animations */
    .nav-btn {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .nav-btn.active {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
      border-left-color: #f97316;
      color: #fff;
    }
    .nav-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(10px);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top: 3px solid #f97316;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="min-h-screen font-sans selection:bg-orange-500/30">

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Top bar -->
  <nav class="sticky top-0 z-50 glass-header h-16">
    <div class="max-w-[1600px] mx-auto px-4 h-full">
      <div class="flex items-center justify-between h-full gap-4">
        
        <!-- Logo Area -->
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white shadow-lg shadow-orange-500/20 ring-1 ring-white/10">
            <i class="fa-solid fa-om"></i>
          </div>
          <div>
            <div class="text-white font-extrabold tracking-tight text-lg leading-none">EventLens <span class="text-orange-500">Pro</span></div>
            <div class="text-[10px] text-slate-400 font-semibold uppercase tracking-wider mt-1">Political Admin Console</div>
          </div>
        </div>

        <!-- Right Actions -->
        <div class="flex items-center gap-3">
          <!-- CID Display -->
          <div id="cidPill" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/60 border border-slate-800 text-xs font-mono text-slate-300">
            <i class="fa-solid fa-database text-emerald-500"></i>
            <span id="cidVal" class="font-bold text-white tracking-wide"></span>
          </div>

          <div class="h-6 w-px bg-slate-800 mx-1"></div>

          <!-- AUTH BUTTON -->
          <button id="btnAuth" class="group px-3 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 text-orange-400 hover:text-orange-300 transition-colors border border-transparent hover:border-orange-500/30" title="Update Token">
            <i class="fa-solid fa-key text-sm"></i>
          </button>

          <button id="btnReload" class="group px-3 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 text-slate-300 hover:text-white transition-colors border border-transparent hover:border-slate-700">
            <i class="fa-solid fa-rotate-right text-sm group-hover:rotate-180 transition-transform duration-500"></i>
          </button>

          <button id="btnSave" class="group relative px-5 py-2 rounded-lg bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white text-sm font-bold shadow-lg shadow-orange-600/20 transition-all hover:scale-105 active:scale-95 flex items-center gap-2 overflow-hidden">
            <span class="relative z-10 flex items-center gap-2">
              <i class="fa-solid fa-floppy-disk"></i> Save Changes
            </span>
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Layout -->
  <main class="max-w-[1600px] mx-auto px-4 py-6">
    <div class="grid lg:grid-cols-12 gap-6 items-start">

      <!-- Left Sidebar -->
      <aside class="lg:col-span-3 space-y-6 sticky top-24">
        
        <!-- Context Card -->
        <div class="glass-panel rounded-2xl p-5 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-chess-rook text-6xl text-orange-500"></i>
          </div>
          
          <div class="text-xs font-bold text-orange-400 uppercase tracking-widest mb-4">Current Context</div>
          
          <div class="space-y-4 relative z-10">
            <div>
              <label class="text-[11px] font-bold text-slate-400 uppercase">Collection ID</label>
              <div class="mt-1 flex gap-2">
                <input id="cidInput" class="input-field w-full rounded-lg px-3 py-2 text-xs font-mono" placeholder="Enter CID..." />
                <button id="btnApplyCid" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold text-white transition-colors">
                  <i class="fa-solid fa-check"></i>
                </button>
              </div>
            </div>

            <div>
              <label class="text-[11px] font-bold text-slate-400 uppercase">Edit Target</label>
              <div class="relative mt-1">
                <select id="targetFormSel" class="input-field w-full rounded-lg px-3 py-2.5 text-sm appearance-none cursor-pointer">
                  <option value="__defaults__">üì° Defaults (All Forms)</option>
                  <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                  <option value="visitor_form">üìù Visitor Form</option>
                  <option value="party_attendance">üö© Party Attendance</option>
                  <option value="president_tour">üöô President Tour</option>
                  <option value="mandal_reporting">üìä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó</option>
                  <option value="coordinator">üëî Coordinator</option>
                  <option value="program_info">‚ÑπÔ∏è Program Info</option>
                </select>
                <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs">
                  <i class="fa-solid fa-chevron-down"></i>
                </div>
              </div>
              <div class="text-[10px] text-slate-500 mt-2 leading-relaxed">
                Changes apply to the selected form only unless "Defaults" is chosen.
              </div>
            </div>

            <div class="flex items-center justify-between gap-2 rounded-lg bg-slate-950/40 border border-slate-800 p-3">
              <div>
                <div class="text-xs font-bold text-white">Live Preview</div>
                <div class="text-[10px] text-slate-500">Real-time branding update</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input id="livePreviewToggle" type="checkbox" class="sr-only peer" checked>
                <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="glass-panel rounded-2xl p-2 space-y-1">
          <button class="nav-btn active w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="branding">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-palette text-orange-400"></i></span>
            Branding & Preview
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="programs">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-list-check text-blue-400"></i></span>
            Program Names
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="levels">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-lock text-rose-400"></i></span>
            Level Locks
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="data">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-table text-emerald-400"></i></span>
            Data Records
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="analytics">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-chart-pie text-purple-400"></i></span>
            Analytics
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="backend">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-plug text-yellow-400"></i></span>
            API Config
          </button>
        </nav>

        <div class="text-center">
          <p class="text-[10px] text-slate-600">v2.9.0 Pro ‚Ä¢ EventLens System</p>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="lg:col-span-9 min-h-[80vh]">
        
        <!-- TAB: Branding -->
        <section id="tab-branding" class="tab-content animate-fade-in">
          <div class="grid lg:grid-cols-12 gap-6">
            
            <!-- Editor Column -->
            <div class="lg:col-span-7 space-y-6">
              <div class="glass-panel rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                   <h2 class="text-xl font-bold text-white flex items-center gap-2">
                     <i class="fa-solid fa-pen-nib text-orange-500"></i> Appearance
                   </h2>
                   <div class="flex gap-2">
                      <button id="btnResetBrand" class="px-3 py-1.5 text-xs font-semibold text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-700 rounded-lg transition-colors">Reset</button>
                      <button id="btnCopyToDefaults" class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded-lg transition-colors">Copy to All</button>
                   </div>
                </div>

                <!-- Text Inputs -->
                <div class="space-y-4">
                  <div class="grid md:grid-cols-2 gap-4">
                    <div class="group">
                      <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Title / Header</label>
                      <input id="b_title" class="input-field w-full rounded-xl px-4 py-3 text-sm font-bold" placeholder="e.g. ‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞" />
                    </div>
                    <div class="group">
                      <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Subtitle</label>
                      <input id="b_subtitle" class="input-field w-full rounded-xl px-4 py-3 text-sm" placeholder="e.g. ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§" />
                    </div>
                  </div>
                  <div class="group">
                    <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Tagline</label>
                    <input id="b_tagline" class="input-field w-full rounded-xl px-4 py-3 text-sm" placeholder="e.g. ‡§∏‡•á‡§µ‡§æ ‚Ä¢ ‡§∏‡§Ç‡§ó‡§†‡§® ‚Ä¢ ‡§∏‡§Æ‡§∞‡•ç‡§™‡§£" />
                  </div>
                </div>

                <!-- Colors -->
                <div class="mt-6 p-4 bg-slate-950/30 rounded-xl border border-slate-800/50">
                  <label class="text-xs font-bold text-slate-400 block mb-3">Gradient Theme</label>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <div class="flex items-center gap-3">
                        <input id="b_c1" type="color" class="w-10 h-10 rounded-lg bg-transparent cursor-pointer border-0 p-0" />
                        <div class="text-xs font-mono text-slate-400">Primary</div>
                      </div>
                    </div>
                    <div>
                      <div class="flex items-center gap-3">
                        <input id="b_c2" type="color" class="w-10 h-10 rounded-lg bg-transparent cursor-pointer border-0 p-0" />
                        <div class="text-xs font-mono text-slate-400">Secondary</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Assets Upload -->
              <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">Assets</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- Logo Upload -->
                  <div class="relative group">
                    <input id="file_logo" type="file" accept="image/*,.svg" class="hidden" />
                    <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_logo').click()">
                      <img id="prev_logo" class="absolute inset-0 w-full h-full object-contain p-2 hidden z-10" />
                      <i id="icon_logo" class="fa-solid fa-image text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform"></i>
                      <span class="text-[10px] font-bold text-slate-400 group-hover:text-white">Upload Logo</span>
                    </div>
                    <button class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="logo"><i class="fa-solid fa-xmark text-xs"></i></button>
                    <div id="name_logo" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
                  </div>

                  <!-- Header Upload -->
                  <div class="relative group">
                    <input id="file_header" type="file" accept="image/*,.svg" class="hidden" />
                    <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_header').click()">
                      <img id="prev_header" class="absolute inset-0 w-full h-full object-cover hidden z-10 opacity-60" />
                      <i id="icon_header" class="fa-solid fa-panorama text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform z-0"></i>
                      <span class="text-[10px] font-bold text-slate-400 group-hover:text-white z-20 relative">Upload Header</span>
                    </div>
                    <button class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="header"><i class="fa-solid fa-xmark text-xs"></i></button>
                    <div id="name_header" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
                  </div>

                  <!-- BG Upload -->
                  <div class="relative group">
                    <input id="file_bg" type="file" accept="image/*,.svg" class="hidden" />
                    <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_bg').click()">
                      <img id="prev_bg" class="absolute inset-0 w-full h-full object-cover hidden z-10 opacity-60" />
                      <i id="icon_bg" class="fa-solid fa-mountain-sun text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform z-0"></i>
                      <span class="text-[10px] font-bold text-slate-400 group-hover:text-white z-20 relative">Upload BG</span>
                    </div>
                    <button class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="bg"><i class="fa-solid fa-xmark text-xs"></i></button>
                    <div id="name_bg" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Preview Column -->
            <div class="lg:col-span-5">
              <div class="sticky top-28">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Mobile Preview</h3>
                  <div class="flex gap-2">
                     <button id="btnLoadFormPreview" class="px-3 py-1 text-xs rounded-full bg-orange-600 hover:bg-orange-500 text-white font-bold transition-colors"><i class="fa-solid fa-rotate mr-1"></i> Refresh</button>
                     <button id="btnOpenFormPreview" class="px-3 py-1 text-xs rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold transition-colors"><i class="fa-solid fa-up-right-from-square"></i></button>
                  </div>
                </div>


                <div class="flex items-center gap-2">
  <label class="text-xs text-slate-400">Preview form</label>
  <select id="previewTargetSelect" class="rounded-lg border border-white/10 bg-slate-900/40 px-2 py-1 text-sm text-white"></select>
</div>
<div id="previewTabs" class="mt-3 flex flex-wrap gap-2"></div>
                <!-- Phone Mockup Container -->
                <div class="flex justify-center">
                  <div class="phone-mockup w-[320px] h-[640px] bg-white">
                    <iframe id="formPreviewIframe" class="w-full h-full bg-white border-0"></iframe>
                    
                    <!-- Fallback/Overlay for branding preview (JS controlled opacity) -->
                    <div id="customPreviewOverlay" class="absolute inset-0 bg-slate-900 pointer-events-none opacity-0 transition-opacity duration-300 z-20 flex flex-col">
                       <!-- This overlay is just for quick color feedback if iframe is slow -->
                       <div id="previewHeaderBar" class="h-1 w-full bg-orange-500"></div>
                       <div id="previewBg" class="flex-1 bg-cover bg-center relative">
                         <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                         <div class="relative p-6 flex flex-col items-center justify-center h-full text-center">
                            <div id="previewHeaderImgWrap" class="w-full h-32 rounded-lg overflow-hidden mb-4 hidden shadow-lg">
                               <img id="previewHeaderImg" class="w-full h-full object-cover">
                            </div>
                            <img id="previewLogo" class="w-20 h-20 rounded-full object-cover border-4 border-white/10 mb-4 hidden shadow-2xl">
                            <i id="previewLogoIcon" class="fa-solid fa-bolt text-4xl text-orange-500 mb-4"></i>
                            
                            <h2 id="previewTitle" class="text-2xl font-bold text-white mb-1">Title</h2>
                            <p id="previewSubtitle" class="text-sm text-slate-300">Subtitle</p>
                            <div class="mt-6 flex gap-2 justify-center">
                               <div id="sw1" class="w-4 h-4 rounded-full bg-orange-500"></div>
                               <div id="sw2" class="w-4 h-4 rounded-full bg-red-500"></div>
                            </div>
                         </div>
                       </div>
                    </div>
                  </div>
                </div>
                
                <div class="text-center mt-4">
                   <div class="inline-block px-3 py-1 rounded-full bg-slate-900 border border-slate-800 text-[10px] text-slate-500 font-mono">
                     <span id="formPreviewUrlTxt" class="max-w-[200px] truncate block">...</span>
                   </div>
                </div>
              </div>
            </div>
          </div>
<!-- Removed All Forms Live Preview grid -->
</section>

        <!-- TAB: Programs -->
        <section id="tab-programs" class="tab-content hidden animate-fade-in space-y-6">
          <div class="glass-panel rounded-2xl p-6">
             <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                   <h2 class="text-xl font-bold text-white">Program Management</h2>
                   <p class="text-sm text-slate-400">Manage the list of programs available in dropdowns.</p>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-slate-800">
                   <span class="text-xs font-bold text-slate-400 px-2">Mode:</span>
                   <select id="progScopeSel" class="bg-transparent text-xs text-white font-bold py-1 pr-2 outline-none">
                      <option value="current">Current Form Only</option>
                      <option value="defaults">Defaults (Global)</option>
                   </select>
                </div>
             </div>

             <div class="flex gap-2 mb-8">
                <input id="progInput" class="input-field flex-1 rounded-xl px-4 py-3 text-sm" placeholder="Type new program name (e.g. ‡§¨‡•Ç‡§• ‡§µ‡§ø‡§ú‡§Ø ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®)..." />
                <button id="btnAddProg" class="px-6 py-3 rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-bold shadow-lg shadow-orange-600/20 transition-all active:scale-95">
                   <i class="fa-solid fa-plus"></i> Add
                </button>
             </div>

             <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="progList">
                <!-- Program items injected here -->
             </div>
          </div>
        </section>

        <!-- TAB: Levels -->
        <section id="tab-levels" class="tab-content hidden animate-fade-in space-y-6">
          <div class="glass-panel rounded-2xl p-6">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Hierarchical Locks</h2>
                <select id="levelScopeSel" class="input-field rounded-lg px-3 py-1.5 text-xs">
                   <option value="current">Current Form</option>
                   <option value="defaults">Defaults</option>
                </select>
             </div>
             
             <div class="grid md:grid-cols-3 gap-6">
                <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
                   <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-sitemap"></i></div>
                      <div class="font-bold text-white text-sm">Reporting Level</div>
                   </div>
                   <select id="lvl_mandal_reporting" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                      <option value="">üîì Unlocked</option>
                      <option value="district">District Fixed</option>
                      <option value="vidhansabha">Vidhan Sabha Fixed</option>
                      <option value="mandal">Mandal Fixed</option>
                   </select>
                </div>

                <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
                   <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 rounded-lg bg-purple-500/20 text-purple-400 flex items-center justify-center"><i class="fa-solid fa-user-tie"></i></div>
                      <div class="font-bold text-white text-sm">Coordinator</div>
                   </div>
                   <select id="lvl_coordinator" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                      <option value="">üîì Unlocked</option>
                      <option value="district">District Fixed</option>
                      <option value="vidhansabha">Vidhan Sabha Fixed</option>
                      <option value="mandal">Mandal Fixed</option>
                   </select>
                </div>

                <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
                   <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 rounded-lg bg-emerald-500/20 text-emerald-400 flex items-center justify-center"><i class="fa-solid fa-info"></i></div>
                      <div class="font-bold text-white text-sm">Program Info</div>
                   </div>
                   <select id="lvl_program_info" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                      <option value="">üîì Unlocked</option>
                      <option value="district">District Fixed</option>
                      <option value="vidhansabha">Vidhan Sabha Fixed</option>
                      <option value="mandal">Mandal Fixed</option>
                   </select>
                </div>
             </div>
          </div>
        </section>

        <!-- TAB: Data -->
        <section id="tab-data" class="tab-content hidden animate-fade-in space-y-6">
          <div class="glass-panel rounded-2xl p-6">
             <!-- Filters -->
             <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
                <div class="col-span-2 lg:col-span-2">
                   <input id="dataSearch" class="input-field w-full rounded-xl px-4 py-2.5 text-sm" placeholder="Search name, mobile..." />
                </div>
                <div class="col-span-1 lg:col-span-1">
                   <select id="dataFormSel" class="input-field w-full rounded-xl px-3 py-2.5 text-sm">
                      <option value="__all__">All Forms</option>
                      <option value="visitor_form">Visitor</option>
                      <option value="party_attendance">Attendance</option>
                      <option value="president_tour">Tour</option>
                      <option value="mandal_reporting">Reporting</option>
                      <option value="coordinator">Coordinator</option>
                      <option value="program_info">Program Info</option>
                   </select>
                </div>
                <div class="col-span-1">
                   <input id="dateFrom" type="date" class="input-field w-full rounded-xl px-3 py-2.5 text-sm" />
                </div>
                <div class="col-span-1">
                   <input id="dateTo" type="date" class="input-field w-full rounded-xl px-3 py-2.5 text-sm" />
                </div>
                <div class="col-span-1">
                   <button id="btnApplyFilter" class="w-full h-full rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-bold text-sm transition-colors border border-slate-700">Filter</button>
                </div>
             </div>

             <!-- Stats -->
             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                   <div class="text-[10px] text-slate-500 font-bold uppercase">Total Entries</div>
                   <div id="kpiTotal" class="text-2xl font-extrabold text-white mt-1">0</div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                   <div class="text-[10px] text-slate-500 font-bold uppercase">Today</div>
                   <div id="kpiToday" class="text-2xl font-extrabold text-orange-500 mt-1">0</div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                   <div class="text-[10px] text-slate-500 font-bold uppercase">Unique Mobiles</div>
                   <div id="kpiUnique" class="text-2xl font-extrabold text-blue-400 mt-1">0</div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                    <div class="flex gap-2 mt-2">
                       <button id="btnLoadData" class="flex-1 py-1.5 rounded-lg bg-orange-600/20 text-orange-500 hover:bg-orange-600 hover:text-white text-xs font-bold transition-all">Load</button>
                       <button id="btnExportCsv" class="flex-1 py-1.5 rounded-lg bg-slate-800 text-slate-300 hover:text-white text-xs font-bold transition-all"><i class="fa-solid fa-download"></i> CSV</button>
                    </div>
                 </div>
             </div>

             <!-- Table -->
             <div class="rounded-xl border border-slate-800 overflow-hidden bg-slate-950/20">
                <div class="overflow-x-auto">
                   <table class="w-full text-sm text-left">
                      <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-bold">
                         <tr>
                            <th class="px-4 py-3 cursor-pointer hover:text-white" data-sort="created_at">Time <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="px-4 py-3">Form</th>
                            <th class="px-4 py-3 cursor-pointer hover:text-white" data-sort="mobile">Mobile <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3 cursor-pointer hover:text-white" data-sort="district">District <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="px-4 py-3">Action</th>
                         </tr>
                      </thead>
                      <tbody id="dataTbody" class="divide-y divide-slate-800 text-slate-300">
                         <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500 italic">Click "Load" to fetch data</td></tr>
                      </tbody>
                   </table>
                </div>
                <div class="bg-slate-900/80 px-4 py-2 flex justify-between items-center border-t border-slate-800">
                   <div class="text-xs text-slate-500">Showing <span id="loadedCount" class="text-white font-bold">0</span> records</div>
                   <div class="flex gap-2">
                      <button id="btnPrevPage" class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs text-white disabled:opacity-50">Prev</button>
                      <button id="btnNextPage" class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs text-white disabled:opacity-50">Next</button>
                   </div>
                </div>
             </div>
          </div>
        </section>

        <!-- TAB: Analytics -->
        <section id="tab-analytics" class="tab-content hidden animate-fade-in space-y-6">
          <div class="flex justify-end">
             <button id="btnRefreshCharts" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-xs font-bold text-white transition-colors border border-slate-700"><i class="fa-solid fa-rotate mr-2"></i>Refresh Charts</button>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
             <div class="glass-panel p-5 rounded-2xl">
                <h4 class="text-sm font-bold text-slate-300 mb-4">Submission Trends (14 Days)</h4>
                <div class="h-[250px]"><canvas id="chartByDay"></canvas></div>
             </div>
             <div class="glass-panel p-5 rounded-2xl">
                <h4 class="text-sm font-bold text-slate-300 mb-4">By Form Type</h4>
                <div class="h-[250px]"><canvas id="chartByForm"></canvas></div>
             </div>
             <div class="glass-panel p-5 rounded-2xl md:col-span-2">
                <h4 class="text-sm font-bold text-slate-300 mb-4">Top Districts</h4>
                <div class="h-[200px]"><canvas id="chartDistrict"></canvas></div>
             </div>
          </div>
        </section>
        
        <!-- TAB: Backend Info -->
        <section id="tab-backend" class="tab-content hidden animate-fade-in">
           <div class="glass-panel rounded-2xl p-8 text-center">
              <div class="inline-flex w-16 h-16 rounded-full bg-slate-800 items-center justify-center mb-4">
                 <i class="fa-solid fa-server text-2xl text-slate-400"></i>
              </div>
              <h2 class="text-xl font-bold text-white">Backend Configuration</h2>
              <p class="text-sm text-slate-400 mt-2 max-w-lg mx-auto">This console connects to the EventLens AWS Lambda infrastructure. Ensure your user account has `political_admin` claims.</p>
              
              <div class="mt-8 grid gap-4 max-w-2xl mx-auto text-left">
                 <div class="bg-slate-950/50 rounded-lg p-4 border border-slate-800 font-mono text-xs text-slate-300">
                    <span class="text-orange-500">POST</span> /prod/political/forms
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/30 p-3 rounded border border-slate-800">
                       <div class="text-[10px] text-slate-500 uppercase font-bold">Action</div>
                       <div class="text-sm text-white font-mono mt-1">admin_save_config</div>
                    </div>
                    <div class="bg-slate-900/30 p-3 rounded border border-slate-800">
                        <div class="text-[10px] text-slate-500 uppercase font-bold">Action</div>
                        <div class="text-sm text-white font-mono mt-1">admin_list_entries</div>
                     </div>
                 </div>
              </div>
           </div>
        </section>

      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-[60] backdrop-blur-sm">
    <div class="absolute inset-0 bg-black/80" id="modalBackdrop"></div>
    <div class="relative max-w-2xl w-[90%] rounded-2xl border border-slate-700 bg-slate-900 shadow-2xl overflow-hidden animate-slide-up">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 bg-slate-900/50">
        <div>
          <h3 class="text-lg font-bold text-white">Data Details</h3>
          <div id="modalMeta" class="text-xs text-slate-400 font-mono mt-1">ID: ...</div>
        </div>
        <button id="btnCloseModal" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors flex items-center justify-center">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-0 overflow-auto max-h-[70vh]">
        <pre id="modalJson" class="text-xs text-green-400 bg-[#0d1117] p-6 font-mono overflow-auto"></pre>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
      <h3 class="text-lg font-bold text-white mb-2">Update Access Token</h3>
      <p class="text-xs text-slate-400 mb-4">Your session has expired or the token is invalid. Please paste a new ID Token below.</p>
      <textarea id="authTokenInput" class="w-full h-24 bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs text-slate-300 font-mono mb-4 focus:border-orange-500 outline-none" placeholder="Paste id_token here..."></textarea>
      <div class="flex justify-end gap-3">
        <button id="btnCancelAuth" class="px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white hover:bg-slate-800">Cancel</button>
        <button id="btnSaveAuth" class="px-4 py-2 rounded-lg text-xs font-bold text-white bg-orange-600 hover:bg-orange-500">Save & Reload</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- Constants & Utils ---
  const API_ID = "vxid0yoovj"; // Replace if needed
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  const FORMS_URL = `${BASE_URL}/political/forms`;

  const FORM_META = {
    __defaults__: { file: "political_visitor_form.html", label: "üì° Defaults" },
    visitor_form: { file: "political_visitor_form.html", label: "üìù Visitor" },
    party_attendance: { file: "political_party_attendance_form.html", label: "üö© Attendance" },
    president_tour: { file: "political_president_tour_form.html", label: "üöô Tour" },
    mandal_reporting: { file: "political_mandal_reporting_form.html", label: "üìä Reporting" },
    coordinator: { file: "political_coordinator_form.html", label: "üëî Coordinator" },
    program_info: { file: "political_program_info_form.html", label: "‚ÑπÔ∏è Program Info" },
  };

  const $ = (id) => document.getElementById(id);
  const qs = (n) => { try { return (new URL(window.location.href)).searchParams.get(n) || ""; } catch(e){ return ""; } };

  function getIdToken(){ return localStorage.getItem("id_token") || localStorage.getItem("idToken") || ""; }
  function extFromMime(m){ if(!m) return "jpg"; if(m.includes("png")) return "png"; if(m.includes("webp")) return "webp"; return "jpg"; }
  async function sha256Hex(file){
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result||""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // --- UI Helpers ---
  function showToast(msg, type = 'info') {
    const container = $('toastContainer');
    const el = document.createElement('div');
    
    let icon = 'fa-info-circle';
    let colors = 'bg-slate-800 border-slate-700 text-white';
    
    if(type === 'success') { icon = 'fa-circle-check'; colors = 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100'; }
    if(type === 'error') { icon = 'fa-circle-exclamation'; colors = 'bg-red-900/90 border-red-500/30 text-red-100'; }
    if(type === 'loading') { icon = 'fa-circle-notch fa-spin'; colors = 'bg-blue-900/90 border-blue-500/30 text-blue-100'; }

    el.className = `toast flex items-center gap-3 px-4 py-3 rounded-xl border shadow-xl min-w-[300px] ${colors}`;
    el.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-medium">${msg}</span>`;
    
    container.appendChild(el);

    if(type !== 'loading') {
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
        setTimeout(() => el.remove(), 300);
      }, 3000);
    }
    return el;
  }

  function openAuthModal() {
      const modal = $('authModal');
      if(modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          $('authTokenInput').focus();
      }
  }

  // --- State & Config ---
  const DEFAULT_CONFIG = {
    defaults: {
      branding: { title: "Political Forms", subtitle: "Visitor Entry System", tagline: "", color1: "#f97316", color2: "#ef4444", logo: { kind: "none" }, header: { kind: "none" }, background: { kind: "none" } },
      programs: ["‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡•ç‡§Æ‡•á‡§≤‡§®","‡§ú‡§®‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï","‡§¨‡•Ç‡§• ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó"],
      fixed_levels: {}
    },
    forms: { visitor_form: {}, party_attendance: {}, president_tour: {}, mandal_reporting: {}, coordinator: {}, program_info: {} }
  };

  let state = {
    cid: (qs("cid") || qs("collection_id") || "").trim(),
    target: "visitor_form",
    config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
    pendingAssets: {},
    cacheBust: Date.now(),
    lastPreviewDoc: "",
    allItems: [],
    viewItems: [],
    nextToken: null,
    prevStack: [],
    sort: { key: "created_at", dir: "desc" },
    charts: { byForm: null, byDay: null, byDistrict: null }
  };

  // --- Core Logic ---
  function ensureFormObj(ft){ if (!state.config.forms[ft]) state.config.forms[ft] = {}; }
  function deepMerge(base, override){
    if (!override || typeof override !== "object") return base;
    const out = Array.isArray(base) ? [...base] : { ...base };
    Object.keys(override).forEach(k=>{
      const bv = out[k], ov = override[k];
      if (Array.isArray(ov)) out[k] = ov;
      else if (ov && typeof ov === "object" && bv && typeof bv === "object" && !Array.isArray(bv)) out[k] = deepMerge(bv, ov);
      else out[k] = ov;
    });
    return out;
  }

  function getEffectiveBranding(ft) {
    const d = state.config.defaults.branding;
    const o = (ft !== "__defaults__") ? (state.config.forms[ft]?.branding || {}) : {};
    return { ...d, ...o };
  }

  
function withCacheBust(url) {
  if(!url) return "";
  try {
    const u = new URL(url, window.location.href);
    u.searchParams.set("cb", String(state.cacheBust || Date.now()));
    return u.toString();
  } catch(e) {
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "cb=" + encodeURIComponent(String(state.cacheBust || Date.now()));
  }
}

function escHtml(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function getEffectiveForm(ft) {
  const cfg = state.config || {};
  const forms = cfg.forms || {};
  const defaults = cfg.defaults || {};
  const global = cfg.global || {};
  const form = (ft && ft !== "__defaults__") ? (forms[ft] || {}) : {};
  const brandingDefaults = (defaults.branding || {});
  const brandingForm = (form.branding || {});
  const branding = deepMerge(brandingDefaults, brandingForm);

  const title = form.title || cfg.form?.title || branding.title || "Form";
  const subtitle = form.subtitle || cfg.form?.subtitle || branding.subtitle || "";
  const tagline = (form.tagline ?? cfg.form?.tagline ?? branding.tagline ?? global.tagline ?? "");

  const pend = (state.pendingAssets?.[ft] || {});
  const logoUrl = pend.logo?.previewUrl || form.logo_url || branding.logo?.url || (typeof branding.logo?.value === "string" && branding.logo.value.startsWith("http") ? branding.logo.value : "");
  const headerUrl = pend.header?.previewUrl || form.header_url || branding.header?.url || (typeof branding.header?.value === "string" && branding.header.value.startsWith("http") ? branding.header.value : "");
  const bgUrl = pend.background?.previewUrl || form.background_url || branding.background?.url || (typeof branding.background?.value === "string" && branding.background.value.startsWith("http") ? branding.background.value : "");

  const color1 = branding.color1 || "#f97316";
  const color2 = branding.color2 || "#ef4444";

  return { ft, form, branding, title, subtitle, tagline, logoUrl, headerUrl, bgUrl, color1, color2 };
}


function renderBrandInputsFromConfig() {
  if(!state.config) return;
  const ft = state.target || "visitor_form";
  const eff = getEffectiveForm(ft);

  // Title/Sub/Tagline inputs (users expect these to change form heading)
  if($("b_title")) $("b_title").value = eff.title || "";
  if($("b_subtitle")) $("b_subtitle").value = eff.subtitle || "";
  if($("b_tagline")) $("b_tagline").value = eff.tagline || "";

  // Colors
  if($("b_c1")) $("b_c1").value = eff.color1 || "#f97316";
  if($("b_c2")) $("b_c2").value = eff.color2 || "#ef4444";

  // Current images previews
  const logoUrl = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";
  const headerUrl = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
  const bgUrl = eff.bgUrl ? withCacheBust(eff.bgUrl) : "";

  if($("prev_logo")) {
    if(logoUrl) {
      $("prev_logo").src = logoUrl;
      $("prev_logo").classList.remove('hidden');
      $("icon_logo").classList.add('hidden');
      $("name_logo").textContent = "Uploaded";
    } else {
      $("prev_logo").src = "";
      $("prev_logo").classList.add('hidden');
      $("icon_logo").classList.remove('hidden');
      $("name_logo").textContent = "No file";
    }
  }
  
  if($("prev_header")) {
    if(headerUrl) {
      $("prev_header").src = headerUrl;
      $("prev_header").classList.remove('hidden');
      $("icon_header").classList.add('hidden');
      $("name_header").textContent = "Uploaded";
    } else {
      $("prev_header").src = "";
      $("prev_header").classList.add('hidden');
      $("icon_header").classList.remove('hidden');
      $("name_header").textContent = "No file";
    }
  }
  
  if($("prev_bg")) {
    if(bgUrl) {
      $("prev_bg").src = bgUrl;
      $("prev_bg").classList.remove('hidden');
      $("icon_bg").classList.add('hidden');
      $("name_bg").textContent = "Uploaded";
    } else {
      $("prev_bg").src = "";
      $("prev_bg").classList.add('hidden');
      $("icon_bg").classList.remove('hidden');
      $("name_bg").textContent = "No file";
    }
  }
}

function renderBrandPreview() {
  if(!state.config) return;
  const eff = getEffectiveForm(state.target || "visitor_form");

  const headerImg = $("previewHeaderImg");
  const logoImg = $("previewLogoImg");
  const bgImg = $("previewBgImg");
  const titleEl = $("previewTitle");
  const subtitleEl = $("previewSubtitle");
  const taglineEl = $("previewTagline");
  const btn = $("previewBtn");

  const bg = eff.bgUrl ? withCacheBust(eff.bgUrl) : "";
  if(bgImg) bgImg.src = bg || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='900'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%230f172a'/%3E%3Cstop offset='1' stop-color='%23111827'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23g)'/%3E%3C/svg%3E";

  const header = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
  if(headerImg) {
    if(header) headerImg.src = header;
    else {
      const c1 = eff.color1.replace("#","%23");
      const c2 = eff.color2.replace("#","%23");
      headerImg.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='240'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='${c1}'/%3E%3Cstop offset='1' stop-color='${c2}'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23g)'/%3E%3C/svg%3E`;
    }
  }

  const logo = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";
  if(logoImg) logoImg.src = logo || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='100%25' height='100%25' rx='16' fill='%23111827'/%3E%3Ctext x='50%25' y='54%25' font-size='22' text-anchor='middle' fill='%2394a3b8' font-family='Arial'%3ELOGO%3C/text%3E%3C/svg%3E";

  if(titleEl) titleEl.textContent = eff.title || "";
  if(subtitleEl) subtitleEl.textContent = eff.subtitle || "";
  if(taglineEl) taglineEl.textContent = eff.tagline || "";
  if(btn) btn.style.backgroundImage = `linear-gradient(90deg, ${eff.color1}, ${eff.color2})`;

  renderPreviewTabs();
  // renderAllFormsGrid(); // removed (use right preview selector)
}


function buildPreviewSrcDoc(ft) {
  const eff = getEffectiveForm(ft || "visitor_form");
  
  // Use live input values if available, otherwise use saved config
  const title = $("b_title")?.value?.trim() || eff.title || "";
  const subtitle = $("b_subtitle")?.value?.trim() || eff.subtitle || "";
  const tagline = $("b_tagline")?.value?.trim() || eff.tagline || "";
  const c1 = $("b_c1")?.value || eff.color1 || "#f97316";
  const c2 = $("b_c2")?.value || eff.color2 || "#ef4444";
  
  const bg = eff.bgUrl ? withCacheBust(eff.bgUrl) : "";
  const header = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
  const logo = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";

  const rawPrograms =
    eff.form?.program_options ||
    eff.form?.programs ||
    state.config?.defaults?.programs ||
    [];

  const programs = Array.isArray(rawPrograms) ? rawPrograms : [];
  const optionsHtml = programs.slice(0, 40).map(p => `<option>${escHtml(p)}</option>`).join("");

  const headerBlock = header
    ? `<img class="header-img" src="${escHtml(header)}" alt="header" />`
    : `<div class="header-grad"></div>`;

  const logoBlock = logo
    ? `<img class="logo" src="${escHtml(logo)}" alt="logo" />`
    : `<div class="logo ph">LOGO</div>`;

  const bgStyle = bg ? `background-image:url('${escHtml(bg)}');` : "";

  return `<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preview</title>
  <style>
    :root{--c1:${c1};--c2:${c2};}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e5e7eb; background:#0b1220; ${bgStyle} background-size:cover; background-position:center;}
    .overlay{min-height:100vh; background:linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.88));}
    .wrap{max-width:420px;margin:0 auto; padding:14px;}
    .card{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); border-radius:18px; overflow:hidden; box-shadow:0 12px 30px rgba(0,0,0,.35);}
    .header{position:relative;height:150px; overflow:hidden;}
    .header-img{width:100%;height:100%;object-fit:cover;display:block;}
    .header-grad{width:100%;height:100%; background:linear-gradient(135deg,var(--c1),var(--c2));}
    .logo{position:absolute;left:14px;bottom:-26px;width:58px;height:58px;border-radius:16px;border:2px solid rgba(255,255,255,.35); background:rgba(2,6,23,.7); object-fit:cover; box-shadow:0 10px 18px rgba(0,0,0,.35);}
    .logo.ph{display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#94a3b8;}
    .content{padding:44px 14px 16px;}
    .title{font-size:18px;font-weight:800;line-height:1.2;margin:0;}
    .sub{margin:6px 0 0 0;font-size:12px;color:#cbd5e1;}
    .tag{margin:6px 0 0 0;font-size:11px;color:#94a3b8;}
    .field{margin-top:12px;}
    label{display:block;font-size:11px;color:#cbd5e1;margin-bottom:6px;}
    input,select{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.14); background:rgba(2,6,23,.55); color:#e5e7eb; padding:12px 12px; outline:none;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .btn{margin-top:14px;width:100%;border:none;border-radius:14px;padding:12px 14px;font-weight:800;color:white; cursor:pointer;background:linear-gradient(90deg,var(--c1),var(--c2));}
    .note{margin-top:10px;font-size:10px;color:#64748b;text-align:center;}
  </style>
</head>
<body>
  <div class="overlay">
    <div class="wrap">
      <div class="card">
        <div class="header">
          ${headerBlock}
          ${logoBlock}
        </div>
        <div class="content">
          <h1 class="title">${escHtml(title)}</h1>
          ${subtitle ? `<div class="sub">${escHtml(subtitle)}</div>` : ``}
          ${tagline ? `<div class="tag">${escHtml(tagline)}</div>` : ``}

          <div class="field">
            <label>‡§®‡§æ‡§Æ / Name</label>
            <input placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç" />
          </div>

          <div class="row">
            <div class="field">
              <label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
              <input placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ" />
            </div>
            <div class="field">
              <label>‡§ú‡§ø‡§≤‡§æ</label>
              <input placeholder="‡§ú‡§ø‡§≤‡§æ" />
            </div>
          </div>

          ${optionsHtml ? `
          <div class="field">
            <label>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ / Program</label>
            <select>
              <option value="">Select</option>
              ${optionsHtml}
            </select>
          </div>` : ``}

          <div class="field">
            <label>‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä</label>
            <input placeholder="Optional" />
          </div>

          <button class="btn">Submit</button>
          <div class="note">Admin Preview ‚Ä¢ Live Branding</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>`;
}

function renderFormPreviewIframe() {
  const iframe = $("formPreviewIframe");
  if(!iframe) return;
  const doc = buildPreviewSrcDoc(state.target || "visitor_form");
  state.lastPreviewDoc = doc;
  iframe.srcdoc = doc;
}

function openCurrentPreviewInNewTab() {
  const doc = state.lastPreviewDoc || buildPreviewSrcDoc(state.target || "visitor_form");
  const blob = new Blob([doc], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank", "noopener");
  setTimeout(() => URL.revokeObjectURL(url), 60_000);
}


  function renderPreviewTabs(){
    const tabsEl = document.getElementById("previewTabs");
    const selEl = document.getElementById("previewTargetSelect");
    if(!tabsEl) return;

    const cfg = state.config || {};
    const formsNode = cfg.forms || {};
    const formKeys = Object.keys(formsNode);

    tabsEl.innerHTML = "";
    if(selEl) selEl.innerHTML = "";

    // Fallback list if config hasn't loaded yet
    const keys = (formKeys && formKeys.length) ? formKeys : Object.keys(FORM_META || {});
    keys.forEach((k)=>{
      // tabs
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "px-3 py-1.5 rounded-full text-sm border transition " + (k===state.target
        ? "bg-white text-slate-900 border-white"
        : "bg-white/5 text-white border-white/10 hover:bg-white/10");
      btn.textContent = (FORM_META[k] && FORM_META[k].label) ? FORM_META[k].label : k;
      btn.addEventListener("click", ()=>{
        if(k === state.target) return;
        state.target = k;
        renderPreviewTabs();
        renderFormPreviewIframe();
        renderBrandPreview();
      });
      tabsEl.appendChild(btn);

      // select
      if(selEl){
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = btn.textContent;
        if(k===state.target) opt.selected = true;
        selEl.appendChild(opt);
      }
    });

    if(selEl && !selEl.__wired){
      selEl.__wired = true;
      selEl.addEventListener("change", (e)=>{
        const v = e.target.value;
        if(v && v !== state.target){
          state.target = v;
          renderPreviewTabs();
          renderFormPreviewIframe();
          renderBrandPreview();
        }
      });
    }
  }


function collectBrandFromUI() {
  return {
    color1: $("b_c1")?.value || "#f97316",
    color2: $("b_c2")?.value || "#ef4444"
  };
}

function renderAllFormsGrid() {
  const grid = $("allFormsGrid");
  if(!grid || !state.config) return;

  const forms = state.config.forms || {};
  const keys = Object.keys(forms);

  grid.innerHTML = "";

  const addCard = (ft, eff) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "text-left rounded-2xl overflow-hidden border " + (ft === state.target
      ? "border-white/25 bg-white/10"
      : "border-white/10 bg-white/5 hover:bg-white/10");

    const header = eff.headerUrl ? withCacheBust(eff.headerUrl) : "";
    const logo = eff.logoUrl ? withCacheBust(eff.logoUrl) : "";

    const headerEl = header
      ? `<img src="${escHtml(header)}" class="w-full h-24 object-cover" />`
      : `<div class="w-full h-24" style="background:linear-gradient(135deg,${escHtml(eff.color1)},${escHtml(eff.color2)})"></div>`;

    const logoEl = logo
      ? `<img src="${escHtml(logo)}" class="w-10 h-10 rounded-xl object-cover border border-white/25 bg-slate-900" />`
      : `<div class="w-10 h-10 rounded-xl flex items-center justify-center text-[10px] font-extrabold border border-white/15 bg-slate-900 text-slate-400">LOGO</div>`;

    btn.innerHTML = `
      ${headerEl}
      <div class="p-3">
        <div class="flex items-start gap-3">
          ${logoEl}
          <div class="min-w-0">
            <div class="font-bold text-slate-100 truncate">${escHtml(eff.title || ft)}</div>
            <div class="text-xs text-slate-400 truncate">${escHtml(eff.subtitle || ft)}</div>
          </div>
        </div>
        <div class="mt-3">
          <div class="h-2 rounded-full" style="background:linear-gradient(90deg,${escHtml(eff.color1)},${escHtml(eff.color2)})"></div>
        </div>
      </div>
    `;

    btn.addEventListener("click", () => {
      state.target = ft;
      const sel = $("targetFormSel");
      if(sel) sel.value = ft;
      renderAll();
      renderFormPreviewIframe();
      renderBrandPreview();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    grid.appendChild(btn);
  };

  // Defaults card
  addCard("__defaults__", getEffectiveForm("__defaults__"));

  keys.forEach(ft => addCard(ft, getEffectiveForm(ft)));
}

function setPending(key, file) {
    if(!file) {
      // Clear the asset
      if(state.pendingAssets[state.target]?.[key]) {
        delete state.pendingAssets[state.target][key];
      }
      $(`prev_${key}`).src = "";
      $(`prev_${key}`).classList.add('hidden');
      $(`icon_${key}`).classList.remove('hidden');
      $(`name_${key}`).textContent = "No file";
      renderBrandPreview();
      renderFormPreviewIframe();
      return;
    }
    
    if(!state.pendingAssets[state.target]) state.pendingAssets[state.target] = {};
    state.pendingAssets[state.target][key] = { file, previewUrl: URL.createObjectURL(file) };
    $(`name_${key}`).textContent = file.name;
    
    // Immediate preview in thumbnail
    $(`prev_${key}`).src = URL.createObjectURL(file);
    $(`prev_${key}`).classList.remove('hidden');
    $(`icon_${key}`).classList.add('hidden');
    
    renderBrandPreview();
    renderFormPreviewIframe();
  }

  // --- API Calls (Restored Robust Logic) ---
  async function apiCall(action, payload){
    let idToken = getIdToken();
    
    const doFetch = async (token) => {
        return await fetch(FORMS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ action, payload })
        });
    };

    if (!idToken) {
       console.warn("No ID token found in storage.");
    }

    let resp = await doFetch(idToken || "");
    
    // Auto-recover from 401 using custom Modal
    if (resp.status === 401) {
        openAuthModal();
        throw new Error("Unauthorized: Session Expired. Use the Key icon to update token.");
    }
    
    const txt = await resp.text();
    let json = {};
    try { json = JSON.parse(txt); } catch(e) { json = { message: txt || "Invalid JSON" }; }
    
    if (!resp.ok) throw new Error(json.message || json.error || `HTTP ${resp.status}`);
    return json;
  }
  
  async function apiCallCandidates(actions, payload){
    let lastErr = null;
    for (const a of actions){
      try { return await apiCall(a, payload); } catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("API call failed");
  }

  async function initAssetUpload(assetKind, ft, file){
    const sha = await sha256Hex(file);
    const fileName = `${crypto.randomUUID()}.${extFromMime(file.type)}`;
    const payload = { collection_id: state.cid, form_type: ft === "__defaults__" ? "visitor_form" : ft, asset_kind: assetKind, sha256: sha, file_name: fileName, mime_type: file.type };
    const res = await apiCallCandidates(["admin_init_asset_upload","admin_init_upload_asset","init_asset_upload"], payload);
    const uploadUrl = res.upload_url || res.url;
    if (!uploadUrl) return null;
    await fetch(uploadUrl, { method:"PUT", body: file, headers: { "Content-Type": file.type } });
    const publicUrl = res.public_url || res.asset_url || res.url_public || "";
    const key = res.s3_key || res.asset_key || res.key || "";
    return { kind: "s3", value: publicUrl || key || "" };
  }

  async function saveConfig() {
    if(!state.cid) { showToast("CID missing","error"); return; }
    if(!state.config) { showToast("Config not loaded","error"); return; }

    const btn = $("btnSave");
    const toast = showToast("Saving...","info",0);
    if(btn){ btn.disabled = true; btn.textContent = "Saving..."; }

    try {
      const ft = state.target || "visitor_form";

      // FIRST: Upload pending assets if any
      const pending = state.pendingAssets?.[ft] || {};
      const assetRefs = {};
      
      if(pending.logo?.file) {
        showToast("Uploading logo...", "info");
        const ref = await initAssetUpload("logo", ft, pending.logo.file);
        if(ref) assetRefs.logo = ref;
      }
      
      if(pending.header?.file) {
        showToast("Uploading header...", "info");
        const ref = await initAssetUpload("header", ft, pending.header.file);
        if(ref) assetRefs.header = ref;
      }
      
      if(pending.background?.file) {
        showToast("Uploading background...", "info");
        const ref = await initAssetUpload("background", ft, pending.background.file);
        if(ref) assetRefs.bg = ref;
      }

      // Users expect Title/Sub/Tagline to change the actual form heading.
      const meta = {
        title: ($("b_title")?.value || "").trim(),
        subtitle: ($("b_subtitle")?.value || "").trim(),
        tagline: ($("b_tagline")?.value || "").trim(),
      };

      const brand = collectBrandFromUI();
      
      // Merge uploaded assets into branding
      if(assetRefs.logo) brand.logo = assetRefs.logo;
      if(assetRefs.header) brand.header = assetRefs.header;
      if(assetRefs.bg) brand.background = assetRefs.bg;

      // Apply local changes into state.config
      state.config.defaults = state.config.defaults || {};
      state.config.defaults.branding = state.config.defaults.branding || {};
      state.config.forms = state.config.forms || {};

      if(ft === "__defaults__") {
        state.config.defaults.branding = deepMerge(state.config.defaults.branding, brand);
        if(meta.title) state.config.defaults.branding.title = meta.title;
        if(meta.subtitle) state.config.defaults.branding.subtitle = meta.subtitle;
        if(meta.tagline) state.config.defaults.branding.tagline = meta.tagline;

        state.config.global = state.config.global || {};
        if(meta.tagline) state.config.global.tagline = meta.tagline;
      } else {
        const f = state.config.forms[ft] || (state.config.forms[ft] = {});
        f.title = meta.title || f.title || "";
        f.subtitle = meta.subtitle || f.subtitle || "";
        f.tagline = meta.tagline || f.tagline || "";

        f.branding = deepMerge(f.branding || {}, brand);
      }

      // Save to backend (political module)
      await apiCall("admin_save_config", {
        collection_id: state.cid,
        config_type: "political_forms",
        config: state.config
      });

      toast.remove?.();
      showToast("‚úÖ Saved successfully!","success");
      
      // Clear pending for this form (uploaded already)
      if(state.pendingAssets?.[ft]) delete state.pendingAssets[ft];

      // Refresh from backend to get latest signed URLs (logo_url/header_url/background_url)
      await loadConfig();

    } catch(e) {
      console.error("Save failed:", e);
      toast.remove?.();
      showToast("‚ùå Save failed: " + (e?.message || e),"error");
    } finally {
      if(btn){ btn.disabled = false; btn.textContent = "Save Config"; }
      state.cacheBust = Date.now();
      renderBrandInputsFromConfig();
      renderAll();
      renderFormPreviewIframe();
    }
  }

  async function loadConfig() {
     if(!state.cid) { $('cidPill').classList.add('hidden'); return; }
     $('cidPill').classList.remove('hidden');
     $('cidVal').textContent = state.cid;

     const t = showToast("Loading configuration...", "loading");
     let cfg = null;
     try {
        // EXACT payload user said works (no config_type for GET)
        const res = await apiCallCandidates(["admin_get_config","admin_get_settings","get_admin_config"], { 
            collection_id: state.cid,
            form_type: "visitor_form" 
        });
        cfg = res.config || res.data || res.item || null;
     } catch(e) {}
     
     if (!cfg){
        const local = localStorage.getItem(`EL_CFG_${state.cid}`);
        if(local) try{ cfg = JSON.parse(local); }catch(e){}
     }

     if (cfg) state.config = deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), cfg);
     t.remove();
     renderAll();
  }

  // --- Rendering & Logic ---
  function renderAll() {
     renderBrandPreview();
     renderPrograms();
     renderLevels();
  }

  function renderPrograms() {
     const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
     const scope = $('progScopeSel').value;
     let list = [];
     
     if(scope === 'defaults') list = state.config.defaults.programs || [];
     else {
        // If specific form
        const specific = state.config.forms[ft]?.programs;
        list = specific || state.config.defaults.programs || []; 
     }

     const container = $('progList');
     container.innerHTML = '';
     list.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = "flex items-center justify-between bg-slate-900/50 border border-slate-800 rounded-lg px-3 py-2";
        el.innerHTML = `<span class="text-sm font-medium text-slate-300 truncate">${p}</span> 
                        <button class="text-slate-500 hover:text-red-400 p-1" onclick="deleteProg(${idx})"><i class="fa-solid fa-trash"></i></button>`;
        container.appendChild(el);
     });
     
     window.deleteProg = (idx) => {
         const newList = [...list];
         newList.splice(idx, 1);
         if(scope === 'defaults') state.config.defaults.programs = newList;
         else {
             ensureFormObj(ft);
             state.config.forms[ft].programs = newList;
         }
         renderPrograms();
     };
  }
  
  function renderLevels() {
      const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
      const src = (ft === "__defaults__") ? state.config.defaults.fixed_levels : (state.config.forms[ft]?.fixed_levels || state.config.defaults.fixed_levels);
      
      $('lvl_mandal_reporting').value = src?.mandal_reporting || "";
      $('lvl_coordinator').value = src?.coordinator || "";
      $('lvl_program_info').value = src?.program_info || "";
  }

  // --- Data Loading (Restored Real Logic) ---
  function normalizeItem(it){
    const payload = it.payload || it.data || it.fields || {};
    const createdAt = it.created_at || it.createdAt || it.ts || 0;
    const ft = it.form_type || it.formType || payload.form_type || "";
    return {
      entry_id: it.entry_id || it.id || "",
      created_at: createdAt,
      form_type: ft,
      payload,
      mobile: payload.mobile || payload.phone || "",
      name: payload.name || payload.full_name || "",
      district: payload.district || "",
      program_name: payload.program_name || payload.program || payload.karyakram || ""
    };
  }
  function dateKeyFromMs(ms){
    if (!ms) return "";
    const x = new Date(Number(ms));
    return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;
  }

  async function loadData(direction="fresh") {
     if(!state.cid) return showToast("CID Required", "error");
     const t = showToast("Fetching records...", "loading");
     
     let next_token = null;
     if (direction === "next") next_token = state.nextToken || null;
     if (direction === "prev"){ const prev = state.prevStack.pop() || null; next_token = prev; }

     const payload = {
       collection_id: state.cid,
       form_type: $('dataFormSel').value,
       filters: { q: ($('dataSearch').value||"").trim(), date_from: $('dateFrom').value||"", date_to: $('dateTo').value||"" },
       limit: 200,
       next_token
     };

     let res = null;
     try{
       res = await apiCallCandidates(["admin_list_entries","admin_query_entries","list_entries_admin","admin_list_data"], payload);
       state.allItems = (res.items || res.data || res.rows || []).map(normalizeItem);
       state.nextToken = res.next_token || res.nextToken || null;
       try{ localStorage.setItem(`EL_POLITICAL_DATA_CACHE::${state.cid}`, JSON.stringify(state.allItems)); }catch(_){}
       t.remove(); showToast(`Loaded ${state.allItems.length} items`, "success");
     } catch(e){
        // Cache fallback
        try{
            const raw = localStorage.getItem(`EL_POLITICAL_DATA_CACHE::${state.cid}`);
            if(raw){ state.allItems = JSON.parse(raw).map(normalizeItem); t.remove(); showToast("Loaded from cache (Offline)", "info"); }
            else { t.remove(); showToast("Failed to load data", "error"); }
        }catch(_){ t.remove(); showToast("Failed to load data", "error"); }
     }
     
     state.viewItems = state.allItems; 
     renderTable();
     updateStats();
  }

  function renderTable() {
      const tbody = $('dataTbody');
      tbody.innerHTML = '';
      $('loadedCount').textContent = state.viewItems.length;

      state.viewItems.slice(0, 50).forEach(item => {
          const row = document.createElement('tr');
          row.className = "hover:bg-slate-800/30 transition-colors border-b border-slate-800/50";
          row.innerHTML = `
             <td class="px-4 py-3 text-slate-400 font-mono text-xs">${new Date(item.created_at).toLocaleDateString()}</td>
             <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] bg-slate-800 border border-slate-700 text-slate-300">${item.form_type}</span></td>
             <td class="px-4 py-3 text-white font-mono text-xs">${item.payload.mobile || '-'}</td>
             <td class="px-4 py-3 text-white font-medium">${item.payload.name || '-'}</td>
             <td class="px-4 py-3 text-slate-400">${item.payload.district || '-'}</td>
             <td class="px-4 py-3">
                <button class="text-orange-500 hover:text-orange-400 text-xs font-bold" onclick='openModal(${JSON.stringify(item)})'>View</button>
             </td>
          `;
          tbody.appendChild(row);
      });
  }

  function updateStats() {
      $('kpiTotal').textContent = state.allItems.length;
      $('kpiUnique').textContent = new Set(state.allItems.map(i => i.payload.mobile)).size;
      buildCharts();
  }

  window.openModal = (item) => {
      $('modal').classList.remove('hidden');
      $('modal').classList.add('flex');
      $('modalJson').textContent = JSON.stringify(item, null, 2);
  };
  $('btnCloseModal').onclick = () => { $('modal').classList.add('hidden'); $('modal').classList.remove('flex'); };
  $('modalBackdrop').onclick = $('btnCloseModal').onclick;

  // Auth Button Handlers
  $('btnAuth').onclick = openAuthModal;
  $('btnCancelAuth').onclick = () => { $('authModal').classList.remove('flex'); $('authModal').classList.add('hidden'); };
  $('btnSaveAuth').onclick = () => {
      const t = $('authTokenInput').value.trim();
      if(t) {
          localStorage.setItem("id_token", t);
          showToast("Token updated! Reloading...", "success");
          setTimeout(() => location.reload(), 800);
      }
  };

  // --- Charts ---
  function buildCharts() {
     const items = state.viewItems.length ? state.viewItems : state.allItems;

     const byForm = {}; items.forEach(x=>{ const k=x.form_type||"unknown"; byForm[k]=(byForm[k]||0)+1; });
     const formLabels = Object.keys(byForm); const formVals = formLabels.map(k=>byForm[k]);

     const dayMap = {}; items.forEach(x=>{ const k=dateKeyFromMs(x.created_at); if(!k) return; dayMap[k]=(dayMap[k]||0)+1; });
     const days = Object.keys(dayMap).sort(); const last14 = days.slice(-14); const dayVals = last14.map(k=>dayMap[k]);

     const dist = {}; items.forEach(x=>{ const k=(x.district||"").trim()||"Unknown"; dist[k]=(dist[k]||0)+1; });
     const distPairs = Object.entries(dist).sort((a,b)=>b[1]-a[1]).slice(0,10);
     const distLabels = distPairs.map(p=>p[0]); const distVals = distPairs.map(p=>p[1]);

     if(state.charts.byDay) state.charts.byDay.destroy();
     if(state.charts.byForm) state.charts.byForm.destroy();
     if(state.charts.district) state.charts.district.destroy();

     const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: { display: false }, y: { display: false } } };

     state.charts.byDay = new Chart($('chartByDay'), { type: 'line', data: { labels: last14, datasets: [{ data: dayVals, borderColor: '#f97316', tension: 0.4 }] }, options: common });
     state.charts.byForm = new Chart($('chartByForm'), { type: 'bar', data: { labels: formLabels, datasets: [{ data: formVals, backgroundColor: '#3b82f6' }] }, options: common });
     state.charts.district = new Chart($('chartDistrict'), { type: 'bar', data: { labels: distLabels, datasets: [{ data: distVals, backgroundColor: '#a855f7' }] }, options: common });
  }

  // --- Event Listeners ---
  $('btnSave').onclick = saveConfig;
  
  // Branding buttons
  if($('btnResetBrand')) {
    $('btnResetBrand').onclick = () => {
      if(confirm('Reset branding to defaults?')) {
        $('b_title').value = "";
        $('b_subtitle').value = "";
        $('b_tagline').value = "";
        $('b_c1').value = "#f97316";
        $('b_c2').value = "#ef4444";
        renderFormPreviewIframe();
        renderBrandPreview();
        showToast("Branding reset", "info");
      }
    };
  }
  
  if($('btnCopyToDefaults')) {
    $('btnCopyToDefaults').onclick = async () => {
      if(!confirm('Copy current branding to all forms as defaults?')) return;
      
      const brand = collectBrandFromUI();
      const meta = {
        title: $('b_title').value.trim(),
        subtitle: $('b_subtitle').value.trim(),
        tagline: $('b_tagline').value.trim()
      };
      
      // Copy to defaults
      state.config.defaults.branding = deepMerge(state.config.defaults.branding || {}, brand);
      if(meta.title) state.config.defaults.branding.title = meta.title;
      if(meta.subtitle) state.config.defaults.branding.subtitle = meta.subtitle;
      if(meta.tagline) state.config.defaults.branding.tagline = meta.tagline;
      
      showToast("‚úÖ Copied to defaults! Click Save to apply.", "success");
    };
  }

  // Preview controls
  if($('btnLoadFormPreview')) $('btnLoadFormPreview').onclick = () => { state.cacheBust = Date.now(); renderBrandPreview(); renderFormPreviewIframe(); };
  if($('btnOpenFormPreview')) $('btnOpenFormPreview').onclick = () => { state.cacheBust = Date.now(); openCurrentPreviewInNewTab(); };
  if($('btnRefreshSignedUrls')) $('btnRefreshSignedUrls').onclick = () => { state.cacheBust = Date.now(); loadConfig(); };
  $('btnReload').onclick = loadConfig;
  $('btnApplyCid').onclick = () => { state.cid = $('cidInput').value; loadConfig(); };
  
  // Tab Switching
  document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.onclick = () => {
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
          $(`tab-${btn.dataset.tab}`).classList.remove('hidden');
      };
  });

  // Target Change
  $('targetFormSel').onchange = () => {
      state.target = $('targetFormSel').value;
      renderBrandInputsFromConfig();
      renderAll();
      renderFormPreviewIframe();
  };

  // Asset Inputs
  ['logo','header','bg'].forEach(k => {
     $(`file_${k}`).onchange = (e) => { if(e.target.files[0]) setPending(k, e.target.files[0]); };
     const clearBtn = document.querySelector(`[data-clear="${k}"]`);
     if(clearBtn) clearBtn.onclick = (e) => { e.stopPropagation(); $(`file_${k}`).value = ""; setPending(k, null); renderBrandPreview(); };
  });

  // Input Live Sync
  const livePreviewToggle = $('livePreviewToggle');
  const updatePreviewLive = () => {
    if(livePreviewToggle?.checked) {
      renderFormPreviewIframe();
    }
    renderBrandPreview();
  };
  
  ['input','change'].forEach(ev => {
      $('b_title').addEventListener(ev, updatePreviewLive);
      $('b_subtitle').addEventListener(ev, updatePreviewLive);
      $('b_tagline').addEventListener(ev, updatePreviewLive);
      $('b_c1').addEventListener(ev, updatePreviewLive);
      $('b_c2').addEventListener(ev, updatePreviewLive);
  });

  $('btnAddProg').onclick = () => {
      const v = $('progInput').value.trim();
      if(!v) return;
      const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
      const scope = $('progScopeSel').value;
      if(scope === 'defaults') {
          state.config.defaults.programs = [v, ...(state.config.defaults.programs||[])];
      } else {
          ensureFormObj(ft);
          state.config.forms[ft].programs = [v, ...(state.config.forms[ft].programs||[])];
      }
      $('progInput').value = "";
      renderPrograms();
      showToast("Program Added", "success");
  };

  $('btnLoadData').onclick = () => loadData("fresh");
  $('btnApplyFilter').onclick = () => loadData("fresh");
  $('btnNextPage').onclick = () => loadData("next");
  $('btnPrevPage').onclick = () => loadData("prev");
  $('btnExportCsv').onclick = () => {
     const csvContent = "data:text/csv;charset=utf-8," + state.allItems.map(e => Object.values(e.payload).join(",")).join("\n");
     const encodedUri = encodeURI(csvContent);
     const link = document.createElement("a");
     link.setAttribute("href", encodedUri);
     link.setAttribute("download", "data.csv");
     document.body.appendChild(link);
     link.click();
  };

  // Init
  loadConfig();
  renderFormPreviewIframe();

})();
</script>
</body>
</html>
