<!DOCTYPE html>
<html lang="hi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Political Admin Console Pro - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: { 
            brand: { 500: '#f97316', 600: '#ea580c' }, 
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } 
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.4s ease-out forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #020617;
      background-image: 
        radial-gradient(at 0% 0%, rgba(249, 115, 22, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(56, 189, 248, 0.10) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(249, 115, 22, 0.05) 0px, transparent 50%);
      background-attachment: fixed;
      color: #e2e8f0;
    }
    
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .glass-header {
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .input-field {
      background: rgba(2, 6, 23, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      transition: all 0.2s;
    }
    .input-field:focus {
      outline: none;
      border-color: #f97316;
      background: rgba(2, 6, 23, 0.7);
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
    }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    .phone-mockup {
      border: 12px solid #1e293b;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #000;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .phone-mockup::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 24px;
      background: #1e293b;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      z-index: 10;
    }

    .nav-btn {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .nav-btn.active {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
      border-left-color: #f97316;
      color: #fff;
    }
    .nav-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(10px);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top: 3px solid #f97316;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="min-h-screen font-sans selection:bg-orange-500/30">

  <div id="toastContainer" class="toast-container"></div>

  <nav class="sticky top-0 z-50 glass-header h-16">
    <div class="max-w-[1600px] mx-auto px-4 h-full">
      <div class="flex items-center justify-between h-full gap-4">
        
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white shadow-lg shadow-orange-500/20 ring-1 ring-white/10">
            <i class="fa-solid fa-om"></i>
          </div>
          <div>
            <div class="text-white font-extrabold tracking-tight text-lg leading-none">EventLens <span class="text-orange-500">Pro</span></div>
            <div class="text-[10px] text-slate-400 font-semibold uppercase tracking-wider mt-1">Political Admin Console</div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div id="cidPill" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/60 border border-slate-800 text-xs font-mono text-slate-300">
            <i class="fa-solid fa-database text-emerald-500"></i>
            <span id="cidVal" class="font-bold text-white tracking-wide"></span>
          </div>

          <div class="h-6 w-px bg-slate-800 mx-1"></div>

          <button id="btnReload" class="group px-3 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 text-slate-300 hover:text-white transition-colors border border-transparent hover:border-slate-700" title="Reload">
            <i class="fa-solid fa-rotate-right text-sm group-hover:rotate-180 transition-transform duration-500"></i>
          </button>

          <button id="btnSave" class="group relative px-5 py-2 rounded-lg bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white text-sm font-bold shadow-lg shadow-orange-600/20 transition-all hover:scale-105 active:scale-95 flex items-center gap-2 overflow-hidden">
            <span class="relative z-10 flex items-center gap-2">
              <i class="fa-solid fa-floppy-disk"></i> Save Changes
            </span>
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-[1600px] mx-auto px-4 py-6">
    <div class="grid lg:grid-cols-12 gap-6 items-start">

      <aside class="lg:col-span-3 space-y-6 sticky top-24">
        
        <div class="glass-panel rounded-2xl p-5 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-chess-rook text-6xl text-orange-500"></i>
          </div>
          
          <div class="text-xs font-bold text-orange-400 uppercase tracking-widest mb-4">Current Context</div>
          
          <div class="space-y-4 relative z-10">
            <div>
              <label class="text-[11px] font-bold text-slate-400 uppercase">Collection ID</label>
              <div class="mt-1 flex gap-2">
                <input id="cidInput" class="input-field w-full rounded-lg px-3 py-2 text-xs font-mono" placeholder="Enter CID..." />
                <button id="btnApplyCid" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold text-white transition-colors" title="Apply CID">
                  <i class="fa-solid fa-check"></i>
                </button>
              </div>
            </div>

            <div>
              <label class="text-[11px] font-bold text-slate-400 uppercase">Edit Target</label>
              <div class="relative mt-1">
                <select id="targetFormSel" class="input-field w-full rounded-lg px-3 py-2.5 text-sm appearance-none cursor-pointer">
                  <option value="__defaults__">üì° Defaults (All Forms)</option>
                  <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                  <option value="visitor_form">üìù Visitor Form</option>
                  <option value="party_attendance">üö© Party Attendance</option>
                  <option value="president_tour">üöô President Tour</option>
                  <option value="mandal_reporting">üìä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó</option>
                  <option value="coordinator">üëî Coordinator</option>
                  <option value="program_info">‚ÑπÔ∏è Program Info</option>
                </select>
                <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs">
                  <i class="fa-solid fa-chevron-down"></i>
                </div>
              </div>
              <div class="text-[10px] text-slate-500 mt-2 leading-relaxed">
                Changes apply to the selected form only unless "Defaults" is chosen.
              </div>
            </div>

            <div class="flex items-center justify-between gap-2 rounded-lg bg-slate-950/40 border border-slate-800 p-3">
              <div>
                <div class="text-xs font-bold text-white">Live Preview</div>
                <div class="text-[10px] text-slate-500">Shows overlay while editing (unsaved)</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input id="livePreviewToggle" type="checkbox" class="sr-only peer" checked>
                <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
              </label>
            </div>
          </div>
        </div>

        <nav class="glass-panel rounded-2xl p-2 space-y-1">
          <button class="nav-btn active w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="branding">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-palette text-orange-400"></i></span>
            Branding & Preview
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="programs">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-list-check text-blue-400"></i></span>
            Program Names
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="levels">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-lock text-rose-400"></i></span>
            Level Locks
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="data">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-table text-emerald-400"></i></span>
            Data Records
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="analytics">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-chart-pie text-purple-400"></i></span>
            Analytics
          </button>
          <button class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold flex items-center gap-3 text-slate-300" data-tab="backend">
            <span class="w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center text-xs"><i class="fa-solid fa-plug text-yellow-400"></i></span>
            API Config
          </button>
        </nav>

        <div class="text-center">
          <p class="text-[10px] text-slate-600">v2.4.0 Pro ‚Ä¢ EventLens System</p>
        </div>
      </aside>

      <div class="lg:col-span-9 min-h-[80vh]">
        
        <section id="tab-branding" class="tab-content animate-fade-in">
          <div class="grid lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 space-y-6">
              <div class="glass-panel rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                   <h2 class="text-xl font-bold text-white flex items-center gap-2">
                     <i class="fa-solid fa-pen-nib text-orange-500"></i> Appearance
                   </h2>
                   <div class="flex gap-2">
                      <button id="btnResetBrand" class="px-3 py-1.5 text-xs font-semibold text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-700 rounded-lg transition-colors">Reset</button>
                      <button id="btnCopyToDefaults" class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded-lg transition-colors">Copy to All</button>
                   </div>
                </div>

                <div class="space-y-4">
                  <div class="grid md:grid-cols-2 gap-4">
                    <div class="group">
                      <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Title / Header</label>
                      <input id="b_title" class="input-field w-full rounded-xl px-4 py-3 text-sm font-bold" placeholder="e.g. ‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞" />
                    </div>
                    <div class="group">
                      <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Subtitle</label>
                      <input id="b_subtitle" class="input-field w-full rounded-xl px-4 py-3 text-sm" placeholder="e.g. ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§" />
                    </div>
                  </div>
                  <div class="group">
                    <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block group-focus-within:text-orange-500 transition-colors">Tagline</label>
                    <input id="b_tagline" class="input-field w-full rounded-xl px-4 py-3 text-sm" placeholder="e.g. ‡§∏‡•á‡§µ‡§æ ‚Ä¢ ‡§∏‡§Ç‡§ó‡§†‡§® ‚Ä¢ ‡§∏‡§Æ‡§∞‡•ç‡§™‡§£" />
                  </div>
                </div>

                <div class="mt-6 p-4 bg-slate-950/30 rounded-xl border border-slate-800/50">
                  <label class="text-xs font-bold text-slate-400 block mb-3">Gradient Theme</label>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <div class="flex items-center gap-3">
                        <input id="b_c1" type="color" class="w-10 h-10 rounded-lg bg-transparent cursor-pointer border-0 p-0" />
                        <div class="text-xs font-mono text-slate-400">Primary</div>
                      </div>
                    </div>
                    <div>
                      <div class="flex items-center gap-3">
                        <input id="b_c2" type="color" class="w-10 h-10 rounded-lg bg-transparent cursor-pointer border-0 p-0" />
                        <div class="text-xs font-mono text-slate-400">Secondary</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">Assets</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="relative group">
                    <input id="file_logo" type="file" accept="image/*" class="hidden" />
                    <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_logo').click()">
                      <img id="prev_logo" class="absolute inset-0 w-full h-full object-contain p-2 hidden z-10" />
                      <i id="icon_logo" class="fa-solid fa-image text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform"></i>
                      <span class="text-[10px] font-bold text-slate-400 group-hover:text-white">Upload Logo</span>
                    </div>
                    <button type="button" class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="logo"><i class="fa-solid fa-xmark text-xs"></i></button>
                    <div id="name_logo" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
                  </div>

                  <div class="relative group">
                    <input id="file_header" type="file" accept="image/*" class="hidden" />
                    <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_header').click()">
                      <img id="prev_header" class="absolute inset-0 w-full h-full object-cover hidden z-10 opacity-60" />
                      <i id="icon_header" class="fa-solid fa-panorama text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform z-0"></i>
                      <span class="text-[10px] font-bold text-slate-400 group-hover:text-white z-20 relative">Upload Header</span>
                    </div>
                    <button type="button" class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="header"><i class="fa-solid fa-xmark text-xs"></i></button>
                    <div id="name_header" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
                  </div>

                  <div class="relative group">
                    <input id="file_bg" type="file" accept="image/*" class="hidden" />
                    <div class="aspect-square rounded-xl bg-slate-900/50 border-2 border-dashed border-slate-700 hover:border-orange-500 hover:bg-slate-800/50 transition-all cursor-pointer flex flex-col items-center justify-center p-4 text-center overflow-hidden" onclick="document.getElementById('file_bg').click()">
                      <img id="prev_bg" class="absolute inset-0 w-full h-full object-cover hidden z-10 opacity-60" />
                      <i id="icon_bg" class="fa-solid fa-mountain-sun text-2xl text-slate-500 mb-2 group-hover:scale-110 transition-transform z-0"></i>
                      <span class="text-[10px] font-bold text-slate-400 group-hover:text-white z-20 relative">Upload BG</span>
                    </div>
                    <button type="button" class="absolute top-2 right-2 z-20 w-6 h-6 rounded-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100" data-clear="bg"><i class="fa-solid fa-xmark text-xs"></i></button>
                    <div id="name_bg" class="text-[10px] text-slate-500 mt-2 truncate text-center">No file</div>
                  </div>
                </div>

                <div class="text-[10px] text-slate-500 mt-4 leading-relaxed">
                  Note: ‡§Ö‡§≠‡•Ä assets demo-mode ‡§Æ‡•á‡§Ç DataURL ‡§¨‡§®‡§æ‡§ï‡§∞ config ‡§Æ‡•á‡§Ç save ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§°‡§º‡§æ image (big size) ‡§°‡§æ‡§≤‡•ã‡§ó‡•á ‡§§‡•ã DynamoDB/Config size limit ‡§≤‡§ó ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§
                </div>
              </div>
            </div>

            <div class="lg:col-span-5">
              <div class="sticky top-28">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Mobile Preview</h3>
                  <div class="flex gap-2">
                     <button id="btnLoadFormPreview" class="px-3 py-1 text-xs rounded-full bg-orange-600 hover:bg-orange-500 text-white font-bold transition-colors"><i class="fa-solid fa-rotate mr-1"></i> Refresh</button>
                     <button id="btnOpenFormPreview" class="px-3 py-1 text-xs rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold transition-colors" title="Open in new tab"><i class="fa-solid fa-up-right-from-square"></i></button>
                  </div>
                </div>

                <div class="flex justify-center">
                  <div class="phone-mockup w-[320px] h-[640px] bg-white">
                    <iframe id="formPreviewIframe" class="w-full h-full bg-white border-0 relative z-10"></iframe>
                    
                    <div id="customPreviewOverlay" class="absolute inset-0 pointer-events-none opacity-0 transition-opacity duration-300 z-20 flex flex-col">
                       <div id="previewHeaderBar" class="h-1 w-full bg-orange-500"></div>
                       <div id="previewBg" class="flex-1 bg-cover bg-center relative">
                         <div class="absolute inset-0 bg-black/65 backdrop-blur-sm"></div>
                         <div class="relative p-6 flex flex-col items-center justify-center h-full text-center">
                            <div id="previewHeaderImgWrap" class="w-full h-32 rounded-lg overflow-hidden mb-4 hidden shadow-lg">
                               <img id="previewHeaderImg" class="w-full h-full object-cover">
                            </div>
                            <img id="previewLogo" class="w-20 h-20 rounded-full object-cover border-4 border-white/10 mb-4 hidden shadow-2xl">
                            <i id="previewLogoIcon" class="fa-solid fa-bolt text-4xl text-orange-500 mb-4"></i>
                            
                            <h2 id="previewTitle" class="text-2xl font-bold text-white mb-1">Title</h2>
                            <p id="previewSubtitle" class="text-sm text-slate-300">Subtitle</p>
                            <p id="previewTagline" class="text-[10px] text-slate-400 mt-2"></p>
                            <div class="mt-6 flex gap-2 justify-center">
                               <div id="sw1" class="w-4 h-4 rounded-full bg-orange-500"></div>
                               <div id="sw2" class="w-4 h-4 rounded-full bg-red-500"></div>
                            </div>
                         </div>
                       </div>
                    </div>
                  </div>
                </div>
                
                <div class="text-center mt-4">
                   <div class="inline-block px-3 py-1 rounded-full bg-slate-900 border border-slate-800 text-[10px] text-slate-500 font-mono">
                     <span id="formPreviewUrlTxt" class="max-w-[200px] truncate block">...</span>
                   </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Programs / Levels / Data / Analytics / Backend sections are same as before... -->
        <!-- (‡§Æ‡•à‡§Ç‡§®‡•á ‡§á‡§® sections ‡§ï‡•ã same ‡§∞‡§ñ‡§æ ‡§π‡•à, only JS ‡§Æ‡•á‡§Ç fix + Data real backend) -->

        <section id="tab-programs" class="tab-content hidden animate-fade-in space-y-6">
          <div class="glass-panel rounded-2xl p-6">
             <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                   <h2 class="text-xl font-bold text-white">Program Management</h2>
                   <p class="text-sm text-slate-400">Manage the list of programs available in dropdowns.</p>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-slate-800">
                   <span class="text-xs font-bold text-slate-400 px-2">Mode:</span>
                   <select id="progScopeSel" class="bg-transparent text-xs text-white font-bold py-1 pr-2 outline-none">
                      <option value="current">Current Form Only</option>
                      <option value="defaults">Defaults (Global)</option>
                   </select>
                </div>
             </div>

             <div class="flex gap-2 mb-8">
                <input id="progInput" class="input-field flex-1 rounded-xl px-4 py-3 text-sm" placeholder="Type new program name (e.g. ‡§¨‡•Ç‡§• ‡§µ‡§ø‡§ú‡§Ø ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®)..." />
                <button id="btnAddProg" class="px-6 py-3 rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-bold shadow-lg shadow-orange-600/20 transition-all active:scale-95">
                   <i class="fa-solid fa-plus"></i> Add
                </button>
             </div>

             <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="progList"></div>
          </div>
        </section>

        <section id="tab-levels" class="tab-content hidden animate-fade-in space-y-6">
          <div class="glass-panel rounded-2xl p-6">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Hierarchical Locks</h2>
                <select id="levelScopeSel" class="input-field rounded-lg px-3 py-1.5 text-xs">
                   <option value="current">Current Form</option>
                   <option value="defaults">Defaults</option>
                </select>
             </div>
             <div class="grid md:grid-cols-3 gap-6">
                <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
                   <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-sitemap"></i></div>
                      <div class="font-bold text-white text-sm">Reporting Level</div>
                   </div>
                   <select id="lvl_mandal_reporting" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                      <option value="">üîì Unlocked</option>
                      <option value="district">District Fixed</option>
                      <option value="vidhansabha">Vidhan Sabha Fixed</option>
                      <option value="mandal">Mandal Fixed</option>
                   </select>
                </div>

                <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
                   <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 rounded-lg bg-purple-500/20 text-purple-400 flex items-center justify-center"><i class="fa-solid fa-user-tie"></i></div>
                      <div class="font-bold text-white text-sm">Coordinator</div>
                   </div>
                   <select id="lvl_coordinator" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                      <option value="">üîì Unlocked</option>
                      <option value="district">District Fixed</option>
                      <option value="vidhansabha">Vidhan Sabha Fixed</option>
                      <option value="mandal">Mandal Fixed</option>
                   </select>
                </div>

                <div class="p-5 rounded-2xl bg-slate-950/40 border border-slate-800 hover:border-slate-700 transition-colors">
                   <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 rounded-lg bg-emerald-500/20 text-emerald-400 flex items-center justify-center"><i class="fa-solid fa-info"></i></div>
                      <div class="font-bold text-white text-sm">Program Info</div>
                   </div>
                   <select id="lvl_program_info" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                      <option value="">üîì Unlocked</option>
                      <option value="district">District Fixed</option>
                      <option value="vidhansabha">Vidhan Sabha Fixed</option>
                      <option value="mandal">Mandal Fixed</option>
                   </select>
                </div>
             </div>
          </div>
        </section>

        <section id="tab-data" class="tab-content hidden animate-fade-in space-y-6">
          <div class="glass-panel rounded-2xl p-6">
             <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
                <div class="col-span-2 lg:col-span-2">
                   <input id="dataSearch" class="input-field w-full rounded-xl px-4 py-2.5 text-sm" placeholder="Search name, mobile..." />
                </div>
                <div class="col-span-1 lg:col-span-1">
                   <select id="dataFormSel" class="input-field w-full rounded-xl px-3 py-2.5 text-sm">
                      <option value="__all__">All Forms</option>
                      <option value="visitor_form">Visitor</option>
                      <option value="party_attendance">Attendance</option>
                      <option value="president_tour">Tour</option>
                      <option value="mandal_reporting">Reporting</option>
                      <option value="coordinator">Coordinator</option>
                      <option value="program_info">Program Info</option>
                   </select>
                </div>
                <div class="col-span-1">
                   <input id="dateFrom" type="date" class="input-field w-full rounded-xl px-3 py-2.5 text-sm" />
                </div>
                <div class="col-span-1">
                   <input id="dateTo" type="date" class="input-field w-full rounded-xl px-3 py-2.5 text-sm" />
                </div>
                <div class="col-span-1">
                   <button id="btnApplyFilter" class="w-full h-full rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-bold text-sm transition-colors border border-slate-700">Filter</button>
                </div>
             </div>

             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                   <div class="text-[10px] text-slate-500 font-bold uppercase">Total Entries</div>
                   <div id="kpiTotal" class="text-2xl font-extrabold text-white mt-1">0</div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                   <div class="text-[10px] text-slate-500 font-bold uppercase">Today</div>
                   <div id="kpiToday" class="text-2xl font-extrabold text-orange-500 mt-1">0</div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                   <div class="text-[10px] text-slate-500 font-bold uppercase">Unique Mobiles</div>
                   <div id="kpiUnique" class="text-2xl font-extrabold text-blue-400 mt-1">0</div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800">
                    <div class="flex gap-2 mt-2">
                       <button id="btnLoadData" class="flex-1 py-1.5 rounded-lg bg-orange-600/20 text-orange-500 hover:bg-orange-600 hover:text-white text-xs font-bold transition-all">Load</button>
                       <button id="btnExportCsv" class="flex-1 py-1.5 rounded-lg bg-slate-800 text-slate-300 hover:text-white text-xs font-bold transition-all"><i class="fa-solid fa-download"></i> CSV</button>
                    </div>
                 </div>
             </div>

             <div class="rounded-xl border border-slate-800 overflow-hidden bg-slate-950/20">
                <div class="overflow-x-auto">
                   <table class="w-full text-sm text-left">
                      <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-bold">
                         <tr>
                            <th class="px-4 py-3 cursor-pointer hover:text-white" data-sort="created_at">Time <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="px-4 py-3">Form</th>
                            <th class="px-4 py-3 cursor-pointer hover:text-white" data-sort="mobile">Mobile <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3 cursor-pointer hover:text-white" data-sort="district">District <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="px-4 py-3">Action</th>
                         </tr>
                      </thead>
                      <tbody id="dataTbody" class="divide-y divide-slate-800 text-slate-300">
                         <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500 italic">Click "Load" to fetch data</td></tr>
                      </tbody>
                   </table>
                </div>
                <div class="bg-slate-900/80 px-4 py-2 flex justify-between items-center border-t border-slate-800">
                   <div class="text-xs text-slate-500">Showing <span id="loadedCount" class="text-white font-bold">0</span> records</div>
                   <div class="flex gap-2">
                      <button id="btnPrevPage" class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs text-white disabled:opacity-50" disabled>Prev</button>
                      <button id="btnNextPage" class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs text-white disabled:opacity-50" disabled>Next</button>
                   </div>
                </div>
             </div>
          </div>
        </section>

        <section id="tab-analytics" class="tab-content hidden animate-fade-in space-y-6">
          <div class="flex justify-end">
             <button id="btnRefreshCharts" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-xs font-bold text-white transition-colors border border-slate-700"><i class="fa-solid fa-rotate mr-2"></i>Refresh Charts</button>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
             <div class="glass-panel p-5 rounded-2xl">
                <h4 class="text-sm font-bold text-slate-300 mb-4">Submission Trends (14 Days)</h4>
                <div class="h-[250px]"><canvas id="chartByDay"></canvas></div>
             </div>
             <div class="glass-panel p-5 rounded-2xl">
                <h4 class="text-sm font-bold text-slate-300 mb-4">By Form Type</h4>
                <div class="h-[250px]"><canvas id="chartByForm"></canvas></div>
             </div>
             <div class="glass-panel p-5 rounded-2xl md:col-span-2">
                <h4 class="text-sm font-bold text-slate-300 mb-4">Top Districts</h4>
                <div class="h-[200px]"><canvas id="chartDistrict"></canvas></div>
             </div>
          </div>
        </section>
        
        <section id="tab-backend" class="tab-content hidden animate-fade-in">
           <div class="glass-panel rounded-2xl p-8 text-center">
              <div class="inline-flex w-16 h-16 rounded-full bg-slate-800 items-center justify-center mb-4">
                 <i class="fa-solid fa-server text-2xl text-slate-400"></i>
              </div>
              <h2 class="text-xl font-bold text-white">Backend Configuration</h2>
              <p class="text-sm text-slate-400 mt-2 max-w-lg mx-auto">This console connects to the EventLens AWS Lambda infrastructure.</p>
              
              <div class="mt-8 grid gap-4 max-w-2xl mx-auto text-left">
                 <div class="bg-slate-950/50 rounded-lg p-4 border border-slate-800 font-mono text-xs text-slate-300">
                    <span class="text-orange-500">POST</span> /prod/political/forms
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/30 p-3 rounded border border-slate-800">
                       <div class="text-[10px] text-slate-500 uppercase font-bold">Action</div>
                       <div class="text-sm text-white font-mono mt-1">admin_save_config</div>
                    </div>
                    <div class="bg-slate-900/30 p-3 rounded border border-slate-800">
                        <div class="text-[10px] text-slate-500 uppercase font-bold">Action</div>
                        <div class="text-sm text-white font-mono mt-1">admin_list_entries</div>
                     </div>
                 </div>
              </div>
           </div>
        </section>

      </div>
    </div>
  </main>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-[60] backdrop-blur-sm">
    <div class="absolute inset-0 bg-black/80" id="modalBackdrop"></div>
    <div class="relative max-w-2xl w-[90%] rounded-2xl border border-slate-700 bg-slate-900 shadow-2xl overflow-hidden animate-slide-up">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 bg-slate-900/50">
        <div>
          <h3 class="text-lg font-bold text-white">Data Details</h3>
          <div id="modalMeta" class="text-xs text-slate-400 font-mono mt-1">ID: ...</div>
        </div>
        <button id="btnCloseModal" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors flex items-center justify-center">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-0 overflow-auto max-h-[70vh]">
        <pre id="modalJson" class="text-xs text-green-400 bg-[#0d1117] p-6 font-mono overflow-auto"></pre>
      </div>
    </div>
  </div>

<script>
(() => {
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  const FORMS_URL = `${BASE_URL}/political/forms`;

  const FORM_META = {
    __defaults__: { file: "political_visitor_form.html" },
    visitor_form: { file: "political_visitor_form.html" },
    party_attendance: { file: "political_party_attendance_form.html" },
    president_tour: { file: "political_president_tour_form.html" },
    mandal_reporting: { file: "political_mandal_reporting_form.html" },
    coordinator: { file: "political_coordinator_form.html" },
    program_info: { file: "political_program_info_form.html" },
  };

  const $ = (id) => document.getElementById(id);
  const qs = (n) => { try { return (new URL(window.location.href)).searchParams.get(n) || ""; } catch(e){ return ""; } };

  const ASSET_DOM_KEYS = { logo: "logo", header: "header", bg: "background" };
  const domToCfgKey = (domKey) => ASSET_DOM_KEYS[domKey] || domKey;

  function safeText(v){ return (v == null) ? "" : String(v); }
  function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function isoToMs(iso){ try { return Date.parse(iso); } catch(e){ return 0; } }
  function dateToMs(dateStr, endOfDay=false){
    if(!dateStr) return "";
    const dt = new Date(dateStr + (endOfDay ? "T23:59:59.999Z" : "T00:00:00.000Z"));
    const ms = dt.getTime();
    return Number.isFinite(ms) ? String(ms) : "";
  }

  function showToast(msg, type = 'info') {
    const container = $('toastContainer');
    const el = document.createElement('div');
    let icon = 'fa-info-circle';
    let colors = 'bg-slate-800 border-slate-700 text-white';
    if(type === 'success') { icon = 'fa-circle-check'; colors = 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100'; }
    if(type === 'error') { icon = 'fa-circle-exclamation'; colors = 'bg-red-900/90 border-red-500/30 text-red-100'; }
    if(type === 'loading') { icon = 'fa-circle-notch fa-spin'; colors = 'bg-blue-900/90 border-blue-500/30 text-blue-100'; }

    el.className = `toast flex items-center gap-3 px-4 py-3 rounded-xl border shadow-xl min-w-[300px] ${colors}`;
    el.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-medium">${msg}</span>`;
    container.appendChild(el);

    if(type !== 'loading') {
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
        setTimeout(() => el.remove(), 300);
      }, 3000);
    }
    return el;
  }

  function setOverlayVisible(v){
    $('customPreviewOverlay').style.opacity = v ? "1" : "0";
  }

  const DEFAULT_CONFIG = {
    defaults: {
      branding: { title: "Political Forms", subtitle: "Visitor Entry System", tagline: "", color1: "#f97316", color2: "#ef4444", logo: { kind: "none" }, header: { kind: "none" }, background: { kind: "none" } },
      programs: ["‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡•ç‡§Æ‡•á‡§≤‡§®","‡§ú‡§®‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï","‡§¨‡•Ç‡§• ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó"],
      fixed_levels: {}
    },
    forms: { visitor_form: {}, party_attendance: {}, president_tour: {}, mandal_reporting: {}, coordinator: {}, program_info: {} }
  };

  let state = {
    cid: (qs("cid") || qs("collection_id") || "").trim(),
    target: "__defaults__",
    config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
    pendingAssets: {},
    allItems: [],
    viewItems: [],
    sort: { key: "created_at", dir: "desc" },
    page: 0,
    pageSize: 50,
    next_key: null,
    charts: {},
    dirty: false,
  };

  function markDirty(){
    state.dirty = true;
    renderBrandPreview();
  }

  function getEffectiveBranding(ft) {
    const d = state.config.defaults.branding || {};
    const o = (ft !== "__defaults__") ? (state.config.forms?.[ft]?.branding || {}) : {};
    return { ...d, ...o };
  }

  function renderBrandPreview() {
    const ft = state.target;
    const b = getEffectiveBranding(ft);

    if(document.activeElement !== $('b_title')) $('b_title').value = safeText(b.title);
    if(document.activeElement !== $('b_subtitle')) $('b_subtitle').value = safeText(b.subtitle);
    if(document.activeElement !== $('b_tagline')) $('b_tagline').value = safeText(b.tagline);
    $('b_c1').value = b.color1 || "#f97316";
    $('b_c2').value = b.color2 || "#ef4444";

    const liveOn = !!$('livePreviewToggle').checked;
    const hasPend = !!(state.pendingAssets[ft] && Object.keys(state.pendingAssets[ft] || {}).length);
    setOverlayVisible(liveOn && (state.dirty || hasPend));

    const pend = state.pendingAssets[ft] || {};
    const pendBg = pend.bg || pend.background;

    const logoUrl = pend.logo ? pend.logo.previewUrl : ((b.logo && b.logo.kind !== 'none') ? b.logo.value : null);
    const headerUrl = pend.header ? pend.header.previewUrl : ((b.header && b.header.kind !== 'none') ? b.header.value : null);
    const bgUrl = pendBg ? pendBg.previewUrl : ((b.background && b.background.kind !== 'none') ? b.background.value : null);

    $('previewTitle').textContent = safeText(b.title) || "Title";
    $('previewSubtitle').textContent = safeText(b.subtitle) || "";
    $('previewTagline').textContent = safeText(b.tagline) || "";
    $('previewHeaderBar').style.background = `linear-gradient(to right, ${b.color1 || "#f97316"}, ${b.color2 || "#ef4444"})`;
    $('sw1').style.backgroundColor = b.color1 || "#f97316";
    $('sw2').style.backgroundColor = b.color2 || "#ef4444";

    if(logoUrl) { $('previewLogo').src = logoUrl; $('previewLogo').classList.remove('hidden'); $('previewLogoIcon').classList.add('hidden'); }
    else { $('previewLogo').classList.add('hidden'); $('previewLogoIcon').classList.remove('hidden'); }

    if(headerUrl) { $('previewHeaderImg').src = headerUrl; $('previewHeaderImgWrap').classList.remove('hidden'); }
    else { $('previewHeaderImgWrap').classList.add('hidden'); }

    if(bgUrl) $('previewBg').style.backgroundImage = `url('${bgUrl}')`;
    else $('previewBg').style.backgroundImage = '';
  }

  function renderFormPreviewIframe() {
    const ft = state.target === "__defaults__" ? "visitor_form" : state.target;
    const file = FORM_META[ft]?.file || "political_visitor_form.html";
    const url = `${file}?cid=${encodeURIComponent(state.cid)}&preview=1&form_type=${encodeURIComponent(ft)}&t=${Date.now()}`;
    $('formPreviewIframe').src = url;
    $('formPreviewUrlTxt').textContent = `${file}?cid=${state.cid || ""}`;
  }

  function setPending(domKey, file) {
    const ft = state.target;
    if(!state.pendingAssets[ft]) state.pendingAssets[ft] = {};

    if(!file){
      try { 
        const prev = state.pendingAssets[ft][domKey]?.previewUrl;
        if(prev) URL.revokeObjectURL(prev);
      } catch(e){}
      delete state.pendingAssets[ft][domKey];

      $(`name_${domKey}`).textContent = "No file";
      const img = $(`prev_${domKey}`);
      if(img){
        img.classList.add('hidden');
        img.removeAttribute('src');
      }
      const icon = $(`icon_${domKey}`);
      if(icon) icon.classList.remove('hidden');

      markDirty();
      return;
    }

    const previewUrl = URL.createObjectURL(file);
    state.pendingAssets[ft][domKey] = { file, previewUrl };
    $(`name_${domKey}`).textContent = file.name;

    const img = $(`prev_${domKey}`);
    if(img){
      img.src = previewUrl;
      img.classList.remove('hidden');
    }
    const icon = $(`icon_${domKey}`);
    if(icon) icon.classList.add('hidden');

    markDirty();
  }

  async function apiCall(action, payload) {
     const idToken = (localStorage.getItem("id_token") || "").trim();
     const headers = { "Content-Type": "application/json" };
     if(idToken) headers["Authorization"] = `Bearer ${idToken}`;

     const resp = await fetch(FORMS_URL, {
       method: "POST",
       headers,
       body: JSON.stringify({ action, payload })
     });

     const text = await resp.text();
     let data = {};
     try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
     if(!resp.ok) {
       const msg = data?.message || data?.error || `API Error ${resp.status}`;
       throw new Error(msg);
     }
     return data;
  }

  async function saveConfig() {
     if(!state.cid) return showToast("Collection ID (CID) required", "error");
     const t = showToast("Saving changes...", "loading");
     const ft = state.target;

     const newBrand = {
        title: $('b_title').value,
        subtitle: $('b_subtitle').value,
        tagline: $('b_tagline').value,
        color1: $('b_c1').value,
        color2: $('b_c2').value
     };

     if(ft === "__defaults__") state.config.defaults.branding = { ...state.config.defaults.branding, ...newBrand };
     else {
        if(!state.config.forms[ft]) state.config.forms[ft] = {};
        state.config.forms[ft].branding = { ...(state.config.forms[ft].branding||{}), ...newBrand };
     }

     const pends = state.pendingAssets[ft];
     if(pends) {
        for(const domKey of ['logo','header','bg']) {
           if(pends[domKey] && pends[domKey].file) {
              const cfgKey = domToCfgKey(domKey);
              const reader = new FileReader();
              await new Promise(r => {
                 reader.onload = () => {
                    const val = reader.result;
                    if(ft === "__defaults__") state.config.defaults.branding[cfgKey] = { kind: 'data', value: val };
                    else {
                      if(!state.config.forms[ft]) state.config.forms[ft] = {};
                      if(!state.config.forms[ft].branding) state.config.forms[ft].branding = {};
                      state.config.forms[ft].branding[cfgKey] = { kind: 'data', value: val };
                    }
                    r();
                 };
                 reader.readAsDataURL(pends[domKey].file);
              });
           }
        }
        state.pendingAssets[ft] = {};
     }

     try {
        await apiCall("admin_save_config", { collection_id: state.cid, config: state.config });
        t.remove(); showToast("Saved to Cloud successfully", "success");
     } catch(e) {
        localStorage.setItem(`EL_CFG_${state.cid}`, JSON.stringify(state.config));
        t.remove(); showToast(`Backend error. Saved locally. (${e.message})`, "error");
     }

     state.dirty = false;
     setOverlayVisible(false);
     renderFormPreviewIframe();
  }

  async function loadConfig() {
     if(!state.cid) {
        $('cidPill').classList.add('hidden');
        return;
     }
     $('cidPill').classList.remove('hidden');
     $('cidVal').textContent = state.cid;
     $('cidInput').value = state.cid;

     const t = showToast("Loading configuration...", "loading");
     try {
        const res = await apiCall("admin_get_config", { collection_id: state.cid });
        if(res.config) state.config = res.config;
        t.remove(); showToast("Loaded from Cloud", "success");
     } catch(e) {
        const local = localStorage.getItem(`EL_CFG_${state.cid}`);
        if(local) state.config = JSON.parse(local);
        t.remove(); showToast(`Cloud config not available. Loaded local (if exists). (${e.message})`, "error");
     }

     state.dirty = false;
     renderAll();
     renderFormPreviewIframe();
  }

  function renderAll() {
     renderBrandPreview();
     renderPrograms();
     renderLevels();
  }

  function ensureForm(ft) { if(!state.config.forms[ft]) state.config.forms[ft] = {}; }

  function renderPrograms() {
     const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
     const scope = $('progScopeSel') ? $('progScopeSel').value : "current";
     let list = [];
     if(scope === 'defaults') list = state.config.defaults.programs || [];
     else {
        const specific = state.config.forms?.[ft]?.programs;
        list = specific || state.config.defaults.programs || []; 
     }

     const container = $('progList');
     if(!container) return;
     container.innerHTML = '';
     list.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = "flex items-center justify-between bg-slate-900/50 border border-slate-800 rounded-lg px-3 py-2";

        const txt = document.createElement('span');
        txt.className = "text-sm font-medium text-slate-300 truncate";
        txt.textContent = p;

        const btn = document.createElement('button');
        btn.className = "text-slate-500 hover:text-red-400 p-1";
        btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
        btn.type = "button";
        btn.onclick = () => {
          const newList = [...list];
          newList.splice(idx, 1);
          if(scope === 'defaults') state.config.defaults.programs = newList;
          else {
              ensureForm(ft);
              state.config.forms[ft].programs = newList;
          }
          markDirty();
          renderPrograms();
        };

        el.appendChild(txt);
        el.appendChild(btn);
        container.appendChild(el);
     });
  }

  function renderLevels() {
      const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
      const scope = $('levelScopeSel') ? $('levelScopeSel').value : "current";
      let src = {};
      if(scope === "defaults") src = state.config.defaults.fixed_levels || {};
      else src = (ft === "__defaults__") ? (state.config.defaults.fixed_levels || {}) : (state.config.forms?.[ft]?.fixed_levels || state.config.defaults.fixed_levels || {});
      $('lvl_mandal_reporting').value = src?.mandal_reporting || "";
      $('lvl_coordinator').value = src?.coordinator || "";
      $('lvl_program_info').value = src?.program_info || "";
  }

  function normalizeItem(it){
    const payload = (it.data && typeof it.data === 'object') ? it.data : (it.payload && typeof it.payload === 'object' ? it.payload : {});
    const created = it.created_at ? num(it.created_at) : (it.created_at_iso ? isoToMs(it.created_at_iso) : 0);
    const mobile = safeText(it.mobile || payload.mobile || "");
    const name = safeText(it.name || payload.name || "");
    const district = safeText(it.district || payload.district || "");
    const form_type = safeText(it.form_type || it.ft || payload.form_type || "");
    return { ...it, created_at: created, form_type, payload, mobile, name, district };
  }

  function fmtTime(ms){
    try{ return new Date(ms).toLocaleString(); }catch(e){ return "-"; }
  }

  function openModal(item){
    $('modal').classList.remove('hidden');
    $('modal').classList.add('flex');
    const id = item.entry_id || item.id || item.entryId || "";
    $('modalMeta').textContent = `ID: ${id || "-"}`;
    $('modalJson').textContent = JSON.stringify(item, null, 2);
  }

  function applyDataFilters(){
    const q = (safeText($('dataSearch')?.value).trim() || "").toLowerCase();
    const ft = $('dataFormSel')?.value || "__all__";
    let items = [...state.allItems];

    if(ft && ft !== "__all__"){
      items = items.filter(x => (x.form_type || "") === ft);
    }
    if(q){
      items = items.filter(x => {
        const s = `${x.mobile||""} ${x.name||""} ${x.district||""}`.toLowerCase();
        return s.includes(q);
      });
    }

    const {key, dir} = state.sort;
    items.sort((a,b) => {
      let av = 0, bv = 0;
      if(key === "created_at"){ av = num(a.created_at); bv = num(b.created_at); }
      else if(key === "mobile"){ av = safeText(a.mobile); bv = safeText(b.mobile); return dir === "asc" ? av.localeCompare(bv) : bv.localeCompare(av); }
      else if(key === "district"){ av = safeText(a.district); bv = safeText(b.district); return dir === "asc" ? av.localeCompare(bv) : bv.localeCompare(av); }
      return dir === "asc" ? (av - bv) : (bv - av);
    });

    state.viewItems = items;
    state.page = 0;
    renderTable();
    updateStats();
  }

  async function loadData() {
     if(!state.cid) return showToast("CID Required", "error");
     const t = showToast("Fetching records...", "loading");

     const formSel = $('dataFormSel')?.value || "__all__";
     const start_ms = dateToMs($('dateFrom')?.value || "", false);
     const end_ms = dateToMs($('dateTo')?.value || "", true);

     const payload = { collection_id: state.cid, form_type: formSel || "__all__", limit: 200, next_key: state.next_key || null };
     if(start_ms) payload.start_ms = start_ms;
     if(end_ms) payload.end_ms = end_ms;

     try {
       const res = await apiCall("admin_list_entries", payload);
       const items = (res.items || []).map(normalizeItem);
       state.allItems = items;
       state.next_key = res.next_key || null;
       t.remove();
       showToast(`Loaded ${items.length} records`, "success");
     } catch(e) {
       t.remove();
       showToast(`Backend error. (${e.message})`, "error");
       state.allItems = [];
     }
     applyDataFilters();
  }

  function renderTable() {
      const tbody = $('dataTbody');
      tbody.innerHTML = '';
      $('loadedCount').textContent = state.viewItems.length;

      const items = state.viewItems.slice(state.page * state.pageSize, (state.page+1) * state.pageSize);

      if(!items.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="px-4 py-8 text-center text-slate-500 italic">No records</td>`;
        tbody.appendChild(tr);
      } else {
        items.forEach(item => {
          const tr = document.createElement('tr');
          tr.className = "hover:bg-slate-800/30 transition-colors border-b border-slate-800/50";

          tr.innerHTML = `
            <td class="px-4 py-3 text-slate-400 font-mono text-xs">${fmtTime(item.created_at)}</td>
            <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] bg-slate-800 border border-slate-700 text-slate-300">${safeText(item.form_type || "-")}</span></td>
            <td class="px-4 py-3 text-white font-mono text-xs">${safeText(item.mobile || "-")}</td>
            <td class="px-4 py-3 text-white font-medium">${safeText(item.name || "-")}</td>
            <td class="px-4 py-3 text-slate-400">${safeText(item.district || "-")}</td>
            <td class="px-4 py-3"><button type="button" class="text-orange-500 hover:text-orange-400 text-xs font-bold btnView">View</button></td>
          `;

          tr.querySelector(".btnView").onclick = () => openModal(item);
          tbody.appendChild(tr);
        });
      }

      const totalPages = Math.ceil(state.viewItems.length / state.pageSize) || 1;
      $('btnPrevPage').disabled = (state.page <= 0);
      $('btnNextPage').disabled = (state.page >= totalPages - 1);
  }

  function updateStats() {
      $('kpiTotal').textContent = state.allItems.length;
      const todayStr = new Date().toDateString();
      $('kpiToday').textContent = state.allItems.filter(i => new Date(i.created_at).toDateString() === todayStr).length;
      $('kpiUnique').textContent = new Set(state.allItems.map(i => i.mobile).filter(Boolean)).size;
      buildCharts();
  }

  function buildCharts() {
     const items = state.allItems || [];
     const days = 14;
     const labels = [];
     const counts = [];
     const now = new Date();

     for(let i=days-1;i>=0;i--){
       const d = new Date(now);
       d.setDate(now.getDate()-i);
       const key = d.toISOString().slice(0,10);
       labels.push(d.toLocaleDateString());
       let c = 0;
       items.forEach(it=>{
         const k = new Date(it.created_at).toISOString().slice(0,10);
         if(k === key) c += 1;
       });
       counts.push(c);
     }

     const byForm = {};
     items.forEach(it => { const ft = it.form_type || "unknown"; byForm[ft] = (byForm[ft] || 0) + 1; });
     const formLabels = Object.keys(byForm);
     const formCounts = formLabels.map(k => byForm[k]);

     const byDist = {};
     items.forEach(it => { const d = it.district || ""; if(!d) return; byDist[d] = (byDist[d] || 0) + 1; });
     const distLabels = Object.keys(byDist).sort((a,b)=>byDist[b]-byDist[a]).slice(0,10);
     const distCounts = distLabels.map(k=>byDist[k]);

     if(state.charts.c1) state.charts.c1.destroy();
     state.charts.c1 = new Chart($('chartByDay'), { type:'line', data:{labels, datasets:[{data:counts, tension:0.35}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });

     if(state.charts.c2) state.charts.c2.destroy();
     state.charts.c2 = new Chart($('chartByForm'), { type:'doughnut', data:{labels:formLabels, datasets:[{data:formCounts}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}} });

     if(state.charts.c3) state.charts.c3.destroy();
     state.charts.c3 = new Chart($('chartDistrict'), { type:'bar', data:{labels:distLabels, datasets:[{data:distCounts}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });
  }

  function exportCsv(){
    const rows = [["created_at","form_type","mobile","name","district","entry_id"]];
    state.viewItems.forEach(it=> rows.push([fmtTime(it.created_at), it.form_type||"", it.mobile||"", it.name||"", it.district||"", it.entry_id||""]));
    const csv = rows.map(r => r.map(x => `"${String(x||"").replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `political_data_${state.cid || "cid"}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $('btnSave').onclick = saveConfig;
  $('btnReload').onclick = loadConfig;
  $('btnApplyCid').onclick = () => { state.cid = $('cidInput').value.trim(); loadConfig(); };

  $('btnLoadFormPreview').onclick = () => { renderFormPreviewIframe(); setOverlayVisible(false); };
  $('btnOpenFormPreview').onclick = () => { const u = $('formPreviewIframe').src; if(u) window.open(u, "_blank"); };

  document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.onclick = () => {
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
          $(`tab-${btn.dataset.tab}`).classList.remove('hidden');
      };
  });

  $('targetFormSel').onchange = () => { state.target = $('targetFormSel').value; renderAll(); renderFormPreviewIframe(); };
  $('livePreviewToggle').onchange = renderBrandPreview;

  ['logo','header','bg'].forEach(k => {
     $(`file_${k}`).onchange = (e) => { if(e.target.files && e.target.files[0]) setPending(k, e.target.files[0]); };
     const clearBtn = document.querySelector(`[data-clear="${k}"]`);
     if(clearBtn) clearBtn.onclick = (e) => { e.stopPropagation(); $(`file_${k}`).value = ""; setPending(k, null); };
  });

  ['input','change'].forEach(ev => {
      ['b_title','b_subtitle','b_tagline','b_c1','b_c2'].forEach(id=>{
        $(id).addEventListener(ev, () => { markDirty(); });
      });
  });

  $('btnAddProg').onclick = () => {
      const v = $('progInput').value.trim();
      if(!v) return;
      const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
      const scope = $('progScopeSel').value;
      if(scope === 'defaults') state.config.defaults.programs = [v, ...(state.config.defaults.programs||[])];
      else { ensureForm(ft); state.config.forms[ft].programs = [v, ...(state.config.forms[ft].programs||[])]; }
      $('progInput').value = "";
      markDirty();
      renderPrograms();
      showToast("Program Added", "success");
  };

  ['lvl_mandal_reporting','lvl_coordinator','lvl_program_info'].forEach(id=>{
    $(id).onchange = () => {
      const scope = $('levelScopeSel').value;
      const ft = state.target === "__defaults__" ? "__defaults__" : state.target;
      const targetObj = (scope === "defaults") ? state.config.defaults : (ft === "__defaults__" ? state.config.defaults : (ensureForm(ft), state.config.forms[ft]));
      if(!targetObj.fixed_levels) targetObj.fixed_levels = {};
      targetObj.fixed_levels.mandal_reporting = $('lvl_mandal_reporting').value;
      targetObj.fixed_levels.coordinator = $('lvl_coordinator').value;
      targetObj.fixed_levels.program_info = $('lvl_program_info').value;
      markDirty();
    };
  });

  $('btnLoadData').onclick = loadData;
  $('btnApplyFilter').onclick = () => { applyDataFilters(); };
  $('dataSearch').oninput = () => applyDataFilters();
  $('dataFormSel').onchange = () => applyDataFilters();

  document.querySelectorAll('[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      if(state.sort.key === key) state.sort.dir = (state.sort.dir === "asc") ? "desc" : "asc";
      else { state.sort.key = key; state.sort.dir = "asc"; }
      applyDataFilters();
    });
  });

  $('btnPrevPage').onclick = () => { if(state.page>0){ state.page--; renderTable(); } };
  $('btnNextPage').onclick = () => { const totalPages = Math.ceil(state.viewItems.length / state.pageSize) || 1; if(state.page < totalPages-1){ state.page++; renderTable(); } };

  $('btnExportCsv').onclick = exportCsv;
  $('btnRefreshCharts').onclick = () => buildCharts();

  $('btnCloseModal').onclick = () => { $('modal').classList.add('hidden'); $('modal').classList.remove('flex'); };
  $('modalBackdrop').onclick = $('btnCloseModal').onclick;

  if(state.cid){
    $('cidVal').textContent = state.cid;
    $('cidPill').classList.remove('hidden');
    $('cidInput').value = state.cid;
  }

  loadConfig();
  renderFormPreviewIframe();

})();
</script>
</body>
</html>
