<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Political Admin Console - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] } } } }</script>
  <style>
    body { background: #0f172a; color: #fff; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; transition: all 0.2s; color: #94a3b8; cursor: pointer; }
    .sidebar-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .sidebar-link.active { background: linear-gradient(135deg, #f97316, #ea580c); color: white; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
    .table-row:hover { background: rgba(255,255,255,0.03); }
    th { cursor: pointer; user-select: none; }
    th:hover { color: #fb923c; }
    
    /* Modal Animation */
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s; opacity: 0; visibility: hidden; }
    .modal.open { opacity: 1; visibility: visible; }
    .modal-content { transform: scale(0.95); transition: transform 0.3s; }
    .modal.open .modal-content { transform: scale(1); }

    /* Mobile Preview Container */
    .mobile-frame { border: 8px solid #1e293b; border-radius: 30px; overflow: hidden; height: 600px; width: 320px; position: relative; background: #0f172a; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); margin: 0 auto; }
    .mobile-screen { height: 100%; width: 100%; overflow-y: auto; background-size: cover; background-position: center; position: relative; }
    .mobile-screen::-webkit-scrollbar { width: 4px; }
    .mobile-screen::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    
    .preview-glass { background: rgba(30, 41, 59, 0.90); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 20px; margin-top: -40px; position: relative; z-index: 10; margin-left: 10px; margin-right: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    
    .header-bg-preview { height: 150px; width: 100%; background-size: cover; background-position: center; position: relative; }
    .header-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(15, 23, 42, 1)); }

    /* Toast */
    #toast { position: fixed; top: 24px; right: 24px; background: #1a1a1a; color: #fff; padding: 16px 24px; border-radius: 12px; z-index: 9999; transform: translateX(150%); transition: 0.4s; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #toast.show { transform: translateX(0); }
    #toast.success { border-color: #22c55e; }
    #toast.error { border-color: #ef4444; }
    #toast.info { border-color: #3b82f6; }
  </style>
</head>
<body class="h-screen flex overflow-hidden">

  <!-- Toast Container -->
  <div id="toast"></div>

  <!-- Sidebar -->
  <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
    <div class="p-6 border-b border-slate-800">
      <div class="flex items-center gap-3 text-orange-500">
        <i class="fa-solid fa-user-shield text-2xl"></i>
        <div>
            <span class="font-bold text-lg text-white block leading-tight">Admin Console</span>
            <span class="text-[10px] text-slate-500" id="sidebarCidDisplay">CID: Loading...</span>
        </div>
      </div>
    </div>
    
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
      <div class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-2">Data Management</div>
      <div class="sidebar-link active" onclick="switchTab('program_info', this)">
        <i class="fa-solid fa-calendar-days w-5"></i> Events
      </div>
      <div class="sidebar-link" onclick="switchTab('coordinator_entry', this)">
        <i class="fa-solid fa-users-gear w-5"></i> Coordinators
      </div>
      <div class="sidebar-link" onclick="switchTab('mandal_reporting', this)">
        <i class="fa-solid fa-clipboard-check w-5"></i> Reporting
      </div>
      <div class="sidebar-link" onclick="switchTab('president_tour', this)">
        <i class="fa-solid fa-plane-departure w-5"></i> President Tour
      </div>
      <div class="sidebar-link" onclick="switchTab('visitor_form', this)">
        <i class="fa-solid fa-user-group w-5"></i> Visitors
      </div>
      <div class="sidebar-link" onclick="switchTab('party_attendance', this)">
        <i class="fa-solid fa-list-check w-5"></i> Attendance
      </div>

      <div class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-6">Settings</div>
      <div class="sidebar-link" onclick="switchTab('settings', this)">
        <i class="fa-solid fa-paintbrush w-5"></i> Branding & Links
      </div>
    </nav>
    
    <div class="p-4 border-t border-slate-800">
        <button onclick="loadData()" class="w-full bg-slate-800 hover:bg-slate-700 text-orange-400 text-sm font-medium py-2 rounded-lg transition"><i class="fa-solid fa-sync mr-1"></i> Refresh Data</button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col bg-slate-950 relative overflow-hidden">
    <!-- Header -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur-sm shrink-0 z-10">
      <h2 id="pageTitle" class="text-lg font-semibold text-white">Event Details</h2>
      <div class="flex items-center gap-4">
        <div id="cidWarning" class="hidden px-3 py-1 rounded bg-red-500/10 text-red-400 text-xs border border-red-500/20">
            <i class="fa-solid fa-circle-exclamation mr-1"></i> No CID
        </div>
        
        <!-- Controls for Data View -->
        <div id="dataControls" class="flex items-center gap-3">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search data..." onkeyup="filterTable()" class="bg-slate-800 text-sm text-white rounded-lg pl-9 pr-3 py-1.5 border border-slate-700 focus:border-orange-500 outline-none w-64">
                <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-500 text-xs"></i>
            </div>
            <button onclick="exportCSV()" class="bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/30 border border-emerald-500/30 px-3 py-1.5 rounded-lg text-sm transition">
                <i class="fa-solid fa-file-csv mr-1"></i> Export
            </button>
        </div>

        <button onclick="window.close()" class="text-slate-400 hover:text-white transition text-sm flex items-center gap-2 border-l border-slate-700 pl-4 ml-2">
            <i class="fa-solid fa-xmark"></i> Close
        </button>
      </div>
    </header>

    <!-- Content Area -->
    <div class="flex-1 overflow-hidden relative">
        
        <!-- DATA VIEW (Tables) -->
        <div id="dataView" class="absolute inset-0 p-6 overflow-auto custom-scrollbar">
            <div class="glass rounded-xl overflow-hidden shadow-2xl min-h-[300px]">
                <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800 text-slate-400 text-xs uppercase font-semibold sticky top-0 z-10 shadow-lg">
                    <tr id="tableHeaderRow">
                    <!-- Dynamic Headers -->
                    </tr>
                </thead>
                <tbody id="tableBody" class="text-sm text-slate-300 divide-y divide-slate-800">
                    <tr><td class="p-8 text-center text-slate-500">Select a tab to view data...</td></tr>
                </tbody>
                </table>
                <div id="emptyState" class="hidden p-12 text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-800 text-slate-600 mb-4">
                        <i class="fa-solid fa-database text-2xl"></i>
                    </div>
                    <h3 class="text-slate-400 font-medium">No Data Found</h3>
                    <p class="text-slate-500 text-xs mt-1">Try refreshing or changing the filter.</p>
                </div>
            </div>
            <div class="mt-4 text-xs text-slate-500 flex justify-between">
                <span id="recordCount">0 Records</span>
                <span>Last Updated: <span id="lastUpdated">Just now</span></span>
            </div>
        </div>

        <!-- SETTINGS VIEW (Branding & Links) -->
        <div id="settingsView" class="absolute inset-0 p-6 overflow-auto hidden custom-scrollbar">
            <div class="flex flex-col lg:flex-row gap-8 h-full">
                
                <!-- Left: Controls -->
                <div class="flex-1 space-y-6 overflow-y-auto pr-2 pb-10">
                    
                    <!-- Branding Form -->
                    <div class="glass rounded-xl p-6 border-l-4 border-orange-500">
                        <h3 class="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2 flex justify-between">
                            <span>Admin Branding</span>
                            <span class="text-xs font-normal text-slate-400 bg-slate-800 px-2 py-1 rounded">Local Settings</span>
                        </h3>
                        <div class="space-y-4">
                            <!-- Logo Upload -->
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Organization Logo (URL or Upload)</label>
                                <div class="flex items-center gap-3">
                                    <div class="h-12 w-12 rounded-full bg-slate-800 border border-slate-700 overflow-hidden flex items-center justify-center relative group">
                                        <img id="logoPreviewSmall" class="h-full w-full object-cover hidden">
                                        <i id="logoPlaceholder" class="fa-solid fa-image text-slate-600"></i>
                                    </div>
                                    <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleImageUpload(this, 'previewLogo', 'logoPreviewSmall')">
                                    <button onclick="document.getElementById('logoInput').click()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded transition">Upload File</button>
                                </div>
                            </div>

                            <!-- Header BG Upload -->
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Header Background</label>
                                <div class="flex gap-2">
                                    <input type="file" id="headerInput" accept="image/*" class="w-full text-xs text-slate-400 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-slate-800 file:text-blue-400 hover:file:bg-slate-700 cursor-pointer" onchange="handleImageUpload(this, 'previewHeaderBg')">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">Organization Name</label>
                                    <input type="text" id="brandName" value="EventLens Political" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white outline-none focus:border-orange-500" oninput="updatePreview()">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">Theme Color</label>
                                    <select id="brandTheme" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white outline-none focus:border-orange-500" onchange="updatePreview()">
                                        <option value="orange">Orange (Saffron)</option>
                                        <option value="blue">Blue (Corporate)</option>
                                        <option value="green">Green (Nature)</option>
                                        <option value="red">Red (Urgent)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Footer Text</label>
                                <input type="text" id="brandFooter" value="Powered by EventLens" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white outline-none focus:border-orange-500" oninput="updatePreview()">
                            </div>

                            <button onclick="saveSettings()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition w-full mt-2 shadow-lg shadow-orange-500/20">
                                <i class="fa-solid fa-floppy-disk mr-1"></i> Save Configuration
                            </button>
                            <p class="text-[10px] text-slate-500 text-center mt-1">Settings are saved locally (Browser) for this CID.</p>
                        </div>
                    </div>

                    <!-- Links Generator -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">Public Form Links (Token Based)</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-2 hover:bg-slate-800 rounded transition group">
                                <span class="text-sm text-slate-300"><i class="fa-solid fa-calendar-days w-6 text-center text-slate-500 group-hover:text-orange-400"></i> Event Details</span>
                                <button onclick="copyLink('political_program_info_form.html', 'program_info')" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Generate</button>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-slate-800 rounded transition group">
                                <span class="text-sm text-slate-300"><i class="fa-solid fa-users-gear w-6 text-center text-slate-500 group-hover:text-orange-400"></i> Coordinator</span>
                                <button onclick="copyLink('political_coordinator_entry_form.html', 'coordinator_entry')" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Generate</button>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-slate-800 rounded transition group">
                                <span class="text-sm text-slate-300"><i class="fa-solid fa-clipboard-check w-6 text-center text-slate-500 group-hover:text-orange-400"></i> Reporting</span>
                                <button onclick="copyLink('political_mandal_reporting_form.html', 'mandal_reporting')" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Generate</button>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-slate-800 rounded transition group">
                                <span class="text-sm text-slate-300"><i class="fa-solid fa-plane-departure w-6 text-center text-slate-500 group-hover:text-orange-400"></i> President Tour</span>
                                <button onclick="copyLink('political_president_tour_form.html', 'president_tour')" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Generate</button>
                            </div>
                            <div class="flex justify-between items-center p-2 hover:bg-slate-800 rounded transition group">
                                <span class="text-sm text-slate-300"><i class="fa-solid fa-user-group w-6 text-center text-slate-500 group-hover:text-orange-400"></i> Visitor Form</span>
                                <button onclick="copyLink('political_visitor_form.html', 'visitor_form')" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Generate</button>
                            </div>
                            <!-- Search Link -->
                            <div class="flex justify-between items-center p-2 hover:bg-slate-800 rounded transition group border-t border-slate-800 mt-2 pt-3">
                                <span class="text-sm text-slate-300"><i class="fa-solid fa-magnifying-glass w-6 text-center text-slate-500 group-hover:text-orange-400"></i> Karyakarta Search</span>
                                <button onclick="copyLink('political-search.html', 'search')" class="text-xs bg-orange-700 hover:bg-orange-600 px-3 py-1.5 rounded text-white border border-orange-600">Generate Search</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Preview -->
                <div class="w-full lg:w-[360px] flex flex-col items-center justify-start shrink-0">
                    <div class="w-full flex justify-between items-center mb-4 px-2">
                        <div class="text-slate-400 text-xs uppercase tracking-widest font-semibold">Live Preview</div>
                        <select id="previewFormSelector" onchange="updatePreview()" class="bg-slate-800 text-white text-xs border border-slate-700 rounded px-2 py-1 outline-none focus:border-orange-500 cursor-pointer">
                            <option value="program_info">Event Details Form</option>
                            <option value="coordinator_entry">Coordinator Form</option>
                            <option value="mandal_reporting">Reporting Form</option>
                            <option value="president_tour">President Tour Form</option>
                            <option value="visitor_form">Visitor Form</option>
                        </select>
                    </div>
                    
                    <div class="mobile-frame shadow-2xl relative">
                        <!-- Simulated Mobile Screen -->
                        <div class="mobile-screen" id="mobileScreen">
                            
                            <!-- Header BG -->
                            <div id="previewHeaderBg" class="header-bg-preview" style="background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=1000&auto=format&fit=crop');">
                                <div class="header-overlay"></div>
                            </div>

                            <!-- Main Card -->
                            <div class="preview-glass">
                                <!-- Logo & Title -->
                                <div class="text-center mb-6">
                                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-slate-800 border border-slate-700 mb-3 overflow-hidden shadow-lg relative -mt-12 z-20">
                                        <img id="previewLogo" src="https://cdn-icons-png.flaticon.com/512/9313/9313234.png" class="w-full h-full object-cover">
                                    </div>
                                    <h1 id="prevHeader" class="text-xl font-bold text-white leading-tight">EventLens Political</h1>
                                    <p id="prevSubHeader" class="text-slate-400 text-xs mt-1">Form Name Here</p>
                                </div>

                                <!-- Dynamic Form Fields (Preview) -->
                                <div id="previewFields" class="space-y-3">
                                    <!-- Populated by JS -->
                                </div>

                                <!-- Button -->
                                <div id="prevBtn" class="h-12 bg-gradient-to-r rounded-xl w-full mt-5 shadow-lg flex items-center justify-center text-white font-bold text-sm cursor-pointer">
                                    Submit
                                </div>
                            </div>

                            <div id="prevFooter" class="text-[10px] text-slate-500 text-center mt-6 pb-4">Powered by EventLens</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div class="modal-content glass w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
        <h3 class="font-bold text-lg text-white">Edit Entry</h3>
        <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="p-6 overflow-y-auto space-y-4" id="modalForm"></div>
      <div class="p-5 border-t border-slate-700 bg-slate-800/50 flex justify-end gap-3">
        <button onclick="closeModal()" class="px-5 py-2 rounded-lg text-slate-300 hover:bg-slate-700 transition">Cancel</button>
        <button onclick="saveChanges()" id="btnSave" class="px-5 py-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-medium shadow-lg shadow-orange-500/20 transition flex items-center gap-2">
            <span>Save Changes</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_ID = 'vxid0yoovj';
    const REGION = 'ap-south-1';
    let currentTab = 'program_info';
    let rawData = []; // Stores all data fetched
    let filteredData = []; // Stores data after search/filter
    let editingId = null;
    let collectionId = '';
    let sortDir = 1; // 1 for asc, -1 for desc

    const qs = (name) => (new URL(window.location.href)).searchParams.get(name) || '';
    collectionId = qs('cid') || qs('collection_id');
    const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;

    // --- Helpers ---
    function showToast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.className = `show ${type}`;
      let icon = 'fa-circle-check text-green-500';
      if(type === 'error') icon = 'fa-circle-exclamation text-red-500';
      if(type === 'info') icon = 'fa-circle-info text-blue-500';
      
      t.innerHTML = `
        <i class="fa-solid ${icon} text-xl"></i>
        <div>
          <h4 class="font-bold text-sm">${type === 'success' ? 'Success' : (type==='error'?'Error':'Info')}</h4>
          <p class="text-xs text-slate-300">${msg}</p>
        </div>
      `;
      setTimeout(() => t.className = '', 3000);
    }

    async function apiCall(endpoint, body) {
      try {
        const headers = { 'Content-Type': 'application/json' };
        
        // 401 FIX: Add Authorization header from localStorage
        const token = localStorage.getItem('id_token') || localStorage.getItem('idToken');
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const res = await fetch(`${BASE_URL}${endpoint}`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(body)
        });
        
        const json = await res.json();
        if (!res.ok) {
            // Handle 401 explicitly
            if (res.status === 401) {
                showToast("Login Expired or Invalid Token.", "error");
            }
            throw new Error(json.message || `API Error: ${res.status}`);
        }
        return json;
      } catch (err) {
        throw err;
      }
    }

    // --- Data Schemas (Updated Keys) ---
    const SCHEMAS = {
      'program_info': {
        title: 'Event Details',
        headers: ['Program Title', 'Date', 'Time', 'Location', 'District', 'Action'],
        fields: [
            { key: 'program_title', label: 'Program Title' }, 
            { key: 'program_date', label: 'Date', type: 'date' },
            { key: 'program_time', label: 'Time', type: 'time' },
            { key: 'program_location', label: 'Location' }, 
            { key: 'district', label: 'District' },
            { key: 'expected_people', label: 'Expected People', type: 'number' }
        ],
        previewFields: [
            { icon: 'fa-heading', ph: 'Program Title' }, { icon: 'fa-map-location-dot', ph: 'District' },
            { icon: 'fa-map-pin', ph: 'Location' }, { icon: 'fa-calendar-day', ph: 'Date & Time' },
            { icon: 'fa-users', ph: 'Expected Attendance' }
        ]
      },
      'coordinator_entry': {
        title: 'Coordinator Management',
        headers: ['Name', 'Role', 'Mobile', 'Area', 'Type', 'Action'],
        fields: [
            { key: 'coord_name', label: 'Name' }, 
            { key: 'coordinator_role', label: 'Role', type: 'select', options: ['Vidhan Sabha Sanyojak', 'Mandal Adhyaksh', 'Ward Sanyojak'] },
            { key: 'coord_mobile', label: 'Mobile' }, 
            { key: 'area', label: 'Area/Ward' },
            { key: 'designation_type', label: 'Type' }
        ],
        previewFields: [
            { icon: 'fa-bullhorn', ph: 'Program Name' }, { icon: 'fa-map-location-dot', ph: 'District' },
            { icon: 'fa-user', ph: 'Convenor Name' }, { icon: 'fa-phone', ph: 'Convenor Mobile' },
            { icon: 'fa-user-plus', ph: 'Co-Convenor Details' }
        ]
      },
      'mandal_reporting': {
        title: 'Mandal Reporting',
        headers: ['Venue', 'Date', 'Level', 'Attendance', 'Action'],
        fields: [
            { key: 'venue', label: 'Venue' },
            { key: 'event_date', label: 'Date', type: 'date' }, 
            { key: 'level', label: 'Level', type: 'select', options:['mandal','district','vidhansabha'] },
            { key: 'attendance', label: 'Attendance' },
            { key: 'guests', label: 'Guests' }
        ],
        previewFields: [
            { icon: 'fa-heading', ph: 'Program Name' }, { icon: 'fa-layer-group', ph: 'Level (Mandal/Dist)' },
            { icon: 'fa-users', ph: 'Total Attendance' }, { icon: 'fa-comment-dots', ph: 'Key Issues' },
            { icon: 'fa-camera', ph: 'Upload Photos' }
        ]
      },
      'president_tour': {
        title: 'President Tour',
        headers: ['Place', 'Date', 'Type', 'Attendance', 'Action'],
        fields: [
            { key: 'tour_venue', label: 'Place' }, 
            { key: 'tour_date', label: 'Date', type: 'date' },
            { key: 'program_type', label: 'Type' },
            { key: 'attendance', label: 'Attendance' }
        ],
        previewFields: [
            { icon: 'fa-user', ph: 'Your Name' }, { icon: 'fa-calendar-day', ph: 'Tour Date' },
            { icon: 'fa-location-arrow', ph: 'Tour Place' }, { icon: 'fa-user-tie', ph: 'VIP Name' },
            { icon: 'fa-bed', ph: 'Stay Arrangement' }
        ]
      },
      'visitor_form': {
        title: 'Visitor Entry',
        headers: ['Name', 'Mobile', 'District', 'Reason', 'Date', 'Action'],
        fields: [
            { key: 'name', label: 'Name' }, 
            { key: 'mobile', label: 'Mobile' },
            { key: 'district', label: 'District' }, 
            { key: 'reason', label: 'Reason' },
            { key: 'created_at', label: 'Date', type: 'date', readonly: true }
        ],
        previewFields: [
            { icon: 'fa-user', ph: 'Visitor Name' }, { icon: 'fa-phone', ph: 'Mobile Number' },
            { icon: 'fa-map-location-dot', ph: 'District' }, { icon: 'fa-sitemap', ph: 'Mandal' },
            { icon: 'fa-comment-dots', ph: 'Reason for Visit' }, { icon: 'fa-camera', ph: 'Selfie' }
        ]
      },
      'party_attendance': {
        title: 'Party Attendance',
        headers: ['Name', 'Mobile', 'Designation', 'Date', 'Action'],
        fields: [
            { key: 'name', label: 'Name' },
            { key: 'mobile', label: 'Mobile' },
            { key: 'designation', label: 'Designation' },
            { key: 'created_at', label: 'Date', type: 'date', readonly: true }
        ],
        previewFields: [
            { icon: 'fa-user', ph: 'Name' }, { icon: 'fa-phone', ph: 'Mobile' },
            { icon: 'fa-id-badge', ph: 'Designation' }, { icon: 'fa-camera', ph: 'Selfie' }
        ]
      }
    };

    // --- Tab Switching ---
    function switchTab(tab, el) {
      currentTab = tab;
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      el.classList.add('active');
      
      const titles = { 
          'program_info': 'Event Details', 'coordinator_entry': 'Coordinator Management', 
          'mandal_reporting': 'Mandal Reports', 'president_tour': 'President Tour Logs', 
          'visitor_form': 'Visitor Entries', 'party_attendance': 'Party Attendance', 
          'settings': 'Dashboard Settings' 
      };
      document.getElementById('pageTitle').textContent = titles[tab];

      if(tab === 'settings') {
        document.getElementById('dataView').classList.add('hidden');
        document.getElementById('dataControls').classList.add('hidden');
        document.getElementById('settingsView').classList.remove('hidden');
        updatePreview();
      } else {
        document.getElementById('settingsView').classList.add('hidden');
        document.getElementById('dataView').classList.remove('hidden');
        document.getElementById('dataControls').classList.remove('hidden');
        loadData();
      }
    }

    // --- Data Loading ---
    async function loadData() {
      if(!collectionId) return;
      const tbody = document.getElementById('tableBody');
      const thead = document.getElementById('tableHeaderRow');
      const schema = SCHEMAS[currentTab];
      
      thead.innerHTML = schema.headers.map((h, index) => 
        `<th class="p-4 border-b border-slate-700 whitespace-nowrap" onclick="sortTable(${index}, '${h}')">
            ${h} <i class="fa-solid fa-sort text-slate-600 text-[10px] ml-1"></i>
         </th>`
      ).join('');

      tbody.innerHTML = `<tr><td colspan="${schema.headers.length}" class="p-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2 text-orange-500"></i><br>Fetching Records...</td></tr>`;

      // Map tab ID to actual DB form_type
      let dbFormType = currentTab;
      if(currentTab === 'program_info') dbFormType = 'program_info_form';
      if(currentTab === 'coordinator_entry') dbFormType = 'coordinator_entry_form';
      if(currentTab === 'president_tour') dbFormType = 'president_tour_form';

      try {
        // Updated to use PUBLIC endpoint based on user request to fix 401
        const json = await apiCall('/political/public/forms', {
            action: "admin_list",
            payload: {
                collection_id: collectionId,
                form_type: dbFormType, 
                limit: 100,
                start_ms: "0" // Fetch all history
            }
        });
        
        rawData = (json.items || []);
        filteredData = [...rawData];
        
        renderTable();
        document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();
      } catch(err) { 
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="${schema.headers.length}" class="p-8 text-center text-red-400">Error loading data. <br><span class="text-xs">${err.message}</span></td></tr>`; 
      }
    }

    // --- Rendering & Filtering ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const schema = SCHEMAS[currentTab];
        document.getElementById('recordCount').innerText = `${filteredData.length} Records`;

        if(filteredData.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }
        document.getElementById('emptyState').classList.add('hidden');

        filteredData.forEach(item => {
            // Data is inside 'data' key based on lambda response, but let's check both levels
            const d = item.data || item.payload || item;
            let tds = '';
            
            schema.fields.forEach(f => { 
                let val = d[f.key];
                // Fallback to top level if not in payload
                if(val === undefined) val = item[f.key];
                
                if(!val) val = '-';
                
                if(f.type === 'date' && val !== '-') { 
                    try { val = new Date(val).toLocaleDateString(); } catch(e){} 
                }
                tds += `<td class="p-4 text-slate-300 border-b border-slate-800/50 whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px]">${val}</td>`; 
            });
            
            tbody.innerHTML += `
            <tr class="table-row transition">
                ${tds}
                <td class="p-4 text-right border-b border-slate-800/50">
                    <button onclick="openEdit('${item.entry_id}')" class="text-orange-400 bg-orange-500/10 hover:bg-orange-500/20 px-2 py-1.5 rounded-lg text-xs font-medium transition mr-2">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <!-- Trigger new API actions -->
                    <button onclick="deleteItem('${item.entry_id}')" class="text-red-400 bg-red-500/10 hover:bg-red-500/20 px-2 py-1.5 rounded-lg text-xs font-medium transition" title="Delete Entry">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>`;
        });
    }

    function filterTable() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const schema = SCHEMAS[currentTab];
        
        filteredData = rawData.filter(item => {
            const d = item.data || item.payload || item;
            return schema.fields.some(f => String(d[f.key] || item[f.key] || '').toLowerCase().includes(term));
        });
        renderTable();
    }

    function sortTable(colIndex, headerName) {
        sortDir = sortDir * -1;
        const key = SCHEMAS[currentTab].fields[colIndex].key;
        
        filteredData.sort((a, b) => {
            const dA = a.data || a.payload || a;
            const dB = b.data || b.payload || b;
            
            const valA = String(dA[key] || a[key] || '').toLowerCase();
            const valB = String(dB[key] || b[key] || '').toLowerCase();
            
            if (valA < valB) return -1 * sortDir;
            if (valA > valB) return 1 * sortDir;
            return 0;
        });
        renderTable();
    }

    function exportCSV() {
        if(filteredData.length === 0) return showToast("No data to export", "error");
        
        const schema = SCHEMAS[currentTab];
        const headers = schema.fields.map(f => f.label).join(',');
        const rows = filteredData.map(item => {
            const d = item.data || item.payload || item;
            return schema.fields.map(f => `"${String(d[f.key] || item[f.key] || '').replace(/"/g, '""')}"`).join(',');
        }).join('\n');
        
        const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows;
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `${currentTab}_export_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Export Started");
    }

    // --- Branding Logic (Local Only) ---
    async function saveSettings() {
        const btn = document.querySelector('button[onclick="saveSettings()"]');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Saving...';
        btn.disabled = true;

        const settings = {
            name: document.getElementById('brandName').value,
            theme: document.getElementById('brandTheme').value,
            footer: document.getElementById('brandFooter').value,
            logo_url: document.getElementById('logoPreviewSmall').src || '', 
            header_bg: document.getElementById('previewHeaderBg').style.backgroundImage.slice(5, -2) || ''
        };

        // Saving locally because backend update_settings is missing
        localStorage.setItem(`political_branding_${collectionId}`, JSON.stringify(settings));
        showToast("Settings Saved Locally!");
        
        btn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i> Save Configuration';
        btn.disabled = false;
    }

    async function loadSettings() {
        const saved = localStorage.getItem(`political_branding_${collectionId}`);
        if(saved) applySettings(JSON.parse(saved));
    }

    function applySettings(s) {
        if(s.name) document.getElementById('brandName').value = s.name;
        if(s.theme) document.getElementById('brandTheme').value = s.theme;
        if(s.footer) document.getElementById('brandFooter').value = s.footer;
        if(s.logo_url) {
            document.getElementById('logoPreviewSmall').src = s.logo_url;
            document.getElementById('logoPreviewSmall').classList.remove('hidden');
            document.getElementById('logoPlaceholder').classList.add('hidden');
            document.getElementById('previewLogo').src = s.logo_url;
        }
        if(s.header_bg) {
            document.getElementById('previewHeaderBg').style.backgroundImage = `url('${s.header_bg}')`;
        }
        updatePreview();
    }

    // --- CRUD Operations (Calling Admin Actions) ---
    function openEdit(id) {
        const item = rawData.find(i => i.entry_id === id); if(!item) return; editingId = id;
        const formContainer = document.getElementById('modalForm'); formContainer.innerHTML = '';
        const fields = SCHEMAS[currentTab].fields || []; 
        const data = item.data || item.payload || item;
        
        fields.forEach(field => {
            if(field.readonly) return;
            const val = (data[field.key] !== undefined) ? data[field.key] : (item[field.key] || '');
            let inputHtml = `<input type="${field.type || 'text'}" id="edit_${field.key}" value="${val}" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white outline-none focus:border-orange-500" />`;
            
            if(field.type === 'select') {
                inputHtml = `<select id="edit_${field.key}" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:border-orange-500">
                    ${field.options.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}
                </select>`;
            }
            formContainer.innerHTML += `<div><label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase">${field.label}</label>${inputHtml}</div>`;
        });
        document.getElementById('editModal').classList.add('open');
    }

    function closeModal() { document.getElementById('editModal').classList.remove('open'); }
    
    async function saveChanges() {
        const btn = document.getElementById('btnSave');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        const updatedFields = {};
        const fields = SCHEMAS[currentTab].fields;
        fields.forEach(f => {
            if(f.readonly) return;
            const el = document.getElementById(`edit_${f.key}`);
            if(el) updatedFields[f.key] = el.value;
        });

        // Try calling admin_update_entry (needs backend implementation)
        try {
            await apiCall('/political/public/forms', {
                action: "admin_update_entry",
                payload: {
                    collection_id: collectionId,
                    entry_id: editingId,
                    form_type: currentTab,
                    updates: updatedFields
                }
            });
            showToast("Updated Successfully!");
            closeModal();
            loadData();
        } catch(e) {
            console.error(e);
            showToast("Update Failed: " + e.message, "error");
        } finally {
            btn.innerHTML = '<span>Save Changes</span>';
            btn.disabled = false;
        }
    }

    async function deleteItem(id) {
       if(!confirm("Are you sure?")) return;
       try {
            await apiCall('/political/public/forms', {
                action: "admin_delete_entry",
                payload: {
                    collection_id: collectionId,
                    entry_id: id,
                    form_type: currentTab
                }
            });
            showToast("Deleted Successfully!");
            loadData();
       } catch(e) {
            console.error(e);
            showToast("Delete Failed: " + e.message, "error");
       }
    }

    // --- Image Preview Utils ---
    function handleImageUpload(input, targetImgId, smallPreviewId = null) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(targetImgId);
                if(targetImgId === 'previewHeaderBg') {
                    img.style.backgroundImage = `url('${e.target.result}')`;
                } else {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                if (smallPreviewId) {
                    const small = document.getElementById(smallPreviewId);
                    small.src = e.target.result;
                    small.classList.remove('hidden');
                    document.getElementById('logoPlaceholder').classList.add('hidden');
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function updatePreview() {
        const name = document.getElementById('brandName').value;
        const footer = document.getElementById('brandFooter').value;
        const theme = document.getElementById('brandTheme').value;
        const selectedForm = document.getElementById('previewFormSelector').value;

        // Texts
        document.getElementById('prevHeader').textContent = name;
        document.getElementById('prevFooter').textContent = footer;
        document.getElementById('prevSubHeader').textContent = SCHEMAS[selectedForm].title;

        // Theme Colors
        const btn = document.getElementById('prevBtn');
        const screen = document.getElementById('mobileScreen');
        let bgGrad, btnGrad;

        if(theme === 'blue') {
            bgGrad = 'radial-gradient(circle at top left, rgba(59,130,246,0.15), transparent 50%), #0f172a';
            btnGrad = 'from-blue-600 to-indigo-600';
        } else if(theme === 'green') {
            bgGrad = 'radial-gradient(circle at top left, rgba(16,185,129,0.15), transparent 50%), #0f172a';
            btnGrad = 'from-emerald-600 to-teal-600';
        } else if(theme === 'red') {
            bgGrad = 'radial-gradient(circle at top left, rgba(239,68,68,0.15), transparent 50%), #0f172a';
            btnGrad = 'from-red-600 to-rose-600';
        } else { // Orange
            bgGrad = 'radial-gradient(circle at top left, rgba(249,115,22,0.15), transparent 50%), #0f172a';
            btnGrad = 'from-orange-500 to-red-500';
        }

        screen.style.background = bgGrad;
        btn.className = `h-12 bg-gradient-to-r rounded-xl w-full mt-5 shadow-lg flex items-center justify-center text-white font-bold text-sm ${btnGrad}`;

        // Render Form Fields
        const fieldsContainer = document.getElementById('previewFields');
        fieldsContainer.innerHTML = '';
        const previewSchema = SCHEMAS[selectedForm].previewFields || [];

        previewSchema.forEach(f => {
            let innerContent = '';
            if(f.icon === 'fa-camera') {
                innerContent = `
                <div class="border-2 border-dashed border-slate-600/50 rounded-xl h-24 flex flex-col items-center justify-center bg-slate-800/30">
                    <i class="fa-solid fa-camera text-slate-500 mb-1"></i>
                    <span class="text-[10px] text-slate-500">${f.ph}</span>
                </div>`;
            } else {
                innerContent = `
                <div class="relative">
                    <input disabled type="text" placeholder="${f.ph}" class="w-full bg-slate-900/60 border border-slate-700/50 rounded-lg py-3 pl-10 pr-3 text-xs text-slate-400">
                    <i class="fa-solid ${f.icon} absolute left-3 top-3.5 text-slate-500 text-xs"></i>
                </div>`;
            }
            fieldsContainer.innerHTML += innerContent;
        });
    }

    async function copyLink(filename, formType) {
        if(!collectionId) { showToast("Collection ID Missing!", "error"); return; }
        
        const btn = event.currentTarget;
        const origText = btn.innerText;
        btn.innerText = "Generating...";
        btn.disabled = true;

        try {
            // Use Lambda to generate secure token link
            let endpoint = '/political/public/forms'; // Updated path
            let action = formType === 'search' ? 'generate_search_link' : 'generate_form_link';
            let payload = { collection_id: collectionId, days_valid: 30 };
            if(formType !== 'search') payload.form_type = formType;

            const res = await apiCall(endpoint, {
                action: action,
                payload: payload
            });

            const token = res.token;
            if(!token) throw new Error("No token returned");

            const base = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            const link = `${base}/${filename}?token=${encodeURIComponent(token)}`;
            
            navigator.clipboard.writeText(link);
            showToast("Secure Link Copied!");
            btn.innerText = "Copied!";
        } catch(e) {
            console.error(e);
            showToast("Failed to generate link", "error");
            btn.innerText = "Retry";
        } finally {
            btn.disabled = false;
            setTimeout(() => btn.innerText = origText, 2000);
        }
    }
    
    // --- Initial Load Logic ---
    // Moved to the end to ensure SCHEMAS and functions are defined
    if(!collectionId) {
        document.getElementById('cidWarning').classList.remove('hidden');
        document.getElementById('sidebarCidDisplay').textContent = "CID: MISSING";
    } else {
        document.getElementById('sidebarCidDisplay').textContent = `CID: ${collectionId.substring(0,8)}...`;
        // Delay slightly to ensure DOM is ready if needed, though script is at end of body
        setTimeout(() => {
            loadSettings(); 
            loadData();
        }, 100);
    }
  </script>
</body>
</html>
