<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="EventLens Admin"/>
<meta name="theme-color" content="#0f172a"/>
<title>Political Admin Console ‚Äî EventLens</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{--brand:#f97316;--brand2:#ef4444;--bg:#0f172a;--surface:#1e293b;--border:#334155;--muted:#64748b;--text:#f1f5f9;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;min-height:100vh;}
.glass{background:rgba(30,41,59,.7);backdrop-filter:blur(12px);border:1px solid var(--border);}
.glass-dark{background:rgba(15,23,42,.8);backdrop-filter:blur(16px);border:1px solid var(--border);}
input,select,textarea{background:#0f172a;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:14px;width:100%;outline:none;transition:border-color .2s;}
input:focus,select:focus,textarea:focus{border-color:var(--brand);}
.btn{padding:8px 16px;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;border:none;transition:all .18s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--brand);color:#fff;}
.btn-primary:hover{background:#ea580c;}
.btn-secondary{background:rgba(51,65,85,.8);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{background:rgba(71,85,105,.8);}
.btn-danger{background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.3);}
.btn-danger:hover{background:rgba(239,68,68,.3);}
.btn-sm{padding:5px 10px;font-size:12px;}
.tag{padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(249,115,22,.15);color:var(--brand);}
/* Nav */
.nav-btn{transition:all .15s;}
.nav-btn.active{background:rgba(249,115,22,.15);color:var(--brand);border-left:3px solid var(--brand);}
.nav-btn:hover:not(.active){background:rgba(255,255,255,.05);}
/* Sections */
.section-card{background:rgba(30,41,59,.5);border:1px solid var(--border);border-radius:16px;padding:20px;}
/* Asset upload */
.asset-drop{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s;}
.asset-drop:hover{border-color:var(--brand);}
.asset-drop.drag-over{border-color:var(--brand);background:rgba(249,115,22,.05);}
/* Preview */
#brandPreview{position:relative;border-radius:14px;overflow:hidden;min-height:180px;background:#0f172a;border:1px solid var(--border);}
#previewBg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.35;}
#previewContent{position:relative;z-index:2;padding:20px;text-align:center;}
/* Toast */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;pointer-events:none;}
.toast-item{background:#1e293b;border:1px solid var(--border);border-radius:30px;padding:10px 20px;font-size:13px;font-weight:600;margin-bottom:8px;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:slideIn .25s ease;}
@keyframes slideIn{from{transform:translateY(-16px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast-success{border-color:rgba(52,211,153,.4);color:#34d399;}
.toast-error{border-color:rgba(248,113,113,.4);color:#f87171;}
.toast-info{border-color:rgba(249,115,22,.4);color:var(--brand);}
/* Table */
.data-table{width:100%;border-collapse:collapse;font-size:13px;}
.data-table th{padding:10px 12px;text-align:left;background:rgba(15,23,42,.6);color:var(--muted);font-size:11px;text-transform:uppercase;border-bottom:1px solid var(--border);}
.data-table td{padding:10px 12px;border-bottom:1px solid rgba(51,65,85,.4);vertical-align:middle;}
.data-table tr:hover td{background:rgba(255,255,255,.02);}
/* Color swatch */
.color-swatch{width:32px;height:32px;border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;}
.color-swatch input[type=color]{width:200%;height:200%;margin:-25%;border:none;cursor:pointer;}
/* Sidebar */
@media(max-width:768px){
  #sidebar{position:fixed;left:-260px;top:0;bottom:0;z-index:50;width:260px;transition:left .3s;}
  #sidebar.open{left:0;}
  #sidebarOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:49;}
  #sidebarOverlay.show{display:block;}
  #mainContent{margin-left:0!important;}
  #hamburger{display:flex!important;}
}
/* QR */
#qrBox canvas{border-radius:8px;}
/* Image preview strip */
.img-preview-wrap{position:relative;display:inline-block;margin-top:10px;}
.img-preview-wrap img{width:100%;max-height:100px;object-fit:cover;border-radius:8px;}
.img-preview-wrap .clear-btn{position:absolute;top:-6px;right:-6px;width:22px;height:22px;background:rgba(239,68,68,.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;border:none;color:#fff;}
/* Tabs content */
.tab-section{display:none;}
.tab-section.active{display:block;}
/* Responsive grid */
.resp-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
@media(max-width:600px){.resp-grid{grid-template-columns:1fr;}}
/* Program chip */
.prog-chip{display:flex;align-items:center;justify-content:space-between;background:rgba(15,23,42,.6);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;}
/* Scrollable */
.scroll-y{overflow-y:auto;max-height:400px;}
/* Form type label */
.ft-label{font-size:10px;font-weight:700;text-transform:uppercase;padding:2px 7px;border-radius:12px;}
.ft-visitor{background:rgba(99,102,241,.2);color:#818cf8;}
.ft-attendance{background:rgba(52,211,153,.15);color:#34d399;}
.ft-tour{background:rgba(250,204,21,.15);color:#fbbf24;}
.ft-mandal{background:rgba(249,115,22,.15);color:var(--brand);}
.ft-coordinator{background:rgba(168,85,247,.15);color:#c084fc;}
.ft-program{background:rgba(14,165,233,.15);color:#38bdf8;}
</style>
</head>
<body>

<!-- Toast -->
<div id="toast"></div>

<!-- Sidebar Overlay (mobile) -->
<div id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/80 backdrop-blur-sm" style="display:none;">
  <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl mx-4">
    <h3 class="text-lg font-bold text-white mb-2">üîë Access Token Update</h3>
    <p class="text-xs text-slate-400 mb-4">Session expired. Paste new id_token from dashboard.</p>
    <textarea id="authTokenInput" class="w-full h-24 bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs text-slate-300 font-mono mb-4" placeholder="Paste id_token here..."></textarea>
    <div class="flex justify-end gap-3">
      <button class="btn btn-secondary" onclick="closeAuthModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveToken()">Save & Reload</button>
    </div>
  </div>
</div>

<!-- Layout -->
<div class="flex min-h-screen">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 glass-dark flex flex-col" style="min-height:100vh;">
    <div class="p-4 border-b border-slate-800">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-9 h-9 rounded-xl bg-orange-500/20 flex items-center justify-center">
          <i class="fa-solid fa-flag text-orange-400"></i>
        </div>
        <div>
          <div class="font-bold text-white text-sm">Political Admin</div>
          <div class="text-[10px] text-slate-500">EventLens Console</div>
        </div>
        <!-- mobile close -->
        <button class="ml-auto text-slate-400 md:hidden" onclick="closeSidebar()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <!-- CID input -->
      <div class="flex gap-2">
        <input id="cidInput" placeholder="Collection ID" class="text-xs flex-1" style="padding:6px 10px;font-size:11px;"/>
        <button class="btn btn-primary btn-sm" onclick="applyCid()"><i class="fa-solid fa-check"></i></button>
      </div>
      <div id="cidPill" class="hidden mt-2 text-[10px] bg-orange-500/10 text-orange-400 rounded-lg px-2 py-1 font-mono truncate">
        CID: <span id="cidVal"></span>
      </div>
    </div>

    <!-- Form Selector -->
    <div class="p-3 border-b border-slate-800">
      <div class="text-[10px] text-slate-500 uppercase font-bold mb-2">Target Form</div>
      <select id="targetFormSel" class="text-xs" style="padding:6px 10px;font-size:12px;" onchange="onTargetChange()">
        <option value="__defaults__">üåê Global Defaults</option>
        <option value="visitor_form">üè¢ Visitor Form</option>
        <option value="party_attendance">‚úÖ Party Attendance</option>
        <option value="president_tour_form">üö© President Tour</option>
        <option value="mandal_reporting">üìã Mandal Reporting</option>
        <option value="coordinator_form">üë§ Coordinator</option>
        <option value="program_info">üìå Program Info</option>
      </select>
    </div>

    <!-- Nav -->
    <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
      <button class="nav-btn active w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="branding" onclick="switchTab('branding',this)">
        <i class="fa-solid fa-palette text-orange-400 w-4"></i> Branding
      </button>
      <button class="nav-btn w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="programs" onclick="switchTab('programs',this)">
        <i class="fa-solid fa-list-check text-blue-400 w-4"></i> Programs
      </button>
      <button class="nav-btn w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="levels" onclick="switchTab('levels',this)">
        <i class="fa-solid fa-lock text-rose-400 w-4"></i> Level Locks
      </button>
      <button class="nav-btn w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="links" onclick="switchTab('links',this)">
        <i class="fa-solid fa-link text-purple-400 w-4"></i> Links & QR
      </button>
      <button class="nav-btn w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="data" onclick="switchTab('data',this)">
        <i class="fa-solid fa-table text-emerald-400 w-4"></i> Data Records
      </button>
      <button class="nav-btn w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="gallery" onclick="switchTab('gallery',this)">
        <i class="fa-solid fa-images text-pink-400 w-4"></i> Photo Gallery
      </button>
      <button class="nav-btn w-full text-left px-3 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-3" data-tab="analytics" onclick="switchTab('analytics',this)">
        <i class="fa-solid fa-chart-pie text-purple-400 w-4"></i> Analytics
      </button>
    </nav>

    <div class="p-3 border-t border-slate-800 space-y-2">
      <button class="btn btn-secondary w-full text-xs" onclick="loadConfig()"><i class="fa-solid fa-rotate-right"></i> Reload Config</button>
      <button class="btn btn-secondary w-full text-xs" onclick="openAuthModal()"><i class="fa-solid fa-key"></i> Update Token</button>
    </div>
  </aside>

  <!-- Main -->
  <main id="mainContent" class="flex-1 p-4 md:p-6 overflow-auto" style="margin-left:0;">

    <!-- Topbar -->
    <div class="flex items-center gap-3 mb-6">
      <button id="hamburger" class="hidden btn btn-secondary btn-sm" style="display:none;" onclick="openSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <h1 class="text-xl font-bold text-white flex-1">Political Admin Console</h1>
      <div class="flex gap-2">
        <button class="btn btn-secondary btn-sm" onclick="saveConfig()"><i class="fa-solid fa-floppy-disk"></i> <span class="hidden sm:inline">Save</span></button>
        <button class="btn btn-primary btn-sm" onclick="openPreviewTab()"><i class="fa-solid fa-eye"></i> <span class="hidden sm:inline">Preview</span></button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê TAB: BRANDING ‚ïê‚ïê‚ïê -->
    <section id="tab-branding" class="tab-section active space-y-5">
      
      <!-- Live Preview -->
      <div class="section-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-white">Live Preview</h2>
          <div class="flex gap-2 items-center">
            <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
              <input type="checkbox" id="livePreviewToggle" checked onchange="renderPreview()" class="accent-orange-500"/>
              Live
            </label>
          </div>
        </div>
        <div id="brandPreview">
          <div id="previewBg"></div>
          <div id="previewContent">
            <div id="prev_logo_wrap" class="inline-flex w-14 h-14 rounded-full items-center justify-center mb-3 overflow-hidden border-2 border-white/20" style="background:rgba(249,115,22,.15);">
              <i id="prev_logo_icon" class="fa-solid fa-flag text-orange-400 text-2xl"></i>
              <img id="prev_logo_img" class="w-full h-full object-cover hidden" src="" alt=""/>
            </div>
            <div id="prev_title" class="font-bold text-white text-lg"></div>
            <div id="prev_subtitle" class="text-slate-300 text-sm mt-1"></div>
            <div id="prev_tagline" class="text-slate-400 text-xs mt-1"></div>
          </div>
          <div id="prev_header_wrap" class="hidden absolute top-0 left-0 right-0 h-20 bg-cover bg-center" style="z-index:1;"></div>
          <div id="prev_footer" class="text-center text-xs text-slate-500 mt-3 pb-3 relative z-10"></div>
        </div>
      </div>

      <!-- Text Branding -->
      <div class="section-card space-y-4">
        <h2 class="font-bold text-white">Text & Colors</h2>
        <div class="resp-grid">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Title (Form heading)</label>
            <input id="b_title" placeholder="e.g. ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§ó‡§Ç‡§§‡•Å‡§ï ‡§´‡•â‡§∞‡•ç‡§Æ" oninput="renderPreview()"/>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Subtitle</label>
            <input id="b_subtitle" placeholder="e.g. Visitor Entry System" oninput="renderPreview()"/>
          </div>
        </div>
        <div class="resp-grid">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Tagline</label>
            <input id="b_tagline" placeholder="e.g. ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä" oninput="renderPreview()"/>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Footer Text</label>
            <input id="b_footer" placeholder="e.g. Powered by BJP IT Cell" oninput="renderPreview()"/>
          </div>
        </div>
        <div class="flex gap-6 items-center">
          <div>
            <label class="block text-xs text-slate-400 mb-2">Primary Color</label>
            <div class="color-swatch"><input type="color" id="b_c1" value="#f97316" oninput="renderPreview()"/></div>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-2">Secondary Color</label>
            <div class="color-swatch"><input type="color" id="b_c2" value="#ef4444" oninput="renderPreview()"/></div>
          </div>
          <div class="flex-1 text-xs text-slate-500">Colors apply as gradient across all forms.</div>
        </div>
      </div>

      <!-- Logo -->
      <div class="section-card space-y-3">
        <h2 class="font-bold text-white">Logo</h2>
        <div class="resp-grid">
          <div>
            <div id="logo-drop" class="asset-drop" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropAsset(event,'logo')" onclick="document.getElementById('logo-file').click()">
              <i class="fa-solid fa-image text-slate-500 text-2xl mb-2"></i>
              <div class="text-xs text-slate-400">Click or drag logo here</div>
              <div class="text-[10px] text-slate-600 mt-1">PNG/JPG ¬∑ Square recommended ¬∑ 200√ó200px</div>
              <input type="file" id="logo-file" accept="image/*" class="hidden" onchange="assetPicked(event,'logo')"/>
            </div>
            <div class="img-preview-wrap hidden" id="logo-preview-wrap">
              <img id="logo-preview" src="" alt="" class="w-full"/>
              <button class="clear-btn" onclick="clearAsset('logo')"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="text-xs text-slate-400 self-center">
            <p class="mb-2">Logo appears in the form header circle.</p>
            <p class="text-slate-500">If no logo uploaded, default icon shows.</p>
          </div>
        </div>
      </div>

      <!-- Header Image -->
      <div class="section-card space-y-3">
        <h2 class="font-bold text-white">Header Image</h2>
        <div class="resp-grid">
          <div>
            <div id="header-drop" class="asset-drop" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropAsset(event,'header')" onclick="document.getElementById('header-file').click()">
              <i class="fa-solid fa-panorama text-slate-500 text-2xl mb-2"></i>
              <div class="text-xs text-slate-400">Click or drag header image</div>
              <div class="text-[10px] text-slate-600 mt-1">Wide image ¬∑ 16:9 or 3:1 ratio ¬∑ 1200√ó400px</div>
              <input type="file" id="header-file" accept="image/*" class="hidden" onchange="assetPicked(event,'header')"/>
            </div>
            <div class="img-preview-wrap hidden" id="header-preview-wrap">
              <img id="header-preview" src="" alt="" style="max-height:80px;width:100%;object-fit:cover;border-radius:8px;"/>
              <button class="clear-btn" onclick="clearAsset('header')"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="text-xs text-slate-400 self-center">
            <p class="mb-2">Displayed at top of form as a banner.</p>
          </div>
        </div>
      </div>

      <!-- Background Image -->
      <div class="section-card space-y-3">
        <h2 class="font-bold text-white">Background Image</h2>
        <div class="resp-grid">
          <div>
            <div id="bg-drop" class="asset-drop" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropAsset(event,'background')" onclick="document.getElementById('bg-file').click()">
              <i class="fa-solid fa-image text-slate-500 text-2xl mb-2"></i>
              <div class="text-xs text-slate-400">Click or drag background image</div>
              <div class="text-[10px] text-slate-600 mt-1">Full page background ¬∑ 1080√ó1920px recommended</div>
              <input type="file" id="bg-file" accept="image/*" class="hidden" onchange="assetPicked(event,'background')"/>
            </div>
            <div class="img-preview-wrap hidden" id="bg-preview-wrap">
              <img id="bg-preview" src="" alt="" style="max-height:80px;width:100%;object-fit:cover;border-radius:8px;"/>
              <button class="clear-btn" onclick="clearAsset('background')"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="text-xs text-slate-400 self-center">
            <p class="mb-2">Shown as full-page background with opacity overlay.</p>
            <div class="mt-2">
              <label class="block text-xs text-slate-400 mb-1">Opacity (0‚Äì100)</label>
              <input type="range" id="b_bg_opacity" min="0" max="100" value="35" oninput="renderPreview()" class="w-full accent-orange-500"/>
              <div class="text-right text-[10px] text-slate-500"><span id="opacityVal">35</span>%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="flex gap-3 flex-wrap">
        <button class="btn btn-primary" onclick="saveConfig()"><i class="fa-solid fa-floppy-disk"></i> Save Branding</button>
        <button class="btn btn-secondary" onclick="loadConfig()"><i class="fa-solid fa-rotate-right"></i> Reload from Server</button>
        <button class="btn btn-secondary" onclick="copyToAllForms()"><i class="fa-solid fa-copy"></i> Copy to All Forms</button>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê TAB: PROGRAMS ‚ïê‚ïê‚ïê -->
    <section id="tab-programs" class="tab-section space-y-5">
      <div class="section-card">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="font-bold text-white">Program Names</h2>
          <div class="flex gap-2 items-center">
            <select id="progScopeSel" class="text-xs" style="padding:5px 10px;width:auto;" onchange="renderPrograms()">
              <option value="form">Current Form</option>
              <option value="defaults">Global Defaults</option>
            </select>
          </div>
        </div>
        <div class="text-xs text-slate-400 mb-4 p-3 bg-slate-900/50 rounded-lg">
          <i class="fa-solid fa-circle-info text-orange-400 mr-1"></i>
          Programs set here will appear as dropdown options in the selected form. "Global Defaults" apply to all forms unless overridden.
        </div>
        <div class="flex gap-2 mb-4">
          <input id="newProgInput" placeholder="‡§®‡§Ø‡§æ program ‡§®‡§æ‡§Æ (e.g. ‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï)" class="flex-1"/>
          <button class="btn btn-primary" onclick="addProgram()"><i class="fa-solid fa-plus"></i> Add</button>
        </div>
        <div id="progList" class="space-y-2 scroll-y"></div>
        <div class="mt-4 flex gap-2 flex-wrap">
          <button class="btn btn-secondary btn-sm" onclick="addDefaultPrograms()"><i class="fa-solid fa-wand-magic-sparkles"></i> Add Defaults</button>
          <button class="btn btn-danger btn-sm" onclick="clearPrograms()"><i class="fa-solid fa-trash"></i> Clear All</button>
          <button class="btn btn-primary btn-sm" onclick="saveConfig()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        </div>
      </div>

      <div class="section-card">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="font-bold text-white">Common Programs (Mandal / Coordinator / Program Info)</h2>
          <div class="text-xs text-slate-400">‡§á‡§® 3 forms ‡§Æ‡•á‡§Ç common program list + prefill/lock</div>
        </div>

        <div class="text-xs text-slate-400 mb-4 p-3 bg-slate-900/50 rounded-lg">
          <i class="fa-solid fa-circle-info text-orange-400 mr-1"></i>
          ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã programs add ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§µ‡•ã ‡§∏‡§ø‡§∞‡•ç‡§´ Mandal Reporting, Coordinator ‡§î‡§∞ Program Info ‡§Æ‡•á‡§Ç dropdown ‡§Æ‡•á‡§Ç ‡§Ü‡§è‡§Ç‡§ó‡•á‡•§
        </div>

        <div class="flex gap-2 mb-4 flex-wrap">
          <input id="newCommonProgInput" placeholder="‡§®‡§Ø‡§æ common program (e.g. ‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï)" class="flex-1"/>
          <button class="btn btn-primary" onclick="addCommonProgram()"><i class="fa-solid fa-plus"></i> Add</button>
          <button class="btn btn-secondary btn-sm" onclick="syncCommonFromGlobal()"><i class="fa-solid fa-arrow-rotate-right"></i> Sync from Global</button>
          <button class="btn btn-danger btn-sm" onclick="clearCommonPrograms()"><i class="fa-solid fa-trash"></i> Clear</button>
          <button class="btn btn-primary btn-sm" onclick="saveConfig()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        </div>

        <div id="commonProgList" class="space-y-2 scroll-y"></div>

        <div class="mt-5 grid md:grid-cols-3 gap-3">
          <div class="p-3 rounded-xl bg-slate-900/40 border border-slate-800/70">
            <div class="text-sm font-semibold text-white mb-2">Mandal Reporting</div>
            <div class="flex items-center gap-2">
              <select id="fixedProg_mandal_reporting" class="text-xs flex-1" style="padding:6px 10px;width:auto;"></select>
              <label class="flex items-center gap-2 text-xs text-slate-300">
                <input type="checkbox" id="lockProg_mandal_reporting" onchange="applyProgramLocksFromUI()"/>
                Lock
              </label>
            </div>
            <div class="text-[11px] text-slate-400 mt-2">Lock ON ‡§π‡•ã‡§®‡•á ‡§™‡§∞ form ‡§Æ‡•á‡§Ç program field read-only ‡§π‡•ã‡§ó‡§æ‡•§</div>
          </div>

          <div class="p-3 rounded-xl bg-slate-900/40 border border-slate-800/70">
            <div class="text-sm font-semibold text-white mb-2">Coordinator</div>
            <div class="flex items-center gap-2">
              <select id="fixedProg_coordinator_form" class="text-xs flex-1" style="padding:6px 10px;width:auto;"></select>
              <label class="flex items-center gap-2 text-xs text-slate-300">
                <input type="checkbox" id="lockProg_coordinator_form" onchange="applyProgramLocksFromUI()"/>
                Lock
              </label>
            </div>
            <div class="text-[11px] text-slate-400 mt-2">Coordinator form key: coordinator_form (alias works for coordinator_entry).</div>
          </div>

          <div class="p-3 rounded-xl bg-slate-900/40 border border-slate-800/70">
            <div class="text-sm font-semibold text-white mb-2">Program Info</div>
            <div class="flex items-center gap-2">
              <select id="fixedProg_program_info" class="text-xs flex-1" style="padding:6px 10px;width:auto;"></select>
              <label class="flex items-center gap-2 text-xs text-slate-300">
                <input type="checkbox" id="lockProg_program_info" onchange="applyProgramLocksFromUI()"/>
                Lock
              </label>
            </div>
          </div>
        </div>
      </div>


    </section>

    <!-- ‚ïê‚ïê‚ïê TAB: LEVEL LOCKS ‚ïê‚ïê‚ïê -->
    <section id="tab-levels" class="tab-section space-y-5">
      <div class="section-card">
        <h2 class="font-bold text-white mb-2">Hierarchical Level Locks</h2>
        <p class="text-xs text-slate-400 mb-5 p-3 bg-slate-900/50 rounded-lg">
          <i class="fa-solid fa-lock text-rose-400 mr-1"></i>
          Level lock ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ form ‡§Æ‡•á‡§Ç ‡§µ‡§π field read-only ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä ‡§î‡§∞ user ‡§â‡§∏‡•á change ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§™‡§æ‡§è‡§ó‡§æ‡•§
          ‡§Ø‡§π setting per-form ‡§π‡•à‡•§
        </p>
        <div class="grid md:grid-cols-2 gap-4" id="levelLocksGrid">
          <!-- rendered by JS -->
        </div>
        <div class="mt-4">
          <button class="btn btn-primary" onclick="saveConfig()"><i class="fa-solid fa-floppy-disk"></i> Save Level Locks</button>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê TAB: LINKS & QR ‚ïê‚ïê‚ïê -->
    <section id="tab-links" class="tab-section space-y-5">
      <div class="section-card">
        <h2 class="font-bold text-white mb-4">Generate Form Links & QR Codes</h2>
        
        <div class="resp-grid mb-4">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Form Type</label>
            <select id="lnk_form_type" class="text-sm">
              <option value="visitor_form">Visitor Form</option>
              <option value="party_attendance">Party Attendance</option>
              <option value="president_tour_form">President Tour</option>
              <option value="mandal_reporting">Mandal Reporting</option>
              <option value="coordinator_form">Coordinator</option>
              <option value="program_info">Program Info</option>
              <option value="search">Political Search</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Validity</label>
            <select id="lnk_days">
              <option value="30">30 ‡§¶‡§ø‡§®</option>
              <option value="365">1 ‡§∏‡§æ‡§≤</option>
              <option value="1825">5 ‡§∏‡§æ‡§≤</option>
              <option value="3650" selected>10 ‡§∏‡§æ‡§≤ (Permanent)</option>
            </select>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-xs text-slate-400 mb-1">Base URL (form file location)</label>
          <input id="lnk_base_url" placeholder="https://yoursite.com/political_visitor_form.html" value=""/>
        </div>

        <button class="btn btn-primary" onclick="generateLink()"><i class="fa-solid fa-link"></i> Generate Link</button>
        
        <div id="lnkResult" class="hidden mt-4 p-4 bg-slate-900/60 rounded-xl border border-slate-700 space-y-3">
          <div class="flex items-center gap-2 flex-wrap">
            <input id="lnkFinalUrl" readonly class="flex-1 font-mono text-xs text-orange-400" style="background:rgba(0,0,0,.3);border-color:rgba(249,115,22,.3);"/>
            <button class="btn btn-secondary btn-sm" onclick="copyLink('lnkFinalUrl')"><i class="fa-regular fa-copy"></i></button>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-secondary btn-sm" onclick="showQR('lnkFinalUrl','qrBox')"><i class="fa-solid fa-qrcode"></i> Show QR</button>
            <button class="btn btn-secondary btn-sm" onclick="saveToHistory()"><i class="fa-solid fa-bookmark"></i> Save Link</button>
          </div>
          <div id="qrBox" class="bg-white inline-block p-2 rounded-lg hidden"></div>
          <button class="btn btn-secondary btn-sm hidden" id="qrDownloadBtn" onclick="downloadQR('qrBox')"><i class="fa-solid fa-download"></i> Download QR</button>
        </div>
      </div>

      <!-- Saved Links -->
      <div class="section-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-white">Saved Links</h2>
          <button class="btn btn-danger btn-sm" onclick="clearLinkHistory()"><i class="fa-solid fa-trash"></i> Clear All</button>
        </div>
        <div id="linkHistoryList" class="space-y-2 scroll-y"></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê TAB: DATA RECORDS ‚ïê‚ïê‚ïê -->
    <section id="tab-data" class="tab-section space-y-5">
      <div class="section-card">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <h2 class="font-bold text-white flex-1">Data Records</h2>
          <div class="flex flex-wrap gap-2">
            <!-- Form Type Filter -->
            <select id="dataFormTypeFilter" class="text-xs" style="padding:5px 10px;width:auto;" onchange="loadData(true)">
              <option value="all">‡§∏‡§≠‡•Ä Forms</option>
              <option value="visitor_form">Visitor</option>
              <option value="party_attendance">Attendance</option>
              <option value="president_tour_form">Tour</option>
              <option value="mandal_reporting">Mandal</option>
              <option value="coordinator_form">Coordinator</option>
              <option value="program_info">Program Info</option>
              <option value="program_common">Programs (Mandal+Coordinator+Info)</option>
            </select>
            <!-- Date range -->
            <input type="date" id="dataStartDate" class="text-xs" style="padding:5px 8px;width:130px;"/>
            <input type="date" id="dataEndDate" class="text-xs" style="padding:5px 8px;width:130px;"/>
            <button class="btn btn-primary btn-sm" onclick="loadData(true)"><i class="fa-solid fa-search"></i> Load</button>
            <button class="btn btn-secondary btn-sm" onclick="exportDataCSV()"><i class="fa-solid fa-download"></i> CSV</button>
          </div>
        </div>
        <!-- Search -->
        <input id="dataSearch" placeholder="Search by name, mobile, district..." class="mb-4 text-sm" oninput="filterDataTable()"/>
        <!-- Stats -->
        <div id="dataStats" class="flex flex-wrap gap-3 mb-4 text-xs"></div>
        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="data-table" id="dataTable">
            <thead>
              <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Mobile</th>
                <th>Form Type</th>
                <th>Program</th>
                <th>District</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <tr><td colspan="7" class="text-center text-slate-500 py-8">Load data ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ä‡§™‡§∞ filter set ‡§ï‡§∞‡•á‡§Ç‡•§</td></tr>
            </tbody>
          </table>
        </div>
        <div class="flex gap-3 mt-4">
          <button class="btn btn-secondary btn-sm hidden" id="dataLoadMoreBtn" onclick="loadData(false)">Load More</button>
          <div class="text-xs text-slate-500 self-center" id="dataCountLabel"></div>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê TAB: GALLERY ‚ïê‚ïê‚ïê -->
    <section id="tab-gallery" class="tab-section space-y-5">
      <div class="section-card">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="font-bold text-white">Photo Gallery</h2>
          <div class="flex gap-2">
            <select id="galFormFilter" class="text-xs" style="padding:5px 10px;width:auto;">
              <option value="">All Forms</option>
              <option value="visitor_form">Visitor</option>
              <option value="party_attendance">Attendance</option>
              <option value="president_tour_form">Tour</option>
              <option value="mandal_reporting">Mandal</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="loadGallery(true)"><i class="fa-solid fa-search"></i> Load</button>
          </div>
        </div>
        <div id="galGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
          <div class="col-span-4 text-center text-slate-500 py-8 text-sm">Click Load to fetch photos.</div>
        </div>
        <button class="btn btn-secondary btn-sm mt-4 hidden" id="galLoadMoreBtn" onclick="loadGallery(false)">Load More</button>
      </div>
      <!-- Slideshow overlay -->
      <div id="slideOverlay" class="fixed inset-0 z-50 bg-black/95 hidden flex items-center justify-center">
        <button class="absolute top-4 right-4 text-white text-2xl" onclick="closeSlide()"><i class="fa-solid fa-xmark"></i></button>
        <button class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-2xl" onclick="prevSlide()"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="absolute right-14 top-1/2 -translate-y-1/2 text-white text-2xl" onclick="nextSlide()"><i class="fa-solid fa-chevron-right"></i></button>
        <img id="slideImg" class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg" src="" alt=""/>
        <div id="slideCaption" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-xs text-slate-400 bg-black/60 px-4 py-2 rounded-full"></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê TAB: ANALYTICS ‚ïê‚ïê‚ïê -->
    <section id="tab-analytics" class="tab-section space-y-5">
      <div class="section-card">
        <h2 class="font-bold text-white mb-4">Analytics Overview</h2>
        <button class="btn btn-primary btn-sm mb-4" onclick="loadAnalytics()"><i class="fa-solid fa-chart-bar"></i> Load Analytics</button>
        <div id="analyticsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <!-- KPI cards -->
        </div>
        <div id="analyticsCharts" class="grid md:grid-cols-2 gap-5">
          <div class="section-card" style="padding:16px;">
            <div class="text-sm font-bold text-white mb-3">By Form Type</div>
            <div id="chartByForm" class="space-y-2"></div>
          </div>
          <div class="section-card" style="padding:16px;">
            <div class="text-sm font-bold text-white mb-3">By District</div>
            <div id="chartByDistrict" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Entry Detail Modal -->
<div id="entryModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm" style="display:none;">
  <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg mx-4 overflow-hidden shadow-2xl">
    <div class="flex items-center justify-between px-5 py-4 border-b border-slate-800">
      <h3 class="font-bold text-white">Entry Details</h3>
      <button class="text-slate-400 hover:text-white" onclick="closeEntryModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="p-5 overflow-auto max-h-[70vh]">
      <div id="entryModalContent"></div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POL_API = 'https://vxid0yoovj.execute-api.ap-south-1.amazonaws.com/prod';
const FORMS_URL = `${POL_API}/political/forms`;

const FORM_META = {
  __defaults__: { label:'Global Defaults', file:'political_visitor_form.html', icon:'üåê' },
  visitor_form: { label:'Visitor Form', file:'political_visitor_form.html', icon:'üè¢' },
  party_attendance: { label:'Party Attendance', file:'political_party_attendance_form.html', icon:'‚úÖ' },
  president_tour_form: { label:'President Tour', file:'political_president_tour_form.html', icon:'üö©' },
  mandal_reporting: { label:'Mandal Reporting', file:'political_mandal_reporting_form.html', icon:'üìã' },
  coordinator_form: { label:'Coordinator', file:'political_coordinator_entry_form.html', icon:'üë§' },
  program_info: { label:'Program Info', file:'political_program_info_form.html', icon:'üìå' },
};

const DEFAULT_CONFIG = {
  defaults: {
    branding: {
      title:'Political Forms', subtitle:'Visitor Entry System', tagline:'', footer_text:'Powered by EventLens',
      color1:'#f97316', color2:'#ef4444',
      logo:{ kind:'none' }, header:{ kind:'none' }, background:{ kind:'none' }, bg_opacity:35
    },
    programs:['‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï','‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡•ç‡§Æ‡•á‡§≤‡§®','‡§ú‡§®‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï','‡§¨‡•Ç‡§• ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó','‡§ö‡•Å‡§®‡§æ‡§µ ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£'],
    fixed_levels:{}
  },
  forms:{
    visitor_form:{ title:'‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§ó‡§Ç‡§§‡•Å‡§ï ‡§´‡•â‡§∞‡•ç‡§Æ', subtitle:'Visitor Entry System', tagline:'', footer_text:'', fixed_level:'', program_options:[], branding:{} },
    party_attendance:{ title:'‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø', subtitle:'Attendance', tagline:'', footer_text:'', fixed_level:'', program_options:[], branding:{} },
    president_tour_form:{ title:'‡§™‡•ç‡§∞‡•á‡§∏‡§ø‡§°‡•á‡§Ç‡§ü ‡§ü‡•Ç‡§∞', subtitle:'Tour', tagline:'', footer_text:'', fixed_level:'', program_options:[], branding:{} },
    mandal_reporting:{ title:'‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó', subtitle:'Reporting', tagline:'', footer_text:'', fixed_level:'', program_options:[], branding:{} },
    coordinator_form:{ title:'‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø', subtitle:'Coordinator Entry', tagline:'', footer_text:'', fixed_level:'', program_options:[], branding:{} },
    program_info:{ title:'‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§á‡§®‡•ç‡§´‡•ã', subtitle:'Program Information', tagline:'', footer_text:'', fixed_level:'', program_options:[], branding:{} },
  }
};

const DEFAULT_PROGRAMS = ['‡§Æ‡§Ç‡§°‡§≤ ‡§¨‡•à‡§†‡§ï','‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡•ç‡§Æ‡•á‡§≤‡§®','‡§ú‡§®‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï','‡§¨‡•Ç‡§• ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó','‡§ö‡•Å‡§®‡§æ‡§µ ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£','‡§™‡•ç‡§∞‡•á‡§∏ ‡§ï‡•â‡§®‡•ç‡§´‡•ç‡§∞‡•á‡§Ç‡§∏','‡§∂‡§ï‡•ç‡§§‡§ø ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§¨‡•à‡§†‡§ï'];

const LEVEL_OPTIONS = [
  { value:'', label:'üîì Unlocked (User ‡§ö‡•Å‡§®‡•á)' },
  { value:'district', label:'üìç District Fixed' },
  { value:'vidhansabha', label:'üó≥Ô∏è Vidhan Sabha Fixed' },
  { value:'mandal', label:'üèòÔ∏è Mandal Fixed' },
];

let state = {
  cid: (new URLSearchParams(location.search)).get('cid') || '',
  target: 'visitor_form',
  config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
  pendingAssets: {}, // { formType: { logo:{file,previewUrl}, header:{...}, background:{...} } }
  dataItems: [], dataFiltered: [], dataNextKey: null,
  galPhotos: [], galNextKey: null, galSlideIdx: 0,
};

// ‚ïê‚ïê UTILS ‚ïê‚ïê
const $i = id => document.getElementById(id);
function toast(msg, type='info', dur=3000) {
  const t = $i('toast');
  const el = document.createElement('div');
  el.className = `toast-item toast-${type}`;
  el.textContent = msg;
  t.appendChild(el);
  setTimeout(() => { el.style.opacity='0'; el.style.transform='translateY(-10px)'; el.style.transition='all .3s'; setTimeout(()=>el.remove(),300); }, dur);
}
function deepMerge(base, over) {
  const out = Array.isArray(base) ? [...base] : {...base};
  Object.keys(over||{}).forEach(k => {
    if(Array.isArray(over[k])) out[k] = over[k];
    else if(over[k]&&typeof over[k]==='object'&&!Array.isArray(over[k])&&out[k]&&typeof out[k]==='object') out[k] = deepMerge(out[k], over[k]);
    else out[k] = over[k];
  });
  return out;
}
function getIdToken(){ return localStorage.getItem('id_token') || localStorage.getItem('idToken') || ''; }
function ft(){ return $i('targetFormSel').value || 'visitor_form'; }

// ‚ïê‚ïê SIDEBAR (mobile) ‚ïê‚ïê
function openSidebar(){ $i('sidebar').classList.add('open'); $i('sidebarOverlay').classList.add('show'); }
function closeSidebar(){ $i('sidebar').classList.remove('open'); $i('sidebarOverlay').classList.remove('show'); }

// ‚ïê‚ïê AUTH MODAL ‚ïê‚ïê
function openAuthModal(){ $i('authModal').style.display='flex'; }
function closeAuthModal(){ $i('authModal').style.display='none'; }
function saveToken(){
  const t = $i('authTokenInput').value.trim();
  if(!t){ toast('Token empty','error'); return; }
  localStorage.setItem('idToken', t);
  closeAuthModal();
  loadConfig();
}

// ‚ïê‚ïê CID ‚ïê‚ïê
function applyCid(){
  state.cid = $i('cidInput').value.trim();
  if(!state.cid){ toast('Collection ID enter ‡§ï‡§∞‡•á‡§Ç','error'); return; }
  $i('cidPill').classList.remove('hidden');
  $i('cidVal').textContent = state.cid;
  try{ localStorage.setItem('EL_ADMIN_CID', state.cid); }catch(e){}
  loadConfig();
}

// ‚ïê‚ïê TAB SWITCHING ‚ïê‚ïê
function switchTab(tabId, btn) {
  document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  $i('tab-' + tabId)?.classList.add('active');
  if(btn) btn.classList.add('active');
  closeSidebar();
  if(tabId==='data' && state.dataItems.length===0 && state.cid) loadData(true);
  if(tabId==='analytics' && state.cid) loadAnalytics();
  if(tabId==='gallery' && state.galPhotos.length===0 && state.cid) loadGallery(true);
  if(tabId==='programs'){ renderPrograms(); renderCommonPrograms(); hydrateProgramLocksToUI(); }
  if(tabId==='levels') renderLevelLocks();
  if(tabId==='links') renderLinkHistory();
}

// ‚ïê‚ïê TARGET FORM CHANGE ‚ïê‚ïê
function onTargetChange(){
  state.target = ft();
  renderPreview();
  populateFieldsFromConfig();
  renderPrograms();
  renderCommonPrograms();
  hydrateProgramLocksToUI();
  renderLevelLocks();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiCall(action, payload) {
  const token = getIdToken();
  const headers = { 'Content-Type':'application/json' };
  if(token) headers['Authorization'] = `Bearer ${token}`;
  const resp = await fetch(FORMS_URL, {
    method:'POST', cache:'no-store', headers,
    body: JSON.stringify({ action, payload: payload||{} })
  });
  if(resp.status===401){ openAuthModal(); throw new Error('Unauthorized'); }
  const txt = await resp.text();
  let json = {};
  try{ json = JSON.parse(txt); }catch(e){ json = { message: txt }; }
  if(!resp.ok) throw new Error(json.message || `HTTP ${resp.status}`);
  return json;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG LOAD / SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadConfig() {
  if(!state.cid){ toast('Collection ID ‡§°‡§æ‡§≤‡•á‡§Ç ‡§™‡§π‡§≤‡•á','error'); return; }
  toast('Loading config...','info');
  try {
    const res = await apiCall('admin_get_config', {
      collection_id: state.cid,
      config_type: 'political_forms'
    });
    const cfg = res.config || res.settings || res.data || null;
    if(cfg) {
      state.config = deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), cfg);
      try{ localStorage.setItem('EL_CFG_'+state.cid, JSON.stringify(state.config)); }catch(e){}
    }
    populateFieldsFromConfig();
    renderPreview();
    renderPrograms();
    renderCommonPrograms();
    hydrateProgramLocksToUI();
    renderLevelLocks();
    toast('Config loaded ‚úì','success');
  } catch(e) {
    // Try local cache
    try{
      const local = localStorage.getItem('EL_CFG_'+state.cid);
      if(local){ state.config = deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), JSON.parse(local)); populateFieldsFromConfig(); renderPreview(); }
    }catch(e2){}
    toast('Load failed: '+e.message,'error');
  }
}

async function saveConfig() {
  if(!state.cid){ toast('Collection ID ‡§°‡§æ‡§≤‡•á‡§Ç','error'); return; }
  
  // Collect current form's values from UI
  collectUIIntoConfig();
  
  // Upload any pending assets first
  await uploadPendingAssets();
  
  toast('Saving...','info');
  try {
    await apiCall('admin_save_config', {
      collection_id: state.cid,
      config_type: 'political_forms',
      settings: state.config,
      config: state.config,
    });
    try{ localStorage.setItem('EL_CFG_'+state.cid, JSON.stringify(state.config)); }catch(e){}
    // Ping forms to reload branding
    try{ localStorage.setItem('EL_BRAND_PING_'+state.cid, String(Date.now())); }catch(e){}
    toast('Saved successfully ‚úì','success');
    // Reload to get fresh presigned URLs
    setTimeout(()=>loadConfig(),800);
  } catch(e) {
    toast('Save failed: '+e.message,'error');
  }
}

function collectUIIntoConfig() {
  const target = ft();
  const isDefaults = target === '__defaults__';
  
  const title = ($i('b_title')?.value||'').trim();
  const subtitle = ($i('b_subtitle')?.value||'').trim();
  const tagline = ($i('b_tagline')?.value||'').trim();
  const footer = ($i('b_footer')?.value||'').trim();
  const c1 = $i('b_c1')?.value || '#f97316';
  const c2 = $i('b_c2')?.value || '#ef4444';
  const bgOpacity = parseInt($i('b_bg_opacity')?.value || '35');

  if(isDefaults){
    const db = state.config.defaults.branding;
    if(title) db.title = title;
    if(subtitle) db.subtitle = subtitle;
    if(tagline) db.tagline = tagline;
    if(footer) db.footer_text = footer;
    db.color1 = c1; db.color2 = c2; db.bg_opacity = bgOpacity;
    state.config.global = state.config.global || {};
    state.config.global.tagline = tagline;
  } else {
    const f = state.config.forms[target] = state.config.forms[target] || {};
    f.title = title; f.subtitle = subtitle; f.tagline = tagline; f.footer_text = footer;
    f.branding = f.branding || {};
    f.branding.color1 = c1; f.branding.color2 = c2; f.branding.bg_opacity = bgOpacity;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPULATE FIELDS FROM STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateFieldsFromConfig() {
  const target = ft();
  const isDefaults = (target === '__defaults__');
  const defs = state.config.defaults || {};
  const db = defs.branding || {};
  const form = (!isDefaults && state.config.forms[target]) ? state.config.forms[target] : {};
  const fb = form.branding || {};
  
  // Merge: defaults first, then form-specific override
  const merged = deepMerge(db, fb);
  
  $i('b_title').value = form.title || merged.title || db.title || '';
  $i('b_subtitle').value = form.subtitle || merged.subtitle || db.subtitle || '';
  $i('b_tagline').value = form.tagline || merged.tagline || db.tagline || '';
  $i('b_footer').value = form.footer_text || merged.footer_text || db.footer_text || 'Powered by EventLens';
  $i('b_c1').value = merged.color1 || db.color1 || '#f97316';
  $i('b_c2').value = merged.color2 || db.color2 || '#ef4444';
  const opa = merged.bg_opacity ?? db.bg_opacity ?? 35;
  $i('b_bg_opacity').value = opa;
  $i('opacityVal').textContent = opa;

  // Asset previews
  const logoUrl = form.logo_url || merged.logo?.url || '';
  const headerUrl = form.header_url || merged.header?.url || '';
  const bgUrl = form.background_url || merged.background?.url || '';

  setAssetPreview('logo', logoUrl);
  setAssetPreview('header', headerUrl);
  setAssetPreview('background', bgUrl);
  
  renderPreview();
}

function setAssetPreview(kind, url) {
  const wrap = $i(`${kind}-preview-wrap`);
  const img = $i(`${kind}-preview`);
  if(!wrap || !img) return;
  if(url){ img.src = url; wrap.classList.remove('hidden'); }
  else{ img.src=''; wrap.classList.add('hidden'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREVIEW RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPreview() {
  if(!$i('livePreviewToggle')?.checked) return;
  
  const c1 = $i('b_c1')?.value || '#f97316';
  const c2 = $i('b_c2')?.value || '#ef4444';
  const title = $i('b_title')?.value || '';
  const subtitle = $i('b_subtitle')?.value || '';
  const tagline = $i('b_tagline')?.value || '';
  const footer = $i('b_footer')?.value || 'Powered by EventLens';
  const opa = parseInt($i('b_bg_opacity')?.value || '35') / 100;
  $i('opacityVal').textContent = Math.round(opa*100);
  
  // Title color from gradient
  if($i('prev_title')) { $i('prev_title').textContent = title; $i('prev_title').style.background = `linear-gradient(90deg,${c1},${c2})`; $i('prev_title').style.webkitBackgroundClip='text'; $i('prev_title').style.webkitTextFillColor='transparent'; }
  if($i('prev_subtitle')) $i('prev_subtitle').textContent = subtitle;
  if($i('prev_tagline')) { $i('prev_tagline').textContent = tagline; $i('prev_tagline').style.display = tagline?'':'none'; }
  if($i('prev_footer')) $i('prev_footer').textContent = footer;
  
  // Logo
  const target = ft();
  const pend = state.pendingAssets[target] || {};
  const logoSrc = pend.logo?.previewUrl || getEffectiveAssetUrl('logo');
  if(logoSrc){ $i('prev_logo_img').src=logoSrc; $i('prev_logo_img').classList.remove('hidden'); $i('prev_logo_icon').classList.add('hidden'); }
  else{ $i('prev_logo_img').classList.add('hidden'); $i('prev_logo_icon').classList.remove('hidden'); }
  
  // Header
  const headerSrc = pend.header?.previewUrl || getEffectiveAssetUrl('header');
  const headerWrap = $i('prev_header_wrap');
  if(headerSrc){ headerWrap.style.backgroundImage=`url('${headerSrc}')`; headerWrap.classList.remove('hidden'); }
  else{ headerWrap.classList.add('hidden'); }
  
  // Background
  const bgSrc = pend.background?.previewUrl || getEffectiveAssetUrl('background');
  const bgDiv = $i('previewBg');
  if(bgSrc){ bgDiv.style.backgroundImage=`url('${bgSrc}')`; bgDiv.style.opacity=opa; }
  else{ bgDiv.style.backgroundImage='none'; }
  
  // Brand line
  const preview = $i('brandPreview');
  preview.style.borderTop = `3px solid ${c1}`;
}

function getEffectiveAssetUrl(kind) {
  const target = ft();
  const isDefaults = target==='__defaults__';
  const form = (!isDefaults && state.config.forms[target]) ? state.config.forms[target] : {};
  const db = state.config.defaults.branding || {};
  
  // form specific first, then defaults
  const formUrl = form[`${kind}_url`] || form.branding?.[kind]?.url || '';
  const defUrl = db[kind]?.url || '';
  return formUrl || defUrl;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASSET UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dragOver(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function dragLeave(e){ e.currentTarget.classList.remove('drag-over'); }
function dropAsset(e, kind){ e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const f=e.dataTransfer.files[0]; if(f) handleAssetFile(kind,f); }
function assetPicked(e, kind){ const f=e.target.files[0]; if(f) handleAssetFile(kind,f); }

function handleAssetFile(kind, file) {
  if(!file || !file.type.startsWith('image/')){ toast('Image file ‡§ö‡§æ‡§π‡§ø‡§è','error'); return; }
  const target = ft();
  state.pendingAssets[target] = state.pendingAssets[target] || {};
  if(state.pendingAssets[target][kind]?.previewUrl) URL.revokeObjectURL(state.pendingAssets[target][kind].previewUrl);
  const previewUrl = URL.createObjectURL(file);
  state.pendingAssets[target][kind] = { file, previewUrl, uploaded:false };
  
  // Show preview
  const wrap = $i(`${kind}-preview-wrap`);
  const img = $i(`${kind}-preview`);
  if(wrap && img){ img.src=previewUrl; wrap.classList.remove('hidden'); }
  
  renderPreview();
  toast(`${kind} selected ‚Äî Save ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ upload ‡§π‡•ã‡§ó‡§æ`,'info');
}

function clearAsset(kind) {
  const target = ft();
  if(state.pendingAssets[target]?.[kind]?.previewUrl) URL.revokeObjectURL(state.pendingAssets[target][kind].previewUrl);
  if(state.pendingAssets[target]) delete state.pendingAssets[target][kind];
  
  // Clear from config
  const isDefaults = target==='__defaults__';
  if(isDefaults){ state.config.defaults.branding[kind] = {kind:'none'}; state.config.defaults.branding[`${kind}_url`]=''; }
  else{
    const f = state.config.forms[target] = state.config.forms[target]||{};
    f[`${kind}_key`]=''; f[`${kind}_url`]='';
    f.branding = f.branding||{}; f.branding[kind]={kind:'none'}; f.branding[`${kind}_url`]='';
  }
  
  setAssetPreview(kind,'');
  renderPreview();
}

async function uploadPendingAssets() {
  const target = ft();
  const pend = state.pendingAssets[target] || {};
  for(const kind of ['logo','header','background']) {
    const p = pend[kind];
    if(!p?.file || p.uploaded) continue;
    try {
      const res = await apiCall('admin_init_asset_upload', {
        collection_id: state.cid,
        file_name: p.file.name,
        mime_type: p.file.type
      });
      if(res.upload_url && res.s3_key) {
        await fetch(res.upload_url, { method:'PUT', body:p.file, headers:{'Content-Type':p.file.type} });
        // Store key in config
        const isDefaults = target==='__defaults__';
        if(isDefaults){
          state.config.defaults.branding[kind] = { kind:'s3', key:res.s3_key };
          state.config.defaults.branding[`${kind}_key`] = res.s3_key;
        } else {
          const f = state.config.forms[target] = state.config.forms[target]||{};
          f[`${kind}_key`] = res.s3_key;
          f.branding = f.branding||{};
          f.branding[kind] = { kind:'s3', key:res.s3_key };
          f.branding[`${kind}_key`] = res.s3_key;
        }
        p.uploaded = true;
        toast(`${kind} uploaded ‚úì`,'success');
      }
    } catch(e) { toast(`${kind} upload failed: ${e.message}`,'error'); }
  }
}

// Copy defaults to all forms
function copyToAllForms() {
  collectUIIntoConfig();
  const db = state.config.defaults.branding;
  Object.keys(state.config.forms).forEach(ft => {
    const f = state.config.forms[ft];
    if(!f.title) f.title = db.title;
    if(!f.subtitle) f.subtitle = db.subtitle;
    if(!f.tagline) f.tagline = db.tagline;
    if(!f.footer_text) f.footer_text = db.footer_text;
    f.branding = deepMerge(f.branding||{}, { color1:db.color1, color2:db.color2 });
  });
  toast('Defaults copied to all forms','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRAMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPrograms() {
  const scope = $i('progScopeSel')?.value || 'form';
  const target = ft();
  let list = [];
  if(scope==='defaults') list = state.config.defaults.programs || [];
  else {
    const node = (target!=='__defaults__' && state.config.forms[target]) ? state.config.forms[target] : {};
    list = (node.program_options?.length ? node.program_options : (node.programs?.length ? node.programs : null)) || state.config.defaults.programs || [];
  }
  
  const container = $i('progList');
  if(!container) return;
  if(!list.length){ container.innerHTML = '<div class="text-sm text-slate-500 text-center py-4">‡§ï‡•ã‡§à program ‡§®‡§π‡•Ä‡§Ç‡•§ Add ‡§ï‡§∞‡•á‡§Ç ‡§ä‡§™‡§∞ ‡§∏‡•á‡•§</div>'; return; }
  container.innerHTML = list.map((p,i) => `
    <div class="prog-chip">
      <span class="text-slate-300">${i+1}. ${escHtml(p)}</span>
      <button class="btn btn-danger btn-sm" onclick="deleteProgram(${i})"><i class="fa-solid fa-trash"></i></button>
    </div>`).join('');
}

function getProgramList() {
  const scope = $i('progScopeSel')?.value || 'form';
  const target = ft();
  if(scope==='defaults') return state.config.defaults.programs || [];
  const node = (target!=='__defaults__'&&state.config.forms[target]) ? state.config.forms[target] : {};
  return (node.program_options?.length ? [...node.program_options] : (node.programs?.length ? [...node.programs] : [...(state.config.defaults.programs||[])]));
}
function setProgramList(list) {
  const scope = $i('progScopeSel')?.value || 'form';
  const target = ft();
  if(scope==='defaults'){ state.config.defaults.programs = list; return; }
  const f = state.config.forms[target] = state.config.forms[target]||{};
  f.program_options = list; f.programs = list;
}

function addProgram() {
  const val = $i('newProgInput')?.value.trim();
  if(!val){ toast('Program name enter ‡§ï‡§∞‡•á‡§Ç','error'); return; }
  const list = getProgramList();
  if(list.includes(val)){ toast('Already exists','error'); return; }
  list.push(val);
  setProgramList(list);
  $i('newProgInput').value='';
  renderPrograms();
  toast('Added ‚úì','success');
}

function deleteProgram(idx) {
  const list = getProgramList();
  list.splice(idx,1);
  setProgramList(list);
  renderPrograms();
}

function addDefaultPrograms() {
  const list = getProgramList();
  DEFAULT_PROGRAMS.forEach(p => { if(!list.includes(p)) list.push(p); });
  setProgramList(list);
  renderPrograms();
  toast('Default programs added','success');
}

function clearPrograms() {
  if(!confirm('‡§∏‡§≠‡•Ä programs delete ‡§ï‡§∞‡•á‡§Ç?')) return;
  setProgramList([]);
  renderPrograms();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Common Programs (Mandal/Coordinator/Program Info) + Program Lock
// Stored at: state.config.defaults.programs_common
// Lock stored at: state.config.forms[ft].fixed_program + fixed_program_lock
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCommonProgramList(){
  const d = state.config && state.config.defaults ? state.config.defaults : {};
  const arr = d.programs_common;
  return Array.isArray(arr) ? arr.slice() : [];
}
function setCommonProgramList(list){
  if(!state.config.defaults) state.config.defaults = {};
  state.config.defaults.programs_common = Array.isArray(list) ? list.slice() : [];
}
function renderCommonPrograms(){
  const container = $i('commonProgList');
  if(!container) return;
  const list = getCommonProgramList();
  if(!list.length){
    container.innerHTML = '<div class="text-sm text-slate-500 text-center py-4">‡§ï‡•ã‡§à common program ‡§®‡§π‡•Ä‡§Ç‡•§ Add ‡§ï‡§∞‡•á‡§Ç ‡§ä‡§™‡§∞ ‡§∏‡•á‡•§</div>';
    populateFixedProgramDropdowns();
    hydrateProgramLocksToUI();
    return;
  }
  container.innerHTML = list.map((p,i)=>`
    <div class="prog-chip">
      <span class="text-slate-300">${i+1}. ${escHtml(p)}</span>
      <button class="btn btn-danger btn-sm" onclick="deleteCommonProgram(${i})"><i class="fa-solid fa-trash"></i></button>
    </div>
  `).join('');
  populateFixedProgramDropdowns();
  hydrateProgramLocksToUI();
}
function addCommonProgram(){
  const val = $i('newCommonProgInput')?.value.trim();
  if(!val){ toast('Program name enter ‡§ï‡§∞‡•á‡§Ç','error'); return; }
  const list = getCommonProgramList();
  if(list.includes(val)){ toast('Already exists','error'); return; }
  list.push(val);
  setCommonProgramList(list);
  if($i('newCommonProgInput')) $i('newCommonProgInput').value='';
  renderCommonPrograms();
  toast('Common program added ‚úì','success');
}
function deleteCommonProgram(idx){
  const list = getCommonProgramList();
  list.splice(idx,1);
  setCommonProgramList(list);
  renderCommonPrograms();
}
function clearCommonPrograms(){
  if(!confirm('‡§∏‡§≠‡•Ä common programs delete ‡§ï‡§∞‡•á‡§Ç?')) return;
  setCommonProgramList([]);
  renderCommonPrograms();
}
function syncCommonFromGlobal(){
  // Copy from defaults.programs into defaults.programs_common
  const g = (state.config.defaults && Array.isArray(state.config.defaults.programs)) ? state.config.defaults.programs : [];
  setCommonProgramList(g.slice());
  renderCommonPrograms();
  toast('Synced from Global ‚úì','success');
}
function populateFixedProgramDropdowns(){
  const list = getCommonProgramList();
  const ids = [
    ['mandal_reporting','fixedProg_mandal_reporting'],
    ['coordinator_form','fixedProg_coordinator_form'],
    ['program_info','fixedProg_program_info'],
  ];
  ids.forEach(([ft,id])=>{
    const sel = $i(id);
    if(!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">‚Äî None ‚Äî</option>' + list.map(p=>`<option value="${escAttr(p)}">${escHtml(p)}</option>`).join('');
    if(prev) sel.value = prev;
  });
}
function applyProgramLocksFromUI(){
  const pairs = [
    ['mandal_reporting','fixedProg_mandal_reporting','lockProg_mandal_reporting'],
    ['coordinator_form','fixedProg_coordinator_form','lockProg_coordinator_form'],
    ['program_info','fixedProg_program_info','lockProg_program_info'],
  ];
  state.config.forms = state.config.forms || {};
  pairs.forEach(([ft,selId,chkId])=>{
    const sel = $i(selId);
    const chk = $i(chkId);
    const v = sel ? (sel.value || '') : '';
    const lock = chk ? !!chk.checked : false;
    const node = state.config.forms[ft] || {};
    if(lock && v){
      node.fixed_program = v;
      node.fixed_program_lock = true;
    } else {
      node.fixed_program = '';
      node.fixed_program_lock = false;
    }
    state.config.forms[ft] = node;
  });
  toast('Program locks updated','success');
}
function hydrateProgramLocksToUI(){
  const pairs = [
    ['mandal_reporting','fixedProg_mandal_reporting','lockProg_mandal_reporting'],
    ['coordinator_form','fixedProg_coordinator_form','lockProg_coordinator_form'],
    ['program_info','fixedProg_program_info','lockProg_program_info'],
  ];
  pairs.forEach(([ft,selId,chkId])=>{
    const node = (state.config.forms && state.config.forms[ft]) ? state.config.forms[ft] : {};
    const fp = node.fixed_program || '';
    const locked = !!node.fixed_program_lock && !!fp;
    const sel = $i(selId);
    const chk = $i(chkId);
    if(sel){
      if(fp && !Array.from(sel.options).some(o=>o.value===fp)){
        // If program not in list, still show it
        const opt = document.createElement('option');
        opt.value = fp; opt.textContent = fp;
        sel.appendChild(opt);
      }
      sel.value = fp || '';
    }
    if(chk) chk.checked = locked;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEVEL LOCKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLevelLocks() {
  const target = ft();
  const isDefaults = target==='__defaults__';
  const container = $i('levelLocksGrid');
  if(!container) return;
  
  const forms = isDefaults ? Object.keys(FORM_META).filter(k=>k!=='__defaults__') : [target];
  
  container.innerHTML = forms.map(f => {
    const meta = FORM_META[f] || { label:f, icon:'üìã' };
    const formNode = state.config.forms[f] || {};
    const currentLevel = formNode.fixed_level || '';
    return `
      <div class="section-card" style="padding:16px;">
        <div class="font-bold text-white text-sm mb-3">${meta.icon} ${meta.label}</div>
        <label class="text-xs text-slate-400 block mb-1">Level Lock</label>
        <select id="lvl_${f}" class="text-sm" onchange="onLevelChange('${f}', this.value)">
          ${LEVEL_OPTIONS.map(o=>`<option value="${o.value}" ${o.value===currentLevel?'selected':''}>${o.label}</option>`).join('')}
        </select>
        <div class="text-[10px] text-slate-500 mt-2">
          ${currentLevel ? `üîí "${currentLevel}" level lock ‡§π‡•à` : 'üîì User level ‡§ö‡•Å‡§® ‡§∏‡§ï‡§§‡§æ ‡§π‡•à'}
        </div>
      </div>`;
  }).join('');
}

function onLevelChange(formKey, val) {
  const f = state.config.forms[formKey] = state.config.forms[formKey]||{};
  f.fixed_level = val;
  // Also update in defaults.fixed_levels
  state.config.defaults.fixed_levels = state.config.defaults.fixed_levels||{};
  state.config.defaults.fixed_levels[formKey] = val;
  toast(`${formKey} level set to "${val||'unlocked'}"`, 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LINKS & QR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateLink() {
  if(!state.cid){ toast('Collection ID ‡§°‡§æ‡§≤‡•á‡§Ç','error'); return; }
  const formType = $i('lnk_form_type')?.value || 'visitor_form';
  const days = parseInt($i('lnk_days')?.value || '3650');
  const baseUrl = ($i('lnk_base_url')?.value||'').trim();
  
  toast('Generating...','info');
  try {
    const action = formType==='search' ? 'generate_search_link' : 'generate_form_link';
    const res = await apiCall(action, { collection_id:state.cid, cid:state.cid, days_valid:days, form_type:formType });
    const token = res.token || '';
    if(!token){ toast('Token ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ','error'); return; }
    
    // Build URL
    let meta = FORM_META[formType] || {};
    let file = meta.file || `political_${formType}.html`;
    if(formType==='search') file = 'political-search.html';
    const base = baseUrl || window.location.origin + window.location.pathname.replace(/[^\/]+$/, '');
    const url = `${base}${file}?token=${token}&cid=${state.cid}`;
    
    $i('lnkFinalUrl').value = url;
    $i('lnkResult').classList.remove('hidden');
    $i('qrBox').innerHTML='';
    $i('qrBox').classList.add('hidden');
    $i('qrDownloadBtn').classList.add('hidden');
    
    toast('Link generated ‚úì','success');
  } catch(e) {
    toast('Generate failed: '+e.message,'error');
  }
}

function showQR(inputId, boxId) {
  const url = $i(inputId)?.value;
  if(!url){ toast('Link ‡§™‡§π‡§≤‡•á generate ‡§ï‡§∞‡•á‡§Ç','error'); return; }
  const box = $i(boxId);
  box.innerHTML='';
  box.classList.remove('hidden');
  try {
    new QRCode(box, { text:url, width:180, height:180, correctLevel:QRCode.CorrectLevel.M });
    $i('qrDownloadBtn')?.classList.remove('hidden');
  } catch(e){ box.textContent='QR Error'; }
}

function downloadQR(boxId) {
  const box = $i(boxId);
  const canvas = box?.querySelector('canvas');
  if(!canvas){ toast('QR ‡§™‡§π‡§≤‡•á generate ‡§ï‡§∞‡•á‡§Ç','error'); return; }
  const a = document.createElement('a');
  a.download = 'eventlens-qr.png';
  a.href = canvas.toDataURL('image/png');
  a.click();
}

function copyLink(inputId) {
  const val = $i(inputId)?.value;
  if(!val) return;
  navigator.clipboard.writeText(val).then(()=>toast('Copied!','success'));
}

function saveToHistory() {
  const url = $i('lnkFinalUrl')?.value;
  if(!url) return;
  const hist = getLinkHistory();
  hist.unshift({ id:Date.now(), url, type:$i('lnk_form_type')?.value||'', created:new Date().toISOString(), disabled:false });
  setLinkHistory(hist.slice(0,100));
  renderLinkHistory();
  toast('Link saved ‚úì','success');
}

function getLinkHistory(){ try{ return JSON.parse(localStorage.getItem('EL_LNKHIST_'+(state.cid||'g'))||'[]'); }catch(e){ return []; } }
function setLinkHistory(h){ try{ localStorage.setItem('EL_LNKHIST_'+(state.cid||'g'), JSON.stringify(h)); }catch(e){} }

function renderLinkHistory() {
  const hist = getLinkHistory();
  const el = $i('linkHistoryList');
  if(!el) return;
  if(!hist.length){ el.innerHTML='<div class="text-sm text-slate-500 text-center py-4">‡§ï‡•ã‡§à saved links ‡§®‡§π‡•Ä‡§Ç‡•§</div>'; return; }
  el.innerHTML = hist.map((h,i) => `
    <div class="prog-chip flex-wrap gap-2" style="${h.disabled?'opacity:.45':''}">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-1">
          <span class="tag">${h.type||'link'}</span>
          <span class="text-[10px] text-slate-500">${new Date(h.created).toLocaleDateString('hi-IN')}</span>
          ${h.disabled?'<span style="color:#f87171;font-size:10px;">‚óè Disabled</span>':''}
        </div>
        <div class="font-mono text-[10px] text-orange-400 truncate max-w-xs">${h.url}</div>
      </div>
      <div class="flex gap-1 flex-shrink-0">
        ${!h.disabled?`<button class="btn btn-secondary btn-sm" onclick="copyHistLink(${i})" title="Copy"><i class="fa-regular fa-copy"></i></button>`:''}
        <button class="btn btn-secondary btn-sm" onclick="showHistQR(${i})" title="QR"><i class="fa-solid fa-qrcode"></i></button>
        <button class="btn ${h.disabled?'btn-primary':'btn-danger'} btn-sm" onclick="toggleHistLink(${i})">${h.disabled?'Enable':'Disable'}</button>
      </div>
    </div>`).join('');
}

function copyHistLink(i){ const h=getLinkHistory(); if(h[i]) navigator.clipboard.writeText(h[i].url).then(()=>toast('Copied!','success')); }
function toggleHistLink(i){ const h=getLinkHistory(); if(h[i]){ h[i].disabled=!h[i].disabled; setLinkHistory(h); renderLinkHistory(); toast(h[i].disabled?'Disabled':'Enabled','info'); } }
function clearLinkHistory(){ if(!confirm('‡§∏‡§≠‡•Ä saved links clear ‡§ï‡§∞‡•á‡§Ç?')) return; setLinkHistory([]); renderLinkHistory(); }
function showHistQR(i) {
  const h=getLinkHistory(); if(!h[i]) return;
  const tmp = document.createElement('div');
  tmp.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:12px;z-index:9999;cursor:pointer;';
  tmp.title='Click to close';
  tmp.onclick=()=>tmp.remove();
  document.body.appendChild(tmp);
  new QRCode(tmp, { text:h[i].url, width:200, height:200, correctLevel:QRCode.CorrectLevel.M });
  const tip = document.createElement('div');
  tip.style.cssText='text-align:center;font-size:11px;color:#64748b;margin-top:8px;';
  tip.textContent='Click to close';
  tmp.appendChild(tip);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA RECORDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadData(reset=true) {
  if(!state.cid){ toast('Collection ID ‡§°‡§æ‡§≤‡•á‡§Ç','error'); return; }
  if(reset){ state.dataItems=[]; state.dataNextKey=null; }
  
  const ft = $i('dataFormTypeFilter')?.value || 'all';
  const startDate = $i('dataStartDate')?.value;
  const endDate = $i('dataEndDate')?.value;
  
  const now = Date.now();
  const endMs = endDate ? new Date(endDate+'T23:59:59').getTime() : now;
  const startMs = startDate ? new Date(startDate+'T00:00:00').getTime() : (now - 30*86400*1000);
  
  $i('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-6"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';
  
  try {
    const res = await apiCall('admin_list', {
      collection_id: state.cid,
      form_type: ft==='all' ? 'all' : ft,
      limit: 100,
      start_ms: String(startMs),
      end_ms: String(endMs),
      next_key: state.dataNextKey || undefined
    });
    
    const items = res.items || [];
    if(reset) state.dataItems = items;
    else state.dataItems = [...state.dataItems, ...items];
    state.dataNextKey = res.next_key || null;
    state.dataFiltered = [...state.dataItems];
    
    filterDataTable();
    renderDataStats();
    
    const moreBtn = $i('dataLoadMoreBtn');
    if(moreBtn) moreBtn.classList.toggle('hidden', !state.dataNextKey);
    
  } catch(e) {
    $i('dataTableBody').innerHTML = `<tr><td colspan="8" class="text-center text-red-400 py-6">${e.message}</td></tr>`;
    toast('Data load failed: '+e.message,'error');
  }
}

function filterDataTable() {
  const q = ($i('dataSearch')?.value||'').toLowerCase();
  if(!q){ state.dataFiltered = [...state.dataItems]; }
  else {
    state.dataFiltered = state.dataItems.filter(item => {
      const p = item.data || {};
      return (item.name||p.name||'').toLowerCase().includes(q)
        || (item.mobile||p.mobile||'').includes(q)
        || (item.district||p.district||p['‡§ú‡§ø‡§≤‡§æ']||'').toLowerCase().includes(q)
        || (item.form_type||'').includes(q);
    });
  }
  renderDataTable();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROUP: Multiple photo entries ‚Üí one row per event
// For president_tour and mandal_reporting forms
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function groupDataItems(items) {
  const GROUPABLE = ['president_tour', 'mandal_reporting'];
  const grouped = new Map();
  const others = [];
  
  items.forEach(item => {
    const ft = (item.form_type || '').toLowerCase();
    const isGroupable = GROUPABLE.some(g => ft.includes(g));
    
    if (!isGroupable) { others.push(item); return; }
    
    const p = item.data || {};
    const date = (item.created_at_iso || '').substring(0, 10);
    const pname = (p.program_name || p.karyakram_name || '').trim();
    const district = (item.district || p.district || '').trim();
    const key = `${ft}|${date}|${pname}|${district}`;
    
    if (!grouped.has(key)) {
      const rep = JSON.parse(JSON.stringify(item));
      rep._allPhotos = [];
      rep._count = 0;
      grouped.set(key, rep);
    }
    const grp = grouped.get(key);
    grp._count++;
    if (item.photo_url && !grp._allPhotos.includes(item.photo_url)) {
      grp._allPhotos.push(item.photo_url);
    }
    if (!grp.photo_url && item.photo_url) grp.photo_url = item.photo_url;
    if (!grp.thumb_url && item.thumb_url) grp.thumb_url = item.thumb_url;
    // Keep highest attendance
    const att = parseInt((item.data || {}).total_attendance) || 0;
    const cur = parseInt((grp.data || {}).total_attendance) || 0;
    if (att > cur && grp.data) grp.data.total_attendance = att;
  });
  
  return [...others, ...Array.from(grouped.values())];
}

// Slideshow state for admin
let _adminSlidePhotos = [], _adminSlideCurrent = 0;

function openAdminPhotoSlide(photos, startIdx) {
  _adminSlidePhotos = photos || [];
  _adminSlideCurrent = startIdx || 0;
  _renderAdminSlide();
  document.getElementById('adminPhotoSlideModal').classList.remove('hidden');
}

function _renderAdminSlide() {
  const photos = _adminSlidePhotos;
  const idx = _adminSlideCurrent;
  const img = document.getElementById('adminSlideshowImg');
  const cnt = document.getElementById('adminSlideshowCount');
  if (img) { img.src = photos[idx] || ''; img.style.display = photos[idx] ? 'block' : 'none'; }
  if (cnt) cnt.textContent = photos.length > 1 ? `${idx+1} / ${photos.length}` : '';
}

function adminSlideNav(dir) {
  const len = _adminSlidePhotos.length;
  if (!len) return;
  _adminSlideCurrent = (_adminSlideCurrent + dir + len) % len;
  _renderAdminSlide();
}

function renderDataTable() {
  const tbody = $i('dataTableBody');
  $i('dataCountLabel').textContent = `${state.dataFiltered.length} records`;
  // Apply event grouping for photo-heavy forms
  const displayItems = groupDataItems(state.dataFiltered);
  const groupedCount = state.dataFiltered.length - displayItems.length;
  $i('dataCountLabel').textContent = `${displayItems.length} records${groupedCount > 0 ? ' (grouped)' : ''}`;
  
  if(!displayItems.length){ tbody.innerHTML='<tr><td colspan="8" class="text-center text-slate-500 py-6">‡§ï‡•ã‡§à records ‡§®‡§π‡•Ä‡§Ç</td></tr>'; return; }
  tbody.innerHTML = displayItems.map((item,idx) => {
    const p = item.data || {};
    const name = item.name||p.name||p['‡§®‡§æ‡§Æ']||'-';
    const mobile = item.mobile||p.mobile||p['‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤']||'-';
    const district = item.district||p.district||p['‡§ú‡§ø‡§≤‡§æ']||'-';
    const program = p.program_name||p.karyakram_name||p.program_type||item.program_name||'-';
    const ft = item.form_type||'-';
    const date = item.created_at_iso ? new Date(item.created_at_iso).toLocaleDateString('hi-IN') : '-';
    const ftClass = getFtClass(ft);
    const allPhotos = (item._allPhotos && item._allPhotos.length) ? item._allPhotos : (item.photo_url ? [item.photo_url] : []);
    const thumb = allPhotos[0] || item.thumb_url || '';
    const photoCount = item._count || allPhotos.length || 0;
    const photosJson = JSON.stringify(allPhotos).replace(/"/g, '&quot;');
    return `
      <tr>
        <td>
          ${thumb ? `
            <div style="position:relative;display:inline-block;cursor:pointer" onclick='openAdminPhotoSlide(${photosJson}, 0)'>
              ${allPhotos.length > 1 ? `
                <div style="width:44px;height:44px;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:1px;border-radius:8px;overflow:hidden">
                  ${allPhotos.slice(0,4).map((p,pi) => `<img src="${p}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.background='#1e293b'">`).join('')}
                </div>` :
                `<img src="${thumb}" class="w-11 h-11 object-cover rounded-lg" onerror="this.style.display='none'"/>`
              }
              ${photoCount > 1 ? `<span style="position:absolute;top:-4px;right:-4px;background:#f97316;color:white;font-size:9px;font-weight:700;border-radius:99px;padding:1px 4px;line-height:14px">${photoCount}</span>` : ''}
            </div>
          ` : '<div class="w-11 h-11 rounded-lg bg-slate-800 flex items-center justify-center text-slate-600"><i class="fa-solid fa-image"></i></div>'}
        </td>
        <td class="font-medium">${escHtml(name)}</td>
        <td class="text-slate-400 font-mono text-xs">${escHtml(mobile)}</td>
        <td><span class="ft-label ${ftClass}">${ft}</span></td>
        <td class="text-slate-400 text-xs">${escHtml(program)}</td>
        <td class="text-slate-400 text-xs">${escHtml(district)}</td>
        <td class="text-slate-500 text-xs">${date}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="openEntryModalGrouped(${idx}, displayItems)"><i class="fa-solid fa-eye"></i></button>
        </td>
      </tr>`;
  }).join('');
  // Store for modal use
  window._adminDisplayItems = displayItems;
}

function renderDataStats() {
  const counts = {};
  state.dataItems.forEach(item => { const ft=item.form_type||'?'; counts[ft]=(counts[ft]||0)+1; });
  const el = $i('dataStats');
  if(!el) return;
  el.innerHTML = Object.entries(counts).map(([ft,n]) => 
    `<div class="bg-slate-900/60 rounded-lg px-3 py-1.5 flex items-center gap-2">
      <span class="ft-label ${getFtClass(ft)}">${ft}</span>
      <span class="font-bold text-white">${n}</span>
    </div>`).join('');
}

function getFtClass(ft) {
  if(ft.includes('visitor')) return 'ft-visitor';
  if(ft.includes('attendance')||ft.includes('party')) return 'ft-attendance';
  if(ft.includes('tour')||ft.includes('president')) return 'ft-tour';
  if(ft.includes('mandal')) return 'ft-mandal';
  if(ft.includes('coordinator')) return 'ft-coordinator';
  if(ft.includes('program')) return 'ft-program';
  return 'ft-visitor';
}

function openEntryModalGrouped(idx, displayItems) {
  const src = displayItems || window._adminDisplayItems || state.dataFiltered;
  const item = src[idx];
  openEntryModal_item(item);
}

function openEntryModal(idx) {
  openEntryModal_item(state.dataFiltered[idx]);
}

function openEntryModal_item(item) {
  if(!item) return;
  const p = item.data || {};
  const allPhotos = (item._allPhotos && item._allPhotos.length) ? item._allPhotos : (item.photo_url ? [item.photo_url] : []);
  const photoCount = item._count || allPhotos.length || 0;
  
  // Build photo section
  let photoSection = '';
  if (allPhotos.length > 1) {
    const thumbsHtml = allPhotos.map((ph, pi) => `<img src="${ph}" onclick="_setAdminMainPhoto('${ph}')" style="width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid ${pi===0?'#f97316':'transparent'}" onerror="this.style.display='none'">`).join('');
    photoSection = `
      <div style="position:relative;margin-bottom:8px">
        <img id="_adminMainImg" src="${allPhotos[0]}" class="w-full max-h-52 object-cover rounded-xl" onerror="this.style.display='none'"/>
        <div style="position:absolute;top:8px;right:8px;background:rgba(249,115,22,.9);color:white;font-size:11px;font-weight:700;padding:3px 10px;border-radius:99px">üì∏ ${photoCount} Photos</div>
      </div>
      <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:6px;margin-bottom:8px">${thumbsHtml}</div>`;
  } else if (allPhotos.length === 1) {
    photoSection = `<img src="${allPhotos[0]}" class="w-full max-h-48 object-cover rounded-xl" style="margin-bottom:8px" onerror="this.style.display='none'"/>`;
  }
  
  $i('entryModalContent').innerHTML = `
    <div class="space-y-3">
      ${photoSection}
      <div class="grid grid-cols-2 gap-3 text-sm">
        ${Object.entries({ 'Form Type':item.form_type, 'Name':item.name||p.name, 'Mobile':item.mobile||p.mobile, 'District':item.district||p.district, 'Date':item.created_at_iso, ...p }).map(([k,v]) => v ? `<div><div class="text-[10px] text-slate-500 uppercase">${k}</div><div class="text-white font-medium">${escHtml(String(v))}</div></div>` : '').join('')}
      </div>
    </div>`;
  $i('entryModal').style.display='flex';
}
function closeEntryModal(){ $i('entryModal').style.display='none'; }

function exportDataCSV() {
  if(!state.dataFiltered.length){ toast('‡§ï‡•ã‡§à data ‡§®‡§π‡•Ä‡§Ç','error'); return; }
  const rows = [['Name','Mobile','Form','District','Date','Entry ID']];
  state.dataFiltered.forEach(item => {
    const p = item.data||{};
    rows.push([item.name||p.name||'', item.mobile||p.mobile||'', item.form_type||'', item.district||p.district||'', item.created_at_iso||'', item.entry_id||'']);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download = `political_data_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  toast('CSV downloaded ‚úì','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GALLERY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadGallery(reset=true) {
  if(!state.cid){ toast('Collection ID ‡§°‡§æ‡§≤‡•á‡§Ç','error'); return; }
  if(reset){ state.galPhotos=[]; state.galNextKey=null; }
  const formType = $i('galFormFilter')?.value || '';
  toast('Loading photos...','info');
  try {
    const res = await apiCall('admin_list_photos', {
      collection_id: state.cid,
      limit: 40,
      last_key: state.galNextKey || undefined
    });
    const photos = res.photos || [];
    if(reset) state.galPhotos=photos;
    else state.galPhotos=[...state.galPhotos,...photos];
    state.galNextKey = res.last_key || null;
    renderGallery(formType);
    $i('galLoadMoreBtn').classList.toggle('hidden', !state.galNextKey);
    toast(`${state.galPhotos.length} photos loaded`,'success');
  } catch(e) {
    toast('Gallery load failed: '+e.message,'error');
  }
}

function renderGallery(filterFt) {
  const grid = $i('galGrid');
  let photos = state.galPhotos;
  if(filterFt) photos = photos.filter(p=>p.form_type===filterFt);
  if(!photos.length){ grid.innerHTML='<div class="col-span-4 text-center text-slate-500 py-8">‡§ï‡•ã‡§à photos ‡§®‡§π‡•Ä‡§Ç‡•§</div>'; return; }
  grid.innerHTML = photos.map((p,i) => `
    <div class="cursor-pointer rounded-lg overflow-hidden relative group" onclick="openSlide(${i})">
      <img src="${p.url}" class="w-full aspect-square object-cover transition-transform group-hover:scale-105" onerror="this.parentNode.style.display='none'" loading="lazy"/>
      <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-[9px] text-slate-300 p-1 truncate">${p.form_type||''}</div>
    </div>`).join('');
}

function openSlide(idx){ state.galSlideIdx=idx; showSlide(); }
function showSlide(){
  const p = state.galPhotos[state.galSlideIdx];
  if(!p) return;
  $i('slideImg').src = p.url;
  $i('slideCaption').textContent = `${p.form_type||''} ¬∑ ${p.created_at_iso?.slice(0,10)||''}`;
  $i('slideOverlay').classList.remove('hidden');
  $i('slideOverlay').style.display='flex';
}
function closeSlide(){ $i('slideOverlay').classList.add('hidden'); $i('slideOverlay').style.display='none'; }
function prevSlide(){ state.galSlideIdx=(state.galSlideIdx-1+state.galPhotos.length)%state.galPhotos.length; showSlide(); }
function nextSlide(){ state.galSlideIdx=(state.galSlideIdx+1)%state.galPhotos.length; showSlide(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAnalytics() {
  if(!state.cid){ toast('Collection ID ‡§°‡§æ‡§≤‡•á‡§Ç','error'); return; }
  try {
    const res = await apiCall('admin_stats', {
      collection_id: state.cid,
      start_ms: String(Date.now() - 90*86400*1000),
      end_ms: String(Date.now())
    });
    const counts = res.counts || {};
    const total = res.total || 0;
    
    // KPI cards
    const kpiEl = $i('analyticsGrid');
    kpiEl.innerHTML = `
      <div class="section-card text-center" style="padding:16px;">
        <div class="text-3xl font-bold text-orange-400">${total}</div>
        <div class="text-xs text-slate-400 mt-1">Total Entries</div>
      </div>
      ${Object.entries(counts).map(([ft,n])=>`
        <div class="section-card text-center" style="padding:16px;">
          <div class="text-2xl font-bold text-white">${n}</div>
          <div class="text-[10px] text-slate-400 mt-1"><span class="ft-label ${getFtClass(ft)}">${ft}</span></div>
        </div>`).join('')}`;
    
    // Bar chart (simple)
    const byForm = $i('chartByForm');
    const maxVal = Math.max(...Object.values(counts),1);
    byForm.innerHTML = Object.entries(counts).map(([ft,n])=>`
      <div class="flex items-center gap-2">
        <div class="text-xs text-slate-400 w-24 truncate">${ft}</div>
        <div class="flex-1 bg-slate-800 rounded-full h-2">
          <div class="h-2 rounded-full bg-gradient-to-r from-orange-500 to-red-500" style="width:${Math.round(n/maxVal*100)}%"></div>
        </div>
        <div class="text-xs font-bold text-white w-8 text-right">${n}</div>
      </div>`).join('');
    
    toast('Analytics loaded ‚úì','success');
  } catch(e) {
    toast('Analytics failed: '+e.message,'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREVIEW IN NEW TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPreviewTab() {
  const target = ft();
  const meta = FORM_META[target] || FORM_META['visitor_form'];
  const file = meta.file;
  const base = window.location.href.replace(/[^\/]+$/, '');
  const url = `${base}${file}?cid=${state.cid}&preview=1`;
  window.open(url, '_blank');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }


function escAttr(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  // Restore CID
  const savedCid = (new URLSearchParams(location.search)).get('cid') || localStorage.getItem('EL_ADMIN_CID') || '';
  if(savedCid){ state.cid=savedCid; $i('cidInput').value=savedCid; $i('cidPill').classList.remove('hidden'); $i('cidVal').textContent=savedCid; }
  
  // Restore local config cache
  if(state.cid){
    try{ const local=localStorage.getItem('EL_CFG_'+state.cid); if(local){ state.config=deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), JSON.parse(local)); populateFieldsFromConfig(); renderPreview(); renderPrograms(); renderLevelLocks(); }}catch(e){}
  }
  
  // Mobile hamburger
  const ham = $i('hamburger');
  if(ham){ ham.style.display='flex'; }
  
  // BG Opacity label
  $i('b_bg_opacity').addEventListener('input', ()=>{ $i('opacityVal').textContent=$i('b_bg_opacity').value; renderPreview(); });
  
  // Keyboard nav for slideshow
  document.addEventListener('keydown', e=>{
    if(!$i('slideOverlay').style.display || $i('slideOverlay').style.display==='none') return;
    if(e.key==='ArrowLeft') prevSlide();
    if(e.key==='ArrowRight') nextSlide();
    if(e.key==='Escape') closeSlide();
  });
  
  // Auth modal
  $i('btnCancelAuth')?.addEventListener('click', closeAuthModal);
  $i('btnSaveAuth')?.addEventListener('click', saveToken);
  
  // Auto-load if CID is present
  if(state.cid) loadConfig();

  // Set today as default end date
  const today = new Date().toISOString().slice(0,10);
  const monthAgo = new Date(Date.now()-30*86400*1000).toISOString().slice(0,10);
  if($i('dataStartDate')) $i('dataStartDate').value = monthAgo;
  if($i('dataEndDate')) $i('dataEndDate').value = today;
  
  renderLinkHistory();
});
</script>
</body>
</html>
