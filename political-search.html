<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>EventLens AI ‚Äî Karyakarta Intelligence</title>
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="EventLens AI" />
  <meta name="theme-color" content="#02050A" />
  <meta name="description" content="AI-powered Karyakarta Intelligence" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%2302050A'/%3E%3Ctext x='96' y='130' font-size='90' text-anchor='middle' fill='%23D4A017'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800&family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { display: ['Cinzel', 'serif'], body: ['Outfit', 'sans-serif'], hindi: ['Noto Sans Devanagari', 'sans-serif'] },
          colors: {
            navy: { 950: '#02050A', 900: '#060D1F', 800: '#0B1530', 700: '#112044', 600: '#1A3060' },
            gold: { 300: '#F5D78A', 400: '#EFC24A', 500: '#D4A017', 600: '#B8880F' },
            crimson: { 400: '#FF5C72', 500: '#E63950' },
            jade: { 400: '#3ECFB2', 500: '#2AB89C' },
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --navy-950: #02050A; --navy-900: #060D1F; --navy-800: #0B1530; --navy-700: #112044;
      --gold-400: #EFC24A; --gold-500: #D4A017; --crimson-500: #E63950; --jade-400: #3ECFB2;
    }
    * { box-sizing: border-box; }
    html, body { overflow-x: hidden; max-width: 100vw; }
    html { scroll-behavior: smooth; }

    body {
      background-color: var(--navy-950);
      background-image:
        radial-gradient(circle at 10% 40%, rgba(212,160,23,0.06) 0%, transparent 60%),
        radial-gradient(circle at 90% 20%, rgba(62,207,178,0.04) 0%, transparent 60%),
        radial-gradient(circle at 50% 100%, rgba(230,57,80,0.04) 0%, transparent 60%);
      background-attachment: fixed;
      color: #D1D9E6;
      font-family: 'Outfit', sans-serif;
      min-height: 100vh; min-height: 100dvh;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* ‚îÄ‚îÄ‚îÄ Sci-Fi Grid Overlay ‚îÄ‚îÄ‚îÄ */
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(circle at center, black 30%, transparent 80%);
      -webkit-mask-image: radial-gradient(circle at center, black 30%, transparent 80%);
    }

    /* ‚îÄ‚îÄ‚îÄ Text Gradients ‚îÄ‚îÄ‚îÄ */
    .text-gradient-gold {
      background: linear-gradient(135deg, #FFEAA7 0%, #D4A017 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }
    .text-gradient-teal {
      background: linear-gradient(135deg, #a7f3d0 0%, #2AB89C 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }

    /* ‚îÄ‚îÄ‚îÄ Premium Glass 2.0 ‚îÄ‚îÄ‚îÄ */
    .glass {
      background: linear-gradient(145deg, rgba(11,21,48,0.5) 0%, rgba(2,5,10,0.7) 100%);
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
      border-radius: 28px;
    }

    /* ‚îÄ‚îÄ‚îÄ Navbar ‚îÄ‚îÄ‚îÄ */
    .navbar {
      background: rgba(2, 5, 10, 0.85);
      backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .logo-icon {
      background: linear-gradient(135deg, #F5D78A 0%, #D4A017 50%, #B8880F 100%);
      box-shadow: 0 4px 20px rgba(212,160,23,0.4), inset 0 2px 4px rgba(255,255,255,0.4);
    }

    /* ‚îÄ‚îÄ‚îÄ Advanced Upload Zone ‚îÄ‚îÄ‚îÄ */
    .upload-zone {
      background: rgba(6,13,31,0.4);
      border: 2px dashed rgba(212,160,23,0.3);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
    }
    .upload-zone:hover, .upload-zone:focus-within {
      border-color: rgba(212,160,23,0.9);
      background: rgba(212,160,23,0.05);
      box-shadow: 0 0 50px rgba(212,160,23,0.15), inset 0 0 30px rgba(212,160,23,0.05);
      transform: translateY(-2px) scale(1.01);
    }
    
    /* ‚îÄ‚îÄ‚îÄ Laser Scan Line ‚îÄ‚îÄ‚îÄ */
    .scan-line {
      background: linear-gradient(to right, transparent, rgba(62,207,178,1), transparent);
      height: 3px;
      box-shadow: 0 0 20px rgba(62,207,178,0.8), 0 0 40px rgba(62,207,178,0.5);
      border-radius: 50%;
    }
    @keyframes scandown {
      0% { top: -5%; opacity: 0; } 
      10% { opacity: 1; }
      90% { opacity: 1; } 
      100% { top: 105%; opacity: 0; }
    }

    /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
    .btn-primary {
      background: linear-gradient(135deg, #F5D78A 0%, #D4A017 50%, #B8880F 100%);
      color: #02050A; font-weight: 800; letter-spacing: 0.04em; text-transform: uppercase;
      box-shadow: 0 8px 30px rgba(212,160,23,0.3), inset 0 2px 0 rgba(255,255,255,0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;
      min-height: 56px; border-radius: 18px;
    }
    .btn-primary:hover { box-shadow: 0 15px 40px rgba(212,160,23,0.5), inset 0 2px 0 rgba(255,255,255,0.5); transform: translateY(-3px); }
    .btn-primary:active { transform: translateY(1px) scale(0.97); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(80%); transform: none; box-shadow: none; }

    .btn-success {
      background: linear-gradient(135deg, #3ECFB2 0%, #1a6b5c 100%);
      color: #fff; font-weight: 800; letter-spacing: 0.03em; text-transform: uppercase;
      box-shadow: 0 8px 30px rgba(62,207,178,0.3), inset 0 2px 0 rgba(255,255,255,0.3);
      transition: all 0.3s ease; min-height: 56px; border-radius: 18px;
    }
    .btn-success:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(62,207,178,0.5); }
    .btn-success:active { transform: scale(0.97); }

    .btn-ghost {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
      color: #cbd5e1; transition: all 0.3s ease; min-height: 50px; border-radius: 16px;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.08); color: #fff; border-color: rgba(255,255,255,0.25); transform: translateY(-2px); }
    .btn-ghost:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ‚îÄ Sleek Input Fields ‚îÄ‚îÄ‚îÄ */
    .field-input {
      width: 100%; background: rgba(2,5,10,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      color: #fff; border-radius: 18px;
      padding: 16px 18px; font-family: 'DM Sans', sans-serif;
      font-size: 15px; font-weight: 500; transition: all 0.3s ease;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
    }
    .field-input::placeholder { color: #64748b; font-weight: 400; }
    .field-input:focus { 
      outline: none; 
      border-color: var(--gold-400); 
      background: rgba(17,32,68,0.4); 
      box-shadow: 0 0 0 4px rgba(212,160,23,0.15), inset 0 2px 4px rgba(0,0,0,0.1); 
    }
    .field-input.has-error { border-color: var(--crimson-500); box-shadow: 0 0 0 4px rgba(230,57,80,0.15); }

    /* ‚îÄ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ‚îÄ */
    .stat-card {
      background: linear-gradient(145deg, rgba(17,32,68,0.4) 0%, rgba(2,5,10,0.8) 100%);
      border: 1px solid rgba(255,255,255,0.05);
      border-top: 1px solid rgba(255,255,255,0.12);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border-radius: 24px;
      position: relative;
    }
    .stat-card::after {
      content: ''; position: absolute; inset: 0; border-radius: 24px;
      background: radial-gradient(circle at top right, rgba(212,160,23,0.1), transparent 70%);
      opacity: 0; transition: opacity 0.4s;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.5); border-color: rgba(212,160,23,0.3); }
    .stat-card:hover::after { opacity: 1; }
    .stat-bar-fill { height: 4px; border-radius: 999px; transition: width 1.5s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 0 12px rgba(62,207,178,0.6); }

    /* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ */
    .tab-btn { font-weight: 700; color: #64748b; transition: all 0.3s ease; position: relative; min-height: 56px; display: flex; align-items: center; justify-content: center; gap: 10px; border-radius: 16px 16px 0 0; text-transform: uppercase; letter-spacing: 0.05em; font-size: 13px; }
    .tab-btn:hover { color: #e2e8f0; background: rgba(255,255,255,0.03); }
    .tab-active { color: var(--gold-400) !important; background: linear-gradient(to top, rgba(212,160,23,0.1) 0%, transparent 100%); }
    .tab-active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--gold-400); border-radius: 3px 3px 0 0; box-shadow: 0 -3px 12px rgba(212,160,23,0.5); }

    /* ‚îÄ‚îÄ‚îÄ Filter Pills ‚îÄ‚îÄ‚îÄ */
    .filter-pill {
      font-size: 11px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase;
      border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); backdrop-filter: blur(10px);
      color: #94a3b8; padding: 10px 20px; border-radius: 999px;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap;
    }
    .filter-pill:hover { color: #fff; border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .filter-pill.active { background: rgba(212,160,23,0.15); border-color: var(--gold-400); color: var(--gold-400); box-shadow: 0 0 20px rgba(212,160,23,0.25); }

    /* ‚îÄ‚îÄ‚îÄ Premium Timeline UI ‚îÄ‚îÄ‚îÄ */
    .timeline-rail::before {
      content: ''; position: absolute; top: 0; bottom: 0; left: 24px; width: 2px;
      background: linear-gradient(to bottom, rgba(212,160,23,0.9) 0%, rgba(212,160,23,0.2) 60%, transparent 100%);
      box-shadow: 0 0 15px rgba(212,160,23,0.4);
    }
    .timeline-dot { background: var(--navy-900); border: 3px solid var(--gold-400); box-shadow: 0 0 0 4px rgba(2,5,10,1), 0 0 12px rgba(212,160,23,0.6); transition: all 0.4s ease; }
    .timeline-item:hover .timeline-dot { transform: scale(1.3); box-shadow: 0 0 0 4px rgba(2,5,10,1), 0 0 20px rgba(212,160,23,1); background: var(--gold-400); }
    
    .event-card {
      background: linear-gradient(145deg, rgba(17,32,68,0.4) 0%, rgba(6,13,31,0.6) 100%);
      border: 1px solid rgba(255,255,255,0.06); 
      border-left: 4px solid rgba(212,160,23,0.4);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .event-card:hover { 
      border-left-color: var(--gold-400); 
      background: linear-gradient(145deg, rgba(17,32,68,0.6) 0%, rgba(6,13,31,0.8) 100%);
      transform: translateX(8px) translateY(-2px); 
      box-shadow: 0 20px 40px rgba(0,0,0,0.5), -5px 0 25px rgba(212,160,23,0.15); 
      border-color: rgba(255,255,255,0.15); 
    }

    /* ‚îÄ‚îÄ‚îÄ Photo Grid ‚îÄ‚îÄ‚îÄ */
    .photo-item {
      border: 1px solid rgba(255,255,255,0.06); border-radius: 20px;
      overflow: hidden; background: rgba(6,13,31,0.8);
      transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); aspect-ratio: 1; cursor: pointer;
      position: relative;
    }
    .photo-item::before {
      content: ''; position: absolute; inset: 0; border-radius: 20px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); z-index: 5; pointer-events: none;
    }
    .photo-item::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 60%);
      opacity: 0; transition: opacity 0.4s; z-index: 1;
    }
    .photo-item:hover { 
      border-color: rgba(212,160,23,0.6); 
      transform: scale(1.06) translateY(-8px); 
      box-shadow: 0 20px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,160,23,0.2); 
      z-index: 10; 
    }
    .photo-item:hover::after { opacity: 1; }
    .photo-item .play-icon { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 2; transform: scale(0.5); }
    .photo-item:hover .play-icon { opacity: 1; transform: scale(1); }

    /* ‚îÄ‚îÄ‚îÄ Animations ‚îÄ‚îÄ‚îÄ */
    @keyframes pulseRing { 0% { box-shadow: 0 0 0 0 rgba(212,160,23,0.5); } 70% { box-shadow: 0 0 0 20px rgba(212,160,23,0); } 100% { box-shadow: 0 0 0 0 rgba(212,160,23,0); } }
    .pulse-ring { animation: pulseRing 2.5s cubic-bezier(0.2, 0.8, 0.2, 1) infinite; }

    @keyframes fadeup { 0% { opacity: 0; transform: translateY(25px); } 100% { opacity: 1; transform: translateY(0); } }
    .animate-fadeup { animation: fadeup 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    @keyframes slidein { 0% { opacity: 0; transform: translateY(35px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
    .animate-slidein { animation: slidein 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-12px); } 100% { transform: translateY(0px); } }
    .animate-float { animation: float 5s ease-in-out infinite; }

    /* ‚îÄ‚îÄ‚îÄ Step indicator ‚îÄ‚îÄ‚îÄ */
    .step-num {
      width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 800; flex-shrink: 0; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .step-num.done { background: var(--jade-400); color: #02050A; box-shadow: 0 0 20px rgba(62,207,178,0.5); }
    .step-num.active { background: var(--gold-500); color: #02050A; box-shadow: 0 0 25px rgba(212,160,23,0.7); transform: scale(1.15); }
    .step-num.pending { background: rgba(255,255,255,0.02); color: #64748b; border: 1px dashed rgba(255,255,255,0.15); }
    .step-line { flex: 1; height: 2px; background: rgba(255,255,255,0.06); transition: background 0.5s ease; border-radius: 2px; }
    .step-line.done { background: linear-gradient(90deg, var(--jade-400), rgba(255,255,255,0.1)); box-shadow: 0 0 8px rgba(62,207,178,0.4); }

    /* ‚îÄ‚îÄ‚îÄ Aurora Background ‚îÄ‚îÄ‚îÄ */
    @keyframes aurora1 { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(30px,-20px) scale(1.05)} 66%{transform:translate(-20px,15px) scale(0.95)} }
    @keyframes aurora2 { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(-25px,20px) scale(1.08)} 66%{transform:translate(20px,-10px) scale(0.93)} }
    .aurora-orb-1 { position:fixed;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(212,160,23,0.07) 0%,transparent 70%);top:-100px;left:-150px;animation:aurora1 18s ease-in-out infinite;pointer-events:none;z-index:0; }
    .aurora-orb-2 { position:fixed;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(62,207,178,0.05) 0%,transparent 70%);bottom:-100px;right:-100px;animation:aurora2 22s ease-in-out infinite;pointer-events:none;z-index:0; }
    .aurora-orb-3 { position:fixed;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(230,57,80,0.04) 0%,transparent 70%);top:40%;left:40%;animation:aurora1 28s ease-in-out infinite reverse;pointer-events:none;z-index:0; }

    /* ‚îÄ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ‚îÄ */
    #toastContainer { position:fixed;top:24px;right:24px;z-index:99999;display:flex;flex-direction:column;gap:12px;pointer-events:none; }
    .toast { display:flex;align-items:center;gap:14px;padding:14px 20px;border-radius:18px;backdrop-filter:blur(40px);font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;min-width:280px;max-width:360px;pointer-events:all;border:1px solid;transform:translateX(120%);opacity:0;transition:all 0.5s cubic-bezier(0.16,1,0.3,1);box-shadow:0 20px 50px rgba(0,0,0,0.5); }
    .toast.show { transform:translateX(0);opacity:1; }
    .toast.hide { transform:translateX(120%);opacity:0; }
    .toast-success { background:rgba(6,13,31,0.95);border-color:rgba(62,207,178,0.4);color:#f1f5f9; }
    .toast-success .toast-icon { color:#3ECFB2; }
    .toast-error { background:rgba(6,13,31,0.95);border-color:rgba(230,57,80,0.4);color:#f1f5f9; }
    .toast-error .toast-icon { color:#E63950; }
    .toast-loading { background:rgba(6,13,31,0.95);border-color:rgba(212,160,23,0.4);color:#f1f5f9; }
    .toast-loading .toast-icon { color:#D4A017; }
    .toast-icon { font-size:18px;flex-shrink:0; }
    .toast-close { margin-left:auto;opacity:0.5;cursor:pointer;font-size:14px;transition:opacity 0.2s;flex-shrink:0; }
    .toast-close:hover { opacity:1; }

    /* ‚îÄ‚îÄ‚îÄ Profile Hero Banner ‚îÄ‚îÄ‚îÄ */
    #profileHero { border-radius:28px;overflow:hidden;position:relative;background:linear-gradient(135deg,rgba(17,32,68,0.6) 0%,rgba(2,5,10,0.9) 100%);border:1px solid rgba(212,160,23,0.2);box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.03);backdrop-filter:blur(40px); }
    #profileHero::before { content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(212,160,23,0.06) 0%,transparent 50%,rgba(62,207,178,0.04) 100%);pointer-events:none; }
    .profile-avatar { width:80px;height:80px;border-radius:50%;border:3px solid rgba(212,160,23,0.5);box-shadow:0 0 0 6px rgba(212,160,23,0.08),0 0 30px rgba(212,160,23,0.3);object-fit:cover;flex-shrink:0;transition:all 0.4s ease; }
    .profile-avatar:hover { box-shadow:0 0 0 8px rgba(212,160,23,0.15),0 0 40px rgba(212,160,23,0.5);transform:scale(1.05); }
    .profile-name { font-family:'Cinzel',serif;font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#FFEAA7 0%,#D4A017 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:0.02em;line-height:1.2; }
    @media(max-width:640px){ .profile-name{font-size:1.15rem;} }

    /* ‚îÄ‚îÄ‚îÄ Animated Counter ‚îÄ‚îÄ‚îÄ */
    .count-animate { transition:all 0.1s ease; }

    /* ‚îÄ‚îÄ‚îÄ Face Scan Animation (Upload zone) ‚îÄ‚îÄ‚îÄ */
    @keyframes faceScanRing { 0%{transform:scale(0.8);opacity:0} 50%{opacity:1} 100%{transform:scale(1.4);opacity:0} }
    @keyframes faceScanDash { 0%{stroke-dashoffset:283} 100%{stroke-dashoffset:0} }
    .face-scan-ring { position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:5; }
    .face-scan-svg { width:140px;height:140px; }
    .face-scan-circle { fill:none;stroke:rgba(212,160,23,0.6);stroke-width:2;stroke-dasharray:283;stroke-dashoffset:283;animation:faceScanDash 2s linear infinite;stroke-linecap:round; }
    .face-scan-circle-2 { fill:none;stroke:rgba(62,207,178,0.4);stroke-width:1;stroke-dasharray:283;stroke-dashoffset:283;animation:faceScanDash 2s linear infinite 1s;stroke-linecap:round; }
    @keyframes scanCorner { 0%,100%{opacity:0.4} 50%{opacity:1} }
    .scan-corner { position:absolute;width:20px;height:20px;border-color:rgba(212,160,23,0.8);border-style:solid;animation:scanCorner 2s ease-in-out infinite; }
    .scan-corner-tl { top:20px;left:20px;border-width:3px 0 0 3px;animation-delay:0s; }
    .scan-corner-tr { top:20px;right:20px;border-width:3px 3px 0 0;animation-delay:0.25s; }
    .scan-corner-bl { bottom:20px;left:20px;border-width:0 0 3px 3px;animation-delay:0.5s; }
    .scan-corner-br { bottom:20px;right:20px;border-width:0 3px 3px 0;animation-delay:0.75s; }

    /* ‚îÄ‚îÄ‚îÄ Ripple Effect ‚îÄ‚îÄ‚îÄ */
    .ripple-container { position:relative;overflow:hidden; }
    .ripple { position:absolute;border-radius:50%;background:rgba(255,255,255,0.25);transform:scale(0);animation:rippleAnim 0.6s linear;pointer-events:none; }
    @keyframes rippleAnim { to{transform:scale(4);opacity:0} }

    /* ‚îÄ‚îÄ‚îÄ Mobile Bottom Bar ‚îÄ‚îÄ‚îÄ */
    #mobileBottomBar { display:none;position:fixed;bottom:0;left:0;right:0;z-index:50;background:rgba(2,5,10,0.95);backdrop-filter:blur(30px);border-top:1px solid rgba(255,255,255,0.08);padding:12px 20px calc(12px + env(safe-area-inset-bottom));box-shadow:0 -20px 50px rgba(0,0,0,0.6); }
    @media(max-width:1023px){ #mobileBottomBar{display:flex;gap:12px;align-items:center;} }
    @media(max-width:1023px){ .safe-area-bottom{padding-bottom:calc(96px + env(safe-area-inset-bottom));} }

    /* ‚îÄ‚îÄ‚îÄ Premium Skeleton Loader ‚îÄ‚îÄ‚îÄ */
    .skeleton { background:linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%);background-size:200% 100%;animation:shimmerAnim 1.8s ease-in-out infinite; }
    @keyframes shimmerAnim { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skeleton-scan-line { position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(212,160,23,0.6),transparent);animation:skeletonScan 2s ease-in-out infinite; }
    @keyframes skeletonScan { 0%{top:0;opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{top:100%;opacity:0} }

    /* ‚îÄ‚îÄ‚îÄ Enhanced Filter Pills with count badge ‚îÄ‚îÄ‚îÄ */
    .filter-count { display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;border-radius:10px;font-size:10px;font-weight:800;padding:0 6px;background:rgba(255,255,255,0.1);color:#94a3b8;margin-left:6px;transition:all 0.3s; }
    .filter-pill.active .filter-count { background:rgba(212,160,23,0.3);color:#D4A017; }

    /* ‚îÄ‚îÄ‚îÄ WhatsApp Share Button ‚îÄ‚îÄ‚îÄ */
    .btn-whatsapp { background:linear-gradient(135deg,#25D366 0%,#128C7E 100%);color:#fff;font-weight:800;letter-spacing:0.03em;box-shadow:0 8px 25px rgba(37,211,102,0.3);transition:all 0.3s ease;border-radius:16px;min-height:48px; }
    .btn-whatsapp:hover { transform:translateY(-2px);box-shadow:0 12px 35px rgba(37,211,102,0.5); }
    .btn-whatsapp:active { transform:scale(0.97); }

    /* ‚îÄ‚îÄ‚îÄ Timeline card premium ‚îÄ‚îÄ‚îÄ */
    .timeline-card-premium {
      background:linear-gradient(145deg,rgba(17,32,68,0.5) 0%,rgba(6,13,31,0.7) 100%);
      border:1px solid rgba(255,255,255,0.07);
      border-left:4px solid rgba(212,160,23,0.5);
      border-radius:24px;padding:24px;
      transition:all 0.4s cubic-bezier(0.16,1,0.3,1);
      backdrop-filter:blur(20px);
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      position:relative;overflow:hidden;
    }
    .timeline-card-premium::before { content:'';position:absolute;top:0;right:0;width:200px;height:200px;background:radial-gradient(circle at top right,rgba(212,160,23,0.05),transparent 70%);pointer-events:none; }
    .timeline-card-premium:hover { border-left-color:var(--gold-400);background:linear-gradient(145deg,rgba(17,32,68,0.7) 0%,rgba(6,13,31,0.9) 100%);transform:translateX(6px) translateY(-3px);box-shadow:0 20px 50px rgba(0,0,0,0.4),-5px 0 25px rgba(212,160,23,0.12);border-color:rgba(255,255,255,0.12); }
    .timeline-card-premium.tour { border-left-color:rgba(62,207,178,0.5); }
    .timeline-card-premium.tour:hover { border-left-color:#3ECFB2;box-shadow:0 20px 50px rgba(0,0,0,0.4),-5px 0 25px rgba(62,207,178,0.12); }
    .timeline-card-premium.attendance { border-left-color:rgba(96,165,250,0.5); }
    .timeline-card-premium.attendance:hover { border-left-color:#60A5FA;box-shadow:0 20px 50px rgba(0,0,0,0.4),-5px 0 25px rgba(96,165,250,0.12); }
    .timeline-card-premium.mandal { border-left-color:rgba(167,139,250,0.5); }
    .timeline-card-premium.visitor { border-left-color:rgba(249,115,22,0.5); }

    /* ‚îÄ‚îÄ‚îÄ Arc chart for stats ‚îÄ‚îÄ‚îÄ */
    .arc-svg { width:60px;height:40px;overflow:visible; }
    .arc-bg { fill:none;stroke:rgba(255,255,255,0.08);stroke-width:5;stroke-linecap:round; }
    .arc-fill { fill:none;stroke-width:5;stroke-linecap:round;transition:stroke-dashoffset 1.5s cubic-bezier(0.2,0.8,0.2,1); }

    /* ‚îÄ‚îÄ‚îÄ Stagger animations ‚îÄ‚îÄ‚îÄ */
    .stagger-item { opacity:0;animation:fadeup 0.6s cubic-bezier(0.16,1,0.3,1) forwards; }
    .stagger-item:nth-child(1){animation-delay:0.05s}
    .stagger-item:nth-child(2){animation-delay:0.1s}
    .stagger-item:nth-child(3){animation-delay:0.15s}
    .stagger-item:nth-child(4){animation-delay:0.2s}
    .stagger-item:nth-child(5){animation-delay:0.25s}
    .stagger-item:nth-child(6){animation-delay:0.3s}
    .stagger-item:nth-child(7){animation-delay:0.35s}
    .stagger-item:nth-child(8){animation-delay:0.4s}

    /* ‚îÄ‚îÄ‚îÄ Navbar enhanced ‚îÄ‚îÄ‚îÄ */
    .nav-status-dot { width:8px;height:8px;border-radius:50%;background:#3ECFB2;box-shadow:0 0 8px rgba(62,207,178,0.8);animation:pulseRing 2s infinite; }

    /* ‚îÄ‚îÄ‚îÄ Enhanced Upload zone ‚îÄ‚îÄ‚îÄ */
    .upload-zone-inner { transition:all 0.5s cubic-bezier(0.4,0,0.2,1); }
    .upload-zone:hover .upload-zone-inner, .upload-zone:focus-within .upload-zone-inner { transform:scale(1.03); }


    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(212,160,23,0.6); }

    .safe-area-bottom { padding-bottom: calc(32px + env(safe-area-inset-bottom)); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    /* Modal & Slideshow Overrides */
    #slideshowOverlay { position: fixed; inset: 0; z-index: 9999; display: none; flex-direction: column; background: rgba(0,0,0,0.98); backdrop-filter: blur(20px); }
    #slideshowOverlay.active { display: flex; }
    #slideshowTopBar { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; flex-shrink: 0; background: linear-gradient(to bottom, rgba(2,5,10,0.9), transparent); gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    #slideshowTitle { font-family: 'DM Sans',sans-serif; font-size: 16px; font-weight: 800; color: var(--gold-400); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; letter-spacing: 0.02em; }
    #slideshowCounter { font-size: 12px; color: #fff; font-weight: 700; font-family: 'DM Sans', sans-serif; white-space: nowrap; background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; backdrop-filter: blur(10px); }
    .ss-ctrl-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); color: #fff; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); backdrop-filter: blur(10px); }
    .ss-ctrl-btn:hover { background: var(--gold-500); border-color: var(--gold-500); color: #000; transform: scale(1.1); box-shadow: 0 0 20px rgba(212,160,23,0.4); }
    #slideshowProgress { height: 4px; background: rgba(255,255,255,0.05); flex-shrink: 0; }
    #slideshowProgressBar { height: 100%; background: linear-gradient(90deg, #F5D78A, #D4A017); transition: width 0.3s ease; box-shadow: 0 0 15px rgba(212,160,23,0.6); }
    #slideshowMain { flex: 1; display: flex; overflow: hidden; min-height: 0; }
    #ssPhotoSide { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; background: radial-gradient(circle at center, rgba(17,32,68,0.2) 0%, #000 100%); overflow: hidden; }
    #slideshowImg { max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    #slideshowImg.fading { opacity: 0; transform: scale(0.95); }
    .ss-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 56px; height: 56px; border-radius: 50%; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15); color: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .ss-nav-btn:hover { background: var(--gold-500); border-color: var(--gold-500); color: #000; box-shadow: 0 0 25px rgba(212,160,23,0.5); transform: translateY(-50%) scale(1.15); }
    #ssPrev { left: 24px; } #ssNext { right: 24px; }
    #ssDetailSide { width: 380px; flex-shrink: 0; background: rgba(6,13,31,0.6); backdrop-filter: blur(40px); border-left: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; overflow: hidden; }
    #ssDetailHeader { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.08); flex-shrink: 0; background: linear-gradient(to bottom, rgba(255,255,255,0.03), transparent); }
    #ssDetailTitle { font-family: 'DM Sans',sans-serif; font-weight: 800; color: #fff; font-size: 18px; margin-bottom: 10px; line-height: 1.4; }
    #ssDetailScroll { flex: 1; overflow-y: auto; padding: 20px 24px; }
    .ss-detail-row { padding: 14px 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
    .ss-detail-row:last-child { border-bottom: none; }
    .ss-detail-key { color: #94a3b8; font-size: 10px; text-transform: uppercase; letter-spacing: 0.15em; font-weight: 800; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .ss-detail-val { color: #f8fafc; font-weight: 500; font-size: 15px; line-height: 1.6; }
    #ssThumbRow { display: flex; gap: 10px; padding: 16px 24px; overflow-x: auto; background: linear-gradient(to top, rgba(2,5,10,0.95), rgba(2,5,10,0.8)); border-top: 1px solid rgba(255,255,255,0.08); flex-shrink: 0; }
    .ss-thumb { width: 64px; height: 64px; border-radius: 12px; object-fit: cover; border: 2px solid transparent; cursor: pointer; flex-shrink: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); opacity: 0.5; }
    .ss-thumb:hover { opacity: 0.9; transform: translateY(-4px); }
    .ss-thumb.active { border-color: var(--gold-400); opacity: 1; box-shadow: 0 0 20px rgba(212,160,23,0.5); transform: scale(1.1) translateY(-2px); }
    @media (max-width: 767px) {
      #slideshowMain { flex-direction: column; }
      #ssDetailSide { width: 100%; flex: none; max-height: 40vh; border-left: none; border-top: 1px solid rgba(255,255,255,0.1); }
      #ssPhotoSide { flex: 1; min-height: 0; }
      .ss-nav-btn { width: 44px; height: 44px; font-size: 16px; }
      #ssPrev { left: 12px; } #ssNext { right: 12px; }
    }

    #detailModal .modal-panel {
      background: linear-gradient(145deg, rgba(11,21,48,0.8) 0%, rgba(2,5,10,0.95) 100%); backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 40px 100px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
      border-radius: 32px;
    }
  
    /* ‚îÄ‚îÄ PWA Install Banner ‚îÄ‚îÄ */
    @keyframes pwaSlideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
    .pwa-banner,.pwa-hint{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:10000;width:calc(100% - 32px);max-width:360px;background:linear-gradient(135deg,rgba(11,21,48,0.98),rgba(2,5,10,0.98));border:1px solid rgba(212,160,23,0.4);border-radius:20px;padding:16px 20px;backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);box-shadow:0 20px 60px rgba(0,0,0,0.7);display:flex;align-items:center;gap:14px;animation:pwaSlideUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards;}
    .pwa-hint{max-width:340px;border-color:rgba(212,160,23,0.3);flex-direction:column;gap:10px;}
    .pwa-icon-box{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#D4A017,#B8880F);display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 15px rgba(212,160,23,0.4);}
    .pwa-install-btn{background:linear-gradient(135deg,#F5D78A,#D4A017);color:#02050A;font-weight:800;font-size:12px;padding:8px 16px;border-radius:12px;border:none;cursor:pointer;font-family:'Outfit',sans-serif;box-shadow:0 4px 12px rgba(212,160,23,0.4);}
    .pwa-dismiss-btn{background:rgba(255,255,255,0.06);color:#94a3b8;font-weight:700;font-size:12px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);cursor:pointer;font-family:'Outfit',sans-serif;}
    .pwa-hint-row{display:flex;align-items:center;gap:12px;width:100%;}
    .pwa-hint-text{font-family:'Noto Sans Devanagari',sans-serif;color:#94a3b8;font-size:12px;line-height:1.7;background:rgba(255,255,255,0.04);padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.07);width:100%;}
  </style>

  <script>
    // JS Logic remains strictly the same
    function previewImage(inputEl) {
      try {
        const file = inputEl && inputEl.files && inputEl.files[0];
        const preview = document.getElementById("preview");
        const placeholder = document.getElementById("uploadPlaceholder");
        const scanLine = document.getElementById("scanLine");
        if (!preview) return;
        if (!file) {
          preview.src = ""; preview.classList.add("hidden");
          if (placeholder) placeholder.classList.remove("hidden");
          if (scanLine) scanLine.classList.add("hidden");
          return;
        }
        const url = URL.createObjectURL(file);
        preview.src = url; preview.classList.remove("hidden");
        if (placeholder) placeholder.classList.add("hidden");
        if (scanLine) scanLine.classList.remove("hidden");
        // Also set as profile avatar thumbnail
        const avatarImg = document.getElementById('profileAvatarImg');
        const avatarPlaceholder = document.getElementById('profileAvatarPlaceholder');
        if (avatarImg) {
          avatarImg.src = url;
          avatarImg.classList.remove('hidden');
          if (avatarPlaceholder) avatarPlaceholder.classList.add('hidden');
        }
        // On mobile: if selfieInput (camera zone), auto-submit after short delay
        if (inputEl.id === 'selfieInput') {
          // Only auto-submit on actual mobile devices, not desktop
          const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
          if (isMobile) {
            setTimeout(() => {
              const searchBtn = document.getElementById('searchBtn');
              if (searchBtn && !searchBtn.disabled) searchBtn.click();
            }, 500);
          }
        }
      } catch (e) { console.error(e); }
    }

    function setImgSrcWithRetry(imgEl, url, maxRetries = 2) {
      if (!imgEl) return;
      let attempt = 0;
      imgEl.referrerPolicy = "no-referrer";
      const load = () => { imgEl.src = url; };
      imgEl.onerror = () => {
        if (attempt < maxRetries) { attempt++; setTimeout(load, 350 * attempt); return; }
        imgEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='1.5'%3E%3Crect x='3' y='3' width='18' height='18' rx='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E";
      };
      load();
    }
    function getBestThumbUrl(obj, fallbackUrl) {
      if (!obj) return fallbackUrl;
      return obj.thumb_url || obj.thumbUrl || obj.thumbnail_url || obj.thumbnailUrl || fallbackUrl;
    }
  </script>
</head>

<body class="font-body">
  <!-- Aurora background -->
  <div class="aurora-orb-1"></div>
  <div class="aurora-orb-2"></div>
  <div class="aurora-orb-3"></div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- ‚ïê‚ïê NAVBAR ‚ïê‚ïê -->
  <nav class="navbar sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-5 sm:px-8">
      <div class="flex items-center justify-between h-20 sm:h-24">
        <div class="flex items-center gap-5">
          <div class="logo-icon w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center flex-shrink-0 relative overflow-hidden group">
            <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
            <i class="fa-solid fa-bolt text-xl sm:text-2xl" style="color:#02050A"></i>
          </div>
          <div>
            <div class="flex items-baseline gap-2">
              <span class="font-display text-white text-xl sm:text-2xl font-bold tracking-wide">EventLens</span>
              <span class="font-display text-base sm:text-lg text-gradient-gold font-bold">AI</span>
            </div>
            <div class="hidden sm:flex items-center gap-2 mt-1">
              <div class="nav-status-dot"></div>
              <p class="text-[10px] uppercase font-extrabold text-slate-400 tracking-[0.2em]">Karyakarta Intelligence</p>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button id="copySummaryBtn" class="hidden items-center gap-2 px-5 py-2.5 rounded-full btn-ghost text-xs font-bold uppercase tracking-widest border border-white/10 hover:border-gold-400 hover:text-gold-400">
            <i class="fa-regular fa-copy text-sm"></i><span class="hidden sm:inline">Copy</span>
          </button>
          <div id="tokenDisplay" class="hidden items-center gap-2 px-4 py-2 rounded-full font-bold uppercase tracking-widest text-[10px] bg-teal-400/10 border border-teal-400/30 text-teal-400 shadow-[0_0_15px_rgba(62,207,178,0.2)]">
            <i class="fa-solid fa-shield-halved text-sm"></i><span class="hidden sm:inline">Secured</span>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-10 relative z-10 safe-area-bottom" style="overflow-x:hidden;">
    <div class="grid lg:grid-cols-12 gap-6 lg:gap-8">

      <!-- ‚ïê‚ïê LEFT COLUMN ‚ïê‚ïê -->
      <div class="lg:col-span-3 relative">
        <div class="sticky top-24 space-y-4">
          
          <!-- ‚îÄ Step Indicator ‚îÄ -->
          <div class="flex items-center justify-between px-3 bg-white/5 backdrop-blur-xl p-3 rounded-2xl border border-white/10 shadow-lg">
            <div class="flex items-center gap-2">
               <div class="step-num active" id="step1Num">1</div>
               <span class="text-[10px] font-extrabold text-white uppercase tracking-widest hidden sm:block">‡§∏‡•á‡§≤‡•ç‡§´‡•Ä</span>
            </div>
            <div class="step-line mx-1" id="stepLine1"></div>
            <div class="flex items-center gap-2">
               <div class="step-num pending" id="step2Num">2</div>
               <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden sm:block" id="step2Label">‡§µ‡§ø‡§µ‡§∞‡§£</span>
            </div>
            <div class="step-line mx-1" id="stepLine2"></div>
            <div class="flex items-center gap-2">
               <div class="step-num pending" id="step3Num">3</div>
               <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden sm:block" id="step3Label">‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü</span>
            </div>
          </div>

          <!-- ‚îÄ STEP 1: Upload Card ‚îÄ -->
          <div id="step1Card" class="glass relative overflow-hidden group">
            <div class="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-gold-400 to-transparent opacity-70"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
            
            <div class="p-6 sm:p-8 relative z-10">
              <div class="flex items-center gap-5 mb-8">
                <div class="w-12 h-12 rounded-2xl flex items-center justify-center bg-gold-400/10 border border-gold-400/30 shadow-[0_0_20px_rgba(212,160,23,0.15)]">
                  <i class="fa-solid fa-face-viewfinder text-xl text-gold-400"></i>
                </div>
                <div>
                  <h2 class="font-display font-bold text-gradient-gold text-xl tracking-wide">AI ‡§´‡•á‡§∏ ‡§∏‡§∞‡•ç‡§ö</h2>
                  <p class="text-xs text-slate-400 mt-1 font-medium tracking-wide">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•Ä ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§™‡§π‡§ö‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç</p>
                </div>
              </div>

              <div class="relative mb-6">
                <label class="upload-zone rounded-3xl flex flex-col items-center justify-center cursor-pointer min-h-[280px]">
                  <input id="selfieInput" accept="image/*" type="file" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-20" onchange="previewImage(this)" />
                  <div id="uploadPlaceholder" class="flex flex-col items-center justify-center py-10 pointer-events-none select-none upload-zone-inner relative">
                    <!-- Scan corners -->
                    <div class="scan-corner scan-corner-tl"></div>
                    <div class="scan-corner scan-corner-tr"></div>
                    <div class="scan-corner scan-corner-bl"></div>
                    <div class="scan-corner scan-corner-br"></div>
                    <div class="w-28 h-28 rounded-full flex items-center justify-center mb-6 pulse-ring bg-slate-900/80 border border-gold-400/40 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.5)] relative">
                      <!-- Face scan SVG ring -->
                      <div class="face-scan-ring">
                        <svg class="face-scan-svg" viewBox="0 0 100 100">
                          <circle class="face-scan-circle" cx="50" cy="50" r="45"/>
                          <circle class="face-scan-circle-2" cx="50" cy="50" r="40"/>
                        </svg>
                      </div>
                      <i class="fa-solid fa-camera text-5xl text-gold-400 relative z-10"></i>
                    </div>
                    <span class="font-bold text-white text-xl mb-2 tracking-wide" style="font-family:'Noto Sans Devanagari',sans-serif;">üì∏ Camera ‡§ñ‡•ã‡§≤‡•á‡§Ç</span>
                    <span class="text-sm text-slate-400 font-medium px-6 text-center" style="font-family:'Noto Sans Devanagari',sans-serif;">‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç</span>
                  </div>
                  <img id="preview" class="hidden absolute inset-0 w-full h-full object-cover rounded-3xl z-10 shadow-2xl" alt="Preview" />
                  <div id="scanLine" class="hidden absolute left-0 w-full scan-line z-10 pointer-events-none" style="animation:scandown 2.5s ease-in-out infinite;"></div>
                </label>
              </div>

              <label class="flex items-center justify-center gap-3 w-full py-4 rounded-2xl btn-ghost text-sm font-bold cursor-pointer mb-6 border-dashed">
                <input id="uploadInput" accept="image/*" type="file" class="hidden" onchange="previewImage(this)" />
                <i class="fa-solid fa-images text-lg text-gold-400"></i>
                <span class="tracking-wide">‡§Ø‡§æ ‡§ó‡•à‡§≤‡§∞‡•Ä ‡§∏‡•á ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç</span>
              </label>

              <button id="searchBtn" class="btn-primary w-full text-base flex items-center justify-center gap-3 z-10 lg:flex hidden">
                <i class="fa-solid fa-magnifying-glass text-xl"></i>
                <span>‡§ö‡•á‡§π‡§∞‡§æ ‡§ñ‡•ã‡§ú‡•á‡§Ç</span>
              </button>

              <div id="statusBox" class="hidden mt-5 text-center"></div>
            </div>
          </div>

          <!-- ‚îÄ STEP 2: Match + Mandatory Name/Mobile ‚îÄ -->
          <div id="step2Card" class="hidden glass relative overflow-hidden animate-slidein">
            <div class="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-teal-400 to-transparent opacity-80 shadow-[0_0_15px_rgba(62,207,178,0.5)]"></div>
            <div class="p-6 sm:p-8 relative z-10">
              <div id="matchSummary" class="text-center mb-8">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-5 bg-teal-400/10 border border-teal-400/40 shadow-[0_0_40px_rgba(62,207,178,0.3)]">
                  <i class="fa-solid fa-fingerprint text-4xl text-teal-400"></i>
                </div>
                <div class="font-display font-bold text-gradient-teal text-2xl mb-2 tracking-wide" id="matchTitle">‡§Æ‡•à‡§ö ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ!</div>
                <div class="text-sm text-slate-400 font-medium tracking-wide" id="matchSubtitle">‡§°‡•á‡§ü‡§æ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç</div>
                <div class="flex justify-center gap-3 mt-5 flex-wrap" id="matchPills"></div>
              </div>

              <div class="h-px w-full bg-gradient-to-r from-transparent via-white/15 to-transparent mb-8"></div>

              <div class="space-y-6 mb-8">
                <div>
                  <label class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest mb-3 text-slate-300">
                    ‡§®‡§æ‡§Æ <span class="text-red-500 text-lg leading-none">*</span>
                    <span class="ml-auto text-[10px] px-3 py-1 rounded-lg bg-red-500/10 text-red-400 border border-red-500/20">‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø</span>
                  </label>
                  <div class="relative group">
                    <i class="fa-solid fa-user absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-base pointer-events-none group-focus-within:text-gold-400 transition-colors"></i>
                    <input id="nameInput" type="text" placeholder="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ" class="field-input pl-14" autocomplete="name" style="font-family:'Noto Sans Devanagari','Outfit',sans-serif;" />
                  </div>
                </div>
                <div>
                  <label class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest mb-3 text-slate-300">
                    ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ <span class="text-red-500 text-lg leading-none">*</span>
                    <span class="ml-auto text-[10px] px-3 py-1 rounded-lg bg-red-500/10 text-red-400 border border-red-500/20">‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø</span>
                  </label>
                  <div class="relative group">
                    <i class="fa-solid fa-mobile-screen absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-base pointer-events-none group-focus-within:text-gold-400 transition-colors"></i>
                    <input id="mobileInput" type="tel" placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞" class="field-input pl-14 font-mono tracking-widest text-lg" maxlength="10" pattern="[0-9]{10}" autocomplete="tel" />
                  </div>
                  <p id="mobileError" class="hidden text-xs mt-3 ml-2 text-red-400 flex items-center gap-2 font-medium"><i class="fa-solid fa-circle-exclamation"></i> ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä 10 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç</p>
                </div>
              </div>

              <button id="confirmBtn" class="btn-success w-full text-lg flex items-center justify-center gap-3 mb-4 shadow-[0_10px_30px_rgba(62,207,178,0.3)]">
                <i class="fa-solid fa-unlock-keyhole"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
              </button>
              <button id="newSearchBtn" class="btn-ghost w-full py-4 rounded-xl text-sm font-bold uppercase tracking-widest border-dashed">
                <i class="fa-solid fa-arrow-rotate-left mr-2"></i>‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç / ‡§®‡§à ‡§ñ‡•ã‡§ú
              </button>
            </div>
          </div>

          <!-- ‚îÄ Stats (visible after results load) ‚îÄ -->
          <div id="statsDashboard" class="hidden space-y-3 animate-fadeup">
            <!-- Profile Hero Banner -->
            <div id="profileHero" class="hidden p-4 rounded-2xl overflow-hidden" style="background:linear-gradient(135deg,rgba(17,32,68,0.7) 0%,rgba(2,5,10,0.9) 100%);border:1px solid rgba(212,160,23,0.2);backdrop-filter:blur(40px);">
              <div class="flex items-center gap-3 relative z-10">
                <div class="relative flex-shrink-0">
                  <img id="profileAvatarImg" class="profile-avatar hidden" src="" alt="Profile" style="width:52px;height:52px;" />
                  <div id="profileAvatarPlaceholder" class="flex items-center justify-center bg-gold-400/10 border-gold-400/40 rounded-full" style="width:52px;height:52px;border:2px solid rgba(212,160,23,0.4);">
                    <i class="fa-solid fa-user text-lg text-gold-400"></i>
                  </div>
                </div>
                <div class="min-w-0 flex-1">
                  <div id="profileNameDisplay" class="font-display font-bold text-white truncate text-sm" style="background:linear-gradient(135deg,#FFEAA7,#D4A017);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">‚Äî</div>
                  <div class="flex items-center gap-2 mt-1 flex-wrap">
                    <span id="profileMobileDisplay" class="text-[10px] font-mono text-slate-400 tracking-widest hidden"></span>
                    <span class="text-[9px] px-2 py-0.5 rounded-md bg-teal-400/10 border border-teal-400/30 text-teal-400 font-extrabold uppercase tracking-widest">‚úì Identified</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats grid - compact 3 col -->
            <div class="grid grid-cols-3 gap-2">
              <div class="stat-card p-3 group overflow-hidden">
                <div class="text-[9px] font-extrabold uppercase tracking-widest mb-1 text-slate-500">Match</div>
                <div class="text-xl font-display font-bold text-gradient-teal" id="scoreVal">‚Äî</div>
                <div class="rounded-full overflow-hidden bg-white/10 h-1 mt-2 shadow-inner">
                  <div id="scoreBar" class="stat-bar-fill w-0 bg-gradient-to-r from-teal-500 to-emerald-300" style="height:4px;"></div>
                </div>
              </div>
              <div class="stat-card p-3 group overflow-hidden">
                <div class="text-[9px] font-extrabold uppercase tracking-widest mb-1 text-slate-500">Events</div>
                <div class="text-xl font-display font-bold text-white tracking-wide count-animate" id="eventCountVal">0</div>
                <div id="timelineCount" class="hidden"></div>
              </div>
              <div class="stat-card p-3 group overflow-hidden">
                <div class="text-[9px] font-extrabold uppercase tracking-widest mb-1 text-slate-500">Photos</div>
                <div class="text-xl font-display font-bold text-white tracking-wide count-animate" id="photoCountVal">0</div>
                <div id="photoCount" class="hidden"></div>
                <div id="similarityText" class="hidden"></div>
              </div>
            </div>

            <div class="flex gap-2">
              <button id="copySummaryBtnMobile" class="flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest btn-ghost border border-white/10 bg-white/5 hover:bg-white/10">
                <i class="fa-solid fa-share-nodes text-gold-400 text-sm"></i> Share
              </button>
              <button id="whatsappShareBtn" class="flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest btn-whatsapp">
                <i class="fa-brands fa-whatsapp text-sm"></i> WhatsApp
              </button>
              <div id="btnAiReport" class="hidden"></div>
            </div>
            <!-- New Search button after results -->
            <button id="newSearchFromResults" type="button" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-[11px] font-bold uppercase tracking-widest border border-dashed border-white/15 bg-white/3 text-slate-400 hover:text-white hover:border-white/30 transition-all mt-1">
              <i class="fa-solid fa-arrow-rotate-left text-xs"></i> ‡§®‡§à ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç
            </button>
          </div>

        </div>
      </div>

      <!-- ‚ïê‚ïê RIGHT COLUMN ‚ïê‚ïê -->
      <div class="lg:col-span-9 space-y-6 relative">

        <!-- Empty State -->
        <div id="emptyState" class="glass rounded-[40px] flex flex-col items-center justify-center text-center p-10 min-h-[600px] relative overflow-hidden">
          <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjEpIi8+PC9zdmc+')] opacity-50"></div>
          
          <!-- Animated face scan placeholder -->
          <div class="w-44 h-44 rounded-full flex items-center justify-center mb-10 bg-slate-900/60 border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)] animate-float relative z-10">
            <svg class="absolute" width="176" height="176" viewBox="0 0 176 176">
              <circle cx="88" cy="88" r="80" fill="none" stroke="rgba(212,160,23,0.15)" stroke-width="1"/>
              <circle cx="88" cy="88" r="80" fill="none" stroke="rgba(212,160,23,0.5)" stroke-width="2" stroke-dasharray="502" stroke-dashoffset="502" style="animation:faceScanDash 3s linear infinite;transform-origin:center;"/>
              <circle cx="88" cy="88" r="68" fill="none" stroke="rgba(62,207,178,0.3)" stroke-width="1" stroke-dasharray="427" stroke-dashoffset="427" style="animation:faceScanDash 3s linear infinite 1.5s;transform-origin:center;"/>
            </svg>
            <!-- Corner brackets -->
            <div style="position:absolute;top:12px;left:12px;width:24px;height:24px;border-top:3px solid rgba(212,160,23,0.7);border-left:3px solid rgba(212,160,23,0.7);border-radius:4px 0 0 0;animation:scanCorner 2s ease-in-out infinite;"></div>
            <div style="position:absolute;top:12px;right:12px;width:24px;height:24px;border-top:3px solid rgba(212,160,23,0.7);border-right:3px solid rgba(212,160,23,0.7);border-radius:0 4px 0 0;animation:scanCorner 2s ease-in-out infinite 0.25s;"></div>
            <div style="position:absolute;bottom:12px;left:12px;width:24px;height:24px;border-bottom:3px solid rgba(212,160,23,0.7);border-left:3px solid rgba(212,160,23,0.7);border-radius:0 0 0 4px;animation:scanCorner 2s ease-in-out infinite 0.5s;"></div>
            <div style="position:absolute;bottom:12px;right:12px;width:24px;height:24px;border-bottom:3px solid rgba(212,160,23,0.7);border-right:3px solid rgba(212,160,23,0.7);border-radius:0 0 4px 0;animation:scanCorner 2s ease-in-out infinite 0.75s;"></div>
            <i class="fa-solid fa-microchip text-6xl text-slate-500 relative z-10"></i>
          </div>
          <h3 class="font-display text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 mb-4 tracking-widest uppercase relative z-10">AI Engine Ready</h3>
          <p class="text-base text-slate-400 max-w-md leading-relaxed mb-12 relative z-10" style="font-family:'Noto Sans Devanagari',sans-serif;">‡§¨‡§æ‡§à‡§Ç ‡§§‡§∞‡§´ ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§° AI ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§™‡•Ç‡§∞‡•á ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•ã ‡§Æ‡§ø‡§≤‡•Ä‡§∏‡•á‡§ï‡§Ç‡§°‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§ó‡§æ‡•§</p>
          
          <div class="grid grid-cols-3 gap-4 sm:gap-6 w-full max-w-lg relative z-10">
            <div class="p-5 sm:p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-md transition-all duration-300 hover:-translate-y-2 hover:bg-white/10 hover:border-gold-400/30 group shadow-lg">
              <i class="fa-solid fa-face-viewfinder mb-4 text-3xl text-gold-400/60 group-hover:text-gold-400 transition-colors"></i>
              <span class="text-[11px] font-bold text-slate-300 block uppercase tracking-widest">Face AI</span>
            </div>
            <div class="p-5 sm:p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-md transition-all duration-300 hover:-translate-y-2 hover:bg-white/10 hover:border-teal-400/30 group shadow-lg">
              <i class="fa-solid fa-bolt mb-4 text-3xl text-teal-400/60 group-hover:text-teal-400 transition-colors"></i>
              <span class="text-[11px] font-bold text-slate-300 block uppercase tracking-widest">Instant</span>
            </div>
            <div class="p-5 sm:p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-md transition-all duration-300 hover:-translate-y-2 hover:bg-white/10 hover:border-red-400/30 group shadow-lg">
              <i class="fa-solid fa-shield-halved mb-4 text-3xl text-red-400/60 group-hover:text-red-400 transition-colors"></i>
              <span class="text-[11px] font-bold text-slate-300 block uppercase tracking-widest">Secure</span>
            </div>
          </div>
        </div>

        <!-- Skeleton Loader -->
        <div id="skeletonLoader" class="hidden glass rounded-[40px] p-10 min-h-[600px] relative overflow-hidden">
          <div class="skeleton-scan-line"></div>
          <div class="flex gap-5 mb-12 border-b border-white/10 pb-8">
            <div class="h-12 w-40 rounded-2xl skeleton"></div>
            <div class="h-12 w-40 rounded-2xl skeleton"></div>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-5 mb-12">
             <div class="aspect-square rounded-3xl skeleton"></div>
             <div class="aspect-square rounded-3xl skeleton"></div>
             <div class="aspect-square rounded-3xl skeleton"></div>
             <div class="aspect-square rounded-3xl skeleton hidden sm:block"></div>
          </div>
          <div class="space-y-8 pl-12 relative border-l-2 border-white/10">
            <div class="relative"><div class="absolute -left-[57px] top-8 w-6 h-6 rounded-full skeleton border-4 border-[#02050A]"></div><div class="rounded-3xl skeleton h-40 w-full"></div></div>
            <div class="relative"><div class="absolute -left-[57px] top-8 w-6 h-6 rounded-full skeleton border-4 border-[#02050A]"></div><div class="rounded-3xl skeleton h-32 w-3/4"></div></div>
          </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden animate-fadeup">

          <!-- Compact top bar: Tabs + Filters + Slideshow -->
          <div class="glass rounded-2xl overflow-hidden mb-4 sticky top-20 z-30" style="border:1px solid rgba(255,255,255,0.07);">
            <div class="flex items-center border-b px-3 gap-1" style="border-color:rgba(255,255,255,0.06);background:rgba(2,5,10,0.6);">
              <button type="button" id="btnTabPhotos" class="tab-btn tab-active flex-shrink-0 px-4 py-3 text-xs gap-2 whitespace-nowrap" style="min-height:44px;font-size:12px;letter-spacing:0.05em;">
                <i class="fa-regular fa-images"></i><span>Photos</span>
              </button>
              <button type="button" id="btnTabTimeline" class="tab-btn flex-shrink-0 px-4 py-3 text-xs gap-2 whitespace-nowrap" style="min-height:44px;font-size:12px;letter-spacing:0.05em;">
                <i class="fa-solid fa-timeline"></i><span>Timeline</span>
              </button>
              <div class="flex-1"></div>
              <button type="button" id="btnAllSlideshow" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gold-400/10 text-gold-400 font-extrabold uppercase tracking-widest hover:bg-gold-400 hover:text-navy-950 transition-all border border-gold-400/40 flex-shrink-0" style="font-size:10px;">
                <i class="fa-solid fa-play text-xs"></i><span class="hidden sm:inline">Play All</span>
              </button>
            </div>

            <div id="timelineFilters" class="hidden items-center gap-2 px-4 py-2.5 overflow-x-auto hide-scroll" style="background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.04);">
              <button class="filter-btn filter-pill active" data-filter="all" style="font-family:'Noto Sans Devanagari',sans-serif;font-size:10px;padding:5px 12px;">‡§∏‡§≠‡•Ä <span class="filter-count" id="countAll">0</span></button>
              <button class="filter-btn filter-pill" data-filter="visitor_form" style="font-size:10px;padding:5px 12px;">Visitor <span class="filter-count" id="countVisitor">0</span></button>
              <button class="filter-btn filter-pill" data-filter="president_tour_form" style="font-size:10px;padding:5px 12px;">Tour <span class="filter-count" id="countTour">0</span></button>
              <button class="filter-btn filter-pill" data-filter="party_attendance" style="font-size:10px;padding:5px 12px;">Attendance <span class="filter-count" id="countAttendance">0</span></button>
              <button class="filter-btn filter-pill" data-filter="mandal_reporting_form" style="font-size:10px;padding:5px 12px;">Mandal <span class="filter-count" id="countMandal">0</span></button>
              <div class="ml-auto flex items-center gap-2 flex-shrink-0 pl-3" style="border-left:1px solid rgba(255,255,255,0.08);">
                <input type="date" id="tlFromDate" class="rounded-lg px-2 py-1 text-[10px] font-bold bg-slate-900/80 border border-white/10 text-slate-300 focus:border-gold-400 outline-none transition-colors" style="width:110px;" title="From">
                <i class="fa-solid fa-arrow-right-long text-slate-600 text-xs"></i>
                <input type="date" id="tlToDate" class="rounded-lg px-2 py-1 text-[10px] font-bold bg-slate-900/80 border border-white/10 text-slate-300 focus:border-gold-400 outline-none transition-colors" style="width:110px;" title="To">
                <button id="btnDownloadTimeline" title="Export" class="flex items-center gap-1 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase bg-white/5 border border-white/10 text-white hover:bg-white/10 transition-all">
                  <i class="fa-solid fa-file-export text-slate-400 text-xs"></i><span class="hidden sm:inline">Export</span>
                </button>
              </div>
              <div id="btnAiReportTimeline" class="hidden"></div>
            </div>
          </div>

          <!-- Photos View - directly visible -->
          <div id="viewPhotos" class="animate-fadeup">
            <div id="photosGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
              <!-- injected -->
            </div>
            <div class="text-center mt-6 text-[10px] font-extrabold tracking-[0.15em] uppercase flex items-center justify-center gap-2 text-slate-500 py-3 rounded-2xl border border-white/5" style="background:rgba(255,255,255,0.02);">
              <i class="fa-solid fa-shield-check text-teal-400 text-xs"></i> 100% Encrypted & Secure Database
            </div>
          </div>

          <!-- Timeline View -->
          <div id="viewTimeline" class="hidden relative pl-8 sm:pl-10 timeline-rail space-y-6 animate-fadeup pb-8">
            <!-- injected -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PPT SLIDESHOW OVERLAY ‚ïê‚ïê -->
  <div id="slideshowOverlay">
    <div id="slideshowTopBar">
      <div style="display:flex;align-items:center;gap:16px;min-width:0;flex:1;">
        <button id="ssClose" class="ss-ctrl-btn"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div id="slideshowTitle">Event</div>
      </div>
      <div style="display:flex;align-items:center;gap:16px;flex-shrink:0;">
        <div id="slideshowCounter"></div>
        <button id="ssAutoplay" class="ss-ctrl-btn"><i class="fa-solid fa-play text-base"></i></button>
      </div>
    </div>
    <div id="slideshowProgress"><div id="slideshowProgressBar" style="width:0%"></div></div>
    <div id="slideshowMain">
      <div id="ssPhotoSide">
        <button class="ss-nav-btn" id="ssPrev"><i class="fa-solid fa-chevron-left"></i></button>
        <img id="slideshowImg" src="" alt="Event Photo" />
        <button class="ss-nav-btn" id="ssNext"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
      <div id="ssDetailSide">
        <div id="ssDetailHeader">
          <div id="ssDetailTitle">Event Details</div>
          <div id="ssDetailBadges" class="flex flex-wrap gap-2 mt-4"></div>
        </div>
        <div id="ssDetailScroll" class="custom-scrollbar">
          <!-- detail rows injected -->
        </div>
      </div>
    </div>
    <div id="ssThumbRow" class="custom-scrollbar"></div>
  </div>

  <!-- ‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê -->
  <div id="detailModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 transition-opacity opacity-0 bg-black/90 backdrop-blur-md" id="modalBackdrop"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4 sm:p-8">
        <div class="relative w-full h-full lg:h-auto lg:max-h-[90vh] lg:max-w-5xl transform overflow-hidden rounded-[32px] text-left shadow-[0_0_100px_rgba(0,0,0,1)] transition-all opacity-0 scale-95 flex flex-col modal-panel" id="modalPanel">
          <div class="flex items-center justify-between px-8 py-6 z-10 bg-white/5 border-b border-white/10 backdrop-blur-xl">
            <h3 class="font-bold text-white text-lg pr-4 truncate tracking-wide" id="detailModalTitle">Details</h3>
            <button id="detailModalClose" class="w-12 h-12 flex items-center justify-center rounded-full bg-white/5 text-slate-300 hover:text-white hover:bg-white/10 transition-all border border-white/10 hover:scale-110">
              <i class="fa-solid fa-xmark text-xl"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto custom-scrollbar bg-black/40" id="detailModalBody"></div>
          <div id="carouselControls" class="hidden absolute top-1/2 -translate-y-1/2 w-full flex justify-between px-6 pointer-events-none">
            <button id="prevBtn" class="pointer-events-auto w-14 h-14 rounded-full flex items-center justify-center text-white bg-black/60 border border-white/20 backdrop-blur-xl hover:bg-gold-400 hover:text-black hover:border-gold-400 transition-all hover:scale-110 shadow-xl"><i class="fa-solid fa-chevron-left text-xl"></i></button>
            <button id="nextBtn" class="pointer-events-auto w-14 h-14 rounded-full flex items-center justify-center text-white bg-black/60 border border-white/20 backdrop-blur-xl hover:bg-gold-400 hover:text-black hover:border-gold-400 transition-all hover:scale-110 shadow-xl"><i class="fa-solid fa-chevron-right text-xl"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(212,160,23,0.6); }
    
    /* Timeline Card Override for Premium look */
    .timeline-card-premium {
       background: linear-gradient(145deg, rgba(17,32,68,0.5) 0%, rgba(6,13,31,0.8) 100%);
       border: 1px solid rgba(255,255,255,0.08); 
       border-left: 4px solid var(--gold-400);
       border-radius: 24px;
       padding: 20px;
       backdrop-filter: blur(20px);
       transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
       box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .timeline-card-premium:hover {
       background: linear-gradient(145deg, rgba(17,32,68,0.7) 0%, rgba(6,13,31,0.9) 100%);
       transform: translateX(8px) translateY(-2px); 
       box-shadow: 0 20px 40px rgba(0,0,0,0.6), -5px 0 30px rgba(212,160,23,0.2); 
       border-color: rgba(212,160,23,0.4); 
    }
    @media (hover: none) {
      .timeline-card-premium:hover { transform: none; }
      .timeline-card-premium:active { opacity: 0.85; transform: scale(0.99); }
    }
  </style>

<!-- ‚ïê‚ïê JAVASCRIPT (Untouched, Logic completely preserved) ‚ïê‚ïê -->
<script>
(() => {
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  const apiKey = "";

  const qs = new URLSearchParams(window.location.search);
  const token = qs.get("token") || "";
  let resolvedCid = qs.get("cid") || qs.get("collection_id") || ""; 

  let galleryImages = [];
  let currentGalleryIndex = 0;
  let globalTimelineData = [];
  let globalPhotoMap = new Map();
  let currentFilter = 'all';
  let pendingSearchRes = null;

  const el = {
    selfieInput: document.getElementById("selfieInput"),
    preview: document.getElementById("preview"),
    statusBox: document.getElementById("statusBox"),
    emptyState: document.getElementById("emptyState"),
    statsDashboard: document.getElementById("statsDashboard"),
    resultsContainer: document.getElementById("resultsContainer"),
    skeletonLoader: document.getElementById("skeletonLoader"),
    scoreVal: document.getElementById("scoreVal"),
    scoreBar: document.getElementById("scoreBar"),
    eventCountVal: document.getElementById("eventCountVal"),
    photoCountVal: document.getElementById("photoCountVal"),
    btnTabTimeline: document.getElementById("btnTabTimeline"),
    btnTabPhotos: document.getElementById("btnTabPhotos"),
    viewTimeline: document.getElementById("viewTimeline"),
    viewPhotos: document.getElementById("viewPhotos"),
    photosGrid: document.getElementById("photosGrid"),
    timelineFilters: document.getElementById("timelineFilters"),
    searchBtn: document.getElementById("searchBtn"),
    copySummaryBtn: document.getElementById("copySummaryBtn"),
    copySummaryBtnMobile: document.getElementById("copySummaryBtnMobile"),
    btnAiReport: document.getElementById("btnAiReport"),
    btnAiReportTimeline: document.getElementById("btnAiReportTimeline"),
    step1Card: document.getElementById("step1Card"),
    step2Card: document.getElementById("step2Card"),
    uploadInput: document.getElementById("uploadInput"),
    matchTitle: document.getElementById("matchTitle"),
    matchSubtitle: document.getElementById("matchSubtitle"),
    matchPills: document.getElementById("matchPills"),
    confirmBtn: document.getElementById("confirmBtn"),
    newSearchBtn: document.getElementById("newSearchBtn"),
    nameInput: document.getElementById("nameInput"),
    mobileInput: document.getElementById("mobileInput"),
    mobileError: document.getElementById("mobileError"),
    btnAllSlideshow: document.getElementById("btnAllSlideshow"),
    similarityText: document.getElementById("similarityText"),
    timelineCount: document.getElementById("timelineCount"),
    photoCount: document.getElementById("photoCount"),
  };

  function setStep(n) {
    const nums = [document.getElementById("step1Num"), document.getElementById("step2Num"), document.getElementById("step3Num")];
    const lines = [document.getElementById("stepLine1"), document.getElementById("stepLine2")];
    const labels = [null, document.getElementById("step2Label"), document.getElementById("step3Label")];
    nums.forEach((el, i) => {
      if (i + 1 < n) { el.className = "step-num done"; el.innerHTML = '<i class="fa-solid fa-check text-sm"></i>'; }
      else if (i + 1 === n) { el.className = "step-num active"; el.textContent = i + 1; }
      else { el.className = "step-num pending"; el.textContent = i + 1; }
    });
    lines.forEach((el, i) => {
      if (el) el.className = "step-line" + (i + 1 < n ? " done" : "");
    });
    labels.forEach((el, i) => {
      if (!el) return;
      el.style.color = (i + 1 <= n) ? "#fff" : "#64748b";
    });
  }

  function validateStep2() {
    let ok = true;
    const name = el.nameInput.value.trim();
    const mobile = el.mobileInput.value.trim();
    if (!name) { el.nameInput.classList.add("has-error"); ok = false; } else { el.nameInput.classList.remove("has-error"); }
    if (!mobile || !/^\d{10}$/.test(mobile)) {
      el.mobileInput.classList.add("has-error");
      el.mobileError.classList.remove("hidden");
      ok = false;
    } else { el.mobileInput.classList.remove("has-error"); el.mobileError.classList.add("hidden"); }
    return ok;
  }

  el.nameInput && el.nameInput.addEventListener("input", () => el.nameInput.classList.remove("has-error"));
  el.mobileInput && el.mobileInput.addEventListener("input", () => { el.mobileInput.classList.remove("has-error"); el.mobileError.classList.add("hidden"); });

  if (el.newSearchBtn) {
    el.newSearchBtn.addEventListener("click", () => {
      el.step2Card.classList.add("hidden");
      el.step1Card.classList.remove("hidden");
      el.statsDashboard.classList.add("hidden");
      el.resultsContainer.classList.add("hidden");
      el.emptyState.classList.remove("hidden");
      el.skeletonLoader.classList.add("hidden");
      if (el.selfieInput) { el.selfieInput.value = ""; previewImage(el.selfieInput); }
      if (el.nameInput) el.nameInput.value = "";
      if (el.mobileInput) el.mobileInput.value = "";
      pendingSearchRes = null;
      setStep(1);
    });
  }

  // New search button visible after results
  const newSearchFromResults = document.getElementById('newSearchFromResults');
  if (newSearchFromResults) {
    newSearchFromResults.addEventListener('click', () => {
      el.step1Card.classList.remove("hidden");
      el.step2Card.classList.add("hidden");
      el.statsDashboard.classList.add("hidden");
      el.resultsContainer.classList.add("hidden");
      el.emptyState.classList.remove("hidden");
      el.skeletonLoader.classList.add("hidden");
      if (el.selfieInput) { el.selfieInput.value = ""; previewImage(el.selfieInput); }
      if (el.nameInput) el.nameInput.value = "";
      if (el.mobileInput) el.mobileInput.value = "";
      pendingSearchRes = null;
      setStep(1);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  function switchTab(tab) {
    const tActive = "tab-btn tab-active flex-shrink-0 px-4 py-3 text-xs gap-2 whitespace-nowrap";
    const tInactive = "tab-btn flex-shrink-0 px-4 py-3 text-xs gap-2 whitespace-nowrap";
    if (tab === 'timeline') {
      el.viewTimeline.classList.remove('hidden');
      if (el.timelineFilters) { el.timelineFilters.classList.remove('hidden'); el.timelineFilters.classList.add('flex'); }
      el.viewPhotos.classList.add('hidden');
      if (el.btnTabTimeline) el.btnTabTimeline.className = tActive;
      if (el.btnTabPhotos) el.btnTabPhotos.className = tInactive;
      // Sync globalPhotoMap to window so renderTimelineGroups can use it
      window._globalPhotoMap = globalPhotoMap;
      window.globalPhotoMap = globalPhotoMap;
    } else {
      el.viewTimeline.classList.add('hidden');
      if (el.timelineFilters) { el.timelineFilters.classList.add('hidden'); el.timelineFilters.classList.remove('flex'); }
      el.viewPhotos.classList.remove('hidden');
      if (el.btnTabTimeline) el.btnTabTimeline.className = tInactive;
      if (el.btnTabPhotos) el.btnTabPhotos.className = tActive;
    }
  }
  if (el.btnTabTimeline) el.btnTabTimeline.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation();
    switchTab('timeline');
  });
  if (el.btnTabPhotos) el.btnTabPhotos.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation();
    switchTab('photos');
  });

  function initFilters() {
    const btns = el.timelineFilters.querySelectorAll('.filter-btn');
    btns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        window.currentFilter = currentFilter;
        applyFilter();
      });
    });
    const fromEl = document.getElementById("tlFromDate");
    const toEl = document.getElementById("tlToDate");
    if (fromEl) fromEl.addEventListener("change", applyFilter);
    if (toEl) toEl.addEventListener("change", applyFilter);
    const dlBtn = document.getElementById("btnDownloadTimeline");
    if (dlBtn) dlBtn.addEventListener("click", downloadTimelineHtml);
  }
  function applyFilter() {
    if (!globalTimelineData.length) return;
    if (window.currentFilter !== undefined) currentFilter = window.currentFilter;
    let filtered = globalTimelineData;
    if (currentFilter !== 'all') {
      filtered = filtered.filter(item => {
        const type = (item.form_type || item.ft || "").toString().toLowerCase().trim();
        const target = currentFilter.toLowerCase().trim();
        return type === target || type.replace('_form','') === target.replace('_form','') || type.includes(target.replace('_form',''));
      });
    }
    const fromEl = document.getElementById("tlFromDate");
    const toEl = document.getElementById("tlToDate");
    if (fromEl && fromEl.value) {
      const fromMs = new Date(fromEl.value + "T00:00:00").getTime();
      filtered = filtered.filter(item => {
        const ms = new Date(item.created_at_iso || item.created_at || 0).getTime();
        return ms >= fromMs;
      });
    }
    if (toEl && toEl.value) {
      const toMs = new Date(toEl.value + "T23:59:59").getTime();
      filtered = filtered.filter(item => {
        const ms = new Date(item.created_at_iso || item.created_at || 0).getTime();
        return ms <= toMs;
      });
    }
    renderTimeline(filtered, globalPhotoMap);
  }

  function downloadTimelineHtml() {
    if (!globalTimelineData.length) return;
    const name = (document.getElementById("nameInput") || {}).value || "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ";
    const rows = globalTimelineData.map(item => {
      const ft = item.form_type || "";
      const d = item.data || {};
      const date = item.created_at_iso ? item.created_at_iso.slice(0,10) : "";
      const prog = d.program_name || d.program_type || ft;
      const dist = d.district || "";
      const vidhan = d.vidhansabha || "";
      return `<tr style="border-bottom:1px solid #e2e8f0"><td style="padding:6px 10px">${date}</td><td style="padding:6px 10px">${ft}</td><td style="padding:6px 10px">${prog}</td><td style="padding:6px 10px">${dist}</td><td style="padding:6px 10px">${vidhan}</td></tr>`;
    }).join("");
    const html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + name + ' - Timeline<\/title>' + '<style>body{font-family:sans-serif;padding:20px;color:#1e293b}h2{color:#f97316}table{width:100%;border-collapse:collapse}' + 'th{background:#f97316;color:white;padding:8px 10px;text-align:left}tr:nth-child(even){background:#f8fafc}@media print{body{padding:0}}<\/style><\/head>' + '<body><h2>üìã ' + name + ' ‚Äî Activity Timeline<\/h2>' + '<p style="color:#64748b">Total Events: ' + globalTimelineData.length + ' | Generated: ' + new Date().toLocaleDateString("hi-IN") + '<\/p>' + '<table><tr><th>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï<\/th><th>Form Type<\/th><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ<\/th><th>‡§ú‡§ø‡§≤‡§æ<\/th><th>‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ<\/th><\/tr>' + rows + '<\/table><\/body><\/html>';
    const blob = new Blob([html], {type:"text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${name}_timeline.html`;
    a.click();
  }

  function doCopy() {
    const score = el.scoreVal.textContent, events = el.eventCountVal.textContent, photos = el.photoCountVal.textContent;
    const text = `*EventLens Search Result*\nSimilarity: ${score}\nEvents Found: ${events}\nPhotos Found: ${photos}\n\nGenerated by EventLens AI`;
    navigator.clipboard.writeText(text).then(() => {
      [el.copySummaryBtn, el.copySummaryBtnMobile].forEach(b => { if (!b) return; const o = b.innerHTML; b.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Copied!'; setTimeout(() => b.innerHTML = o, 2000); });
      if (typeof showToast === 'function') showToast('Report copied to clipboard!', 'success');
    });
  }
  if (el.copySummaryBtn) el.copySummaryBtn.addEventListener('click', doCopy);
  if (el.copySummaryBtnMobile) el.copySummaryBtnMobile.addEventListener('click', doCopy);

  const modal = (() => {
    const wrap = document.getElementById("detailModal"), backdrop = document.getElementById("modalBackdrop"),
          panel = document.getElementById("modalPanel"), titleEl = document.getElementById("detailModalTitle"),
          bodyEl = document.getElementById("detailModalBody"), closeBtn = document.getElementById("detailModalClose"),
          controls = document.getElementById("carouselControls"), prevBtn = document.getElementById("prevBtn"), nextBtn = document.getElementById("nextBtn");
    function open(title, bodyNode, isGallery = false) {
      titleEl.textContent = title || "Details"; bodyEl.innerHTML = "";
      if (bodyNode) bodyEl.appendChild(bodyNode);
      if (isGallery && galleryImages.length > 1) controls.classList.remove("hidden"); else controls.classList.add("hidden");
      wrap.classList.remove("hidden");
      requestAnimationFrame(() => { backdrop.classList.remove("opacity-0"); panel.classList.remove("opacity-0","scale-95"); panel.classList.add("opacity-100","scale-100"); });
      document.body.classList.add("overflow-hidden");
    }
    function close() {
      backdrop.classList.add("opacity-0"); panel.classList.remove("opacity-100","scale-100"); panel.classList.add("opacity-0","scale-95");
      setTimeout(() => { wrap.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); }, 300);
    }
    function showGalleryImage(index) {
      if (index < 0) index = galleryImages.length - 1;
      if (index >= galleryImages.length) index = 0;
      currentGalleryIndex = index;
      const item = galleryImages[index];
      titleEl.textContent = `${item.title} (${index+1}/${galleryImages.length})`;
      const body = document.createElement("div"); body.className = "h-full flex flex-col"; body.style.background = "transparent";
      const imgCont = document.createElement("div"); imgCont.className = "flex-1 flex items-center justify-center p-6";
      const img = document.createElement("img"); img.src = item.url; img.className = "max-w-full max-h-full object-contain rounded-2xl shadow-2xl"; imgCont.appendChild(img);
      const actions = document.createElement("div"); actions.className = "p-6 flex justify-between items-center bg-black/50 border-t border-white/10 backdrop-blur-xl";
      const dlBtn = document.createElement("a"); dlBtn.href = item.url; dlBtn.download = `event_photo_${index}.jpg`; dlBtn.className = "px-6 py-3 rounded-2xl text-sm font-bold uppercase tracking-widest flex items-center gap-3 text-navy-950 bg-gold-400 hover:bg-gold-300 transition-all shadow-[0_0_20px_rgba(212,160,23,0.4)]"; dlBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download'; actions.appendChild(dlBtn);
      body.appendChild(imgCont); body.appendChild(actions); bodyEl.innerHTML = ""; bodyEl.appendChild(body);
    }
    closeBtn.addEventListener("click", close);
    backdrop.addEventListener("click", e => { if (e.target === backdrop) close(); });
    prevBtn.addEventListener("click", e => { e.stopPropagation(); showGalleryImage(currentGalleryIndex - 1); });
    nextBtn.addEventListener("click", e => { e.stopPropagation(); showGalleryImage(currentGalleryIndex + 1); });
    document.addEventListener('keydown', e => {
      if (wrap.classList.contains('hidden')) return;
      if (e.key === 'ArrowLeft') showGalleryImage(currentGalleryIndex - 1);
      if (e.key === 'ArrowRight') showGalleryImage(currentGalleryIndex + 1);
      if (e.key === 'Escape') close();
    });
    return { open, close, showGalleryImage };
  })();

  function isNonEmpty(v) { return v !== null && v !== undefined && String(v).trim() !== ""; }
  function escapeHtml(s) { if (s === null || s === undefined) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
  function prettyIso(iso) { if (!isNonEmpty(iso)) return ""; const d = new Date(iso); return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }); }
  function setStatus(msg, type = "info") {
    if (!el.statusBox) return;
    if (msg) {
      el.statusBox.classList.remove("hidden");
      const colors = { error: 'bg-red-500/10 border-red-500/30 text-red-400', success: 'bg-teal-400/10 border-teal-400/30 text-teal-400', loading: 'bg-gold-400/10 border-gold-400/30 text-gold-400' };
      const style = colors[type] || 'bg-white/5 border-white/10 text-slate-300';
      el.statusBox.innerHTML = `<div class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl text-sm font-bold border ${style} backdrop-blur-md shadow-xl">${type==='loading'?'<i class="fa-solid fa-circle-notch fa-spin"></i>':''}${escapeHtml(msg)}</div>`;
      // Show toast for error/success
      if (typeof showToast === 'function') {
        if (type === 'error' && msg) showToast(msg, 'error');
        else if (type === 'success' && msg) showToast(msg, 'success');
      }
    } else {
      el.statusBox.classList.add("hidden");
      el.statusBox.innerHTML = "";
    }
  }

  function updateDashboard(sim, events, photos) {
    el.emptyState.classList.add("hidden");
    el.skeletonLoader.classList.add("hidden");
    el.statsDashboard.classList.remove("hidden");
    el.resultsContainer.classList.remove("hidden");
    el.copySummaryBtn && el.copySummaryBtn.classList.remove("hidden");
    el.copySummaryBtn && el.copySummaryBtn.classList.add("flex");
    initFilters();
    const simNum = Number(sim);
    el.scoreVal.textContent = `${simNum.toFixed(0)}%`;
    el.scoreBar.style.width = `${Math.min(simNum,100)}%`;
    el.scoreBar.style.background = simNum > 80 ? 'linear-gradient(90deg,#2AB89C,#3ECFB2)' : simNum > 50 ? 'linear-gradient(90deg,#D4A017,#EFC24A)' : 'linear-gradient(90deg,#C41E37,#E63950)';
    // Animated counters
    if (typeof animateCounter === 'function') {
      animateCounter(el.eventCountVal, String(events));
      animateCounter(el.photoCountVal, String(photos));
    } else {
      el.eventCountVal.textContent = events;
      el.photoCountVal.textContent = photos;
    }
    // Arc charts
    if (typeof updateArc === 'function') {
      updateArc('arcMatch', simNum);
      updateArc('arcEvents', Math.min((parseInt(events)||0)/50*100, 100));
      updateArc('arcPhotos', Math.min((parseInt(photos)||0)/100*100, 100));
    }
    // Profile hero
    const nameVal = el.nameInput?.value || '';
    const mobileVal = el.mobileInput?.value || '';
    if (nameVal && typeof updateProfileHero === 'function') updateProfileHero(nameVal, mobileVal, '');
    // Filter count badges
    updateFilterCounts(window.globalTimelineData || []);
    setStep(3);
    // Toast on success
  }

  function updateFilterCounts(timeline) {
    const tl = Array.isArray(timeline) ? timeline : [];
    const counts = { all: tl.length, visitor_form: 0, president_tour_form: 0, party_attendance: 0, mandal_reporting_form: 0 };
    tl.forEach(item => {
      const ft = (item.form_type || item.ft || '').toString().toLowerCase();
      if (ft === 'visitor_form' || ft.includes('visitor')) counts.visitor_form++;
      if (ft === 'president_tour_form' || ft.includes('president') || ft.includes('tour')) counts.president_tour_form++;
      if (ft === 'party_attendance' || ft.includes('attendance')) counts.party_attendance++;
      if (ft === 'mandal_reporting_form' || ft === 'mandal_reporting' || ft.includes('mandal')) counts.mandal_reporting_form++;
    });
    const idMap = { all: 'countAll', visitor_form: 'countVisitor', president_tour_form: 'countTour', party_attendance: 'countAttendance', mandal_reporting_form: 'countMandal' };
    Object.entries(idMap).forEach(([key, id]) => {
      const el2 = document.getElementById(id);
      if (el2) el2.textContent = counts[key] || 0;
    });
  }

  function get(obj, key, fallback = "") { if (!obj) return fallback; const v = obj[key]; return isNonEmpty(v) ? v : fallback; }
  function getFormTypeLabel(ft) {
    const map = {
      president_tour_form: "‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ",
      mandal_reporting: "‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ",
      mandal_reporting_form: "‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ",
      visitor_form: "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§ó‡§®‡•ç‡§§‡•Å‡§ï",
      party_attendance: "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
      coordinator_entry: "‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø‡§ï ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø",
      coordinator_form: "‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø‡§ï ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø",
    };
    return map[ft] || (ft ? ft.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ");
  }

  function buildEventSummary(item) {
    const form = get(item,"form_type",""), data = item.data || {};
    const district = get(item,"district",get(data,"district","")), vidhansabha = get(item,"vidhansabha",get(data,"vidhansabha",""));
    const createdAtIso = prettyIso(get(item,"created_at_iso","")), withLabel = get(item,"with_label","");
    const faceCount = Number(get(item,"face_count",0)||0);
    let title = form || "Event", icon = "fa-calendar-check";
    const highlights = [], footer = [];
    function getFormDate(form, data) {
      const pick = (...keys) => { for (const k of keys) { if (data && data[k] && String(data[k]).trim()) return String(data[k]).trim(); } return ""; };
      const universalKeys = ["tour_date","report_date","attendance_date","event_date","program_date","date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","‡§§‡§æ‡§∞‡•Ä‡§ñ","‡§¶‡§ø‡§®‡§æ‡§Å‡§ï","karyakram_date","form_date"];
      if (form === "president_tour_form") return pick("tour_date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","program_date","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","date","event_date") || pick(...universalKeys);
      if (form === "mandal_reporting" || form === "mandal_reporting_form") return pick("report_date","event_date","program_date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","date") || pick(...universalKeys);
      if (form === "party_attendance") return pick("attendance_date","event_date","program_date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","date") || pick(...universalKeys);
      return pick(...universalKeys);
    }
    const formDate = getFormDate(form, data), displayDate = isNonEmpty(formDate) ? formDate : createdAtIso;
    if (withLabel) highlights.push(withLabel);
    if (faceCount) highlights.push(`${faceCount} faces`);
    const bsPName = data.program_name || data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ"] || data.name_of_program || "";
    const bsPType = data.program_type || data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§™‡•ç‡§∞‡§ï‡§æ‡§∞"] || "";
    if (form === "president_tour_form") { title = bsPName||bsPType||data.tour_title||"‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ"; icon = "fa-plane-departure"; const venue = data.tour_location||data.tour_venue||data.venue||data["‡§∏‡•ç‡§•‡§æ‡§®"]||""; subtitle=[formDate,venue].filter(isNonEmpty).join(" ‚Ä¢ "); if (isNonEmpty(get(data,"guests",""))) highlights.push(["Guests",get(data,"guests","")]); }
    else if (form === "mandal_reporting" || form === "mandal_reporting_form") { title = bsPName||data.venue||data["‡§∏‡•ç‡§•‡§æ‡§®"]||"‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ"; icon = "fa-clipboard-list"; if (isNonEmpty(get(data,"guests",""))) highlights.push(["Guests",get(data,"guests","")]); }
    else if (form === "visitor_form") { title = get(item,"name",get(data,"name",data["‡§®‡§æ‡§Æ"]||"‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§ó‡§®‡•ç‡§§‡•Å‡§ï")); icon = "fa-user-clock"; }
    else if (form === "party_attendance") { title = bsPName||bsPType||"‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø"; icon = "fa-users-line"; }
    else if (form === "coordinator_entry" || form === "coordinator_form") { title = get(data,"name",data["‡§®‡§æ‡§Æ"]||bsPName||"‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø‡§ï ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø"); icon = "fa-id-badge"; }
    else if (bsPName) { title = bsPName; }
    const locBits = [district,vidhansabha].filter(isNonEmpty);
    if (locBits.length) footer.push(locBits.join(", "));
    if (isNonEmpty(displayDate)) footer.push(displayDate);
    const details = [];
    const pushD = (k,v) => { if (isNonEmpty(v)) details.push([k,String(v)]); };
    pushD("Form Type",form); pushD("District",district); pushD("Vidhansabha",vidhansabha);
    pushD("‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï (Form)", isNonEmpty(formDate)?formDate:"‚Äî"); pushD("Entry Date",createdAtIso);
    Object.keys(data).forEach(k => { if (typeof data[k] !== 'object') pushD(k,data[k]); });
    return { title, subtitle: displayDate, highlights, footer, details, rawData: data, icon };
  }

  function makeKVTable(rows) {
    const div = document.createElement("div"); div.className = "space-y-2 p-8";
    rows.forEach(([k,v]) => {
      const row = document.createElement("div"); row.className = "flex flex-col sm:flex-row sm:justify-between py-4 border-b border-white/5 last:border-0";
      row.innerHTML = `<span class="text-xs font-bold uppercase tracking-widest mb-1 text-slate-400 w-1/3">${k}</span><span class="text-base font-medium sm:text-right break-words text-white flex-1">${v}</span>`;
      div.appendChild(row);
    });
    return div;
  }

  function parseS3KeyFromUrl(url) { try { const u = new URL(url), p = u.pathname||""; return p.startsWith("/") ? p.slice(1) : p; } catch(e) { return ""; } }

  function getEventFormDate(formType, data) {
    if (!data) return "";
    const pick = (...keys) => {
      for (const k of keys) {
        const v = data[k];
        if (v && String(v).trim() !== "") return String(v).trim();
      }
      return "";
    };
    const universalDateKeys = ["tour_date","report_date","attendance_date","event_date","program_date","date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","program_date","‡§§‡§æ‡§∞‡•Ä‡§ñ","‡§¶‡§ø‡§®‡§æ‡§Å‡§ï","karyakram_date","karykram_date","form_date","entry_date","submission_date"];
    if (formType === "president_tour_form") return pick("tour_date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","program_date","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","date","event_date") || pick(...universalDateKeys);
    if (formType === "mandal_reporting" || formType === "mandal_reporting_form") return pick("report_date","event_date","program_date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","date") || pick(...universalDateKeys);
    if (formType === "party_attendance") return pick("attendance_date","event_date","program_date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï","date") || pick(...universalDateKeys);
    if (formType === "coordinator_entry" || formType === "coordinator_form") return pick("event_date","program_date","date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï") || pick(...universalDateKeys);
    if (formType === "visitor_form") return pick("visit_date","event_date","date","‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï") || pick(...universalDateKeys);
    return pick(...universalDateKeys);
  }

  function getEventPhotos(item, photoUrlByKey) {
    if (Array.isArray(item.photos) && item.photos.length) return item.photos;
    if (Array.isArray(item.photo_urls) && item.photo_urls.length) return item.photo_urls;
    const s3Key = item.s3_key || "";
    if (isNonEmpty(s3Key) && photoUrlByKey) { const u = photoUrlByKey.get(s3Key); if (u) return [u]; }
    return [];
  }

  const iconColorMap = { 'fa-plane-departure':'#3ECFB2','fa-clipboard-list':'#D4A017','fa-user-clock':'#A78BFA','fa-users-line':'#60A5FA','fa-id-badge':'#F97316','fa-calendar-check':'#D4A017' };

  function renderTimeline(timeline, photoUrlByKey) {
    el.viewTimeline.innerHTML = "";
    if (!Array.isArray(timeline) || timeline.length === 0) {
      el.viewTimeline.innerHTML = `<div class="text-center py-16 text-sm font-bold tracking-widest uppercase text-slate-500 bg-white/5 rounded-3xl border border-white/5">‡§á‡§∏ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§á‡§µ‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç: ${currentFilter}</div>`;
      return;
    }
    const sorted = [...timeline].sort((a,b) => {
      const pd = item => { const fd = getEventFormDate(item.form_type||item.ft||"",item.data||{}); if (fd) { const ps = fd.split(/[-/]/); if (ps.length===3) { const d = ps[0].length===4 ? new Date(ps[0],ps[1]-1,ps[2]) : new Date(ps[2],ps[1]-1,ps[0]); if (!isNaN(d)) return d.getTime(); } } return parseInt(item.created_at||"0",10); };
      return pd(b)-pd(a);
    });
    sorted.forEach((item, index) => {
      const form = item.form_type||item.ft||"", data = item.data||{};
      const formDate = getEventFormDate(form,data);
      const displayDate = formDate || prettyIso(item.created_at_iso||"");
      const pName = data.program_name||data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ"]||data.name_of_program||data.karyakram_name||"";
      const pType = data.program_type||data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§™‡•ç‡§∞‡§ï‡§æ‡§∞"]||data.type||"";
      let title = form||"Event", icon = "fa-calendar-check";
      if (form==="president_tour_form") { title=pName||pType||data.tour_title||"‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ"; icon="fa-plane-departure"; }
      else if (form==="mandal_reporting"||form==="mandal_reporting_form") { title=pName||data.venue||data["‡§∏‡•ç‡§•‡§æ‡§®"]||"‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ"; icon="fa-clipboard-list"; }
      else if (form==="visitor_form") { title=item.name||data.name||data["‡§®‡§æ‡§Æ"]||"‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§ó‡§®‡•ç‡§§‡•Å‡§ï"; icon="fa-user-clock"; }
      else if (form==="party_attendance") { title=pName||pType||"‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø"; icon="fa-users-line"; }
      else if (form==="coordinator_entry"||form==="coordinator_form") { title=data.name||data["‡§®‡§æ‡§Æ"]||pName||"‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø‡§ï ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø"; icon="fa-id-badge"; }
      else if (pName) { title=pName; }
      const district=item.district||data.district||"", vidhansabha=item.vidhansabha||data.vidhansabha||"";
      const locStr=[district,vidhansabha].filter(Boolean).join(", ");
      const eventPhotos=getEventPhotos(item,photoUrlByKey);
      const withLabel=item.with_label||"", faceCount=Number(item.face_count||0);
      const iconColor=iconColorMap[icon]||'#D4A017';

      const wrapper = document.createElement("div"); wrapper.className = "relative pl-4 sm:pl-6 timeline-item stagger-item"; wrapper.style.animationDelay = `${index*60}ms`;
      const dot = document.createElement("div"); dot.className = "timeline-dot absolute w-5 h-5 rounded-full z-10"; dot.style.cssText = "left:-36px; top:24px;"; wrapper.appendChild(dot);
      const card = document.createElement("div");
      const cardClass = form === 'president_tour_form' ? 'tour' : form === 'party_attendance' ? 'attendance' : form === 'mandal_reporting_form' || form === 'mandal_reporting' ? 'mandal' : form === 'visitor_form' ? 'visitor' : '';
      card.className = `timeline-card-premium cursor-pointer ${cardClass}`;

      const mandal = item.mandal || data.mandal || "";
      const guests = data.guests || data["‡§Ö‡§§‡§ø‡§•‡§ø"] || "";
      const venueStr = data.tour_location || data.venue || data.tour_venue || data["‡§∏‡•ç‡§•‡§æ‡§®"] || "";
      const totalAtt = data.total_attendance || data.attendance_count || data["‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø"] || "";
      const designation = data.designation || data["‡§™‡§¶‡§®‡§æ‡§Æ"] || "";
      const level = data.level || data.program_level || data["‡§∏‡•ç‡§§‡§∞"] || "";
      const reportSummary = data.report_summary || data.program_details || data["‡§µ‡§ø‡§µ‡§∞‡§£"] || "";
      const speakers = data.other_speakers || data["‡§µ‡§ï‡•ç‡§§‡§æ"] || "";

      let html = `<div class="flex items-start sm:items-center justify-between gap-4 mb-4 flex-col sm:flex-row">
        <div class="flex items-center gap-4 min-w-0 w-full sm:w-auto">
          <span class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" style="background:${iconColor}15;border:1px solid ${iconColor}40;box-shadow:0 0 15px ${iconColor}20;">
            <i class="fa-solid ${icon} text-base" style="color:${iconColor}"></i>
          </span>
          <h3 class="font-display font-bold text-base sm:text-lg leading-snug text-white tracking-wide" style="overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${escapeHtml(title)}</h3>
        </div>
        ${displayDate ? `<span class="px-3 py-1.5 rounded-lg flex-shrink-0 text-[11px] font-extrabold uppercase tracking-widest whitespace-nowrap self-start sm:self-auto bg-gold-400/10 border border-gold-400/30 text-gold-400">${escapeHtml(displayDate)}</span>` : ""}
      </div>`;

      const infoChips = [];
      if (locStr) infoChips.push(`<span class="text-slate-300 font-medium"><i class="fa-solid fa-location-dot text-[10px] mr-1.5 text-gold-400/60"></i>${escapeHtml(locStr)}</span>`);
      if (mandal) infoChips.push(`<span class="text-slate-300 font-medium"><i class="fa-solid fa-sitemap text-[10px] mr-1.5 text-gold-400/60"></i>${escapeHtml(mandal)}</span>`);
      if (venueStr) infoChips.push(`<span class="text-slate-300 font-medium"><i class="fa-solid fa-map-pin text-[10px] mr-1.5 text-gold-400/60"></i>${escapeHtml(venueStr)}</span>`);
      if (pType && form !== "president_tour_form") infoChips.push(`<span class="text-slate-300 font-medium">${escapeHtml(pType)}</span>`);
      if (infoChips.length) {
        html += `<div class="flex flex-wrap gap-x-5 gap-y-2 mb-4 text-xs">${infoChips.join("")}</div>`;
      }

      const pills = [];
      if (pType && form === "president_tour_form") pills.push({ text: pType, style: "background:rgba(62,207,178,0.1);border:1px solid rgba(62,207,178,0.3);color:#3ECFB2;" });
      if (totalAtt) pills.push({ text: `üë• ${String(totalAtt)} ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§`, style: "background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);color:#60A5FA;" });
      if (level) pills.push({ text: level, style: "background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.3);color:#A78BFA;" });
      if (designation) pills.push({ text: designation, style: "background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);color:#F97316;" });
      if (withLabel) pills.push({ text: `‚úì ${withLabel.split(',')[0].trim()}`, style: "background:rgba(62,207,178,0.1);border:1px solid rgba(62,207,178,0.3);color:#3ECFB2;" });
      if (guests) pills.push({ text: `‡§Ö‡§§‡§ø‡§•‡§ø: ${String(guests).slice(0, 28)}`, style: "background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;" });
      if (speakers) pills.push({ text: `‡§µ‡§ï‡•ç‡§§‡§æ: ${String(speakers).slice(0, 28)}`, style: "background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;" });
      if (pills.length) {
        html += `<div class="flex flex-wrap gap-2.5 mb-4">${pills.map(p => `<span class="text-[10px] px-2.5 py-1 rounded-lg font-bold tracking-wide" style="${p.style}">${escapeHtml(p.text)}</span>`).join("")}</div>`;
      }

      if (reportSummary) {
        html += `<div class="text-xs mb-4 italic text-slate-300 bg-black/30 p-3 rounded-xl border border-white/5 leading-relaxed" style="overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">"${escapeHtml(String(reportSummary))}"</div>`;
      }

      card.innerHTML = html;

      if (eventPhotos.length > 0) {
        const photoSection = document.createElement("div");
        photoSection.style.cssText = "margin-bottom:16px;";

        const allNames = [];
        const addName = (n) => { const t = String(n||"").trim(); if (t && t.length > 1 && !allNames.includes(t)) allNames.push(t); };

        if (Array.isArray(item.with_names)) {
          item.with_names.forEach(n => {
            if (typeof n === 'string') addName(n);
            else if (n && typeof n === 'object') addName(n.name || n.label || n.display_name || "");
          });
        }
        if (allNames.length === 0 && withLabel && withLabel.trim()) {
          const raw = withLabel.replace(/\bwith\b/gi, ',').replace(/\band\b/gi, ',').replace(/\b‡§è‡§Ç‡§°\b/g, ',').replace(/\b‡§î‡§∞\b/g, ',').replace(/\b‡§§‡§•‡§æ\b/g, ',');
          raw.split(',').forEach(n => addName(n));
        }
        const faceSources = [item.faces, item.matched_faces, item.identified_faces];
        faceSources.forEach(arr => {
          if (!Array.isArray(arr)) return;
          arr.forEach(f => { if (!f) return; addName(f.name || f.Name || f.label || f.person_name || f.matched_name || ""); });
        });
        if (Array.isArray(item.photos)) {
          item.photos.forEach(p => { if (p && typeof p === 'object') addName(p.name || p.person_name || p.label || ""); });
        }
        if (form === "visitor_form") addName(item.name || data.name || data["‡§®‡§æ‡§Æ"]);

        const withMore = Number(item.with_more || 0);

        const strip = document.createElement("div");
        strip.style.cssText = "display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;";
        const maxShow = 5;
        eventPhotos.slice(0, maxShow).forEach((u, pi) => {
          const thumb = document.createElement("div");
          thumb.style.cssText = "display:flex;flex-direction:column;align-items:center;gap:6px;flex-shrink:0;";

          const im = document.createElement("img"); setImgSrcWithRetry(im, u);
          im.style.cssText = "width:72px;height:72px;border-radius:16px;object-fit:cover;border:2px solid rgba(255,255,255,0.1);flex-shrink:0;transition:all 0.3s cubic-bezier(0.16, 1, 0.3, 1);display:block;box-shadow:0 4px 10px rgba(0,0,0,0.3);";
          im.onmouseenter = () => { im.style.borderColor = "var(--gold-400)"; im.style.transform = "scale(1.1) translateY(-4px)"; im.style.boxShadow = "0 10px 20px rgba(212,160,23,0.3)"; };
          im.onmouseleave = () => { im.style.borderColor = "rgba(255,255,255,0.1)"; im.style.transform = "scale(1)"; im.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)"; };

          if (allNames[pi]) {
            const nameEl = document.createElement("div");
            const firstName = allNames[pi].split(' ')[0]; 
            nameEl.style.cssText = "font-size:10px;font-weight:800;color:#cbd5e1;text-align:center;max-width:72px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.2;";
            nameEl.title = allNames[pi]; 
            nameEl.textContent = firstName;
            thumb.appendChild(im);
            thumb.appendChild(nameEl);
          } else {
            thumb.appendChild(im);
          }
          strip.appendChild(thumb);
        });

        if (eventPhotos.length > maxShow) {
          const more = document.createElement("div");
          more.style.cssText = "width:72px;height:72px;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px;font-weight:800;background:rgba(212,160,23,0.1);border:2px dashed rgba(212,160,23,0.4);color:var(--gold-400);gap:4px;flex-shrink:0;box-shadow:inset 0 0 20px rgba(212,160,23,0.05);";
          more.innerHTML = `<i class="fa-solid fa-images"></i><span class="text-[11px]">+${eventPhotos.length - maxShow}</span>`;
          strip.appendChild(more);
        }

        photoSection.appendChild(strip);

        if (allNames.length > 0) {
          const nameRow = document.createElement("div");
          nameRow.style.cssText = "margin-top:8px;padding:10px 14px;border-radius:12px;background:rgba(212,160,23,0.08);border:1px solid rgba(212,160,23,0.2);backdrop-filter:blur(10px);";
          const maxShow = 3;
          const shown = allNames.slice(0, maxShow);
          const remaining = (allNames.length - shown.length) + withMore;
          let nameText = shown.map(n => `<span style="color:#F5D78A;font-weight:800;">${escapeHtml(n)}</span>`).join(' <span style="color:#64748b;margin:0 4px;">‚Ä¢</span> ');
          if (remaining > 0) nameText += ` <span style="color:#94a3b8;font-size:11px;font-weight:700;">& ${remaining} ‡§Ö‡§®‡•ç‡§Ø</span>`;
          nameRow.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-users text-[11px]" style="color:#D4A017;flex-shrink:0;"></i><span style="font-size:12px;color:#f1f5f9;line-height:1.5;">${nameText}</span></div>`;
          photoSection.appendChild(nameRow);
        } else if (withMore > 0) {
          const nameRow = document.createElement("div");
          nameRow.style.cssText = "margin-top:8px;font-size:12px;font-weight:700;color:#cbd5e1;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:10px;";
          nameRow.innerHTML = `<i class="fa-solid fa-users text-[11px]"></i><span>${withMore} ‡§Ö‡§®‡•ç‡§Ø ‡§≤‡•ã‡§ó ‡§≠‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§</span>`;
          photoSection.appendChild(nameRow);
        } else if (faceCount > 1) {
          const nameRow = document.createElement("div");
          nameRow.style.cssText = "margin-top:8px;font-size:12px;font-weight:700;color:#cbd5e1;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:10px;";
          nameRow.innerHTML = `<i class="fa-solid fa-users text-[11px]"></i><span>${faceCount} ‡§≤‡•ã‡§ó ‡§™‡§π‡§ö‡§æ‡§®‡•á ‡§ó‡§è</span>`;
          photoSection.appendChild(nameRow);
        }

        card.appendChild(photoSection);
      }

      const footer = document.createElement("div");
      footer.style.cssText = "padding-top:16px;border-top:1px dashed rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:space-between;";
      footer.innerHTML = `<span class="text-[11px] font-extrabold tracking-widest uppercase text-slate-500">${escapeHtml(getFormTypeLabel(form))}</span><span class="text-xs flex items-center gap-2 font-bold text-gold-400 bg-gold-400/10 px-4 py-2 rounded-full hover:bg-gold-400/20 hover:scale-105 transition-all duration-300"><i class="fa-solid fa-expand text-[10px]"></i> View Full Report</span>`;
      card.appendChild(footer);
      card.addEventListener("click", () => openEventSlideshow(item, { title, icon, details: buildEventDetails(item,form,data,displayDate,formDate) }));
      wrapper.appendChild(card);
      el.viewTimeline.appendChild(wrapper);
    });
  }

  function buildEventDetails(item, form, data, displayDate, formDate) {
    const details = [], push = (k, v) => { if (v && String(v).trim()) details.push([k, String(v).trim()]); };
    push("üìÖ ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï", formDate || displayDate);
    push("üìù ‡§´‡•â‡§∞‡•ç‡§Æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞", getFormTypeLabel(form));
    push("üìç ‡§ú‡§ø‡§≤‡§æ", item.district || data.district);
    push("üó≥Ô∏è ‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ", item.vidhansabha || data.vidhansabha);
    push("üïå ‡§Æ‡§Ç‡§°‡§≤", item.mandal || data.mandal);
    push("üèõÔ∏è ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ", data.program_name || data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ"] || data.name_of_program);
    push("üéØ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞", data.program_type || data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§™‡•ç‡§∞‡§ï‡§æ‡§∞"]);
    push("‚≠ê ‡§∏‡•ç‡§§‡§∞", data.level || data.program_level || data["‡§∏‡•ç‡§§‡§∞"]);
    push("üìå ‡§∏‡•ç‡§•‡§æ‡§®", data.tour_location || data.venue || data.tour_venue || data["‡§∏‡•ç‡§•‡§æ‡§®"]);
    push("üë• ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø", data.total_attendance || data.attendance_count || data["‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø"]);
    push("üé§ ‡§µ‡§ï‡•ç‡§§‡§æ", data.other_speakers || data["‡§µ‡§ï‡•ç‡§§‡§æ"]);
    push("üè∑Ô∏è ‡§™‡§¶‡§®‡§æ‡§Æ", data.designation || data["‡§™‡§¶‡§®‡§æ‡§Æ"]);
    if (item.with_label) push("ü§ù ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç", item.with_label);
    if (Array.isArray(item.with_names) && item.with_names.length > 0) {
      const nameStr = item.with_names.join(", ") + (item.with_more > 0 ? ` & ${item.with_more} ‡§Ö‡§®‡•ç‡§Ø` : "");
      push("üë• ‡§™‡§π‡§ö‡§æ‡§®‡•á ‡§ó‡§è ‡§≤‡•ã‡§ó", nameStr);
    }
    push("üìÑ ‡§µ‡§ø‡§µ‡§∞‡§£", data.program_details || data.report_summary || data["‡§µ‡§ø‡§µ‡§∞‡§£"]);
    push("üë§ ‡§Ö‡§§‡§ø‡§•‡§ø", data.guests || data["‡§Ö‡§§‡§ø‡§•‡§ø"]);
    push("üìû ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤", data.mobile || data["‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤"]);
    const skip = new Set(["district","vidhansabha","mandal","program_name","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ","name_of_program","program_type","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§™‡•ç‡§∞‡§ï‡§æ‡§∞","level","program_level","‡§∏‡•ç‡§§‡§∞","tour_location","venue","tour_venue","‡§∏‡•ç‡§•‡§æ‡§®","total_attendance","attendance_count","‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø","other_speakers","‡§µ‡§ï‡•ç‡§§‡§æ","program_details","report_summary","‡§µ‡§ø‡§µ‡§∞‡§£","tour_date","report_date","attendance_date","event_date","name","mobile","designation","‡§™‡§¶‡§®‡§æ‡§Æ","guests","‡§Ö‡§§‡§ø‡§•‡§ø","‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤"]);
    Object.keys(data).forEach(k => {
      if (!skip.has(k) && typeof data[k] !== "object" && isNonEmpty(data[k])) push(k, data[k]);
    });
    return details;
  }

  const SS = (() => {
    let photos = [], idx = 0, autoTimer = null, isPlaying = false, currentDetails = [];
    const overlay = document.getElementById("slideshowOverlay");
    const img = document.getElementById("slideshowImg");
    const counter = document.getElementById("slideshowCounter");
    const titleEl = document.getElementById("slideshowTitle");
    const detailTitle = document.getElementById("ssDetailTitle");
    const detailBadges = document.getElementById("ssDetailBadges");
    const detailScroll = document.getElementById("ssDetailScroll");
    const thumbRow = document.getElementById("ssThumbRow");
    const progBar = document.getElementById("slideshowProgressBar");
    const autoBtn = document.getElementById("ssAutoplay");

    function renderDetailPanel(photoObj) {
      if (!photoObj) return;
      detailTitle.textContent = photoObj.eventTitle || "Event Photo";
      detailBadges.innerHTML = "";
      if (photoObj.formType) {
        const b = document.createElement("span"); b.className = "px-3 py-1 rounded-lg text-[10px] font-extrabold uppercase tracking-widest bg-gold-400/10 border border-gold-400/30 text-gold-400"; b.textContent = photoObj.formType; detailBadges.appendChild(b);
      }
      detailScroll.innerHTML = "";
      const rows = (photoObj.details && photoObj.details.length) ? photoObj.details : currentDetails;
      if (rows && rows.length) {
        rows.forEach(([k, v]) => {
          if (!v || !String(v).trim()) return;
          const row = document.createElement("div"); row.className = "ss-detail-row";
          row.innerHTML = `<div class="ss-detail-key">${escapeHtml(String(k))}</div><div class="ss-detail-val">${escapeHtml(String(v))}</div>`;
          detailScroll.appendChild(row);
        });
      } else {
        detailScroll.innerHTML = `<div class="text-sm pt-6 text-slate-500 font-medium tracking-wide">‡§ï‡•ã‡§à ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</div>`;
      }
    }

    function goTo(i, animate = true) {
      if (!photos.length) return;
      idx = ((i % photos.length) + photos.length) % photos.length;
      progBar.style.width = `${((idx+1)/photos.length)*100}%`;
      counter.textContent = `${idx+1} / ${photos.length}`;
      if (animate) { img.classList.add("fading"); setTimeout(() => { img.src = photos[idx].url; img.onload = () => img.classList.remove("fading"); img.onerror = () => img.classList.remove("fading"); }, 220); }
      else { img.src = photos[idx].url; }
      thumbRow.querySelectorAll(".ss-thumb").forEach((t,ti) => t.classList.toggle("active", ti===idx));
      if (thumbRow.children[idx]) thumbRow.children[idx].scrollIntoView({ behavior:"smooth", block:"nearest", inline:"center" });
      renderDetailPanel(photos[idx]);
    }

    function stopAuto() { clearInterval(autoTimer); autoTimer = null; isPlaying = false; autoBtn.innerHTML = '<i class="fa-solid fa-play"></i>'; }
    function startAuto() { isPlaying = true; autoBtn.innerHTML = '<i class="fa-solid fa-pause"></i>'; autoTimer = setInterval(() => goTo(idx+1), 3500); }

    document.getElementById("ssPrev").addEventListener("click", () => { stopAuto(); goTo(idx-1); });
    document.getElementById("ssNext").addEventListener("click", () => { stopAuto(); goTo(idx+1); });
    document.getElementById("ssClose").addEventListener("click", close);
    autoBtn.addEventListener("click", () => { isPlaying ? stopAuto() : startAuto(); });
    document.addEventListener("keydown", e => {
      if (!overlay.classList.contains("active")) return;
      if (e.key==="ArrowLeft") { stopAuto(); goTo(idx-1); }
      if (e.key==="ArrowRight") { stopAuto(); goTo(idx+1); }
      if (e.key==="Escape") close();
      if (e.key===" ") { isPlaying ? stopAuto() : startAuto(); e.preventDefault(); }
    });

    let touchX = null;
    overlay.addEventListener("touchstart", e => { touchX = e.changedTouches[0].screenX; }, { passive: true });
    overlay.addEventListener("touchend", e => {
      if (touchX === null) return;
      const dx = e.changedTouches[0].screenX - touchX;
      if (Math.abs(dx) > 50) { stopAuto(); goTo(dx < 0 ? idx+1 : idx-1); }
      touchX = null;
    }, { passive: true });

    function open(title, photoList, details, eventTitle, formType) {
      photos = photoList || []; if (!photos.length) return;
      currentDetails = details || [];
      titleEl.textContent = title || "Event";
      thumbRow.innerHTML = "";
      photos.forEach((p,i) => {
        const t = document.createElement("img"); t.src = p.url; t.className = "ss-thumb"; t.alt = "";
        t.addEventListener("click", () => { stopAuto(); goTo(i); }); thumbRow.appendChild(t);
      });
      overlay.classList.add("active");
      document.body.classList.add("overflow-hidden");
      goTo(0, false);
    }
    function close() { stopAuto(); overlay.classList.remove("active"); img.src = ""; document.body.classList.remove("overflow-hidden"); }
    return { open, close };
  })();

  function openEventSlideshow(item, sum) {
    const form = item.form_type||item.ft||"", data = item.data||{};
    const eventPhotos = getEventPhotos(item, globalPhotoMap);
    if (eventPhotos.length === 0) {
      const body = document.createElement("div");
      const det = sum.details||buildEventDetails(item,form,data,getEventFormDate(form,data)||prettyIso(item.created_at_iso||""),getEventFormDate(form,data));
      body.appendChild(makeKVTable(det)); modal.open(sum.title||"Event", body, false); return;
    }
    const formDate = getEventFormDate(form,data), displayDate = formDate||prettyIso(item.created_at_iso||"");
    const details = sum.details||buildEventDetails(item,form,data,displayDate,formDate);
    const enrichedPhotos = eventPhotos.map(u => ({ url:u, eventTitle: sum.title, formType: getFormTypeLabel(form), details }));
    SS.open(sum.title||"Event", enrichedPhotos, details, sum.title, getFormTypeLabel(form));
  }

  function renderPhotos(photoUrls, timeline) {
    el.photosGrid.innerHTML = "";
    galleryImages = [];
    if (!Array.isArray(photoUrls)||photoUrls.length===0) {
      el.photosGrid.innerHTML = `<div class="col-span-full text-center py-16 text-sm font-bold tracking-widest uppercase text-slate-500 bg-white/5 rounded-3xl border border-white/5">‡§ï‡•ã‡§à ‡§´‡•ã‡§ü‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</div>`;
      return;
    }
    const byKey = new Map();
    photoUrls.forEach(u => { const k = parseS3KeyFromUrl(u); if (isNonEmpty(k)&&!byKey.has(k)) byKey.set(k,u); });
    const labelByKey = new Map();
    (timeline||[]).forEach(t => { if (isNonEmpty(t.s3_key)) labelByKey.set(t.s3_key,buildEventSummary(t).title); });
    Array.from(byKey.entries()).forEach(([k,url],idx) => {
      galleryImages.push({ url, title: labelByKey.get(k)||"Event Photo", id: k });
      const wrapper = document.createElement("div"); wrapper.className = "photo-item";
      const img = document.createElement("img"); setImgSrcWithRetry(img,url); img.loading = "lazy"; img.className = "w-full h-full object-cover";
      const playIcon = document.createElement("div"); playIcon.className = "play-icon"; playIcon.innerHTML = '<div style="width:56px;height:56px;border-radius:50%;background:rgba(212,160,23,0.9);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 25px rgba(0,0,0,0.5)"><i class="fa-solid fa-play text-navy-950 text-xl" style="margin-left:4px;"></i></div>';
      wrapper.appendChild(img); wrapper.appendChild(playIcon);
      wrapper.addEventListener("click", () => { modal.open("Gallery",null,true); modal.showGalleryImage(idx); });
      el.photosGrid.appendChild(wrapper);
    });
  }

  async function apiCall(action, payload, tokenOpt) {
    const isPublic = !!tokenOpt;
    const url = isPublic ? `${BASE_URL}/political/public/search` : `${BASE_URL}/political/search`;
    const body = { action, payload: payload||{} }; if (isPublic) body.token = tokenOpt;
    const headers = { "Content-Type":"application/json" };
    if (!isPublic) { const idToken = localStorage.getItem("id_token")||localStorage.getItem("idToken")||""; if (idToken) headers["Authorization"] = `Bearer ${idToken}`; }
    const resp = await fetch(url, { method:"POST", headers, body:JSON.stringify(body) });
    const txt = await resp.text(); let json = {};
    try { json = JSON.parse(txt); } catch(e) { json = { message: txt||"Invalid JSON" }; }
    if (!resp.ok) throw new Error(json.message||`HTTP ${resp.status}`);
    return json;
  }

  async function loadSearchBranding() {
    try {
      const isPublic = !!token;
      const brandPayload = isPublic
        ? { token, form_type:"search" }
        : { collection_id: (qs.get("cid")||qs.get("collection_id")||""), form_type:"search" };
      const brandAction = isPublic ? "public_get_config" : "admin_get_config";
      const brandUrl = isPublic ? `${BASE_URL}/political/public/forms` : `${BASE_URL}/political/forms`;
      const bRes = await fetch(brandUrl, {
        method:"POST", cache:"no-store",
        body:JSON.stringify({ action:brandAction, payload:brandPayload })
      });
      const bData = await bRes.json();
      const cfg = bData && (bData.config || bData.settings || bData.data || bData);
      if (!resolvedCid) {
        const cid = bData.collection_id || bData.cid ||
          (bData.config && (bData.config.collection_id || bData.config.cid)) ||
          (bData.settings && (bData.settings.collection_id || bData.settings.cid)) || "";
        if (cid) resolvedCid = cid.trim();
      }
      if (!cfg) return;

      const defaults = cfg.defaults || {};
      const branding = (defaults.branding) || {};
      const forms = cfg.forms || {};
      const ft = forms["search"] || forms["search_form"] || {};
      const ftBrand = ft.branding || {};

      const c1 = ft.primary_color || ftBrand.color1 || branding.color1 || (cfg.global && cfg.global.theme && cfg.global.theme.primary) || "#D4A017";
      const c2 = ft.secondary_color || ftBrand.color2 || branding.color2 || (cfg.global && cfg.global.theme && cfg.global.theme.secondary) || "#E63950";
      const root = document.documentElement;
      if (c1 && c1 !== "#D4A017") {
        root.style.setProperty("--gold-400", c1);
        root.style.setProperty("--gold-500", c1);
        const styleEl = document.createElement("style");
        styleEl.id = "el-brand-override";
        styleEl.textContent = `
          :root{--gold-400:${c1};--gold-500:${c1};--crimson-500:${c2};}
          .brand-bg-search { background:linear-gradient(135deg,${c1},${c2}) !important; }
          .logo-icon { background:linear-gradient(135deg,${c1},${c2}) !important; }
        `;
        document.head.appendChild(styleEl);
      }

      const logoUrl = ft.logo_url || ftBrand.logo_url || (ftBrand.logo && ftBrand.logo.url) || (branding.logo && branding.logo.url) || "";
      if (logoUrl) {
        const logoWrap = document.querySelector(".logo-icon");
        if (logoWrap) {
          logoWrap.innerHTML = `<img src="${logoUrl}" alt="logo" style="width:100%;height:100%;object-fit:contain;border-radius:10px;" onerror="this.parentElement.innerHTML='<i class=\\'fa-solid fa-bolt text-lg\\' style=\\'color:#02050A\\'></i>'">`;
        }
      }

      const title = ft.title || ftBrand.title || branding.title || "";
      if (title) {
        const nameEl = document.querySelector(".font-display.text-white");
        if (nameEl) nameEl.textContent = title;
      }

      const bgUrl = ft.background_url || (ftBrand.background && ftBrand.background.url) || (branding.background && branding.background.url) || "";
      if (bgUrl) {
        const bgImg = new Image();
        bgImg.onload = () => {
          document.body.style.backgroundImage = `url('${bgUrl}')`;
          document.body.style.backgroundSize = "cover";
          document.body.style.backgroundAttachment = "fixed";
          document.body.style.backgroundPosition = "center";
        };
        bgImg.src = bgUrl;
      }
    } catch(e) {
      console.log("Search branding load skipped:", e.message);
    }
  }

  window.addEventListener("message", ev => {
    const d = ev && ev.data;
    if (!d || typeof d !== "object" || d.type !== "EL_PREVIEW_SETTINGS") return;
    loadSearchBranding();
  });
  try {
    if (window.parent && window.parent !== window) {
      const cid = qs.get("cid") || qs.get("collection_id") || "";
      window.parent.postMessage({ type:"EL_PREVIEW_READY", cid, form_type:"search" }, "*");
    }
  } catch(e) {}

  loadSearchBranding();

  if (el.uploadInput) {
    el.uploadInput.addEventListener("change", function() {
      if (this.files&&this.files[0]&&el.selfieInput) {
        try { const dt = new DataTransfer(); dt.items.add(this.files[0]); el.selfieInput.files = dt.files; } catch(e) {}
        previewImage(this);
      }
    });
  }

  async function doFaceSearch() {
    const file = (el.selfieInput&&el.selfieInput.files&&el.selfieInput.files[0])||(el.uploadInput&&el.uploadInput.files&&el.uploadInput.files[0]);
    if (!file) { setStatus("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç","error"); return; }
    el.searchBtn.disabled = true;
    el.searchBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>‡§ñ‡•ã‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';
    setStatus("‡§ö‡•á‡§π‡§∞‡§æ ‡§™‡§π‡§ö‡§æ‡§® ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...","loading");
    el.emptyState.classList.add("hidden");
    el.statsDashboard.classList.add("hidden");
    el.resultsContainer.classList.add("hidden");
    el.skeletonLoader.classList.remove("hidden");
    try {
      let photoSha256 = "";
      try { const buf = await file.arrayBuffer(); const hb = await crypto.subtle.digest("SHA-256",buf); photoSha256 = Array.from(new Uint8Array(hb)).map(b=>b.toString(16).padStart(2,"0")).join(""); } catch(e) {}
      const init = await apiCall("init_search",{mime_type:file.type||"image/jpeg",sha256:photoSha256},token);
      const uploadUrl = init.upload_url||init.url, searchId = init.search_id||init.searchId;
      if (!init.cache_hit) { await fetch(uploadUrl,{method:"PUT",body:file,headers:{"Content-Type":file.type}}); }
      setStatus("‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§ú ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...","loading");
      const res = await apiCall("run_search",{search_id:searchId},token);
      el.skeletonLoader.classList.add("hidden");
      const tCount = Array.isArray(res.events||res.timeline) ? (res.events||res.timeline).length : 0;
      const pCount = Array.isArray(res.photo_urls) ? res.photo_urls.length : 0;
      if (res.message==="NO_MATCH"||tCount===0) {
        setStatus("‡§ï‡•ã‡§à ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ","error");
        el.emptyState.classList.remove("hidden");
        el.emptyState.querySelector("h3").textContent = "‡§ï‡•ã‡§à ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ";
        el.emptyState.querySelector("p").textContent = "‡§á‡§∏ ‡§ö‡•á‡§π‡§∞‡•á ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
      } else {
        pendingSearchRes = res;
        setStatus("","info");
        const sim = isNonEmpty(res.similarity) ? Number(res.similarity).toFixed(0) : "0";
        if (el.matchPills) {
          el.matchPills.innerHTML = `<span class="px-4 py-2 rounded-xl text-xs font-extrabold uppercase tracking-widest bg-gold-400/10 border border-gold-400/30 text-gold-400 shadow-md">${pCount} ‡§´‡•ã‡§ü‡•ã</span><span class="px-4 py-2 rounded-xl text-xs font-extrabold uppercase tracking-widest bg-teal-400/10 border border-teal-400/30 text-teal-400 shadow-md">${tCount} ‡§á‡§µ‡•á‡§Ç‡§ü</span><span class="px-4 py-2 rounded-xl text-xs font-extrabold uppercase tracking-widest bg-teal-400/20 border border-teal-400/50 text-teal-400 shadow-[0_0_15px_rgba(62,207,178,0.3)]">${sim}% ‡§Æ‡•à‡§ö</span>`;
        }
        if (el.matchTitle) el.matchTitle.textContent = "‚úÖ ‡§Æ‡•à‡§ö ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ!";
        if (el.matchSubtitle) el.matchSubtitle.textContent = "‡§°‡•á‡§ü‡§æ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç";
        const profile = res.profile||{};
        if (el.nameInput&&profile.name) el.nameInput.value = profile.name;
        if (el.mobileInput&&profile.mobile) el.mobileInput.value = profile.mobile;
        if (el.step1Card) el.step1Card.classList.add("hidden");
        if (el.step2Card) el.step2Card.classList.remove("hidden");
        setStep(2);
        if (window.innerWidth < 1024) el.step2Card.scrollIntoView({ behavior:"smooth", block:"start" });
      }
    } catch(err) {
      console.error(err);
      setStatus(err.message||"Connection Error","error");
      el.skeletonLoader.classList.add("hidden");
    } finally {
      el.searchBtn.disabled = false;
      el.searchBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass mr-2"></i>‡§ö‡•á‡§π‡§∞‡§æ ‡§ñ‡•ã‡§ú‡•á‡§Ç';
    }
  }

  function showResults(name, mobile) {
    if (!pendingSearchRes) return;
    const res = pendingSearchRes;
    const sim = isNonEmpty(res.similarity) ? Number(res.similarity).toFixed(0) : "0";
    const timeline = (res.events&&Array.isArray(res.events)&&res.events.length) ? res.events : (res.timeline||[]);
    const tCount = timeline.length, pCount = Array.isArray(res.photo_urls) ? res.photo_urls.length : 0;
    globalTimelineData = timeline;
    window.globalTimelineData = timeline;
    globalPhotoMap = new Map();
    (res.photo_urls||[]).forEach(u => { const k = parseS3KeyFromUrl(u); if (isNonEmpty(k)) globalPhotoMap.set(k,u); });
    if (el.step2Card) el.step2Card.classList.add("hidden");
    if (el.step1Card) el.step1Card.classList.add("hidden");
    currentFilter = "all";
    window.currentFilter = "all";
    updateDashboard(sim, tCount, pCount);
    updateFilterCounts(timeline);
    applyFilter();
    renderPhotos(res.photo_urls||[], timeline);
    switchTab("photos");
    if (window.innerWidth < 1024) el.resultsContainer.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  function openAllSlideshow() {
    const allPhotos = [];
    const seen = new Set();
    const urlToEvent = new Map();
    (globalTimelineData || []).forEach(item => {
      const form = item.form_type || item.ft || "";
      const data = item.data || {};
      const formDate = getEventFormDate(form, data);
      const displayDate = formDate || prettyIso(item.created_at_iso || "");
      const pName = data.program_name || data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§®‡§æ‡§Æ"] || data.name_of_program || "";
      const pType = data.program_type || data["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ_‡§ï‡§æ_‡§™‡•ç‡§∞‡§ï‡§æ‡§∞"] || "";
      let title = pName || pType || form || "Event";
      if (form === "president_tour_form") title = pName || pType || data.tour_title || "‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
      else if (form === "mandal_reporting" || form === "mandal_reporting_form") title = pName || data.venue || data["‡§∏‡•ç‡§•‡§æ‡§®"] || "‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
      else if (form === "visitor_form") title = item.name || data.name || data["‡§®‡§æ‡§Æ"] || "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§ó‡§®‡•ç‡§§‡•Å‡§ï";
      else if (form === "party_attendance") title = pName || pType || "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø";
      else if (form === "coordinator_entry" || form === "coordinator_form") title = data.name || data["‡§®‡§æ‡§Æ"] || pName || "‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø‡§ï ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø";
      const details = buildEventDetails(item, form, data, displayDate, formDate);
      const eventPhotos = getEventPhotos(item, globalPhotoMap);
      eventPhotos.forEach(u => { urlToEvent.set(u, { title, formType: getFormTypeLabel(form), details }); });
    });

    (globalTimelineData || []).forEach(item => {
      const ps = getEventPhotos(item, globalPhotoMap);
      ps.forEach(u => {
        if (!seen.has(u)) {
          seen.add(u);
          const ev = urlToEvent.get(u) || {};
          allPhotos.push({ url: u, eventTitle: ev.title || "Event Photo", formType: ev.formType || "", details: ev.details || [] });
        }
      });
    });
    globalPhotoMap.forEach(u => {
      if (!seen.has(u)) {
        seen.add(u);
        allPhotos.push({ url: u, eventTitle: "Event Photo", formType: "", details: [] });
      }
    });
    if (allPhotos.length) SS.open("‡§∏‡§≠‡•Ä ‡§´‡•ã‡§ü‡•ã", allPhotos, []);
  }

  if (el.searchBtn) el.searchBtn.addEventListener("click", doFaceSearch);
  if (el.confirmBtn) el.confirmBtn.addEventListener("click", () => {
    if (!validateStep2()) return;
    showResults(el.nameInput?el.nameInput.value.trim():"", el.mobileInput?el.mobileInput.value.trim():"");
  });
  if (el.btnAllSlideshow) el.btnAllSlideshow.addEventListener("click", openAllSlideshow);

  const autoName = qs.get("autosearch_name") || "";
  const autoMobile = qs.get("autosearch_mobile") || "";
  const autoS3Key = qs.get("autosearch_s3key") || "";

  if (autoName || autoMobile || autoS3Key) {
    if (el.nameInput && autoName) el.nameInput.value = autoName;
    if (el.mobileInput && autoMobile) el.mobileInput.value = autoMobile;
    if (autoS3Key) {
      (async () => {
        if (!resolvedCid && token) {
          try {
            const r = await fetch(`${BASE_URL}/political/forms`, {
              method: "POST", cache: "no-store",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ action: "public_get_config", payload: { token, form_type: "visitor_form" } })
            });
            const d = await r.json().catch(() => ({}));
            const cid = d.collection_id || d.cid ||
              (d.config && (d.config.collection_id || d.config.cid)) ||
              (d.settings && (d.settings.collection_id || d.settings.cid)) || "";
            if (cid) resolvedCid = cid.trim();
          } catch(e) { console.warn("CID resolve failed:", e); }
        }
        doAutoS3Search(autoS3Key, autoName, autoMobile);
      })();
    }
  }

  async function doAutoS3Search(s3key, nameVal, mobileVal) {
    el.emptyState.classList.add("hidden");
    el.skeletonLoader.classList.remove("hidden");
    el.resultsContainer.classList.add("hidden");
    el.statsDashboard.classList.add("hidden");
    setStatus("‡§ö‡•á‡§π‡§∞‡•á ‡§∏‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ñ‡•ã‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...", "loading");

    try {
      const searchPayload = { s3_key: s3key, days: 730 };
      if (token)       searchPayload.token = token;
      if (resolvedCid) searchPayload.collection_id = resolvedCid;

      const url2 = `${BASE_URL}/political/search`;
      const body = { action: "public_search", payload: searchPayload };
      if (token) body.token = token;

      const res2 = await fetch(url2, {
        method: "POST", cache: "no-store",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res2.json().catch(() => ({}));

      const timeline = data.events || data.timeline || [];
      const photoUrls = data.photo_urls || [];

      el.skeletonLoader.classList.add("hidden");

      if (!timeline.length) {
        setStatus("‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ", "error");
        el.emptyState.classList.remove("hidden");
        try { el.emptyState.querySelector("h3").textContent = "‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ"; } catch(e){}
        try { el.emptyState.querySelector("p").textContent = "‡§á‡§∏ visitor ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§"; } catch(e){}
        return;
      }

      globalTimelineData = timeline;
      globalPhotoMap = new Map();
      photoUrls.forEach(u => { const k = parseS3KeyFromUrl(u); if (k) globalPhotoMap.set(k, u); });

      const profile = data.profile || (data.events && data.events[0] && data.events[0].data) || {};
      if (el.nameInput)   el.nameInput.value   = profile.name   || nameVal  || "";
      if (el.mobileInput) el.mobileInput.value = profile.mobile || mobileVal || "";

      if (el.step1Card) el.step1Card.classList.add("hidden");
      if (el.step2Card) el.step2Card.classList.add("hidden");
      const sim = data.similarity ? Number(data.similarity).toFixed(0) : "‚Äî";
      globalTimelineData = timeline;
      window.globalTimelineData = timeline;
      updateDashboard(sim, timeline.length, photoUrls.length);
      updateFilterCounts(timeline);
      applyFilter();
      renderPhotos(photoUrls, timeline);
      switchTab("photos");
      setStatus("", "info");
    } catch(e) {
      el.skeletonLoader.classList.add("hidden");
      el.emptyState.classList.remove("hidden");
      try { el.emptyState.querySelector("h3").textContent = "Error"; } catch(err){}
      try { el.emptyState.querySelector("p").textContent = e.message || "‡§ï‡•Å‡§õ ‡§ó‡§≤‡§§ ‡§π‡•Å‡§Ü"; } catch(err){}
      setStatus(e.message || "Error", "error");
    }
  }

  // Expose internal functions to window so external patches can access them
  window.renderTimeline = function(timeline, photoUrlByKey) { return renderTimeline(timeline, photoUrlByKey || globalPhotoMap); };
  window.globalPhotoMap = globalPhotoMap;
  window._globalPhotoMap = globalPhotoMap;

})();
</script>

  <!-- ‚ïê‚ïê MOBILE BOTTOM BAR ‚ïê‚ïê -->
  <div id="mobileBottomBar">
    <button id="mobileSearchBtn" class="btn-primary flex-1 text-sm flex items-center justify-center gap-2 ripple-container" style="min-height:48px;">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span id="mobileBottomBtnText">‡§ö‡•á‡§π‡§∞‡§æ ‡§ñ‡•ã‡§ú‡•á‡§Ç</span>
    </button>
    <button id="mobileConfirmBtn" class="btn-success hidden flex-1 text-sm flex items-center justify-center gap-2 ripple-container" style="min-height:48px;">
      <i class="fa-solid fa-unlock-keyhole"></i>
      <span>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç</span>
    </button>
  </div>

  <script>
  // ‚îÄ‚îÄ Toast System ‚îÄ‚îÄ
  function showToast(msg, type = 'success', duration = 3500) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const icons = { success:'fa-circle-check', error:'fa-circle-xmark', loading:'fa-spinner fa-spin' };
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<i class="fa-solid ${icons[type]||icons.success} toast-icon"></i><span style="flex:1;font-family:'Outfit',sans-serif;">${msg}</span><i class="fa-solid fa-xmark toast-close"></i>`;
    container.appendChild(toast);
    toast.querySelector('.toast-close').addEventListener('click', () => dismissToast(toast));
    requestAnimationFrame(() => { requestAnimationFrame(() => { toast.classList.add('show'); }); });
    if (type !== 'loading') setTimeout(() => dismissToast(toast), duration);
    return toast;
  }
  function dismissToast(toast) {
    if (!toast || toast._dismissed) return;
    toast._dismissed = true;
    toast.classList.add('hide');
    setTimeout(() => toast.remove(), 500);
  }

  // ‚îÄ‚îÄ Ripple Effect ‚îÄ‚îÄ
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.ripple-container');
    if (!btn) return;
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const ripple = document.createElement('span');
    ripple.className = 'ripple';
    ripple.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px;`;
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  });

  // ‚îÄ‚îÄ Animated Counter ‚îÄ‚îÄ
  function animateCounter(el, target, duration = 1200) {
    if (!el) return;
    const start = parseInt(el.textContent.replace(/[^0-9]/g,'')) || 0;
    const num = parseInt(target) || 0;
    if (start === num) return;
    const startTime = performance.now();
    function update(now) {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.round(start + (num - start) * eased);
      el.textContent = current;
      if (progress < 1) requestAnimationFrame(update);
      else el.textContent = target;
    }
    requestAnimationFrame(update);
  }

  // ‚îÄ‚îÄ Arc chart updater ‚îÄ‚îÄ
  function updateArc(arcId, percent) {
    const arc = document.getElementById(arcId);
    if (!arc) return;
    const total = 78.5;
    arc.style.strokeDashoffset = total - (total * Math.min(percent/100, 1));
  }

  // ‚îÄ‚îÄ Profile Hero updater ‚îÄ‚îÄ
  function updateProfileHero(name, mobile, photoUrl) {
    const hero = document.getElementById('profileHero');
    const nameEl = document.getElementById('profileNameDisplay');
    const mobileEl = document.getElementById('profileMobileDisplay');
    const avatarImg = document.getElementById('profileAvatarImg');
    const avatarPlaceholder = document.getElementById('profileAvatarPlaceholder');
    if (!hero) return;
    if (name) {
      hero.classList.remove('hidden');
      if (nameEl) nameEl.textContent = name;
    }
    if (mobile && mobileEl) {
      mobileEl.textContent = mobile;
      mobileEl.classList.remove('hidden');
    }
    if (photoUrl && avatarImg) {
      avatarImg.src = photoUrl;
      avatarImg.classList.remove('hidden');
      if (avatarPlaceholder) avatarPlaceholder.classList.add('hidden');
    }
  }

  // ‚îÄ‚îÄ WhatsApp Share ‚îÄ‚îÄ
  const whatsappBtn = document.getElementById('whatsappShareBtn');
  if (whatsappBtn) {
    whatsappBtn.addEventListener('click', () => {
      const score = document.getElementById('scoreVal')?.textContent || '‚Äî';
      const events = document.getElementById('eventCountVal')?.textContent || '0';
      const photos = document.getElementById('photoCountVal')?.textContent || '0';
      const name = document.getElementById('nameInput')?.value || '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ';
      const text = `üîç *EventLens AI - Search Report*\n\nüë§ ‡§®‡§æ‡§Æ: ${name}\nüéØ Match: ${score}\nüìÖ Events: ${events}\nüì∏ Photos: ${photos}\n\n_Generated by EventLens AI_`;
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank');
    });
  }

  // ‚îÄ‚îÄ Mobile bottom bar sync ‚îÄ‚îÄ
  (function() {
    const mobileSearchBtn = document.getElementById('mobileSearchBtn');
    const mobileConfirmBtn = document.getElementById('mobileConfirmBtn');
    const mobileBottomBar = document.getElementById('mobileBottomBar');
    const realSearchBtn = document.getElementById('searchBtn');
    const realConfirmBtn = document.getElementById('confirmBtn');
    if (mobileSearchBtn && realSearchBtn) {
      mobileSearchBtn.addEventListener('click', () => { realSearchBtn.click(); });
    }
    if (mobileConfirmBtn && realConfirmBtn) {
      mobileConfirmBtn.addEventListener('click', () => { realConfirmBtn.click(); });
    }
    // Toggle between search/confirm based on step2 visibility
    const step2 = document.getElementById('step2Card');
    const step1 = document.getElementById('step1Card');
    const resultsContainer = document.getElementById('resultsContainer');
    function syncBar() {
      if (!mobileBottomBar) return;
      const step2Visible = step2 && !step2.classList.contains('hidden');
      const resultsVisible = resultsContainer && !resultsContainer.classList.contains('hidden');
      // Hide bar when results are showing
      if (resultsVisible) {
        mobileBottomBar.style.display = 'none';
        return;
      }
      mobileBottomBar.style.display = '';
      if (mobileSearchBtn) { mobileSearchBtn.style.display = step2Visible ? 'none' : 'flex'; }
      if (mobileConfirmBtn) { mobileConfirmBtn.style.display = step2Visible ? 'flex' : 'none'; }
    }
    if (step2) new MutationObserver(syncBar).observe(step2, { attributes: true, attributeFilter: ['class'] });
    if (resultsContainer) new MutationObserver(syncBar).observe(resultsContainer, { attributes: true, attributeFilter: ['class'] });
    syncBar();
  })();

  // ‚îÄ‚îÄ Intercept setStatus for toast ‚îÄ‚îÄ
  (function() {
    const _origSet = window.setStatus;
    // Patch after page load since setStatus is defined in main script
    window.addEventListener('DOMContentLoaded', () => {});
    // Monkey-patch updateDashboard to trigger profile hero + animated counters
    const _origUpdate = window.updateDashboard;
    window.updateDashboard = function(similarity, timelineCount, photoCount) {
      if (typeof _origUpdate === 'function') _origUpdate(similarity, timelineCount, photoCount);
      // Animated counters
      const eVal = document.getElementById('eventCountVal');
      const pVal = document.getElementById('photoCountVal');
      const sVal = document.getElementById('scoreVal');
      if (eVal) animateCounter(eVal, timelineCount);
      if (pVal) animateCounter(pVal, photoCount);
      // Arc charts
      const simNum = parseFloat(similarity) || 0;
      updateArc('arcMatch', simNum);
      const maxEvents = 50;
      updateArc('arcEvents', (parseInt(timelineCount)||0)/maxEvents*100);
      const maxPhotos = 100;
      updateArc('arcPhotos', (parseInt(photoCount)||0)/maxPhotos*100);
      // Profile hero from input
      const nameVal = document.getElementById('nameInput')?.value || '';
      const mobileVal = document.getElementById('mobileInput')?.value || '';
      if (nameVal) updateProfileHero(nameVal, mobileVal, '');
    };
  })();

  // ‚îÄ‚îÄ Add ripple to primary buttons ‚îÄ‚îÄ
  document.querySelectorAll('.btn-primary, .btn-success').forEach(btn => {
    btn.classList.add('ripple-container');
  });

  // ‚îÄ‚îÄ Add stagger to photo grid items ‚îÄ‚îÄ
  const _origRenderPhotos = window.renderPhotos;
  if (typeof _origRenderPhotos === 'function') {
    window.renderPhotos = function(photoUrls, timeline) {
      const result = _origRenderPhotos(photoUrls, timeline);
      const grid = document.getElementById('photosGrid');
      if (grid) {
        Array.from(grid.children).forEach((el, i) => {
          el.classList.add('stagger-item');
          el.style.animationDelay = `${i * 40}ms`;
        });
      }
      return result;
    };
  }

  // ‚îÄ‚îÄ Toast on search actions ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    const confirmBtn = document.getElementById('confirmBtn');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        const nameVal = document.getElementById('nameInput')?.value || '';
        const mobileVal = document.getElementById('mobileInput')?.value || '';
        if (nameVal) updateProfileHero(nameVal, mobileVal, '');
      });
    }
  });
  </script>

<script>
// ‚îÄ‚îÄ Timeline Grouping Patch ‚îÄ‚îÄ
let globalTimelineGroups = [];
function buildTimelineGroups(timelineArr) {
  const timeline = Array.isArray(timelineArr) ? timelineArr : [];
  const map = new Map();
  for (const it of timeline) {
    if (!it||typeof it!=='object') continue;
    const eid = (it.event_id||it.eventId||it.event_key||it.eventKey||it.entry_id||it.entryId||'').toString().trim();
    const gid = eid||(it.entry_id||it.entryId||'').toString().trim()||Math.random().toString(36).slice(2);
    if (!map.has(gid)) { map.set(gid,{group_id:gid,event_id:eid||gid,form_type:it.form_type||it.ft||'unknown',created_at:it.created_at||'0',created_at_iso:it.created_at_iso||'',with_label:it.with_label||'',face_count:it.face_count||0,district:it.district||(it.data||{}).district||'',vidhansabha:it.vidhansabha||(it.data||{}).vidhansabha||'',mandal:it.mandal||(it.data||{}).mandal||'',items:[it]}); }
    else { const g=map.get(gid); g.items.push(it); const ca=Number(it.created_at||0),ga=Number(g.created_at||0); if (ca>ga){g.created_at=it.created_at||g.created_at;g.created_at_iso=it.created_at_iso||g.created_at_iso;g.district=it.district||g.district;g.vidhansabha=it.vidhansabha||g.vidhansabha;g.mandal=it.mandal||g.mandal;g.form_type=it.form_type||it.ft||g.form_type;} }
  }
  const groups = Array.from(map.values()); groups.sort((a,b)=>Number(b.created_at||0)-Number(a.created_at||0)); return groups;
}
function renderTimelineGroups(groups) {
  const grid=document.getElementById("viewTimeline"); if(!grid)return; grid.innerHTML="";
  if(!Array.isArray(groups)||groups.length===0){grid.innerHTML='<div class="text-center py-16 text-sm font-bold tracking-widest uppercase text-slate-500 bg-white/5 rounded-3xl border border-white/5">No timeline entries.</div>';return;}
  const repItems=groups.map(g=>{const rep=(g.items&&g.items[0])?g.items[0]:{};return Object.assign({},rep,{_groupPhotos:g.items,_itemCount:g.items.length});});
  // Use renderTimeline directly since _renderTimelineMain is not defined
  if(typeof window.renderTimeline==='function'){
    window.renderTimeline(repItems, window._globalPhotoMap||window.globalPhotoMap||new Map());
  } else if(typeof window._renderTimelineMain==='function'){
    window._renderTimelineMain(repItems,window._globalPhotoMap||new Map());
  }
}
function applyFilter() {
  const groups=Array.isArray(globalTimelineGroups)?globalTimelineGroups:[];
  if(window.currentFilter==='all'){renderTimelineGroups(groups);return;}
  const filtered=groups.filter(g=>{const ft=(g.form_type||'').toString();return ft===window.currentFilter;});
  renderTimelineGroups(filtered);
}
(function patchSearchSubmitHook() {
  const _orig=window.renderPhotos;
  window.renderPhotos=function(photoUrls,timeline){
    try{globalTimelineGroups=buildTimelineGroups(window.globalTimelineData||timeline||[]);const scoreEl=document.getElementById("scoreVal");const sim=scoreEl?Number(scoreEl.textContent.replace('%','')||0).toFixed(0):'0';}catch(e){console.warn('timeline grouping patch failed',e);}
    return _orig?_orig(photoUrls,timeline):undefined;
  };
})();
</script>


  <script>
  (function(){
    // ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
      try {
        const sw = 'self.addEventListener("install",e=>{self.skipWaiting();});self.addEventListener("fetch",e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));});';
        const blob = new Blob([sw], {type:'text/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
      } catch(e) {}
    }
    // ‚îÄ‚îÄ Android Install Prompt ‚îÄ‚îÄ
    let _dp = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); _dp = e; _showPWABanner();
    });
    function _showPWABanner() {
      if (document.getElementById('pwaBanner')) return;
      const b = document.createElement('div');
      b.id = 'pwaBanner'; b.className = 'pwa-banner';
      const ic = document.createElement('div'); ic.className = 'pwa-icon-box';
      ic.innerHTML = '<i class="fa-solid fa-bolt" style="color:#02050A;font-size:20px;"></i>';
      const tx = document.createElement('div'); tx.style.cssText = 'flex:1;min-width:0;';
      tx.innerHTML = '<div style="font-family:Outfit,sans-serif;font-weight:800;color:#fff;font-size:14px;margin-bottom:3px;">EventLens AI Install ‡§ï‡§∞‡•á‡§Ç</div><div style="font-family:Outfit,sans-serif;color:#94a3b8;font-size:11px;">Home Screen ‡§™‡§∞ add ‡§ï‡§∞‡•á‡§Ç ‚Äî faster access</div>';
      const bts = document.createElement('div'); bts.style.cssText='display:flex;gap:8px;flex-shrink:0;';
      const ib = document.createElement('button'); ib.className='pwa-install-btn'; ib.textContent='Install';
      const db = document.createElement('button'); db.className='pwa-dismiss-btn'; db.textContent='‚úï';
      bts.appendChild(ib); bts.appendChild(db);
      b.appendChild(ic); b.appendChild(tx); b.appendChild(bts);
      document.body.appendChild(b);
      ib.onclick = async () => { if(_dp){_dp.prompt();const r=await _dp.userChoice;if(r.outcome==='accepted'){b.style.opacity='0';setTimeout(()=>b.remove(),300);}_dp=null;}};
      db.onclick = () => { b.style.transition='all 0.3s';b.style.opacity='0';setTimeout(()=>b.remove(),300); };
    }
    // ‚îÄ‚îÄ iOS Safari Hint ‚îÄ‚îÄ
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream && !navigator.standalone && !sessionStorage.getItem('el_ios')) {
      sessionStorage.setItem('el_ios','1');
      setTimeout(() => {
        if (document.getElementById('pwaBanner')) return;
        const h = document.createElement('div'); h.className = 'pwa-hint';
        const hr = document.createElement('div'); hr.className = 'pwa-hint-row';
        const ic2 = document.createElement('div'); ic2.className = 'pwa-icon-box';
        ic2.innerHTML = '<i class="fa-solid fa-bolt" style="color:#02050A;font-size:18px;"></i>';
        const tt = document.createElement('div'); tt.style.cssText='flex:1;font-family:Outfit,sans-serif;font-weight:800;color:#fff;font-size:13px;';
        tt.textContent = 'Home Screen ‡§™‡§∞ Install ‡§ï‡§∞‡•á‡§Ç';
        const cl = document.createElement('button'); cl.style.cssText='background:none;border:none;color:#64748b;font-size:18px;cursor:pointer;flex-shrink:0;line-height:1;';
        cl.innerHTML='&times;'; cl.onclick=()=>h.remove();
        hr.appendChild(ic2); hr.appendChild(tt); hr.appendChild(cl);
        const ins = document.createElement('div'); ins.className = 'pwa-hint-text';
        ins.innerHTML = 'Safari ‡§Æ‡•á‡§Ç <b style="color:#D4A017;">Share ‚Üë</b> tap ‡§ï‡§∞‡•á‡§Ç ‚Üí <b style="color:#D4A017;">"Add to Home Screen"</b> ‡§ö‡•Å‡§®‡•á‡§Ç';
        h.appendChild(hr); h.appendChild(ins);
        document.body.appendChild(h);
        setTimeout(()=>{ if(h.parentNode){h.style.transition='all 0.4s';h.style.opacity='0';setTimeout(()=>h.remove(),400);} }, 8000);
      }, 3000);
    }
  })();
  </script>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  EventLens Political Search ‚Äî Bridge Patch v2
  ‡§á‡§∏‡•á political-search.html ‡§ï‡•á </body> ‡§∏‡•á ‡§™‡§π‡§≤‡•á paste ‡§ï‡§∞‡•á‡§Ç‡•§
  
  1. Guest lead ‚Üí selfie-guest-data table (photographer dashboard ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á)
  2. Favorite/Select ‚Üí Gallery table (client view ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
(function() {
  'use strict';

  // ‚îÄ‚îÄ‚îÄ APIs ‚îÄ‚îÄ‚îÄ
  const SAVE_DETAILS_API = 'https://1s2tgemahh.execute-api.ap-south-1.amazonaws.com/prod/save-details';
  const CLIENT_API = 'https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod/client-api';

  // ‚îÄ‚îÄ‚îÄ Get CID from URL or window ‚îÄ‚îÄ‚îÄ
  function _getCid() {
    try {
      const qs = new URLSearchParams(location.search);
      const fromUrl = qs.get('cid') || qs.get('collection_id') || '';
      if (fromUrl) return fromUrl.trim();
      // From window global (set during branding load)
      return (window.resolvedCid || window.currentCid || '').trim();
    } catch(e) { return ''; }
  }

  function _getToken() {
    try {
      const qs = new URLSearchParams(location.search);
      return (qs.get('token') || '').trim();
    } catch(e) { return ''; }
  }

  // ‚îÄ‚îÄ‚îÄ 1. Save guest lead to selfie-guest-data ‚îÄ‚îÄ‚îÄ
  async function saveGuestLead(name, mobile, photoCount) {
    const cid = _getCid();
    if (!cid || !mobile) return; // no CID or mobile = skip

    try {
      const payload = {
        action: 'save_guest',
        collection_id: cid,
        link_id: _getToken() || 'political_search',
        guest_name: name || '',
        guest_mobile: mobile || '',
        photo_count: photoCount || 0,
        source: 'political_search',
        timestamp: Date.now()
      };
      await fetch(SAVE_DETAILS_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      // console.log('[Bridge] Guest lead saved');
    } catch(e) {
      console.warn('[Bridge] saveGuestLead failed:', e.message);
    }
  }

  // ‚îÄ‚îÄ‚îÄ 2. Sync favorite/select to Gallery table ‚îÄ‚îÄ‚îÄ
  async function syncToPhotographerDashboard(photoKey, photoUrl, name, mobile, action) {
    const cid = _getCid();
    if (!cid || !photoKey) return;

    try {
      const payload = {
        action: 'update_selection',
        collection_id: cid,
        photo_id: photoKey,
        photo_url: photoUrl || '',
        user_type: 'guest',
        guest_name: name || '',
        guest_mobile: mobile || '',
        selection_type: action || 'fav', // 'fav' or 'selected'
        source: 'political_search',
        timestamp: Date.now()
      };
      await fetch(CLIENT_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch(e) {
      console.warn('[Bridge] syncToPhotographerDashboard failed:', e.message);
    }
  }

  // ‚îÄ‚îÄ‚îÄ Expose bridge ‚îÄ‚îÄ‚îÄ
  window.EL = window.EL || {};
  window.EL.bridge = { saveGuestLead, syncToPhotographerDashboard };

  // ‚îÄ‚îÄ‚îÄ Auto-hook: intercept showResults (called after name/mobile confirm) ‚îÄ‚îÄ‚îÄ
  // political-search.html ‡§Æ‡•á‡§Ç showResults(name, mobile) function ‡§π‡•à
  const _origShowResults = window.showResults;
  if (typeof _origShowResults === 'function') {
    window.showResults = function(name, mobile, ...rest) {
      // Call original
      try { _origShowResults.call(this, name, mobile, ...rest); } catch(e) {}
      // Save guest lead after small delay (let results render)
      if (name || mobile) {
        setTimeout(() => {
          const photoCount = document.querySelectorAll('.photo-item, [class*="photo"]').length || 0;
          saveGuestLead(name, mobile, photoCount);
        }, 600);
      }
    };
  }

  // ‚îÄ‚îÄ‚îÄ Auto-hook: intercept favorite / select buttons ‚îÄ‚îÄ‚îÄ
  // Wait for DOM to have results rendered, then hook buttons
  function _hookFavButtons() {
    // This runs via MutationObserver when results appear
    document.querySelectorAll('[data-photo-key], .fav-btn, .select-btn, [onclick*="fav"], [onclick*="select"]').forEach(btn => {
      if (btn.__el_hooked) return;
      btn.__el_hooked = true;
      btn.addEventListener('click', function() {
        setTimeout(() => {
          try {
            const photoKey = this.dataset.photoKey || this.closest('[data-photo-key]')?.dataset.photoKey || '';
            const photoUrl = this.dataset.photoUrl || this.closest('[data-photo-url]')?.dataset.photoUrl || '';
            const actionType = (this.classList.contains('fav-btn') || (this.dataset.action||'').includes('fav')) ? 'fav' : 'selected';
            const name = document.getElementById('nameInput')?.value || document.querySelector('[id*="name"]')?.value || '';
            const mobile = document.getElementById('mobileInput')?.value || document.querySelector('[id*="mobile"]')?.value || '';
            if (photoKey || photoUrl) {
              syncToPhotographerDashboard(photoKey || photoUrl, photoUrl, name, mobile, actionType);
            }
          } catch(err) {}
        }, 200);
      });
    });
  }

  // MutationObserver to hook buttons as they appear
  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(() => { _hookFavButtons(); });
    observer.observe(document.body, { childList: true, subtree: true });
    // Also run once on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', _hookFavButtons);
    } else {
      _hookFavButtons();
    }
  }

})();
</script>

<script>
// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CORE_API_BASE = 'https://1s2tgemahh.execute-api.ap-south-1.amazonaws.com';

// CID ‡§î‡§∞ guest info track ‡§ï‡§∞‡•ã
(function(){
  const qs = new URLSearchParams(location.search);
  
  // token ‡§∏‡•á CID extract ‡§ï‡§∞‡§®‡§æ (unverified decode)
  function _decodeToken(t){
    try{
      const p = t.split('.')[0];
      const pad = '='.repeat((4-(p.length%4))%4);
      return JSON.parse(atob((p+pad).replace(/-/g,'+').replace(/_/g,'/')));
    }catch(e){ return {}; }
  }
  
  const tok = qs.get('token')||'';
  const decoded = tok ? _decodeToken(tok) : {};
  window._politicalCID = qs.get('cid') || decoded.collection_id || decoded.cid || '';
})();

// ‚îÄ‚îÄ Political Favorite ‚Üí Photographer Dashboard Bridge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncFavoriteToPhotographer(photoUrl, isFav, guestName, guestMobile){
  const cid = window._politicalCID || '';
  if(!cid || !photoUrl) return;
  try{
    let photoId = photoUrl;
    try{
      const u = new URL(photoUrl);
      // pathname ‡§∏‡•á bucket prefix ‡§π‡§ü‡§æ‡§ì: /bucket-name/political/...  ‚Üí political/...
      photoId = decodeURIComponent(u.pathname).replace(/^\/[^/]+\//,'');
    }catch(e){}
    
    await fetch(`${CORE_API_BASE}/client-api`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action:'update_selection',
        payload:{
          collection_id: cid,
          photo_id: photoId,
          user_type:'guest',
          guest_name: guestName||window._politicalGuestName||'Political Search User',
          guest_mobile: guestMobile||window._politicalGuestMobile||'',
          fav: !!isFav,
          selected: !!isFav,
          source:'political_search'
        }
      })
    });
    console.log('[EL] Favorite synced to photographer dashboard');
  }catch(e){ console.warn('[EL] Favorite sync failed',e); }
}

// ‚îÄ‚îÄ Guest Lead Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveGuestLeadToCore(name, mobile, matchCount){
  const cid = window._politicalCID || '';
  if(!cid||!mobile) return;
  window._politicalGuestName   = name   || '';
  window._politicalGuestMobile = mobile || '';
  try{
    await fetch(`${CORE_API_BASE}/save-details`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        mobile: String(mobile),
        name: name||'',
        collection_id: cid,
        linkId: cid,
        photo_count: matchCount||0,
        source:'political_search'
      })
    });
    console.log('[EL] Guest lead saved');
  }catch(e){ console.warn('[EL] Guest lead save failed',e); }
}

// ‚îÄ‚îÄ Hook into existing confirmBtn click ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‡§Ø‡§π code DOMContentLoaded ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ existing confirmBtn handler ‡§ï‡•á ‡§¨‡§æ‡§¶ add ‡§ï‡§∞‡•ã:
document.addEventListener('DOMContentLoaded', function(){
  const confirmBtn = document.getElementById('confirmBtn');
  if(confirmBtn){
    confirmBtn.addEventListener('click', function(){
      // Existing handler ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§Ø‡§π trigger ‡§π‡•ã‡§ó‡§æ
      setTimeout(function(){
        const name   = (document.getElementById('nameInput')   || {}).value || '';
        const mobile = (document.getElementById('mobileInput') || {}).value || '';
        // photo count: statsDashboard ‡§∏‡•á ‡§≤‡•ã
        const photoCountEl = document.getElementById('photoCountVal');
        const matchCount = photoCountEl ? parseInt(photoCountEl.textContent||'0') : 0;
        
        if(name || mobile){
          saveGuestLeadToCore(name, mobile, matchCount);
        }
      }, 500); // search result ‡§Ü‡§®‡•á ‡§¶‡•ã ‡§™‡§π‡§≤‡•á
    });
  }
  
  // ‚îÄ‚îÄ Photo grid ‡§Æ‡•á‡§Ç favorite button hook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Slideshow/Gallery ‡§Æ‡•á‡§Ç ‡§ú‡§π‡§æ‡§Å heart button click ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§µ‡§π‡§æ‡§Å:
  // existing slideshowState ‡§Ø‡§æ photosGrid observe ‡§ï‡§∞‡•ã
  
  // MutationObserver: photosGrid ‡§Æ‡•á‡§Ç favorite buttons ‡§ï‡•ã intercept ‡§ï‡§∞‡•ã
  const photosGrid = document.getElementById('photosGrid') || document.getElementById('photoGrid');
  if(photosGrid){
    photosGrid.addEventListener('click', function(e){
      const favBtn = e.target.closest('[data-action="fav"],[data-fav],[id$="FavBtn"],[class*="fav-btn"],[class*="heart"]');
      if(!favBtn) return;
      
      // Photo URL ‡§®‡§ø‡§ï‡§æ‡§≤‡•ã
      const photoItem = favBtn.closest('[data-url],[data-photo-url]') || favBtn.closest('.photo-item');
      let photoUrl = '';
      if(photoItem){
        photoUrl = photoItem.dataset.url || photoItem.dataset.photoUrl || '';
        if(!photoUrl){
          const img = photoItem.querySelector('img');
          if(img) photoUrl = img.src || '';
        }
      }
      
      const isFav = !favBtn.classList.contains('active'); // toggle
      const name   = window._politicalGuestName   || '';
      const mobile = window._politicalGuestMobile || '';
      
      if(photoUrl){
        syncFavoriteToPhotographer(photoUrl, isFav, name, mobile);
      }
    });
  }
  
  // ‚îÄ‚îÄ Slideshow viewer ‡§Æ‡•á‡§Ç ‡§≠‡•Ä hook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‡§Ö‡§ó‡§∞ slideshow modal ‡§Æ‡•á‡§Ç heart button ‡§π‡•à:
  const viewerFavBtn = document.getElementById('viewerFavBtn') || document.getElementById('slideFavBtn');
  if(viewerFavBtn){
    viewerFavBtn.addEventListener('click', function(){
      // Current photo URL
      const viewerImg = document.getElementById('viewerImg') || document.getElementById('slideImg');
      const photoUrl = viewerImg ? viewerImg.src : '';
      const isFav = viewerFavBtn.classList.contains('active') || viewerFavBtn.classList.contains('active-fav');
      const name   = window._politicalGuestName   || '';
      const mobile = window._politicalGuestMobile || '';
      if(photoUrl) syncFavoriteToPhotographer(photoUrl, isFav, name, mobile);
    });
  }
  
  // SS (Slideshow) modal ‡§Æ‡•á‡§Ç hook ‚Äî political-search.html ‡§ï‡§æ SS object
  // SS.open() ‡§ï‡•á ‡§¨‡§æ‡§¶ favorite state change intercept:
  const _origSSOpen = window.SS && window.SS.open;
  if(window.SS && _origSSOpen){
    window.SS.open = function(title, photos, timeline){
      const result = _origSSOpen.call(window.SS, title, photos, timeline);
      // SS modal ‡§ï‡•á heart buttons observe ‡§ï‡§∞‡•ã
      setTimeout(function(){
        const modal = document.getElementById('ssModal') || document.querySelector('.slideshow-modal');
        if(modal){
          modal.querySelectorAll('.fav-btn,.heart-btn,[data-action="fav"]').forEach(function(btn){
            if(btn._elHooked) return;
            btn._elHooked = true;
            btn.addEventListener('click', function(){
              const img = modal.querySelector('.ss-img,#ssImg,img.slideshow-image');
              const photoUrl = img ? img.src : '';
              const isFav = btn.classList.contains('active')||btn.classList.contains('liked');
              const name   = window._politicalGuestName||'';
              const mobile = window._politicalGuestMobile||'';
              if(photoUrl) syncFavoriteToPhotographer(photoUrl, !isFav, name, mobile);
            });
          });
        }
      }, 800);
      return result;
    };
  }
});
</script>
<script>
if('serviceWorker' in navigator){window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js').catch(function(){});});}
let _deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();_deferredInstallPrompt=e;var btn=document.getElementById('installAppBtn');if(btn)btn.style.display='inline-flex';});
window._installApp=function(){if(!_deferredInstallPrompt)return;_deferredInstallPrompt.prompt();_deferredInstallPrompt.userChoice.then(function(){_deferredInstallPrompt=null;var btn=document.getElementById('installAppBtn');if(btn)btn.style.display='none';});};
</script>
</body>
</html>
