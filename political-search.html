<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EventLens Political | Worker Search</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#121c3a;
      --card2:#0e1632;
      --text:#e9edf7;
      --muted:#a7b3d1;
      --line:rgba(255,255,255,.10);
      --brand:#7c5cff;
      --brand2:#23c483;
      --warn:#ffb020;
      --bad:#ff4d6d;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.35), transparent 55%),
                  radial-gradient(900px 500px at 95% 10%, rgba(35,196,131,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 14px 40px;}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 14px; border:1px solid var(--line); background:rgba(15,23,48,.65);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      min-width: 240px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), #00d4ff);
      box-shadow: 0 8px 18px rgba(124,92,255,.30);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logo svg{width:22px;height:22px}
    .title{display:flex;flex-direction:column;line-height:1.1}
    .title b{font-size:16px; letter-spacing:.2px}
    .title span{font-size:12px;color:var(--muted)}
    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--line); background:rgba(18,28,58,.55);
      padding:8px 10px; border-radius:999px; color:var(--muted); font-size:12px;
    }
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(124,92,255,.18), rgba(124,92,255,.06));
      color:var(--text);
      padding:10px 12px; border-radius:14px;
      display:inline-flex; gap:8px; align-items:center;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      font-weight:600; font-size:13px;
    }
    .btn:hover{border-color:rgba(124,92,255,.55)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:rgba(18,28,58,.45);
    }
    .btn.good{
      background:linear-gradient(180deg, rgba(35,196,131,.20), rgba(35,196,131,.08));
    }
    .btn.bad{
      background:linear-gradient(180deg, rgba(255,77,109,.22), rgba(255,77,109,.08));
    }
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{position:relative; top:auto}
      .brand{min-width:unset}
    }
    .panel{
      border:1px solid var(--line);
      background:rgba(15,23,48,.60);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      padding:12px 14px;
      font-size:13px; letter-spacing:.3px;
      color:#d8e0ff;
      border-bottom:1px solid var(--line);
      background: rgba(18,28,58,.55);
    }
    .panel .content{padding:14px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:12px}
    label{font-size:12px; color:var(--muted)}
    input[type="file"]{display:none}
    .drop{
      border:1px dashed rgba(255,255,255,.22);
      border-radius:16px;
      padding:12px;
      background: rgba(18,28,58,.35);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .drop .left{display:flex; gap:12px; align-items:center}
    .thumb{
      width:72px; height:72px; border-radius:16px; background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden; flex:0 0 auto;
      display:grid; place-items:center;
    }
    .thumb img{width:100%;height:100%;object-fit:cover; display:block}
    .drop .meta{display:flex; flex-direction:column; gap:4px}
    .meta .name{font-weight:700; font-size:13px}
    .meta .hint{color:var(--muted); font-size:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .statline{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px
    }
    .stat{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(18,28,58,.35);
      font-size:12px;
      color:var(--muted);
    }
    .stat b{color:var(--text)}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    select, input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      background:rgba(18,28,58,.35);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    select{width:auto}
    input[type="text"]::placeholder{color:rgba(167,179,209,.7)}
    .rightTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(18,28,58,.55);
    }
    .rightTop .heading{
      display:flex; flex-direction:column;
    }
    .heading b{font-size:14px}
    .heading span{font-size:12px;color:var(--muted)}
    .tabs{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tab{
      cursor:pointer;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(18,28,58,.35);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      background:rgba(124,92,255,.18);
      border-color:rgba(124,92,255,.55);
      color:#e9edf7;
    }
    .timeline{
      padding:14px;
      display:grid;
      gap:10px;
    }
    .card{
      border:1px solid var(--line);
      background:rgba(18,28,58,.35);
      border-radius:18px;
      overflow:hidden;
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:12px;
      padding:10px;
      align-items:stretch;
      cursor:pointer;
      transition: border-color .15s ease, transform .05s ease;
    }
    .card:hover{border-color:rgba(124,92,255,.45)}
    .card:active{transform:translateY(1px)}
    .card .img{
      width:92px; height:92px;
      border-radius:16px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      overflow:hidden;
      display:grid; place-items:center;
      position:relative;
    }
    .card .img img{width:100%;height:100%;object-fit:cover; display:block}
    .badge{
      position:absolute; left:8px; bottom:8px;
      padding:5px 8px;
      font-size:11px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      color:#fff;
      max-width: 78px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .card .body{display:flex; flex-direction:column; gap:6px; min-width:0}
    .topline{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      min-width:0;
    }
    .topline .main{
      min-width:0;
      display:flex; flex-direction:column; gap:2px;
    }
    .main .h{
      font-weight:800; font-size:13px; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .main .sub{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .metaRow{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .metaRow span{
      display:inline-flex; gap:6px; align-items:center;
      border:1px solid var(--line);
      background:rgba(18,28,58,.25);
      padding:6px 8px;
      border-radius:12px;
      max-width: 100%;
    }
    .metaRow span b{color:#dbe3ff; font-weight:700}
    .empty{
      padding:22px 14px;
      color:var(--muted);
      text-align:center;
    }

    /* Gallery */
    .galleryWrap{padding:14px}
    .galleryTools{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px}
    .galleryGrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
    }
    @media (max-width:1100px){.galleryGrid{grid-template-columns: repeat(4, 1fr)}}
    @media (max-width:900px){.galleryGrid{grid-template-columns: repeat(3, 1fr)}}
    @media (max-width:640px){.galleryGrid{grid-template-columns: repeat(2, 1fr)}}
    .ph{
      border:1px solid var(--line);
      background:rgba(18,28,58,.35);
      border-radius:16px;
      overflow:hidden;
      position:relative;
      cursor:pointer;
      transition: border-color .15s ease;
    }
    .ph:hover{border-color:rgba(35,196,131,.45)}
    .ph .img{aspect-ratio: 1 / 1; background: rgba(0,0,0,.18); display:grid; place-items:center}
    .ph img{width:100%; height:100%; object-fit:cover; display:block}
    .ph .cap{
      padding:8px 9px;
      font-size:11px;
      color:var(--muted);
      border-top:1px solid var(--line);
      display:flex; flex-direction:column; gap:3px;
    }
    .cap .t{color:var(--text); font-weight:800; font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .cap .s{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .check{
      position:absolute; top:8px; left:8px;
      width:22px; height:22px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.35);
      display:grid; place-items:center;
      backdrop-filter: blur(6px);
    }
    .check input{width:16px;height:16px}
    .tag{
      position:absolute; bottom:8px; right:8px;
      padding:5px 8px;
      font-size:11px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      color:#fff;
      max-width: 70%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Modal / Lightbox */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      z-index:50;
      padding:16px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(1100px, 100%);
      max-height: 92vh;
      overflow:hidden;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(15,23,48,.85);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px){
      .modal{grid-template-columns: 1fr; max-height: 92vh}
    }
    .modal .media{
      border-right:1px solid var(--line);
      background: rgba(0,0,0,.18);
      position:relative;
      display:flex; flex-direction:column;
    }
    @media (max-width: 980px){
      .modal .media{border-right:none; border-bottom:1px solid var(--line)}
    }
    .modal .media img{
      width:100%; height:100%; object-fit:contain; background: rgba(0,0,0,.25);
    }
    .modal .side{
      padding:14px;
      overflow:auto;
    }
    .modal .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .close{
      cursor:pointer;
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(18,28,58,.45);
      display:grid; place-items:center;
    }
    .kv{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(18,28,58,.35);
      padding:10px 12px;
      margin-bottom:10px;
    }
    .kv b{display:block; font-size:12px; color:#dbe3ff; margin-bottom:6px}
    .kv pre{
      margin:0;
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.35;
    }

    /* Toast */
    .toast{
      position:fixed;
      right:14px; bottom:14px;
      background: rgba(15,23,48,.92);
      border:1px solid rgba(255,255,255,.18);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:none;
      z-index:60;
      min-width: 220px;
      max-width: min(420px, calc(100vw - 28px));
    }
    .toast.show{display:block}
    .toast .t{font-weight:800; font-size:12px; margin-bottom:4px}
    .toast .m{font-size:12px; color:var(--muted); line-height:1.35}
    .spinner{
      width:14px;height:14px;border:2px solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:999px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform: rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7h10v10H7z" stroke="white" stroke-width="2" opacity=".85"/>
            <path d="M9 4h6l1 3H8l1-3z" fill="white" opacity=".85"/>
            <path d="M12 11.2a2.3 2.3 0 1 0 0 4.6 2.3 2.3 0 0 0 0-4.6z" fill="white"/>
          </svg>
        </div>
        <div class="title">
          <b>Worker Search</b>
          <span>EventLens Political ‚Ä¢ Timeline + Gallery</span>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="envPill">ENV: ‚Äî</div>
        <button class="btn secondary" id="copyLinkBtn" title="Link copy">
          <span>üîó</span><span>Copy Link</span>
        </button>
        <button class="btn good" id="shareBtn" title="Share">
          <span>üì§</span><span>Share</span>
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <h3>Search</h3>
        <div class="content">
          <div class="field">
            <label>Selfie Photo</label>
            <div class="drop">
              <div class="left">
                <div class="thumb" id="selfieThumb">
                  <span class="muted">No photo</span>
                </div>
                <div class="meta">
                  <div class="name" id="fileName">No file selected</div>
                  <div class="hint">PNG/JPG ‚Ä¢ 1 face best</div>
                </div>
              </div>
              <div class="row">
                <label class="btn small" for="selfieInput">üì∑ Choose</label>
                <button class="btn small secondary" id="clearBtn" type="button">‚úñ Clear</button>
              </div>
            </div>
            <input id="selfieInput" type="file" accept="image/*" />
          </div>

          <div class="row">
            <button class="btn good" id="searchBtn" type="button">
              <span id="searchBtnIcon">üîé</span><span id="searchBtnText">Search</span>
            </button>
            <button class="btn secondary" id="resetViewBtn" type="button">‚Ü∫ Reset View</button>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>Quick Filters</label>
            <div class="filters">
              <select id="formTypeFilter">
                <option value="">All forms</option>
              </select>
              <select id="sortBy">
                <option value="new">Newest first</option>
                <option value="old">Oldest first</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Search in timeline (program / guests / district)</label>
            <input id="q" type="text" placeholder="Type to filter..." />
          </div>

          <div class="statline" id="stats">
            <div class="stat">Events: <b id="statEvents">0</b></div>
            <div class="stat">Photos: <b id="statPhotos">0</b></div>
            <div class="stat">Similarity: <b id="statSim">‚Äî</b></div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>Profile (from DB)</label>
            <div class="stat" style="width:100%">
              <div><b id="profName">‚Äî</b></div>
              <div class="muted" id="profMobile">‚Äî</div>
            </div>
          </div>

          <div class="row">
            <button class="btn small secondary" id="downloadSelectedBtn" type="button">‚¨á Download Selected</button>
            <button class="btn small" id="slideshowBtn" type="button">üñº Slideshow</button>
          </div>

          <div class="divider"></div>

          <div class="muted" style="font-size:12px;line-height:1.35">
            *Tip: Timeline ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä event card ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•ã ‚Üí detail + photo ‡§ñ‡•Å‡§≤ ‡§ú‡§æ‡§è‡§ó‡•Ä.<br/>
            *‡§Ö‡§ó‡§∞ backend thumbnail URL ‡§≠‡•á‡§ú‡•á‡§ó‡§æ ‡§§‡•ã thumbnails lightweight ‡§∞‡§π‡•á‡§Ç‡§ó‡•á.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="rightTop">
          <div class="heading">
            <b id="resultTitle">No results yet</b>
            <span id="resultSub">Upload selfie and press Search</span>
          </div>
          <div class="tabs">
            <div class="tab active" data-tab="timeline" id="tabTimeline">Timeline</div>
            <div class="tab" data-tab="photos" id="tabPhotos">Photos</div>
          </div>
        </div>

        <!-- Timeline -->
        <div id="timelineView">
          <div class="timeline" id="timeline"></div>
          <div class="empty" id="timelineEmpty">No data.</div>
        </div>

        <!-- Photos -->
        <div id="photosView" style="display:none">
          <div class="galleryWrap">
            <div class="galleryTools">
              <div class="muted" id="galleryHint">Photos will appear here.</div>
              <div class="row">
                <button class="btn small secondary" id="selectAllBtn" type="button">Select All</button>
                <button class="btn small secondary" id="clearSelBtn" type="button">Clear</button>
              </div>
            </div>
            <div class="galleryGrid" id="gallery"></div>
            <div class="empty" id="galleryEmpty">No photos.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal / Lightbox -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="media">
        <img id="modalImg" alt="photo" />
      </div>
      <div class="side">
        <div class="head">
          <div>
            <div style="font-weight:900" id="modalTitle">Detail</div>
            <div class="muted" style="font-size:12px" id="modalSub">‚Äî</div>
          </div>
          <div class="row">
            <button class="btn small secondary" id="openImgBtn" type="button">Open</button>
            <button class="btn small" id="downloadImgBtn" type="button">Download</button>
            <div class="close" id="closeModal" title="Close">‚úï</div>
          </div>
        </div>

        <div class="kv">
          <b>Key Info</b>
          <pre id="modalKeyInfo">‚Äî</pre>
        </div>

        <div class="kv">
          <b>Full Data</b>
          <pre id="modalJson">‚Äî</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t" id="toastTitle">‚Äî</div>
    <div class="m" id="toastMsg">‚Äî</div>
  </div>

<script>
(function(){
  // ====== CONFIG ======
  const REGION = "ap-south-1";
  const API_ID = "vxid0yoovj"; // keep your existing API id
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  // Endpoint: POST /political/search  (token-based)
  const SEARCH_ENDPOINT = `${BASE_URL}/political/search`;

  // ====== HELPERS ======
  const qs = new URLSearchParams(window.location.search);
  const token = qs.get("token") || "";

  const el = {
    envPill: document.getElementById("envPill"),
    selfieInput: document.getElementById("selfieInput"),
    selfieThumb: document.getElementById("selfieThumb"),
    fileName: document.getElementById("fileName"),
    clearBtn: document.getElementById("clearBtn"),
    searchBtn: document.getElementById("searchBtn"),
    searchBtnIcon: document.getElementById("searchBtnIcon"),
    searchBtnText: document.getElementById("searchBtnText"),
    resetViewBtn: document.getElementById("resetViewBtn"),
    q: document.getElementById("q"),
    formTypeFilter: document.getElementById("formTypeFilter"),
    sortBy: document.getElementById("sortBy"),
    statEvents: document.getElementById("statEvents"),
    statPhotos: document.getElementById("statPhotos"),
    statSim: document.getElementById("statSim"),
    profName: document.getElementById("profName"),
    profMobile: document.getElementById("profMobile"),
    resultTitle: document.getElementById("resultTitle"),
    resultSub: document.getElementById("resultSub"),

    tabTimeline: document.getElementById("tabTimeline"),
    tabPhotos: document.getElementById("tabPhotos"),
    timelineView: document.getElementById("timelineView"),
    photosView: document.getElementById("photosView"),
    timeline: document.getElementById("timeline"),
    timelineEmpty: document.getElementById("timelineEmpty"),

    gallery: document.getElementById("gallery"),
    galleryEmpty: document.getElementById("galleryEmpty"),
    galleryHint: document.getElementById("galleryHint"),
    selectAllBtn: document.getElementById("selectAllBtn"),
    clearSelBtn: document.getElementById("clearSelBtn"),
    downloadSelectedBtn: document.getElementById("downloadSelectedBtn"),
    slideshowBtn: document.getElementById("slideshowBtn"),

    overlay: document.getElementById("overlay"),
    closeModal: document.getElementById("closeModal"),
    modalImg: document.getElementById("modalImg"),
    modalTitle: document.getElementById("modalTitle"),
    modalSub: document.getElementById("modalSub"),
    modalKeyInfo: document.getElementById("modalKeyInfo"),
    modalJson: document.getElementById("modalJson"),
    openImgBtn: document.getElementById("openImgBtn"),
    downloadImgBtn: document.getElementById("downloadImgBtn"),

    toast: document.getElementById("toast"),
    toastTitle: document.getElementById("toastTitle"),
    toastMsg: document.getElementById("toastMsg"),
    copyLinkBtn: document.getElementById("copyLinkBtn"),
    shareBtn: document.getElementById("shareBtn"),
  };

  function toast(title, msg){
    el.toastTitle.textContent = title;
    el.toastMsg.textContent = msg || "";
    el.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.toast.classList.remove("show"), 3500);
  }

  function safeStr(v){
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function toISO(msOrIso){
    // timeline has created_at_iso already; fallback
    const s = safeStr(msOrIso);
    if (!s) return "";
    if (s.includes("T") && s.includes("Z")) return s;
    if (s.includes("T") && s.includes("+")) return s;
    // ms string?
    const n = Number(s);
    if (!Number.isFinite(n)) return s;
    try{
      return new Date(n).toISOString();
    }catch(e){ return s; }
  }

  function fmtDT(iso){
    if(!iso) return "";
    try{
      const d = new Date(iso);
      return d.toLocaleString("en-IN",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }catch(e){ return iso; }
  }

  function formLabel(ft){
    const map = {
      "visitor_form":"Visitor",
      "party_attendance":"Attendance",
      "president_tour_form":"President Tour",
      "mandal_reporting":"Mandal Report",
      "program_info_form":"Program Info",
      "coordinator_entry_form":"Coordinator Entry",
      "search":"Search"
    };
    return map[ft] || ft || "Form";
  }

  function pick(obj, keys){
    for (const k of keys){
      const v = obj && obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== "") return v;
    }
    return "";
  }

  function keyInfoFromItem(item){
    const d = item.data || {};
    const ft = safeStr(item.form_type);
    const program = pick(d, ["program_name","programType","program","tour_venue","venue"]) || pick(item, ["reason"]) || "";
    const guests = pick(d, ["guests","guest","guests_name","guest_names"]) || "";
    const when = pick(d, ["tour_date","event_date","date"]) || "";
    const time = pick(d, ["tour_time","event_time","time"]) || "";
    const venue = pick(d, ["tour_venue","venue"]) || "";
    const attendance = pick(d, ["attendance","count"]) || "";
    const lvl = pick(d, ["level"]) || "";
    return {
      title: (program ? program : formLabel(ft)),
      subtitle: [when, time, venue].filter(Boolean).join(" ‚Ä¢ "),
      guests,
      attendance,
      level: lvl
    };
  }

  function parseS3KeyFromUrl(url){
    try{
      const u = new URL(url);
      // virtual-hosted style: bucket.s3.amazonaws.com/key
      return decodeURIComponent(u.pathname.replace(/^\//,""));
    }catch(e){ return ""; }
  }

  function buildUrlMaps(resp){
    // Supports: photo_urls, thumb_urls
    const byKey = {};
    const thumbsByKey = {};
    const list = Array.isArray(resp.photo_urls) ? resp.photo_urls : [];
    for (const u of list){
      const k = parseS3KeyFromUrl(u);
      if (k) byKey[k] = u;
    }
    const tlist = Array.isArray(resp.thumb_urls) ? resp.thumb_urls : [];
    for (const u of tlist){
      const k = parseS3KeyFromUrl(u);
      if (k) thumbsByKey[k] = u;
    }
    return {byKey, thumbsByKey};
  }

  // ====== STATE ======
  let lastResp = null;
  let galleryItems = []; // {url, thumbUrl, s3_key, caption, sub, itemRef}
  let selectedKeys = new Set();
  let slideshowIndex = 0;

  // ====== UI ACTIONS ======
  function setBusy(isBusy){
    if(isBusy){
      el.searchBtnIcon.innerHTML = '<span class="spinner"></span>';
      el.searchBtnText.textContent = "Searching...";
      el.searchBtn.disabled = true;
    }else{
      el.searchBtnIcon.textContent = "üîé";
      el.searchBtnText.textContent = "Search";
      el.searchBtn.disabled = false;
    }
  }

  function clearFile(){
    el.selfieInput.value = "";
    el.selfieThumb.innerHTML = '<span class="muted">No photo</span>';
    el.fileName.textContent = "No file selected";
  }

  function setTab(tab){
    const isTimeline = tab === "timeline";
    el.tabTimeline.classList.toggle("active", isTimeline);
    el.tabPhotos.classList.toggle("active", !isTimeline);
    el.timelineView.style.display = isTimeline ? "" : "none";
    el.photosView.style.display = isTimeline ? "none" : "";
  }

  function resetView(){
    el.q.value = "";
    el.formTypeFilter.value = "";
    el.sortBy.value = "new";
    selectedKeys.clear();
    renderAll();
  }

  function ensureFormTypeOptions(timeline){
    const set = new Set();
    (timeline||[]).forEach(i => set.add(safeStr(i.form_type)));
    const current = el.formTypeFilter.value;
    // rebuild
    el.formTypeFilter.innerHTML = '<option value="">All forms</option>';
    [...set].filter(Boolean).sort().forEach(ft=>{
      const opt = document.createElement("option");
      opt.value = ft;
      opt.textContent = formLabel(ft);
      el.formTypeFilter.appendChild(opt);
    });
    el.formTypeFilter.value = current;
  }

  function filterTimeline(timeline){
    let items = Array.isArray(timeline) ? [...timeline] : [];
    const ft = el.formTypeFilter.value;
    const q = el.q.value.trim().toLowerCase();
    if (ft){
      items = items.filter(i => safeStr(i.form_type) === ft);
    }
    if (q){
      items = items.filter(i=>{
        const d = i.data || {};
        const blob = [
          i.form_type, i.district, i.vidhansabha, i.mandal, i.reason, i.name, i.mobile,
          d.program_name, d.program_type, d.tour_venue, d.venue, d.guests, d.tour_date, d.event_date,
          d.attendance
        ].map(safeStr).join(" ").toLowerCase();
        return blob.includes(q);
      });
    }
    const sort = el.sortBy.value;
    items.sort((a,b)=>{
      const A = Number(safeStr(a.created_at)) || Date.parse(a.created_at_iso||"") || 0;
      const B = Number(safeStr(b.created_at)) || Date.parse(b.created_at_iso||"") || 0;
      return sort === "old" ? (A-B) : (B-A);
    });
    return items;
  }

  function buildGalleryFromTimeline(resp){
    const timeline = Array.isArray(resp.timeline) ? resp.timeline : [];
    const {byKey, thumbsByKey} = buildUrlMaps(resp);
    const map = new Map(); // s3_key -> item
    for (const it of timeline){
      const k = safeStr(it.s3_key);
      if (!k) continue;
      if (!map.has(k)) map.set(k, it);
    }
    const out = [];
    for (const [k, it] of map.entries()){
      const url = byKey[k] || ""; // may be empty if backend didn't return signed url
      // thumb url might be separate key, or same key mapping
      const turl = thumbsByKey[k] || "";
      const ki = keyInfoFromItem(it);
      const caption = formLabel(it.form_type) + (ki.title ? (" ‚Ä¢ " + ki.title) : "");
      const sub = (it.created_at_iso ? fmtDT(it.created_at_iso) : "") || (toISO(it.created_at)||"");
      out.push({
        s3_key:k,
        url,
        thumbUrl: turl || url,
        caption,
        sub,
        itemRef: it
      });
    }
    // fallback: if backend returned photo_urls but timeline has no s3_key match (rare)
    if (out.length === 0 && Array.isArray(resp.photo_urls)){
      resp.photo_urls.forEach((u,idx)=>{
        out.push({
          s3_key: "photo_"+idx,
          url: u,
          thumbUrl: u,
          caption: "Photo",
          sub: "",
          itemRef: null
        });
      });
    }
    // Sort by time desc
    out.sort((a,b)=>{
      const A = Date.parse(a.itemRef?.created_at_iso||"") || Number(a.itemRef?.created_at||0) || 0;
      const B = Date.parse(b.itemRef?.created_at_iso||"") || Number(b.itemRef?.created_at||0) || 0;
      return B-A;
    });
    return out;
  }

  function renderTimeline(resp){
    const timeline = filterTimeline(resp.timeline || []);
    el.timeline.innerHTML = "";
    el.timelineEmpty.style.display = timeline.length ? "none" : "";
    if (!timeline.length) return;

    const {byKey, thumbsByKey} = buildUrlMaps(resp);

    for (const it of timeline){
      const ft = safeStr(it.form_type);
      const dt = it.created_at_iso ? fmtDT(it.created_at_iso) : fmtDT(toISO(it.created_at));
      const ki = keyInfoFromItem(it);

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.entryId = safeStr(it.entry_id||"");
      card.dataset.s3Key = safeStr(it.s3_key||"");

      const imgBox = document.createElement("div");
      imgBox.className = "img";

      // thumb preference: thumb_urls map -> else photo_urls map -> else placeholder
      const s3k = safeStr(it.s3_key||"");
      const thumbUrl = (s3k && (thumbsByKey[s3k] || byKey[s3k])) || "";
      if (thumbUrl){
        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = thumbUrl;
        img.alt = "thumb";
        imgBox.appendChild(img);
      }else{
        imgBox.innerHTML = '<span class="muted" style="font-size:11px">No<br/>thumb</span>';
      }

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = formLabel(ft);
      imgBox.appendChild(badge);

      const body = document.createElement("div");
      body.className = "body";

      const top = document.createElement("div");
      top.className = "topline";

      const main = document.createElement("div");
      main.className = "main";

      const h = document.createElement("div");
      h.className = "h";
      h.textContent = ki.title || formLabel(ft);

      const sub = document.createElement("div");
      sub.className = "sub";
      sub.textContent = (dt ? dt + " ‚Ä¢ " : "") + (ki.subtitle || "");

      main.appendChild(h);
      main.appendChild(sub);

      const right = document.createElement("div");
      right.style.color = "var(--muted)";
      right.style.fontSize = "12px";
      right.style.whiteSpace = "nowrap";
      right.textContent = safeStr(it.district || (it.data && it.data.district) || "");

      top.appendChild(main);
      top.appendChild(right);

      const meta = document.createElement("div");
      meta.className = "metaRow";
      const guests = (ki.guests || "");
      const attendance = (ki.attendance || "");
      const level = (ki.level || "");
      if (guests){
        const sp = document.createElement("span");
        sp.innerHTML = "Guests: <b>" + escapeHtml(guests) + "</b>";
        meta.appendChild(sp);
      }
      if (attendance){
        const sp = document.createElement("span");
        sp.innerHTML = "Attendance: <b>" + escapeHtml(attendance) + "</b>";
        meta.appendChild(sp);
      }
      const placeParts = [
        pick(it, ["district"]) || pick(it.data||{}, ["district"]),
        pick(it, ["vidhansabha"]) || pick(it.data||{}, ["vidhansabha"]),
        pick(it, ["mandal"]) || pick(it.data||{}, ["mandal"])
      ].filter(Boolean);
      if (placeParts.length){
        const sp = document.createElement("span");
        sp.innerHTML = "Area: <b>" + escapeHtml(placeParts.join(" / ")) + "</b>";
        meta.appendChild(sp);
      }
      if (level){
        const sp = document.createElement("span");
        sp.innerHTML = "Level: <b>" + escapeHtml(level) + "</b>";
        meta.appendChild(sp);
      }
      body.appendChild(top);
      if (meta.childNodes.length) body.appendChild(meta);

      card.appendChild(imgBox);
      card.appendChild(body);

      card.addEventListener("click", ()=> openDetail(resp, it));
      el.timeline.appendChild(card);
    }
  }

  function escapeHtml(s){
    return safeStr(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderGallery(){
    el.gallery.innerHTML = "";
    el.galleryEmpty.style.display = galleryItems.length ? "none" : "";
    el.galleryHint.textContent = galleryItems.length ? ("Total photos: " + galleryItems.length) : "Photos will appear here.";

    for (const g of galleryItems){
      const tile = document.createElement("div");
      tile.className = "ph";
      tile.dataset.s3Key = g.s3_key;

      const check = document.createElement("div");
      check.className = "check";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedKeys.has(g.s3_key);
      cb.addEventListener("click", (e)=>{ e.stopPropagation(); toggleSelect(g.s3_key, cb.checked); });
      check.appendChild(cb);

      const img = document.createElement("div");
      img.className = "img";
      if (g.thumbUrl){
        img.innerHTML = '<img loading="lazy" alt="photo" src="'+escapeHtml(g.thumbUrl)+'"/>';
      }else{
        img.innerHTML = '<span class="muted" style="font-size:11px">No photo URL</span>';
      }

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = g.itemRef ? formLabel(g.itemRef.form_type) : "Photo";

      const cap = document.createElement("div");
      cap.className = "cap";
      const t = document.createElement("div");
      t.className = "t";
      t.textContent = g.caption || "Photo";
      const s = document.createElement("div");
      s.className = "s";
      s.textContent = g.sub || "";
      cap.appendChild(t);
      cap.appendChild(s);

      tile.appendChild(check);
      tile.appendChild(img);
      tile.appendChild(tag);
      tile.appendChild(cap);

      tile.addEventListener("click", ()=>{
        // open lightbox
        slideshowIndex = galleryItems.findIndex(x=>x.s3_key===g.s3_key);
        openPhoto(g);
      });

      el.gallery.appendChild(tile);
    }

    el.statPhotos.textContent = String(galleryItems.length);
  }

  function toggleSelect(key, isChecked){
    if (isChecked) selectedKeys.add(key);
    else selectedKeys.delete(key);
  }

  function renderStats(resp){
    const timeline = Array.isArray(resp.timeline) ? resp.timeline : [];
    el.statEvents.textContent = String(timeline.length);
    el.statSim.textContent = resp.similarity !== undefined ? String(resp.similarity) : "‚Äî";
    const name = resp.profile && resp.profile.name ? resp.profile.name : "‚Äî";
    const mobile = resp.profile && resp.profile.mobile ? resp.profile.mobile : "‚Äî";
    el.profName.textContent = name || "‚Äî";
    el.profMobile.textContent = mobile || "‚Äî";
  }

  function renderAll(){
    if (!lastResp){
      el.timeline.innerHTML = "";
      el.timelineEmpty.style.display = "";
      el.gallery.innerHTML = "";
      el.galleryEmpty.style.display = "";
      el.statEvents.textContent = "0";
      el.statPhotos.textContent = "0";
      el.statSim.textContent = "‚Äî";
      el.profName.textContent = "‚Äî";
      el.profMobile.textContent = "‚Äî";
      return;
    }
    renderStats(lastResp);
    ensureFormTypeOptions(lastResp.timeline||[]);
    renderTimeline(lastResp);
    renderGallery();
  }

  // ====== MODAL / LIGHTBOX ======
  function openDetail(resp, item){
    const {byKey, thumbsByKey} = buildUrlMaps(resp);
    const k = safeStr(item.s3_key||"");
    const url = (k && (byKey[k] || thumbsByKey[k])) || (Array.isArray(resp.photo_urls) ? resp.photo_urls[0] : "");
    el.modalImg.src = url || "";
    el.modalTitle.textContent = formLabel(item.form_type) + " ‚Ä¢ " + (item.entry_id || "");
    el.modalSub.textContent = (item.created_at_iso ? fmtDT(item.created_at_iso) : "");

    const ki = keyInfoFromItem(item);
    const lines = [];
    lines.push("Title: " + (ki.title||""));
    if (ki.subtitle) lines.push("When/Where: " + ki.subtitle);
    if (ki.guests) lines.push("Guests: " + ki.guests);
    if (ki.attendance) lines.push("Attendance: " + ki.attendance);
    const area = [
      pick(item, ["district"]) || pick(item.data||{}, ["district"]),
      pick(item, ["vidhansabha"]) || pick(item.data||{}, ["vidhansabha"]),
      pick(item, ["mandal"]) || pick(item.data||{}, ["mandal"]),
    ].filter(Boolean).join(" / ");
    if (area) lines.push("Area: " + area);
    if (k) lines.push("S3 Key: " + k);

    el.modalKeyInfo.textContent = lines.join("\n");
    el.modalJson.textContent = JSON.stringify(item, null, 2);

    el.openImgBtn.onclick = ()=> { if (url) window.open(url, "_blank"); else toast("No URL","Backend ‡§®‡•á signed photo URL ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ."); };
    el.downloadImgBtn.onclick = ()=> downloadUrl(url, (item.entry_id||"photo") + ".jpg");

    el.overlay.classList.add("show");
  }

  function openPhoto(g){
    if (!g || !g.url){
      toast("No URL", "‡§á‡§∏ photo ‡§ï‡§æ signed URL backend ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§Ø‡§æ.");
      return;
    }
    el.modalImg.src = g.url;
    el.modalTitle.textContent = g.caption || "Photo";
    el.modalSub.textContent = g.sub || "";
    el.modalKeyInfo.textContent = "S3 Key: " + g.s3_key;
    el.modalJson.textContent = JSON.stringify(g.itemRef || {}, null, 2);
    el.openImgBtn.onclick = ()=> window.open(g.url, "_blank");
    el.downloadImgBtn.onclick = ()=> downloadUrl(g.url, (g.s3_key.split("/").pop() || "photo") );
    el.overlay.classList.add("show");
  }

  function closeModal(){
    el.overlay.classList.remove("show");
  }

  function downloadUrl(url, filename){
    if (!url){ toast("No URL",""); return; }
    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "photo.jpg";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ====== SLIDESHOW ======
  function startSlideshow(){
    if (!galleryItems.length){
      toast("No photos","‡§™‡§π‡§≤‡•á search ‡§ï‡§∞‡•ã, ‡§´‡§ø‡§∞ Photos tab ‡§Æ‡•á‡§Ç photos ‡§Ü‡§è‡§Ç‡§ó‡•á.");
      return;
    }
    // start from first selected, else current index
    const selected = [...selectedKeys];
    if (selected.length){
      const idx = galleryItems.findIndex(x=>x.s3_key===selected[0]);
      if (idx >= 0) slideshowIndex = idx;
    }else{
      slideshowIndex = 0;
    }
    openPhoto(galleryItems[slideshowIndex]);
    toast("Slideshow", "Arrow keys (‚Üê/‚Üí) ‡§∏‡•á next/prev. ESC ‡§∏‡•á close.");
  }

  function slideshowNext(dir){
    if (!galleryItems.length) return;
    slideshowIndex = (slideshowIndex + dir + galleryItems.length) % galleryItems.length;
    openPhoto(galleryItems[slideshowIndex]);
  }

  // ====== SHARE / COPY LINK ======
  async function copyLink(){
    try{
      await navigator.clipboard.writeText(window.location.href);
      toast("Copied", "Link clipboard ‡§Æ‡•á‡§Ç copy ‡§π‡•ã ‡§ó‡§Ø‡§æ.");
    }catch(e){
      toast("Copy failed", "Browser clipboard block ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à. Manually copy ‡§ï‡§∞ ‡§≤‡•ã.");
    }
  }

  async function shareLink(){
    const url = window.location.href;
    if (navigator.share){
      try{
        await navigator.share({title: document.title, text: "EventLens Political Worker Search", url});
      }catch(e){}
    }else{
      await copyLink();
      toast("Share", "Web Share unsupported. Link copy ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ.");
    }
  }

  // ====== API CALL ======
  async function callSearch(file){
    const fd = new FormData();
    fd.append("selfie", file);
    if (token) fd.append("token", token);

    const resp = await fetch(SEARCH_ENDPOINT, { method:"POST", body: fd });
    const data = await resp.json().catch(()=> ({}));
    if (!resp.ok){
      const msg = data && (data.message || data.error) ? (data.message || data.error) : ("HTTP " + resp.status);
      throw new Error(msg);
    }
    return data;
  }

  // ====== FILE PREVIEW ======
  function previewSelectedFile(file){
    if (!file){ return; }
    el.fileName.textContent = file.name;
    const url = URL.createObjectURL(file);
    el.selfieThumb.innerHTML = '<img alt="selfie" src="'+escapeHtml(url)+'"/>';
  }

  // ====== EVENT WIRES ======
  el.envPill.textContent = "ENV: " + (token ? "PUBLIC" : "ADMIN");
  el.copyLinkBtn.addEventListener("click", copyLink);
  el.shareBtn.addEventListener("click", shareLink);

  el.selfieInput.addEventListener("change", ()=>{
    const f = el.selfieInput.files && el.selfieInput.files[0];
    if (f) previewSelectedFile(f);
  });

  el.clearBtn.addEventListener("click", ()=>{ clearFile(); });

  el.resetViewBtn.addEventListener("click", resetView);

  el.formTypeFilter.addEventListener("change", renderAll);
  el.sortBy.addEventListener("change", renderAll);
  el.q.addEventListener("input", ()=>{ renderAll(); });

  el.tabTimeline.addEventListener("click", ()=> setTab("timeline"));
  el.tabPhotos.addEventListener("click", ()=> setTab("photos"));

  el.selectAllBtn.addEventListener("click", ()=>{
    galleryItems.forEach(g=> selectedKeys.add(g.s3_key));
    renderGallery();
    toast("Selected", "All photos selected.");
  });

  el.clearSelBtn.addEventListener("click", ()=>{
    selectedKeys.clear();
    renderGallery();
    toast("Cleared", "Selection cleared.");
  });

  el.downloadSelectedBtn.addEventListener("click", ()=>{
    const keys = [...selectedKeys];
    if (!keys.length){ toast("No selection", "‡§™‡§π‡§≤‡•á photo select ‡§ï‡§∞‡•ã."); return; }
    // download one by one (browser may ask permission)
    let count = 0;
    for (const k of keys){
      const g = galleryItems.find(x=>x.s3_key===k);
      if (g && g.url){
        count++;
        downloadUrl(g.url, (k.split("/").pop() || ("photo_"+count+".jpg")));
      }
    }
    toast("Download", count ? (count + " downloads started.") : "No signed URLs available.");
  });

  el.slideshowBtn.addEventListener("click", startSlideshow);

  el.searchBtn.addEventListener("click", async ()=>{
    const f = el.selfieInput.files && el.selfieInput.files[0];
    if (!f){ toast("Selfie missing", "‡§™‡§π‡§≤‡•á selfie photo select ‡§ï‡§∞‡•ã."); return; }
    setBusy(true);
    try{
      const data = await callSearch(f);
      lastResp = data;
      // status
      if (data.message === "NO_MATCH"){
        el.resultTitle.textContent = "No match";
        el.resultSub.textContent = "Try another selfie (clear face, close-up).";
        galleryItems = [];
      }else{
        el.resultTitle.textContent = "Match found";
        el.resultSub.textContent = "FaceId: " + (data.face_id || "‚Äî") + " ‚Ä¢ similarity: " + (data.similarity ?? "‚Äî");
        galleryItems = buildGalleryFromTimeline(data);
      }
      // reset selection each new search
      selectedKeys.clear();
      renderAll();
      setTab("timeline");
      toast(data.message || "Done", data.message === "OK" ? "Results updated." : "No match.");
    }catch(err){
      console.error(err);
      toast("Search error", err.message || "Unknown error");
    }finally{
      setBusy(false);
    }
  });

  // modal close
  el.closeModal.addEventListener("click", closeModal);
  el.overlay.addEventListener("click", (e)=>{
    if (e.target === el.overlay) closeModal();
  });

  window.addEventListener("keydown", (e)=>{
    if (!el.overlay.classList.contains("show")) return;
    if (e.key === "Escape"){ closeModal(); }
    if (e.key === "ArrowRight"){ slideshowNext(+1); }
    if (e.key === "ArrowLeft"){ slideshowNext(-1); }
  });

  // initial render
  renderAll();
})();
</script>
</body>
</html>
