<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karyakarta Search AI - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: { brand: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c', dark: '#0f172a' } },
          animation: {
            'scan': 'scan 2s linear infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            scan: {
              '0%': { top: '0%', opacity: '0' },
              '10%': { opacity: '1' },
              '90%': { opacity: '1' },
              '100%': { top: '100%', opacity: '0' },
            }
          }
        }
      }
    }
  </script>

  <style>
    body { 
      background-color: #020617;
      background-image: 
        radial-gradient(at 0% 0%, rgba(249, 115, 22, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.10) 0px, transparent 50%);
      background-attachment: fixed;
      color: #e2e8f0; 
    }
    .glass-panel { 
      background: rgba(15, 23, 42, 0.6); 
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08); 
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .glass-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .timeline-line::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 20px;
      width: 2px;
      background: linear-gradient(to bottom, #f97316 0%, rgba(51, 65, 85, 0.5) 100%);
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Scan animation overlay */
    .scan-overlay {
      background: linear-gradient(to bottom, transparent, rgba(249, 115, 22, 0.5), transparent);
      height: 4px;
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.8);
    }
  </style>

  <script>
    // --- Image helpers ---
    function previewImage(inputEl) {
      try {
        const file = inputEl && inputEl.files && inputEl.files[0];
        const preview = document.getElementById("preview");
        const placeholder = document.getElementById("uploadPlaceholder");
        const scanLine = document.getElementById("scanLine");
        
        if (!preview) return;
        if (!file) {
          preview.src = "";
          preview.classList.add("hidden");
          if(placeholder) placeholder.classList.remove("hidden");
          if(scanLine) scanLine.classList.add("hidden");
          return;
        }
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.classList.remove("hidden");
        if(placeholder) placeholder.classList.add("hidden");
        // Show scan effect on preview
        if(scanLine) scanLine.classList.remove("hidden");
      } catch (e) { console.error(e); }
    }

    function setImgSrcWithRetry(imgEl, url, maxRetries = 2) {
      if (!imgEl) return;
      let attempt = 0;
      imgEl.referrerPolicy = "no-referrer";
      const load = () => { imgEl.src = url; };
      imgEl.onerror = () => {
        if (attempt < maxRetries) {
          attempt += 1;
          setTimeout(load, 350 * attempt);
          return;
        }
        imgEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E";
        imgEl.classList.add("p-4", "bg-slate-800");
      };
      load();
    }
    function getBestThumbUrl(obj, fallbackUrl) {
      if (!obj) return fallbackUrl;
      return obj.thumb_url || obj.thumbUrl || obj.thumbnail_url || obj.thumbnailUrl || fallbackUrl;
    }
  </script>
</head>
<body class="min-h-screen font-sans selection:bg-orange-500/30">

  <!-- Top Navbar -->
  <nav class="sticky top-0 z-40 glass-panel border-b-0 border-b-white/5 shadow-lg shadow-orange-900/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-orange-500/20">
            <i class="fa-solid fa-bolt text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white tracking-tight">EventLens <span class="text-orange-400">AI</span></h1>
            <p class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">Political Intelligence Unit</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
           <div id="tokenDisplay" class="hidden md:block px-3 py-1 rounded-full bg-slate-800/50 border border-slate-700 text-xs font-mono text-slate-400">
             <i class="fa-solid fa-shield-halved mr-1 text-emerald-500"></i> Secure
           </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-12 gap-8">
      
      <!-- Left Column: Search & Upload -->
      <div class="lg:col-span-4 space-y-6">
        
        <!-- Search Card -->
        <div class="glass-panel rounded-2xl p-1 shadow-2xl overflow-hidden relative group">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-red-600"></div>
          
          <div class="p-6 bg-slate-900/40">
            <h2 class="text-lg font-bold text-white mb-1 flex items-center gap-2">
              <i class="fa-solid fa-face-viewfinder text-orange-500"></i> Face Search
            </h2>
            <p class="text-slate-400 text-xs mb-6">Upload a selfie to scan the karyakarta database.</p>

            <!-- Upload Area -->
            <div class="relative w-full aspect-[4/5] bg-slate-800/50 rounded-xl border-2 border-dashed border-slate-700 hover:border-orange-500/50 transition-all duration-300 overflow-hidden group/upload cursor-pointer">
              <input id="selfieInput" accept="image/*" type="file" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" onchange="previewImage(this)" />
              
              <!-- Placeholder State -->
              <div id="uploadPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 group-hover/upload:text-orange-400 transition-colors pointer-events-none">
                <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-3 shadow-inner">
                  <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                </div>
                <span class="text-sm font-medium">Click to Upload Selfie</span>
                <span class="text-xs opacity-60 mt-1">Supports JPG, PNG</span>
              </div>

              <!-- Preview State -->
              <img id="preview" class="hidden absolute inset-0 w-full h-full object-cover z-10" />
              
              <!-- Scanning Animation (Hidden by default, shown via JS logic if needed, or CSS on preview) -->
              <div id="scanLine" class="hidden absolute left-0 w-full h-1 bg-orange-500 shadow-[0_0_15px_rgba(249,115,22,1)] z-10 animate-scan pointer-events-none"></div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 space-y-3">
              <button id="searchBtn" class="relative w-full py-4 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold shadow-lg shadow-orange-900/40 transition-all active:scale-[0.98] group/btn overflow-hidden">
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300"></div>
                <span class="relative flex items-center justify-center gap-2">
                  <i class="fa-solid fa-magnifying-glass"></i> Search Database
                </span>
              </button>
            </div>
            
            <!-- Status Text -->
            <div id="statusBox" class="hidden mt-4 text-center">
               <!-- Content injected by JS -->
            </div>
          </div>
        </div>

        <!-- Instructions (Optional) -->
        <div class="hidden lg:block p-5 rounded-2xl border border-slate-800 bg-slate-900/30 text-xs text-slate-400 leading-relaxed">
          <strong class="text-slate-300 block mb-2"><i class="fa-regular fa-lightbulb text-yellow-500 mr-1"></i> Pro Tips:</strong>
          <ul class="list-disc pl-4 space-y-1">
             <li>Ensure good lighting on the face.</li>
             <li>Avoid wearing sunglasses or masks.</li>
             <li>Results show timeline events and grouped photos.</li>
          </ul>
        </div>
      </div>

      <!-- Right Column: Results -->
      <div class="lg:col-span-8 space-y-6">
        
        <!-- Empty State -->
        <div id="emptyState" class="glass-panel rounded-2xl p-12 text-center flex flex-col items-center justify-center h-full min-h-[400px]">
           <div class="w-24 h-24 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 border border-slate-700">
             <i class="fa-solid fa-fingerprint text-4xl text-slate-600"></i>
           </div>
           <h3 class="text-xl font-bold text-slate-300">Ready to Search</h3>
           <p class="text-slate-500 mt-2 max-w-sm">Upload a photo from the left panel to identify karyakartas and view their event history.</p>
        </div>

        <!-- Stats Dashboard (Hidden initially) -->
        <div id="statsDashboard" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4">
          <!-- Match Score -->
          <div class="glass-card p-4 rounded-xl relative overflow-hidden">
             <div class="absolute right-0 top-0 p-3 opacity-10"><i class="fa-solid fa-bullseye text-6xl"></i></div>
             <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider">AI Confidence</div>
             <div class="mt-2 flex items-baseline gap-1">
                <span id="scoreVal" class="text-3xl font-extrabold text-white">0%</span>
             </div>
             <div class="w-full bg-slate-700 h-1.5 mt-3 rounded-full overflow-hidden">
                <div id="scoreBar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 w-0 transition-all duration-1000"></div>
             </div>
          </div>
          
          <!-- Timeline Count -->
          <div class="glass-card p-4 rounded-xl relative overflow-hidden">
             <div class="absolute right-0 top-0 p-3 opacity-10"><i class="fa-solid fa-clock-rotate-left text-6xl"></i></div>
             <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Events Found</div>
             <div class="mt-2 text-3xl font-extrabold text-white" id="eventCountVal">0</div>
             <div class="text-xs text-slate-500 mt-1">Timeline entries</div>
          </div>
          
          <!-- Photos Count -->
          <div class="glass-card p-4 rounded-xl relative overflow-hidden">
             <div class="absolute right-0 top-0 p-3 opacity-10"><i class="fa-solid fa-images text-6xl"></i></div>
             <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Visual Records</div>
             <div class="mt-2 text-3xl font-extrabold text-white" id="photoCountVal">0</div>
             <div class="text-xs text-slate-500 mt-1">Photos matched</div>
          </div>
        </div>

        <!-- Timeline Section -->
        <div id="resultsContainer" class="hidden space-y-8">
           
           <!-- Tab/Header -->
           <div class="flex items-center gap-6 border-b border-slate-700/50 pb-4">
              <button class="text-orange-500 font-bold border-b-2 border-orange-500 pb-4 -mb-4.5 px-2">Timeline</button>
              <button class="text-slate-400 hover:text-slate-200 font-medium pb-4 -mb-4.5 px-2 transition-colors" onclick="document.getElementById('photosSection').scrollIntoView({behavior: 'smooth'})">Photos</button>
           </div>

           <div class="relative pl-4 timeline-line space-y-8" id="timeline">
              <!-- Timeline Items injected here -->
           </div>

           <!-- Photos Grid -->
           <div id="photosSection" class="pt-8 border-t border-slate-800 hidden">
              <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <i class="fa-regular fa-images text-orange-500"></i> Photo Gallery
              </h3>
              <div id="photosGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                 <!-- Photos injected here -->
              </div>
           </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>
    
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <!-- Panel -->
        <div class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl opacity-0 scale-95" id="modalPanel">
          <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700/50 bg-slate-800/30">
             <h3 class="text-lg font-semibold leading-6 text-white" id="detailModalTitle">Details</h3>
             <button id="detailModalClose" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
          </div>
          <div class="px-6 py-6 max-h-[70vh] overflow-y-auto custom-scrollbar" id="detailModalBody">
            <!-- Content -->
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- LOGIC SCRIPT (UNCHANGED LOGIC, JUST UPDATED RENDERERS) -->
<script>
(() => {
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;

  const qs = new URLSearchParams(window.location.search);
  const token = qs.get("token") || "";   

  const el = {
    selfieInput: document.getElementById("selfieInput"),
    preview: document.getElementById("preview"),
    statusBox: document.getElementById("statusBox"),
    // New stats elements
    emptyState: document.getElementById("emptyState"),
    statsDashboard: document.getElementById("statsDashboard"),
    resultsContainer: document.getElementById("resultsContainer"),
    scoreVal: document.getElementById("scoreVal"),
    scoreBar: document.getElementById("scoreBar"),
    eventCountVal: document.getElementById("eventCountVal"),
    photoCountVal: document.getElementById("photoCountVal"),
    
    timeline: document.getElementById("timeline"),
    photosSection: document.getElementById("photosSection"),
    photosGrid: document.getElementById("photosGrid"),
    searchBtn: document.getElementById("searchBtn"),
  };

  // --------- Modal Logic (Updated Animations) ----------
  const modal = (() => {
    const wrap = document.getElementById("detailModal");
    const backdrop = document.getElementById("modalBackdrop");
    const panel = document.getElementById("modalPanel");
    const titleEl = document.getElementById("detailModalTitle");
    const bodyEl = document.getElementById("detailModalBody");
    const closeBtn = document.getElementById("detailModalClose");

    function open(title, bodyNode) {
      titleEl.textContent = title || "Details";
      bodyEl.innerHTML = "";
      if (bodyNode) bodyEl.appendChild(bodyNode);
      
      wrap.classList.remove("hidden");
      // Animate in
      requestAnimationFrame(() => {
        backdrop.classList.remove("opacity-0");
        panel.classList.remove("opacity-0", "scale-95");
        panel.classList.add("opacity-100", "scale-100");
      });
      document.body.classList.add("overflow-hidden");
    }

    function close() {
      backdrop.classList.add("opacity-0");
      panel.classList.remove("opacity-100", "scale-100");
      panel.classList.add("opacity-0", "scale-95");
      
      setTimeout(() => {
        wrap.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }, 200); // match transition duration
    }

    closeBtn.addEventListener("click", close);
    backdrop.addEventListener("click", close);

    return { open, close };
  })();

  // --------- UI Helpers (Same logic) ----------
  function isNonEmpty(v) { return v !== null && v !== undefined && String(v).trim() !== ""; }
  
  function prettyIso(iso) {
    if (!isNonEmpty(iso)) return "";
    const date = new Date(iso);
    return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
  }

  function setStatus(msg, type = "info") {
    if (!el.statusBox) return;
    el.statusBox.classList.remove("hidden");
    el.statusBox.innerHTML = `
      <div class="inline-flex items-center px-4 py-2 rounded-full text-xs font-semibold ${
        type === 'error' ? 'bg-red-500/10 text-red-400 border border-red-500/20' : 
        type === 'success' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 
        'bg-slate-800 text-slate-300 border border-slate-700'
      }">
        ${type === 'loading' ? '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>' : ''}
        ${msg}
      </div>
    `;
  }

  function updateDashboard(sim, events, photos) {
    el.emptyState.classList.add("hidden");
    el.statsDashboard.classList.remove("hidden");
    el.resultsContainer.classList.remove("hidden");

    // Animate Numbers
    el.scoreVal.textContent = sim + "%";
    el.scoreBar.style.width = sim + "%";
    el.scoreBar.className = `h-full transition-all duration-1000 ${
      sim > 80 ? 'bg-gradient-to-r from-emerald-500 to-green-400' : 
      sim > 50 ? 'bg-gradient-to-r from-yellow-500 to-orange-400' : 
      'bg-gradient-to-r from-red-500 to-red-400'
    }`;
    
    el.eventCountVal.textContent = events;
    el.photoCountVal.textContent = photos;
  }

  function get(obj, key, fallback = "") {
    if (!obj) return fallback;
    const v = obj[key];
    return isNonEmpty(v) ? v : fallback;
  }

  // --------- Logic: Build Summary (Unchanged) ----------
  function buildEventSummary(item) {
    const form = get(item, "form_type", "");
    const data = item.data || {};

    const district = get(item, "district", get(data, "district", ""));
    const vidhansabha = get(item, "vidhansabha", get(data, "vidhansabha", ""));
    const mandal = get(item, "mandal", get(data, "mandal", ""));
    const createdAtIso = prettyIso(get(item, "created_at_iso", ""));

    let title = form || "Event";
    let subtitle = "";
    let icon = "fa-calendar-check"; // Default icon
    const highlights = []; 
    const footer = [];     

    if (form === "president_tour_form") {
      title = get(data, "program_name", get(data, "program_type", "President Tour"));
      icon = "fa-plane-departure";
      const date = get(data, "tour_date", "");
      const venue = get(data, "tour_venue", "");
      subtitle = [date, venue].filter(isNonEmpty).join(" • ");
      const guests = get(data, "guests", "");
      const level = get(data, "level", "");
      if (isNonEmpty(guests)) highlights.push(["Guests", guests]);
      if (isNonEmpty(level)) highlights.push(["Level", level]);
    } else if (form === "mandal_reporting") {
      title = get(data, "venue", "Mandal Report");
      icon = "fa-clipboard-list";
      const date = get(data, "event_date", "");
      subtitle = date;
      const guests = get(data, "guests", "");
      const attendance = get(data, "attendance", "");
      if (isNonEmpty(guests)) highlights.push(["Guests", guests]);
      if (isNonEmpty(attendance)) highlights.push(["Attendance", attendance]);
    } else if (form === "visitor_form") {
      title = get(item, "name", get(data, "name", "Visitor"));
      icon = "fa-user-clock";
      subtitle = get(data, "reason", "");
    } else if (form === "party_attendance") {
      title = "Party Attendance";
      icon = "fa-users-line";
      subtitle = get(data, "designation", "");
    }

    const locBits = [district, vidhansabha].filter(isNonEmpty);
    if (locBits.length) footer.push(locBits.join(", "));
    if (isNonEmpty(createdAtIso)) footer.push(createdAtIso);

    // Full details for modal
    const details = [];
    const pushD = (k, v) => { if (isNonEmpty(v)) details.push([k, String(v)]); };
    
    // Core fields
    pushD("Form Type", form);
    pushD("District", district);
    pushD("Vidhansabha", vidhansabha);
    pushD("Mandal", mandal);
    pushD("Created", get(item, "created_at_iso", ""));

    // Dynamic fields
    Object.keys(data).forEach(k => {
      if(typeof data[k] !== 'object') pushD(k, data[k]);
    });

    return { title, subtitle, highlights, footer, details, rawData: data, icon };
  }

  function makeKVTable(rows) {
    const div = document.createElement("div");
    div.className = "space-y-3";
    rows.forEach(([k, v]) => {
      const row = document.createElement("div");
      row.className = "flex flex-col sm:flex-row sm:justify-between border-b border-slate-800 pb-2 last:border-0";
      row.innerHTML = `
        <span class="text-xs text-slate-500 font-medium uppercase tracking-wide">${k}</span>
        <span class="text-sm text-slate-200 font-medium text-right mt-1 sm:mt-0">${v}</span>
      `;
      div.appendChild(row);
    });
    return div;
  }

  function parseS3KeyFromUrl(url) {
    try {
      const u = new URL(url);
      const p = u.pathname || "";
      return p.startsWith("/") ? p.slice(1) : p;
    } catch (e) { return ""; }
  }

  // --------- Render Timeline (New Design) ----------
  function renderTimeline(timeline, photoUrlByKey) {
    if (!el.timeline) return;
    el.timeline.innerHTML = "";

    if (!Array.isArray(timeline) || timeline.length === 0) {
      el.timeline.innerHTML = `<div class="text-center py-10 text-slate-500">No events found in timeline.</div>`;
      return;
    }

    const sorted = [...timeline].sort((a, b) => (parseInt(b.created_at || "0", 10) - parseInt(a.created_at || "0", 10)));

    sorted.forEach((item, index) => {
      const sum = buildEventSummary(item);
      const s3Key = get(item, "s3_key", "");
      const photoUrl = isNonEmpty(s3Key) ? (photoUrlByKey.get(s3Key) || "") : "";

      // Wrapper
      const wrapper = document.createElement("div");
      wrapper.className = "relative pl-8 group animate-[pulse-slow_0.5s_ease-out]";
      wrapper.style.animationDelay = `${index * 100}ms`;

      // Dot on timeline
      const dot = document.createElement("div");
      dot.className = "absolute left-[13px] top-6 w-4 h-4 rounded-full bg-slate-900 border-2 border-slate-600 group-hover:border-orange-500 group-hover:bg-orange-900 transition-colors z-10";
      wrapper.appendChild(dot);

      // Card
      const card = document.createElement("div");
      card.className = "glass-card rounded-xl p-5 hover:bg-slate-800/80 transition-all cursor-pointer group-hover:translate-x-1 duration-300";

      // Header
      const header = document.createElement("div");
      header.className = "flex items-start justify-between gap-4";
      
      const titleBlock = document.createElement("div");
      titleBlock.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="text-orange-500 bg-orange-500/10 p-1.5 rounded-md text-xs"><i class="fa-solid ${sum.icon}"></i></span>
          <h3 class="font-bold text-white text-lg leading-tight">${sum.title}</h3>
        </div>
        ${sum.subtitle ? `<p class="text-slate-400 text-sm">${sum.subtitle}</p>` : ''}
      `;
      
      header.appendChild(titleBlock);
      card.appendChild(header);

      // Highlights grid
      if(sum.highlights.length > 0) {
        const grid = document.createElement("div");
        grid.className = "mt-4 grid grid-cols-2 gap-2";
        sum.highlights.forEach(([k,v]) => {
          grid.innerHTML += `
            <div class="bg-slate-950/30 rounded px-3 py-2 border border-slate-800">
              <div class="text-[10px] uppercase text-slate-500">${k}</div>
              <div class="text-sm font-medium text-slate-200 truncate">${v}</div>
            </div>
          `;
        });
        card.appendChild(grid);
      }

      // Footer & Image Row
      const footerRow = document.createElement("div");
      footerRow.className = "mt-4 pt-3 border-t border-slate-800 flex items-center justify-between";
      
      const locText = document.createElement("div");
      locText.className = "text-xs text-slate-500 font-mono";
      locText.innerHTML = sum.footer.join(" &bull; ");
      footerRow.appendChild(locText);

      // Mini Thumb if avail
      if (isNonEmpty(photoUrl)) {
        const thumb = document.createElement("img");
        setImgSrcWithRetry(thumb, getBestThumbUrl(item, photoUrl));
        thumb.className = "w-10 h-10 rounded-lg object-cover border border-slate-600 ml-3";
        footerRow.appendChild(thumb);
      } else {
        footerRow.innerHTML += `<span class="text-xs text-slate-600 italic">No image</span>`;
      }

      card.appendChild(footerRow);

      // Click Event
      card.addEventListener("click", () => {
        const body = document.createElement("div");
        
        // Hero Image in Modal
        if (isNonEmpty(photoUrl)) {
          const imgCont = document.createElement("div");
          imgCont.className = "mb-6 relative group rounded-xl overflow-hidden bg-black";
          const img = document.createElement("img");
          setImgSrcWithRetry(img, getBestThumbUrl(item, photoUrl)); // Load low quality first
          // Swap to high quality if possible or just use url
          img.src = photoUrl;
          img.className = "w-full h-auto max-h-[400px] object-contain mx-auto";
          
          const dlBtn = document.createElement("a");
          dlBtn.href = photoUrl;
          dlBtn.download = "";
          dlBtn.className = "absolute bottom-3 right-3 bg-white text-black px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg hover:bg-gray-200 transition-colors opacity-0 group-hover:opacity-100";
          dlBtn.innerHTML = '<i class="fa-solid fa-download mr-1"></i> Save';

          imgCont.appendChild(img);
          imgCont.appendChild(dlBtn);
          body.appendChild(imgCont);
        }

        body.appendChild(makeKVTable(sum.details));
        modal.open(sum.title, body);
      });

      wrapper.appendChild(card);
      el.timeline.appendChild(wrapper);
    });
  }

  // --------- Render Photos (New Design) ----------
  function renderPhotos(photoUrls, timeline) {
    if (!el.photosSection || !el.photosGrid) return;
    el.photosGrid.innerHTML = "";

    if (!Array.isArray(photoUrls) || photoUrls.length === 0) {
      el.photosSection.classList.add("hidden");
      return;
    }

    // De-dupe and map
    const byKey = new Map();
    photoUrls.forEach((u) => {
      const k = parseS3KeyFromUrl(u);
      if (isNonEmpty(k) && !byKey.has(k)) byKey.set(k, u);
    });

    // Map keys to Titles
    const labelByKey = new Map();
    (timeline || []).forEach((t) => {
      if (isNonEmpty(t.s3_key)) labelByKey.set(t.s3_key, buildEventSummary(t).title);
    });

    el.photosSection.classList.remove("hidden");

    Array.from(byKey.entries()).forEach(([k, url], idx) => {
      const wrapper = document.createElement("div");
      wrapper.className = "group relative aspect-square rounded-xl overflow-hidden bg-slate-900 border border-slate-700 cursor-pointer";
      
      const img = document.createElement("img");
      setImgSrcWithRetry(img, url);
      img.loading = "lazy";
      img.className = "w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-80 group-hover:opacity-100";
      
      const overlay = document.createElement("div");
      overlay.className = "absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3";
      
      const txt = document.createElement("div");
      txt.className = "text-white text-xs font-medium truncate";
      txt.textContent = labelByKey.get(k) || "Event Photo";
      
      overlay.appendChild(txt);
      wrapper.appendChild(img);
      wrapper.appendChild(overlay);

      wrapper.addEventListener("click", () => {
        const body = document.createElement("div");
        const lgImg = document.createElement("img");
        lgImg.src = url;
        lgImg.className = "w-full rounded-lg mb-4";
        
        const dlBtn = document.createElement("a");
        dlBtn.href = url;
        dlBtn.download = "";
        dlBtn.className = "w-full block text-center bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-xl font-bold transition-colors";
        dlBtn.textContent = "Download High Res";

        body.appendChild(lgImg);
        body.appendChild(dlBtn);
        modal.open(labelByKey.get(k) || "Photo Preview", body);
      });

      el.photosGrid.appendChild(wrapper);
    });
  }

  // --------- API Logic (UNCHANGED) ----------
  async function createThumbnailDataUrl(file, maxSize = 360, quality = 0.75) {
    return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
            const img = new Image();
            img.onload = () => {
                const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
                const w = Math.max(1, Math.round(img.width * scale));
                const h = Math.max(1, Math.round(img.height * scale));
                const canvas = document.createElement("canvas");
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL("image/jpeg", quality));
            };
            img.onerror = reject;
            img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
    });
  }

  async function apiCall(action, payload, tokenOpt) {
    const isPublic = !!tokenOpt;
    const url = isPublic ? `${BASE_URL}/political/public/search` : `${BASE_URL}/political/search`;
    const body = { action, payload: payload || {} };
    if (isPublic) body.token = tokenOpt;
    const headers = { "Content-Type": "application/json" };
    if (!isPublic) {
      const idToken = localStorage.getItem("id_token") || localStorage.getItem("idToken") || "";
      if (idToken) headers["Authorization"] = `Bearer ${idToken}`;
    }
    const resp = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
    const txt = await resp.text();
    let json = {};
    try { json = JSON.parse(txt); } catch (e) { json = { message: txt || "Invalid JSON" }; }
    if (!resp.ok) throw new Error(json.message || `HTTP ${resp.status}`);
    return json;
  }

  // --------- Main Events ----------
  if (el.searchBtn) {
    el.searchBtn.addEventListener("click", async () => {
      const file = el.selfieInput && el.selfieInput.files && el.selfieInput.files[0];
      if (!file) {
        setStatus("कृपया पहले फोटो चुनें (Please select a photo)", "error");
        return;
      }

      // Reset UI
      el.searchBtn.disabled = true;
      el.searchBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';
      setStatus("Initializing Secure Upload...", "loading");
      el.statsDashboard.classList.add("hidden");
      el.resultsContainer.classList.add("hidden");

      try {
        // 1. Init
        const init = await apiCall("init_search", { mime_type: file.type || "image/jpeg" }, token);
        const uploadUrl = init.upload_url || init.url;
        const searchId = init.search_id || init.searchId;
        
        // 2. Upload
        setStatus("Uploading Image to Cloud...", "loading");
        await fetch(uploadUrl, { method: "PUT", body: file, headers: { "Content-Type": file.type } });

        // 3. Search
        setStatus("AI Running Facial Recognition...", "loading");
        const res = await apiCall("run_search", { search_id: searchId }, token);

        const sim = isNonEmpty(res.similarity) ? Number(res.similarity).toFixed(0) : "0";
        const tCount = Array.isArray(res.timeline) ? res.timeline.length : 0;
        const pCount = Array.isArray(res.photo_urls) ? res.photo_urls.length : 0;

        if (res.message === "NO_MATCH" || tCount === 0) {
          setStatus("No Match Found in Database", "error");
          el.emptyState.classList.remove("hidden");
          el.emptyState.querySelector("h3").textContent = "No Matches Found";
          el.emptyState.querySelector("p").textContent = "The uploaded face does not match any records in our Karyakarta database.";
        } else {
          setStatus("Search Complete", "success");
          
          // Populate Dashboard
          updateDashboard(sim, tCount, pCount);

          // Populate Lists
          const photoUrlByKey = new Map();
          (res.photo_urls || []).forEach((u) => {
            const k = parseS3KeyFromUrl(u);
            if (isNonEmpty(k)) photoUrlByKey.set(k, u);
          });

          renderTimeline(res.timeline || [], photoUrlByKey);
          renderPhotos(res.photo_urls || [], res.timeline || []);
          
          // Scroll to results on mobile
          if(window.innerWidth < 1024) {
             el.statsDashboard.scrollIntoView({ behavior: 'smooth' });
          }
        }

      } catch (err) {
        console.error(err);
        setStatus(err.message || "Connection Error", "error");
      } finally {
        el.searchBtn.disabled = false;
        el.searchBtn.innerHTML = '<span class="relative flex items-center justify-center gap-2"><i class="fa-solid fa-magnifying-glass"></i> Search Database</span>';
      }
    });
  }
})();
</script>
</body>
</html>
