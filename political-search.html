<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karyakarta Search - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script>

  // --- Image helpers (preview + resilient loading) ---
  function previewImage(inputEl) {
    // Backward compatible: some versions had onchange="previewImage(this)"
    try {
      const file = inputEl && inputEl.files && inputEl.files[0];
      const preview = document.getElementById("preview");
      if (!preview) return;
      if (!file) {
        preview.src = "";
        preview.classList.add("hidden");
        return;
      }
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.classList.remove("hidden");
    } catch (e) {
      // ignore
    }
  }

  function setImgSrcWithRetry(imgEl, url, maxRetries = 2) {
    if (!imgEl) return;
    let attempt = 0;
    imgEl.referrerPolicy = "no-referrer";

    const load = () => { imgEl.src = url; };

    imgEl.onerror = () => {
      if (attempt < maxRetries) {
        attempt += 1;
        const delay = 350 * attempt;
        setTimeout(load, delay);
        return;
      }
      imgEl.classList.add("opacity-60");
      imgEl.title = "Image load failed. Click to retry.";
      imgEl.style.cursor = "pointer";
      imgEl.onclick = () => {
        imgEl.classList.remove("opacity-60");
        imgEl.title = "";
        imgEl.style.cursor = "";
        imgEl.onclick = null;
        attempt = 0;
        load();
      };
    };

    load();
  }

  function getBestThumbUrl(obj, fallbackUrl) {
    if (!obj) return fallbackUrl;
    return obj.thumb_url || obj.thumbUrl || obj.thumbnail_url || obj.thumbnailUrl || fallbackUrl;
  }
</script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }, colors: { brand: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c' } } } } }</script>
  <style>
    body { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.15), transparent 40%), radial-gradient(circle at bottom right, rgba(234, 88, 12, 0.10), transparent 40%), #020617; color: #e2e8f0; }
    .glass { background: rgba(30,41,59,0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
    .animate-spin-slow { animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="glass rounded-2xl p-6 mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4 shadow-xl border-t-2 border-orange-500/50">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center text-orange-400"><i class="fa-solid fa-magnifying-glass-chart text-xl"></i></div>
        <div><h1 class="text-2xl font-extrabold text-white">Karyakarta Search</h1><p class="text-slate-400 text-sm">EventLens Political Module</p></div>
      </div>
      <div class="text-right hidden md:block"><div class="text-xs font-mono text-slate-500" id="tokenDisplay">Token: Checking...</div></div>
    </div>

    <div class="grid md:grid-cols-12 gap-6">
      <!-- Sidebar -->
      <div class="md:col-span-4 space-y-6">
        <div class="glass rounded-2xl p-6 shadow-lg border-l-4 border-orange-500">
          <h2 class="font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-camera"></i> 1. Search by Selfie</h2>
          <div class="relative group cursor-pointer mb-4">
            <input id="selfieInput" accept="image/*" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
            <div id="uploadBox" class="h-48 border-2 border-dashed border-slate-600 rounded-xl flex flex-col items-center justify-center bg-slate-800/50 group-hover:border-orange-500 transition-colors">
              <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i><span class="text-sm text-slate-400">Tap to upload image</span>
            </div>
            <img id="preview" class="hidden h-48 w-full object-cover rounded-xl border border-slate-600" />
          </div>
          <button id="searchBtn" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold shadow-lg shadow-orange-500/25 transition-all active:scale-95 flex items-center justify-center gap-2">
            <span>Search Database</span> <i class="fa-solid fa-search"></i>
          </button>
          <div id="statusBox" class="hidden mt-4 p-3 rounded-lg text-sm text-center"></div>
        </div>
      </div>

      <!-- Results -->
      <div class="md:col-span-8">
        <div class="glass rounded-2xl p-6 shadow-lg min-h-[400px]">
          <div class="flex items-center justify-between mb-6 border-b border-slate-700 pb-4">
             <h2 class="font-bold text-xl text-white flex items-center gap-2"><i class="fa-solid fa-timeline"></i> Result Timeline</h2>
             <span id="matchScore" class="text-sm font-mono text-slate-400"></span>
          </div>

          <!-- Filters -->
          <div class="flex flex-col md:flex-row gap-3 mb-4">
            <div class="flex-1 min-w-[180px]">
              <label class="block text-xs text-slate-400 mb-1">फॉर्म टाइप</label>
              <select id="formFilter" class="w-full bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                <option value="all">All Forms</option>
              </select>
            </div>
            <div class="flex-[2] min-w-[220px]">
              <label class="block text-xs text-slate-400 mb-1">कीवर्ड</label>
              <input id="keywordFilter" type="text" placeholder="नाम / मोबाइल / जिला / कार्यक्रम / अतिथि / स्थान..." class="w-full bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white placeholder:text-slate-500" />
            </div>
            <div class="min-w-[180px]">
              <label class="block text-xs text-slate-400 mb-1">Sort</label>
              <select id="sortOrder" class="w-full bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                <option value="desc">Newest first</option>
                <option value="asc">Oldest first</option>
              </select>
            </div>
            <div class="min-w-[140px] flex items-end">
              <button id="clearFilters" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                Clear
              </button>
            </div>
          </div>

          <div id="statsBar" class="text-xs text-slate-400 mb-4"></div>

          <div id="timeline" class="space-y-4">
             <div class="text-center py-10 text-slate-500"><i class="fa-regular fa-image text-4xl mb-3 opacity-50"></i><p>Upload a selfie to view history.</p></div>
          </div>
          
<div id="photosSection" class="hidden mt-8 pt-6 border-t border-slate-700">
  <div class="flex items-center justify-between gap-3 mb-2">
    <h3 class="font-bold text-white flex items-center gap-2">
      <i class="fa-regular fa-images"></i>
      कार्यकर्त्ता की सभी फोटो
    </h3>
    <button id="loadAllPhotosBtn" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl px-3 py-2 text-xs text-white">
      Load thumbnails
    </button>
  </div>
  <div class="text-xs text-slate-400 mb-4">
    नोट: फोटो URLs (लिंक) 10 मिनट में expire होते हैं। अगर कुछ फोटो नहीं खुलें, तो “Search” फिर से करिए।
    बहुत सारी फोटो एक साथ load करने से कभी‑कभी नेटवर्क error (ERR_CONNECTION_RESET) आता है, इसलिए thumbnails group‑wise load होते हैं।
  </div>

  <div id="photosGroups" class="space-y-4"></div>
  <div id="photosGrid" class="hidden grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
</div>

        </div>
      </div>
    </div>
  </div>

<script>
/**
 * EventLens Political Search (Updated)
 * - Timeline cards show: program/venue/date/time/guests + district/vidhansabha/mandal
 * - Click any event card to open full details (and download photo)
 * - Photos section shows ALL photos returned by API (with program names) + download
 * - Selfie thumbnail preview (client-side) for fast UI
 *
 * NOTE: True bandwidth/billing saving thumbnails require backend to store separate thumb files.
 */
(() => {
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;

  const qs = new URLSearchParams(window.location.search);
  const token = qs.get("token") || "";   // Public link token (recommended)

  const el = {
    selfieInput: document.getElementById("selfieInput"),
    preview: document.getElementById("preview"),
    statusBox: document.getElementById("statusBox"),
    matchScore: document.getElementById("matchScore"),
    timeline: document.getElementById("timeline"),
    photosSection: document.getElementById("photosSection"),
    photosGrid: document.getElementById("photosGrid"),
    searchBtn: document.getElementById("searchBtn"),

    formFilter: document.getElementById("formFilter"),
    keywordFilter: document.getElementById("keywordFilter"),
    sortOrder: document.getElementById("sortOrder"),
    clearFilters: document.getElementById("clearFilters"),
    statsBar: document.getElementById("statsBar"),
    photosGroups: document.getElementById("photosGroups"),
    loadAllPhotosBtn: document.getElementById("loadAllPhotosBtn"),

  };

  // --------- UI State ----------
  const STATE = {
    rawTimeline: [],
    rawPhotoUrls: [],
    photoUrlByKey: new Map(),
    filters: { form: "all", q: "", sort: "desc" },
    photoGroups: [],        // built from rawTimeline
    loadedGroups: new Set() // groupKey strings
  };

  function debounce(fn, wait = 250) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  function safeLower(x) {
    return (x == null ? "" : String(x)).toLowerCase();
  }

  function buildSearchText(entry) {
    const parts = [];
    const push = (v) => { if (v != null && String(v).trim() !== "") parts.push(String(v)); };

    push(entry.form_type);
    push(entry.name); push(entry.mobile);
    push(entry.district); push(entry.vidhansabha); push(entry.mandal);
    push(entry.reason);

    // Common fields inside data
    const d = entry.data || {};
    Object.keys(d).forEach((k) => push(d[k]));

    // Normalize by joining
    return safeLower(parts.join(" | "));
  }

  function initFiltersFromTimeline(timeline) {
    if (!el.formFilter) return;
    const prev = el.formFilter.value || "all";
    const types = Array.from(new Set((timeline || []).map(x => x.form_type).filter(Boolean))).sort();

    // Rebuild options
    el.formFilter.innerHTML = `<option value="all">All Forms</option>` + types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    // restore
    if (types.includes(prev)) el.formFilter.value = prev;
    else el.formFilter.value = "all";
  }

  function getFilteredTimeline() {
    let t = Array.isArray(STATE.rawTimeline) ? [...STATE.rawTimeline] : [];
    const f = STATE.filters;

    if (f.form && f.form !== "all") {
      t = t.filter(x => x.form_type === f.form);
    }
    if (f.q && f.q.trim() !== "") {
      const q = safeLower(f.q.trim());
      t = t.filter(x => buildSearchText(x).includes(q));
    }

    // sort by created_at
    t.sort((a,b) => {
      const av = Number(a.created_at || 0);
      const bv = Number(b.created_at || 0);
      return f.sort === "asc" ? (av - bv) : (bv - av);
    });

    return t;
  }

  function updateStatsBar(filteredTimeline) {
    if (!el.statsBar) return;
    const raw = STATE.rawTimeline || [];
    const shown = filteredTimeline || [];

    const uniqueForms = new Set(raw.map(x => x.form_type || "")).size;
    const uniquePhotos = new Set(raw.map(x => x.s3_key || "").filter(Boolean)).size;

    el.statsBar.innerHTML =
      `Events: <b class="text-slate-200">${shown.length}</b> / ${raw.length} &nbsp; | &nbsp; ` +
      `Forms: ${uniqueForms} &nbsp; | &nbsp; Photos: ${uniquePhotos}`;
  }

  function applyFiltersAndRender() {
    const filtered = getFilteredTimeline();
    updateStatsBar(filtered);

    renderTimeline(filtered, STATE.photoUrlByKey);

    // Photos हमेशा "पूरा timeline" से (filter नहीं) ताकि सभी uploads दिखें
    renderPhotosGrouped(STATE.rawTimeline, STATE.photoUrlByKey);
  }



  // --------- Modal (details / full photo) ----------
  const modal = (() => {
    const wrap = document.createElement("div");
    wrap.id = "detailModal";
    wrap.className = "fixed inset-0 z-50 hidden";
    wrap.innerHTML = `
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-slate-900 border border-slate-700 rounded-2xl shadow-xl overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 border-b border-slate-700">
            <div class="font-semibold text-white" id="detailModalTitle">Details</div>
            <button id="detailModalClose" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Close</button>
          </div>
          <div class="p-5 max-h-[75vh] overflow-auto" id="detailModalBody"></div>
        </div>
      </div>
    `;
    document.body.appendChild(wrap);

    const titleEl = wrap.querySelector("#detailModalTitle");
    const bodyEl = wrap.querySelector("#detailModalBody");

    function open(title, bodyNode) {
      titleEl.textContent = title || "Details";
      bodyEl.innerHTML = "";
      if (bodyNode) bodyEl.appendChild(bodyNode);
      wrap.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    }
    function close() {
      wrap.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }

    wrap.querySelector("#detailModalClose").addEventListener("click", close);
    wrap.addEventListener("click", (e) => {
      if (e.target === wrap.firstElementChild) close();
    });

    return { open, close };
  })();

  // --------- UI Helpers ----------
  function isNonEmpty(v) { return v !== null && v !== undefined && String(v).trim() !== ""; }
  function prettyIso(iso) {
    if (!isNonEmpty(iso)) return "";
    return String(iso).replace("T", " ").replace(/\.\d+/, "").replace("+00:00", " UTC");
  }
  function setStatus(msg, type = "info") {
    if (!el.statusBox) return;
    el.statusBox.textContent = msg || "";
    el.statusBox.className = "p-3 rounded-lg text-sm border " + (
      type === "error"
        ? "bg-red-900/20 border-red-700 text-red-200"
        : type === "success"
          ? "bg-emerald-900/20 border-emerald-700 text-emerald-200"
          : "bg-slate-900/40 border-slate-700 text-slate-200"
    );
  }
  function setMatch(text) {
    if (!el.matchScore) return;
    el.matchScore.textContent = text || "";
  }

  function makeBadge(text, kind = "blue") {
    const span = document.createElement("span");
    const base = "inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border";
    const map = {
      blue: "bg-blue-900/30 text-blue-200 border-blue-700",
      yellow: "bg-yellow-900/30 text-yellow-200 border-yellow-700",
      gray: "bg-slate-800 text-slate-200 border-slate-700",
      red: "bg-red-900/30 text-red-200 border-red-700",
      green: "bg-emerald-900/30 text-emerald-200 border-emerald-700",
      purple: "bg-purple-900/30 text-purple-200 border-purple-700",
    };
    span.className = base + " " + (map[kind] || map.gray);
    span.textContent = text;
    return span;
  }

  function get(obj, key, fallback = "") {
    if (!obj) return fallback;
    const v = obj[key];
    return isNonEmpty(v) ? v : fallback;
  }

  // --------- Build event summary ----------
  function buildEventSummary(item) {
    const form = get(item, "form_type", "");
    const data = item.data || {};

    const district = get(item, "district", get(data, "district", ""));
    const vidhansabha = get(item, "vidhansabha", get(data, "vidhansabha", ""));
    const mandal = get(item, "mandal", get(data, "mandal", ""));
    const createdAtIso = prettyIso(get(item, "created_at_iso", ""));

    let title = form || "Event";
    let subtitle = "";
    const highlights = []; // key->value lines for card
    const footer = [];     // small gray lines

    if (form === "president_tour_form") {
      title = get(data, "program_name", get(data, "program_type", "President Tour"));
      const date = get(data, "tour_date", "");
      const time = get(data, "tour_time", "");
      const venue = get(data, "tour_venue", "");
      subtitle = [date, time, venue].filter(isNonEmpty).join(" • ");
      const guests = get(data, "guests", "");
      const level = get(data, "level", "");
      const attendance = get(data, "attendance", "");
      if (isNonEmpty(guests)) highlights.push(["अतिथि", guests]);
      if (isNonEmpty(level)) highlights.push(["Level", level]);
      if (isNonEmpty(attendance)) highlights.push(["Attendance", attendance]);
    } else if (form === "mandal_reporting") {
      title = get(data, "venue", "Mandal Report");
      const date = get(data, "event_date", "");
      const time = get(data, "event_time", "");
      subtitle = [date, time].filter(isNonEmpty).join(" • ");
      const guests = get(data, "guests", "");
      const level = get(data, "level", "");
      const attendance = get(data, "attendance", "");
      if (isNonEmpty(guests)) highlights.push(["अतिथि", guests]);
      if (isNonEmpty(level)) highlights.push(["Level", level]);
      if (isNonEmpty(attendance)) highlights.push(["Attendance", attendance]);
    } else if (form === "visitor_form") {
      title = get(item, "name", get(data, "name", "Visitor"));
      subtitle = [get(item, "mobile", get(data, "mobile", "")), get(data, "reason", "")].filter(isNonEmpty).join(" • ");
    } else if (form === "party_attendance") {
      title = get(item, "name", get(data, "name", "Party Attendance"));
      subtitle = [get(data, "designation", ""), get(item, "mobile", get(data, "mobile", ""))].filter(isNonEmpty).join(" • ");
    } else {
      // fallback
      title = form || "Event";
      subtitle = [get(item, "name", ""), get(item, "mobile", "")].filter(isNonEmpty).join(" • ");
    }

    const locBits = [];
    if (isNonEmpty(district)) locBits.push(`District: ${district}`);
    if (isNonEmpty(vidhansabha)) locBits.push(`Vidhansabha: ${vidhansabha}`);
    if (isNonEmpty(mandal)) locBits.push(`Mandal: ${mandal}`);
    if (locBits.length) footer.push(locBits.join(" • "));
    if (isNonEmpty(createdAtIso)) footer.push(`Created: ${createdAtIso}`);

    // details for modal
    const details = [];
    const pushD = (k, v) => { if (isNonEmpty(v)) details.push([k, String(v)]); };

    pushD("Form Type", form);
    pushD("Entry ID", get(item, "entry_id", ""));
    pushD("Created", createdAtIso);
    pushD("District", district);
    pushD("Vidhansabha", vidhansabha);
    pushD("Mandal", mandal);
    pushD("S3 Key", get(item, "s3_key", ""));

    const addIf = (label, key) => pushD(label, get(data, key, ""));
    if (form === "president_tour_form") {
      addIf("Program Name", "program_name");
      addIf("Program Type", "program_type");
      addIf("Tour Date", "tour_date");
      addIf("Tour Time", "tour_time");
      addIf("Venue", "tour_venue");
      addIf("Guests", "guests");
      addIf("Level", "level");
      addIf("Attendance", "attendance");
    } else if (form === "mandal_reporting") {
      addIf("Venue", "venue");
      addIf("Event Date", "event_date");
      addIf("Event Time", "event_time");
      addIf("Guests", "guests");
      addIf("Level", "level");
      addIf("Attendance", "attendance");
    } else if (form === "visitor_form") {
      addIf("Reason", "reason");
      addIf("Address", "address");
      addIf("Designation", "designation");
    } else if (form === "party_attendance") {
      addIf("Designation", "designation");
    }

    return { title, subtitle, highlights, footer, details, rawData: data };
  }

  function makeKVTable(rows) {
    const table = document.createElement("table");
    table.className = "w-full text-sm";
    rows.forEach(([k, v]) => {
      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-800 last:border-b-0";
      const tdK = document.createElement("td");
      tdK.className = "py-2 pr-4 font-medium text-slate-300 align-top w-44";
      tdK.textContent = k;
      const tdV = document.createElement("td");
      tdV.className = "py-2 text-white whitespace-pre-wrap";
      tdV.textContent = isNonEmpty(v) ? String(v) : "-";
      tr.appendChild(tdK);
      tr.appendChild(tdV);
      table.appendChild(tr);
    });
    return table;
  }

  function parseS3KeyFromUrl(url) {
    try {
      const u = new URL(url);
      const p = u.pathname || "";
      return p.startsWith("/") ? p.slice(1) : p;
    } catch (e) {
      return "";
    }
  }

  // --------- Render Timeline ----------
  function renderTimeline(timeline, photoUrlByKey) {
    if (!el.timeline) return;
    el.timeline.innerHTML = "";

    if (!Array.isArray(timeline) || timeline.length === 0) {
      el.timeline.innerHTML = `<div class="text-slate-300 text-sm">No timeline entries.</div>`;
      return;
    }

    const sorted = [...timeline].sort((a, b) => (parseInt(b.created_at || "0", 10) - parseInt(a.created_at || "0", 10)));

    sorted.forEach((item) => {
      const sum = buildEventSummary(item);
      const entry = item; // alias for older code paths
      const s3Key = get(item, "s3_key", "");
      const photoUrl = isNonEmpty(s3Key) ? (photoUrlByKey.get(s3Key) || "") : "";

      const card = document.createElement("div");
      card.className = "p-4 rounded-xl border border-slate-700 bg-slate-900/40 hover:bg-slate-900/60 transition cursor-pointer";

      const top = document.createElement("div");
      top.className = "flex items-start justify-between gap-3";

      const left = document.createElement("div");
      const t = document.createElement("div");
      t.className = "text-white font-semibold text-base";
      t.textContent = sum.title;

      const st = document.createElement("div");
      st.className = "text-slate-300 text-sm mt-0.5";
      st.textContent = sum.subtitle || "";

      left.appendChild(t);
      if (isNonEmpty(sum.subtitle)) left.appendChild(st);

      const right = document.createElement("div");
      right.className = "flex flex-wrap items-center gap-2 justify-end";
      right.appendChild(makeBadge(item.form_type || "event", "blue"));
      if (item.duplicate) right.appendChild(makeBadge("DUPLICATE", "yellow"));

      top.appendChild(left);
      top.appendChild(right);

      const mid = document.createElement("div");
      mid.className = "mt-3 space-y-1";
      sum.highlights.forEach(([k, v]) => {
        const row = document.createElement("div");
        row.className = "text-sm";
        const kk = document.createElement("span");
        kk.className = "text-slate-300 font-medium";
        kk.textContent = `${k}: `;
        const vv = document.createElement("span");
        vv.className = "text-white whitespace-pre-wrap";
        vv.textContent = String(v);
        row.appendChild(kk);
        row.appendChild(vv);
        mid.appendChild(row);
      });

      const bottom = document.createElement("div");
      bottom.className = "mt-3 text-xs text-slate-400 space-y-1";
      sum.footer.forEach((line) => {
        const d = document.createElement("div");
        d.textContent = line;
        bottom.appendChild(d);
      });

      if (isNonEmpty(photoUrl)) {
        const imgRow = document.createElement("div");
        imgRow.className = "mt-4 flex items-center gap-3";
        const img = document.createElement("img");
        setImgSrcWithRetry(img, getBestThumbUrl(entry, photoUrl));
        img.loading = "lazy";
        img.decoding = "async";
        img.className = "w-16 h-16 rounded-lg object-cover border border-slate-700";
        img.alt = "event photo";
        const tip = document.createElement("div");
        tip.className = "text-xs text-slate-400";
        tip.textContent = "Click to open details";
        imgRow.appendChild(img);
        imgRow.appendChild(tip);
        card.appendChild(imgRow);
      }

      card.appendChild(top);
      if (sum.highlights.length) card.appendChild(mid);
      card.appendChild(bottom);

      card.addEventListener("click", () => {
        const body = document.createElement("div");
        body.className = "space-y-4";

        if (isNonEmpty(photoUrl)) {
          const ph = document.createElement("div");
          ph.className = "space-y-2";
          const img = document.createElement("img");
          setImgSrcWithRetry(img, getBestThumbUrl(entry, photoUrl));
          img.loading = "lazy";
          img.decoding = "async";
          img.className = "w-full max-h-[420px] object-contain rounded-xl border border-slate-700 bg-slate-950";
          const dl = document.createElement("a");
          dl.href = photoUrl;
          dl.textContent = "Download photo";
          dl.className = "inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white w-fit";
          dl.setAttribute("download", "");
          ph.appendChild(img);
          ph.appendChild(dl);
          body.appendChild(ph);
        }

        body.appendChild(makeKVTable(sum.details));

        const raw = document.createElement("details");
        raw.className = "bg-slate-950/60 rounded-xl border border-slate-700 p-3";
        const sm = document.createElement("summary");
        sm.className = "cursor-pointer text-slate-300 font-medium";
        sm.textContent = "Raw data (JSON)";
        const pre = document.createElement("pre");
        pre.className = "mt-3 text-xs text-slate-200 overflow-auto";
        pre.textContent = JSON.stringify(sum.rawData || {}, null, 2);
        raw.appendChild(sm);
        raw.appendChild(pre);
        body.appendChild(raw);

        modal.open(sum.title, body);
      });

      el.timeline.appendChild(card);
    });
  }

  // --------- Render Photos ----------
  function renderPhotos(photoUrls, timeline) {
    if (!el.photosSection || !el.photosGrid) return;

    el.photosGrid.innerHTML = "";

    if (!Array.isArray(photoUrls) || photoUrls.length === 0) {
      el.photosSection.classList.add("hidden");
      return;
    }

    // Add toggle button once
    const header = el.photosSection.querySelector("h3");
    if (header && !header.dataset.toggleAdded) {
      const btn = document.createElement("button");
      btn.className = "ml-auto px-3 py-1 rounded-lg text-xs bg-slate-800 hover:bg-slate-700 text-slate-100 border border-slate-700";
      btn.textContent = "Hide";
      btn.addEventListener("click", () => {
        const hidden = el.photosGrid.classList.toggle("hidden");
        btn.textContent = hidden ? "Show" : "Hide";
      });
      header.className = "flex items-center gap-3";
      header.appendChild(btn);
      header.dataset.toggleAdded = "1";
    }

    // Key->URL unique
    const byKey = new Map();
    photoUrls.forEach((u) => {
      const k = parseS3KeyFromUrl(u);
      if (isNonEmpty(k) && !byKey.has(k)) byKey.set(k, u);
    });

    // labels by key from timeline
    const labelByKey = new Map();
    (timeline || []).forEach((t) => {
      if (isNonEmpty(t.s3_key)) {
        const sum = buildEventSummary(t);
        labelByKey.set(t.s3_key, sum.title);
      }
    });

    const entries = Array.from(byKey.entries()); // [key, url]

    entries.forEach(([k, url]) => {
      const card = document.createElement("div");
      card.className = "rounded-xl overflow-hidden border border-slate-700 bg-slate-900/40 hover:bg-slate-900/60 transition cursor-pointer";

      const img = document.createElement("img");
      setImgSrcWithRetry(img, url);
      img.loading = "lazy";
      img.decoding = "async";
      img.className = "w-full h-32 object-cover bg-slate-950";
      img.alt = "photo";

      const cap = document.createElement("div");
      cap.className = "p-2 text-xs text-slate-200";
      cap.textContent = labelByKey.get(k) || "Photo";

      card.appendChild(img);
      card.appendChild(cap);

      card.addEventListener("click", () => {
        const body = document.createElement("div");
        body.className = "space-y-3";

        const photo = document.createElement("img");
        photo.src = url;
        photo.loading = "lazy";
        photo.decoding = "async";
        photo.className = "w-full max-h-[520px] object-contain rounded-xl border border-slate-700 bg-slate-950";

        const dl = document.createElement("a");
        dl.href = url;
        dl.textContent = "Download photo";
        dl.className = "inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white w-fit";
        dl.setAttribute("download", "");

        const meta = document.createElement("div");
        meta.className = "text-xs text-slate-400 break-all";
        meta.textContent = k;

        body.appendChild(photo);
        body.appendChild(dl);
        body.appendChild(meta);

        modal.open(labelByKey.get(k) || "Photo", body);
      });

      el.photosGrid.appendChild(card);
    });

    el.photosSection.classList.remove("hidden");
  }


  // --------- Render Photos (Grouped + Lazy thumbnails) ----------
  let _lazyObserver = null;
  function getLazyObserver() {
    if (_lazyObserver) return _lazyObserver;
    if (!("IntersectionObserver" in window)) return null;
    _lazyObserver = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (!e.isIntersecting) return;
        const img = e.target;
        const url = img.dataset.src;
        if (url) {
          setImgSrcWithRetry(img, url, 3);
          img.removeAttribute("data-src");
        }
        _lazyObserver.unobserve(img);
      });
    }, { root: null, rootMargin: "220px", threshold: 0.01 });
    return _lazyObserver;
  }

  function cssEscape(v) {
    const s = String(v == null ? "" : v);
    if (window.CSS && typeof window.CSS.escape === "function") return window.CSS.escape(s);
    return s.replace(/[^a-zA-Z0-9_\-]/g, (ch) => "\" + ch);
  }

  function attachLazyImg(img, url) {
    img.dataset.src = url;
    const obs = getLazyObserver();
    if (obs) obs.observe(img);
    else setImgSrcWithRetry(img, url, 3);
  }

  function renderPhotosGrouped(timeline, photoUrlByKey) {
    if (!el.photosSection || !el.photosGroups) return;

    const tl = Array.isArray(timeline) ? timeline : [];
    const items = tl
      .filter(e => e && e.s3_key && photoUrlByKey && photoUrlByKey.has(e.s3_key))
      .map(e => ({ entry: e, url: photoUrlByKey.get(e.s3_key) }));

    if (items.length === 0) {
      el.photosSection.classList.add("hidden");
      el.photosGroups.innerHTML = "";
      return;
    }

    el.photosSection.classList.remove("hidden");

    const groups = new Map();
    items.forEach(({ entry, url }) => {
      const sum = buildEventSummary(entry);
      const gTitle = sum.title || "Event";
      const gKey = `${entry.form_type || "form"}::${gTitle}`;

      if (!groups.has(gKey)) {
        groups.set(gKey, {
          key: gKey,
          form_type: entry.form_type || "",
          title: gTitle,
          subtitle: sum.subtitle || "",
          footer: sum.footer || "",
          highlights: Array.isArray(sum.highlights) ? sum.highlights : [],
          maxCreatedAt: Number(entry.created_at || 0),
          items: []
        });
      }
      const g = groups.get(gKey);
      g.items.push({ entry, url, sum });
      g.maxCreatedAt = Math.max(g.maxCreatedAt, Number(entry.created_at || 0));
    });

    const groupList = Array.from(groups.values()).sort((a, b) => b.maxCreatedAt - a.maxCreatedAt);
    STATE.photoGroups = groupList;
    STATE.loadedGroups = new Set(); // reset on new results

    el.photosGroups.innerHTML = "";

    groupList.forEach((g) => {
      const wrap = document.createElement("div");
      wrap.className = "rounded-2xl border border-slate-700 bg-slate-900/40 p-4";
      wrap.dataset.groupKey = g.key;

      const head = document.createElement("div");
      head.className = "flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.className = "text-sm font-semibold text-white";
      title.innerHTML = `${escapeHtml(g.title)} <span class="text-slate-400 font-normal">(${escapeHtml(g.form_type || "")}, ${g.items.length} फोटो)</span>`;

      const sub = document.createElement("div");
      sub.className = "text-xs text-slate-400 mt-1";
      const hl = (g.highlights || []).slice(0, 3).map(x => `• ${escapeHtml(x)}`).join(" &nbsp; ");
      sub.innerHTML = (g.subtitle ? escapeHtml(g.subtitle) + " &nbsp; | &nbsp; " : "") + hl;

      left.appendChild(title);
      left.appendChild(sub);

      const right = document.createElement("div");
      right.className = "flex items-center gap-2";

      const btnLoad = document.createElement("button");
      btnLoad.className = "bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl px-3 py-2 text-xs text-white";
      btnLoad.textContent = "Load thumbnails";
      btnLoad.addEventListener("click", () => loadPhotoGroup(g.key));

      const btnExpand = document.createElement("button");
      btnExpand.className = "bg-slate-950 hover:bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-xs text-white";
      btnExpand.textContent = "Details";
      btnExpand.addEventListener("click", () => {
        const body = document.createElement("div");
        body.className = "space-y-3";
        const p = document.createElement("div");
        p.className = "text-sm text-slate-200";
        p.innerHTML = `<div class="mb-2"><b>कार्यक्रम:</b> ${escapeHtml(g.title)}</div>` +
                      (g.subtitle ? `<div class="mb-1"><b>लोकेशन/टाइम:</b> ${escapeHtml(g.subtitle)}</div>` : "") +
                      (g.footer ? `<div class="mb-1"><b>अतिथि/अन्य:</b> ${escapeHtml(g.footer)}</div>` : "");
        body.appendChild(p);
        const list = document.createElement("div");
        list.className = "text-xs text-slate-400";
        list.innerHTML = `<div class="mb-2">इस group में ${g.items.length} फोटो है। नीचे “Load thumbnails” दबाकर फोटो देख सकते हो।</div>`;
        body.appendChild(list);
        modal.open("Program Details", body);
      });

      right.appendChild(btnLoad);
      right.appendChild(btnExpand);

      head.appendChild(left);
      head.appendChild(right);

      const grid = document.createElement("div");
      grid.className = "mt-4 hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3";
      grid.dataset.gridFor = g.key;

      wrap.appendChild(head);
      wrap.appendChild(grid);

      el.photosGroups.appendChild(wrap);
    });

    // Load all button (top)
    if (el.loadAllPhotosBtn) {
      el.loadAllPhotosBtn.onclick = () => {
        groupList.forEach(g => loadPhotoGroup(g.key));
      };
    }
  }

  function loadPhotoGroup(groupKey) {
    if (STATE.loadedGroups && STATE.loadedGroups.has(groupKey)) {
      // just unhide
      const grid = el.photosGroups?.querySelector(`[data-grid-for="${cssEscape(groupKey)}"]`);
      if (grid) grid.classList.remove("hidden");
      return;
    }

    const wrap = el.photosGroups?.querySelector(`[data-group-key="${cssEscape(groupKey)}"]`);
    const grid = el.photosGroups?.querySelector(`[data-grid-for="${cssEscape(groupKey)}"]`);
    if (!wrap || !grid) return;

    const group = (STATE.photoGroups || []).find(g => g.key === groupKey);
    if (!group) return;

    grid.innerHTML = "";
    grid.classList.remove("hidden");

    group.items.forEach(({ entry, url, sum }) => {
      const card = document.createElement("div");
      card.className = "rounded-xl overflow-hidden border border-slate-700 bg-slate-950";

      const imgWrap = document.createElement("div");
      imgWrap.className = "w-full aspect-square bg-slate-900 relative";

      const img = document.createElement("img");
      img.alt = sum?.title ? `Photo - ${sum.title}` : "Photo";
      img.loading = "lazy";
      img.decoding = "async";
      img.className = "w-full h-full object-cover";

      attachLazyImg(img, url);

      imgWrap.appendChild(img);

      const meta = document.createElement("div");
      meta.className = "p-2";
      const cap = document.createElement("div");
      cap.className = "text-[11px] text-slate-300 line-clamp-2";
      cap.textContent = `${sum?.title || entry.form_type || "Event"}`;

      const act = document.createElement("div");
      act.className = "mt-2 flex items-center justify-between gap-2";

      const btnView = document.createElement("button");
      btnView.className = "flex-1 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg px-2 py-1 text-[11px] text-white";
      btnView.textContent = "View";
      btnView.addEventListener("click", () => {
        const body = document.createElement("div");
        body.className = "space-y-3";

        const big = document.createElement("img");
        big.alt = img.alt;
        big.className = "w-full max-h-[520px] object-contain rounded-xl border border-slate-700 bg-slate-950";
        big.loading = "lazy";
        big.decoding = "async";
        setImgSrcWithRetry(big, url, 3);

        const dl = document.createElement("a");
        dl.href = url;
        dl.textContent = "Download photo";
        dl.className = "inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white w-fit";
        dl.setAttribute("download", "");

        const details = document.createElement("div");
        details.className = "text-sm text-slate-200";
        details.innerHTML = `<div class="mb-2"><b>फॉर्म:</b> ${escapeHtml(entry.form_type || "")}</div>` +
                            `<div class="mb-2"><b>Created:</b> ${escapeHtml(entry.created_at_iso || "")}</div>`;

        body.appendChild(big);
        body.appendChild(dl);
        body.appendChild(details);

        // include key details table (reuse existing helper)
        try {
          body.appendChild(makeKVTable(entry));
        } catch (_) {}

        modal.open("Photo", body);
      });

      const dlSmall = document.createElement("a");
      dlSmall.href = url;
      dlSmall.className = "bg-slate-950 hover:bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-[11px] text-white";
      dlSmall.textContent = "DL";
      dlSmall.setAttribute("download", "");

      act.appendChild(btnView);
      act.appendChild(dlSmall);

      meta.appendChild(cap);
      meta.appendChild(act);

      card.appendChild(imgWrap);
      card.appendChild(meta);
      grid.appendChild(card);
    });

    if (STATE.loadedGroups) STATE.loadedGroups.add(groupKey);
  }



  // --------- Thumbnail preview (selfie) ----------
  async function createThumbnailDataUrl(file, maxSize = 360, quality = 0.75) {
    const dataUrl = await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result || ""));
      fr.onerror = () => reject(fr.error);
      fr.readAsDataURL(file);
    });

    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.onload = () => resolve(i);
      i.onerror = reject;
      i.src = dataUrl;
    });

    const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
    const w = Math.max(1, Math.round(img.width * scale));
    const h = Math.max(1, Math.round(img.height * scale));

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);
    return canvas.toDataURL("image/jpeg", quality);
  }

  // --------- API Call ----------
  async function apiCall(action, payload, tokenOpt) {
    const isPublic = !!tokenOpt;
    const url = isPublic ? `${BASE_URL}/political/public/search` : `${BASE_URL}/political/search`;

    const body = { action, payload: payload || {} };
    if (isPublic) body.token = tokenOpt;

    const headers = { "Content-Type": "application/json" };

    // Private/admin mode: attach Authorization if available
    if (!isPublic) {
      const idToken = localStorage.getItem("id_token") || localStorage.getItem("idToken") || "";
      if (idToken) headers["Authorization"] = `Bearer ${idToken}`;
    }

    const resp = await fetch(url, {
      method: "POST",
      headers,
      body: JSON.stringify(body),
    });

    const txt = await resp.text();
    let json = {};
    try { json = JSON.parse(txt); } catch (e) { json = { message: txt || "Invalid JSON" }; }

    if (!resp.ok) {
      const msg = json && json.message ? json.message : `HTTP ${resp.status}`;
      throw new Error(msg);
    }
    return json;
  }

  function setLoading(isLoading) {
    if (!el.searchBtn) return;
    el.searchBtn.disabled = isLoading;
    el.searchBtn.textContent = isLoading ? "Searching..." : "Search";
  }

  // --------- Events ----------
  if (el.selfieInput) {
    el.selfieInput.addEventListener("change", async () => {
      const file = el.selfieInput.files && el.selfieInput.files[0];
      if (!file) return;
      try {
        const thumb = await createThumbnailDataUrl(file, 360, 0.75);
        if (el.preview) el.preview.src = thumb;
        setStatus("Selfie selected (thumbnail preview).");
      } catch (e) {
        setStatus("Selfie selected.", "info");
      }
    });
  }

  if (el.searchBtn) {
    el.searchBtn.addEventListener("click", async () => {
      const file = el.selfieInput && el.selfieInput.files && el.selfieInput.files[0];
      if (!file) {
        setStatus("कृपया पहले फोटो चुनें।", "error");
        return;
      }

      setLoading(true);
      setStatus("Starting search...");

      try {
        // 1) init_search -> upload_url + search_id
        const init = await apiCall("init_search", { mime_type: file.type || "image/jpeg" }, token);
        const uploadUrl = init.upload_url || init.url || "";
        const searchId = init.search_id || init.searchId || "";
        if (!uploadUrl || !searchId) throw new Error("init_search: upload_url / search_id missing");

        // 2) upload selfie
        setStatus("Uploading selfie...");
        const putResp = await fetch(uploadUrl, {
          method: "PUT",
          body: file,
          headers: { "Content-Type": file.type || "image/jpeg" },
        });
        if (!putResp.ok) throw new Error("Upload failed");

        // 3) run_search
        setStatus("Searching faces...");
        const res = await apiCall("run_search", { search_id: searchId }, token);

        const sim = isNonEmpty(res.similarity) ? Number(res.similarity).toFixed(2) : "0";
        const facesCount = Array.isArray(res.face_ids) ? res.face_ids.length : (res.face_id ? 1 : 0);
        const tCount = Array.isArray(res.timeline) ? res.timeline.length : 0;
        const pCount = Array.isArray(res.photo_urls) ? res.photo_urls.length : 0;

        if (res.message === "NO_MATCH" || tCount === 0) {
          setStatus("NO MATCH (कोई व्यक्ति नहीं मिला)", "error");
          setMatch(`Similarity: 0%`);
          // Reset state + UI
          STATE.rawTimeline = [];
          STATE.rawPhotoUrls = [];
          STATE.photoUrlByKey = new Map();
          initFiltersFromTimeline([]);
          updateStatsBar([]);
          if (el.photosGroups) el.photosGroups.innerHTML = "";
          if (el.keywordFilter) el.keywordFilter.value = "";
          if (el.formFilter) el.formFilter.value = "all";

          el.timeline.innerHTML = `<div class="text-slate-300 text-sm">No timeline entries.</div>`;
          el.photosSection.classList.add("hidden");
          return;
        }

        setStatus(`OK • Similarity: ${sim}% • Timeline: ${tCount} • Photos: ${pCount}`, "success");
        setMatch(`Similarity: ${sim}% • Faces: ${facesCount}`);

        // s3_key -> photo_url
        const photoUrlByKey = new Map();
        (res.photo_urls || []).forEach((u) => {
          const k = parseS3KeyFromUrl(u);
          if (isNonEmpty(k)) photoUrlByKey.set(k, u);
        });

        // Save to STATE + init filters + render
        STATE.rawTimeline = Array.isArray(res.timeline) ? res.timeline : [];
        STATE.rawPhotoUrls = Array.isArray(res.photo_urls) ? res.photo_urls : [];
        STATE.photoUrlByKey = photoUrlByKey;

        initFiltersFromTimeline(STATE.rawTimeline);
        applyFiltersAndRender();

      } catch (err) {
        console.error(err);
        setStatus(err.message || "Error", "error");
        setMatch("");
        if (el.timeline) el.timeline.innerHTML = `<div class="text-slate-300 text-sm">Error.</div>`;
        if (el.photosSection) el.photosSection.classList.add("hidden");
      } finally {
        setLoading(false);
      }
    });
  }


  // --------- Filter Listeners ----------
  if (el.formFilter) {
    el.formFilter.addEventListener("change", () => {
      STATE.filters.form = el.formFilter.value || "all";
      applyFiltersAndRender();
    });
  }
  if (el.keywordFilter) {
    const onKey = debounce(() => {
      STATE.filters.q = el.keywordFilter.value || "";
      applyFiltersAndRender();
    }, 220);
    el.keywordFilter.addEventListener("input", onKey);
  }
  if (el.sortOrder) {
    el.sortOrder.addEventListener("change", () => {
      STATE.filters.sort = el.sortOrder.value || "desc";
      applyFiltersAndRender();
    });
  }
  if (el.clearFilters) {
    el.clearFilters.addEventListener("click", () => {
      STATE.filters = { form: "all", q: "", sort: (el.sortOrder?.value || "desc") };
      if (el.formFilter) el.formFilter.value = "all";
      if (el.keywordFilter) el.keywordFilter.value = "";
      applyFiltersAndRender();
    });
  }

})();

  // expose helpers for inline handlers
  try { window.previewImage = previewImage; } catch(e) {}
  try { window.setImgSrcWithRetry = setImgSrcWithRetry; } catch(e) {}
</script>
</body>
</html>
