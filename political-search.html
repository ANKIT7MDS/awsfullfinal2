<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karyakarta Search - EventLens (Token Fixed)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: { brand: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c' } }
        }
      }
    }
  </script>
  <style>
    body { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.15), transparent 40%), radial-gradient(circle at bottom right, rgba(234, 88, 12, 0.10), transparent 40%), #020617; color: #e2e8f0; }
    .glass { background: rgba(30,41,59,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
    .search-glow { box-shadow: 0 0 40px -10px rgba(249, 115, 22, 0.3); }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    .timeline-line::before { content: ''; position: absolute; left: 23px; top: 30px; bottom: -20px; width: 2px; background: #334155; z-index: 0; }
    .timeline-item:last-child .timeline-line::before { display: none; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4">

  <!-- AUTH STATUS -->
  <div class="absolute top-4 right-4 text-xs font-mono text-slate-500" id="authStatus">Checking Auth...</div>

  <!-- SEARCH HEADER -->
  <div class="w-full max-w-xl mt-8 mb-6 text-center">
    <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-orange-500/10 text-orange-500 mb-4 ring-1 ring-orange-500/20">
      <i class="fa-solid fa-face-viewfinder text-2xl"></i>
    </div>
    <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-red-400">Search Karyakarta</h1>
    <p class="text-slate-400 text-sm mt-2">Upload a photo to find timeline & details</p>
  </div>

  <!-- SEARCH BOX -->
  <div class="w-full max-w-xl glass rounded-2xl p-1 search-glow transition-all duration-300 hover:border-orange-500/30">
    <div class="relative group cursor-pointer">
      <input type="file" id="searchFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" onchange="handleSearch(event)" />
      <div id="dropzone" class="flex items-center gap-4 p-4 rounded-xl bg-slate-900/50 group-hover:bg-slate-800/80 transition-colors">
        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 group-hover:text-orange-400 transition-colors">
          <i class="fa-solid fa-camera text-xl"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-sm font-medium text-white group-hover:text-orange-200">Tap to Search Face</h3>
          <p class="text-xs text-slate-500">Supports JPG, PNG (Max 5MB)</p>
        </div>
        <div class="w-8 h-8 rounded-full border border-slate-700 flex items-center justify-center">
          <i class="fa-solid fa-chevron-right text-xs text-slate-500"></i>
        </div>
      </div>

      <!-- Preview & Loader Overlay -->
      <div id="processing" class="absolute inset-0 bg-slate-900 z-30 rounded-xl flex items-center justify-center gap-3 hidden">
        <img id="searchPreview" class="w-10 h-10 rounded-full object-cover border-2 border-orange-500" alt="preview">
        <span class="text-sm text-orange-400 font-medium animate-pulse">Searching Database...</span>
      </div>
    </div>
  </div>

  <!-- RESULTS CONTAINER -->
  <div id="resultsArea" class="w-full max-w-xl mt-8 hidden">

    <!-- PERSON PROFILE CARD -->
    <div id="profileCard" class="glass rounded-2xl p-6 mb-6 relative overflow-hidden hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-red-500"></div>
      <div class="flex gap-5 items-start">
        <div class="relative">
          <div class="w-20 h-20 rounded-2xl overflow-hidden border-2 border-slate-700 shadow-xl">
            <img id="resultImage" src="" class="w-full h-full object-cover" alt="result">
          </div>
          <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-slate-900 rounded-full flex items-center justify-center border border-slate-700 text-orange-500 text-xs font-bold">
            <i class="fa-solid fa-check"></i>
          </div>
        </div>
        <div class="flex-1">
          <h2 id="personName" class="text-xl font-bold text-white">Unknown Person</h2>
          <div class="flex flex-wrap gap-2 mt-2">
            <span id="personPhone" class="px-2.5 py-1 rounded-md bg-slate-800 text-xs text-slate-300 border border-slate-700 hidden">
              <i class="fa-solid fa-phone mr-1.5 text-orange-500"></i> <span id="phoneVal"></span>
            </span>
            <span id="personDesig" class="px-2.5 py-1 rounded-md bg-slate-800 text-xs text-slate-300 border border-slate-700 hidden">
              <i class="fa-solid fa-id-badge mr-1.5 text-blue-400"></i> <span id="desigVal"></span>
            </span>
          </div>
          <div class="mt-3 text-xs text-slate-500 flex gap-4">
            <span><i class="fa-regular fa-clock mr-1"></i> Match Score: <span id="matchScore" class="text-emerald-400">--</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <div class="flex gap-4 border-b border-slate-800 mb-6">
      <button onclick="switchTab('timeline')" id="tab-timeline" class="pb-3 text-sm font-medium text-orange-500 border-b-2 border-orange-500 transition-colors">Activity Timeline</button>
      <button onclick="switchTab('photos')" id="tab-photos" class="pb-3 text-sm font-medium text-slate-500 hover:text-slate-300 transition-colors">All Photos</button>
    </div>

    <!-- TIMELINE VIEW -->
    <div id="view-timeline" class="space-y-0"></div>

    <!-- PHOTOS VIEW -->
    <div id="view-photos" class="hidden">
      <div id="photosGrid" class="grid grid-cols-3 gap-2"></div>
    </div>

  </div>

  <div id="errorMsg" class="mt-6 p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-sm text-center hidden"></div>

<script>
  // ==========================================
  // CONFIGURATION
  // ==========================================
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const BASE_API = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod/political`;

  const $ = (id) => document.getElementById(id);
  const qs = (k) => new URLSearchParams(window.location.search).get(k);

  const COLLECTION_ID = qs('cid') || 'bjpmandsaur';
  const PUBLIC_TOKEN = qs('token'); // public link token (if exists)

  // ==========================================
  // AUTH / MODE
  // ==========================================
  function getJwtFromStorage() {
    return localStorage.getItem('idToken') || localStorage.getItem('accessToken');
  }

  function getMode() {
    // If URL token exists => PUBLIC mode
    if (PUBLIC_TOKEN) return 'public';
    // else => admin mode (JWT must exist)
    return 'admin';
  }

  function getApiUrl() {
    const mode = getMode();
    return `${BASE_API}${mode === 'public' ? '/public/search' : '/search'}`;
  }

  function getHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    // IMPORTANT:
    // Public mode: do NOT send Authorization, token goes in payload
    // Admin mode: send Authorization Bearer JWT
    if (getMode() === 'admin') {
      const jwt = getJwtFromStorage();
      if (jwt) headers['Authorization'] = 'Bearer ' + jwt;
    }
    return headers;
  }

  // Auth status text
  (function(){
    const mode = getMode();
    if (mode === 'public') $('authStatus').innerText = "Mode: ✅ Public Link (token)";
    else {
      const jwt = getJwtFromStorage();
      $('authStatus').innerText = jwt ? "Mode: ✅ Admin (JWT)" : "Mode: ⚠️ Admin (missing JWT)";
    }
  })();

  // ==========================================
  // CORE LOGIC
  // ==========================================
  async function safeJson(res) {
    const text = await res.text();
    try { return JSON.parse(text); } catch { return { raw: text }; }
  }

  async function apiPost(action, payload) {
    const url = getApiUrl();
    const headers = getHeaders();
    const res = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ action, payload })
    });

    const data = await safeJson(res);
    if (!res.ok) {
      const msg = data?.message || data?.error || data?.raw || 'API Error';
      throw new Error(msg);
    }
    return data;
  }

  async function uploadToS3(uploadUrl, file) {
    const putRes = await fetch(uploadUrl, {
      method: 'PUT',
      headers: { 'Content-Type': file.type || 'application/octet-stream' },
      body: file
    });
    if (!putRes.ok) throw new Error("S3 Upload Failed");
  }

  async function handleSearch(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    // size check 5MB
    if (file.size > 5 * 1024 * 1024) {
      showError("File 5MB से बड़ा है. छोटा photo चुनो.");
      $('searchFile').value = '';
      return;
    }

    // UI reset
    $('resultsArea').classList.add('hidden');
    $('errorMsg').classList.add('hidden');
    $('processing').classList.remove('hidden');

    const reader = new FileReader();
    reader.onload = (ev) => $('searchPreview').src = ev.target.result;
    reader.readAsDataURL(file);

    try {
      const mode = getMode();
      const jwt = getJwtFromStorage();

      // auth validation
      if (mode === 'public' && !PUBLIC_TOKEN) {
        throw new Error("Public token missing. Link में ?token=... नहीं मिला.");
      }
      if (mode === 'admin' && !jwt) {
        throw new Error("Admin login token नहीं मिला. पहले Admin panel से login करो.");
      }

      // ✅ IMPORTANT FIX:
      // Public mode में token payload में जाना चाहिए (Authorization header नहीं)
      const commonPayload = {
        collection_id: COLLECTION_ID,
        token: PUBLIC_TOKEN || undefined
      };

      // STEP 1: init_search
      const initData = await apiPost('init_search', {
        ...commonPayload,
        mime_type: file.type || 'application/octet-stream'
      });

      if (!initData.upload_url || !initData.search_id) {
        throw new Error("Init response invalid (upload_url/search_id missing).");
      }

      // STEP 2: upload to S3
      await uploadToS3(initData.upload_url, file);

      // STEP 3: run_search
      const searchData = await apiPost('run_search', {
        ...commonPayload,
        search_id: initData.search_id
      });

      const timeline = searchData.timeline || [];
      const photos = searchData.photo_urls || [];
      const similarity = searchData.similarity || 0;

      if (similarity === 0 && timeline.length === 0) {
        throw new Error("No matching face found.");
      }

      renderProfile(null, { similarity });
      renderTimeline(timeline);
      renderPhotos(photos);

      $('resultsArea').classList.remove('hidden');

    } catch (err) {
      console.error(err);
      showError(err.message || "Search failed. Please try again.");
    } finally {
      $('processing').classList.add('hidden');
      $('searchFile').value = '';
    }
  }

  // ==========================================
  // RENDERING
  // ==========================================
  function renderProfile(info, stats) {
    $('profileCard').classList.remove('hidden');
    $('resultImage').src = $('searchPreview').src;

    $('personName').innerText = "Found Person";
    $('personPhone').classList.add('hidden');
    $('personDesig').classList.add('hidden');

    if (stats && stats.similarity != null) {
      $('matchScore').innerText = Math.round(stats.similarity) + "%";
    } else {
      $('matchScore').innerText = "--";
    }
  }

  function renderTimeline(events) {
    const container = $('view-timeline');
    container.innerHTML = '';
    if (!events || events.length === 0) {
      container.innerHTML = `<div class="text-center text-slate-500 py-8">No activity history found.</div>`;
      return;
    }

    events.forEach(ev => {
      const data = ev.data || {};
      const date = new Date(ev.created_at_iso || ev.timestamp || ev.created_at);
      const dateStr = isNaN(date) ? 'Unknown Date' : date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
      const timeStr = isNaN(date) ? '--:--' : date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

      let icon = 'fa-calendar-check', color = 'text-blue-400';
      const type = ev.form_type || ev.type;

      if (type === 'visitor_form') { icon = 'fa-building-user'; color = 'text-orange-400'; }
      else if (type === 'party_attendance') { icon = 'fa-handshake'; color = 'text-green-400'; }
      else if (type === 'program_info') { icon = 'fa-microphone'; color = 'text-purple-400'; }
      else if (type === 'president_tour') { icon = 'fa-person-walking'; color = 'text-teal-400'; }
      else if (type === 'coordinator_entry') { icon = 'fa-user-gear'; color = 'text-pink-400'; }
      else if (type === 'mandal_reporting') { icon = 'fa-chart-line'; color = 'text-yellow-400'; }

      let desc = ev.reason || data.program_title || data.program_name || data.tour_place || 'Activity Recorded';
      if (data.program_location) desc += ` @ ${data.program_location}`;

      const html = `
        <div class="timeline-item relative pl-12 pb-8">
          <div class="timeline-line"></div>
          <div class="absolute left-0 top-0 w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center z-10 ${color}">
            <i class="fa-solid ${icon}"></i>
          </div>
          <div class="glass p-4 rounded-xl border border-slate-700/50 hover:border-orange-500/30 transition-colors">
            <div class="flex justify-between items-start mb-1">
              <h4 class="font-bold text-slate-200 text-sm">${formatEventType(type)}</h4>
              <span class="text-[10px] text-slate-500 bg-slate-900 px-2 py-0.5 rounded-full">${dateStr} • ${timeStr}</span>
            </div>
            <p class="text-xs text-slate-400 leading-relaxed">${escapeHtml(desc)}</p>
            ${data.program_date ? `<div class="mt-1 text-xs text-slate-500"><i class="fa-regular fa-calendar mr-1"></i>Event Date: ${escapeHtml(String(data.program_date))}</div>` : ''}
          </div>
        </div>`;
      container.innerHTML += html;
    });
  }

  function renderPhotos(photos) {
    const grid = $('photosGrid');
    grid.innerHTML = '';

    if (!photos || photos.length === 0) {
      $('view-photos').innerHTML = `<div class="text-center text-slate-500 py-8">No photos found.</div>`;
      return;
    }

    photos.forEach(p => {
      const url = typeof p === 'string' ? p : p.url;
      if (!url) return;

      grid.innerHTML += `
        <a href="${url}" target="_blank" class="block aspect-square rounded-lg overflow-hidden border border-slate-700 hover:border-orange-500 transition group relative">
          <img src="${url}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" alt="photo">
          <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
            <i class="fa-solid fa-expand text-white"></i>
          </div>
        </a>`;
    });
  }

  function switchTab(tab) {
    if (tab === 'timeline') {
      $('view-timeline').classList.remove('hidden');
      $('view-photos').classList.add('hidden');
      $('tab-timeline').className = "pb-3 text-sm font-medium text-orange-500 border-b-2 border-orange-500 transition-colors";
      $('tab-photos').className = "pb-3 text-sm font-medium text-slate-500 hover:text-slate-300 transition-colors";
    } else {
      $('view-timeline').classList.add('hidden');
      $('view-photos').classList.remove('hidden');
      $('tab-timeline').className = "pb-3 text-sm font-medium text-slate-500 hover:text-slate-300 transition-colors";
      $('tab-photos').className = "pb-3 text-sm font-medium text-orange-500 border-b-2 border-orange-500 transition-colors";
    }
  }

  function showError(msg) {
    $('errorMsg').innerText = msg;
    $('errorMsg').classList.remove('hidden');
  }

  function formatEventType(type) {
    if (!type) return "Activity";
    return String(type).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  }

  // basic HTML escape (desc safety)
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>

</body>
</html>
