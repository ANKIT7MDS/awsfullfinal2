<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karyakarta Search - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }, colors: { brand: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c' } } } } }</script>
  <style>
    body { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.15), transparent 40%), radial-gradient(circle at bottom right, rgba(234, 88, 12, 0.10), transparent 40%), #020617; color: #e2e8f0; }
    .glass { background: rgba(30,41,59,0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
    .animate-spin-slow { animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="glass rounded-2xl p-6 mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4 shadow-xl border-t-2 border-orange-500/50">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center text-orange-400"><i class="fa-solid fa-magnifying-glass-chart text-xl"></i></div>
        <div><h1 class="text-2xl font-extrabold text-white">Karyakarta Search</h1><p class="text-slate-400 text-sm">EventLens Political Module</p></div>
      </div>
      <div class="text-right hidden md:block"><div class="text-xs font-mono text-slate-500" id="tokenDisplay">Token: Checking...</div></div>
    </div>

    <div class="grid md:grid-cols-12 gap-6">
      <!-- Sidebar -->
      <div class="md:col-span-4 space-y-6">
        <div class="glass rounded-2xl p-6 shadow-lg border-l-4 border-orange-500">
          <h2 class="font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-camera"></i> 1. Search by Selfie</h2>
          <div class="relative group cursor-pointer mb-4">
            <input id="selfieInput" accept="image/*" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImage(this)" />
            <div id="uploadBox" class="h-48 border-2 border-dashed border-slate-600 rounded-xl flex flex-col items-center justify-center bg-slate-800/50 group-hover:border-orange-500 transition-colors">
              <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i><span class="text-sm text-slate-400">Tap to upload image</span>
            </div>
            <img id="preview" class="hidden h-48 w-full object-cover rounded-xl border border-slate-600" />
          </div>
          <button id="searchBtn" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold shadow-lg shadow-orange-500/25 transition-all active:scale-95 flex items-center justify-center gap-2">
            <span>Search Database</span> <i class="fa-solid fa-search"></i>
          </button>
          <div id="statusBox" class="hidden mt-4 p-3 rounded-lg text-sm text-center"></div>
        </div>
      </div>

      <!-- Results -->
      <div class="md:col-span-8">
        <div class="glass rounded-2xl p-6 shadow-lg min-h-[400px]">
          <div class="flex items-center justify-between mb-6 border-b border-slate-700 pb-4">
             <h2 class="font-bold text-xl text-white flex items-center gap-2"><i class="fa-solid fa-timeline"></i> Result Timeline</h2>
             <span id="matchScore" class="text-sm font-mono text-slate-400"></span>
          </div>
          <div id="timeline" class="space-y-4">
             <div class="text-center py-10 text-slate-500"><i class="fa-regular fa-image text-4xl mb-3 opacity-50"></i><p>Upload a selfie to view history.</p></div>
          </div>
          <div id="photosSection" class="hidden mt-8 pt-6 border-t border-slate-700">
             <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i class="fa-regular fa-images"></i> Related Photos</h3>
             <div id="photosGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_ID = 'vxid0yoovj'; const REGION = 'ap-south-1'; const BASE_URL = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
  let lastFaceId = null; const qs = (n) => new URL(window.location.href).searchParams.get(n); const token = qs('token');
  document.getElementById('tokenDisplay').innerText = token ? `Token: ${token.substring(0,8)}...` : 'Admin Mode';

  function previewImage(input) {
    const f = input.files[0]; if(f){ const r = new FileReader(); r.onload = (e) => { document.getElementById('preview').src = e.target.result; document.getElementById('preview').classList.remove('hidden'); document.getElementById('uploadBox').classList.add('hidden'); }; r.readAsDataURL(f); }
  }

  const showStatus = (msg, err=false) => {
    const b=document.getElementById('statusBox'); b.classList.remove('hidden', 'bg-emerald-500/10', 'text-emerald-400', 'bg-red-500/10', 'text-red-400');
    b.classList.add(err ? 'bg-red-500/10' : 'bg-emerald-500/10'); b.classList.add(err ? 'text-red-400' : 'text-emerald-400'); b.innerHTML = msg;
  };

  async function apiCall(action, payload) {
    const url = `${BASE_URL}/political${token ? '/public/search' : '/search'}`; const headers = { 'Content-Type': 'application/json' };
    if(!token) { const jwt = localStorage.getItem('idToken') || localStorage.getItem('accessToken'); if(jwt) headers['Authorization'] = 'Bearer ' + jwt; }
    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify({ action, payload }) });
    const data = await res.json(); if(!res.ok) throw new Error(data.message || data.error || 'API Error'); return data;
  }
  async function uploadToS3(url, file) { const r = await fetch(url, { method: 'PUT', headers: { 'Content-Type': file.type }, body: file }); if(!r.ok) throw new Error("Upload Failed"); }

  document.getElementById("searchBtn").onclick = async () => {
    const file = document.getElementById("selfieInput").files[0];
    if(!token && !localStorage.getItem('idToken')) return showStatus("Authentication Missing", true);
    if(!file) return showStatus("Select a selfie first", true);
    const btn = document.getElementById("searchBtn"); const oldText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Searching...'; showStatus('');
    document.getElementById("timeline").innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-3xl text-orange-500"></i></div>';

    try {
      const init = await apiCall("init_search", { token, mime_type: file.type }); await uploadToS3(init.upload_url, file);
      const res = await apiCall("run_search", { token, search_id: init.search_id }); lastFaceId = res.face_id;
      
      document.getElementById("matchScore").innerHTML = res.similarity > 0 ? `<span class="bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded">Match: ${Math.round(res.similarity)}%</span>` : `<span class="bg-red-500/20 text-red-400 px-2 py-1 rounded">No Match Found</span>`;
      
      const tl = document.getElementById("timeline");
      if(res.timeline && res.timeline.length > 0) {
          tl.innerHTML = res.timeline.map((t) => {
            const d = t.data || {};
            let extraInfo = '';
            
            // Logic to show detailed info based on form type
            if(t.form_type === 'program_info') {
               extraInfo = `
                 <div class="mt-2 text-xs bg-slate-800/50 p-2 rounded border border-slate-700">
                   <div class="font-semibold text-orange-300 mb-1">${d.program_title || 'Untitled Program'}</div>
                   <div class="grid grid-cols-2 gap-1 text-slate-400">
                     <div><i class="fa-solid fa-map-pin mr-1"></i>${d.program_location || '-'}</div>
                     <div><i class="fa-solid fa-calendar mr-1"></i>${d.program_date || '-'}</div>
                     <div><i class="fa-solid fa-users mr-1"></i>${d.expected_people || '-'}</div>
                     <div><i class="fa-solid fa-clock mr-1"></i>${d.program_time || '-'}</div>
                   </div>
                 </div>`;
            } else if (t.form_type === 'president_tour') {
               extraInfo = `
                 <div class="mt-2 text-xs bg-slate-800/50 p-2 rounded border border-slate-700">
                   <div class="font-semibold text-teal-300 mb-1">Tour: ${d.tour_place || 'Unknown'}</div>
                   <div class="text-slate-400"><i class="fa-solid fa-user-tie mr-1"></i>VIP: ${d.vip_person || '-'}</div>
                   <div class="text-slate-400"><i class="fa-solid fa-calendar mr-1"></i>Date: ${d.tour_date || '-'}</div>
                 </div>`;
            } else if (t.form_type === 'party_attendance') {
               extraInfo = `
                 <div class="mt-2 text-xs bg-slate-800/50 p-2 rounded border border-slate-700">
                   <div class="font-semibold text-blue-300 mb-1">Meeting: ${d.program_name || 'Meeting'}</div>
                   <div class="text-slate-400"><i class="fa-solid fa-users mr-1"></i>Count: ${d.attendance_count || '-'}</div>
                   <div class="text-slate-400"><i class="fa-solid fa-calendar mr-1"></i>Date: ${d.program_date || '-'}</div>
                 </div>`;
            } else if (t.form_type === 'coordinator_entry') {
               extraInfo = `
                 <div class="mt-2 text-xs bg-slate-800/50 p-2 rounded border border-slate-700">
                   <div class="text-purple-300 font-semibold">Role: ${d.coordinator_role || '-'}</div>
                   <div class="text-slate-400">Area: ${d.area || '-'}</div>
                 </div>`;
            } else if (t.form_type === 'mandal_reporting') {
               extraInfo = `
                 <div class="mt-2 text-xs bg-slate-800/50 p-2 rounded border border-slate-700">
                   <div class="text-pink-300 font-semibold">Type: ${d.report_type || '-'}</div>
                   <div class="text-slate-400">Issues: ${d.issues || '-'}</div>
                   <div class="text-slate-400">Workers: ${d.workers_count || '-'}</div>
                 </div>`;
            }

            return `
            <div class="relative pl-8 pb-6 border-l border-slate-700 last:border-0 last:pb-0">
                <div class="absolute -left-1.5 top-0 w-3 h-3 rounded-full bg-orange-500 ring-4 ring-slate-900"></div>
                <div class="glass p-4 rounded-xl border border-slate-700 hover:border-orange-500/50 transition-colors">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-mono text-orange-400">${t.created_at_iso ? new Date(t.created_at_iso).toLocaleDateString() : 'Date Unknown'}</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300 capitalize">${t.form_type?.replace(/_/g, ' ') || 'Entry'}</span>
                    </div>
                    <div class="font-bold text-white text-lg">${t.name || 'Unknown'}</div>
                    <div class="text-slate-400 text-sm mt-1">${t.reason || (d.program_title ? d.program_title : 'No description provided')}</div>
                    
                    ${extraInfo}

                    <div class="text-xs text-slate-500 mt-2 flex gap-3">
                       ${t.district ? `<span><i class="fa-solid fa-map-location-dot"></i> ${t.district}</span>` : ''} 
                       ${t.mandal ? `<span><i class="fa-solid fa-sitemap"></i> ${t.mandal}</span>` : ''}
                    </div>
                </div>
            </div>`;
          }).join('');
      } else { tl.innerHTML = `<div class="p-4 bg-yellow-500/10 text-yellow-500 rounded-xl text-center">No history found for this face.</div>`; }

      const pg = document.getElementById("photosGrid");
      if(res.photo_urls && res.photo_urls.length > 0) {
        document.getElementById("photosSection").classList.remove('hidden');
        pg.innerHTML = res.photo_urls.map(u => `<a href="${u}" target="_blank" class="block aspect-square overflow-hidden rounded-lg border border-slate-700 hover:border-orange-500 transition"><img src="${u}" class="w-full h-full object-cover transition hover:scale-110"></a>`).join('');
      } else { document.getElementById("photosSection").classList.add('hidden'); }

      showStatus("âœ… Search Complete", false);
    } catch(e) { showStatus(e.message, true); document.getElementById("timeline").innerHTML = `<div class="text-center text-red-400">Error loading data.</div>`; } finally { btn.disabled = false; btn.innerHTML = oldText; }
  };
</script>
</body>
</html>
