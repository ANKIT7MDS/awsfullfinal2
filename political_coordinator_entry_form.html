<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Political Coordinator Entry Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: radial-gradient(1000px 700px at 20% 10%, rgba(56,189,248,.18), transparent 60%),
                     radial-gradient(900px 600px at 80% 20%, rgba(99,102,241,.16), transparent 55%),
                     linear-gradient(180deg, #020617, #020617); }
    .card { background: rgba(2,6,23,.55); backdrop-filter: blur(8px); }
    .btn { background: #0284c7; }
    .btn:hover { background: #0369a1; }
  </style>
</head>
<body class="min-h-screen text-white">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <div class="card border border-slate-800 rounded-3xl p-6 md:p-8 shadow-2xl">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold">Coordinator Entry Form</h1>
          <p id="modeLine" class="text-slate-300 mt-1 text-sm"></p>
        </div>
        <div class="text-xs text-slate-400">EventLens Political Module</div>
      </div>

      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="space-y-1"><label class="text-sm text-slate-200">कार्यक्रम / क्षेत्र *</label><input id="program_name" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">जिला *</label><input id="district" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">विधानसभा</label><input id="vidhansabha" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="optional" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">मंडल *</label><input id="mandal" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">समन्वयक 1 (नाम) *</label><input id="coord_1" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">समन्वयक 1 (मोबाइल) *</label><input id="coord_1_mobile" type="tel" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">समन्वयक 2 (नाम)</label><input id="coord_2" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="optional" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">समन्वयक 2 (मोबाइल)</label><input id="coord_2_mobile" type="tel" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="optional" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">समन्वयक 3 (नाम)</label><input id="coord_3" type="text" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="optional" /></div>
<div class="space-y-1"><label class="text-sm text-slate-200">समन्वयक 3 (मोबाइल)</label><input id="coord_3_mobile" type="tel" class="w-full mt-2 p-3 rounded-xl bg-slate-900/60 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="optional" /></div>
      </div>

      <div class="mt-6 space-y-1">
        <label class="text-sm text-slate-200">फोटो (Optional)</label>
        <input id="fileInput" type="file" accept="image/*" class="mt-2 block w-full text-sm text-slate-200 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-slate-800 file:text-white hover:file:bg-slate-700" />
        <p class="text-xs text-slate-400 mt-1">Photo optional है.</p>
      </div>

      <button id="submitBtn" class="btn w-full mt-6 py-4 rounded-2xl font-semibold text-lg">Submit / Save</button>

      <div id="statusBox" class="mt-6 hidden rounded-2xl border border-slate-800 p-4 bg-slate-950/50">
        <div class="text-sm font-semibold">Status</div>
        <div id="statusText" class="mt-1 text-sm text-slate-200"></div>
      </div>

      <div class="mt-6 text-xs text-slate-500">
        Note: Public link में token जरूरी है. Admin mode में dashboard login token (localStorage) और collection id जरूरी है.
      </div>
    </div>
  </div>

<script>
(() => {
  const FORM_TYPE = "coordinator_entry";
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";
  const API_BASES = [
    `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod/political/forms`,
    `https://${API_ID}.execute-api.${REGION}.amazonaws.com/political/forms`,
  ];

  const REQUIRED_IDS = ["program_name","district","mandal","coord_1","coord_1_mobile"];

  const qs = (k) => new URLSearchParams(window.location.search).get(k) || "";
  const showStatus = (msg, isErr=false) => {
    const box = document.getElementById("statusBox");
    const txt = document.getElementById("statusText");
    box.classList.remove("hidden");
    txt.textContent = msg;
    txt.className = "mt-1 text-sm " + (isErr ? "text-red-400" : "text-emerald-300");
  };

  const isPublicMode = () => !!qs("token");
  const getPublicToken = () => qs("token");

  const getIdTokenPrefer = () => {
    return localStorage.getItem("idToken") ||
           localStorage.getItem("accessToken") ||
           localStorage.getItem("cognito_id_token") ||
           localStorage.getItem("cognito_access_token") ||
           "";
  };

  const requireAdminToken = () => {
    const t = getIdTokenPrefer();
    if (!t) throw new Error("Login token नहीं मिला (dashboard से login करो)");
    return t;
  };

  const getCollectionIdAdmin = () => {
    const cid = qs("cid") || localStorage.getItem("political_cid") || "";
    if (cid) localStorage.setItem("political_cid", cid);
    return cid;
  };

  async function sha256Hex(file) {
    const buf = await file.arrayBuffer();
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function apiCall(action, payload, useAuth) {
    let lastErr = null;
    for (const base of API_BASES) {
      try {
        const headers = { "Content-Type": "application/json" };
        if (useAuth) headers["Authorization"] = "Bearer " + requireAdminToken();
        const res = await fetch(base, {
          method: "POST",
          headers,
          body: JSON.stringify({ action, payload })
        });
        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }

        if (!res.ok) {
          const msg = (data && (data.message || data.detail)) ? (data.message || data.detail) : ("API Error " + res.status);
          // stage fallback if first base fails
          lastErr = new Error(msg);
          continue;
        }
        return data;
      } catch (e) {
        lastErr = e;
        continue;
      }
    }
    throw lastErr || new Error("API call failed");
  }

  async function uploadPut(url, file) {
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Content-Type": file.type || "application/octet-stream"
      },
      body: file
    });
    if (!res.ok) throw new Error("Upload failed: " + res.status);
  }

  function readField(id) {
    const el = document.getElementById(id);
    return (el && el.value) ? String(el.value).trim() : "";
  }

  function setModeLine() {
    const el = document.getElementById("modeLine");
    if (isPublicMode()) {
      el.textContent = "Public Mode: token based (no login).";
    } else {
      el.textContent = "Admin Mode: dashboard login + cid required.";
    }
  }

  async function onSubmit() {
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";
    try {
      setModeLine();

      // validate
      for (const id of REQUIRED_IDS) {
        if (!readField(id)) {
          showStatus("कृपया '" + id + "' भरें", true);
          btn.disabled = false; btn.textContent = "Submit / Save";
          return;
        }
      }

      const fileInput = document.getElementById("fileInput");
      const file = fileInput && fileInput.files ? fileInput.files[0] : null;
      if (false && !file) {
        showStatus("कृपया photo select करें", true);
        btn.disabled = false; btn.textContent = "Submit / Save";
        return;
      }

      const payloadData = {};
      for (const id of ['program_name', 'district', 'vidhansabha', 'mandal', 'coord_1', 'coord_1_mobile', 'coord_2', 'coord_2_mobile', 'coord_3', 'coord_3_mobile']) {
        payloadData[id] = readField(id);
      }

      let fileName = "";
      let mimeType = "image/jpeg";
      let sha256 = "";
      if (file) {
        fileName = file.name || ("upload_" + Date.now() + ".jpg");
        mimeType = file.type || mimeType;
        sha256 = await sha256Hex(file);
      } else {
        // optional file not provided: keep empty
      }

      if (isPublicMode()) {
        const token = getPublicToken();
        if (!token) {
          showStatus("Token missing", true);
          return;
        }

        const createResp = await apiCall("public_create_entry", {
          token,
          form_type: FORM_TYPE,
          file_kind: "selfie",
          file_name: fileName,
          mime_type: mimeType,
          sha256,
          payload: payloadData
        }, false);

        if (!createResp || !createResp.finalize_token) throw new Error("Create response invalid");
        if (file && createResp.upload_url) {
          await uploadPut(createResp.upload_url, file);
        }
        await apiCall("public_finalize_entry", {
          token,
          finalize_token: createResp.finalize_token
        }, false);

        showStatus("Saved ✅ Entry ID: " + (createResp.entry_id || ""));
      } else {
        const cid = getCollectionIdAdmin();
        if (!cid) {
          showStatus("cid missing (dashboard के अंदर collection खोलकर link जनरेट करो)", true);
          return;
        }

        const createResp = await apiCall("create_entry", {
          collection_id: cid,
          form_type: FORM_TYPE,
          file_kind: "selfie",
          file_name: fileName,
          mime_type: mimeType,
          sha256,
          payload: payloadData
        }, true);

        if (!createResp || !createResp.finalize_token) throw new Error("Create response invalid");
        if (file && createResp.upload_url) {
          await uploadPut(createResp.upload_url, file);
        }
        await apiCall("finalize_entry", {
          finalize_token: createResp.finalize_token
        }, true);

        showStatus("Saved ✅ Entry ID: " + (createResp.entry_id || ""));
      }
    } catch (e) {
      showStatus(e && e.message ? e.message : "Error", true);
    } finally {
      btn.disabled = false;
      btn.textContent = "Submit / Save";
    }
  }

  document.getElementById("submitBtn").addEventListener("click", onSubmit);
  setModeLine();
})();
</script>
</body>
</html>
