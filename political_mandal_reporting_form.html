<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reporting Form - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] } } } }</script>
  <style>
    body { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.15), transparent 50%), radial-gradient(circle at bottom right, rgba(234, 88, 12, 0.1), transparent 50%), #0f172a; color: #fff; }
    .glass { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .input-group { position: relative; transition: transform 0.2s; }
    .input-field { width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 0.85rem; padding: 0.85rem 1rem 0.85rem 2.75rem; color: white; transition: all 0.3s; outline: none; }
    .input-field:focus { border-color: #f97316; box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15); }
    .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
    .input-field:focus ~ .input-icon { color: #f97316; }
    .btn-gradient { background: linear-gradient(135deg, #f97316, #ea580c); transition: all 0.3s; }
    .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(249, 115, 22, 0.4); }
    select.input-field option { background: #0f172a; color: white; }
    
    .hidden-field { display: none; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="glass w-full max-w-lg rounded-3xl p-6 md:p-8 relative overflow-hidden">
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-orange-500 rounded-b-full shadow-[0_0_20px_rgba(249,115,22,0.6)]"></div>
    
    <div class="text-center mb-6 mt-2">
      <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-orange-500/10 text-orange-500 mb-4 ring-1 ring-orange-500/20">
        <i class="fa-solid fa-clipboard-check text-2xl"></i>
      </div>
      <h1 class="text-2xl font-bold">Event Report</h1>
      <p class="text-slate-400 text-sm mt-1">Submit Post-Event Details</p>
    </div>

    <form id="f" class="space-y-4">
      
      <!-- Program Name -->
      <div class="input-group">
        <input id="program_name" type="text" placeholder="कार्यक्रम का नाम *" required class="input-field" />
        <i class="fa-solid fa-heading input-icon"></i>
      </div>

      <!-- Level Selection -->
      <div class="input-group">
        <select id="report_level" class="input-field" onchange="toggleLevels()">
            <option value="district">Level: District (जिला)</option>
            <option value="vidhansabha">Level: Vidhansabha (विधानसभा)</option>
            <option value="mandal" selected>Level: Mandal (मंडल)</option>
        </select>
        <i class="fa-solid fa-layer-group input-icon"></i>
      </div>

      <!-- District (Always Visible) -->
      <div class="input-group" id="div_district">
        <input id="district" type="text" placeholder="जिला *" required class="input-field" />
        <i class="fa-solid fa-map-location-dot input-icon"></i>
      </div>

      <!-- Vidhansabha (Hidden for District Level) -->
      <div class="input-group" id="div_vidhansabha">
        <input id="vidhansabha" type="text" placeholder="विधानसभा *" class="input-field" />
        <i class="fa-solid fa-landmark input-icon"></i>
      </div>

      <!-- Mandal (Hidden for District & Vidhansabha Level) -->
      <div class="input-group" id="div_mandal">
        <input id="mandal" type="text" placeholder="मंडल *" class="input-field" />
        <i class="fa-solid fa-sitemap input-icon"></i>
      </div>

      <!-- Details -->
      <div class="input-group">
        <input id="program_location" type="text" placeholder="कार्यक्रम का स्थान *" required class="input-field" />
        <i class="fa-solid fa-map-pin input-icon"></i>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="input-group">
            <input id="total_attendance" type="number" placeholder="कुल उपस्थिति" class="input-field" />
            <i class="fa-solid fa-users input-icon"></i>
        </div>
        <div class="input-group">
            <input id="key_speaker" type="text" placeholder="प्रमुख वक्ता" class="input-field" />
            <i class="fa-solid fa-microphone-lines input-icon"></i>
        </div>
      </div>

      <!-- Photo Upload -->
      <div class="pt-3">
        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 ml-1">कार्यक्रम के फोटो *</label>
        <div class="relative group cursor-pointer overflow-hidden rounded-2xl">
          <input id="selfie" type="file" accept="image/*" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="previewImage(this)" />
          <div id="uploadBox" class="border-2 border-dashed border-slate-600 rounded-2xl p-6 flex flex-col items-center justify-center bg-slate-800/40 group-hover:border-orange-500 transition-all h-32">
            <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center mb-2"><i class="fa-solid fa-camera text-xl text-slate-300"></i></div>
            <span class="text-sm font-medium text-slate-300">Upload Photos</span>
          </div>
          <img id="preview" class="hidden absolute inset-0 w-full h-full object-cover rounded-2xl z-10" />
          <button type="button" id="removePreview" class="hidden absolute top-2 right-2 z-30 bg-black/60 text-white rounded-full p-1.5 hover:bg-red-500 transition" onclick="clearImage(event)"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>

      <button id="submitBtn" type="submit" class="w-full btn-gradient text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex items-center justify-center gap-2 text-lg">
        <span>Submit Report</span> <i class="fa-solid fa-paper-plane"></i>
      </button>
    </form>
    <div id="statusBox" class="hidden mt-4 p-4 rounded-xl text-sm text-center font-medium border border-transparent"></div>
  </div>

<script>
    // Logic to toggle fields based on Level selection
    function toggleLevels() {
        const level = document.getElementById('report_level').value;
        const divVidhan = document.getElementById('div_vidhansabha');
        const divMandal = document.getElementById('div_mandal');
        const inpVidhan = document.getElementById('vidhansabha');
        const inpMandal = document.getElementById('mandal');

        if(level === 'district') {
            divVidhan.classList.add('hidden-field');
            divMandal.classList.add('hidden-field');
            inpVidhan.required = false; inpMandal.required = false;
            inpVidhan.value = ''; inpMandal.value = ''; // Clear hidden values
        } else if(level === 'vidhansabha') {
            divVidhan.classList.remove('hidden-field');
            divMandal.classList.add('hidden-field');
            inpVidhan.required = true; inpMandal.required = false;
            inpMandal.value = '';
        } else { // mandal
            divVidhan.classList.remove('hidden-field');
            divMandal.classList.remove('hidden-field');
            inpVidhan.required = true; inpMandal.required = true;
        }
    }

    // Initialize on load
    window.onload = toggleLevels;

    function previewImage(i){const f=i.files[0];if(f){const r=new FileReader();r.onload=(e)=>{document.getElementById('preview').src=e.target.result;document.getElementById('preview').classList.remove('hidden');document.getElementById('removePreview').classList.remove('hidden');document.getElementById('uploadBox').classList.add('hidden');};r.readAsDataURL(f);}}
    function clearImage(e){e.preventDefault();e.stopPropagation();document.getElementById('selfie').value='';document.getElementById('preview').classList.add('hidden');document.getElementById('removePreview').classList.add('hidden');document.getElementById('uploadBox').classList.remove('hidden');}

    (() => {
        const API_ID = 'vxid0yoovj'; const REGION = 'ap-south-1'; const FORM_TYPE = 'mandal_reporting';
        const FIELD_IDS = ['program_name','report_level','district','vidhansabha','mandal','program_location','total_attendance','key_speaker'];
        const $ = (id) => document.getElementById(id);
        const qs = (n) => { try{ return (new URL(window.location.href)).searchParams.get(n)||''; }catch(e){ return ''; } };
        const token = qs('token'); const cidParam = (qs('cid') || qs('collection_id') || qs('id')).trim(); const isPublicMode = () => !!token;

        function showStatus(msg, isErr=false){
            const b=$('statusBox');
            b.classList.remove('hidden', 'bg-emerald-500/10', 'text-emerald-400', 'border-emerald-500/20', 'bg-red-500/10', 'text-red-400', 'border-red-500/20');
            b.classList.add(isErr ? 'bg-red-500/10' : 'bg-emerald-500/10');
            b.classList.add(isErr ? 'text-red-400' : 'text-emerald-400');
            b.classList.add(isErr ? 'border-red-500/20' : 'border-emerald-500/20');
            b.innerHTML = msg;
        }

        async function sha256Hex(file){ const buf = await file.arrayBuffer(); const hash = await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
        function getJwt(){ return localStorage.getItem('idToken') || localStorage.getItem('accessToken') || ''; }

        async function apiCall(action, payload, auth=false){
            const base = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod${isPublicMode()?'/political/public/forms':'/political/forms'}`;
            const headers = {'Content-Type':'application/json'};
            if(auth){ const jwt = getJwt(); if(!jwt) throw new Error('Auth Missing'); headers['Authorization'] = 'Bearer '+jwt; }
            const res = await fetch(base, { method:'POST', headers, body:JSON.stringify({action, payload}) });
            const data = await res.json();
            if(!res.ok) throw new Error(data.message || data.error || 'API Error');
            return data;
        }
        async function uploadToS3(url, file){ const res = await fetch(url, { method:'PUT', headers:{'Content-Type':file.type}, body:file }); if(!res.ok) throw new Error('Photo Upload Failed'); }

        $('f').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const btn = $('submitBtn'); const ot = btn.innerHTML; btn.disabled=true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...'; showStatus('');
            try {
                const file = $('selfie').files[0]; if(!file) throw new Error('Program Photo required');
                const data = {}; for(const id of FIELD_IDS) data[id] = $(id).value.trim();
                const sha = await sha256Hex(file); const fileName = `${crypto.randomUUID()}.jpg`;
                
                let res;
                if(isPublicMode()){ 
                    res = await apiCall('public_create_entry', { token, form_type: FORM_TYPE, sha256: sha, file_name: fileName, mime_type: file.type, payload: data }); 
                } else { 
                    if(!cidParam) throw new Error('Missing Collection ID'); 
                    res = await apiCall('create_entry', { collection_id: cidParam, form_type: FORM_TYPE, sha256: sha, file_name: fileName, mime_type: file.type, payload: data }, true); 
                }

                if(res.upload_url) await uploadToS3(res.upload_url, file);
                
                const af = isPublicMode() ? 'public_finalize_entry' : 'finalize_entry';
                await apiCall(af, { finalize_token: res.finalize_token, entry_id: res.entry_id }, !isPublicMode());
                
                showStatus('✅ Report Submitted Successfully!', false); $('f').reset(); clearImage(e); toggleLevels();
            } catch(err) { showStatus('❌ ' + err.message, true); } finally { btn.disabled=false; btn.innerHTML = ot; }
        });
    })();
</script>
</body>
</html>
