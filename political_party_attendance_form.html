<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Party Attendance - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    :root {
      --c1: #f97316; /* primary */
      --c2: #ef4444; /* secondary */
      --bgimg: none;
    }
    body {
      background:
        radial-gradient(circle at top left, rgba(249, 115, 22, 0.14), transparent 50%),
        radial-gradient(circle at bottom right, rgba(234, 88, 12, 0.10), transparent 50%),
        linear-gradient(180deg, rgba(2, 6, 23, 0.92), rgba(2, 6, 23, 0.98)),
        var(--bgimg);
      background-size: cover;
      background-attachment: fixed;
      color: #fff;
    }
    .glass {
      background: rgba(30, 41, 59, 0.75);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.10);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.40);
    }
    .input-field {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.10);
      color: white;
      transition: all 0.25s ease;
    }
    .input-field:focus {
      border-color: var(--c1);
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.18);
      outline: none;
    }
    .input-field:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(15, 23, 42, 0.35);
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    .brand-text {
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      background-image: linear-gradient(to right, var(--c1), var(--c2));
    }
    .brand-bg { background-image: linear-gradient(to right, var(--c1), var(--c2)); }
    .brand-ring { box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.16); }
  </style>
</head>
    <body class="min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-lg glass rounded-2xl p-6 relative overflow-hidden transition-all duration-500" id="main-container">
    <div class="absolute top-0 left-0 w-full h-1 brand-bg"></div>

    <div id="header-image" class="hidden w-full h-24 rounded-xl mb-4 bg-slate-800/40 border border-white/5 overflow-hidden bg-cover bg-center"></div>

    <div class="text-center mb-6" id="form-header">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/5 text-orange-500 mb-3 overflow-hidden border border-white/10">
            <i id="default-icon" class="fa-solid fa-people-group text-2xl"></i>
            <img id="custom-logo" src="" class="w-full h-full object-cover hidden" alt="logo">
        </div>
        <h1 id="org-name" class="text-2xl font-extrabold brand-text">पार्टी उपस्थिति फॉर्म</h1>
        <p id="org-subtitle" class="text-slate-300/80 text-xs mt-1">Party Attendance</p>
        <p id="org-tagline" class="text-slate-400 text-[11px] mt-2 hidden"></p>
    </div>

      <form id="f" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-slate-300/80 mb-1">मोबाइल नंबर (Mobile)</label>
          <div class="relative">
            <input type="tel" id="mobile" class="w-full rounded-lg px-3 py-2.5 text-sm input-field pl-10" placeholder="10-digit Number" inputmode="numeric" pattern="[0-9]{10}" required>
            <i class="fa-solid fa-phone absolute left-3 top-3 text-slate-500 text-xs"></i>
            <div id="mobile-loader" class="absolute right-3 top-3 hidden">
              <i class="fa-solid fa-circle-notch fa-spin text-orange-400"></i>
            </div>
          </div>
          <p id="user-found-msg" class="text-[10px] text-emerald-400 mt-1 hidden">
            <i class="fa-solid fa-check-circle mr-1"></i> डेटा मिला! विवरण भर दिया गया है।
          </p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-300/80 mb-1">नाम</label>
            <input type="text" id="name" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" placeholder="Name" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-300/80 mb-1">पद</label>
            <input type="text" id="designation" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" placeholder="Designation">
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-300/80 mb-1">कार्यक्रम का नाम</label>
          <div class="relative">
            <select id="program_name" class="w-full rounded-lg px-3 py-2.5 text-sm input-field appearance-none" required>
              <option value="">— कार्यक्रम चुनें —</option>
              <option value="कार्यक्रम-1">कार्यक्रम-1</option>
            </select>
            <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-slate-500 text-xs pointer-events-none"></i>
          </div>
          <p class="text-[10px] text-slate-400 mt-1">नये कार्यक्रम का नाम एडमिन कंसोल से सेट होगा।</p>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-300/80 mb-1">जिला</label>
          <select id="district" class="w-full rounded-lg px-3 py-2.5 text-sm input-field">
            <option value="">— जिला चुनें —</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-300/80 mb-1">विधानसभा</label>
            <select id="vidhansabha" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" disabled>
              <option value="">— पहले जिला चुनें —</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-300/80 mb-1">मंडल</label>
            <select id="mandal" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" disabled>
              <option value="">— पहले विधानसभा चुनें —</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-300/80 mb-1">तारीख</label>
            <input type="date" id="attendance_date" class="w-full rounded-lg px-3 py-2.5 text-sm input-field">
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-300/80 mb-1">समय</label>
            <input type="time" id="attendance_time" class="w-full rounded-lg px-3 py-2.5 text-sm input-field">
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-300/80 mb-1">टिप्पणी</label>
          <textarea id="remarks" rows="3" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" placeholder="Remarks / Notes"></textarea>
        </div>

        <button type="submit" id="submitBtn" class="w-full brand-bg text-white font-extrabold py-3 rounded-xl shadow-lg shadow-orange-500/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2 hover:opacity-95">
          <span>सुरक्षित करें (Save)</span><i class="fa-solid fa-paper-plane text-xs"></i>
        </button>
      </form>

    <div id="status" class="mt-4 text-center text-xs font-medium hidden"></div>
    <div class="mt-4 text-center text-[11px] text-slate-400/80">
      <span id="footer-text"></span>
    </div>
</div>

    <!-- SUCCESS SCREEN -->
<div id="success-screen" class="hidden w-full max-w-lg glass rounded-2xl p-8 text-center flex flex-col items-center justify-center min-h-[420px]">
    <div class="w-20 h-20 bg-emerald-500/15 text-emerald-400 rounded-full flex items-center justify-center mb-6 text-4xl shadow-lg shadow-emerald-500/10 border border-emerald-500/20">
        <i class="fa-solid fa-check"></i>
    </div>
    <h2 class="text-2xl font-extrabold text-white mb-2">धन्यवाद!</h2>
    <p id="success-msg" class="text-slate-200/90 mb-8 leading-relaxed">उपस्थिति की जानकारी सेव कर ली गई है।</p>
    <button onclick="window.location.reload()" class="px-6 py-2.5 bg-white/10 hover:bg-white/15 border border-white/10 rounded-lg text-sm text-white transition">
        <i class="fa-solid fa-rotate-right mr-2"></i> नया फॉर्म
    </button>
</div>

    <script>
    // ===============================
// COMMON CONFIG & UTILS
// ===============================
const API_ID = "vxid0yoovj";
const AWS_REGION = "ap-south-1";
const BASE_URL = `https://${API_ID}.execute-api.${AWS_REGION}.amazonaws.com/prod`;

const $ = (id) => document.getElementById(id);
const qs = (n) => { try { return (new URL(window.location.href)).searchParams.get(n) || ""; } catch (e) { return ""; } };
const token = (qs("token") || "").trim();
const cidParam = (qs("cid") || qs("collection_id") || qs("id") || "").trim();
const levelParam = (qs("level") || "").trim().toLowerCase(); // district | vidhansabha | mandal
const debug = (qs("debug") || "").trim() === "1";

function isPublicMode() { return !!token; }

function setThemeVars(c1, c2) {
  if (c1) document.documentElement.style.setProperty("--c1", c1);
  if (c2) document.documentElement.style.setProperty("--c2", c2);
}
function setBackgroundImage(url) {
  if (!url) return;
  document.documentElement.style.setProperty("--bgimg", `url('${url}')`);
}

function showStatus(msg, isError) {
  const el = $("status");
  if (!el) return;
  el.classList.remove("hidden","text-green-400","text-red-400");
  el.classList.add(isError ? "text-red-400" : "text-green-400");
  el.textContent = msg || "";
  if (!msg) el.classList.add("hidden");
}

async function apiCall(action, payload) {
  const path = isPublicMode() ? "/political/public/forms" : "/political/forms";
  const url = `${BASE_URL}${path}`;
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, payload: payload || {} })
  });
  const text = await res.text();
  let data = {};
  try { data = JSON.parse(text); } catch(e) { data = { message: text || "Invalid JSON" }; }
  if (!res.ok) throw new Error(data.message || data.error || `HTTP ${res.status}`);
  return data;
}

function safeStr(v) { return (v === null || v === undefined) ? "" : String(v); }

async function sha256Hex(file) {
  const buffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function uploadToS3(url, file) {
  await fetch(url, { method: "PUT", body: file, headers: { "Content-Type": file.type || "application/octet-stream" } });
}

function mergeObj(a, b) {
  const out = Object.assign({}, a || {});
  Object.keys(b || {}).forEach(k => {
    if (b[k] && typeof b[k] === "object" && !Array.isArray(b[k])) out[k] = mergeObj(out[k], b[k]);
    else out[k] = b[k];
  });
  return out;
}

// ===============================
// BRANDING + PROGRAMS + FIXED LEVEL
// ===============================
async function loadRemoteConfig(formType) {
  try {
    const payload = {
      cid: CID,
      collection_id: CID,
      form_type: formType,
      token: TOKEN,
    };
    // IMPORTANT: return FULL response (it contains: settings, config, form, form_type)
    const res = await apiCallPublic("public_get_config", payload);
    return res || null;
  } catch (e) {
    console.error("loadRemoteConfig failed:", e);
    return null;
  }
}

function safeStr(x) {
  return (x === undefined || x === null) ? "" : String(x);
}

// ---------- Helpers to read NEW API shape ----------
function getDefaultsNode(resp) {
  return (resp && resp.settings && resp.settings.defaults) ||
         (resp && resp.config && resp.config.defaults) ||
         null;
}

function getGlobalNode(resp) {
  return (resp && resp.settings && resp.settings.global) ||
         (resp && resp.config && resp.config.global) ||
         null;
}

function getFormNode(resp, formType) {
  if (!resp) return null;

  // Backend already returns resolved `form`
  if (resp.form && typeof resp.form === "object") return resp.form;

  const ft = formType || resp.form_type || FORM_TYPE;

  if (resp.settings && resp.settings.forms && resp.settings.forms[ft]) return resp.settings.forms[ft];
  if (resp.config && resp.config.forms && resp.config.forms[ft]) return resp.config.forms[ft];

  return null;
}

function pickAssetUrl(assetObj, fallbackUrl) {
  if (!assetObj) return safeStr(fallbackUrl || "");
  if (typeof assetObj === "string") return assetObj;
  return safeStr(assetObj.url || fallbackUrl || "");
}

function pickBranding(resp, formNode) {
  const defaults = getDefaultsNode(resp) || {};
  // form branding > defaults branding > empty
  return (formNode && formNode.branding) || defaults.branding || {};
}

function applyBrandingFromResponse(resp, formType) {
  const formNode = getFormNode(resp, formType) || {};
  const branding = pickBranding(resp, formNode);
  const globalNode = getGlobalNode(resp) || {};
  const globalTheme = globalNode.theme || {};

  // Text
  const orgNameEl = $("org-name");
  const orgSubtitleEl = $("org-subtitle");
  const orgTaglineEl = $("org-tagline");
  if (orgNameEl) orgNameEl.textContent = safeStr(formNode.title || orgNameEl.textContent);
  if (orgSubtitleEl) orgSubtitleEl.textContent = safeStr(formNode.subtitle || orgSubtitleEl.textContent);
  if (orgTaglineEl) orgTaglineEl.textContent = safeStr(formNode.tagline || branding.tagline || orgTaglineEl.textContent);

  // Footer
  const footerTextEl = $("footer-text");
  if (footerTextEl) footerTextEl.textContent = safeStr(globalNode.tagline || "Powered by EventLens");

  // Images (use signed URLs if present)
  const logoUrl = pickAssetUrl(branding.logo, formNode.logo_url);
  const headerUrl = pickAssetUrl(branding.header, formNode.header_url);
  const bgUrl = pickAssetUrl(branding.background, formNode.background_url);

  const logoEl = $("custom-logo");
  if (logoEl && logoUrl) {
    logoEl.src = logoUrl;
    logoEl.classList.remove("hidden");
  }

  const headerEl = $("header-image");
  if (headerEl && headerUrl) {
    headerEl.src = headerUrl;
    headerEl.classList.remove("hidden");
  }

  // Optional background image
  if (bgUrl) {
    document.body.style.backgroundImage = `url('${bgUrl}')`;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundPosition = "center";
    document.body.style.backgroundAttachment = "fixed";
  }

  // Optional theme colors: if you later wire CSS vars, these are ready
  const primary = branding.color1 || globalTheme.primary || "#f97316";
  const secondary = branding.color2 || globalTheme.secondary || "#ef4444";
  const background = globalTheme.background || "#0f172a";
  document.documentElement.style.setProperty("--brand-primary", primary);
  document.documentElement.style.setProperty("--brand-secondary", secondary);
  document.documentElement.style.setProperty("--brand-background", background);
}

function fillProgramNamesFromResponse(resp, formType, selectId) {
  const select = $(selectId);
  if (!select) return;

  const firstOpt = select.querySelector("option") ? select.querySelector("option").outerHTML : '<option value="">Select Program</option>';
  select.innerHTML = firstOpt;

  const formNode = getFormNode(resp, formType) || {};
  const defaults = getDefaultsNode(resp) || {};

  const list =
    (Array.isArray(formNode.program_options) && formNode.program_options) ||
    (Array.isArray(formNode.programs) && formNode.programs) ||
    (Array.isArray(defaults.programs) && defaults.programs) ||
    [];

  const uniq = [...new Set(list.map(x => safeStr(x).trim()).filter(Boolean))];
  uniq.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  });
}

// Kept for compatibility (if you add fixed_level dropdown later)
function getFixedLevelFromResponse(resp, formType) {
  const formNode = getFormNode(resp, formType) || {};
  if (formNode.fixed_level) return safeStr(formNode.fixed_level);

  const defaults = getDefaultsNode(resp) || {};
  const fixedLevels = defaults.fixed_levels || {};
  return safeStr(fixedLevels[formType] || fixedLevels["party_attendance"] || "");
}

function applyFixedLevelFromResponse(resp, formType) {
  const levelSelect = $("fixed_level");
  if (!levelSelect) return;

  const level = getFixedLevelFromResponse(resp, formType);
  if (level) {
    levelSelect.value = level;
    levelSelect.disabled = true;
  }
}


const FORM_TYPE = "party_attendance";
    const FIELD_IDS = ["mobile","name","designation","program_name","district","vidhansabha","mandal","attendance_date","attendance_time","remarks"];

    const DISTRICT_DATA = {
"मंदसौर": {
    "मंदसौर": ["मंदसौर नगर उत्तर", "मंदसौर नगर दक्षिण", "मंदसौर ग्रामीण"],
    "सुवासरा": ["सीतामऊ", "सुवासरा", "शामगढ़"],
    "गरोठ": ["गरोठ", "भानपुरा", "मेलखेड़ा"],
    "मल्हारगढ़": ["मल्हारगढ़", "नारायणगढ़", "पिपलियामंडी"]
},
"रतलाम": {
    "रतलाम सिटी": ["दीनदयाल नगर", "अम्बेडकर नगर", "श्यामा प्रसाद मुखर्जी नगर"],
    "रतलाम ग्रामीण": ["धराड़", "बांगरोद", "नामली"],
    "सैलाना": ["सैलाना", "बाजना", "रावटी"],
    "जावरा": ["जावरा नगर", "जावरा ग्रामीण", "पिप्लौदा"],
    "आलोट": ["आलोट", "बड़ावदा", "ताल"]
},
"नीमच": {
    "नीमच": ["नीमच उत्तर", "नीमच दक्षिण", "नीमच पश्चिम", "जीरन"],
    "मनासा": ["मनासा", "रामपुरा", "कुकाड़ेश्वर"],
    "जावद": ["जावद", "सिंगोली", "रतनगढ़"]
},
"उज्जैन": {
    "उज्जैन उत्तर": ["दौलतगंज", "नई सड़क", "फ्रीगंज"],
    "उज्जैन दक्षिण": ["महानंदा", "नानाखेड़ा", "कोठी रोड"],
    "घट्टिया": ["घट्टिया", "उन्हेल", "पानबिहार"],
    "तराना": ["तराना", "माकड़ोन", "कायथा"],
    "महिदपुर": ["महिदपुर नगर", "महिदपुर ग्रामीण", "झारड़ा"],
    "नागदा-खाचरौद": ["नागदा", "खाचरौद", "बिरलाग्राम"],
    "बड़नगर": ["बड़नगर", "इंगोरिया", "खरसौद"]
},
"आगर-मालवा": {
    "आगर": ["आगर नगर", "आगर ग्रामीण", "बड़ौद"],
    "सुसनेर": ["सुसनेर", "नलखेड़ा", "सोयत"]
},
"शाजापुर": {
    "शाजापुर": ["शाजापुर नगर", "शाजापुर ग्रामीण", "मो. बड़ोदिया"],
    "शुजालपुर": ["शुजालपुर मंडी", "शुजालपुर सिटी", "अकोदिया"],
    "कालापीपल": ["कालापीपल", "पोलायकलां", "खोकराकलां"]
},
"देवास": {
    "देवास": ["देवास उत्तर", "देवास दक्षिण", "देवास पश्चिम"],
    "सोनकच्छ": ["सोनकच्छ", "टोंकखुर्द", "पीपलरावां"],
    "हाटपिपल्या": ["हाटपिपल्या", "नेवरी", "करनावाद"],
    "खातेगांव": ["खातेगांव", "कन्नौद", "हरणगांव"],
    "बागली": ["बागली", "उदयनगर", "सतवास"]
},
"इंदौर": {
    "इंदौर-1": ["वार्ड 1-5", "वार्ड 6-10", "वार्ड 11-15"],
    "इंदौर-2": ["वार्ड 16-20", "वार्ड 21-25", "वार्ड 26-30"],
    "इंदौर-3": ["वार्ड 31-35", "वार्ड 36-40", "वार्ड 41-45"],
    "इंदौर-4": ["वार्ड 46-50", "वार्ड 51-55", "वार्ड 56-60"],
    "इंदौर-5": ["वार्ड 61-65", "वार्ड 66-70", "वार्ड 71-75"],
    "राऊ": ["राऊ नगर", "तेजाजी नगर", "दत्तौदा"],
    "महू": ["महू नगर", "महू ग्रामीण", "मानपुर"],
    "देपालपुर": ["देपालपुर", "गौतमपुरा", "बेटमा"],
    "सांवेर": ["सांवेर", "चंद्रावतीगंज", "क्षिप्रा"]
},
"धार": {
    "धार": ["धार नगर", "धार ग्रामीण", "तिरला"],
    "पीथमपुर": ["पीथमपुर", "सागौर", "नालछा"],
    "बदनावर": ["बदनावर", "कानवन", "मुलथान"],
    "सरदारपुर": ["सरदारपुर", "राजगढ़", "अमझेरा"],
    "गंधवानी": ["गंधवानी", "बाग", "टांडा"],
    "कुक्षी": ["कुक्षी", "डही", "निसरपुर"],
    "मनावर": ["मनावर", "उमरबन", "सिंघाना"],
    "धरमपुरी": ["धरमपुरी", "धामनोद", "मांडू"]
},
"झाबुआ": {
    "झाबुआ": ["झाबुआ नगर", "झाबुआ ग्रामीण", "रामा"],
    "थांदला": ["थांदला", "खवासा", "मेघनगर"],
    "पेटलावद": ["पेटलावद", "रायपुरिया", "सारंगी"]
},
"अलीराजपुर": {
    "अलीराजपुर": ["अलीराजपुर नगर", "अलीराजपुर ग्रामीण", "सोंडवा"],
    "जोबट": ["जोबट", "उदयगढ़", "भाबरा"]
},
"खरगोन": {
    "खरगोन": ["खरगोन नगर", "खरगोन ग्रामीण", "सनावद"],
    "भीकनगांव": ["भीकनगांव", "झिरन्या", "गोगावां"],
    "बड़वाह": ["बड़वाह", "महेश्वर", "करही"],
    "महेश्वर": ["महेश्वर", "मंडलेश्वर", "धामनोद"],
    "कसरावद": ["कसरावद", "पिपलगोन", "बालकवाड़ा"],
    "भगवानपुरा": ["भगवानपुरा", "सेगांव", "बिस्टान"]
},
"बड़वानी": {
    "बड़वानी": ["बड़वानी नगर", "बड़वानी ग्रामीण", "पाटी"],
    "सेंधवा": ["सेंधवा नगर", "सेंधवा ग्रामीण", "चाचरीया"],
    "राजपुर": ["राजपुर", "ठीकरी", "अंजड़"],
    "पानसेमल": ["पानसेमल", "खेतिया", "निवाली"]
},
"खंडवा": {
    "खंडवा": ["खंडवा नगर", "खंडवा ग्रामीण", "छैगांवमाखन"],
    "पंधाना": ["पंधाना", "सिंघोट", "आरुद"],
    "मांधाता": ["मांधाता", "पुनासा", "मूंदी"],
    "हरसूद": ["हरसूद", "खालवा", "किल्लोद"]
},
"बुरहानपुर": {
    "बुरहानपुर": ["बुरहानपुर नगर", "बुरहानपुर ग्रामीण", "शाहपुर"],
    "नेपानगर": ["नेपानगर", "धुलकोट", "खकनार"]
}
};
    // ===============================
// LOCATION HELPERS (district -> vidhansabha -> mandal)
// ===============================
function initDistrictCascade() {
  const dEl = $("district");
  const vEl = $("vidhansabha");
  const mEl = $("mandal");
  if (!dEl || !vEl || !mEl) return;

  // Populate Districts
  dEl.innerHTML = '<option value="">— जिला चुनें —</option>';
  Object.keys(DISTRICT_DATA).sort((a,b)=>a.localeCompare(b,"hi")).forEach((d) => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    dEl.appendChild(opt);
  });

  dEl.addEventListener("change", () => {
    const dVal = dEl.value;
    vEl.innerHTML = '<option value="">— विधानसभा चुनें —</option>';
    mEl.innerHTML = '<option value="">— पहले विधानसभा चुनें —</option>';
    vEl.disabled = !dVal;
    mEl.disabled = true;

    if (dVal && DISTRICT_DATA[dVal]) {
      Object.keys(DISTRICT_DATA[dVal]).sort((a,b)=>a.localeCompare(b,"hi")).forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        vEl.appendChild(opt);
      });
    }
  });

  vEl.addEventListener("change", () => {
    const dVal = dEl.value;
    const vVal = vEl.value;
    mEl.innerHTML = '<option value="">— मंडल चुनें —</option>';
    mEl.disabled = !vVal;

    if (dVal && vVal && DISTRICT_DATA[dVal] && DISTRICT_DATA[dVal][vVal]) {
      DISTRICT_DATA[dVal][vVal].slice().sort((a,b)=>a.localeCompare(b,"hi")).forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        mEl.appendChild(opt);
      });
    }
  });
}

function applyLocationAutofill(info) {
  // info: {district, vidhansabha, mandal}
  if (!info) return;
  const d = safeStr(info.district).trim();
  const v = safeStr(info.vidhansabha).trim();
  const m = safeStr(info.mandal).trim();

  if (d && $("district")) {
    $("district").value = d;
    $("district").dispatchEvent(new Event("change"));
    setTimeout(() => {
      if (v && $("vidhansabha")) {
        $("vidhansabha").value = v;
        $("vidhansabha").dispatchEvent(new Event("change"));
        setTimeout(() => {
          if (m && $("mandal")) $("mandal").value = m;
        }, 120);
      }
    }, 120);
  }
}

    let remoteCfg = null;

    async function initAll() {
  // remote config (branding + programs)
  const remoteResp = await loadRemoteConfig(FORM_TYPE);
  if (remoteResp) {
    applyBrandingFromResponse(remoteResp, FORM_TYPE);
    fillProgramNamesFromResponse(remoteResp, FORM_TYPE, "program_name");
    applyFixedLevelFromResponse(remoteResp, FORM_TYPE);
  }

  // init district cascade after config load (no change)
  initDistrictCascade();

  // init mobile lookup
  initMobileLookup();

  // init submit
  initSubmit();
}


    document.addEventListener("DOMContentLoaded", initAll);

    // Mobile Auto-fill
    let mobileTimer = null;
    async function tryLookupMobile() {
      const mobile = ($("mobile").value || "").trim();
      if (mobile.length !== 10) return;

      $("mobile-loader").classList.remove("hidden");
      $("user-found-msg").classList.add("hidden");

      try {
        const payload = isPublicMode()
          ? { token, form_type: FORM_TYPE, mobile }
          : { collection_id: cidParam, form_type: FORM_TYPE, mobile };
        const action = isPublicMode() ? "public_lookup_mobile" : "lookup_mobile";
        const res = await apiCall(action, payload);

        const info = res && (res.profile || res.data || res);
        if (info && (info.name || info.designation || info.district || info.vidhansabha || info.mandal)) {
          if (info.name) $("name").value = info.name;
          if (info.designation) $("designation").value = info.designation;
          applyLocationAutofill(info);
          $("user-found-msg").classList.remove("hidden");
        }
      } catch (e) {
        if (debug) console.log("lookup failed", e);
      } finally {
        $("mobile-loader").classList.add("hidden");
      }
    }

    $("mobile").addEventListener("input", () => {
      clearTimeout(mobileTimer);
      $("user-found-msg").classList.add("hidden");
      const m = ($("mobile").value || "").trim();
      if (m.length === 10) mobileTimer = setTimeout(tryLookupMobile, 500);
    });
    $("mobile").addEventListener("blur", () => {
      clearTimeout(mobileTimer);
      tryLookupMobile();
    });

    // Submit (NO PHOTO)
    $("f").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = $("submitBtn");
      const old = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
      showStatus("", false);

      try {
        const data = {};
        FIELD_IDS.forEach((id) => {
          const el = $(id);
          if (el) data[id] = (el.value || "").trim();
        });

        if (!data.program_name) throw new Error("कृपया कार्यक्रम चुनें");
        if (!data.district) throw new Error("कृपया जिला चुनें");
        if (!data.vidhansabha) throw new Error("कृपया विधानसभा चुनें");

        let res;
        if (isPublicMode()) {
          res = await apiCall("public_create_entry", {
            token,
            form_type: FORM_TYPE,
            file_kind: "none",
            payload: data
          });
        } else {
          if (!cidParam) throw new Error("Missing Collection ID (cid)");
          res = await apiCall("create_entry", {
            collection_id: cidParam,
            form_type: FORM_TYPE,
            file_kind: "none",
            payload: data
          });
        }

        const finalizeAction = isPublicMode() ? "public_finalize_entry" : "finalize_entry";
        await apiCall(finalizeAction, { finalize_token: res.finalize_token, entry_id: res.entry_id });

        $("main-container").classList.add("hidden");
        $("success-screen").classList.remove("hidden");
      } catch (err) {
        showStatus("❌ " + (err.message || "Error"), true);
        btn.disabled = false;
        btn.innerHTML = old;
      }
    });
    </script>
    </body>
    </html>
