<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‚Äî EventLens</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800;900&family=Noto+Sans+Devanagari:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --saf:#ff6b00;
  --saf2:#ff8c00;
  --saf3:#ffb347;
  --gold:#ffd700;
  --cream:#fff8f0;
  --warm-white:#fffdf9;
  --bg:#fff5e6;
  --card:#ffffff;
  --text:#1a0a00;
  --muted:#7a5c3a;
  --border:#ffcf98;
  --success:#1a7a3a;
  --success-bg:#e6f7ec;
  --danger:#c0392b;
}
html,body{min-height:100%;background:var(--bg);}
body{
  font-family:'Baloo 2','Noto Sans Devanagari',sans-serif;
  color:var(--text);
  background:
    radial-gradient(ellipse 90% 50% at 50% -10%, rgba(255,107,0,0.12), transparent 60%),
    var(--bg);
  background-attachment:fixed;
}
.deva{font-family:'Noto Sans Devanagari','Baloo 2',sans-serif;}

/* ‚îÄ‚îÄ HEADER STRIP (center title/subtitle) ‚îÄ‚îÄ */
.top-strip{
  background:linear-gradient(135deg,var(--saf),var(--saf2));
  padding:12px 12px 10px;
  box-shadow:0 3px 12px rgba(255,107,0,0.3);
  position:sticky;top:0;z-index:100;
  display:grid;
  grid-template-columns:52px 1fr 52px;
  align-items:center;
  gap:8px;
}
.hdr-left,.hdr-right{width:52px;height:44px;display:flex;align-items:center;}
.hdr-left{justify-content:flex-start;}
.hdr-right{justify-content:flex-end;}
.title-wrap{ text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.title-wrap .t1{font-size:17px;font-weight:900;color:#fff;line-height:1.1;}
.title-wrap .t2{font-size:11px;color:rgba(255,255,255,0.8);}
.logo-wrap{
  width:44px;height:44px;border-radius:12px;
  background:rgba(255,255,255,0.2);
  border:2px solid rgba(255,255,255,0.4);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;flex-shrink:0;
}

/* Header banner */
.header-banner-wrap{ width:100%; max-width:420px; margin:0 auto; padding:12px 12px 0; }
.header-banner{
  width:100%; height:120px; object-fit:cover; display:block;
  border-radius:18px;
  border:2px solid var(--border);
  box-shadow:0 4px 20px rgba(255,107,0,0.14), 0 1px 4px rgba(0,0,0,0.06);
  background:#fff;
}
@media (max-width:360px){ .header-banner{height:108px;} }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{
  background:var(--card);
  border-radius:20px;
  box-shadow:0 4px 24px rgba(255,107,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
  border:2px solid var(--border);
  overflow:hidden;
}
.card-header{
  background:linear-gradient(135deg, rgba(255,107,0,0.08), rgba(255,180,71,0.06));
  border-bottom:2px solid var(--border);
  padding:14px 16px;
  display:flex;align-items:center;gap:10px;
}
.card-header .icon{
  width:38px;height:38px;border-radius:11px;
  background:linear-gradient(135deg,var(--saf),var(--saf2));
  color:#fff;display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;
  box-shadow:0 3px 10px rgba(255,107,0,0.35);
}
.card-header .htxt{font-size:15px;font-weight:800;color:var(--text);}
.card-header .hsub{font-size:11px;color:var(--muted);margin-top:1px;}

/* ‚îÄ‚îÄ CAMERA BOX ‚îÄ‚îÄ */
#cam-box{position:relative;width:100%;aspect-ratio:1/1;background:#111;overflow:hidden;}
#cam-video{width:100%;height:100%;object-fit:cover;display:block;}
#cam-canvas{display:none;}

.oval-guide{position:absolute;inset:0;pointer-events:none;}
.oval-guide ellipse{fill:none;stroke:rgba(255,180,71,0.9);stroke-width:3;filter:drop-shadow(0 0 10px rgba(255,107,0,0.8));transition:stroke .3s,filter .3s;}
.oval-guide ellipse.scanning{stroke:#ffd700;animation:ov-pulse 1s infinite;}
.oval-guide ellipse.matched{stroke:#22c55e;filter:drop-shadow(0 0 14px #22c55e);}
@keyframes ov-pulse{0%,100%{opacity:1}50%{opacity:.3}}

.scanline{position:absolute;left:12%;right:12%;height:2px;pointer-events:none;background:linear-gradient(90deg,transparent,rgba(255,140,0,.9),transparent);animation:scan-move 2s linear infinite;}
@keyframes scan-move{0%{top:20%}100%{top:78%}}

.cm{position:absolute;width:24px;height:24px;border-color:rgba(255,140,0,.7);border-style:solid;}
.cm.tl{top:12px;left:12px;border-width:3px 0 0 3px;border-radius:6px 0 0 0;}
.cm.tr{top:12px;right:12px;border-width:3px 3px 0 0;border-radius:0 6px 0 0;}
.cm.bl{bottom:12px;left:12px;border-width:0 0 3px 3px;border-radius:0 0 0 6px;}
.cm.br{bottom:12px;right:12px;border-width:0 3px 3px 0;border-radius:0 0 6px 0;}

#status-chip{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:7px;
  padding:7px 16px;border-radius:99px;
  font-size:13px;font-weight:700;
  background:rgba(0,0,0,.75);backdrop-filter:blur(8px);
  color:#fff;white-space:nowrap;z-index:10;
  border:1px solid rgba(255,140,0,.35);
  transition:all .3s;
}
#status-dot{width:9px;height:9px;border-radius:50%;background:var(--saf);flex-shrink:0;}
#status-dot.scanning{background:#ffd700;animation:blink .7s infinite;}
#status-dot.matched{background:#22c55e;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.1}}

#flip-btn{
  position:absolute;top:12px;right:12px;z-index:20;
  width:40px;height:40px;border-radius:50%;
  background:rgba(0,0,0,.65);backdrop-filter:blur(8px);
  border:1px solid rgba(255,140,0,.3);
  color:#ffb347;font-size:15px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
}

.capture-area{padding:20px 16px 16px;background:linear-gradient(180deg, #fff9f2 0%, #fff5e6 100%);border-top:2px solid var(--border);}
#cap-btn{
  width:100%;padding:18px 24px;
  border-radius:16px;border:none;cursor:pointer;
  background:linear-gradient(135deg, var(--saf), #e65500);
  color:#fff;
  font-family:'Noto Sans Devanagari','Baloo 2',sans-serif;
  font-size:20px;font-weight:900;
  display:flex;align-items:center;justify-content:center;gap:12px;
  box-shadow:0 8px 28px rgba(255,107,0,0.45), 0 2px 6px rgba(0,0,0,0.12);
  transition:transform .12s, box-shadow .12s;
  letter-spacing:.01em;
  -webkit-tap-highlight-color:transparent;
}
#cap-btn:active{transform:scale(.96);box-shadow:0 3px 12px rgba(255,107,0,0.35);}
#cap-btn .cam-icon{font-size:28px;}
.cap-hint{text-align:center;margin-top:10px;font-size:13px;color:var(--muted);font-weight:600;}

#prev-box{display:none;position:relative;}
#prev-box img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;}
#retake-btn{position:absolute;top:12px;right:12px;background:rgba(220,50,50,.9);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;}

#proc-overlay{display:none;position:absolute;inset:0;z-index:50;background:rgba(255,245,230,.9);backdrop-filter:blur(4px);align-items:center;justify-content:center;flex-direction:column;gap:12px;}
#proc-overlay.show{display:flex;}
.proc-spinner{width:56px;height:56px;border-radius:50%;border:5px solid rgba(255,107,0,.2);border-top-color:var(--saf);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.proc-txt{font-size:16px;font-weight:800;color:var(--saf);}

#gal-btn{
  width:100%;padding:13px;border-radius:14px;cursor:pointer;
  background:#fff;border:2px solid var(--border);
  color:var(--saf);font-size:15px;font-weight:700;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:background .15s;
  -webkit-tap-highlight-color:transparent;
}
#gal-btn:active{background:#fff5e6;}

.form-wrap{background:var(--warm-white);border-radius:20px;overflow:hidden;box-shadow:0 4px 24px rgba(255,107,0,0.12);border:2px solid var(--border);}
.lbl{display:block;font-size:12px;font-weight:800;color:var(--saf);margin-bottom:5px;letter-spacing:.03em;text-transform:uppercase;}
.inp{
  width:100%;padding:14px 15px;border-radius:13px;
  font-size:16px;font-family:'Noto Sans Devanagari','Baloo 2',sans-serif;
  background:#fff;border:2px solid var(--border);
  color:var(--text);outline:none;
  transition:border-color .2s, box-shadow .2s;
  font-weight:600;
}
.inp::placeholder{color:#c8a87a;font-weight:400;}
.inp:focus{border-color:var(--saf);box-shadow:0 0 0 4px rgba(255,107,0,0.1);}
.inp:disabled{opacity:.5;background:#faf3ea;}
select.inp option{background:#fff;color:var(--text);}

.submit-btn{
  width:100%;padding:18px;border-radius:16px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--saf),#e65500);
  color:#fff;font-size:20px;font-weight:900;
  font-family:'Noto Sans Devanagari','Baloo 2',sans-serif;
  display:flex;align-items:center;justify-content:center;gap:10px;
  box-shadow:0 8px 28px rgba(255,107,0,0.4);
  transition:transform .12s, box-shadow .12s;
  -webkit-tap-highlight-color:transparent;
}
.submit-btn:active{transform:scale(.97);}
.submit-btn:disabled{opacity:.5;transform:none;}

.back-btn{display:flex;align-items:center;gap:8px;padding:10px 14px;background:#fff;border:2px solid var(--border);border-radius:11px;color:var(--saf);font-size:14px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent;}

#scr-ok{display:none;}
.ok-card{background:linear-gradient(160deg, #fff9f2, #fff5e6);border-radius:24px;border:3px solid #22c55e;text-align:center;padding:36px 24px 32px;box-shadow:0 8px 40px rgba(34,197,94,0.2);}
.ok-icon{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg, #22c55e, #16a34a);display:flex;align-items:center;justify-content:center;font-size:44px;margin:0 auto 20px;box-shadow:0 8px 28px rgba(34,197,94,0.4);animation:pop-in .4s cubic-bezier(.17,.89,.32,1.28);}
@keyframes pop-in{from{transform:scale(.4);opacity:0}to{transform:scale(1);opacity:1}}
.ok-name{font-size:28px;font-weight:900;color:var(--text);margin-bottom:4px;line-height:1.2;}
.ok-msg{font-size:16px;color:#2d6a4a;font-weight:600;margin-bottom:6px;}
.ok-sub{font-size:13px;color:var(--muted);margin-bottom:28px;}
.new-btn{width:100%;padding:16px;border-radius:14px;border:none;cursor:pointer;background:linear-gradient(135deg,var(--saf),var(--saf2));color:#fff;font-size:17px;font-weight:800;font-family:'Noto Sans Devanagari','Baloo 2',sans-serif;box-shadow:0 6px 20px rgba(255,107,0,0.4);-webkit-tap-highlight-color:transparent;}

#confirm-overlay{position:fixed;inset:0;z-index:9000;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);padding:16px;}
#confirm-overlay.open{display:flex;}
.confirm-card{width:100%;max-width:420px;background:linear-gradient(160deg, #fff9f2, #fff5e6);border-radius:28px;border:3px solid #22c55e;padding:36px 24px 28px;text-align:center;box-shadow:0 24px 80px rgba(0,0,0,.4), 0 0 0 1px rgba(34,197,94,.3);animation:sheet-up .35s cubic-bezier(.22,.8,.28,1);position:relative;}
@keyframes sheet-up{from{transform:translateY(60px) scale(.97);opacity:0}to{transform:none;opacity:1}}
.confirm-avatar{width:96px;height:96px;border-radius:50%;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;font-size:48px;margin:0 auto 18px;box-shadow:0 8px 30px rgba(34,197,94,.45);animation:pop-in .45s cubic-bezier(.17,.89,.32,1.28);}
.confirm-name{font-size:30px;font-weight:900;color:var(--text);line-height:1.15;margin-bottom:8px;}
.confirm-tag{display:inline-block;padding:6px 16px;border-radius:99px;background:rgba(34,197,94,.12);border:2px solid rgba(34,197,94,.3);color:#166534;font-size:14px;font-weight:700;margin-bottom:18px;}
.confirm-msg{font-size:17px;color:#2d6a4a;font-weight:800;margin-bottom:10px;line-height:1.35;}
.confirm-sub{font-size:13px;color:var(--muted);margin-bottom:14px;line-height:1.6;}
#cfm-audio-hint{display:none;font-size:12px;font-weight:800;color:#14532d;background:rgba(34,197,94,.10);border:2px solid rgba(34,197,94,.25);padding:10px 12px;border-radius:12px;margin:0 0 16px;}
.confirm-wave{position:absolute;bottom:0;left:0;right:0;height:5px;background:linear-gradient(90deg, #22c55e, #86efac, #22c55e);border-radius:0 0 25px 25px;animation:wave-move 2s linear infinite;background-size:200%;}
@keyframes wave-move{from{background-position:0%}to{background-position:200%}}
.close-confirm-btn{width:100%;padding:16px;border-radius:14px;border:none;cursor:pointer;background:linear-gradient(135deg,var(--saf),var(--saf2));color:#fff;font-size:17px;font-weight:900;font-family:'Noto Sans Devanagari','Baloo 2',sans-serif;box-shadow:0 6px 20px rgba(255,107,0,.4);-webkit-tap-highlight-color:transparent;}

.autofill-badge{display:none;padding:10px 14px;border-radius:12px;background:rgba(34,197,94,.08);border:2px solid rgba(34,197,94,.25);color:#166534;font-size:13px;font-weight:700;margin-bottom:12px;}
#mob-found{display:none;font-size:12px;font-weight:700;color:var(--success);margin-top:5px;padding:6px 10px;background:var(--success-bg);border-radius:8px;}
#f-status{display:none;text-align:center;font-size:14px;font-weight:700;padding:12px;border-radius:12px;margin-top:4px;}

#offline-banner{display:none;position:fixed;top:0;left:0;right:0;z-index:8000;background:var(--saf);color:#fff;font-size:12px;font-weight:700;padding:8px 16px;text-align:center;}
#offline-banner.on{display:block;}

#scr-cam{display:block;}
#scr-form{display:none;}
#scr-ok{display:none;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:rgba(255,107,0,.3);border-radius:2px;}

.wrap{width:100%;max-width:420px;margin:0 auto;padding:0 12px 48px;}
</style>
</head>
<body>

<div id="offline-banner">üìµ Offline ‚Äî ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡•á‡§µ ‡§π‡•à</div>

<!-- ‚ïê‚ïê‚ïê CAMERA SCREEN ‚ïê‚ïê‚ïê -->
<div id="scr-cam">

  <!-- Header -->
  <div class="top-strip">
    <div class="hdr-left">
      <div class="logo-wrap">
        <i id="default-icon" class="fa-solid fa-people-group" style="font-size:20px;color:#fff;"></i>
        <img id="logo-img" style="width:100%;height:100%;object-fit:contain;display:none;" alt=""/>
      </div>
    </div>
    <div class="title-wrap">
      <div id="org-name" class="t1 deva">‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</div>
      <div id="org-sub" class="t2">Party Attendance</div>
    </div>
    <div class="hdr-right"></div>
  </div>

  <!-- Header image (event banner) -->
  <div id="hdr-cam-img-wrap" class="header-banner-wrap" style="display:none;">
    <img id="hdr-cam-img" class="header-banner" alt=""/>
  </div>

  <div class="wrap" style="padding-top:16px;">

    <!-- Camera Card -->
    <div class="card" style="margin-bottom:12px;">
      <div class="card-header">
        <div class="icon"><i class="fa-solid fa-camera"></i></div>
        <div>
          <div class="htxt deva">‡§ö‡•á‡§π‡§∞‡§æ ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç</div>
          <div class="hsub">Face Scan for Attendance</div>
        </div>
      </div>

      <!-- Camera View -->
      <div style="position:relative;">
        <div id="cam-box">
          <video id="cam-video" autoplay muted playsinline></video>
          <canvas id="cam-canvas"></canvas>
          <svg class="oval-guide" viewBox="0 0 100 100" preserveAspectRatio="none" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;">
            <ellipse id="oval-el" cx="50" cy="50" rx="34" ry="42"/>
          </svg>
          <div class="scanline"></div>
          <div class="cm tl"></div><div class="cm tr"></div>
          <div class="cm bl"></div><div class="cm br"></div>
          <div id="status-chip"><span id="status-dot"></span><span id="status-txt" class="deva">‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•Å‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à...</span></div>
          <button id="flip-btn" onclick="flipCam()"><i class="fa-solid fa-rotate"></i></button>
        </div>

        <!-- Preview box -->
        <div id="prev-box">
          <img id="prev-img" src="" alt=""/>
          <button id="retake-btn" onclick="doRetake()"><i class="fa-solid fa-rotate-left"></i> ‡§´‡§ø‡§∞ ‡§∏‡•á</button>
        </div>

        <!-- Processing overlay -->
        <div id="proc-overlay">
          <div class="proc-spinner"></div>
          <div class="proc-txt deva">‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...</div>
          <div style="font-size:12px;color:var(--muted);font-weight:600;">‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç</div>
        </div>
      </div>

      <!-- Capture Button Area -->
      <div class="capture-area" id="capture-area-wrap">
        <button id="cap-btn" onclick="doCapture()">
          <span class="cam-icon">üì∏</span>
          <span class="deva">‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç ‚Äî ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</span>
        </button>
        <div class="cap-hint deva">
          <i class="fa-solid fa-circle-info" style="color:var(--saf);margin-right:4px;"></i>
          ‡§ö‡•á‡§π‡§∞‡§æ ‡§Ö‡§Ç‡§°‡§æ‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§Ç, ‡§´‡§ø‡§∞ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç
        </div>
      </div>

      <!-- After capture: proceed or retry -->
      <div id="proceed-wrap" style="display:none;padding:16px;">
        <div id="proceed-msg" style="text-align:center;font-size:14px;font-weight:700;color:#166534;background:var(--success-bg);padding:10px;border-radius:10px;margin-bottom:10px;"></div>
        <button class="submit-btn" onclick="gotoForm()">
          <i class="fa-solid fa-arrow-right"></i><span class="deva">‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç</span>
        </button>
      </div>
    </div>

    <!-- Gallery fallback -->
    <label id="gal-btn" style="cursor:pointer;">
      <input id="gal-input" type="file" accept="image/*" capture="user" style="display:none;" onchange="galUpload(event)"/>
      <i class="fa-solid fa-images" style="font-size:18px;"></i>
      <span class="deva">‡§ó‡•à‡§≤‡§∞‡•Ä ‡§∏‡•á ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</span>
    </label>

    <div id="footer-cam" style="text-align:center;font-size:11px;color:#c8a87a;margin-top:16px;font-weight:600;">Powered by EventLens</div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê FORM SCREEN ‚ïê‚ïê‚ïê -->
<div id="scr-form">
  <!-- Header -->
  <div class="top-strip">
    <div class="hdr-left">
      <button class="back-btn" onclick="goCam()" style="background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.4);color:#fff;padding:8px 12px;">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
    </div>
    <div class="title-wrap">
      <div class="t1 deva">‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç</div>
      <div class="t2">Fill Your Details</div>
    </div>
    <div class="hdr-right"></div>
  </div>

  <!-- Form Header image -->
  <div id="form-hdr-img-wrap" class="header-banner-wrap" style="display:none;">
    <img id="form-hdr-img" class="header-banner" alt=""/>
  </div>

  <div class="wrap" style="padding-top:16px;">
    <div class="form-wrap">
      <div style="padding:20px;">

        <div id="autofill-badge" class="autofill-badge deva">
          <i class="fa-solid fa-wand-magic-sparkles" style="margin-right:6px;"></i>
          <span id="autofill-txt">‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä auto-fill ‡§π‡•ã ‡§ó‡§à</span>
        </div>

        <form id="vform" onsubmit="doSubmit(event)">
          <div style="display:flex;flex-direction:column;gap:14px;">

            <div>
              <label class="lbl deva">üì± ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ *</label>
              <div style="position:relative;">
                <input id="f-mobile" type="tel" class="inp" placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞" inputmode="numeric" maxlength="10" required style="padding-left:44px;"/>
                <i class="fa-solid fa-phone" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--saf);"></i>
                <div id="mob-spin" style="display:none;position:absolute;right:14px;top:50%;transform:translateY(-50%);"><i class="fa-solid fa-circle-notch" style="color:var(--saf);font-size:14px;animation:spin 1s linear infinite;"></i></div>
              </div>
              <div id="mob-found" class="deva"><i class="fa-solid fa-check-circle" style="margin-right:5px;"></i>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•á ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ó‡§Ø‡§æ!</div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label class="lbl deva">üë§ ‡§®‡§æ‡§Æ *</label>
                <input id="f-name" type="text" class="inp" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ" required/>
              </div>
              <div>
                <label class="lbl">‡§™‡§¶ / Post</label>
                <input id="f-desig" type="text" class="inp" placeholder="‡§™‡§¶ / Designation"/>
              </div>
            </div>

            <div>
              <label class="lbl deva">üìã ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ *</label>
              <select id="f-program" class="inp" required>
                <option value="">‚Äî ‡§ö‡•Å‡§®‡•á‡§Ç / Select ‚Äî</option>
              </select>
              <div id="f-program-fixed" style="display:none;padding:14px 15px;border-radius:13px;font-size:16px;background:#fff8f0;border:2px solid var(--border);color:var(--text);font-weight:700;"></div>
            </div>

            <div>
              <label class="lbl deva">üèõÔ∏è ‡§ú‡§ø‡§≤‡§æ *</label>
              <select id="f-dist" class="inp"><option value="">‚Äî ‡§ú‡§ø‡§≤‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option></select>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label class="lbl deva">‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ</label>
                <select id="f-vidhan" class="inp" disabled><option value="">‚Äî ‡§™‡§π‡§≤‡•á ‡§ú‡§ø‡§≤‡§æ ‚Äî</option></select>
              </div>
              <div>
                <label class="lbl deva">‡§Æ‡§Ç‡§°‡§≤</label>
                <select id="f-mandal" class="inp" disabled><option value="">‚Äî ‡§™‡§π‡§≤‡•á ‡§µ‡§ø‡§ß‡§æ‡§® ‚Äî</option></select>
              </div>
            </div>

            <div>
              <label class="lbl">‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä / Remarks</label>
              <textarea id="f-remarks" rows="2" class="inp" placeholder="‡§ï‡•ã‡§à ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä (Optional)" style="resize:none;font-size:14px;"></textarea>
            </div>

            <div id="f-status"></div>

            <button id="submit-btn" type="submit" class="submit-btn">
              <i class="fa-solid fa-check-circle" style="font-size:22px;"></i>
              <span class="deva">‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <div style="text-align:center;font-size:11px;color:#c8a87a;margin-top:14px;font-weight:600;" id="footer-form">Powered by EventLens</div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê SUCCESS SCREEN ‚ïê‚ïê‚ïê -->
<div id="scr-ok">
  <div class="top-strip">
    <div class="hdr-left"></div>
    <div class="title-wrap">
      <div class="t1 deva">‚úÖ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú</div>
      <div class="t2">Attendance Recorded</div>
    </div>
    <div class="hdr-right"></div>
  </div>
  <div class="wrap" style="padding-top:20px;">
    <div class="ok-card">
      <div class="ok-icon">‚úÖ</div>
      <div id="ok-name" class="ok-name deva"></div>
      <div id="ok-msg" class="ok-msg deva">‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à</div>
      <div id="ok-sub" class="ok-sub deva">‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶ üôè</div>
      <button onclick="doNewEntry()" class="new-btn deva">
        <i class="fa-solid fa-rotate-right" style="margin-right:8px;"></i>‡§Ö‡§ó‡§≤‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø
      </button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê FULL-SCREEN CONFIRMATION POPUP ‚ïê‚ïê‚ïê -->
<div id="confirm-overlay">
  <div class="confirm-card">
    <div class="confirm-avatar">üôè</div>
    <div id="cfm-name" class="confirm-name deva">‚Äî</div>
    <div class="confirm-tag deva">‚úÖ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à</div>
    <div id="cfm-msg" class="confirm-msg deva">‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!</div>
    <div id="cfm-sub" class="confirm-sub deva"></div>
    <div id="cfm-audio-hint" class="deva">üîä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§≤‡•Ä? ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç</div>
    <button class="close-confirm-btn deva" onclick="closeConfirmAndReset()">
      <i class="fa-solid fa-rotate-right" style="margin-right:8px;"></i>‡§Ö‡§ó‡§≤‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø
    </button>
    <div class="confirm-wave"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_ID  = "vxid0yoovj";
const REGION  = "ap-south-1";
const BASE    = `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`;
const FTYPE   = "party_attendance";

// ‚úÖ Sarvam (REST) docs: https://docs.sarvam.ai/api-reference-docs/text-to-speech/convert
// IMPORTANT: key ko frontend me mat rakho. Preview/testing ke liye yaha paste kar sakte ho.
const SARVAM_KEY     = "";           // <- yaha apni key paste karo
const SARVAM_MODEL   = "bulbul:v3";  // bulbul:v3 or bulbul:v2
const SARVAM_SPEAKER = "shubh";      // v3 default: shubh (see docs)

const _qs = k => { try { return new URLSearchParams(location.search).get(k)||""; } catch(e){return "";} };
const _$  = id => document.getElementById(id);
const DBG = _qs("debug")==="1";

const TOK = _qs("token");
let   CID = (_qs("cid")||_qs("collection_id")).trim();
function isPub(){ return !!TOK; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let camFile=null, searchResp=null;
let entryId=null, finalTok=null, upUrl=null, s3k=null;
let facingMode="user", mobTimer=null, remoteCfg=null;

let AUDIO_UNLOCKED=false;
let _pendingAudioUrl=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(action, payload){
  const r = await fetch(`${BASE}/political/forms`,{
    method:"POST",cache:"no-store",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action, payload:payload||{}})
  });
  const txt = await r.text();
  let d={}; try{d=JSON.parse(txt);}catch(e){d={message:txt};}
  if(!r.ok) throw new Error(d.message||d.error||`HTTP ${r.status}`);
  return d;
}
async function sha256(file){
  const b=await file.arrayBuffer();
  const h=await crypto.subtle.digest("SHA-256",b);
  return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO UNLOCK (mobile autoplay policy)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function unlockAudio(){
  if(AUDIO_UNLOCKED) return;
  AUDIO_UNLOCKED=true;
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    const ctx = new AC();
    await ctx.resume();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    g.gain.value = 0.00001;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.01);
    setTimeout(()=>{ ctx.close().catch(()=>{}); }, 250);
  }catch(e){}
}
["click","touchstart","pointerdown"].forEach(evt=>{
  window.addEventListener(evt, ()=>unlockAudio(), {once:true, passive:true});
});

function showAudioHint(on){
  const el=_$("cfm-audio-hint");
  if(!el) return;
  el.style.display = on ? "block" : "none";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SARVAM TTS (REST)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function speakSarvam(text){
  try{
    showAudioHint(false);
    _pendingAudioUrl=null;

    if(!SARVAM_KEY){
      if(DBG) console.warn("Sarvam key missing");
      return;
    }

    await unlockAudio();

    // ‚úÖ REST schema (docs): {text, target_language_code, speaker?, model?, pace?, speech_sample_rate?, temperature?}
    const body={
      text: String(text||"").slice(0, 2400),
      target_language_code:"hi-IN",
      speaker: SARVAM_SPEAKER,
      model: SARVAM_MODEL,
      pace: 0.95,
      speech_sample_rate: 24000,
      temperature: 0.6
    };

    // For bulbul:v2 only (DON'T send for v3): pitch/loudness/enable_preprocessing
    if(SARVAM_MODEL==="bulbul:v2"){
      body.pitch = 0;
      body.loudness = 1.2;
      body.enable_preprocessing = true;
      body.speech_sample_rate = 22050;
      body.pace = 0.9;
      body.temperature = null;
    }

    const res = await fetch("https://api.sarvam.ai/text-to-speech",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "api-subscription-key": SARVAM_KEY
      },
      body: JSON.stringify(body)
    });

    const data = await res.json().catch(()=>({}));
    if(!res.ok){
      if(DBG) console.warn("Sarvam TTS failed:", res.status, data);
      return;
    }

    const b64 = data.audios && data.audios[0];
    if(!b64){
      if(DBG) console.warn("Sarvam TTS no audio:", data);
      return;
    }

    const binary = atob(b64);
    const bytes = new Uint8Array(binary.length);
    for(let i=0;i<binary.length;i++) bytes[i]=binary.charCodeAt(i);

    const blob = new Blob([bytes.buffer],{type:"audio/wav"});
    const url = URL.createObjectURL(blob);

    const audio = new Audio(url);
    audio.preload = "auto";

    const p = audio.play();
    if(p && typeof p.catch==="function"){
      p.catch(err=>{
        // autoplay blocked -> user tap will play
        _pendingAudioUrl = url;
        showAudioHint(true);
        if(DBG) console.warn("Audio blocked; tap to play.", err);
      });
    }

    audio.onended = ()=>{
      URL.revokeObjectURL(url);
      if(_pendingAudioUrl===url) _pendingAudioUrl=null;
      showAudioHint(false);
    };

  }catch(e){
    if(DBG) console.warn("Sarvam TTS error:", e);
  }
}

// Tap-to-play fallback (only when confirm is open and pending audio exists)
document.addEventListener("click", ()=>{
  const ov=_$("confirm-overlay");
  if(!ov || !ov.classList.contains("open")) return;
  if(!_pendingAudioUrl) return;

  const a = new Audio(_pendingAudioUrl);
  const p=a.play();
  if(p && typeof p.catch==="function") p.catch(()=>{});
  showAudioHint(false);
}, true);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESOLVE CID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function resolveCid(){
  if(CID||!TOK) return;
  try{
    const r = await api("public_get_config",{token:TOK, form_type:FTYPE});
    const c = r.collection_id||r.cid||
      (r.config&&(r.config.collection_id||r.config.cid))||"";
    if(c){ CID=c.trim(); }
  }catch(e){ if(DBG) console.warn("resolveCid fail",e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BRANDING + dynamic district data
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadBranding(){
  try{
    const payload = TOK ? {token:TOK,form_type:FTYPE} : {collection_id:CID,form_type:FTYPE};
    const action  = TOK ? "public_get_config" : "admin_get_config";
    const res = await api(action, payload);

    if(!CID){
      const c=res.collection_id||res.cid||
        (res.config&&(res.config.collection_id||res.config.cid))||"";
      if(c) CID=c.trim();
    }

    const cfg = res.config||res.settings||res.data||res;
    remoteCfg=cfg;

    const forms=cfg.forms||{}; const ft=forms[FTYPE]||{};
    const def=cfg.defaults||{}; const gl=cfg.global||{};

    const title=ft.title||def.title||gl.title||"";
    const sub=ft.subtitle||def.subtitle||"";
    const logo=(ft.branding&&ft.branding.logo&&ft.branding.logo.url)||(def.logo_url)||"";
    const hdr=ft.header_url||"";
    const c1=(ft.branding&&ft.branding.color1)||(def.color1)||"";
    const c2=(ft.branding&&ft.branding.color2)||(def.color2)||"";
    const foot=gl.tagline||"Powered by EventLens";

    if(title){ _$("org-name").textContent=title; }
    if(sub){ _$("org-sub").textContent=sub; }
    _$("footer-cam").textContent=foot; _$("footer-form").textContent=foot;
    if(c1){ document.documentElement.style.setProperty("--saf",c1); }
    if(c2){ document.documentElement.style.setProperty("--saf2",c2); }
    if(logo){ _$("logo-img").src=logo; _$("logo-img").style.display="block"; _$("default-icon").style.display="none"; }
    if(hdr){
      _$("hdr-cam-img").src=hdr; _$("hdr-cam-img-wrap").style.display="block";
      _$("form-hdr-img").src=hdr; _$("form-hdr-img-wrap").style.display="block";
      _$("hdr-cam-img").onerror=()=>{ _$("hdr-cam-img-wrap").style.display="none"; };
      _$("form-hdr-img").onerror=()=>{ _$("form-hdr-img-wrap").style.display="none"; };
    }

    // ‚úÖ dynamic district list: district_data/location_data at global OR form level
    const dyn = (ft && (ft.district_data||ft.location_data)) ||
                (cfg && (cfg.district_data||cfg.location_data||cfg.districts||cfg.locations)) || null;
    if(dyn && typeof dyn==="object") window.DISTRICT_DATA_DYNAMIC = dyn;

    fillProgramNames(cfg);
  }catch(e){ if(DBG) console.warn("branding fail",e); }
}

function fillProgramNames(cfg){
  const sel=_$("f-program"); if(!sel) return;
  const forms=cfg.forms||{}; const ft=forms[FTYPE]||{};
  const fl = ft.fixed_levels || cfg.defaults?.fixed_levels || {};

  if(fl.fixed_program){
    sel.style.display="none";
    const fixedDiv=_$("f-program-fixed");
    if(fixedDiv){ fixedDiv.textContent=fl.fixed_program; fixedDiv.style.display="block"; }
    let opt=[...sel.options].find(o=>o.value===fl.fixed_program);
    if(!opt){ const o=document.createElement("option"); o.value=fl.fixed_program; o.textContent=fl.fixed_program; sel.appendChild(o); }
    sel.value=fl.fixed_program;
    return;
  }

  const fixedDiv=_$("f-program-fixed"); if(fixedDiv) fixedDiv.style.display="none";
  sel.style.display="";

  const programs = ft.programs||ft.program_names||ft.program_list||
    (cfg.global&&cfg.global.programs)||cfg.defaults?.programs||[];

  if(programs&&programs.length){
    sel.innerHTML='<option value="">‚Äî ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>';
    programs.forEach(p=>{
      const o=document.createElement("option");
      o.value=typeof p==="string"?p:(p.value||p.name||p);
      o.textContent=typeof p==="string"?p:(p.label||p.name||p);
      sel.appendChild(o);
    });
  }
}

function getProgramFromConfig(){
  if(!remoteCfg) return "";
  const forms=remoteCfg.forms||{}; const ft=forms[FTYPE]||{};
  const fl=ft.fixed_levels||remoteCfg.defaults?.fixed_levels||{};
  if(fl.fixed_program) return fl.fixed_program;

  const programs = ft.programs || ft.program_names || ft.program_list ||
    (remoteCfg.global && remoteCfg.global.programs) ||
    (remoteCfg.defaults && remoteCfg.defaults.programs) || [];

  if(Array.isArray(programs) && programs.length===1){
    const p=programs[0];
    return typeof p==="string" ? p : (p.value||p.name||p.label||"");
  }
  return "";
}

function getBestCurrentProgram(){
  const a=getProgramFromConfig();
  if(a) return a;
  const sel=_$("f-program");
  const b=sel && sel.value ? (sel.value||"").trim() : "";
  if(b) return b;

  if(remoteCfg){
    const forms=remoteCfg.forms||{}; const ft=forms[FTYPE]||{};
    const programs = ft.programs || ft.program_names || ft.program_list ||
      (remoteCfg.global && remoteCfg.global.programs) ||
      (remoteCfg.defaults && remoteCfg.defaults.programs) || [];
    if(Array.isArray(programs) && programs.length){
      const p=programs[0];
      const s=typeof p==="string" ? p : (p.value||p.name||p.label||"");
      if(s) return s;
    }
  }
  return "";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAMERA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startCam(mode="user"){
  facingMode=mode;
  setStatus("idle","‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•Å‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à...");
  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:mode,width:{ideal:720},height:{ideal:720}}
    });
    _$("cam-video").srcObject=stream;
    _$("cam-video").onloadedmetadata=()=>{
      _$("cam-video").play();
      setStatus("idle","‡§ö‡•á‡§π‡§∞‡§æ ‡§Ö‡§Ç‡§°‡§æ‡§ï‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§Ç, üì∏ ‡§¶‡§¨‡§æ‡§è‡§Ç");
    };
  }catch(e){
    _$("cam-box").innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:220px;padding:24px;gap:12px;background:#fff8f0;">
      <i class="fa-solid fa-camera-slash" style="font-size:48px;color:rgba(255,107,0,.4);"></i>
      <p style="font-size:15px;font-weight:800;color:var(--text);" class="deva">‡§ï‡•à‡§Æ‡§∞‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</p>
      <p style="font-size:13px;color:var(--muted);" class="deva">‡§®‡•Ä‡§ö‡•á ‡§∏‡•á ‡§ó‡•à‡§≤‡§∞‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç</p>
    </div>`;
    _$("cap-btn").style.display="none";
  }
}
function flipCam(){
  const v=_$("cam-video"); if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
  startCam(facingMode==="user"?"environment":"user");
}
function setStatus(type,txt){
  _$("status-txt").textContent=txt;
  const dot=_$("status-dot"); dot.className="";
  const oval=_$("oval-el"); oval.className="";
  if(type==="scanning"){dot.className="scanning";oval.className="scanning";}
  else if(type==="matched"){dot.className="matched";oval.className="matched";}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAPTURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doCapture(){
  await unlockAudio();
  const v=_$("cam-video"),cnv=_$("cam-canvas");
  if(!v.srcObject && !v.src) return;
  const w=v.videoWidth||640,h=v.videoHeight||640;
  cnv.width=w; cnv.height=h;
  const ctx=cnv.getContext("2d");
  if(facingMode==="user"){ctx.translate(w,0);ctx.scale(-1,1);}
  ctx.drawImage(v,0,0,w,h);
  if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
  cnv.toBlob(async blob=>{
    const file=new File([blob],"selfie.jpg",{type:"image/jpeg"});
    camFile=file;
    _$("prev-img").src=URL.createObjectURL(blob);
    _$("cam-box").style.display="none";
    _$("prev-box").style.display="block";
    _$("capture-area-wrap").style.display="none";
    _$("proc-overlay").classList.add("show");
    await runMatch(file);
  },"image/jpeg",.88);
}
async function galUpload(e){
  await unlockAudio();
  const file=e.target.files&&e.target.files[0]; if(!file) return;
  camFile=file;
  _$("prev-img").src=URL.createObjectURL(file);
  _$("cam-box").style.display="none";
  _$("prev-box").style.display="block";
  _$("capture-area-wrap").style.display="none";
  _$("proc-overlay").classList.add("show");
  await runMatch(file);
}
function doRetake(){
  camFile=null; searchResp=null; entryId=null; finalTok=null; upUrl=null; s3k=null;
  _$("prev-box").style.display="none";
  _$("cam-box").style.display="block";
  _$("capture-area-wrap").style.display="block";
  _$("proceed-wrap").style.display="none";
  _$("proc-overlay").classList.remove("show");
  setStatus("idle","‡§ö‡•á‡§π‡§∞‡§æ ‡§Ö‡§Ç‡§°‡§æ‡§ï‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§Ç, üì∏ ‡§¶‡§¨‡§æ‡§è‡§Ç");
  startCam(facingMode);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACE MATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runMatch(file){
  setStatus("scanning","‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...");
  try{
    if(!CID && TOK) await resolveCid();
    const sha=await sha256(file);
    const cp={form_type:FTYPE,sha256:sha,file_name:"selfie.jpg",mime_type:"image/jpeg",payload:{}};
    if(TOK) cp.token=TOK;
    if(CID) cp.collection_id=CID;
    const cr=await api(isPub()?"public_create_entry":"create_entry",cp);
    entryId=cr.entry_id; finalTok=cr.finalize_token; upUrl=cr.upload_url; s3k=cr.s3_key;
    if(upUrl&&!cr.duplicate) await fetch(upUrl,{method:"PUT",body:file,headers:{"Content-Type":"image/jpeg"}});

    const sp={s3_key:s3k,days:730};
    if(TOK) sp.token=TOK;
    if(CID) sp.collection_id=CID;
    const sr=await fetch(`${BASE}/political/search`,{method:"POST",cache:"no-store",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"public_search",payload:sp})});
    const sd=await sr.json();
    if(DBG) console.log("üü¢ SEARCH:",JSON.stringify(sd));

    _$("proc-overlay").classList.remove("show");

    if(sd.message==="OK"&&(sd.face_id||sd.matched)){
      searchResp=sd; onMatch(sd);
    }else{
      onNoMatch();
    }
  }catch(err){
    if(DBG) console.error("Match error:",err);
    _$("proc-overlay").classList.remove("show");
    setStatus("idle","Error ‚Äî ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç");
    _$("proceed-wrap").style.display="block";
    _$("proceed-wrap").querySelector("#proceed-msg").textContent="Error ‚Äî ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç";
  }
}

function extractProfile(sd){
  if(!sd) return {};
  const cands=[];
  if(sd.profile) cands.push(sd.profile);
  if(sd.identity) cands.push(sd.identity);
  if(sd.data) cands.push(sd.data);
  const evs=sd.events||sd.timeline||[];
  [...evs].sort((a,b)=>{
    const at=(a.form_type||"").includes("attendance")?0:1;
    const bt=(b.form_type||"").includes("attendance")?0:1;
    return at-bt;
  }).forEach(ev=>{
    if(ev.data&&typeof ev.data==="object") cands.push(ev.data);
    if(ev.profile) cands.push(ev.profile);
    cands.push(ev);
  });
  cands.push(sd);
  const g=(obj,...keys)=>{ for(const k of keys){ if(!obj) continue; const v=obj[k]; if(v&&typeof v==="string"&&v.trim()) return v.trim(); } return ""; };
  const p={};
  for(const c of cands){
    if(!c||typeof c!=="object") continue;
    if(!p.name)   p.name   = g(c,"name","‡§®‡§æ‡§Æ","full_name","visitor_name","person_name");
    if(!p.mobile) p.mobile = g(c,"mobile","phone","mobile_no","‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤","contact");
    if(!p.desig)  p.desig  = g(c,"designation","‡§™‡§¶","post","role","position","desg");
    if(!p.dist)   p.dist   = g(c,"district","‡§ú‡§ø‡§≤‡§æ","dist","district_name");
    if(!p.vidhan) p.vidhan = g(c,"vidhansabha","‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ","vidhan_sabha","constituency");
    if(!p.mandal) p.mandal = g(c,"mandal","‡§Æ‡§Ç‡§°‡§≤","mandal_name");
    if(!p.program) p.program = g(c,"program_name","‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ","program","event_name");
  }
  return p;
}

function onMatch(sd){
  setStatus("matched",`‚úÖ ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ó‡§Ø‡§æ! ${Math.round(sd.similarity||0)}%`);
  const p = extractProfile(sd);

  const currentProgram = getBestCurrentProgram();
  if(!p.program && currentProgram) p.program = currentProgram;

  const hasComplete = p.name && p.mobile && (p.dist||p.mandal||p.vidhan);
  if(hasComplete){
    autoConfirmAttendance(sd, p);
  } else {
    window._autofill = p;
    showPartialMatchNotice(p);
  }
}

function onNoMatch(){
  setStatus("idle","‡§®‡§Ø‡§æ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£");
  window._autofill = null;
  _$("proceed-wrap").style.display="block";
  _$("proceed-msg").textContent="‡§®‡§Ø‡§æ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‚Äî ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç";
}

function showPartialMatchNotice(p){
  _$("proceed-wrap").style.display="block";
  const nm = p.name ? `${p.name} ‡§ú‡•Ä` : "‡§Ü‡§™";
  _$("proceed-msg").innerHTML = `<i class="fa-solid fa-user-pen" style="margin-right:6px;"></i>${nm} ‡§™‡§π‡§ö‡§æ‡§®‡•á ‡§ó‡§è ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç`;
}

async function autoConfirmAttendance(sd, p){
  setStatus("matched","‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...");
  _$("proc-overlay").classList.add("show");
  _$("proc-overlay").querySelector(".proc-txt").textContent = "‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
  try{
    if(!CID && TOK) await resolveCid();
    const currentProgram = getBestCurrentProgram();
    const fd={
      mobile:p.mobile||"",
      name:p.name||"",
      designation:p.desig||"",
      program_name:p.program||currentProgram||"",
      district:p.dist||"",
      vidhansabha:p.vidhan||"",
      mandal:p.mandal||"",
      remarks:"",
    };
    await doSave(fd, camFile);
    _$("proc-overlay").classList.remove("show");
    showBigConfirm({name:fd.name, dist:fd.district, vidhan:fd.vidhansabha, mandal:fd.mandal, program:fd.program_name});
  }catch(err){
    if(DBG) console.error("Auto-confirm error:",err);
    _$("proc-overlay").classList.remove("show");
    window._autofill = p;
    _$("proceed-wrap").style.display="block";
    _$("proceed-msg").textContent="‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç";
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRMATION POPUP + TTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBigConfirm(p){
  const name = (p && p.name) ? p.name : "";
  const program = (p && p.program) ? (p.program||"").trim() : "";
  const nameJi = name ? `${name} ‡§ú‡•Ä` : "‡§Ü‡§™";

  _$("cfm-name").textContent = nameJi;

  if(program){
    _$("cfm-msg").textContent = `${program} ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à‡•§ ‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!`;
  }else{
    _$("cfm-msg").textContent = "‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à ‚Äî ‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!";
  }

  const parts=[];
  if(p && p.dist) parts.push(p.dist);
  if(p && p.vidhan) parts.push(p.vidhan);
  if(p && p.mandal) parts.push(p.mandal);
  if(program) parts.push(`üìã ${program}`);
  _$("cfm-sub").textContent = parts.join(" ‚Ä¢ ");

  _$("confirm-overlay").classList.add("open");

  const ttsText = name
    ? (program
        ? `${name} ‡§ú‡•Ä, ${program} ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à‡•§ ‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`
        : `${name} ‡§ú‡•Ä, ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à‡•§ ‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`)
    : (program
        ? `${program} ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à‡•§ ‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`
        : `‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à‡•§ ‡§™‡§ß‡§æ‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`);

  speakSarvam(ttsText);
}

function closeConfirmAndReset(){
  _$("confirm-overlay").classList.remove("open");
  showAudioHint(false);
  _pendingAudioUrl=null;
  doNewEntry();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gotoForm(){
  _$("scr-cam").style.display="none";
  _$("scr-form").style.display="block";
  initCascade();
  setupMobLookup();
  setTimeout(()=>{ if(window._autofill){ fillForm(window._autofill); window._autofill=null; } },200);
}
function goCam(){
  _$("scr-form").style.display="none";
  _$("scr-cam").style.display="block";
  startCam(facingMode);
}

function fillForm(p){
  if(!p) return;
  if(p.name)   _$("f-name").value   = p.name;
  if(p.mobile) _$("f-mobile").value = p.mobile;
  if(p.desig)  _$("f-desig").value  = p.desig;

  const currentProgram = getBestCurrentProgram();
  const prog = p.program || currentProgram;
  if(prog){
    const ps=_$("f-program");
    const found=[...ps.options].find(o=>o.value===prog||o.textContent===prog);
    if(found) ps.value=found.value;
  }

  const filled=[]; if(p.name) filled.push("‡§®‡§æ‡§Æ"); if(p.mobile) filled.push("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤");
  if(p.desig) filled.push("‡§™‡§¶"); if(p.dist) filled.push("‡§ú‡§ø‡§≤‡§æ");
  if(filled.length){
    _$("autofill-badge").style.display="flex";
    _$("autofill-txt").textContent=`Auto-fill: ${filled.join(", ")}`;
  }
  fillLocation(p);
}

function fillLocation(p){
  const d=(p.dist||"").trim(),v=(p.vidhan||"").trim(),m=(p.mandal||"").trim();
  if(!d) return;
  const dSel=_$("f-dist");
  dSel.value=d; dSel.dispatchEvent(new Event("change"));
  if(v){
    setTimeout(()=>{
      const vSel=_$("f-vidhan");
      vSel.value=v; vSel.dispatchEvent(new Event("change"));
      if(m){ setTimeout(()=>{ _$("f-mandal").value=m; },250); }
    },250);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CASCADE (dynamic + fallback)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDistrictData(){
  if(window.DISTRICT_DATA_DYNAMIC && typeof window.DISTRICT_DATA_DYNAMIC==="object") return window.DISTRICT_DATA_DYNAMIC;
  return DISTRICT_DATA;
}

function initCascade(){
  const d=_$("f-dist"),v=_$("f-vidhan"),m=_$("f-mandal");
  if(!d||d.options.length>2) return;

  const DATA = getDistrictData();

  d.innerHTML='<option value="">‚Äî ‡§ú‡§ø‡§≤‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>';
  Object.keys(DATA).sort((a,b)=>a.localeCompare(b,"hi")).forEach(k=>{
    const o=document.createElement("option"); o.value=k; o.textContent=k; d.appendChild(o);
  });

  d.addEventListener("change",()=>{
    v.innerHTML='<option value="">‚Äî ‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>';
    m.innerHTML='<option value="">‚Äî ‡§Æ‡§Ç‡§°‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>';
    v.disabled=!d.value; m.disabled=true;
    if(d.value){
      Object.keys(DATA[d.value]||{}).sort((a,b)=>a.localeCompare(b,"hi")).forEach(k=>{
        const o=document.createElement("option"); o.value=k; o.textContent=k; v.appendChild(o);
      });
    }
  });

  v.addEventListener("change",()=>{
    m.innerHTML='<option value="">‚Äî ‡§Æ‡§Ç‡§°‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>'; m.disabled=true;
    const ms=(DATA[d.value]||{})[v.value]||[];
    if(ms.length){
      m.disabled=false;
      ms.sort((a,b)=>a.localeCompare(b,"hi")).forEach(k=>{
        const o=document.createElement("option");o.value=k;o.textContent=k;m.appendChild(o);
      });
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE LOOKUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupMobLookup(){
  const mob=_$("f-mobile"); if(!mob||mob._ls) return; mob._ls=true;
  mob.addEventListener("input",()=>{
    clearTimeout(mobTimer); _$("mob-found").style.display="none";
    if((mob.value||"").trim().length===10) mobTimer=setTimeout(doMobLookup,700);
  });
}

async function doMobLookup(){
  const mobile=(_$("f-mobile").value||"").trim(); if(mobile.length!==10) return;
  _$("mob-spin").style.display="block";
  try{
    const pl={form_type:FTYPE,mobile};
    if(TOK) pl.token=TOK; if(CID) pl.collection_id=CID;
    const res=await api(isPub()?"public_lookup_mobile":"lookup_mobile",pl);
    const p=extractProfile({profile:res.profile,data:res.data,events:res.events,...res});

    const currentProgram = getBestCurrentProgram();
    if(!p.program && currentProgram) p.program=currentProgram;

    if(p.name||p.dist){ fillForm(p); _$("mob-found").style.display="block"; }
  }catch(e){ if(DBG) console.warn("mob lookup fail",e); }
  finally{ _$("mob-spin").style.display="none"; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doSubmit(e){
  e.preventDefault();
  if(!camFile){ showFStatus("‚ùå ‡§´‡•ã‡§ü‡•ã ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à",true); return; }

  await unlockAudio();

  const btn=_$("submit-btn");
  const old=btn.innerHTML;
  btn.disabled=true;
  btn.innerHTML='<i class="fa-solid fa-spinner" style="animation:spin 1s linear infinite;"></i><span class="deva"> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</span>';
  showFStatus("",false);

  try{
    if(!CID) await resolveCid();
    if(!CID) throw new Error("Collection ID ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‚Äî URL ‡§Æ‡•á‡§Ç ?cid= ‡§Ø‡§æ ?token= ‡§ú‡•ã‡§°‡§º‡•á‡§Ç");

    const fd={
      mobile:(_$("f-mobile").value||"").trim(),
      name:(_$("f-name").value||"").trim(),
      designation:(_$("f-desig").value||"").trim(),
      program_name:(_$("f-program").value||"").trim(),
      district:(_$("f-dist").value||"").trim(),
      vidhansabha:(_$("f-vidhan").value||"").trim(),
      mandal:(_$("f-mandal").value||"").trim(),
      remarks:(_$("f-remarks").value||"").trim(),
    };

    await doSave(fd, camFile);

    showBigConfirm({
      name:fd.name,
      dist:fd.district,
      vidhan:fd.vidhansabha,
      mandal:fd.mandal,
      program:fd.program_name || getBestCurrentProgram()
    });

    _$("scr-form").style.display="none";
    _$("scr-ok").style.display="block";
    _$("ok-name").textContent = fd.name ? `${fd.name} ‡§ú‡•Ä` : "";
    _$("ok-msg").textContent = fd.program_name ? `${fd.program_name} ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à` : "‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à";

  }catch(err){
    showFStatus("‚ùå "+(err.message||"Error"),true);
    btn.disabled=false; btn.innerHTML=old;
  }
}

async function doSave(formData, file){
  const sha=await sha256(file);
  if(!entryId||!finalTok){
    const cp={form_type:FTYPE,sha256:sha,file_name:"selfie.jpg",mime_type:"image/jpeg",payload:formData};
    if(TOK) cp.token=TOK; if(CID) cp.collection_id=CID;
    const cr=await api(isPub()?"public_create_entry":"create_entry",cp);
    entryId=cr.entry_id; finalTok=cr.finalize_token; upUrl=cr.upload_url; s3k=cr.s3_key;
    if(upUrl&&!cr.duplicate) await fetch(upUrl,{method:"PUT",body:file,headers:{"Content-Type":"image/jpeg"}});
  }else{
    const up={form_type:FTYPE,sha256:sha,file_name:"selfie.jpg",mime_type:"image/jpeg",payload:formData};
    if(TOK) up.token=TOK; if(CID) up.collection_id=CID;
    const ur=await api(isPub()?"public_create_entry":"create_entry",up);
    finalTok=ur.finalize_token; entryId=ur.entry_id;
    if(ur.upload_url&&!ur.duplicate) await fetch(ur.upload_url,{method:"PUT",body:file,headers:{"Content-Type":"image/jpeg"}});
  }
  await api(isPub()?"public_finalize_entry":"finalize_entry",{finalize_token:finalTok,entry_id:entryId});
}

function showFStatus(msg,isErr){
  const el=_$("f-status");
  if(!msg){el.style.display="none";return;}
  el.style.display="block";
  el.style.background=isErr?"rgba(220,38,38,.08)":"var(--success-bg)";
  el.style.border=isErr?"2px solid rgba(220,38,38,.25)":"2px solid rgba(34,197,94,.25)";
  el.style.color=isErr?"#b91c1c":"var(--success)";
  el.style.borderRadius="12px";
  el.textContent=msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doNewEntry(){
  camFile=null; searchResp=null; entryId=null; finalTok=null; upUrl=null; s3k=null;
  window._autofill=null;
  _$("scr-ok").style.display="none";
  _$("scr-form").style.display="none";
  _$("scr-cam").style.display="block";
  if(_$("vform")) _$("vform").reset();
  _$("autofill-badge").style.display="none";
  _$("prev-box").style.display="none";
  _$("cam-box").style.display="block";
  _$("capture-area-wrap").style.display="block";
  _$("proceed-wrap").style.display="none";
  _$("proc-overlay").classList.remove("show");
  _$("proc-overlay").querySelector(".proc-txt").textContent="‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...";
  setStatus("idle","‡§ö‡•á‡§π‡§∞‡§æ ‡§Ö‡§Ç‡§°‡§æ‡§ï‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§Ç, üì∏ ‡§¶‡§¨‡§æ‡§è‡§Ç");
  startCam(facingMode);
}

window.addEventListener("offline",()=>_$("offline-banner").classList.add("on"));
window.addEventListener("online", ()=>_$("offline-banner").classList.remove("on"));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DISTRICT DATA (fallback)
// NOTE: ‡§Ö‡§ó‡§∞ "‡§¨‡§æ‡§ï‡•Ä ‡§ú‡§ø‡§≤‡•á/‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ" ‡§ö‡§æ‡§π‡§ø‡§è ‡§§‡•ã best: admin config ‡§Æ‡•á‡§Ç district_data/location_data ‡§≠‡•á‡§ú‡•ã.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DISTRICT_DATA = {
  "‡§Æ‡•Å‡§∞‡•à‡§®‡§æ": {
    "3. ‡§∏‡§¨‡§≤‡§ó‡§¢‡§º": ["‡§∏‡§¨‡§≤‡§ó‡§¢‡§º ‡§®‡§ó‡§∞","‡§∏‡§¨‡§≤‡§ó‡§¢‡§º ‡§ó‡§æ‡§Æ‡•Ä‡§£","‡§®‡•á‡§™‡§∞‡•Ä","‡§ü‡•á‡§Ç‡§ü‡§∞‡§æ ‡§®‡§Ø‡§æ","‡§∞‡§æ‡§Æ‡§™‡•Å‡§∞ ‡§ï‡§≤‡§æ‡§Ç ‡§®‡§Ø‡§æ"],
    "4. ‡§ú‡•å‡§∞‡§æ": ["‡§ï‡•à‡§≤‡§æ‡§∞‡§∏","‡§ú‡•å‡§∞‡§æ ‡§®‡§ó‡§∞","‡§ú‡•å‡§∞‡§æ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§™‡§π‡§æ‡§°‡§ó‡§¢‡§º","‡§∏‡§∞‡§∏‡•à‡§®‡•Ä"],
    "5. ‡§∏‡•Å‡§Æ‡§æ‡§µ‡§≤‡•Ä": ["‡§∏‡•Å‡§Æ‡§æ‡§µ‡§≤‡•Ä","‡§õ‡•à‡§∞‡§æ","‡§Æ‡•Å‡§Ç‡§ó‡§æ‡§µ‡§≤‡•Ä","‡§¨‡§æ‡§ó‡§ö‡•Ä‡§®‡•Ä","‡§Æ‡•Å‡§∞‡•à‡§®‡§æ ‡§ó‡§æ‡•ç‡§∞‡§Æ‡•Ä‡§£"],
    "6. ‡§Æ‡•Å‡§∞‡•à‡§®‡§æ": ["‡§Æ‡•Å‡§∞‡•à‡§®‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ","‡§Æ‡•Å‡§∞‡•à‡§®‡§æ ‡§™‡§∂‡•ç‡§ö‡§ø‡§Æ","‡§Æ‡•Å‡§∞‡•à‡§®‡§æ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£","‡§¨‡§æ‡§®‡§Æ‡•å‡§∞","‡§∞‡§ø‡§†‡•å‡§∞‡§æ‡§ï‡§≤‡§æ‡•Ö","‡§ú‡§°‡•á‡§∞‡•Ç‡§Ü ‡§®‡§Ø‡§æ"],
    "7. ‡§¶‡§ø‡§Æ‡§®‡•Ä": ["‡§¶‡§ø‡§Æ‡§®‡•Ä","‡§¨‡§æ‡§Æ‡•å‡§∞","‡§Ö‡§Æ‡•ç‡§¨‡§æ‡§π","‡§™‡•ã‡§∞‡§∏‡§æ","‡§Ö‡§ü‡•á‡§∞"]
  },
  "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞": {
    "224. ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞": ["‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£","‡§¶‡§≤‡•å‡§¶‡§æ","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞"],
    "225. ‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡§¢‡§º ‡§Ö‡§ú‡§æ": ["‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡§¢‡§º","‡§¨‡•Ç‡§¢‡§æ ‡§¨‡•Å‡§∞‡§π‡§æ‡§®‡§™‡•Å‡§∞","‡§ò‡•Å‡§®‡•ç‡§ß‡§°‡§ï‡§æ"],
    "226. ‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ": ["‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§â ‡§®‡§ó‡§∞","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§â ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§ï‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞"],
    "227. ‡§ó‡§∞‡•ã‡§†": ["‡§ó‡§∞‡•ã‡§†","‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ","‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ","‡§≠‡•à‡§∏‡•ã‡§¶‡§æ"]
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async()=>{
  await loadBranding();
  await startCam("user");
})();
</script>
</body>
</html>
