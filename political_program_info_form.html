<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>पार्टी कार्यक्रम जानकारी - EventLens Political</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              900: '#0c4a6e'
            }
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: radial-gradient(circle at top left, rgba(14,165,233,0.15), transparent 40%),
                  radial-gradient(circle at top right, rgba(139,92,246,0.10), transparent 40%),
                  #020617;
    }
    .glass {
      background: rgba(30,41,59,0.72);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>
<body class="min-h-screen text-slate-200">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <div class="glass rounded-3xl p-6 md:p-8 shadow-2xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-black text-white">पार्टी कार्यक्रम जानकारी</h1>
          <p class="text-slate-300 mt-2 text-sm">कार्यक्रम जानकारी (photo optional).</p>
        </div>
        <div class="text-xs text-slate-400 text-right">
          <div class="font-semibold">Collection ID</div>
          <div id="cidText" class="mt-1 break-all">-</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4">
        
        <label class="block text-sm font-semibold text-slate-200 mb-1">कार्यक्रम का नाम *</label>
        <input required id="program_name" type="text" placeholder="कार्यक्रम का नाम" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">दिनांक *</label>
        <input required id="date" type="date" placeholder="" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">स्थान समय *</label>
        <input required id="place_time" type="text" placeholder="स्थान + समय" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        
        <label class="block text-sm font-semibold text-slate-200 mb-1">फोटो अपलोड * (Optional)</label>
        <input id="fileInput"  accept='image/*' type="file" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 outline-none transition" />
        <div class="text-xs text-slate-400 -mt-1">अगर फोटो नहीं डालना है तो भी save हो जाएगा।</div>
        

        <button id="submitBtn" class="mt-2 w-full py-3 rounded-xl bg-brand-600 hover:bg-brand-500 font-bold text-white transition">
          Submit / Save
        </button>

        <div id="statusBox" class="hidden mt-2 p-4 rounded-2xl bg-slate-900 border border-slate-700 text-sm">
          <div class="font-semibold text-white mb-1">Status</div>
          <div id="statusText" class="text-slate-300">-</div>
        </div>

        <div class="mt-4 text-xs text-slate-400">
          ✅ Note: यह Form Political Dashboard के लिए है। अगर login token missing है तो submit नहीं होगा।
        </div>
      </div>
    </div>

    <div class="text-center text-xs text-slate-500 mt-6">
      EventLens Political Module
    </div>
  </div>

<script>
  const API_BASE = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod";
  const FORMS_ENDPOINT = API_BASE + "/political/forms";

  function qs(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function showStatus(msg) {
    const box = document.getElementById('statusBox');
    const t = document.getElementById('statusText');
    box.classList.remove('hidden');
    t.textContent = msg;
  }

  function getAccessToken() {
    return localStorage.getItem('accessToken') || localStorage.getItem('idToken') || '';
  }

  async function sha256Hex(file) {
    const buf = await file.arrayBuffer();
    const hashBuf = await crypto.subtle.digest('SHA-256', buf);
    const bytes = Array.from(new Uint8Array(hashBuf));
    return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  async function apiCall(action, payload) {
    const token = getAccessToken();
    if(!token) throw new Error("Login token नहीं मिला। पहले Political Dashboard से login करो।");
    const r = await fetch(FORMS_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ action, payload })
    });
    const txt = await r.text();
    let data = {};
    try { data = JSON.parse(txt); } catch(e) { data = {raw: txt}; }
    if(!r.ok) {
      throw new Error((data && data.message) ? data.message : ("API Error " + r.status));
    }
    return data;
  }

  function getCollectionId() {
    const cid = qs("cid") || localStorage.getItem("political_cid") || "";
    if(cid) localStorage.setItem("political_cid", cid);
    return cid;
  }

  async function uploadToS3(url, file) {
    const r = await fetch(url, {
      method: "PUT",
      headers: {
        "Content-Type": file.type || "application/octet-stream"
      },
      body: file
    });
    if(!r.ok) throw new Error("S3 Upload fail (" + r.status + ")");
    return true;
  }

  async function handleSubmit() {
    const cid = getCollectionId();
    document.getElementById("cidText").textContent = cid || "-";
    if(!cid) {
      showStatus("❌ Collection ID missing. इस page को Dashboard से खोलो (link में ?cid= होगा).");
      return;
    }

    const data = {};
    data['program_name'] = (document.getElementById('program_name').value || '').trim();
    data['date'] = (document.getElementById('date').value || '').trim();
    data['place_time'] = (document.getElementById('place_time').value || '').trim();

    const required = ["program_name", "date", "place_time"];
    for(const k of required) {
      if(!data[k]) {
        showStatus("❌ " + k + " खाली है। भर दो।");
        return;
      }
    }

    const input = document.getElementById("fileInput");
    

    const files = (input.files && input.files.length>0) ? Array.from(input.files) : [];

    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').textContent = "Saving...";

    try {
      // If no files (optional), create a metadata-only entry
      if(files.length === 0) {
        showStatus("⏳ Creating entry...");
        const createResp = await apiCall("create_entry", {
          collection_id: cid,
          form_type: "program_info",
          payload: data,
          file_kind: "none",
          file_name: "",
          mime_type: "",
          sha256: ""
        });

        showStatus("⏳ Finalizing entry...");
        await apiCall("finalize_entry", {
          entry_id: createResp.entry_id,
          pk: createResp.pk,
          sk: createResp.sk,
          s3_key: createResp.s3_key || "",
          file_kind: "none",
          sha256: ""
        });

        showStatus("✅ Saved (no photo).");
        return;
      }

      // For each file create entry (1 file = 1 entry)
      for(let i=0;i<files.length;i++) {
        const f = files[i];
        showStatus("⏳ Hashing file " + (i+1) + "/" + files.length + " ...");
        const hex = await sha256Hex(f);

        showStatus("⏳ Creating entry " + (i+1) + "/" + files.length + " ...");
        const createResp = await apiCall("create_entry", {
          collection_id: cid,
          form_type: "program_info",
          payload: data,
          file_kind: "photo",
          file_name: f.name,
          mime_type: f.type || "image/jpeg",
          sha256: hex
        });

        if(createResp.duplicate === true) {
          showStatus("✅ Duplicate मिला: photo दुबारा upload नहीं हुआ, entry link हो गई। (" + (i+1) + ")");
          await apiCall("finalize_entry", {
            entry_id: createResp.entry_id,
            pk: createResp.pk,
            sk: createResp.sk,
            s3_key: createResp.s3_key,
            file_kind: "photo",
            sha256: hex,
            duplicate: true
          });
          continue;
        }

        if(createResp.upload_url) {
          showStatus("⏳ Uploading S3 " + (i+1) + "/" + files.length + " ...");
          await uploadToS3(createResp.upload_url, f);
        }

        showStatus("⏳ Finalizing entry " + (i+1) + "/" + files.length + " ...");
        await apiCall("finalize_entry", {
          entry_id: createResp.entry_id,
          pk: createResp.pk,
          sk: createResp.sk,
          s3_key: createResp.s3_key,
          file_kind: "photo",
          sha256: hex
        });

        showStatus("✅ Saved " + (i+1) + "/" + files.length);
      }

      showStatus("✅ Done! सभी entry save हो गई। Indexing थोड़ी देर में Rekognition में हो जाएगी।");
      input.value = "";
    } catch(err) {
      showStatus("❌ Error: " + (err && err.message ? err.message : err));
    } finally {
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('submitBtn').textContent = "Submit / Save";
    }
  }

  document.getElementById("submitBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    handleSubmit();
  });

  document.getElementById("cidText").textContent = getCollectionId() || "-";
</script>

</body>
</html>
