<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visitor Form - EventLens Political</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              900: '#0c4a6e'
            }
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: radial-gradient(circle at top left, rgba(14,165,233,0.15), transparent 40%),
                  radial-gradient(circle at top right, rgba(139,92,246,0.10), transparent 40%),
                  #020617;
    }
    .glass {
      background: rgba(30,41,59,0.72);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>
<body class="min-h-screen text-slate-200">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <div class="glass rounded-3xl p-6 md:p-8 shadow-2xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-black text-white">Visitor Form</h1>
          <p class="text-slate-300 mt-2 text-sm">Visitor / Visitor Entry. सभी detail भरकर selfie upload करें।</p>
        </div>
        <div class="text-xs text-slate-400 text-right">
          <div class="font-semibold">Collection ID</div>
          <div id="cidText" class="mt-1 break-all">-</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4">
        
        <label class="block text-sm font-semibold text-slate-200 mb-1">मोबाइल नंबर *</label>
        <input required id="mobile" type="tel" placeholder="10 digit मोबाइल" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">नाम *</label>
        <input required id="name" type="text" placeholder="पूरा नाम" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">जिला *</label>
        <input required id="district" type="text" placeholder="जिला" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">विधानसभा *</label>
        <input required id="vidhansabha" type="text" placeholder="विधानसभा" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">मंडल *</label>
        <input required id="mandal" type="text" placeholder="मंडल" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">वार्ड/बूथ/पता *</label>
        <input required id="address" type="text" placeholder="वार्ड/बूथ/पता" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        <label class="block text-sm font-semibold text-slate-200 mb-1">आने का कारण *</label>
        <input required id="reason" type="text" placeholder="क्यों आए" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition placeholder-slate-500" />
        

        
        <label class="block text-sm font-semibold text-slate-200 mb-1">सेल्फी (Photo) *</label>
        <input id="fileInput"  accept='image/*' type="file" class="w-full px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 text-white focus:border-brand-500 outline-none transition" />
    

        <button id="submitBtn" class="mt-2 w-full py-3 rounded-xl bg-brand-600 hover:bg-brand-500 font-bold text-white transition">
          Submit / Save
        </button>

        <div id="statusBox" class="hidden mt-2 p-4 rounded-2xl bg-slate-900 border border-slate-700 text-sm">
          <div class="font-semibold text-white mb-1">Status</div>
          <div id="statusText" class="text-slate-300">-</div>
        </div>

        <div class="mt-4 text-xs text-slate-400">
          ✅ <span id="noteText">Note: यह Form Political Dashboard के लिए है। अगर login token missing है तो submit नहीं होगा।</span>
        </div>
      </div>
    </div>

    <div class="text-center text-xs text-slate-500 mt-6">
      EventLens Political Module
  
// ===== EventLens Political Visitor Form (Dual Mode)
  // Public Mode: URL has ?token=...  (NO login needed)
  // Admin Mode: URL has ?cid=... and logged-in token in localStorage (idToken/accessToken)
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";

  const API_BASE_CANDIDATES = [
    `https://${API_ID}.execute-api.${REGION}.amazonaws.com`,         // $default stage
    `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`     // prod stage fallback
  ];

  function qs(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function showStatus(msg) {
    const box = document.getElementById('statusBox');
    const t = document.getElementById('statusText');
    box.classList.remove('hidden');
    t.textContent = msg;
  }

  function isPublicMode() {
    return !!qs("token");
  }

  function getIdTokenPrefer() {
    // Prefer ID token (Cognito group claim usually in idToken)
    return (
      localStorage.getItem('idToken') ||
      localStorage.getItem('cognito_id_token') ||
      localStorage.getItem('accessToken') ||
      localStorage.getItem('cognito_access_token') ||
      ''
    );
  }

  async function sha256Hex(file) {
    const buf = await file.arrayBuffer();
    const hashBuf = await crypto.subtle.digest('SHA-256', buf);
    const bytes = Array.from(new Uint8Array(hashBuf));
    return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  async function apiCall(action, payload, opts = {}) {
    const { useAuth = true } = opts;

    let lastErr = null;
    for (const base of API_BASE_CANDIDATES) {
      const url = base + "/political/forms";
      try {
        const headers = { "Content-Type": "application/json" };

        if (useAuth) {
          const t = getIdTokenPrefer();
          if (!t) throw new Error("Login token नहीं मिला। पहले dashboard से login करो।");
          headers["Authorization"] = "Bearer " + t;
        }

        const r = await fetch(url, {
          method: "POST",
          headers,
          body: JSON.stringify({ action, payload })
        });

        const txt = await r.text();
        let data = {};
        try { data = JSON.parse(txt); } catch(e) { data = { raw: txt }; }

        // If stage mismatch, API Gateway commonly returns 403 + "Missing Authentication Token"
        if (!r.ok) {
          const msg = (data && data.message) ? data.message : (data && data.raw) ? data.raw : ("API Error " + r.status);
          // retry on stage mismatch / not found
          if (r.status === 403 && typeof msg === "string" && msg.toLowerCase().includes("missing authentication token")) {
            lastErr = new Error(msg);
            continue;
          }
          if (r.status === 404) {
            lastErr = new Error(msg);
            continue;
          }
          throw new Error(msg);
        }
        return data;
      } catch (e) {
        lastErr = e;
        // if fetch itself fails (CORS/Network), try next base
        continue;
      }
    }
    throw (lastErr || new Error("API call failed"));
  }

  function getCollectionId() {
    const cid = qs("cid") || localStorage.getItem("political_cid") || "";
    if (cid) localStorage.setItem("political_cid", cid);
    return cid;
  }

  async function uploadToS3(url, file) {
    const r = await fetch(url, {
      method: "PUT",
      headers: { "Content-Type": file.type || "application/octet-stream" },
      body: file
    });
    if (!r.ok) throw new Error("S3 Upload fail (" + r.status + ")");
    return true;
  }

  async function handleSubmit() {
    const publicToken = qs("token") || "";
    const cid = getCollectionId();
    document.getElementById("cidText").textContent = (cid || "-");

    const data = {};
    data['mobile'] = (document.getElementById('mobile').value || '').trim();
    data['name'] = (document.getElementById('name').value || '').trim();
    data['district'] = (document.getElementById('district').value || '').trim();
    data['vidhansabha'] = (document.getElementById('vidhansabha').value || '').trim();
    data['mandal'] = (document.getElementById('mandal').value || '').trim();
    data['address'] = (document.getElementById('address').value || '').trim();
    data['reason'] = (document.getElementById('reason').value || '').trim();

    const required = ["mobile", "name", "district", "vidhansabha", "mandal", "address", "reason"];
    for (const k of required) {
      if (!data[k]) {
        showStatus("❌ " + k + " खाली है। भर दो।");
        return;
      }
    }

    const input = document.getElementById("fileInput");
    if (!input.files || input.files.length === 0) {
      showStatus("❌ फोटो select नहीं किया।");
      return;
    }
    const files = Array.from(input.files || []);
    const f = files[0]; // visitor form: single selfie

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = "Saving...";

    try {
      // Decide mode
      const publicMode = !!publicToken;

      // In admin mode, cid is required
      if (!publicMode && !cid) {
        showStatus("❌ Collection ID missing. Dashboard से link खोलो (URL में ?cid= होगा).");
        return;
      }

      showStatus("⏳ Hashing file ...");
      const hex = await sha256Hex(f);

      const commonPayload = {
        collection_id: publicMode ? "" : cid,
        form_type: "visitor_form",
        payload: data,
        file_kind: "selfie",
        file_name: f.name,
        mime_type: f.type || "image/jpeg",
        sha256: hex
      };

      let createResp;

      if (publicMode) {
        showStatus("⏳ Creating (Public) ...");
        createResp = await apiCall("public_create_entry", {
          ...commonPayload,
          token: publicToken
        }, { useAuth: false });
      } else {
        showStatus("⏳ Creating (Admin) ...");
        createResp = await apiCall("create_entry", commonPayload, { useAuth: true });
      }

      // Duplicate case
      if (createResp.duplicate === true) {
        showStatus("✅ Duplicate मिला: upload skip, entry linked.");
        const finalizePayload = {
          entry_id: createResp.entry_id,
          pk: createResp.pk,
          sk: createResp.sk,
          s3_key: createResp.s3_key || "",
          file_kind: "selfie",
          sha256: hex,
          duplicate: true
        };

        if (publicMode) {
          finalizePayload.token = publicToken;
          finalizePayload.finalize_token = createResp.finalize_token || "";
          await apiCall("public_finalize_entry", finalizePayload, { useAuth: false });
        } else {
          await apiCall("finalize_entry", finalizePayload, { useAuth: true });
        }
        showStatus("✅ Saved (duplicate).");
        return;
      }

      if (createResp.upload_url) {
        showStatus("⏳ Uploading photo ...");
        await uploadToS3(createResp.upload_url, f);
      }

      showStatus("⏳ Finalizing ...");
      const finalizePayload = {
        entry_id: createResp.entry_id,
        pk: createResp.pk,
        sk: createResp.sk,
        s3_key: createResp.s3_key || "",
        file_kind: "selfie",
        sha256: hex
      };

      if (publicMode) {
        finalizePayload.token = publicToken;
        finalizePayload.finalize_token = createResp.finalize_token || "";
        await apiCall("public_finalize_entry", finalizePayload, { useAuth: false });
      } else {
        await apiCall("finalize_entry", finalizePayload, { useAuth: true });
      }

      showStatus("✅ Submit हो गया!");
      // optional reset
      // document.getElementById("form").reset();
    } catch (e) {
      const msg = (e && e.message) ? e.message : String(e);
      // Hint for common API Gateway auth setup issue
      if (msg.toLowerCase().includes("unauthorized") || msg.toLowerCase().includes("missing authentication token")) {
        showStatus("❌ API Authorization issue. API Gateway में POST /political/forms का Authorization NONE करो (public submit के लिए).");
      } else if (msg.toLowerCase().includes("failed to fetch")) {
        showStatus("❌ Network/CORS issue. (1) सही file upload हुई है? (2) API Gateway CORS enabled? (3) Route Authorization NONE? ");
      } else {
        showStatus("❌ " + msg);
      }
    } finally {
      btn.disabled = false;
      btn.textContent = "Submit / Save";
    }
  }

  document.getElementById("submitBtn").addEventListener("click", handleSubmit);

  // Show mode hint
  (function initHint(){
    const publicMode = isPublicMode();
    const note = document.getElementById("noteText");
    if (publicMode) {
      note.textContent = "Public Link Mode: token detect हुआ है, login की जरूरत नहीं है।";
    } else {
      note.textContent = "Admin Mode: dashboard login token और ?cid= जरूरी है।";
    }
  })();
 getCollectionId() || "-";
</script>

</body>
</html>
