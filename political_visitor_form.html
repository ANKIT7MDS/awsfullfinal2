<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visitor Form - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] } } } }</script>
  <style>
    body { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.15), transparent 50%), radial-gradient(circle at bottom right, rgba(234, 88, 12, 0.1), transparent 50%), #0f172a; color: #fff; }
    .glass { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); }
    .input-field { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s ease; }
    .input-field:focus { border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2); outline: none; }
    .input-field:disabled { opacity: 0.6; cursor: not-allowed; background: rgba(15, 23, 42, 0.4); }
    /* Hide scrollbar for cleaner UI */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    
    /* Dynamic Branding Classes (Default) */
    .brand-text { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #fb923c, #f87171); }
    .brand-border { border-color: #f97316; }
    .brand-bg { background-image: linear-gradient(to right, #f97316, #ef4444); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div id="main-container" class="w-full max-w-lg glass rounded-2xl p-6 relative overflow-hidden transition-all duration-500">
    <!-- Decorative Header (Configurable) -->
    <div id="header-bar" class="absolute top-0 left-0 w-full h-1 brand-bg"></div>

    <!-- Header Section -->
    <div class="text-center mb-6" id="form-header">
        <div id="logo-container" class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-500/10 text-orange-500 mb-3 overflow-hidden">
            <!-- Default Icon -->
            <i id="default-icon" class="fa-solid fa-building-user text-2xl"></i>
            <!-- Image Logo (Hidden by default) -->
            <img id="custom-logo" src="" class="w-full h-full object-cover hidden">
        </div>
        <h1 id="org-name" class="text-2xl font-bold brand-text">कार्यालय आगंतुक फॉर्म</h1>
        <p id="org-subtitle" class="text-slate-400 text-xs mt-1">Visitor Entry System</p>
    </div>

    <!-- ENTRY FORM -->
    <form id="f" class="space-y-4">
        
        <!-- Mobile First (For Auto-fill) -->
        <div>
            <label class="block text-xs font-medium text-slate-400 mb-1">मोबाइल नंबर (Mobile)</label>
            <div class="relative">
                <input type="tel" id="mobile" class="w-full rounded-lg px-3 py-2.5 text-sm input-field pl-10" placeholder="10-digit Number" pattern="[0-9]{10}" required>
                <i class="fa-solid fa-phone absolute left-3 top-3 text-slate-500 text-xs"></i>
                <!-- Loader for lookup -->
                <div id="mobile-loader" class="absolute right-3 top-3 hidden">
                    <i class="fa-solid fa-circle-notch fa-spin text-orange-500"></i>
                </div>
            </div>
            <p id="user-found-msg" class="text-[10px] text-green-400 mt-1 hidden"><i class="fa-solid fa-check-circle"></i> डेटा मिला! विवरण भर दिया गया है।</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">नाम (Name)</label>
                <input type="text" id="name" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" placeholder="Visitor Name" required>
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">पद (Designation)</label>
                <input type="text" id="designation" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" placeholder="e.g. मंडल अध्यक्ष">
            </div>
        </div>

        <!-- LOCATION DROPDOWNS -->
        <div>
            <label class="block text-xs font-medium text-slate-400 mb-1">जिला (District)</label>
            <select id="district" class="w-full rounded-lg px-3 py-2.5 text-sm input-field">
                <option value="">— जिला चुनें —</option>
            </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">विधानसभा (Vidhan Sabha)</label>
                <select id="vidhansabha" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" disabled>
                    <option value="">— पहले जिला चुनें —</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1">मंडल (Mandal)</label>
                <select id="mandal" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" disabled>
                    <option value="">— पहले विधानसभा चुनें —</option>
                </select>
            </div>
        </div>

        <!-- Address / Booth -->
        <div>
            <label class="block text-xs font-medium text-slate-400 mb-1">पता / वार्ड / बूथ (Address)</label>
            <input type="text" id="address" class="w-full rounded-lg px-3 py-2.5 text-sm input-field" placeholder="Address Details">
        </div>

        <!-- Purpose Dropdown -->
        <div>
            <label class="block text-xs font-medium text-slate-400 mb-1">आने का कारण (Purpose)</label>
            <div class="relative">
                <select id="reason" class="w-full rounded-lg px-3 py-2.5 text-sm input-field appearance-none" required>
                    <option value="">— कारण चुनें —</option>
                    <option value="Meet District President">जिला अध्यक्ष जी से भेट</option>
                    <option value="Transfer/Complaint/Govt Work">ट्रान्सफर / शिकायत / शासकीय कार्य</option>
                    <option value="Office Meeting">कार्यालय पर बैठक</option>
                    <option value="General Visit">सामान्य उपस्तिथि / शिष्टाचार भेंट</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-slate-500 text-xs pointer-events-none"></i>
            </div>
        </div>

        <!-- Selfie Upload Section -->
        <div class="space-y-2">
            <label class="block text-xs font-semibold text-slate-300 uppercase tracking-wider">सेल्फी (Selfie)</label>
            <div class="relative group">
                <input type="file" id="selfie" accept="image/*" capture="user" class="hidden" onchange="previewImage(event)">
                <label for="selfie" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-600 rounded-xl cursor-pointer hover:border-orange-500 hover:bg-slate-800/50 transition-all group-hover:shadow-lg group-hover:shadow-orange-500/10 overflow-hidden" id="dropzone">
                    <div id="preview-container" class="hidden w-full h-full relative">
                        <img id="preview" class="w-full h-full object-cover">
                        <button type="button" onclick="clearImage(event)" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center shadow-lg hover:scale-110 transition"><i class="fa-solid fa-times text-xs"></i></button>
                    </div>
                    <div id="upload-placeholder" class="text-center p-4">
                        <i class="fa-solid fa-camera text-2xl text-slate-400 mb-2 group-hover:text-orange-400 transition"></i>
                        <p class="text-xs text-slate-400">फोटो लें / Upload Photo</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitBtn" class="w-full brand-bg text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/20 transition-all transform active:scale-95 flex items-center justify-center gap-2 hover:opacity-90">
            <span>सुरक्षित करें (Save)</span>
            <i class="fa-solid fa-paper-plane text-xs"></i>
        </button>

    </form>
    
    <div id="status" class="mt-4 text-center text-xs font-medium hidden"></div>
</div>

<!-- SUCCESS SCREEN (Hidden by default) -->
<div id="success-screen" class="hidden w-full max-w-lg glass rounded-2xl p-8 text-center flex flex-col items-center justify-center min-h-[400px]">
    <div class="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mb-6 text-4xl shadow-lg shadow-green-500/20">
        <i class="fa-solid fa-check"></i>
    </div>
    <h2 class="text-2xl font-bold text-white mb-2">धन्यवाद!</h2>
    <p id="success-msg" class="text-slate-300 mb-8 leading-relaxed">
        आपकी जानकारी सफलतापूर्वक दर्ज कर ली गई है।
    </p>
    <button onclick="window.location.reload()" class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-white transition">
        <i class="fa-solid fa-user-plus mr-2"></i> नई एंट्री करें
    </button>
</div>

<script>
    // ==========================================
    // CONFIGURATION - API & BRANDING
    // ==========================================
    
    const API_ID = "vxid0yoovj"; 
    const AWS_REGION = "ap-south-1";
    const BASE_API_URL = `https://${API_ID}.execute-api.${AWS_REGION}.amazonaws.com`;
    
    // UPDATED ROUTES based on user input
    // /political/timeline [POST]
    // /political/forms [POST] (Private/Office)
    // /public/forms [POST] (Public)
    
    const TIMELINE_API = `${BASE_API_URL}/political/timeline`; 

    // This object can be updated via Admin Console in future (stored in S3 or DB)
    const BRANDING_CONFIG = {
        default: {
            title: "कार्यालय आगंतुक फॉर्म",
            subtitle: "Visitor Entry System",
            themeColor: "from-orange-500 to-red-500", // Tailwind Gradient
            successMsg: "आपकी जानकारी सफलतापूर्वक दर्ज कर ली गई है। आपका दिन शुभ हो।"
        },
        // Example for a specific collection ID
        bjpmandsaur: {
            title: "भाजपा कार्यालय मंदसौर",
            subtitle: "स्वागतम",
            successMsg: "भारतीय जनता पार्टी कार्यालय में पधारने के लिए धन्यवाद। वन्दे मातरम!",
            // logoUrl: "https://example.com/logo.png" 
        }
    };

    // ==========================================
    // DATA SOURCE: DISTRICT -> VIDHAN -> MANDAL
    // ==========================================
    const DISTRICT_DATA = {
    "मंदसौर": {
        "मंदसौर": ["मंदसौर नगर उत्तर", "मंदसौर नगर दक्षिण", "मंदसौर ग्रामीण"],
        "सुवासरा": ["सीतामऊ", "सुवासरा", "शामगढ़"],
        "गरोठ": ["गरोठ", "भानपुरा", "मेलखेड़ा"],
        "मल्हारगढ़": ["मल्हारगढ़", "नारायणगढ़", "पिपलियामंडी"]
    },
    "रतलाम": {
        "रतलाम सिटी": ["दीनदयाल नगर", "अम्बेडकर नगर", "श्यामा प्रसाद मुखर्जी नगर"],
        "रतलाम ग्रामीण": ["धराड़", "बांगरोद", "नामली"],
        "सैलाना": ["सैलाना", "बाजना", "रावटी"],
        "जावरा": ["जावरा नगर", "जावरा ग्रामीण", "पिप्लौदा"],
        "आलोट": ["आलोट", "बड़ावदा", "ताल"]
    },
    "नीमच": {
        "नीमच": ["नीमच उत्तर", "नीमच दक्षिण", "नीमच पश्चिम", "जीरन"],
        "मनासा": ["मनासा", "रामपुरा", "कुकाड़ेश्वर"],
        "जावद": ["जावद", "सिंगोली", "रतनगढ़"]
    },
    "उज्जैन": {
        "उज्जैन उत्तर": ["दौलतगंज", "नई सड़क", "फ्रीगंज"],
        "उज्जैन दक्षिण": ["महानंदा", "नानाखेड़ा", "कोठी रोड"],
        "घट्टिया": ["घट्टिया", "उन्हेल", "पानबिहार"],
        "तराना": ["तराना", "माकड़ोन", "कायथा"],
        "महिदपुर": ["महिदपुर नगर", "महिदपुर ग्रामीण", "झारड़ा"],
        "नागदा-खाचरौद": ["नागदा", "खाचरौद", "बिरलाग्राम"],
        "बड़नगर": ["बड़नगर", "इंगोरिया", "खरसौद"]
    },
    "आगर-मालवा": {
        "आगर": ["आगर नगर", "आगर ग्रामीण", "बड़ौद"],
        "सुसनेर": ["सुसनेर", "नलखेड़ा", "सोयत"]
    },
    "शाजापुर": {
        "शाजापुर": ["शाजापुर नगर", "शाजापुर ग्रामीण", "मो. बड़ोदिया"],
        "शुजालपुर": ["शुजालपुर मंडी", "शुजालपुर सिटी", "अकोदिया"],
        "कालापीपल": ["कालापीपल", "पोलायकलां", "खोकराकलां"]
    },
    "देवास": {
        "देवास": ["देवास उत्तर", "देवास दक्षिण", "देवास पश्चिम"],
        "सोनकच्छ": ["सोनकच्छ", "टोंकखुर्द", "पीपलरावां"],
        "हाटपिपल्या": ["हाटपिपल्या", "नेवरी", "करनावाद"],
        "खातेगांव": ["खातेगांव", "कन्नौद", "हरणगांव"],
        "बागली": ["बागली", "उदयनगर", "सतवास"]
    },
    "इंदौर": {
        "इंदौर-1": ["वार्ड 1-5", "वार्ड 6-10", "वार्ड 11-15"],
        "इंदौर-2": ["वार्ड 16-20", "वार्ड 21-25", "वार्ड 26-30"],
        "इंदौर-3": ["वार्ड 31-35", "वार्ड 36-40", "वार्ड 41-45"],
        "इंदौर-4": ["वार्ड 46-50", "वार्ड 51-55", "वार्ड 56-60"],
        "इंदौर-5": ["वार्ड 61-65", "वार्ड 66-70", "वार्ड 71-75"],
        "राऊ": ["राऊ नगर", "तेजाजी नगर", "दत्तौदा"],
        "महू": ["महू नगर", "महू ग्रामीण", "मानपुर"],
        "देपालपुर": ["देपालपुर", "गौतमपुरा", "बेटमा"],
        "सांवेर": ["सांवेर", "चंद्रावतीगंज", "क्षिप्रा"]
    },
    "धार": {
        "धार": ["धार नगर", "धार ग्रामीण", "तिरला"],
        "पीथमपुर": ["पीथमपुर", "सागौर", "नालछा"],
        "बदनावर": ["बदनावर", "कानवन", "मुलथान"],
        "सरदारपुर": ["सरदारपुर", "राजगढ़", "अमझेरा"],
        "गंधवानी": ["गंधवानी", "बाग", "टांडा"],
        "कुक्षी": ["कुक्षी", "डही", "निसरपुर"],
        "मनावर": ["मनावर", "उमरबन", "सिंघाना"],
        "धरमपुरी": ["धरमपुरी", "धामनोद", "मांडू"]
    },
    "झाबुआ": {
        "झाबुआ": ["झाबुआ नगर", "झाबुआ ग्रामीण", "रामा"],
        "थांदला": ["थांदला", "खवासा", "मेघनगर"],
        "पेटलावद": ["पेटलावद", "रायपुरिया", "सारंगी"]
    },
    "अलीराजपुर": {
        "अलीराजपुर": ["अलीराजपुर नगर", "अलीराजपुर ग्रामीण", "सोंडवा"],
        "जोबट": ["जोबट", "उदयगढ़", "भाबरा"]
    },
    "खरगोन": {
        "खरगोन": ["खरगोन नगर", "खरगोन ग्रामीण", "सनावद"],
        "भीकनगांव": ["भीकनगांव", "झिरन्या", "गोगावां"],
        "बड़वाह": ["बड़वाह", "महेश्वर", "करही"],
        "महेश्वर": ["महेश्वर", "मंडलेश्वर", "धामनोद"],
        "कसरावद": ["कसरावद", "पिपलगोन", "बालकवाड़ा"],
        "भगवानपुरा": ["भगवानपुरा", "सेगांव", "बिस्टान"]
    },
    "बड़वानी": {
        "बड़वानी": ["बड़वानी नगर", "बड़वानी ग्रामीण", "पाटी"],
        "सेंधवा": ["सेंधवा नगर", "सेंधवा ग्रामीण", "चाचरीया"],
        "राजपुर": ["राजपुर", "ठीकरी", "अंजड़"],
        "पानसेमल": ["पानसेमल", "खेतिया", "निवाली"]
    },
    "खंडवा": {
        "खंडवा": ["खंडवा नगर", "खंडवा ग्रामीण", "छैगांवमाखन"],
        "पंधाना": ["पंधाना", "सिंघोट", "आरुद"],
        "मांधाता": ["मांधाता", "पुनासा", "मूंदी"],
        "हरसूद": ["हरसूद", "खालवा", "किillod"]
    },
    "बुरहानपुर": {
        "बुरहानपुर": ["बुरहानपुर नगर", "बुरहानपुर ग्रामीण", "शाहपुर"],
        "नेपानगर": ["नेपानगर", "धुलकोट", "खकनार"]
    }
};

    // ==========================================
    // UTILITIES
    // ==========================================
    const $ = (id) => document.getElementById(id);
    const FIELD_IDS = ['mobile','name','designation','district','vidhansabha','mandal','address','reason']; 
    const FORM_TYPE = 'visitor_form';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const cidParam = urlParams.get('cid');
    function isPublicMode() { return !!token; }

    function showStatus(msg, isError) {
        const el = $('status'); el.classList.remove('hidden','text-green-400','text-red-400');
        el.classList.add(isError ? 'text-red-400' : 'text-green-400');
        el.innerText = msg; el.classList.remove('hidden');
    }

    // ==========================================
    // INITIALIZATION & BRANDING
    // ==========================================
    function applyBranding() {
        const config = (cidParam && BRANDING_CONFIG[cidParam]) ? BRANDING_CONFIG[cidParam] : BRANDING_CONFIG['default'];
        
        $('org-name').textContent = config.title;
        $('org-subtitle').textContent = config.subtitle;
        $('success-msg').textContent = config.successMsg;

        if(config.logoUrl) {
            $('custom-logo').src = config.logoUrl;
            $('custom-logo').classList.remove('hidden');
            $('default-icon').classList.add('hidden');
        }
        
        // Apply theme color logic if needed (simplified for now to use orange gradient)
    }

    function initLocations() {
        applyBranding();
        const dEl = $('district'); const vEl = $('vidhansabha'); const mEl = $('mandal');
        
        // Populate District
        const districts = Object.keys(DISTRICT_DATA).sort((a,b)=>a.localeCompare(b, "hi"));
        districts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            dEl.appendChild(opt);
        });

        // Handle District Change
        dEl.addEventListener('change', () => {
            const dVal = dEl.value;
            vEl.innerHTML = '<option value="">— विधानसभा चुनें —</option>';
            mEl.innerHTML = '<option value="">— पहले विधानसभा चुनें —</option>';
            vEl.disabled = !dVal; mEl.disabled = true;

            if(dVal && DISTRICT_DATA[dVal]) {
                const vidhans = Object.keys(DISTRICT_DATA[dVal]).sort((a,b)=>a.localeCompare(b, "hi"));
                vidhans.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v; opt.textContent = v;
                    vEl.appendChild(opt);
                });
            }
        });

        // Handle Vidhan Sabha Change
        vEl.addEventListener('change', () => {
            const dVal = dEl.value; const vVal = vEl.value;
            mEl.innerHTML = '<option value="">— मंडल चुनें —</option>';
            mEl.disabled = !vVal;

            if(dVal && vVal && DISTRICT_DATA[dVal][vVal]) {
                const mandals = DISTRICT_DATA[dVal][vVal].sort((a,b)=>a.localeCompare(b, "hi"));
                mandals.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m; opt.textContent = m;
                    mEl.appendChild(opt);
                });
            }
        });
    }

    // ==========================================
    // AUTO-FILL LOGIC (MOBILE LOOKUP)
    // ==========================================
    const mobileInput = $('mobile');
    mobileInput.addEventListener('blur', async () => {
        const val = mobileInput.value.trim();
        if(val.length !== 10) return;

        $('mobile-loader').classList.remove('hidden');
        
        try {
            // Updated to use the correct TIMELINE route
            const res = await fetch(TIMELINE_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mobile: val }) // Sending mobile to API
            });
            
            if(!res.ok) throw new Error(`API Error: ${res.status}`);
            const data = await res.json();
            
            if(data && (data.visitor_details || (data.events && data.events.length > 0))) {
                const info = data.visitor_details || (data.events[0]); // Fallback to first event data
                
                if(info) {
                    // Auto-fill fields if they exist
                    if(info.name) $('name').value = info.name;
                    if(info.designation) $('designation').value = info.designation;
                    if(info.address) $('address').value = info.address;
                    
                    // Trigger Cascading Dropdowns
                    if(info.district && DISTRICT_DATA[info.district]) {
                        $('district').value = info.district;
                        $('district').dispatchEvent(new Event('change')); // Load Vidhansabhas
                        
                        setTimeout(() => {
                            if(info.vidhansabha) {
                                $('vidhansabha').value = info.vidhansabha;
                                $('vidhansabha').dispatchEvent(new Event('change')); // Load Mandals
                                
                                setTimeout(() => {
                                    if(info.mandal) $('mandal').value = info.mandal;
                                }, 100);
                            }
                        }, 100);
                    }
                    
                    $('user-found-msg').classList.remove('hidden');
                }
            }
        } catch(e) {
            console.log("User lookup failed or new user", e);
        } finally {
            $('mobile-loader').classList.add('hidden');
        }
    });

    document.addEventListener('DOMContentLoaded', initLocations);

    // ==========================================
    // IMAGE HANDLING
    // ==========================================
    function previewImage(event) {
        const file = event.target.files[0];
        if(file){
            const src = URL.createObjectURL(file);
            $('preview').src = src; $('preview-container').classList.remove('hidden');
            $('dropzone').classList.add('border-orange-500'); $('upload-placeholder').classList.add('hidden');
        }
    }
    function clearImage(e) {
        if(e) e.stopPropagation();
        $('selfie').value = ''; $('preview').src = '';
        $('preview-container').classList.add('hidden');
        $('dropzone').classList.remove('border-orange-500'); $('upload-placeholder').classList.remove('hidden');
    }

    async function sha256Hex(file) {
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ==========================================
    // API & SUBMIT
    // ==========================================
    async function apiCall(action, payload, useAuth=false) {
        try {
            // DYNAMIC ROUTE SELECTION
            // If useAuth is true (Private mode), use /political/forms
            // If useAuth is false (Public mode), use /public/forms
            const url = useAuth ? `${BASE_API_URL}/political/forms` : `${BASE_API_URL}/public/forms`;

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload })
            });
            
            if(!res.ok) {
                // Try to parse error message if possible
                const text = await res.text();
                let errData;
                try { errData = JSON.parse(text); } catch(e) {}
                throw new Error((errData && (errData.message || errData.error)) || `API Error: ${res.status} (Check Connection)`);
            }
            return await res.json();
        } catch(e) {
            if(e.name === 'TypeError' && e.message === 'Failed to fetch') {
                throw new Error("API Server Unreachable. Please check API_ID configuration.");
            }
            throw e;
        }
    }

    async function uploadToS3(url, file) {
        await fetch(url, { method: 'PUT', body: file, headers: { 'Content-Type': file.type } });
    }

    $('f').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = $('submitBtn'); const ot = btn.innerHTML; 
        btn.disabled=true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...'; 
        showStatus('');

        try {
            const file = $('selfie').files[0]; 
            if(!file) throw new Error('Selfie/Photo अनिवार्य है (Photo Required)');

            // Collect Data
            const data = {}; 
            for(const id of FIELD_IDS) {
                const el = $(id);
                if(el) {
                    data[id] = el.value.trim();
                }
            }

            if(!data.district) throw new Error("कृपया जिला चुनें");
            if(!data.vidhansabha) throw new Error("कृपया विधानसभा चुनें");

            const sha = await sha256Hex(file); 
            const fileName = `${crypto.randomUUID()}.jpg`;

            let res;
            if(isPublicMode()){ 
                res = await apiCall('public_create_entry', { token, form_type: FORM_TYPE, sha256: sha, file_name: fileName, mime_type: file.type, payload: data }); 
            } else { 
                if(!cidParam) throw new Error('Missing Collection ID'); 
                res = await apiCall('create_entry', { collection_id: cidParam, form_type: FORM_TYPE, sha256: sha, file_name: fileName, mime_type: file.type, payload: data }, true); 
            }

            if(res.upload_url) await uploadToS3(res.upload_url, file);

            const af = isPublicMode() ? 'public_finalize_entry' : 'finalize_entry';
            await apiCall(af, { finalize_token: res.finalize_token, entry_id: res.entry_id }, !isPublicMode());

            // Show Success Screen instead of just text
            $('main-container').classList.add('hidden');
            $('success-screen').classList.remove('hidden');
            
            $('f').reset(); clearImage(e);

        } catch(err) { 
            showStatus('❌ ' + err.message, true); 
            btn.disabled=false; btn.innerHTML = ot; 
        }
    });
</script>
</body>
</html>
