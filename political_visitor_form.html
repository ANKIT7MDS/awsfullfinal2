<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Political Visitor Form - EventLens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 400:'#38bdf8', 500:'#0ea5e9', 600:'#0284c7', 700:'#0369a1' }
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <div class="rounded-2xl bg-slate-900/40 border border-slate-800 shadow-xl overflow-hidden">
      <div class="px-6 py-5 border-b border-slate-800 flex items-center justify-between">
        <div>
          <div class="text-xl font-semibold">Political Visitor Form</div>
          <div id="modeLine" class="text-sm text-slate-400 mt-1">Loading...</div>
        </div>
        <div class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-200">EventLens</div>
      </div>

      <div class="p-6 space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-slate-300">नाम *</label>
            <input id="name" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="जैसे: Ankit" />
          </div>

          <div>
            <label class="text-sm text-slate-300">मोबाइल *</label>
            <input id="mobile" inputmode="numeric" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="10 digit" />
          </div>

          <div>
            <label class="text-sm text-slate-300">जिला *</label>
            <input id="district" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="जैसे: Mandsaur" />
          </div>

          <div>
            <label class="text-sm text-slate-300">विधानसभा</label>
            <input id="vidhansabha" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="optional" />
          </div>

          <div>
            <label class="text-sm text-slate-300">मंडल *</label>
            <input id="mandal" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="जैसे: Mandsaur" />
          </div>

          <div>
            <label class="text-sm text-slate-300">वार्ड/बूथ/पता *</label>
            <input id="address" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="जैसे: Ward 23" />
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-300">आने का कारण *</label>
          <input id="reason" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-800 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-500" placeholder="जैसे: Meeting / Help / Suggestion" />
        </div>

        <div>
          <label class="text-sm text-slate-300">सेल्फी (Photo) *</label>
          <input id="photo" type="file" accept="image/*" class="mt-1 block w-full text-sm text-slate-300 file:mr-4 file:rounded-xl file:border-0 file:bg-brand-600 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-brand-700" />
          <div class="text-xs text-slate-400 mt-2">Photo upload के लिए internet stable होना चाहिए.</div>
        </div>

        <button id="submitBtn" class="w-full rounded-2xl bg-brand-600 hover:bg-brand-700 transition px-6 py-4 font-semibold">
          Submit / Save
        </button>

        <div id="statusBox" class="hidden rounded-2xl border border-slate-800 bg-slate-950/50 p-4">
          <div class="text-sm text-slate-300">Status</div>
          <div id="statusText" class="mt-1 text-sm font-medium"></div>
        </div>
      </div>
    </div>

    <div class="text-center text-xs text-slate-500 mt-6">
      EventLens Political Module
    </div>
  </div>

<script>
  // ----------------------------
  // CONFIG (your political HTTP API)
  // ----------------------------
  const API_ID = "vxid0yoovj";
  const REGION = "ap-south-1";

  // Tries $default first (no stage), then /prod (fallback)
  const API_BASE_CANDIDATES = [
    `https://${API_ID}.execute-api.${REGION}.amazonaws.com`,
    `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod`,
  ];

  const FORM_TYPE = "visitor_form";

  // ----------------------------
  // Helpers
  // ----------------------------
  const qs = (name) => new URL(window.location.href).searchParams.get(name) || "";
  const isPublicMode = () => !!qs("token");
  const showStatus = (msg, ok=false) => {
    const box = document.getElementById("statusBox");
    const txt = document.getElementById("statusText");
    box.classList.remove("hidden");
    txt.textContent = msg;
    txt.className = "mt-1 text-sm font-medium " + (ok ? "text-emerald-400" : "text-rose-400");
  };

  const getIdTokenPrefer = () => (
    localStorage.getItem("idToken") ||
    localStorage.getItem("cognito_idToken") ||
    localStorage.getItem("cognito_id_token") ||
    localStorage.getItem("cognito_accessToken") ||
    localStorage.getItem("accessToken") ||
    localStorage.getItem("cognito_access_token") ||
    ""
  );

  async function sha256Hex(file) {
    const buf = await file.arrayBuffer();
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function sanitizeMobile(m) {
    return (m || "").replace(/\D/g, "").slice(0, 10);
  }

  async function apiPost(action, payload, useAuth) {
    let lastErr = null;

    for (const base of API_BASE_CANDIDATES) {
      const url = base + (useAuth ? "/political/forms" : "/political/public/forms");
      const headers = { "Content-Type": "application/json" };

      if (useAuth) {
        const t = getIdTokenPrefer();
        if (!t) throw new Error("Login token missing. Dashboard से login करके खोलो या public link use करो.");
        headers["Authorization"] = "Bearer " + t;
      }

      try {
        const res = await fetch(url, {
          method: "POST",
          headers,
          body: JSON.stringify({ action, payload })
        });

        // stage mismatch can look like 403/404 with "Missing Authentication Token"
        const txt = await res.text();
        let data = {};
        try { data = JSON.parse(txt || "{}"); } catch { data = { raw: txt || "" }; }

        if (!res.ok) {
          const msg = (data && (data.message || data.raw)) ? (data.message || data.raw) : ("HTTP " + res.status);
          // try next base only if likely stage mismatch
          const low = String(msg).toLowerCase();
          if ((res.status === 403 || res.status === 404) && (low.includes("missing authentication token") || low.includes("not found"))) {
            lastErr = new Error(msg);
            continue;
          }
          throw new Error(msg);
        }

        return data;
      } catch (e) {
        lastErr = e;
        // Try next candidate only for network errors
        continue;
      }
    }

    throw (lastErr || new Error("API call failed"));
  }

  function setModeLine() {
    const token = qs("token");
    const cid = qs("cid");
    const el = document.getElementById("modeLine");

    if (token) {
      el.textContent = "PUBLIC LINK MODE ✅ (Login नहीं चाहिए)";
    } else if (cid) {
      el.textContent = "ADMIN MODE ✅ (Login required)";
    } else {
      el.textContent = "⚠️ URL में ?token=... या ?cid=... missing है";
    }
  }

  async function handleSubmit() {
    try {
      showStatus("Saving...", true);

      const data = {
        name: (document.getElementById("name").value || "").trim(),
        mobile: sanitizeMobile(document.getElementById("mobile").value || ""),
        district: (document.getElementById("district").value || "").trim(),
        vidhansabha: (document.getElementById("vidhansabha").value || "").trim(),
        mandal: (document.getElementById("mandal").value || "").trim(),
        address: (document.getElementById("address").value || "").trim(),
        reason: (document.getElementById("reason").value || "").trim(),
      };

      // basic validation
      const required = ["name","mobile","district","mandal","address","reason"];
      for (const k of required) {
        if (!data[k]) throw new Error(`"${k}" खाली है`);
      }
      if (data.mobile.length !== 10) throw new Error("Mobile 10 digits होना चाहिए");

      const input = document.getElementById("photo");
      const file = (input.files && input.files[0]) ? input.files[0] : null;
      if (!file) throw new Error("Photo select करो");

      const token = qs("token");
      const cid = qs("cid");
      const publicMode = !!token;

      // build request
      const sha = await sha256Hex(file);
      const mime = file.type || "image/jpeg";
      const fileName = `${crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"")}.jpg`;

      const createPayload = {
        form_type: FORM_TYPE,
        file_kind: "selfie",
        file_name: fileName,
        mime_type: mime,
        sha256: sha,
        payload: data,
      };

      let createAction = "create_entry";
      let useAuth = true;

      if (publicMode) {
        createAction = "public_create_entry";
        useAuth = false;
        createPayload.token = token;
      } else {
        // admin mode needs collection id
        if (!cid) throw new Error("Admin mode में URL में ?cid=COLLECTION_ID जरूरी है");
        createPayload.collection_id = cid;
      }

      // 1) create entry => get upload_url
      const created = await apiPost(createAction, createPayload, useAuth);

      // 2) upload to S3 (if upload_url present)
      if (created.upload_url) {
        const putRes = await fetch(created.upload_url, {
          method: "PUT",
          headers: { "Content-Type": mime },
          body: file
        });
        if (!putRes.ok) throw new Error("S3 upload failed: " + putRes.status);
      }

      // 3) finalize
      const finalizePayload = {
        pk: created.pk,
        sk: created.sk,
        entry_id: created.entry_id,
        s3_key: created.s3_key,
        file_kind: "selfie",
        sha256: sha,
        duplicate: !!created.duplicate,
        finalize_token: created.finalize_token
      };

      let finalizeAction = "finalize_entry";
      let finalizeUseAuth = true;

      if (publicMode) {
        finalizeAction = "public_finalize_entry";
        finalizeUseAuth = false;
        finalizePayload.token = token;
      }

      await apiPost(finalizeAction, finalizePayload, finalizeUseAuth);

      showStatus("✅ Saved successfully", true);
      // optional: reset file input
      document.getElementById("submitBtn").disabled = false;

    } catch (e) {
      showStatus("❌ " + (e && e.message ? e.message : String(e)), false);
      document.getElementById("submitBtn").disabled = false;
    }
  }

  // init
  setModeLine();
  document.getElementById("submitBtn").addEventListener("click", () => {
    document.getElementById("submitBtn").disabled = true;
    handleSubmit();
  });
</script>

</body>
</html>
