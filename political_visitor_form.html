<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visitor Form • EventLens Political</title>
  <style>
    :root {
      --bg:#071126; --card:#0b1b33; --text:#eaf2ff; --muted:#9cb2d8;
      --border:rgba(255,255,255,.10); --btn:#0a84ff; --danger:#ff4d4d;
      --radius:18px;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#050a16,#08122a 50%,#050a16); color:var(--text);}
    .wrap{max-width:560px;margin:0 auto;padding:18px 14px 36px;}
    .card{background:rgba(11,27,51,.92); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:0 14px 40px rgba(0,0,0,.35);}
    h1{font-size:22px;margin:0 0 6px;}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px;line-height:1.45;}
    label{display:block;margin:12px 0 6px;font-size:13px;color:#d7e6ff;}
    input{width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(7,17,38,.75);color:var(--text);outline:none;}
    input:focus{border-color:rgba(10,132,255,.55);}
    .btn{width:100%;margin-top:14px;padding:14px 14px;border:none;border-radius:16px;font-weight:700;font-size:16px;color:white;background:var(--btn);cursor:pointer;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .note{margin-top:10px;font-size:12px;color:var(--muted);}
    .status{margin-top:14px;padding:12px;border-radius:16px;border:1px solid var(--border);background:rgba(7,17,38,.6);}
    .ok{color:#8cffd1;}
    .err{color:#ff9a9a;}
    .small{font-size:12px;color:var(--muted);}
    .footer{text-align:center;margin-top:18px;color:var(--muted);font-size:12px;opacity:.85;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Visitor Form</h1>
      <p class="sub">यह फॉर्म EventLens Political Module के लिए है। Public Link में login की जरूरत नहीं है। Admin Mode में dashboard login token चाहिए।</p>

      <form id="f">

      <label for="name">नाम *</label>
      <input id="name" name="name" type="text" placeholder="" required />


      <label for="mobile">मोबाइल नंबर *</label>
      <input id="mobile" name="mobile" type="tel" placeholder="10 digit" required />


      <label for="district">जिला *</label>
      <input id="district" name="district" type="text" placeholder="" required />


      <label for="vidhansabha">विधानसभा</label>
      <input id="vidhansabha" name="vidhansabha" type="text" placeholder=""  />


      <label for="mandal">मंडल *</label>
      <input id="mandal" name="mandal" type="text" placeholder="" required />


      <label for="address">वार्ड/बूथ/पता *</label>
      <input id="address" name="address" type="text" placeholder="" required />


      <label for="reason">आने का कारण / विवरण *</label>
      <input id="reason" name="reason" type="text" placeholder="" required />

        <label for="selfie">सेल्फी (Photo) *</label>
        <input id="selfie" name="selfie" type="file" accept="image/*" required />

        <button id="submitBtn" class="btn" type="submit">Submit / Save</button>
      </form>

      <div class="note">Note: Public Link में URL में <b>?token=</b> होना जरूरी है।</div>

      <div id="statusBox" class="status" style="display:none;">
        <div id="statusText" class="small"></div>
      </div>

      <div class="footer">EventLens Political Module • 2026-01-30 05:02</div>
    </div>
  </div>

<script>
(() => {
  const API_ID = 'vxid0yoovj';
  const REGION = 'ap-south-1';
  const FORM_TYPE = 'visitor_form';

  const FIELD_IDS = ['name','mobile','district','vidhansabha','mandal','address','reason'];
  const REQUIRED_IDS = ['name','mobile','district','mandal','address','reason'];

  const $ = (id) => document.getElementById(id);
  const qs = (name) => {
    try{ return (new URL(window.location.href)).searchParams.get(name) || ''; }catch(e){ return ''; }
  };

  const token = qs('token');
  const cidParam = (qs('cid') || qs('collection_id') || qs('id')).trim();

  const isPublicMode = () => !!token;

  function showStatus(msg, isErr=false){
    const box = $('statusBox'); const t = $('statusText');
    box.style.display = '';
    t.textContent = msg || '';
    t.className = isErr ? 'err' : 'ok';
  }

  function scanJwtFromLocalStorage(){
    let best = '';
    try {
      for(let i=0;i<localStorage.length;i++) {
        const k = localStorage.key(i);
        const v = (localStorage.getItem(k)||'').trim();
        if(v.startsWith('eyJ') && v.split('.').length===3 && v.length > best.length) best = v;
      }
    } catch(e) {}
    return best;
  }

  function getJwt(){
    return localStorage.getItem('idToken')
      || localStorage.getItem('accessToken')
      || localStorage.getItem('cognito_id_token')
      || localStorage.getItem('cognito_access_token')
      || scanJwtFromLocalStorage()
      || '';
  }

  async function sha256Hex(file){
    const buf = await file.arrayBuffer();
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  function apiCandidates(){
    const path = isPublicMode() ? '/political/public/forms' : '/political/forms';
    return [
      `https://${API_ID}.execute-api.${REGION}.amazonaws.com${path}`,
      `https://${API_ID}.execute-api.${REGION}.amazonaws.com/prod${path}`
    ];
  }

  async function apiCall(action, payload, opts={}){
    const useAuth = !!opts.useAuth;
    const bases = apiCandidates();
    let lastErr = null;

    for(const base of bases){
      try {
        const headers = {'Content-Type':'application/json'};
        if(useAuth){
          const jwt = getJwt();
          if(!jwt) throw new Error('Login token नहीं मिला। Dashboard में login करके फिर try करो।');
          headers['Authorization'] = 'Bearer ' + jwt;
        }
        const res = await fetch(base, {
          method: 'POST',
          headers,
          body: JSON.stringify({ action, payload })
        });
        const text = await res.text();
        let data = null;
        try{ data = JSON.parse(text); }catch(e){ data = { raw:text }; }

        if(!res.ok){
          const msg = (data && (data.message || data.error || data.raw)) ? (data.message || data.error || data.raw) : ('API error ' + res.status);
          if(res.status === 404){ lastErr = new Error(msg); continue; }
          throw new Error(msg);
        }
        return data;
      } catch(e) {
        lastErr = e;
      }
    }
    throw (lastErr || new Error('API call failed'));
  }

  async function uploadToS3(url, file){
    const res = await fetch(url, {
      method:'PUT',
      headers: {'Content-Type': file.type || 'application/octet-stream'},
      body: file
    });
    if(!res.ok) throw new Error('Photo upload failed: ' + res.status);
  }

  function collectFormData(){
    const out = {};
    for(const id of FIELD_IDS){
      const el = $(id);
      if(el) out[id] = (el.value || '').trim();
    }
    return out;
  }

  function validate(data, file){
    for(const id of REQUIRED_IDS){
      if(!data[id]) return 'कृपया "' + id + '" भरें';
    }
    if(!file) return 'कृपया selfie select करें';
    if(data.mobile && data.mobile.replace(/\D/g,'').length < 10) return 'मोबाइल नंबर सही नहीं लग रहा';
    return '';
  }

  $('f').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = $('submitBtn');
    btn.disabled = true;

    try {
      showStatus('Saving...', false);

      const file = ($('selfie').files || [])[0];
      const data = collectFormData();
      const v = validate(data, file);
      if(v) throw new Error(v);

      const fileName = (crypto.randomUUID ? crypto.randomUUID() : ('file_' + Date.now())) + '.jpg';
      const sha = await sha256Hex(file);

      if(isPublicMode()) {
        const createRes = await apiCall('public_create_entry', {
          token,
          form_type: FORM_TYPE,
          file_kind: 'selfie',
          file_name: fileName,
          mime_type: file.type || 'image/jpeg',
          sha256: sha,
          payload: data
        }, { useAuth:false });

        if(!createRes?.finalize_token || !createRes?.entry_id) throw new Error('Create entry response invalid');

        if(createRes.upload_url){
        await uploadToS3(createRes.upload_url, file);
      } else if(createRes.duplicate){
        // Duplicate selfie detected - reuse existing photo (no upload required)
      } else {
        throw new Error('Upload URL missing');
      }

        await apiCall('public_finalize_entry', {
          token,
          entry_id: createRes.entry_id,
          finalize_token: createRes.finalize_token
        }, { useAuth:false });

        showStatus('✅ Saved successfully', false);
        btn.disabled = false;
        return;
      }

      if(!cidParam) throw new Error('Admin Mode में URL में cid/collection_id missing है');

      const createRes = await apiCall('create_entry', {
        collection_id: cidParam,
        form_type: FORM_TYPE,
        file_kind: 'selfie',
        file_name: fileName,
        mime_type: file.type || 'image/jpeg',
        sha256: sha,
        payload: data
      }, { useAuth:true });

      if(!createRes?.finalize_token || !createRes?.entry_id) throw new Error('Create entry response invalid');

      if(createRes.upload_url){
        await uploadToS3(createRes.upload_url, file);
      } else if(createRes.duplicate){
        // Duplicate selfie detected - reuse existing photo (no upload required)
      } else {
        throw new Error('Upload URL missing');
      }

      await apiCall('finalize_entry', {
        entry_id: createRes.entry_id,
        finalize_token: createRes.finalize_token
      }, { useAuth:true });

      showStatus('✅ Saved successfully (Admin Mode)', false);
      btn.disabled = false;
    } catch(err) {
      showStatus('❌ ' + (err?.message || String(err)), true);
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
